var requirejs,require,define;(function(global){var req,s,head,baseElement,dataMain,src,interactiveScript,currentlyAddingScript,mainScript,subPath,version="2.1.22",commentRegExp=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg,cjsRequireRegExp=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,jsSuffixRegExp=/\.js$/,currDirRegExp=/^\.\//,op=Object.prototype,ostring=op.toString,hasOwn=op.hasOwnProperty,ap=Array.prototype,isBrowser=typeof window!="undefined"&&typeof navigator!="undefined"&&!!window.document,isWebWorker=!isBrowser&&typeof importScripts!="undefined",readyRegExp=isBrowser&&navigator.platform==="PLAYSTATION 3"?/^complete$/:/^(complete|loaded)$/,defContextName="_",isOpera=typeof opera!="undefined"&&opera.toString()==="[object Opera]",contexts={},cfg={},globalDefQueue=[],useInteractive=!1;function isFunction(it){return ostring.call(it)==="[object Function]"}function isArray(it){return ostring.call(it)==="[object Array]"}function each(ary,func){if(ary){var i;for(i=0;i<ary.length;i+=1)if(ary[i]&&func(ary[i],i,ary))break}}function eachReverse(ary,func){if(ary){var i;for(i=ary.length-1;i>-1;i-=1)if(ary[i]&&func(ary[i],i,ary))break}}function hasProp(obj,prop){return hasOwn.call(obj,prop)}function getOwn(obj,prop){return hasProp(obj,prop)&&obj[prop]}function eachProp(obj,func){var prop;for(prop in obj)if(hasProp(obj,prop)&&func(obj[prop],prop))break}function mixin(target,source,force,deepStringMixin){return source&&eachProp(source,function(value,prop){if(force||!hasProp(target,prop))deepStringMixin&&typeof value=="object"&&value&&!isArray(value)&&!isFunction(value)&&!(value instanceof RegExp)?(target[prop]||(target[prop]={}),mixin(target[prop],value,force,deepStringMixin)):target[prop]=value}),target}function bind(obj,fn){return function(){return fn.apply(obj,arguments)}}function scripts(){return document.getElementsByTagName("script")}function defaultOnError(err){throw err}function getGlobal(value){if(!value)return value;var g=global;return each(value.split("."),function(part){g=g[part]}),g}function makeError(id,msg,err,requireModules){var e=new Error(msg+"\nhttp://requirejs.org/docs/errors.html#"+id);return e.requireType=id,e.requireModules=requireModules,err&&(e.originalError=err),e}if(typeof define!="undefined")return;if(typeof requirejs!="undefined"){if(isFunction(requirejs))return;cfg=requirejs,requirejs=undefined}typeof require!="undefined"&&!isFunction(require)&&(cfg=require,require=undefined);function newContext(contextName){var inCheckLoaded,Module,context,handlers,checkLoadedTimeoutId,config={waitSeconds:7,baseUrl:"./",paths:{},bundles:{},pkgs:{},shim:{},config:{}},registry={},enabledRegistry={},undefEvents={},defQueue=[],defined={},urlFetched={},bundlesMap={},requireCounter=1,unnormalizedCounter=1;function trimDots(ary){var i,part;for(i=0;i<ary.length;i++){part=ary[i];if(part===".")ary.splice(i,1),i-=1;else if(part===".."){if(i===0||i===1&&ary[2]===".."||ary[i-1]==="..")continue;i>0&&(ary.splice(i-1,2),i-=2)}}}function normalize(name,baseName,applyMap){var pkgMain,mapValue,nameParts,i,j,nameSegment,lastIndex,foundMap,foundI,foundStarMap,starI,normalizedBaseParts,baseParts=baseName&&baseName.split("/"),map=config.map,starMap=map&&map["*"];name&&(name=name.split("/"),lastIndex=name.length-1,config.nodeIdCompat&&jsSuffixRegExp.test(name[lastIndex])&&(name[lastIndex]=name[lastIndex].replace(jsSuffixRegExp,"")),name[0].charAt(0)==="."&&baseParts&&(normalizedBaseParts=baseParts.slice(0,baseParts.length-1),name=normalizedBaseParts.concat(name)),trimDots(name),name=name.join("/"));if(applyMap&&map&&(baseParts||starMap)){nameParts=name.split("/");outerLoop:for(i=nameParts.length;i>0;i-=1){nameSegment=nameParts.slice(0,i).join("/");if(baseParts)for(j=baseParts.length;j>0;j-=1){mapValue=getOwn(map,baseParts.slice(0,j).join("/"));if(mapValue){mapValue=getOwn(mapValue,nameSegment);if(mapValue){foundMap=mapValue,foundI=i;break outerLoop}}}!foundStarMap&&starMap&&getOwn(starMap,nameSegment)&&(foundStarMap=getOwn(starMap,nameSegment),starI=i)}!foundMap&&foundStarMap&&(foundMap=foundStarMap,foundI=starI),foundMap&&(nameParts.splice(0,foundI,foundMap),name=nameParts.join("/"))}return pkgMain=getOwn(config.pkgs,name),pkgMain?pkgMain:name}function removeScript(name){isBrowser&&each(scripts(),function(scriptNode){if(scriptNode.getAttribute("data-requiremodule")===name&&scriptNode.getAttribute("data-requirecontext")===context.contextName)return scriptNode.parentNode.removeChild(scriptNode),!0})}function hasPathFallback(id){var pathConfig=getOwn(config.paths,id);if(pathConfig&&isArray(pathConfig)&&pathConfig.length>1)return pathConfig.shift(),context.require.undef(id),context.makeRequire(null,{skipMap:!0})([id]),!0}function splitPrefix(name){var prefix,index=name?name.indexOf("!"):-1;return index>-1&&(prefix=name.substring(0,index),name=name.substring(index+1,name.length)),[prefix,name]}function makeModuleMap(name,parentModuleMap,isNormalized,applyMap){var url,pluginModule,suffix,nameParts,prefix=null,parentName=parentModuleMap?parentModuleMap.name:null,originalName=name,isDefine=!0,normalizedName="";return name||(isDefine=!1,name="_@r"+(requireCounter+=1)),nameParts=splitPrefix(name),prefix=nameParts[0],name=nameParts[1],prefix&&(prefix=normalize(prefix,parentName,applyMap),pluginModule=getOwn(defined,prefix)),name&&(prefix?pluginModule&&pluginModule.normalize?normalizedName=pluginModule.normalize(name,function(name){return normalize(name,parentName,applyMap)}):normalizedName=name.indexOf("!")===-1?normalize(name,parentName,applyMap):name:(normalizedName=normalize(name,parentName,applyMap),nameParts=splitPrefix(normalizedName),prefix=nameParts[0],normalizedName=nameParts[1],isNormalized=!0,url=context.nameToUrl(normalizedName))),suffix=prefix&&!pluginModule&&!isNormalized?"_unnormalized"+(unnormalizedCounter+=1):"",{prefix:prefix,name:normalizedName,parentMap:parentModuleMap,unnormalized:!!suffix,url:url,originalName:originalName,isDefine:isDefine,id:(prefix?prefix+"!"+normalizedName:normalizedName)+suffix}}function getModule(depMap){var id=depMap.id,mod=getOwn(registry,id);return mod||(mod=registry[id]=new context.Module(depMap)),mod}function on(depMap,name,fn){var id=depMap.id,mod=getOwn(registry,id);hasProp(defined,id)&&(!mod||mod.defineEmitComplete)?name==="defined"&&fn(defined[id]):(mod=getModule(depMap),mod.error&&name==="error"?fn(mod.error):mod.on(name,fn))}function onError(err,errback){var ids=err.requireModules,notified=!1;errback?errback(err):(each(ids,function(id){var mod=getOwn(registry,id);mod&&(mod.error=err,mod.events.error&&(notified=!0,mod.emit("error",err)))}),notified||req.onError(err))}function takeGlobalQueue(){globalDefQueue.length&&(each(globalDefQueue,function(queueItem){var id=queueItem[0];typeof id=="string"&&(context.defQueueMap[id]=!0),defQueue.push(queueItem)}),globalDefQueue=[])}handlers={require:function(mod){return mod.require?mod.require:mod.require=context.makeRequire(mod.map)},exports:function(mod){mod.usingExports=!0;if(mod.map.isDefine)return mod.exports?defined[mod.map.id]=mod.exports:mod.exports=defined[mod.map.id]={}},module:function(mod){return mod.module?mod.module:mod.module={id:mod.map.id,uri:mod.map.url,config:function(){return getOwn(config.config,mod.map.id)||{}},exports:mod.exports||(mod.exports={})}}};function cleanRegistry(id){delete registry[id],delete enabledRegistry[id]}function breakCycle(mod,traced,processed){var id=mod.map.id;mod.error?mod.emit("error",mod.error):(traced[id]=!0,each(mod.depMaps,function(depMap,i){var depId=depMap.id,dep=getOwn(registry,depId);dep&&!mod.depMatched[i]&&!processed[depId]&&(getOwn(traced,depId)?(mod.defineDep(i,defined[depId]),mod.check()):breakCycle(dep,traced,processed))}),processed[id]=!0)}function checkLoaded(){var err,usingPathFallback,waitInterval=config.waitSeconds*1e3,expired=waitInterval&&context.startTime+waitInterval<(new Date).getTime(),noLoads=[],reqCalls=[],stillLoading=!1,needCycleCheck=!0;if(inCheckLoaded)return;inCheckLoaded=!0,eachProp(enabledRegistry,function(mod){var map=mod.map,modId=map.id;if(!mod.enabled)return;map.isDefine||reqCalls.push(mod);if(!mod.error)if(!mod.inited&&expired)hasPathFallback(modId)?(usingPathFallback=!0,stillLoading=!0):(noLoads.push(modId),removeScript(modId));else if(!mod.inited&&mod.fetched&&map.isDefine){stillLoading=!0;if(!map.prefix)return needCycleCheck=!1}});if(expired&&noLoads.length)return err=makeError("timeout","Load timeout for modules: "+noLoads,null,noLoads),err.contextName=context.contextName,onError(err);needCycleCheck&&each(reqCalls,function(mod){breakCycle(mod,{},{})}),(!expired||usingPathFallback)&&stillLoading&&(isBrowser||isWebWorker)&&!checkLoadedTimeoutId&&(checkLoadedTimeoutId=setTimeout(function(){checkLoadedTimeoutId=0,checkLoaded()},50)),inCheckLoaded=!1}Module=function(map){this.events=getOwn(undefEvents,map.id)||{},this.map=map,this.shim=getOwn(config.shim,map.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},Module.prototype={init:function(depMaps,factory,errback,options){options=options||{};if(this.inited)return;this.factory=factory,errback?this.on("error",errback):this.events.error&&(errback=bind(this,function(err){this.emit("error",err)})),this.depMaps=depMaps&&depMaps.slice(0),this.errback=errback,this.inited=!0,this.ignore=options.ignore,options.enabled||this.enabled?this.enable():this.check()},defineDep:function(i,depExports){this.depMatched[i]||(this.depMatched[i]=!0,this.depCount-=1,this.depExports[i]=depExports)},fetch:function(){if(this.fetched)return;this.fetched=!0,context.startTime=(new Date).getTime();var map=this.map;if(!this.shim)return map.prefix?this.callPlugin():this.load();context.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],bind(this,function(){return map.prefix?this.callPlugin():this.load()}))},load:function(){var url=this.map.url;urlFetched[url]||(urlFetched[url]=!0,context.load(this.map.id,url))},check:function(){if(!this.enabled||this.enabling)return;var err,cjsModule,id=this.map.id,depExports=this.depExports,exports=this.exports,factory=this.factory;if(!this.inited)hasProp(context.defQueueMap,id)||this.fetch();else if(this.error)this.emit("error",this.error);else if(!this.defining){this.defining=!0;if(this.depCount<1&&!this.defined){if(isFunction(factory)){try{exports=context.execCb(id,factory,depExports,exports)}catch(e){err=e}this.map.isDefine&&exports===undefined&&(cjsModule=this.module,cjsModule?exports=cjsModule.exports:this.usingExports&&(exports=this.exports));if(err){if(this.events.error&&this.map.isDefine||req.onError!==defaultOnError)return err.requireMap=this.map,err.requireModules=this.map.isDefine?[this.map.id]:null,err.requireType=this.map.isDefine?"define":"require",onError(this.error=err);typeof console!="undefined"&&console.error?console.error(err):req.onError(err)}}else exports=factory;this.exports=exports;if(this.map.isDefine&&!this.ignore){defined[id]=exports;if(req.onResourceLoad){var resLoadMaps=[];each(this.depMaps,function(depMap){resLoadMaps.push(depMap.normalizedMap||depMap)}),req.onResourceLoad(context,this.map,resLoadMaps)}}cleanRegistry(id),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}},callPlugin:function(){var map=this.map,id=map.id,pluginMap=makeModuleMap(map.prefix);this.depMaps.push(pluginMap),on(pluginMap,"defined",bind(this,function(plugin){var load,normalizedMap,normalizedMod,bundleId=getOwn(bundlesMap,this.map.id),name=this.map.name,parentName=this.map.parentMap?this.map.parentMap.name:null,localRequire=context.makeRequire(map.parentMap,{enableBuildCallback:!0});if(this.map.unnormalized){plugin.normalize&&(name=plugin.normalize(name,function(name){return normalize(name,parentName,!0)})||""),normalizedMap=makeModuleMap(map.prefix+"!"+name,this.map.parentMap),on(normalizedMap,"defined",bind(this,function(value){this.map.normalizedMap=normalizedMap,this.init([],function(){return value},null,{enabled:!0,ignore:!0})})),normalizedMod=getOwn(registry,normalizedMap.id),normalizedMod&&(this.depMaps.push(normalizedMap),this.events.error&&normalizedMod.on("error",bind(this,function(err){this.emit("error",err)})),normalizedMod.enable());return}if(bundleId){this.map.url=context.nameToUrl(bundleId),this.load();return}load=bind(this,function(value){this.init([],function(){return value},null,{enabled:!0})}),load.error=bind(this,function(err){this.inited=!0,this.error=err,err.requireModules=[id],eachProp(registry,function(mod){mod.map.id.indexOf(id+"_unnormalized")===0&&cleanRegistry(mod.map.id)}),onError(err)}),load.fromText=bind(this,function(text,textAlt){var moduleName=map.name,moduleMap=makeModuleMap(moduleName),hasInteractive=useInteractive;textAlt&&(text=textAlt),hasInteractive&&(useInteractive=!1),getModule(moduleMap),hasProp(config.config,id)&&(config.config[moduleName]=config.config[id]);try{req.exec(text)}catch(e){return onError(makeError("fromtexteval","fromText eval for "+id+" failed: "+e,e,[id]))}hasInteractive&&(useInteractive=!0),this.depMaps.push(moduleMap),context.completeLoad(moduleName),localRequire([moduleName],load)}),plugin.load(map.name,localRequire,load,config)})),context.enable(pluginMap,this),this.pluginMaps[pluginMap.id]=pluginMap},enable:function(){enabledRegistry[this.map.id]=this,this.enabled=!0,this.enabling=!0,each(this.depMaps,bind(this,function(depMap,i){var id,mod,handler;if(typeof depMap=="string"){depMap=makeModuleMap(depMap,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[i]=depMap,handler=getOwn(handlers,depMap.id);if(handler){this.depExports[i]=handler(this);return}this.depCount+=1,on(depMap,"defined",bind(this,function(depExports){if(this.undefed)return;this.defineDep(i,depExports),this.check()})),this.errback?on(depMap,"error",bind(this,this.errback)):this.events.error&&on(depMap,"error",bind(this,function(err){this.emit("error",err)}))}id=depMap.id,mod=registry[id],!hasProp(handlers,id)&&mod&&!mod.enabled&&context.enable(depMap,this)})),eachProp(this.pluginMaps,bind(this,function(pluginMap){var mod=getOwn(registry,pluginMap.id);mod&&!mod.enabled&&context.enable(pluginMap,this)})),this.enabling=!1,this.check()},on:function(name,cb){var cbs=this.events[name];cbs||(cbs=this.events[name]=[]),cbs.push(cb)},emit:function(name,evt){each(this.events[name],function(cb){cb(evt)}),name==="error"&&delete this.events[name]}};function callGetModule(args){hasProp(defined,args[0])||getModule(makeModuleMap(args[0],null,!0)).init(args[1],args[2])}function removeListener(node,func,name,ieName){node.detachEvent&&!isOpera?ieName&&node.detachEvent(ieName,func):node.removeEventListener(name,func,!1)}function getScriptData(evt){var node=evt.currentTarget||evt.srcElement;return removeListener(node,context.onScriptLoad,"load","onreadystatechange"),removeListener(node,context.onScriptError,"error"),{node:node,id:node&&node.getAttribute("data-requiremodule")}}function intakeDefines(){var args;takeGlobalQueue();while(defQueue.length){args=defQueue.shift();if(args[0]===null)return onError(makeError("mismatch","Mismatched anonymous define() module: "+args[args.length-1]));callGetModule(args)}context.defQueueMap={}}return context={config:config,contextName:contextName,registry:registry,defined:defined,urlFetched:urlFetched,defQueue:defQueue,defQueueMap:{},Module:Module,makeModuleMap:makeModuleMap,nextTick:req.nextTick,onError:onError,configure:function(cfg){cfg.baseUrl&&cfg.baseUrl.charAt(cfg.baseUrl.length-1)!=="/"&&(cfg.baseUrl+="/");var shim=config.shim,objs={paths:!0,bundles:!0,config:!0,map:!0};eachProp(cfg,function(value,prop){objs[prop]?(config[prop]||(config[prop]={}),mixin(config[prop],value,!0,!0)):config[prop]=value}),cfg.bundles&&eachProp(cfg.bundles,function(value,prop){each(value,function(v){v!==prop&&(bundlesMap[v]=prop)})}),cfg.shim&&(eachProp(cfg.shim,function(value,id){isArray(value)&&(value={deps:value}),(value.exports||value.init)&&!value.exportsFn&&(value.exportsFn=context.makeShimExports(value)),shim[id]=value}),config.shim=shim),cfg.packages&&each(cfg.packages,function(pkgObj){var location,name;pkgObj=typeof pkgObj=="string"?{name:pkgObj}:pkgObj,name=pkgObj.name,location=pkgObj.location,location&&(config.paths[name]=pkgObj.location),config.pkgs[name]=pkgObj.name+"/"+(pkgObj.main||"main").replace(currDirRegExp,"").replace(jsSuffixRegExp,"")}),eachProp(registry,function(mod,id){!mod.inited&&!mod.map.unnormalized&&(mod.map=makeModuleMap(id,null,!0))}),(cfg.deps||cfg.callback)&&context.require(cfg.deps||[],cfg.callback)},makeShimExports:function(value){function fn(){var ret;return value.init&&(ret=value.init.apply(global,arguments)),ret||value.exports&&getGlobal(value.exports)}return fn},makeRequire:function(relMap,options){options=options||{};function localRequire(deps,callback,errback){var id,map,requireMod;return options.enableBuildCallback&&callback&&isFunction(callback)&&(callback.__requireJsBuild=!0),typeof deps=="string"?isFunction(callback)?onError(makeError("requireargs","Invalid require call"),errback):relMap&&hasProp(handlers,deps)?handlers[deps](registry[relMap.id]):req.get?req.get(context,deps,relMap,localRequire):(map=makeModuleMap(deps,relMap,!1,!0),id=map.id,hasProp(defined,id)?defined[id]:onError(makeError("notloaded",'Module name "'+id+'" has not been loaded yet for context: '+contextName+(relMap?"":". Use require([])")))):(intakeDefines(),context.nextTick(function(){intakeDefines(),requireMod=getModule(makeModuleMap(null,relMap)),requireMod.skipMap=options.skipMap,requireMod.init(deps,callback,errback,{enabled:!0}),checkLoaded()}),localRequire)}return mixin(localRequire,{isBrowser:isBrowser,toUrl:function(moduleNamePlusExt){var ext,index=moduleNamePlusExt.lastIndexOf("."),segment=moduleNamePlusExt.split("/")[0],isRelative=segment==="."||segment==="..";return index!==-1&&(!isRelative||index>1)&&(ext=moduleNamePlusExt.substring(index,moduleNamePlusExt.length),moduleNamePlusExt=moduleNamePlusExt.substring(0,index)),context.nameToUrl(normalize(moduleNamePlusExt,relMap&&relMap.id,!0),ext,!0)},defined:function(id){return hasProp(defined,makeModuleMap(id,relMap,!1,!0).id)},specified:function(id){return id=makeModuleMap(id,relMap,!1,!0).id,hasProp(defined,id)||hasProp(registry,id)}}),relMap||(localRequire.undef=function(id){takeGlobalQueue();var map=makeModuleMap(id,relMap,!0),mod=getOwn(registry,id);mod.undefed=!0,removeScript(id),delete defined[id],delete urlFetched[map.url],delete undefEvents[id],eachReverse(defQueue,function(args,i){args[0]===id&&defQueue.splice(i,1)}),delete context.defQueueMap[id],mod&&(mod.events.defined&&(undefEvents[id]=mod.events),cleanRegistry(id))}),localRequire},enable:function(depMap){var mod=getOwn(registry,depMap.id);mod&&getModule(depMap).enable()},completeLoad:function(moduleName){var found,args,mod,shim=getOwn(config.shim,moduleName)||{},shExports=shim.exports;takeGlobalQueue();while(defQueue.length){args=defQueue.shift();if(args[0]===null){args[0]=moduleName;if(found)break;found=!0}else args[0]===moduleName&&(found=!0);callGetModule(args)}context.defQueueMap={},mod=getOwn(registry,moduleName);if(!found&&!hasProp(defined,moduleName)&&mod&&!mod.inited){if(config.enforceDefine&&(!shExports||!getGlobal(shExports))){if(hasPathFallback(moduleName))return;return onError(makeError("nodefine","No define call for "+moduleName,null,[moduleName]))}callGetModule([moduleName,shim.deps||[],shim.exportsFn])}checkLoaded()},nameToUrl:function(moduleName,ext,skipExt){var paths,syms,i,parentModule,url,parentPath,bundleId,pkgMain=getOwn(config.pkgs,moduleName);pkgMain&&(moduleName=pkgMain),bundleId=getOwn(bundlesMap,moduleName);if(bundleId)return context.nameToUrl(bundleId,ext,skipExt);if(req.jsExtRegExp.test(moduleName))url=moduleName+(ext||"");else{paths=config.paths,syms=moduleName.split("/");for(i=syms.length;i>0;i-=1){parentModule=syms.slice(0,i).join("/"),parentPath=getOwn(paths,parentModule);if(parentPath){isArray(parentPath)&&(parentPath=parentPath[0]),syms.splice(0,i,parentPath);break}}url=syms.join("/"),url+=ext||(/^data\:|\?/.test(url)||skipExt?"":".js"),url=(url.charAt(0)==="/"||url.match(/^[\w\+\.\-]+:/)?"":config.baseUrl)+url}return config.urlArgs?url+((url.indexOf("?")===-1?"?":"&")+config.urlArgs):url},load:function(id,url){req.load(context,id,url)},execCb:function(name,callback,args,exports){return callback.apply(exports,args)},onScriptLoad:function(evt){if(evt.type==="load"||readyRegExp.test((evt.currentTarget||evt.srcElement).readyState)){interactiveScript=null;var data=getScriptData(evt);context.completeLoad(data.id)}},onScriptError:function(evt){var data=getScriptData(evt);if(!hasPathFallback(data.id)){var parents=[];return eachProp(registry,function(value,key){key.indexOf("_@r")!==0&&each(value.depMaps,function(depMap){return depMap.id===data.id&&parents.push(key),!0})}),onError(makeError("scripterror",'Script error for "'+data.id+(parents.length?'", needed by: '+parents.join(", "):'"'),evt,[data.id]))}}},context.require=context.makeRequire(),context}req=requirejs=function(deps,callback,errback,optional){var context,config,contextName=defContextName;return!isArray(deps)&&typeof deps!="string"&&(config=deps,isArray(callback)?(deps=callback,callback=errback,errback=optional):deps=[]),config&&config.context&&(contextName=config.context),context=getOwn(contexts,contextName),context||(context=contexts[contextName]=req.s.newContext(contextName)),config&&context.configure(config),context.require(deps,callback,errback)},req.config=function(config){return req(config)},req.nextTick=typeof setTimeout!="undefined"?function(fn){setTimeout(fn,4)}:function(fn){fn()},require||(require=req),req.version=version,req.jsExtRegExp=/^\/|:|\?|\.js$/,req.isBrowser=isBrowser,s=req.s={contexts:contexts,newContext:newContext},req({}),each(["toUrl","undef","defined","specified"],function(prop){req[prop]=function(){var ctx=contexts[defContextName];return ctx.require[prop].apply(ctx,arguments)}}),isBrowser&&(head=s.head=document.getElementsByTagName("head")[0],baseElement=document.getElementsByTagName("base")[0],baseElement&&(head=s.head=baseElement.parentNode)),req.onError=defaultOnError,req.createNode=function(config,moduleName,url){var node=config.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script");return node.type=config.scriptType||"text/javascript",node.charset="utf-8",node.async=!0,node},req.load=function(context,moduleName,url){var config=context&&context.config||{},node;if(isBrowser)return node=req.createNode(config,moduleName,url),config.onNodeCreated&&config.onNodeCreated(node,config,moduleName,url),node.setAttribute("data-requirecontext",context.contextName),node.setAttribute("data-requiremodule",moduleName),node.attachEvent&&!(node.attachEvent.toString&&node.attachEvent.toString().indexOf("[native code")<0)&&!isOpera?(useInteractive=!0,node.attachEvent("onreadystatechange",context.onScriptLoad)):(node.addEventListener("load",context.onScriptLoad,!1),node.addEventListener("error",context.onScriptError,!1)),node.src=url,currentlyAddingScript=node,baseElement?head.insertBefore(node,baseElement):head.appendChild(node),currentlyAddingScript=null,node;if(isWebWorker)try{importScripts(url),context.completeLoad(moduleName)}catch(e){context.onError(makeError("importscripts","importScripts failed for "+moduleName+" at "+url,e,[moduleName]))}};function getInteractiveScript(){return interactiveScript&&interactiveScript.readyState==="interactive"?interactiveScript:(eachReverse(scripts(),function(script){if(script.readyState==="interactive")return interactiveScript=script}),interactiveScript)}isBrowser&&!cfg.skipDataMain&&eachReverse(scripts(),function(script){head||(head=script.parentNode),dataMain=script.getAttribute("data-main");if(dataMain)return mainScript=dataMain,cfg.baseUrl||(src=mainScript.split("/"),mainScript=src.pop(),subPath=src.length?src.join("/")+"/":"./",cfg.baseUrl=subPath),mainScript=mainScript.replace(jsSuffixRegExp,""),req.jsExtRegExp.test(mainScript)&&(mainScript=dataMain),cfg.deps=cfg.deps?cfg.deps.concat(mainScript):[mainScript],!0}),define=function(name,deps,callback){var node,context;typeof name!="string"&&(callback=deps,deps=name,name=null),isArray(deps)||(callback=deps,deps=null),!deps&&isFunction(callback)&&(deps=[],callback.length&&(callback.toString().replace(commentRegExp,"").replace(cjsRequireRegExp,function(match,dep){deps.push(dep)}),deps=(callback.length===1?["require"]:["require","exports","module"]).concat(deps))),useInteractive&&(node=currentlyAddingScript||getInteractiveScript(),node&&(name||(name=node.getAttribute("data-requiremodule")),context=contexts[node.getAttribute("data-requirecontext")])),context?(context.defQueue.push([name,deps,callback]),context.defQueueMap[name]=!0):globalDefQueue.push([name,deps,callback])},define.amd={jQuery:!0},req.exec=function(text){return eval(text)},req(cfg)})(this),define("requireLib",function(){}),define("text",["module"],function(module){"use strict";var text,fs,Cc,Ci,xpcIsWindows,progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],xmlRegExp=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,bodyRegExp=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,hasLocation=typeof location!="undefined"&&location.href,defaultProtocol=hasLocation&&location.protocol&&location.protocol.replace(/\:/,""),defaultHostName=hasLocation&&location.hostname,defaultPort=hasLocation&&(location.port||undefined),buildMap={},masterConfig=module.config&&module.config()||{};function useDefault(value,defaultValue){return value===undefined||value===""?defaultValue:value}function isSamePort(protocol1,port1,protocol2,port2){if(port1===port2)return!0;if(protocol1===protocol2){if(protocol1==="http")return useDefault(port1,"80")===useDefault(port2,"80");if(protocol1==="https")return useDefault(port1,"443")===useDefault(port2,"443")}return!1}text={version:"2.0.15",strip:function(content){if(content){content=content.replace(xmlRegExp,"");var matches=content.match(bodyRegExp);matches&&(content=matches[1])}else content="";return content},jsEscape:function(content){return content.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:masterConfig.createXhr||function(){var xhr,i,progId;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}return xhr},parseName:function(name){var modName,ext,temp,strip=!1,index=name.lastIndexOf("."),isRelative=name.indexOf("./")===0||name.indexOf("../")===0;return index!==-1&&(!isRelative||index>1)?(modName=name.substring(0,index),ext=name.substring(index+1)):modName=name,temp=ext||modName,index=temp.indexOf("!"),index!==-1&&(strip=temp.substring(index+1)==="strip",temp=temp.substring(0,index),ext?ext=temp:modName=temp),{moduleName:modName,ext:ext,strip:strip}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(url,protocol,hostname,port){var uProtocol,uHostName,uPort,match=text.xdRegExp.exec(url);return match?(uProtocol=match[2],uHostName=match[3],uHostName=uHostName.split(":"),uPort=uHostName[1],uHostName=uHostName[0],(!uProtocol||uProtocol===protocol)&&(!uHostName||uHostName.toLowerCase()===hostname.toLowerCase())&&(!uPort&&!uHostName||isSamePort(uProtocol,uPort,protocol,port))):!0},finishLoad:function(name,strip,content,onLoad){content=strip?text.strip(content):content,masterConfig.isBuild&&(buildMap[name]=content),onLoad(content)},load:function(name,req,onLoad,config){if(config&&config.isBuild&&!config.inlineText){onLoad();return}masterConfig.isBuild=config&&config.isBuild;var parsed=text.parseName(name),nonStripName=parsed.moduleName+(parsed.ext?"."+parsed.ext:""),url=req.toUrl(nonStripName),useXhr=masterConfig.useXhr||text.useXhr;if(url.indexOf("empty:")===0){onLoad();return}!hasLocation||useXhr(url,defaultProtocol,defaultHostName,defaultPort)?text.get(url,function(content){text.finishLoad(name,parsed.strip,content,onLoad)},function(err){onLoad.error&&onLoad.error(err)}):req([nonStripName],function(content){text.finishLoad(parsed.moduleName+"."+parsed.ext,parsed.strip,content,onLoad)})},write:function(pluginName,moduleName,write,config){if(buildMap.hasOwnProperty(moduleName)){var content=text.jsEscape(buildMap[moduleName]);write.asModule(pluginName+"!"+moduleName,"define(function () { return '"+content+"';});\n")}},writeFile:function(pluginName,moduleName,req,write,config){var parsed=text.parseName(moduleName),extPart=parsed.ext?"."+parsed.ext:"",nonStripName=parsed.moduleName+extPart,fileName=req.toUrl(parsed.moduleName+extPart)+".js";text.load(nonStripName,req,function(value){var textWrite=function(contents){return write(fileName,contents)};textWrite.asModule=function(moduleName,contents){return write.asModule(moduleName,fileName,contents)},text.write(pluginName,nonStripName,textWrite,config)},config)}};if(masterConfig.env==="node"||!masterConfig.env&&typeof process!="undefined"&&process.versions&&!!process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"])fs=require.nodeRequire("fs"),text.get=function(url,callback,errback){try{var file=fs.readFileSync(url,"utf8");file[0]==="ï»¿"&&(file=file.substring(1)),callback(file)}catch(e){errback&&errback(e)}};else if(masterConfig.env==="xhr"||!masterConfig.env&&text.createXhr())text.get=function(url,callback,errback,headers){var xhr=text.createXhr(),header;xhr.open("GET",url,!0);if(headers)for(header in headers)headers.hasOwnProperty(header)&&xhr.setRequestHeader(header.toLowerCase(),headers[header]);masterConfig.onXhr&&masterConfig.onXhr(xhr,url),xhr.onreadystatechange=function(evt){var status,err;xhr.readyState===4&&(status=xhr.status||0,status>399&&status<600?(err=new Error(url+" HTTP status: "+status),err.xhr=xhr,errback&&errback(err)):callback(xhr.responseText),masterConfig.onXhrComplete&&masterConfig.onXhrComplete(xhr,url))},xhr.send(null)};else if(masterConfig.env==="rhino"||!masterConfig.env&&typeof Packages!="undefined"&&typeof java!="undefined")text.get=function(url,callback){var stringBuffer,line,encoding="utf-8",file=new java.io.File(url),lineSeparator=java.lang.System.getProperty("line.separator"),input=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file),encoding)),content="";try{stringBuffer=new java.lang.StringBuffer,line=input.readLine(),line&&line.length()&&line.charAt(0)===65279&&(line=line.substring(1)),line!==null&&stringBuffer.append(line);while((line=input.readLine())!==null)stringBuffer.append(lineSeparator),stringBuffer.append(line);content=String(stringBuffer.toString())}finally{input.close()}callback(content)};else if(masterConfig.env==="xpconnect"||!masterConfig.env&&typeof Components!="undefined"&&Components.classes&&Components.interfaces)Cc=Components.classes,Ci=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),xpcIsWindows="@mozilla.org/windows-registry-key;1"in Cc,text.get=function(url,callback){var inStream,convertStream,fileObj,readData={};xpcIsWindows&&(url=url.replace(/\//g,"\\")),fileObj=new FileUtils.File(url);try{inStream=Cc["@mozilla.org/network/file-input-stream;1"].createInstance(Ci.nsIFileInputStream),inStream.init(fileObj,1,0,!1),convertStream=Cc["@mozilla.org/intl/converter-input-stream;1"].createInstance(Ci.nsIConverterInputStream),convertStream.init(inStream,"utf-8",inStream.available(),Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),convertStream.readString(inStream.available(),readData),convertStream.close(),inStream.close(),callback(readData.value)}catch(e){throw new Error((fileObj&&fileObj.path||"")+": "+e)}};return text}),define("Core/Visual/AddressBarManager",["require","exports"],function(require,exports){var AddressBarManager=function(){function AddressBarManager(){this.DefaultTitle="BlokDust"}return AddressBarManager.prototype.UpdateURL=function(url){window.history.pushState({html:"Reset"},this.DefaultTitle,""+url),document.title=this.DefaultTitle},AddressBarManager.prototype.StripURL=function(){var currentUrl=window.location.href,splitUrl=currentUrl.split("?");splitUrl.length>1&&(window.history.pushState({html:"Reset"},this.DefaultTitle,""+splitUrl[0]),window.onpopstate=function(){window.location.reload()}),document.title=this.DefaultTitle},AddressBarManager}();exports.AddressBarManager=AddressBarManager}),define("Core/Audio/Connections/AudioChain",["require","exports"],function(require,exports){var AudioChain=function(){function AudioChain(){this.Connections=[],this.Sources=[],this.PostEffects=[],this.PowerSources=[],this.PreEffects=[],this.PowerEffects=[]}return AudioChain}();exports.AudioChain=AudioChain});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Block",["require","exports","../Core/Audio/Connections/AudioChain"],function(require,exports,AudioChain_1){var DisplayObject=etch.drawing.DisplayObject,ObservableCollection=etch.collections.ObservableCollection,Point=etch.primitives.Point,RoutedEvent=etch.events.RoutedEvent,RoutedEventArgs=etch.events.RoutedEventArgs,Block=function(_super){__extends(Block,_super);function Block(){_super.apply(this,arguments),this.Click=new RoutedEvent,this.IsChained=!1,this.IsPressed=!1,this.IsSelected=!1,this.Connections=new ObservableCollection,this.Outline=[],this.Duplicable=!1}return Block.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Version=0,this.Chain=new AudioChain_1.AudioChain,this.Update()},Block.prototype.PopulateParams=function(){var paramsCopy={};if(this.Params){this.BackwardsCompatibilityPatch();for(var key in this.Params)paramsCopy[""+key]=this.Params[""+key]}var params=this.Params={},defaults=this.Defaults;for(var key in defaults)paramsCopy[""+key]||paramsCopy[""+key]==0?params[""+key]=paramsCopy[""+key]:params[""+key]=defaults[""+key]},Block.prototype.BackwardsCompatibilityPatch=function(){},Block.prototype.Update=function(){},Block.prototype.Draw=function(){_super.prototype.Draw.call(this),this.Ctx.globalAlpha=this.IsPressed&&this.IsSelected?.5:1},Block.prototype.DrawSprite=function(type,option){App.BlockSprites.DrawSprite(this.DrawTo.BlocksContainer,this.Position,!0,type.toLowerCase(),option)},Block.prototype.MouseDown=function(){this.IsPressed=!0,this.LastPosition=this.Position.Clone(),this.Click.raise(this,new RoutedEventArgs)},Block.prototype.TouchDown=function(){this.IsPressed=!0},Block.prototype.MouseUp=function(){this.IsPressed=!1,this.Duplicable=!0},Block.prototype.MouseMove=function(point){this.IsPressed&&(App.CommandsInputManager.IsKeyCodeDown(KeyCodes.KeyDown.Alt)&&this.Duplicable?(this.DrawTo.CreateBlockFromType(this.Type,this.Params),this.MouseUp()):this.Position=App.Metrics.CursorToGrid(point))},Block.prototype.SetSearchResults=function(results){},Block.prototype.SetReversedBuffer=function(buffer){},Block.prototype.HitTest=function(point){this.Ctx.beginPath(),this.DrawMoveTo(this.Outline[0].x,this.Outline[0].y);for(var i=1;i<this.Outline.length;i++)this.DrawLineTo(this.Outline[i].x,this.Outline[i].y);return this.Ctx.closePath(),this.Ctx.isPointInPath(point.x,point.y)},Block.prototype.DrawMoveTo=function(x,y){var p=App.Metrics.GetRelativePoint(this.Position,new Point(x,y));p=App.Metrics.PointOnGrid(p),this.Ctx.moveTo(p.x,p.y)},Block.prototype.DrawLineTo=function(x,y){var p=App.Metrics.GetRelativePoint(this.Position,new Point(x,y));p=App.Metrics.PointOnGrid(p),this.Ctx.lineTo(p.x,p.y)},Block.prototype.ParticleCollision=function(particle){},Block.prototype.UpdateOptionsForm=function(){},Block.prototype.SetParam=function(param,value){},Block.prototype.RefreshOptionsPanel=function(cmd){App.MainScene.OptionsPanel.Scale>0&&App.MainScene.OptionsPanel.SelectedBlock==this&&(this.UpdateOptionsForm(),App.MainScene.OptionsPanel.Populate(this.OptionsForm,!1)),cmd?cmd==="animate"&&(App.MainScene.OptionsPanel.Animating=!0):App.MainScene.OptionsPanel.Animating=!1},Block.prototype.RefreshOption=function(optionNo){App.MainScene.OptionsPanel.Scale>0&&App.MainScene.OptionsPanel.SelectedBlock==this&&(this.UpdateOptionsForm(),App.MainScene.OptionsPanel.RefreshOption(optionNo,this.OptionsForm))},Block.prototype.UpdateConnections=function(chain){this.Chain=chain},Block.prototype.DistanceFrom=function(point){var p=App.Metrics.ConvertGridUnitsToAbsolute(this.Position);return Math.distanceBetween(p.x,p.y,point.x,point.y)},Block.prototype.Refresh=function(){},Block.prototype.Stop=function(){},Block.prototype.Dispose=function(){_super.prototype.Dispose.call(this)},Block}(DisplayObject);exports.Block=Block});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effect",["require","exports","./Block"],function(require,exports,Block_1){var ObservableCollection=etch.collections.ObservableCollection,Effect=function(_super){__extends(Effect,_super);function Effect(){_super.apply(this,arguments),this.CatchmentArea=6,this.Connections=new ObservableCollection}return Effect.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.UpdateOptionsForm()},Effect.prototype.Update=function(){_super.prototype.Update.call(this)},Effect.prototype.AddSource=function(source){this.Connections.Add(source)},Effect.prototype.RemoveSource=function(source){this.Connections.Remove(source)},Effect.prototype.ValidateSources=function(){for(var i=0;i<this.Connections.Count;i++){var src=this.Connections.GetValueAt(i);App.Sources.contains(src)||this.RemoveSource(src)}},Effect.prototype.Dispose=function(){_super.prototype.Dispose.call(this)},Effect}(Block_1.Block);exports.Effect=Effect});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/PowerEffect",["require","exports","../Effect"],function(require,exports,Effect_1){var PowerEffect=function(_super){__extends(PowerEffect,_super);function PowerEffect(){_super.apply(this,arguments),this.OldConnections=[]}return PowerEffect.prototype.Init=function(sketch){_super.prototype.Init.call(this,sketch)},PowerEffect.prototype.UpdateConnections=function(){},PowerEffect}(Effect_1.Effect);exports.PowerEffect=PowerEffect});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/Power",["require","exports","./PowerEffect"],function(require,exports,PowerEffect_1){var Point=etch.primitives.Point,Power=function(_super){__extends(Power,_super);function Power(){_super.apply(this,arguments)}return Power.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Power.Blocks.Power.name,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(1,-2),new Point(2,-1),new Point(2,0),new Point(0,2),new Point(-1,1))},Power.prototype.UpdateConnections=function(){var _this=this,newConnections=this.Connections.ToArray();this.OldConnections.forEach(function(source){newConnections.indexOf(source)===-1&&source.RemovePower()}),newConnections.forEach(function(source){_this.OldConnections.indexOf(source)===-1&&source.AddPower()}),this.OldConnections=newConnections},Power.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Power.prototype.Stop=function(){var connections=this.Connections.ToArray();connections.forEach(function(source){source.RemovePower()})},Power}(PowerEffect_1.PowerEffect);exports.Power=Power}),define("Blocks/Interaction/VoiceObject",["require","exports"],function(require,exports){var VoiceCreator=function(){function VoiceCreator(id){this.ID=id}return Object.defineProperty(VoiceCreator.prototype,"Key",{get:function(){return this._key},set:function(key){this._key=key},enumerable:!0,configurable:!0}),Object.defineProperty(VoiceCreator.prototype,"Controller",{get:function(){return this._controller},set:function(controller){this._controller=controller},enumerable:!0,configurable:!0}),Object.defineProperty(VoiceCreator.prototype,"Note",{get:function(){return this._note},set:function(note){this._note=note},enumerable:!0,configurable:!0}),Object.defineProperty(VoiceCreator.prototype,"ControllerMods",{get:function(){return this._controllerMods},set:function(controllerMods){this._controllerMods=controllerMods},enumerable:!0,configurable:!0}),VoiceCreator}();exports.VoiceCreator=VoiceCreator});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Interaction/Controller",["require","exports","../Power/PowerEffect"],function(require,exports,PowerEffect_1){var Controller=function(_super){__extends(Controller,_super);function Controller(){_super.apply(this,arguments),this.KeysDown={}}return Controller.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Transposition=0,this.TranspositionAmount=12,this.TranspositionRange=3,this.Bend=0,this.Mods=[]},Controller.prototype.NoteOn=function(note,velocity){var _this=this;velocity=velocity||127;var glide=0;this.Params.glide!==undefined&&(glide=this.Params.glide);var polyphonic=!1;this.Params.isPolyphonic!==undefined&&(polyphonic=this.Params.isPolyphonic);var connections=this.Connections.ToArray();connections.forEach(function(source){source.NoteOn(""+_this.Id,note,polyphonic,glide,velocity)})},Controller.prototype.NoteOff=function(note){var _this=this,connections=this.Connections.ToArray();connections.forEach(function(source){source.NoteOff(""+_this.Id,note)})},Controller.prototype.UpdateMods=function(){var connections=this.Connections.ToArray();connections.forEach(function(source){source.NoteUpdate()})},Controller.prototype.GetPitchMods=function(){var pitchMods=this.Transposition+this.Bend;for(var i=0;i<this.Mods.length;i++)pitchMods+=this.Mods[i];return pitchMods},Controller.prototype.ExecuteCodeCommand=function(code){switch(code){case 1e3:this.Transposition>-(this.TranspositionAmount*this.TranspositionRange)&&(this.Transposition-=this.TranspositionAmount,this.Params.transpose!==undefined&&(this.Params.transpose-=1,this.RefreshOptionsPanel()),this.UpdateMods());break;case 1001:this.Transposition<this.TranspositionAmount*this.TranspositionRange&&(this.Transposition+=this.TranspositionAmount,this.Params.transpose!==undefined&&(this.Params.transpose+=1,this.RefreshOptionsPanel()),this.UpdateMods())}},Controller.prototype.UpdateConnections=function(){},Controller.prototype.MidiVelocityToGain=function(velocity){return velocity/127},Controller}(PowerEffect_1.PowerEffect);exports.Controller=Controller});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Source",["require","exports","./Block","./Power/Power","./Interaction/VoiceObject","./Interaction/Controller"],function(require,exports,Block_1,Power_1,VoiceObject_1,Controller_1){var ObservableCollection=etch.collections.ObservableCollection,Source=function(_super){__extends(Source,_super);function Source(){_super.apply(this,arguments),this.Connections=new ObservableCollection,this.Settings={envelope:{attack:.01,decay:.5,sustain:.5,release:.01},output:{volume:.5}},this.PowerAmount=0}return Source.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Sources=[],this.Envelopes=[],this.ActiveVoices=[],this.FreeVoices=[],this.ParticlePowered=!1,this.LaserPowered=!1,this instanceof Power_1.Power||(this.AudioInput=new Tone.Mono,this.AudioInput.connect(App.Audio.Master)),this.UpdateOptionsForm()},Source.prototype.AddEffect=function(effect){this.Connections.Add(effect)},Source.prototype.RemoveEffect=function(effect){this.Connections.Remove(effect)},Source.prototype.ValidateEffects=function(){for(var i=0;i<this.Connections.Count;i++){var effect=this.Connections.GetValueAt(i);App.Effects.contains(effect)||this.RemoveEffect(effect)}},Source.prototype.UpdateConnections=function(chain){_super.prototype.UpdateConnections.call(this,chain),this._EnvelopeReset(),this.DeactivateDisconnectedVoices()},Source.prototype._EnvelopeReset=function(){var _this=this;this.Envelopes.length?this.Envelopes.forEach(function(e){e.attack=_this.Settings.envelope.attack,e.decay=_this.Settings.envelope.decay,e.sustain=_this.Settings.envelope.sustain,e.release=_this.Settings.envelope.release}):this.Sources[0]instanceof Tone.Simpler&&this.Sources.forEach(function(s){var e=s.envelope;e.attack=_this.Settings.envelope.attack,e.decay=_this.Settings.envelope.decay,e.sustain=_this.Settings.envelope.sustain,e.release=_this.Settings.envelope.release})},Source.prototype.CreateSource=function(){if(this.Sources[this.Sources.length-1])return this.Sources[this.Sources.length-1]},Source.prototype.CreateEnvelope=function(){if(this.Envelopes[this.Envelopes.length-1])return this.Envelopes[this.Envelopes.length-1]},Source.prototype.IsASoundSource=function(){return this.Envelopes.length||this.Sources.length},Source.prototype.IsMyName=function(name){return name===this.BlockName},Source.prototype.Stop=function(){this.DeactivateAllVoices()},Source.prototype.TriggerAttack=function(index){index===void 0&&(index=0),this.Envelopes.length?index==="all"?this.Envelopes.forEach(function(e){e.triggerAttack()}):this.Envelopes[index].triggerAttack():this.Sources[0]&&this.Sources[0].envelope?index==="all"?this.Sources.forEach(function(s){s.triggerAttack()}):this.Sources[index].triggerAttack():this.UpdateCollision!==undefined&&(this.UpdateCollision=!0)},Source.prototype.TriggerRelease=function(index,forceRelease){index===void 0&&(index=0),forceRelease===void 0&&(forceRelease=!1),this.Envelopes.length?index==="all"?this.Envelopes.forEach(function(e){e.triggerRelease()}):this.Envelopes[index].triggerRelease():this.Sources[0]&&this.Sources[0].envelope?index==="all"?this.Sources.forEach(function(s){s.triggerRelease()}):this.Sources[index].triggerRelease():this.UpdateCollision!==undefined&&(this.UpdateCollision=!0)},Source.prototype.TriggerAttackRelease=function(duration,time,velocity){duration===void 0&&(duration=App.Config.PulseLength),time===void 0&&(time="+0.01");if(this.Envelopes.length)this.Envelopes[0].triggerAttackRelease(duration);else if(this.Sources[0]&&this.Sources[0].envelope)this.Sources[0].triggerAttackRelease(!1,duration,time);else if(this.PowerAmount!==undefined){this.AddPower(),this.UpdateCollision!==undefined&&(this.UpdateCollision=!0);var block=this,seconds=App.Audio.Tone.toSeconds(duration)*1e3;setTimeout(function(){block.RemovePower(),block.UpdateCollision!==undefined&&(block.UpdateCollision=!0)},seconds)}},Source.prototype.NoteOn=function(controller,note,polyphonic,glide,velocity){note=note||App.Config.DefaultNote,polyphonic=polyphonic||!1,glide=glide||0,velocity=velocity||0;var voiceData=this.GetVoice(note,controller,polyphonic);if(voiceData.trigger||this.ActiveVoices.length>1)glide=0;this.SetPitch(note,voiceData.ID,glide),voiceData.trigger&&this.TriggerAttack(voiceData.ID)},Source.prototype.NoteOff=function(controller,note){note=note||App.Config.DefaultNote;var voiceData=this.RemoveVoice(note,controller);voiceData.trigger&&this.TriggerRelease(voiceData.ID)},Source.prototype.NoteUpdate=function(){var _this=this;this.ActiveVoices.forEach(function(voice){_this.SetPitch(voice.Note,voice.ID)})},Source.prototype.GetVoice=function(note,controller,polyphonic){var voice,trigger=!0,id=-1;return polyphonic?this.FreeVoices.length>0?voice=this.FreeVoices.shift():(voice=this.ActiveVoices.shift(),trigger=!1):this.MonoVoice?(voice=this.MonoVoice,trigger=!1):(this.FreeVoices.length>0?voice=this.FreeVoices.shift():(voice=this.ActiveVoices.shift(),trigger=!1),this.MonoVoice=voice),voice&&(voice.Note=note,voice.Controller=controller,id=voice.ID,this.ActiveVoices.indexOf(voice)==-1&&this.ActiveVoices.push(voice)),{ID:id,trigger:trigger}},Source.prototype.RemoveVoice=function(note,controller){var voice,trigger=!1,id=-1;for(var i=0;i<this.ActiveVoices.length;i++){var activeVoice=this.ActiveVoices[i];if(activeVoice.Note===note&&activeVoice.Controller===controller){voice=activeVoice,trigger=!0,id=voice.ID;if(voice===this.MonoVoice){if(this.IsPowered()){this.AssignMonoVoiceToPower(),trigger=!1;continue}this.MonoVoice=null}this.ActiveVoices.splice(i,1),this.FreeVoices.push(activeVoice)}}return{ID:id,trigger:trigger}},Source.prototype.RetriggerActiveVoices=function(){var _this=this;this.ActiveVoices.forEach(function(activeVoice,i){_this.TriggerRelease(i),_this.TriggerAttack(i)})},Source.prototype.DeactivateAllVoices=function(){var _this=this;this.ActiveVoices.forEach(function(activeVoice,i){_this.ActiveVoices.splice(i,1),_this.FreeVoices.push(activeVoice),_this.TriggerRelease(i)})},Source.prototype.DeactivateDisconnectedVoices=function(){var controllers=["power"],voices=[],connections=this.Connections.ToArray();connections.forEach(function(connection){connection instanceof Controller_1.Controller&&controllers.push(""+connection.Id)}),this.ActiveVoices.forEach(function(activeVoice){var deactivate=!0;for(var h=0;h<controllers.length;h++)activeVoice.Controller===controllers[h]&&(deactivate=!1);deactivate&&voices.push(activeVoice)});for(var i=0;i<voices.length;i++){if(voices[i]===this.MonoVoice){if(this.IsPowered()){this.AssignMonoVoiceToPower();continue}this.MonoVoice=null}var n=this.ActiveVoices.indexOf(voices[i]);this.ActiveVoices.splice(n,1),this.FreeVoices.push(voices[i]),this.TriggerRelease(voices[i].ID)}},Source.prototype.AssignMonoVoiceToPower=function(){this.MonoVoice.Controller="power",this.MonoVoice.Note=App.Config.DefaultNote,this.SetPitch(this.MonoVoice.Note,this.MonoVoice.ID)},Source.prototype.CreateFirstVoice=function(){if(!this.IsASoundSource())return;this.FreeVoices.length<1&&this.FreeVoices.push(new VoiceObject_1.VoiceCreator(0))},Source.prototype.CreateVoices=function(){if(!this.IsASoundSource())return;if(this.IsMyName(App.L10n.Blocks.Source.Blocks.Granular.name))return;var diff=App.Config.PolyphonicVoices-this.FreeVoices.length;if(diff>0)for(var i=1;i<=App.Config.PolyphonicVoices;i++){var s=this.CreateSource(),e=this.CreateEnvelope();e?(s.connect(e),s.start(),e.connect(this.AudioInput)):this.Sources[0]instanceof Tone.Simpler&&(e=this.Sources[i].envelope,s.connect(this.AudioInput)),this.FreeVoices.push(new VoiceObject_1.VoiceCreator(i))}},Source.prototype.RemoveExtraVoices=function(){if(!this.IsASoundSource())return;if(this.IsMyName(App.L10n.Blocks.Source.Blocks.Granular.name))return;this.DeactivateAllVoices(),this.TriggerRelease("all"),this.FreeVoices.length=1,this.ActiveVoices.length=0},Source.prototype.MidiToFrequency=function(note){return App.Audio.Tone.midiToFrequency(note)},Source.prototype.MidiToPlayback=function(note){return App.Audio.Tone.intervalToFrequencyRatio(note-App.Config.DefaultNote)},Source.prototype.GetSourcePitchMods=function(){var sourceMods=0;return this.Params.transpose&&(sourceMods+=this.Params.transpose),this.Params.fine&&(sourceMods+=this.Params.fine),this.Params.playbackRate&&(sourceMods+=this.Params.playbackRate),this.Params.detune&&(sourceMods+=this.Params.detune),sourceMods},Source.prototype.GetConnectedPitchMods=function(){var controllerMods=0,connections=this.Connections.ToArray();return connections.forEach(function(connection){connection instanceof Controller_1.Controller&&(controllerMods+=connection.GetPitchMods())}),controllerMods},Source.prototype.SetPitch=function(note,voiceNo,glide){var voiceNumber=voiceNo?voiceNo:0,time=glide?glide:0,pitch=note+this.GetConnectedPitchMods()+this.GetSourcePitchMods(),frequency=this.MidiToFrequency(pitch),playback=this.MidiToPlayback(pitch);if(this.Sources[voiceNumber].frequency)this.Sources[voiceNumber].frequency.linearRampToValue(frequency,time);else if(this.Sources[voiceNumber].player)Tone.isSafari?this.Sources[voiceNumber].player.playbackRate=playback:this.Sources[voiceNumber].player.playbackRate.linearRampToValue(playback,time);else if(this.Sources[0].playbackRate instanceof Tone.Signal)Tone.isSafari?this.Sources[voiceNumber].playbackRate=playback:this.Sources[voiceNumber].playbackRate.linearRampToValue(playback,time);else if(this.Grains)for(var i=0;i<this.Grains.length;i++)Tone.isSafari?this.Grains[i].playbackRate=playback:this.Grains[i].playbackRate.linearRampToValue(playback,time)},Source.prototype.MouseDown=function(){_super.prototype.MouseDown.call(this),this.AddPower()},Source.prototype.MouseUp=function(){_super.prototype.MouseUp.call(this),this.RemovePower()},Source.prototype.AddPower=function(){this.PowerAmount++;if(this.PowerAmount===1){App.MainScene&&App.MainScene.ConnectionLines.UpdateList();if(!this.IsASoundSource())return;this.NoteOn("power")}},Source.prototype.RemovePower=function(){if(this.PowerAmount===0)return;this.PowerAmount--;if(this.PowerAmount===0){App.MainScene&&App.MainScene.ConnectionLines.UpdateList();if(!this.IsASoundSource())return;this.NoteOff("power")}},Source.prototype.IsPowered=function(){return this.PowerAmount>0?!0:!1},Source.prototype.ParticleCollision=function(particle){_super.prototype.ParticleCollision.call(this,particle),this.AddPower();var that=this;setTimeout(function(){that.RemovePower()},App.Config.PulseLength),particle.Dispose()},Source.prototype.Dispose=function(){_super.prototype.Dispose.call(this),this.AudioInput&&this.AudioInput.dispose(),this.DeactivateAllVoices(),this.ActiveVoices.length&&(this.ActiveVoices.forEach(function(s){s.ID=null}),this.ActiveVoices=[]),this.FreeVoices.length&&(this.FreeVoices.forEach(function(s){s.ID=null}),this.FreeVoices=[])},Source}(Block_1.Block);exports.Source=Source});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/PostEffect",["require","exports","./../Effect"],function(require,exports,Effect_1){var PostEffect=function(_super){__extends(PostEffect,_super);function PostEffect(){_super.apply(this,arguments)}return PostEffect}(Effect_1.Effect);exports.PostEffect=PostEffect});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/PowerSource",["require","exports","../Source"],function(require,exports,Source_1){var PowerSource=function(_super){__extends(PowerSource,_super);function PowerSource(){_super.apply(this,arguments)}return PowerSource.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo)},PowerSource.prototype.UpdateConnections=function(){},PowerSource}(Source_1.Source);exports.PowerSource=PowerSource});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/PreEffect",["require","exports","./../Effect"],function(require,exports,Effect_1){var PreEffect=function(_super){__extends(PreEffect,_super);function PreEffect(){_super.apply(this,arguments)}return PreEffect}(Effect_1.Effect);exports.PreEffect=PreEffect}),define("Core/Audio/Connections/ConnectionManager",["require","exports","../../../Blocks/Source","../../../Blocks/Effects/PostEffect","../../../Blocks/Power/PowerSource","../../../Blocks/Effects/PreEffect"],function(require,exports,Source_1,PostEffect_1,PowerSource_1,PreEffect_1){var ConnectionManager=function(){function ConnectionManager(){this._Debug=!1,this.Chains=[],this._MuteBufferTime=35,this.IsConnected=!0}return ConnectionManager.prototype.Update=function(){var _this=this;this._Debug&&console.clear(),this.IsConnected=!1,App.Audio.Master.mute=!0,this._Disconnect(function(){var chains=_this.CreateChains(),powerEffects=App.PowerEffects,powerSources=App.PowerSources;_this._SortChainedBlocks(chains),_this._Connect(chains,powerEffects,powerSources),_this.IsConnected=!0})},ConnectionManager.prototype._Disconnect=function(callback){var _this=this;clearTimeout(this.connectionTimeout),clearTimeout(this.unMuteTimeout),this.connectionTimeout=setTimeout(function(){App.Blocks.forEach(function(block){block instanceof Source_1.Source?block.AudioInput.disconnect():block instanceof PostEffect_1.PostEffect&&block.Effect.disconnect(),block.IsChained=!1}),_this.Chains=[],callback()},this._MuteBufferTime)},ConnectionManager.prototype._Connect=function(chains,powerEffects,powerSources){var _this=this;this._Debug&&console.log(chains),chains.forEach(function(chain){chain.Sources.forEach(function(block){block.UpdateConnections(chain),block.Chain=chain,_this._Debug&&console.log(block)}),chain.PreEffects.forEach(function(block){setTimeout(function(){block.UpdateConnections(chain)},0),block.Chain=chain,_this._Debug&&console.log(block)}),chain.PowerSources.forEach(function(block){block.Chain=chain});if(chain.Sources.length){_this._Debug&&console.warn("Connect: ",chain.Sources," to: ",chain.PostEffects);var p=chain.PostEffects;if(p.length){var currentUnit=p[0].Effect;for(var i=1;i<p.length;i++){var toUnit=p[i].Effect;currentUnit.connect(toUnit),currentUnit=toUnit}chain.Sources.forEach(function(source){source.AudioInput.connect(p[0].Effect)}),chain.PostEffects[p.length-1].Effect.toMaster()}else chain.Sources.forEach(function(source){source.AudioInput.toMaster()})}}),powerEffects.forEach(function(powerEffect){powerEffect.UpdateConnections(),_this._Debug&&console.log(powerEffect)}),powerSources.forEach(function(powerSource){powerSource.UpdateConnections(),_this._Debug&&console.log(powerSource)}),this.unMuteTimeout=setTimeout(function(){App.Audio.Master.mute=!1},this._MuteBufferTime),App.MainScene&&App.MainScene.ConnectionLines.UpdateList()},ConnectionManager.prototype.CreateChains=function(){return this.Chains},ConnectionManager.prototype._SortChainedBlocks=function(chains){chains.forEach(function(chain){chain.Connections.forEach(function(block){block instanceof PowerSource_1.PowerSource?chain.PowerSources.push(block):block instanceof Source_1.Source?chain.Sources.push(block):block instanceof PostEffect_1.PostEffect?chain.PostEffects.push(block):block instanceof PreEffect_1.PreEffect&&chain.PreEffects.push(block)})})},ConnectionManager.prototype.GetChainFromBlock=function(block){var _chain;return this.Chains.forEach(function(chain){chain.Connections.indexOf(block)!==-1&&(_chain=chain)}),_chain},ConnectionManager.prototype.GetChainFromPreEffect=function(block){var _chain;return this.Chains.forEach(function(chain){chain.PreEffects.indexOf(block)!==-1&&(_chain=chain)}),_chain},ConnectionManager}();exports.ConnectionManager=ConnectionManager});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Core/Audio/Connections/ConnectionMethods/AccumulativeConnectionMethod",["require","exports","../AudioChain","../ConnectionManager","../../../../Blocks/Power/PowerEffect"],function(require,exports,AudioChain_1,ConnectionManager_1,PowerEffect_1){var AccumulativeConnectionMethod=function(_super){__extends(AccumulativeConnectionMethod,_super);function AccumulativeConnectionMethod(){_super.call(this)}return AccumulativeConnectionMethod.prototype.CreateChains=function(){var _this=this;return App.Blocks.forEach(function(block){if(!block.IsChained&&!(block instanceof PowerEffect_1.PowerEffect)){var chain=new AudioChain_1.AudioChain;_this.Chains.push(chain),_this._ParseConnections(chain,block)}}),this.Chains},AccumulativeConnectionMethod.prototype._ParseConnections=function(chain,parentBlock){var _this=this;if(chain.Connections.indexOf(parentBlock)===-1&&!(parentBlock instanceof PowerEffect_1.PowerEffect)){chain.Connections.push(parentBlock),parentBlock.IsChained=!0;var parentConnections=parentBlock.Connections.ToArray();parentConnections.forEach(function(childBlock){_this._ParseConnections(chain,childBlock)})}},AccumulativeConnectionMethod}(ConnectionManager_1.ConnectionManager);exports.AccumulativeConnectionMethod=AccumulativeConnectionMethod}),define("Core/Audio/AudioFileManager",["require","exports"],function(require,exports){var AudioFileManager=function(){function AudioFileManager(){}return AudioFileManager.prototype.DecodeFileData=function(files,callback){if(!files[0].type.match("audio.*")){App.Message("This is not an audio file, please try again with a .wav, .mp3 or .ogg");return}files[0].size>1e8&&App.Message("The audio file is too large. The maximum size is 100mb");var reader=new FileReader;reader.onerror=AudioFileManager.ErrorHandler,reader.onprogress=AudioFileManager.UpdateProgress,reader.onabort=function(e){App.Message("File read cancelled")},reader.onload=function(ev){App.Audio.ctx.decodeAudioData(ev.target.result,function(theBuffer){callback(files[0],theBuffer)},function(){App.Message("Sorry, we could not process this audio file."),console.error("Sorry, we could not process this audio file."),callback(files[0],undefined)})},reader.readAsArrayBuffer(files[0])},AudioFileManager.ErrorHandler=function(event){switch(event.target.error.code){case event.target.error.NOT_FOUND_ERR:App.Message("File Not Found!");break;case event.target.error.NOT_READABLE_ERR:App.Message("File is not readable");break;case event.target.error.ABORT_ERR:break;default:App.Message("An error occurred reading this file.")}},AudioFileManager.UpdateProgress=function(event){if(event.lengthComputable){var percentLoaded=Math.round(event.loaded/event.total*100);percentLoaded<100}},AudioFileManager}();exports.AudioFileManager=AudioFileManager}),define("Core/Audio/AudioNodeConnectionManager",["require","exports","../../Blocks/Effects/PostEffect"],function(require,exports,PostEffect_1){var AudioNodeConnectionManager=function(){function AudioNodeConnectionManager(){this.ExtendToneConnectionMethods()}return AudioNodeConnectionManager.prototype.ExtendToneConnectionMethods=function(){AudioNode.prototype._toneConnect=AudioNode.prototype.connect,AudioNode.prototype.connect=function(destination,outNum,inNum){destination instanceof PostEffect_1.PostEffect&&(destination=destination.Effect),this._toneConnect(destination,outNum,inNum)}},AudioNodeConnectionManager.Debug=!1,AudioNodeConnectionManager}();exports.AudioNodeConnectionManager=AudioNodeConnectionManager}),define("Core/Audio/MIDIMessageArgs",["require","exports"],function(require,exports){var MIDIMessageArgs=function(){function MIDIMessageArgs(MIDI){Object.defineProperty(this,"MIDI",{value:MIDI,writable:!1})}return MIDIMessageArgs}();exports.MIDIMessageArgs=MIDIMessageArgs}),define("Core/Audio/MIDIManager",["require","exports","./MIDIMessageArgs"],function(require,exports,MIDIMessageArgs_1){var MIDIManager=function(){function MIDIManager(){this.HasMIDICapability=!1,this.MIDIMessage=new nullstone.Event}return MIDIManager.prototype.Init=function(){navigator.requestMIDIAccess!==undefined?(this.HasMIDICapability=!0,App.Audio.MIDIManager.HasMIDICapability?(navigator.requestMIDIAccess({sysex:!1}).then(this._OnMIDIInit.bind(this),this._OnMIDIFailure.bind(this)),console.log("MIDI ready")):console.log("No access to MIDI devices or your browser doesn't support WebMIDI API")):this.HasMIDICapability=!1},MIDIManager.prototype._OnMIDIInit=function(midi){this.MIDI=midi,console.log("MIDI success",this.MIDI),this.HookUpMIDIInput(),this.MIDI.onstatechange=this.HookUpMIDIInput.bind(this)},MIDIManager.prototype.HookUpMIDIInput=function(){var i=0,inputs=this.MIDI.inputs.values();for(var input=inputs.next();input&&!input.done;input=inputs.next())input.value.onmidimessage=this._OnMIDIMessage.bind(this),console.log(input),i===0&&MIDIManager.DisplayInput(input.value),i++},MIDIManager.prototype._OnMIDIFailure=function(error){this.HasMIDICapability=!1,console.log(error)},MIDIManager.prototype._OnMIDIMessage=function(e){var args={cmd:e.data[0]>>4,channel:e.data[0]&15,type:e.data[0]&240,note:e.data[1],velocity:e.data[2]};this.MIDIMessage.raise(this,new MIDIMessageArgs_1.MIDIMessageArgs(args))},MIDIManager.DisplayInput=function(i){return typeof App.Message=="function"&&setTimeout(function(){App.Message("MIDI Controller: "+i.name+" "+i.state),console.log("Input port: [\n                    type: + "+i.type+"\n                    id: "+i.id+"\n                    manufacturer: "+i.manufacturer+"\n                    name: "+i.name+"\n                    version: "+i.version+"\n                    state: "+i.state+"\n                ]")},250),i},MIDIManager}();exports.MIDIManager=MIDIManager});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Core/Audio/Connections/ConnectionMethods/SimpleConnectionMethod",["require","exports","../AudioChain","../ConnectionManager"],function(require,exports,AudioChain_1,ConnectionManager_1){var SimpleConnectionMethod=function(_super){__extends(SimpleConnectionMethod,_super);function SimpleConnectionMethod(){_super.call(this)}return SimpleConnectionMethod.prototype.CreateChains=function(){var _this=this;return App.Sources.forEach(function(source){var chain=new AudioChain_1.AudioChain;_this.Chains.push(chain);var effects=source.Connections.ToArray();(_a=chain.Connections).push.apply(_a,[source].concat(effects)),chain.Connections.forEach(function(block){block.IsChained=!0});var _a}),this.Chains},SimpleConnectionMethod}(ConnectionManager_1.ConnectionManager);exports.SimpleConnectionMethod=SimpleConnectionMethod}),define("Core/Audio/Waveform",["require","exports"],function(require,exports){var Waveform=function(){function Waveform(){}return Waveform.prototype.GetWaveformFromBuffer=function(buffer,points,stepsPerPoint,normal){stepsPerPoint=10;var leftOnly=!1,newWaveform=[],peak=0,normThreshold=.01,left=buffer.getChannelData(0);if(buffer.numberOfChannels>1&&!leftOnly)var right=buffer.getChannelData(1);var slice=Math.ceil(left.length/points),step=Math.ceil(slice/stepsPerPoint);for(var i=0;i<points;i++){var max1=0,max2=0;for(var j=0;j<slice;j+=step){var datum=left[i*slice+j];datum<0&&(datum=-datum),datum>max1&&(max1=datum);if(right){var datum2=right[i*slice+j];datum2<0&&(datum2=-datum2),datum2>max2&&(max2=datum2),max2>max1&&(max1=max2)}}max1>peak&&(peak=max1),newWaveform.push(max1)}if(peak>normThreshold){var percent=normal/100,mult=(1/peak-1)*percent+1;for(var i=0;i<newWaveform.length;i++)newWaveform[i]=newWaveform[i]*mult}return newWaveform},Waveform}();exports.Waveform=Waveform}),define("Core/Audio/Audio",["require","exports","./Connections/ConnectionMethods/AccumulativeConnectionMethod","./AudioFileManager","./AudioNodeConnectionManager","./MIDIManager","./Connections/ConnectionMethods/SimpleConnectionMethod","./Waveform"],function(require,exports,AccumulativeConnectionMethod_1,AudioFileManager_1,AudioNodeConnectionManager_1,MIDIManager_1,SimpleConnectionMethod_1,Waveform_1){var Audio=function(){function Audio(){this.MasterVolume=-10,this.NoteIndex=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],this.WaveformTypeIndex=["sine","square","triangle","sawtooth"],this.WaveformTypeIndexNoise=["white","pink","brown"]}return Audio.prototype.Init=function(){this.Tone=new Tone,this.ctx=this.Tone.context,this.sampleRate=this.ctx.sampleRate,this.Master=Tone.Master;var masterCompressor=this.ctx.createDynamicsCompressor();masterCompressor.threshold.value=-8,masterCompressor.knee.value=10,masterCompressor.ratio.value=8,masterCompressor.attack.value=0,masterCompressor.release.value=.05,this.Master.chain(masterCompressor),this.Meter=new Tone.Meter,this.Master.connect(this.Meter),this.Level=0,this.Peak=0,this.Clip=!1,this.Master.volume.value=this.MasterVolume,this.AudioNodeConnectionManager=new AudioNodeConnectionManager_1.AudioNodeConnectionManager,this.ConnectionMethodType=1;switch(this.ConnectionMethodType){case 0:this.ConnectionManager=new SimpleConnectionMethod_1.SimpleConnectionMethod;break;case 1:this.ConnectionManager=new AccumulativeConnectionMethod_1.AccumulativeConnectionMethod;break;default:console.error("No connection method set")}this.AudioFileManager=new AudioFileManager_1.AudioFileManager,this.MIDIManager=new MIDIManager_1.MIDIManager,this.MIDIManager.Init(),this.Waveform=new Waveform_1.Waveform,this.WaveWorker=new Worker("Workers/WaveWorker.js"),this.WaveWorker.onmessage=function(e){var block=null;for(var i=0;i<App.Blocks.length;i++)e.data.blockId===App.Blocks[i].Id&&(block=App.Blocks[i]);block&&block.SetReversedBuffer(e.data.buffer)},this.HasBufferSourceDetuneCapability=!!this.ctx.createBufferSource().detune},Object.defineProperty(Audio.prototype,"MeterVolumeDb",{get:function(){return this.Meter.getDb()},enumerable:!0,configurable:!0}),Object.defineProperty(Audio.prototype,"MeterVolume",{get:function(){return this.Meter.getLevel()},enumerable:!0,configurable:!0}),Object.defineProperty(Audio.prototype,"HasClipped",{get:function(){return this.Meter.isClipped()},enumerable:!0,configurable:!0}),Audio.prototype.Monitor=function(){this.Level=this.MeterVolumeDb,this.Level>this.Peak&&(this.Peak=this.Level),this.Peak>0&&(this.Clip=!0)},Audio.prototype.MonitorReset=function(){this.Peak=0,this.Clip=!1},Audio.prototype.ReverseBuffer=function(blockId,buffer){if(this.WaveWorker){var channelNo=buffer.numberOfChannels,channels=[];for(var i=0;i<channelNo;i++)channels.push(buffer.getChannelData(i));this.WaveWorker.postMessage({blockId:blockId,channels:channels})}},Audio.prototype.DigestBuffer=function(blockId,buffer){var master=[]},Audio}();exports.Audio=Audio});var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,5)}}(),etch;(function(etch){var engine;(function(engine){var ClockTimer=function(){function ClockTimer(){this._Listeners=[],this._LastTime=0}return ClockTimer.prototype.RegisterTimer=function(listener){var ls=this._Listeners,index=ls.indexOf(listener);if(index>-1)return;ls.push(listener),ls.length===1&&this._RequestAnimationTick()},ClockTimer.prototype.UnregisterTimer=function(listener){var ls=this._Listeners,index=ls.indexOf(listener);index>-1&&ls.splice(index,1)},ClockTimer.prototype._DoTick=function(){var nowTime=(new Date).getTime(),lastTime=this._LastTime;this._LastTime=nowTime;var ls=this._Listeners,len=ls.length;if(len===0)return;for(var i=0;i<len;i++)ls[i].OnTicked(lastTime,nowTime);this._RequestAnimationTick()},ClockTimer.prototype._RequestAnimationTick=function(){var _this=this;requestAnimFrame(function(){return _this._DoTick()})},ClockTimer}();engine.ClockTimer=ClockTimer})(engine=etch.engine||(etch.engine={}))})(etch||(etch={}));var etch;(function(etch){var primitives;(function(primitives){var Vector=function(){function Vector(x,y){this.x=x,this.y=y}return Vector.prototype.Get=function(){return new Vector(this.x,this.y)},Vector.prototype.Set=function(x,y){this.x=x,this.y=y},Vector.prototype.Add=function(v){this.x+=v.x,this.y+=v.y},Vector.Add=function(v1,v2){return new Vector(v1.x+v2.x,v1.y+v2.y)},Vector.prototype.Clone=function(){return new Vector(this.x,this.y)},Vector.LERP=function(start,end,p){var x=start.x+(end.x-start.x)*p,y=start.y+(end.y-start.y)*p;return new Vector(x,y)},Vector.prototype.Sub=function(v){this.x-=v.x,this.y-=v.y},Vector.Sub=function(v1,v2){return new Vector(v1.x-v2.x,v1.y-v2.y)},Vector.prototype.Mult=function(n){this.x=this.x*n,this.y=this.y*n},Vector.Mult=function(v1,v2){return new Vector(v1.x*v2.x,v1.y*v2.y)},Vector.MultN=function(v1,n){return new Vector(v1.x*n,v1.y*n)},Vector.prototype.Div=function(n){this.x=this.x/n,this.y=this.y/n},Vector.Div=function(v1,v2){return new Vector(v1.x/v2.x,v1.y/v2.y)},Vector.DivN=function(v1,n){return new Vector(v1.x/n,v1.y/n)},Vector.prototype.Mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vector.prototype.MagSq=function(){return this.x*this.x+this.y*this.y},Vector.prototype.Normalize=function(){var m=this.Mag();m!=0&&m!=1&&this.Div(m)},Vector.prototype.Limit=function(max){this.MagSq()>max*max&&(this.Normalize(),this.Mult(max))},Vector.prototype.Heading=function(){var angle=Math.atan2(-this.y,this.x);return-1*angle},Vector.Random2D=function(){return Vector.FromAngle(Math.random()*Math.TAU)},Vector.FromAngle=function(angle){return new Vector(Math.cos(angle),Math.sin(angle))},Vector.prototype.ToPoint=function(){return new primitives.Point(this.x,this.y)},Vector}();primitives.Vector=Vector})(primitives=etch.primitives||(etch.primitives={}))})(etch||(etch={}));var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},etch;(function(etch){var exceptions;(function(exceptions){var Exception=function(){function Exception(message){this.Message=message}return Exception.prototype.toString=function(){var typeName=this.constructor.name;return typeName?typeName+": "+this.Message:this.Message},Exception}();exceptions.Exception=Exception;var ArgumentException=function(_super){__extends(ArgumentException,_super);function ArgumentException(message){_super.call(this,message)}return ArgumentException}(Exception);exceptions.ArgumentException=ArgumentException;var ArgumentNullException=function(_super){__extends(ArgumentNullException,_super);function ArgumentNullException(message){_super.call(this,message)}return ArgumentNullException}(Exception);exceptions.ArgumentNullException=ArgumentNullException;var InvalidOperationException=function(_super){__extends(InvalidOperationException,_super);function InvalidOperationException(message){_super.call(this,message)}return InvalidOperationException}(Exception);exceptions.InvalidOperationException=InvalidOperationException;var NotSupportedException=function(_super){__extends(NotSupportedException,_super);function NotSupportedException(message){_super.call(this,message)}return NotSupportedException}(Exception);exceptions.NotSupportedException=NotSupportedException;var IndexOutOfRangeException=function(_super){__extends(IndexOutOfRangeException,_super);function IndexOutOfRangeException(index){_super.call(this,index.toString())}return IndexOutOfRangeException}(Exception);exceptions.IndexOutOfRangeException=IndexOutOfRangeException;var ArgumentOutOfRangeException=function(_super){__extends(ArgumentOutOfRangeException,_super);function ArgumentOutOfRangeException(msg){_super.call(this,msg)}return ArgumentOutOfRangeException}(Exception);exceptions.ArgumentOutOfRangeException=ArgumentOutOfRangeException;var AttachException=function(_super){__extends(AttachException,_super);function AttachException(message,data){_super.call(this,message),this.Data=data}return AttachException}(Exception);exceptions.AttachException=AttachException;var InvalidJsonException=function(_super){__extends(InvalidJsonException,_super);function InvalidJsonException(jsonText,innerException){_super.call(this,"Invalid json."),this.JsonText=jsonText,this.InnerException=innerException}return InvalidJsonException}(Exception);exceptions.InvalidJsonException=InvalidJsonException;var TargetInvocationException=function(_super){__extends(TargetInvocationException,_super);function TargetInvocationException(message,innerException){_super.call(this,message),this.InnerException=innerException}return TargetInvocationException}(Exception);exceptions.TargetInvocationException=TargetInvocationException;var UnknownTypeException=function(_super){__extends(UnknownTypeException,_super);function UnknownTypeException(fullTypeName){_super.call(this,fullTypeName),this.FullTypeName=fullTypeName}return UnknownTypeException}(Exception);exceptions.UnknownTypeException=UnknownTypeException;var FormatException=function(_super){__extends(FormatException,_super);function FormatException(message){_super.call(this,message)}return FormatException}(Exception);exceptions.FormatException=FormatException})(exceptions=etch.exceptions||(etch.exceptions={}))})(etch||(etch={}));var etch;(function(etch){var collections;(function(collections){var ObservableCollection=function(){function ObservableCollection(){this._ht=[],this.CollectionChanged=new nullstone.Event,this.PropertyChanged=new nullstone.Event}return ObservableCollection.prototype.getEnumerator=function(){return nullstone.IEnumerator_.fromArray(this._ht)},Object.defineProperty(ObservableCollection.prototype,"Count",{get:function(){return this._ht.length},enumerable:!0,configurable:!0}),ObservableCollection.prototype.ToArray=function(){return this._ht.slice(0)},ObservableCollection.prototype.GetValueAt=function(index){var ht=this._ht;if(index<0||index>=ht.length)throw new etch.exceptions.IndexOutOfRangeException(index);return ht[index]},ObservableCollection.prototype.SetValueAt=function(index,value){var ht=this._ht;if(index<0||index>=ht.length)throw new etch.exceptions.IndexOutOfRangeException(index);var oldValue=ht[index];ht[index]=value,this.CollectionChanged.raise(this,CollectionChangedEventArgs.Replace(value,oldValue,index))},ObservableCollection.prototype.Add=function(value){var index=this._ht.push(value)-1;this.CollectionChanged.raise(this,CollectionChangedEventArgs.Add(value,index)),this._RaisePropertyChanged("Count")},ObservableCollection.prototype.AddRange=function(values){var index=this._ht.length,len=values.length;for(var i=0;i<len;i++)this._ht.push(values[i]);this.CollectionChanged.raise(this,CollectionChangedEventArgs.AddRange(values,index)),this._RaisePropertyChanged("Count")},ObservableCollection.prototype.Insert=function(index,value){var ht=this._ht;if(index<0||index>ht.length)throw new etch.exceptions.IndexOutOfRangeException(index);index>=ht.length?ht.push(value):ht.splice(index,0,value),this.CollectionChanged.raise(this,CollectionChangedEventArgs.Add(value,index)),this._RaisePropertyChanged("Count")},ObservableCollection.prototype.IndexOf=function(value){return this._ht.indexOf(value)},ObservableCollection.prototype.Contains=function(value){return this._ht.indexOf(value)>-1},ObservableCollection.prototype.Remove=function(value){var index=this._ht.indexOf(value);return index<0?!1:(this._ht.splice(index,1),this.CollectionChanged.raise(this,CollectionChangedEventArgs.Remove(value,index)),this._RaisePropertyChanged("Count"),!0)},ObservableCollection.prototype.RemoveAt=function(index){if(index<0||index>=this._ht.length)throw new etch.exceptions.IndexOutOfRangeException(index);var item=this._ht.splice(index,1)[0];this.CollectionChanged.raise(this,CollectionChangedEventArgs.Remove(item,index)),this._RaisePropertyChanged("Count")},ObservableCollection.prototype.Clear=function(){var old=this._ht;this._ht=[],this.CollectionChanged.raise(this,CollectionChangedEventArgs.Reset(old)),this._RaisePropertyChanged("Count")},ObservableCollection.prototype._RaisePropertyChanged=function(propertyName){this.PropertyChanged.raise(this,new collections.PropertyChangedEventArgs(propertyName))},ObservableCollection}();collections.ObservableCollection=ObservableCollection})(collections=etch.collections||(etch.collections={}))})(etch||(etch={}));var etch;(function(etch){var collections;(function(collections){var PropertyChangedEventArgs=function(){function PropertyChangedEventArgs(propertyName){Object.defineProperty(this,"PropertyName",{value:propertyName,writable:!1})}return PropertyChangedEventArgs}();collections.PropertyChangedEventArgs=PropertyChangedEventArgs,collections.INotifyPropertyChanged_=new nullstone.Interface("INotifyPropertyChanged"),collections.INotifyPropertyChanged_.is=function(o){return o&&o.PropertyChanged instanceof nullstone.Event}})(collections=etch.collections||(etch.collections={}))})(etch||(etch={}));var Size=minerva.Size,etch;(function(etch){var drawing;(function(drawing){var Canvas=function(){function Canvas(){this.IsCached=!1,this.HTMLElement=document.createElement("canvas"),document.body.appendChild(this.HTMLElement)}return Object.defineProperty(Canvas.prototype,"Ctx",{get:function(){return this.HTMLElement.getContext("2d")},enumerable:!0,configurable:!0}),Object.defineProperty(Canvas.prototype,"Width",{get:function(){return this.Ctx.canvas.width},set:function(value){this.Ctx.canvas.width=value},enumerable:!0,configurable:!0}),Object.defineProperty(Canvas.prototype,"Height",{get:function(){return this.Ctx.canvas.height},set:function(value){this.Ctx.canvas.height=value},enumerable:!0,configurable:!0}),Object.defineProperty(Canvas.prototype,"Size",{get:function(){return new Size(this.Width,this.Height)},enumerable:!0,configurable:!0}),Object.defineProperty(Canvas.prototype,"Style",{get:function(){return this.Ctx.canvas.style},enumerable:!0,configurable:!0}),Canvas}();drawing.Canvas=Canvas})(drawing=etch.drawing||(etch.drawing={}))})(etch||(etch={}));var etch;(function(etch){var drawing;(function(drawing){var DisplayObject=function(){function DisplayObject(){this._DisplayList=new drawing.DisplayObjectCollection,this.FrameCount=-1,this.IsCached=!1,this.IsInitialised=!1,this.IsPaused=!1,this.IsVisible=!0,this.LastVisualTick=0}return DisplayObject.prototype.Init=function(drawTo,drawFrom){this.DrawTo=drawTo,drawFrom&&(this.DrawFrom=drawFrom),this.IsInitialised=!0,this.Setup(),this.Resize()},Object.defineProperty(DisplayObject.prototype,"Ctx",{get:function(){return this.DrawTo.Ctx},enumerable:!0,configurable:!0}),Object.defineProperty(DisplayObject.prototype,"CanvasWidth",{get:function(){return this.Ctx.canvas.width},enumerable:!0,configurable:!0}),Object.defineProperty(DisplayObject.prototype,"CanvasHeight",{get:function(){return this.Ctx.canvas.height},enumerable:!0,configurable:!0}),Object.defineProperty(DisplayObject.prototype,"DisplayList",{get:function(){return this._DisplayList},set:function(value){this._DisplayList=value},enumerable:!0,configurable:!0}),DisplayObject.prototype.Setup=function(){},DisplayObject.prototype.Update=function(){},DisplayObject.prototype.Draw=function(){},DisplayObject.prototype.IsFirstFrame=function(){return this.FrameCount===0},DisplayObject.prototype.Dispose=function(){},DisplayObject.prototype.Play=function(){this.IsPaused=!1;for(var i=0;i<this.DisplayList.Count;i++){var displayObject=this.DisplayList.GetValueAt(i);displayObject.Play()}},DisplayObject.prototype.Pause=function(){this.IsPaused=!0;for(var i=0;i<this.DisplayList.Count;i++){var displayObject=this.DisplayList.GetValueAt(i);displayObject.Pause()}},DisplayObject.prototype.Resize=function(){},DisplayObject.prototype.Show=function(){this.IsVisible=!0;for(var i=0;i<this.DisplayList.Count;i++){var displayObject=this.DisplayList.GetValueAt(i);displayObject.Show()}},DisplayObject.prototype.Hide=function(){this.IsVisible=!1;for(var i=0;i<this.DisplayList.Count;i++){var displayObject=this.DisplayList.GetValueAt(i);displayObject.Hide()}},DisplayObject}();drawing.DisplayObject=DisplayObject})(drawing=etch.drawing||(etch.drawing={}))})(etch||(etch={}));var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},ObservableCollection=etch.collections.ObservableCollection,etch;(function(etch){var drawing;(function(drawing){var DisplayObjectCollection=function(_super){__extends(DisplayObjectCollection,_super);function DisplayObjectCollection(){var _this=this;_super.call(this),this.CollectionChanged.on(function(){for(var i=0;i<_this.Count;i++){var obj=_this.GetValueAt(i);obj.ZIndex=i}},this)}return DisplayObjectCollection.prototype.Swap=function(obj1,obj2){var obj1Index=this.IndexOf(obj1),obj2Index=this.IndexOf(obj2);this.SetIndex(obj1,obj2Index),this.SetIndex(obj2,obj1Index)},DisplayObjectCollection.prototype.ToFront=function(obj){var index=0;this.Count>0&&(index=this.Count-1),this.SetIndex(obj,index)},DisplayObjectCollection.prototype.ToBack=function(obj){this.SetIndex(obj,0)},DisplayObjectCollection.prototype.SetIndex=function(obj,index){if(index>this.Count||index<0)throw new etch.exceptions.Exception("index out of range");this.Remove(obj),this.Insert(index,obj)},Object.defineProperty(DisplayObjectCollection.prototype,"Bottom",{get:function(){return this.GetValueAt(0)},enumerable:!0,configurable:!0}),Object.defineProperty(DisplayObjectCollection.prototype,"Top",{get:function(){return this.GetValueAt(this.Count-1)},enumerable:!0,configurable:!0}),DisplayObjectCollection}(ObservableCollection);drawing.DisplayObjectCollection=DisplayObjectCollection})(drawing=etch.drawing||(etch.drawing={}))})(etch||(etch={}));var DisplayObjectCollection=etch.drawing.DisplayObjectCollection,Point=etch.primitives.Point,__extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},ClockTimer=etch.engine.ClockTimer,DisplayObject=etch.drawing.DisplayObject,etch;(function(etch){var drawing;(function(drawing){var Stage=function(_super){__extends(Stage,_super);function Stage(maxDelta){_super.call(this),this.DeltaTime=(new Date(0)).getTime(),this.LastVisualTick=(new Date(0)).getTime(),this.Updated=new nullstone.Event,this.Drawn=new nullstone.Event,this._MaxDelta=maxDelta||1e3/60}return Stage.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Timer=new ClockTimer,this.Timer.RegisterTimer(this)},Stage.prototype.OnTicked=function(lastTime,nowTime){this.DeltaTime=Math.min(nowTime-this.LastVisualTick,this._MaxDelta),this.LastVisualTick=nowTime,this.Ctx.clearRect(0,0,this.Ctx.canvas.width,this.Ctx.canvas.height),this.UpdateDisplayList(this.DisplayList),this.Updated.raise(this,this.LastVisualTick),this.DrawDisplayList(this.DisplayList),this.Drawn.raise(this,this.LastVisualTick)},Stage.prototype.UpdateDisplayList=function(displayList){for(var i=0;i<displayList.Count;i++){var displayObject=displayList.GetValueAt(i);displayObject.FrameCount++,displayObject.DeltaTime=this.DeltaTime,displayObject.LastVisualTick=this.LastVisualTick,displayObject.IsPaused||displayObject.Update(),this.UpdateDisplayList(displayObject.DisplayList)}},Stage.prototype.DrawDisplayList=function(displayList){for(var i=0;i<displayList.Count;i++){var displayObject=displayList.GetValueAt(i);displayObject.IsVisible&&displayObject.Draw(),this.DrawDisplayList(displayObject.DisplayList)}},Stage.prototype.ResizeDisplayList=function(displayList){for(var i=0;i<displayList.Count;i++){var displayObject=displayList.GetValueAt(i);displayObject.Resize(),this.ResizeDisplayList(displayObject.DisplayList)}},Stage.prototype.Resize=function(){_super.prototype.Resize.call(this),this.ResizeDisplayList(this.DisplayList)},Stage}(drawing.DisplayObject);drawing.Stage=Stage})(drawing=etch.drawing||(etch.drawing={}))})(etch||(etch={}));var etch;(function(etch){var events;(function(events){(function(CollectionChangedAction){CollectionChangedAction[CollectionChangedAction.Add=1]="Add",CollectionChangedAction[CollectionChangedAction.Remove=2]="Remove",CollectionChangedAction[CollectionChangedAction.Replace=3]="Replace",CollectionChangedAction[CollectionChangedAction.Reset=4]="Reset"})(events.CollectionChangedAction||(events.CollectionChangedAction={}));var CollectionChangedAction=events.CollectionChangedAction,CollectionChangedEventArgs=function(){function CollectionChangedEventArgs(){}return CollectionChangedEventArgs.Reset=function(allValues){var args=new CollectionChangedEventArgs;return Object.defineProperty(args,"Action",{value:CollectionChangedAction.Reset,writable:!1}),Object.defineProperty(args,"OldStartingIndex",{value:0,writable:!1}),Object.defineProperty(args,"NewStartingIndex",{value:-1,writable:!1}),Object.defineProperty(args,"OldItems",{value:allValues,writable:!1}),Object.defineProperty(args,"NewItems",{value:null,writable:!1}),args},CollectionChangedEventArgs.Replace=function(newValue,oldValue,index){var args=new CollectionChangedEventArgs;return Object.defineProperty(args,"Action",{value:CollectionChangedAction.Replace,writable:!1}),Object.defineProperty(args,"OldStartingIndex",{value:-1,writable:!1}),Object.defineProperty(args,"NewStartingIndex",{value:index,writable:!1}),Object.defineProperty(args,"OldItems",{value:[oldValue],writable:!1}),Object.defineProperty(args,"NewItems",{value:[newValue],writable:!1}),args},CollectionChangedEventArgs.Add=function(newValue,index){var args=new CollectionChangedEventArgs;return Object.defineProperty(args,"Action",{value:CollectionChangedAction.Add,writable:!1}),Object.defineProperty(args,"OldStartingIndex",{value:-1,writable:!1}),Object.defineProperty(args,"NewStartingIndex",{value:index,writable:!1}),Object.defineProperty(args,"OldItems",{value:null,writable:!1}),Object.defineProperty(args,"NewItems",{value:[newValue],writable:!1}),args},CollectionChangedEventArgs.AddRange=function(newValues,index){var args=new CollectionChangedEventArgs;return Object.defineProperty(args,"Action",{value:CollectionChangedAction.Add,writable:!1}),Object.defineProperty(args,"OldStartingIndex",{value:-1,writable:!1}),Object.defineProperty(args,"NewStartingIndex",{value:index,writable:!1}),Object.defineProperty(args,"OldItems",{value:null,writable:!1}),Object.defineProperty(args,"NewItems",{value:newValues,writable:!1}),args},CollectionChangedEventArgs.Remove=function(oldValue,index){var args=new CollectionChangedEventArgs;return Object.defineProperty(args,"Action",{value:CollectionChangedAction.Remove,writable:!1}),Object.defineProperty(args,"OldStartingIndex",{value:index,writable:!1}),Object.defineProperty(args,"NewStartingIndex",{value:-1,writable:!1}),Object.defineProperty(args,"OldItems",{value:[oldValue],writable:!1}),Object.defineProperty(args,"NewItems",{value:null,writable:!1}),args},CollectionChangedEventArgs}();events.CollectionChangedEventArgs=CollectionChangedEventArgs})(events=etch.events||(etch.events={}))})(etch||(etch={}));var CollectionChangedEventArgs=etch.events.CollectionChangedEventArgs,etch;(function(etch){var events;(function(events){events.INotifyCollectionChanged_=new nullstone.Interface("INotifyCollectionChanged"),events.INotifyCollectionChanged_.is=function(o){return o&&o.CollectionChanged instanceof nullstone.Event}})(events=etch.events||(etch.events={}))})(etch||(etch={}));var etch;(function(etch){var events;(function(events){var PropertyChangedEventArgs=function(){function PropertyChangedEventArgs(propertyName){Object.defineProperty(this,"PropertyName",{value:propertyName,writable:!1})}return PropertyChangedEventArgs}();events.PropertyChangedEventArgs=PropertyChangedEventArgs,events.INotifyPropertyChanged_=new nullstone.Interface("INotifyPropertyChanged"),events.INotifyPropertyChanged_.is=function(o){return o&&o.PropertyChanged instanceof nullstone.Event}})(events=etch.events||(etch.events={}))})(etch||(etch={}));var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},RoutedEventArgs=etch.events.RoutedEventArgs,etch;(function(etch){var events;(function(events){var RoutedEvent=function(_super){__extends(RoutedEvent,_super);function RoutedEvent(){_super.apply(this,arguments)}return RoutedEvent}(nullstone.Event);events.RoutedEvent=RoutedEvent})(events=etch.events||(etch.events={}))})(etch||(etch={}));var etch;(function(etch){var events;(function(events){var RoutedEventArgs=function(){function RoutedEventArgs(){this.Handled=!1,this.Source=null,this.OriginalSource=null}return RoutedEventArgs}();events.RoutedEventArgs=RoutedEventArgs})(events=etch.events||(etch.events={}))})(etch||(etch={}));var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},etch;(function(etch){var primitives;(function(primitives){var Point=function(_super){__extends(Point,_super);function Point(){_super.apply(this,arguments)}return Point.prototype.Clone=function(){return new Point(this.x,this.y)},Point.prototype.ToVector=function(){return new primitives.Vector(this.x,this.y)},Point}(minerva.Point);primitives.Point=Point})(primitives=etch.primitives||(etch.primitives={}))})(etch||(etch={})),define("etch",function(){}),define("Blocks/BlockSprites",["require","exports","etch"],function(require,exports){var Point=etch.primitives.Point,BlockSprites=function(){function BlockSprites(){}return BlockSprites.prototype.DrawSprite=function(ctx,pos,scaled,blockType,pos2){this.Ctx=ctx.Ctx,this._Scaled=scaled,this._Position=pos,this._XOffset=0,this._YOffset=0;var grd=App.GridSize;switch(blockType){case App.L10n.Blocks.Effect.Blocks.AutoWah.name.toLowerCase():this._Scaled||(this._XOffset=grd*.5,this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(-2,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.BitCrusher.name.toLowerCase():this._Scaled||(this._YOffset=grd),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,0),this.DrawLineTo(1,-2),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(1,-2),this.DrawLineTo(1,-1),this.DrawLineTo(0,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Chomp.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(0,1),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Chopper.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(0,0),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Chorus.name.toLowerCase():this._Scaled||(this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[10]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[6]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,0),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Convolution.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5)),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,0),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[6]),this.DrawMoveTo(0,0),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.StereoDelay.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.DrawLineTo(0,1),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,1),this.DrawLineTo(0,0),this.DrawLineTo(1,1),this.DrawLineTo(1,2),this.DrawLineTo(0,1),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Distortion.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,0),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[9]),this.DrawLineTo(-1,-1),this.DrawLineTo(0,-1),this.DrawLineTo(0,0),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Envelope.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[6]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(0,0),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Eq.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5),this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(1,1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(0,0),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawLineTo(0,0),this.DrawLineTo(1,1),this.DrawLineTo(2,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Filter.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(-1,-2),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.DrawLineTo(-1,0),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[6]),this.DrawMoveTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Volume.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5),this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(2,1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,0),this.DrawLineTo(1,1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Vibrato.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[9]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[6]),this.DrawMoveTo(0,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Phaser.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[9]),this.DrawMoveTo(-1,0),this.DrawLineTo(-1,-2),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,0),this.DrawLineTo(-1,-1),this.DrawLineTo(1,1),this.DrawLineTo(1,2),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.PitchShifter.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5),this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(2,-1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Reverb.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5)),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,0),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[6]),this.DrawMoveTo(0,0),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Effect.Blocks.Scuzz.name.toLowerCase():this._Scaled||(this._YOffset=grd),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[10]),this.DrawMoveTo(-1,-1),this.DrawLineTo(2,-1),this.DrawLineTo(0,1),this.DrawLineTo(-1,0),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(0,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Source.Blocks.Tone.name.toLowerCase():this._Scaled||(this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(-2,0),this.DrawLineTo(0,-2),this.DrawLineTo(2,0),this.DrawLineTo(1,1),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-2,0),this.DrawLineTo(0,-2),this.DrawLineTo(0,0),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(0,-2),this.DrawLineTo(1,-1),this.DrawLineTo(0,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Source.Blocks.Noise.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,0),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(0,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Source.Blocks.Microphone.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[9]),this.DrawMoveTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Source.Blocks.Sample.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5),this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(1,1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[10]),this.DrawMoveTo(1,0),this.DrawLineTo(2,0),this.DrawLineTo(1,1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Source.Blocks.Granular.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5)),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(0,0),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(2,1),this.DrawLineTo(1,2),this.DrawLineTo(1,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Source.Blocks.Recorder.name.toLowerCase():this._Scaled||(this._XOffset=-(grd*.5)),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[9]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(2,1),this.DrawLineTo(1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(0,0),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Source.Blocks.SampleGen.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[10]),this.DrawMoveTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.DrawLineTo(0,2),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Interaction.Blocks.ComputerKeyboard.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(2,1),this.DrawLineTo(1,2),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawLineTo(0,-1),this.DrawLineTo(0,1),this.DrawLineTo(1,1),this.DrawLineTo(1,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Interaction.Blocks.MIDIController.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,-1),this.DrawLineTo(2,1),this.DrawLineTo(1,2),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawLineTo(0,-1),this.DrawLineTo(-1,1),this.DrawLineTo(1,1),this.DrawLineTo(1,0),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[9]),this.DrawLineTo(-1,-1),this.DrawLineTo(-1,1),this.DrawLineTo(0,1),this.DrawLineTo(0,-1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Power.Blocks.ParticleEmitter.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(-2,0),this.DrawLineTo(2,0),this.DrawLineTo(0,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Power.Blocks.Power.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(1,-2),this.DrawLineTo(2,-1),this.DrawLineTo(2,0),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(0,0),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(0,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,0),this.DrawLineTo(1,-2),this.DrawLineTo(1,-1),this.DrawLineTo(0,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Power.Blocks.TogglePower.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(1,2),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,0),this.DrawLineTo(0,1),this.DrawLineTo(1,2),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Power.Blocks.PulsePower.name.toLowerCase():this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(0,1),this.DrawLineTo(0,0),this.DrawLineTo(1,-1),this.DrawLineTo(1,1),this.DrawLineTo(0,2),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Power.Blocks.Laser.name.toLowerCase():this._Scaled||(this._YOffset=grd*.5),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,-1),this.DrawLineTo(0,1),this.DrawLineTo(-1,0),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(0,0),this.Ctx.closePath(),this.Ctx.fill();break;case App.L10n.Blocks.Power.Blocks.Void.name.toLowerCase():App.FillColor(this.Ctx,App.Palette[14]),this.Ctx.beginPath(),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),App.FillColor(this.Ctx,App.Palette[8]),this._Scaled?this.DrawPixel(pos2.x,pos2.y,2):this.DrawPixel(-1,2,2),this.DrawPixel(-3,-8,1),this.DrawPixel(1,-4,1),this.DrawPixel(8,-3,1),this.DrawPixel(-8,1,1),this.DrawPixel(1,9,1);break;default:console.log("block not found")}},BlockSprites.prototype.DrawPixel=function(x,y,size){var s=size*.5;this.Ctx.beginPath(),this.DrawFloatMoveTo(x,y),this.DrawFloatLineTo(x+s,y),this.DrawFloatLineTo(x+s,y+s),this.DrawFloatLineTo(x,y+s),this.Ctx.closePath(),this.Ctx.fill()},BlockSprites.prototype.DrawMoveTo=function(x,y){var pos=new Point(this._Position.x+this._XOffset,this._Position.y+this._YOffset),p,grd=App.GridSize;this._Scaled?(p=App.Metrics.GetRelativePoint(pos,new Point(x,y)),p=App.Metrics.PointOnGrid(p)):p=new Point(pos.x+x*grd,pos.y+y*grd),this.Ctx.moveTo(p.x,p.y)},BlockSprites.prototype.DrawLineTo=function(x,y){var pos=new Point(this._Position.x+this._XOffset,this._Position.y+this._YOffset),p,grd=App.GridSize;this._Scaled?(p=App.Metrics.GetRelativePoint(pos,new Point(x,y)),p=App.Metrics.PointOnGrid(p)):p=new Point(pos.x+x*grd,pos.y+y*grd),this.Ctx.lineTo(p.x,p.y)},BlockSprites.prototype.DrawFloatMoveTo=function(x,y){var pos=new Point(this._Position.x+this._XOffset,this._Position.y+this._YOffset),p;this._Scaled?p=App.Metrics.PointOnGrid(new Point(pos.x+x/App.GridSize*App.Unit,pos.y+y/App.GridSize*App.Unit)):p=new Point(pos.x+x*App.Unit,pos.y+y*App.Unit),this.Ctx.moveTo(p.x,p.y)},BlockSprites.prototype.DrawFloatLineTo=function(x,y){var pos=new Point(this._Position.x+this._XOffset,this._Position.y+this._YOffset),p;this._Scaled?p=App.Metrics.PointOnGrid(new Point(pos.x+x/App.GridSize*App.Unit,pos.y+y/App.GridSize*App.Unit)):p=new Point(pos.x+x*App.Unit,pos.y+y*App.Unit),this.Ctx.lineTo(p.x,p.y)},BlockSprites}();exports.BlockSprites=BlockSprites}),define("Core/Visual/RGBA",["require","exports"],function(require,exports){var RGBA=function(){function RGBA(r,g,b,a){this.R=r,this.G=g,this.B=b,this.A=a}return RGBA.prototype.toString=function(){return"rgba("+this.R+","+this.G+","+this.B+","+this.A+")"},RGBA.prototype.clone=function(){return new RGBA(this.R,this.G,this.B,this.A)},RGBA}();exports.RGBA=RGBA}),define("Core/Visual/ColorManager",["require","exports","./RGBA"],function(require,exports,RGBA_1){var ColorManager=function(){function ColorManager(){this.Master=new RGBA_1.RGBA(0,0,0,0),this.HighPass=new RGBA_1.RGBA(0,-100,0,0),this.LowPass=new RGBA_1.RGBA(-100,0,0,0),this.Passes=!1}return ColorManager.prototype.FillColor=function(ctx,col){this.SetRGBA(ctx,col.R,col.G,col.B,col.A,"fill")},ColorManager.prototype.StrokeColor=function(ctx,col){this.SetRGBA(ctx,col.R,col.G,col.B,col.A,"stroke")},ColorManager.prototype.FillRGBA=function(ctx,r,g,b,a){this.SetRGBA(ctx,r,g,b,a,"fill")},ColorManager.prototype.StrokeRGBA=function(ctx,r,g,b,a){this.SetRGBA(ctx,r,g,b,a,"stroke")},ColorManager.prototype.ColorString=function(col){return this.BuildColour(col.R,col.G,col.B,col.A)},ColorManager.prototype.DarkerColor=function(col,darkness){var r=this.ValueInRange(col.R-darkness,0,255),g=this.ValueInRange(col.G-darkness,0,255),b=this.ValueInRange(col.B-darkness,0,255);return new RGBA_1.RGBA(r,g,b,col.A)},ColorManager.prototype.LighterColor=function(col,lightness){var r=this.ValueInRange(col.R+lightness,0,255),g=this.ValueInRange(col.G+lightness,0,255),b=this.ValueInRange(col.B+lightness,0,255);return new RGBA_1.RGBA(r,g,b,col.A)},ColorManager.prototype.SetRGBA=function(ctx,r,g,b,a,mode){var red=Math.round(r+this.Master.R),green=Math.round(g+this.Master.G),blue=Math.round(b+this.Master.B),alpha=a+this.Master.A;if(this.Passes){var av=(red+green+blue)/3,hp=av/255,lp=1-av/255;red+=Math.round(this.HighPass.R*hp+this.LowPass.R*lp),green+=Math.round(this.HighPass.G*hp+this.LowPass.G*lp),blue+=Math.round(this.HighPass.B*hp+this.LowPass.B*lp)}mode==="stroke"?ctx.strokeStyle=this.BuildColour(red,green,blue,alpha):ctx.fillStyle=this.BuildColour(red,green,blue,alpha)},ColorManager.prototype.BuildColour=function(red,green,blue,alpha){return red=this.ValueInRange(red,0,255),green=this.ValueInRange(green,0,255),blue=this.ValueInRange(blue,0,255),alpha=this.ValueInRange(alpha,0,1),"rgba("+red+","+green+","+blue+","+alpha+")"},ColorManager.prototype.ValueInRange=function(value,floor,ceiling){return value<floor&&(value=floor),value>ceiling&&(value=ceiling),value},ColorManager.prototype.GetLuminosity=function(col){return.299*col.R+.587*col.G+.114*col.B},ColorManager}();exports.ColorManager=ColorManager}),define("Core/Resources/CommandHandlerFactory",["require","exports"],function(require,exports){var CommandHandlerFactory=function(){function CommandHandlerFactory(command,type){this.Command=command,this._Type=type}return CommandHandlerFactory.prototype.GetInstance=function(){return Object.create(this._Type)},CommandHandlerFactory.prototype.GetType=function(){return this._Type},CommandHandlerFactory}();exports.CommandHandlerFactory=CommandHandlerFactory}),define("Core/Commands/CommandManager",["require","exports","../Resources/CommandHandlerFactory"],function(require,exports,CommandHandlerFactory_1){var CommandManager=function(){function CommandManager(resourceManager){var _this=this;this._CommandHandlerFactories=[],this._ResourceManager=resourceManager,this._ResourceManager.ResourceAdded.on(function(resource){_this._OnResourceAdded(resource)},this)}return CommandManager.prototype._OnResourceAdded=function(resource){CommandHandlerFactory_1.CommandHandlerFactory.prototype.isPrototypeOf(resource)&&this._CommandHandlerFactories.push(resource)},CommandManager.prototype.ExecuteCommand=function(command,parameters){var commandHandlerFactories=this._GetCommandHandlerFactories(command);if(!commandHandlerFactories.length)return;var commandHandler=commandHandlerFactories[0].GetInstance();return commandHandler.Execute(parameters)},CommandManager.prototype._GetCommandHandlerFactories=function(command){return this._CommandHandlerFactories.filter(function(item){return item.Command==command},this)},CommandManager}();exports.CommandManager=CommandManager}),define("StringValue",["require","exports"],function(require,exports){var StringValue=function(){function StringValue(value){this.value="",value&&(this.value=value.toLowerCase())}return StringValue.prototype.toString=function(){return this.value},StringValue}();exports.StringValue=StringValue});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Commands",["require","exports","./StringValue"],function(require,exports,StringValue_1){var Command=function(_super){__extends(Command,_super);function Command(){_super.apply(this,arguments)}return Command}(StringValue_1.StringValue),Commands=function(){function Commands(){}return Commands.CHANGE_THEME=new Command("changeTheme"),Commands.CREATE_BLOCK=new Command("createBlock"),Commands.DELETE_BLOCK=new Command("deleteBlock"),Commands.LOAD=new Command("load"),Commands.MOVE_BLOCK=new Command("moveBlock"),Commands.REDO=new Command("redo"),Commands.SAVE=new Command("save"),Commands.SAVE_AS=new Command("saveAs"),Commands.UNDO=new Command("undo"),Commands}();exports.Commands=Commands}),define("Core/Inputs/KeyboardInputManager",["require","exports"],function(require,exports){var KeyboardInputManager=function(){function KeyboardInputManager(){var _this=this;this._isEnabled=!0,this.KeyDownChange=new nullstone.Event,this.KeyUpChange=new nullstone.Event,this.ClearKeysDown(),document.addEventListener("keydown",function(e){if(!_this.IsEnabled)return;_this.KeyboardDown(e)}),document.addEventListener("keyup",function(e){if(!_this.IsEnabled)return;_this.KeyboardUp(e)})}return Object.defineProperty(KeyboardInputManager.prototype,"IsEnabled",{get:function(){return this._isEnabled},set:function(val){this._isEnabled=val},enumerable:!0,configurable:!0}),KeyboardInputManager.prototype.ClearKeysDown=function(){this.KeysDown={}},KeyboardInputManager.prototype.KeyboardDown=function(e){var k=e.keyCode;if(typeof k=="undefined")return;k===KeyCodes.KeyDown.Backspace&&App.FocusManager.IsActive()&&e.preventDefault(),k===KeyCodes.KeyDown.Enter&&!App.FocusManager.IsActive()&&e.preventDefault(),this.KeysDown[k]=!0},KeyboardInputManager.prototype.KeyboardUp=function(e){var k=e.keyCode;if(typeof k=="undefined")return;delete this.KeysDown[k]},KeyboardInputManager.prototype.IsKeyCodeDown=function(keycode){return!!this.KeysDown[keycode]},KeyboardInputManager.prototype.IsModifierDown=function(){return this.KeysDown[KeyCodes.KeyDown.Ctrl]||this.KeysDown[KeyCodes.KeyDown.CommandFF]||this.KeysDown[KeyCodes.KeyDown.LeftWindowKey]||this.KeysDown[KeyCodes.KeyDown.RightWindowKey]},KeyboardInputManager}();exports.KeyboardInputManager=KeyboardInputManager});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Core/Inputs/CommandsInputManager",["require","exports","../../Commands","./KeyboardInputManager"],function(require,exports,Commands_1,KeyboardInputManager_1){var CommandsInputManager=function(_super){__extends(CommandsInputManager,_super);function CommandsInputManager(commandManager){_super.call(this),this._CommandManager=commandManager}return CommandsInputManager.prototype.KeyboardDown=function(e){_super.prototype.KeyboardDown.call(this,e);if(!this.IsEnabled)return;this.CreateCommand(e)},CommandsInputManager.prototype.KeyboardUp=function(e){_super.prototype.KeyboardUp.call(this,e);if(!this.IsEnabled)return;this.CreateCommand(e)},CommandsInputManager.prototype.CreateCommand=function(e){if(!App.TypingManager.IsEnabled){if((this.IsKeyCodeDown(KeyCodes.KeyDown.Ctrl)||this.IsKeyCodeDown(KeyCodes.KeyDown.LeftWindowKey)||this.IsKeyCodeDown(KeyCodes.KeyDown.CommandFF))&&this.IsKeyCodeDown(KeyCodes.KeyDown.s)){e.preventDefault(),App.MainScene.SharePanel.OpenPanel();return}if((this.IsKeyCodeDown(KeyCodes.KeyDown.Ctrl)||this.IsKeyCodeDown(KeyCodes.KeyDown.LeftWindowKey)||this.IsKeyCodeDown(KeyCodes.KeyDown.CommandFF))&&this.IsKeyCodeDown(KeyCodes.KeyDown.Shift)&&this.IsKeyCodeDown(KeyCodes.KeyDown.z)){e.preventDefault(),this._CommandManager.ExecuteCommand(Commands_1.Commands.REDO);return}if((this.IsKeyCodeDown(KeyCodes.KeyDown.Ctrl)||this.IsKeyCodeDown(KeyCodes.KeyDown.LeftWindowKey)||this.IsKeyCodeDown(KeyCodes.KeyDown.CommandFF))&&this.IsKeyCodeDown(KeyCodes.KeyDown.z)){e.preventDefault(),this._CommandManager.ExecuteCommand(Commands_1.Commands.UNDO);return}}},CommandsInputManager}(KeyboardInputManager_1.KeyboardInputManager);exports.CommandsInputManager=CommandsInputManager}),define("CompositionLoadedEventArgs",["require","exports"],function(require,exports){var CompositionLoadedEventArgs=function(){function CompositionLoadedEventArgs(saveFile){Object.defineProperty(this,"SaveFile",{value:saveFile,writable:!1})}return CompositionLoadedEventArgs}();exports.CompositionLoadedEventArgs=CompositionLoadedEventArgs}),define("Core/Operations/AddItemToArrayOperation",["require","exports"],function(require,exports){var AddItemToArrayOperation=function(){function AddItemToArrayOperation(item,array,index){this._Item=item,this._Array=array,this._Index=index||-1}return AddItemToArrayOperation.prototype.Do=function(){var that=this;return new Promise(function(resolve,reject){that._Index==-1||that._Index>=that._Array.length?that._Array.push(that._Item):that._Array.insert(that._Item,that._Index),resolve(that._Array)})},AddItemToArrayOperation.prototype.Undo=function(){var that=this;return new Promise(function(resolve){that._Array.remove(that._Item),resolve(that._Array)})},AddItemToArrayOperation.prototype.Dispose=function(){this._Item=null,this._Array=null},AddItemToArrayOperation}();exports.AddItemToArrayOperation=AddItemToArrayOperation});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("CommandCategories",["require","exports","./StringValue"],function(require,exports,StringValue_1){var Category=function(_super){__extends(Category,_super);function Category(){_super.apply(this,arguments)}return Category}(StringValue_1.StringValue),CommandCategories=function(){function CommandCategories(){}return CommandCategories.COMPOSITIONS=new Category("compositions"),CommandCategories.SETTINGS=new Category("settings"),CommandCategories}();exports.CommandCategories=CommandCategories}),define("CommandHandlers/CreateBlockCommandHandler",["require","exports","../Core/Operations/AddItemToArrayOperation","../Commands","../CommandCategories"],function(require,exports,AddItemToArrayOperation_1,Commands_1,CommandCategories_1){var CreateBlockCommandHandler=function(){function CreateBlockCommandHandler(){}return CreateBlockCommandHandler.prototype.Execute=function(block){App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.CREATE_BLOCK.toString(),block.BlockName);var op=new AddItemToArrayOperation_1.AddItemToArrayOperation(block,App.Blocks);return App.OperationManager.Do(op)},CreateBlockCommandHandler}();exports.CreateBlockCommandHandler=CreateBlockCommandHandler}),define("Core/Operations/CompoundOperation",["require","exports"],function(require,exports){var CompoundOperation=function(){function CompoundOperation(){this.Operations=[]}return CompoundOperation.prototype.AddOperation=function(operation){this.Operations.push(operation)},CompoundOperation.prototype.RemoveOperation=function(operation){this.Operations.remove(operation)},CompoundOperation.prototype.Do=function(){var sequence=Promise.resolve();return this.Operations.forEach(function(op){sequence=sequence.then(function(){return op.Do()})}),sequence},CompoundOperation.prototype.Undo=function(){var ops=this.Operations.clone().reverse(),sequence=Promise.resolve();return ops.forEach(function(op){sequence=sequence.then(function(){return op.Undo()})}),sequence},CompoundOperation.prototype.Dispose=function(){this.Operations.forEach(function(op){op.Dispose()})},CompoundOperation}();exports.CompoundOperation=CompoundOperation}),define("Core/Operations/ChangePropertyOperation",["require","exports"],function(require,exports){var ChangePropertyOperation=function(){function ChangePropertyOperation(obj,propertyName,oldValue,newValue){this._Object=obj,this._PropertyName=propertyName,this._NewValue=newValue,oldValue?this._OldValue=oldValue:this._OldValue=this._Object[this._PropertyName]}return ChangePropertyOperation.prototype.Do=function(){var that=this;return new Promise(function(resolve){that._Object[that._PropertyName]=that._NewValue,resolve(that._Object)})},ChangePropertyOperation.prototype.Undo=function(){var that=this;return new Promise(function(resolve){that._Object[that._PropertyName]=that._OldValue,resolve(that._Object)})},ChangePropertyOperation.prototype.Dispose=function(){this._Object=null},ChangePropertyOperation}();exports.ChangePropertyOperation=ChangePropertyOperation});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Operations/MoveBlockOperation",["require","exports","../Core/Operations/ChangePropertyOperation","../Core/Operations/CompoundOperation"],function(require,exports,ChangePropertyOperation_1,CompoundOperation_1){var MoveBlockOperation=function(_super){__extends(MoveBlockOperation,_super);function MoveBlockOperation(block){_super.call(this),this._Block=block,this.Operations.push(new ChangePropertyOperation_1.ChangePropertyOperation(block,"Position",this._Block.LastPosition.Clone(),this._Block.Position.Clone()))}return MoveBlockOperation.prototype.Do=function(){return _super.prototype.Do.call(this)},MoveBlockOperation.prototype.Undo=function(){return _super.prototype.Undo.call(this)},MoveBlockOperation.prototype.Dispose=function(){this._Block=null},MoveBlockOperation}(CompoundOperation_1.CompoundOperation);exports.MoveBlockOperation=MoveBlockOperation}),define("Operations/RemoveDisplayObjectOperation",["require","exports"],function(require,exports){var RemoveDisplayObjectOperation=function(){function RemoveDisplayObjectOperation(displayObject,displayList){this._DisplayObject=displayObject,this._DisplayList=displayList}return RemoveDisplayObjectOperation.prototype.Do=function(){this._Index=this._DisplayList.IndexOf(this._DisplayObject);var that=this;return new Promise(function(resolve){that._DisplayList.Remove(that._DisplayObject),resolve(that._DisplayList)})},RemoveDisplayObjectOperation.prototype.Undo=function(){var that=this;return new Promise(function(resolve){that._DisplayList.Insert(that._Index,that._DisplayObject),resolve(that._DisplayList)})},RemoveDisplayObjectOperation.prototype.Dispose=function(){this._DisplayList=null,this._DisplayObject=null},RemoveDisplayObjectOperation}();exports.RemoveDisplayObjectOperation=RemoveDisplayObjectOperation}),define("Core/Operations/RemoveItemFromArrayOperation",["require","exports"],function(require,exports){var RemoveItemFromArrayOperation=function(){function RemoveItemFromArrayOperation(item,array){this._Item=item,this._Array=array}return RemoveItemFromArrayOperation.prototype.Do=function(){this._Index=this._Array.indexOf(this._Item);var that=this;return new Promise(function(resolve){that._Array.remove(that._Item),resolve(that._Array)})},RemoveItemFromArrayOperation.prototype.Undo=function(){var that=this;return new Promise(function(resolve){that._Array.insert(that._Item,that._Index),resolve(that._Array)})},RemoveItemFromArrayOperation.prototype.Dispose=function(){this._Item=null,this._Array=null},RemoveItemFromArrayOperation}();exports.RemoveItemFromArrayOperation=RemoveItemFromArrayOperation});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Operations/DeleteBlockOperation",["require","exports","../Core/Operations/CompoundOperation","./MoveBlockOperation","./RemoveDisplayObjectOperation","../Core/Operations/RemoveItemFromArrayOperation"],function(require,exports,CompoundOperation_1,MoveBlockOperation_1,RemoveDisplayObjectOperation_1,RemoveItemFromArrayOperation_1){var DeleteBlockOperation=function(_super){__extends(DeleteBlockOperation,_super);function DeleteBlockOperation(block){_super.call(this),this._Block=block,this.Operations.push(new MoveBlockOperation_1.MoveBlockOperation(block)),this.Operations.push(new RemoveDisplayObjectOperation_1.RemoveDisplayObjectOperation(block,App.MainScene.BlocksContainer.DisplayList)),this.Operations.push(new RemoveItemFromArrayOperation_1.RemoveItemFromArrayOperation(block,App.Blocks)),this._Block.Stop()}return DeleteBlockOperation.prototype.Do=function(){return _super.prototype.Do.call(this)},DeleteBlockOperation.prototype.Undo=function(){return _super.prototype.Undo.call(this)},DeleteBlockOperation.prototype.Dispose=function(){this._Block.Dispose(),this._Block=null},DeleteBlockOperation}(CompoundOperation_1.CompoundOperation);exports.DeleteBlockOperation=DeleteBlockOperation}),define("CommandHandlers/DeleteBlockCommandHandler",["require","exports","../Operations/DeleteBlockOperation","../Commands","../CommandCategories"],function(require,exports,DeleteBlockOperation_1,Commands_1,CommandCategories_1){var DeleteBlockCommandHandler=function(){function DeleteBlockCommandHandler(){}return DeleteBlockCommandHandler.prototype.Execute=function(block){App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.DELETE_BLOCK.toString(),block.BlockName);var op=new DeleteBlockOperation_1.DeleteBlockOperation(block);return App.OperationManager.Do(op)},DeleteBlockCommandHandler}();exports.DeleteBlockCommandHandler=DeleteBlockCommandHandler}),define("Core/Inputs/FocusManagerEventArgs",["require","exports"],function(require,exports){var FocusManagerEventArgs=function(){function FocusManagerEventArgs(hasFocus){Object.defineProperty(this,"HasFocus",{value:hasFocus,writable:!1})}return FocusManagerEventArgs}();exports.FocusManagerEventArgs=FocusManagerEventArgs}),define("Core/Inputs/FocusManager",["require","exports","./FocusManagerEventArgs"],function(require,exports,FocusManagerEventArgs_1){var FocusManager=function(){function FocusManager(){var _this=this;this.HasFocus=!0,this.FocusChanged=new nullstone.Event,this._TitleInput=document.getElementById("shareTitleInput"),this._SearchInput=document.getElementById("soundCloudSearchInput"),window.onfocus=function(){_this.HasFocus=!0,_this.FocusChanged.raise(_this,new FocusManagerEventArgs_1.FocusManagerEventArgs(_this.HasFocus))},window.onblur=function(){_this.HasFocus=!1,_this.FocusChanged.raise(_this,new FocusManagerEventArgs_1.FocusManagerEventArgs(_this.HasFocus))},document.addEventListener("visibilitychange",function(){_this.HasFocus=!document.hidden,_this.FocusChanged.raise(_this,new FocusManagerEventArgs_1.FocusManagerEventArgs(_this.HasFocus))},!1),document.addEventListener("focusout",function(){window.scrollTo(0,0)})}return FocusManager.prototype.IsActive=function(){return document.activeElement!==this._TitleInput&&document.activeElement!==this._SearchInput},FocusManager.prototype.ActiveIsNotBody=function(){return document.activeElement!==document.body},FocusManager.prototype.BlurActive=function(){document.activeElement.blur()},FocusManager.prototype.IsTouchTarget=function(e){return e.target===App.Canvas.HTMLElement},FocusManager}();exports.FocusManager=FocusManager}),define("Operations/LoadOperation",["require","exports"],function(require,exports){var LoadOperation=function(){function LoadOperation(id){this._Id=id,this._LZMA=new LZMA("/lib/lzma/src/lzma_worker.js")}return LoadOperation.prototype.Decompress=function(data){var _this=this;return new Promise(function(resolve){data=JSON.parse("["+data+"]"),_this._LZMA.decompress(data,function(result){resolve(result.toString())},function(percent){})})},LoadOperation.prototype.Do=function(){var _this=this,that=this;return new Promise(function(resolve,reject){var protocol=App.IsLocalhost()?"http":"https",url=protocol+"://files.blokdust.io/compositions/"+_this._Id+"?t="+Utils.Dates.getTimeStamp();$.ajax({url:url,type:"GET",crossDomain:!0,dataType:"text"}).done(function(data){that.Decompress(data).then(function(decompressed){resolve(decompressed)})}).fail(function(jqXHR,textStatus){reject(textStatus)})})},LoadOperation.prototype.Dispose=function(){},LoadOperation}();exports.LoadOperation=LoadOperation}),define("CommandHandlers/LoadCommandHandler",["require","exports","../Operations/LoadOperation","../Commands","../CommandCategories"],function(require,exports,LoadOperation_1,Commands_1,CommandCategories_1){var LoadCommandHandler=function(){function LoadCommandHandler(){}return LoadCommandHandler.prototype.Execute=function(id){App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.LOAD.toString(),id);var op=new LoadOperation_1.LoadOperation(id);return App.OperationManager.Do(op)},LoadCommandHandler}();exports.LoadCommandHandler=LoadCommandHandler}),define("Device",["require","exports"],function(require,exports){(function(Device){Device[Device.mobile=0]="mobile",Device[Device.tablet=1]="tablet",Device[Device.desktop=2]="desktop"})(exports.Device||(exports.Device={}));var Device=exports.Device}),define("Metrics",["require","exports","./Device","etch"],function(require,exports,Device_1){var Point=etch.primitives.Point,Metrics=function(){function Metrics(){App.ZoomLevel=1,App.DragOffset=new Point(0,0),App.ScaledDragOffset=new Point(0,0),this.C=new Point(0,0),this.OptionsX=.3,this.OptionsPoint=new Point(.3,.6),this.ItemsPerPage=6,this.Device=Device_1.Device.desktop,this._DeviceZoom=1,this.HeaderHeight=60}return Metrics.prototype.Compute=function(){this._ScreenDivision=850;var gridSize=15,canvas=App.Canvas,width=window.innerWidth,height=window.innerHeight;this.DeviceCheck(),App.Unit=width/this._ScreenDivision*this.PixelRatio,App.GridSize=gridSize*App.Unit,this.UpdateGridScale(),canvas.Width=width*this.PixelRatio,canvas.Height=height*this.PixelRatio,canvas.Style.width=width+"px",canvas.Style.height=height+"px";for(var i=0;i<App.SubCanvas.length;i++){var c=App.SubCanvas[i];c.width=(width+1.5)*this.PixelRatio,c.height=height*this.PixelRatio,c.style.width=width*1.5+"px",c.style.height=height+"px"}App.Width=width*this.PixelRatio,App.Height=height*this.PixelRatio,App.MainScene.Width=App.Width,App.MainScene.Height=App.Height,this.C.x=App.Width*.5,this.C.y=App.Height*.5;var headerType=Math.round(App.Unit*28),headerTypePR=Math.round(App.Unit*(28/this.PixelRatio)),sliderType=Math.round(App.Unit*33),urlType=Math.round(App.Unit*(24/this.PixelRatio)),urlType2=Math.round(App.Unit*24),largeType=Math.round(App.Unit*11),midType=Math.round(App.Unit*10),bodyType=Math.round(App.Unit*8),italicType=Math.round(App.Unit*7.5),italicType2=Math.round(App.Unit*8),italicType3=Math.round(App.Unit*9),dataType=Math.round(App.Unit*5);this.TxtHeader="200 "+headerType+"px Dosis",this.TxtHeaderPR="200 "+headerTypePR+"px Dosis",this.TxtSlider="200 "+sliderType+"px Dosis",this.TxtUrl="200 "+urlType+"px Dosis",this.TxtUrl2="200 "+urlType2+"px Dosis",this.TxtMid="400 "+midType+"px Dosis",this.TxtLarge="400 "+largeType+"px Dosis",this.TxtBody="200 "+bodyType+"px Dosis",this.TxtItalic="300 italic "+italicType+"px Merriweather Sans",this.TxtItalic2="300 italic "+italicType2+"px Merriweather Sans",this.TxtItalic3="300 italic "+italicType3+"px Merriweather Sans",this.TxtData="400 "+dataType+"px PT Sans"},Metrics.prototype.UpdateGridScale=function(){App.ScaledUnit=App.Unit*App.ZoomLevel*this._DeviceZoom,App.ScaledGridSize=App.GridSize*App.ZoomLevel*this._DeviceZoom,App.ScaledDragOffset.x=App.DragOffset.x*App.ZoomLevel,App.ScaledDragOffset.y=App.DragOffset.y*App.ZoomLevel},Object.defineProperty(Metrics.prototype,"PixelRatio",{get:function(){return Utils.Device.getPixelRatio(App.Canvas.Ctx)},enumerable:!0,configurable:!0}),Metrics.prototype.DeviceCheck=function(){var width=window.innerWidth,height=window.innerHeight;height>width*1.3?(this._ScreenDivision=475,this.OptionsPoint=new Point(.5,.4),this.ItemsPerPage=3,this._DeviceZoom=1,this.Device=Device_1.Device.mobile):height>width*1.1?(this._ScreenDivision=600,this.OptionsPoint=new Point(.2,.5),this.ItemsPerPage=4,this._DeviceZoom=1,this.Device=Device_1.Device.tablet):(this.OptionsPoint=new Point(.3,.6),this.ItemsPerPage=6,this._DeviceZoom=1,this.Device=Device_1.Device.desktop)},Metrics.prototype.CursorToGrid=function(point){var x=Math.round((point.x-App.ScaledDragOffset.x*App.Unit-this.C.x)/App.ScaledGridSize),y=Math.round((point.y-App.ScaledDragOffset.y*App.Unit-this.C.y)/App.ScaledGridSize);return new Point(x,y)},Metrics.prototype.PointOnGrid=function(point){var x=this.C.x+App.ScaledDragOffset.x*App.Unit+point.x*App.ScaledGridSize,y=this.C.y+App.ScaledDragOffset.y*App.Unit+point.y*App.ScaledGridSize;return new Point(x,y)},Metrics.prototype.UnscaledPointOnGrid=function(point){var x=this.C.x+App.DragOffset.x*App.Unit+point.x*App.GridSize,y=this.C.y+App.DragOffset.y*App.Unit+point.y*App.GridSize;return new Point(x,y)},Metrics.prototype.UndraggedPointOnGrid=function(point){var x=this.C.x+point.x*App.ScaledGridSize,y=this.C.y+point.y*App.ScaledGridSize;return new Point(x,y)},Metrics.prototype.FloatOnGrid=function(point){var x=this.C.x+App.ScaledDragOffset.x*App.Unit+point.x*App.ZoomLevel,y=this.C.y+App.ScaledDragOffset.y*App.Unit+point.y*App.ZoomLevel;return new Point(x,y)},Metrics.prototype.GetRelativePoint=function(point,offset){return new Point(point.x+offset.x,point.y+offset.y)},Metrics.prototype.ConvertGridUnitsToAbsolute=function(point){return new Point(App.GridSize*point.x,App.GridSize*point.y)},Metrics.prototype.ConvertToPixelRatioPoint=function(point){point.x*=this.PixelRatio,point.y*=this.PixelRatio},Metrics.prototype.VectorFromAngle=function(angle){return new Point(Math.cos(angle),Math.sin(angle))},Metrics}();exports.Metrics=Metrics}),define("CommandHandlers/MoveBlockCommandHandler",["require","exports","../Operations/MoveBlockOperation","../Commands","../CommandCategories"],function(require,exports,MoveBlockOperation_1,Commands_1,CommandCategories_1){var MoveBlockCommandHandler=function(){function MoveBlockCommandHandler(){}return MoveBlockCommandHandler.prototype.Execute=function(block){App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.MOVE_BLOCK.toString(),block.BlockName);var op=new MoveBlockOperation_1.MoveBlockOperation(block);return App.OperationManager.Do(op)},MoveBlockCommandHandler}();exports.MoveBlockCommandHandler=MoveBlockCommandHandler}),define("Core/Operations/OperationManager",["require","exports","etch"],function(require,exports){var Exception=etch.exceptions.Exception,ObservableCollection=etch.collections.ObservableCollection,RoutedEvent=etch.events.RoutedEvent,RoutedEventArgs=etch.events.RoutedEventArgs,OperationManager=function(){function OperationManager(){this._DebugEnabled=!0,this._Operations=new ObservableCollection,this._Head=-1,this._MaxOperations=100,this.OperationBegin=new RoutedEvent,this.OperationComplete=new RoutedEvent}return Object.defineProperty(OperationManager.prototype,"Head",{get:function(){return this._Head},set:function(value){this._Head=value},enumerable:!0,configurable:!0}),Object.defineProperty(OperationManager.prototype,"MaxOperations",{get:function(){return this._MaxOperations},set:function(value){if(!(value>0&&value<Number.MAX_VALUE))throw new Exception("Invalid range");this._MaxOperations=value},enumerable:!0,configurable:!0}),OperationManager.prototype.Do=function(operation){var _this=this;if(this._CurrentOperation)return Promise.reject(Error(OperationManager.OPERATION_IN_PROGRESS));if(this._Operations.Count===this.MaxOperations){var firstOp=this._Operations.GetValueAt(0);firstOp.Dispose();var trimmed=this._Operations.ToArray().splice(1,this._Operations.Count-1);this._Operations.Clear(),this._Operations.AddRange(trimmed),this.Head--}if(!operation.Undo)this._Operations.Clear();else if(this.Head!=this._Operations.Count-1){var trimmed=this._Operations.ToArray().splice(0,this.Head+1);this._Operations.Clear(),this._Operations.AddRange(trimmed)}this._Operations.Add(operation),this.OperationBegin.raise(operation,new RoutedEventArgs);var that=this;return this._CurrentOperation=operation.Do().then(function(result){return that._CurrentOperation=null,that.Head=_this._Operations.Count-1,that.OperationComplete.raise(operation,new RoutedEventArgs),that._Debug(),result}).catch(function(error){that._CurrentOperation=null})},OperationManager.prototype.Undo=function(){if(!this.CanUndo())return Promise.reject(Error(OperationManager.CANNOT_UNDO));if(this._CurrentOperation)return Promise.reject(Error(OperationManager.OPERATION_IN_PROGRESS));var operation=this._Operations.GetValueAt(this.Head);this.OperationBegin.raise(operation,new RoutedEventArgs);var that=this;return this._CurrentOperation=operation.Undo().then(function(result){return that._CurrentOperation=null,that.Head--,that.OperationComplete.raise(operation,new RoutedEventArgs),that._Debug(),result}).catch(function(error){that._CurrentOperation=null})},OperationManager.prototype.Redo=function(){if(!this.CanRedo())return Promise.reject(Error(OperationManager.CANNOT_REDO));if(this._CurrentOperation)return Promise.reject(Error(OperationManager.OPERATION_IN_PROGRESS));var operation=this._Operations.GetValueAt(this.Head+1),that=this;return this._CurrentOperation=operation.Do().then(function(result){return that._CurrentOperation=null,that.Head++,that.OperationComplete.raise(operation,new RoutedEventArgs),that._Debug(),result}).catch(function(error){that._CurrentOperation=null})},OperationManager.prototype._Debug=function(){if(!this._DebugEnabled)return;var str="";for(var i=0;i<this._Operations.Count;i++)this.Head===i?str+="[]":str+="#"},OperationManager.prototype.CanUndo=function(){return this.Head>0},OperationManager.prototype.CanRedo=function(){return this.Head<this._Operations.Count-1},OperationManager.CANNOT_UNDO="Cannot undo",OperationManager.CANNOT_REDO="Cannot redo",OperationManager.OPERATION_IN_PROGRESS="Operation in progress",OperationManager}();exports.OperationManager=OperationManager}),define("Particle",["require","exports"],function(require,exports){var Particle=function(){function Particle(position,vector,size,life){this.Disposed=!1,this.Position=position,this.Vector=vector,this.Size=size,this.Life=life}return Particle.prototype.Move=function(){this.Position.x+=this.Vector.X*App.Unit,this.Position.y+=this.Vector.Y*App.Unit},Particle.prototype.Reset=function(){return this.Position=null,this.Vector=null,this.Size=null,this.Life=null,!0},Particle.prototype.Dispose=function(){this.Life=-1,this.Disposed=!0},Particle.prototype.ReturnToPool=function(){},Particle}();exports.Particle=Particle}),define("Core/Inputs/KeyDownEventArgs",["require","exports"],function(require,exports){var KeyDownEventArgs=function(){function KeyDownEventArgs(keyDown){Object.defineProperty(this,"KeyDown",{value:keyDown,writable:!1})}return KeyDownEventArgs}();exports.KeyDownEventArgs=KeyDownEventArgs}),define("Core/Inputs/KeyUpEventArgs",["require","exports"],function(require,exports){var KeyUpEventArgs=function(){function KeyUpEventArgs(keyUp){Object.defineProperty(this,"KeyUp",{value:keyUp,writable:!1})}return KeyUpEventArgs}();exports.KeyUpEventArgs=KeyUpEventArgs});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Core/Inputs/PianoKeyboardManager",["require","exports","./KeyboardInputManager","./KeyDownEventArgs","./KeyUpEventArgs"],function(require,exports,KeyboardInputManager_1,KeyDownEventArgs_1,KeyUpEventArgs_1){var PianoKeyboardManager=function(_super){__extends(PianoKeyboardManager,_super);function PianoKeyboardManager(){_super.call(this),this.KeyDownChange=new nullstone.Event,this.KeyUpChange=new nullstone.Event,this.PianoKeyboardMap={ArrowUp:1001,ArrowDown:1e3,Digit0:75,Digit2:61,Digit3:63,Digit5:66,Digit6:68,Digit7:70,Digit9:73,KeyB:55,KeyC:52,KeyD:51,KeyE:64,KeyG:54,KeyH:56,KeyI:72,KeyJ:58,KeyL:61,KeyM:59,KeyN:57,KeyO:74,KeyP:76,KeyQ:60,KeyR:65,KeyS:49,KeyT:67,KeyU:71,KeyV:53,KeyW:62,KeyX:50,KeyY:69,KeyZ:48,NumpadAdd:1001,NumpadSubtract:1e3,Semicolon:63,Comma:60,Equal:78,Period:62,Slash:64,BracketLeft:77,BracketRight:79,OSLeft:-1,OSRight:-1},this.PianoKeyboardMapFallBack={38:this.PianoKeyboardMap.ArrowUp,40:this.PianoKeyboardMap.ArrowDown,48:this.PianoKeyboardMap.Digit0,50:this.PianoKeyboardMap.Digit2,51:this.PianoKeyboardMap.Digit3,52:this.PianoKeyboardMap.Digit4,54:this.PianoKeyboardMap.Digit6,55:this.PianoKeyboardMap.Digit7,57:this.PianoKeyboardMap.Digit9,66:this.PianoKeyboardMap.KeyB,67:this.PianoKeyboardMap.KeyC,68:this.PianoKeyboardMap.KeyD,69:this.PianoKeyboardMap.KeyE,71:this.PianoKeyboardMap.KeyG,72:this.PianoKeyboardMap.KeyH,73:this.PianoKeyboardMap.KeyI,74:this.PianoKeyboardMap.KeyJ,76:this.PianoKeyboardMap.KeyL,77:this.PianoKeyboardMap.KeyM,78:this.PianoKeyboardMap.KeyN,79:this.PianoKeyboardMap.KeyO,80:this.PianoKeyboardMap.KeyP,81:this.PianoKeyboardMap.KeyQ,82:this.PianoKeyboardMap.KeyR,83:this.PianoKeyboardMap.KeyS,84:this.PianoKeyboardMap.KeyT,85:this.PianoKeyboardMap.KeyU,86:this.PianoKeyboardMap.KeyV,87:this.PianoKeyboardMap.KeyW,88:this.PianoKeyboardMap.KeyX,89:this.PianoKeyboardMap.KeyY,90:this.PianoKeyboardMap.KeyZ,91:this.PianoKeyboardMap.OSLeft,93:this.PianoKeyboardMap.OSRight,107:this.PianoKeyboardMap.NumpadAdd,109:this.PianoKeyboardMap.NumpadSubtract,186:this.PianoKeyboardMap.Semicolon,188:this.PianoKeyboardMap.Comma,189:this.PianoKeyboardMap.Minus,190:this.PianoKeyboardMap.Period,191:this.PianoKeyboardMap.Slash,219:this.PianoKeyboardMap.BracketLeft,221:this.PianoKeyboardMap.BracketRight}}return Object.defineProperty(PianoKeyboardManager.prototype,"IsEnabled",{get:function(){return this._isEnabled},set:function(val){val===!1,this._isEnabled=val},enumerable:!0,configurable:!0}),PianoKeyboardManager.prototype.KeyboardDown=function(e){if(!this.IsEnabled)return;var k;e.code?k=this.PianoKeyboardMap[e.code]:k=this.PianoKeyboardMapFallBack[e.keyCode];if(typeof k!==undefined){if(k in this.KeysDown)return;this.KeysDown[k]=!0,this.KeyDown=k,this.KeyDownChange.raise(this,new KeyDownEventArgs_1.KeyDownEventArgs(this.KeyDown))}},PianoKeyboardManager.prototype.KeyboardUp=function(e){if(!this.IsEnabled)return;var k;e.code?k=this.PianoKeyboardMap[e.code]:k=this.PianoKeyboardMapFallBack[e.keyCode],typeof k!==undefined&&(k===-1?this.KeysDown={}:delete this.KeysDown[k],this.KeyUp=k,this.KeyUpChange.raise(this,new KeyUpEventArgs_1.KeyUpEventArgs(this.KeyUp)))},PianoKeyboardManager}(KeyboardInputManager_1.KeyboardInputManager);exports.PianoKeyboardManager=PianoKeyboardManager}),define("Core/Inputs/PointerInputManager",["require","exports"],function(require,exports){var PointerInputManager=function(){function PointerInputManager(){this.MouseDown=new nullstone.Event,this.MouseUp=new nullstone.Event,this.MouseMove=new nullstone.Event,this.MouseWheel=new nullstone.Event,this.TouchStart=new nullstone.Event,this.TouchEnd=new nullstone.Event,this.TouchMove=new nullstone.Event,this.TouchAssumed=!1,this.OnMouseDown=this.OnMouseDown.bind(this),document.addEventListener("mousedown",this.OnMouseDown),this.OnMouseUp=this.OnMouseUp.bind(this),document.addEventListener("mouseup",this.OnMouseUp),this.OnMouseMove=this.OnMouseMove.bind(this),document.addEventListener("mousemove",this.OnMouseMove),this.OnMouseWheel=this.OnMouseWheel.bind(this),document.addEventListener("mousewheel",this.OnMouseWheel),document.addEventListener("DOMMouseScroll",this.OnMouseWheel),this.OnTouchStart=this.OnTouchStart.bind(this),document.addEventListener("touchstart",this.OnTouchStart),this.OnTouchEnd=this.OnTouchEnd.bind(this),document.addEventListener("touchend",this.OnTouchEnd),this.OnTouchMove=this.OnTouchMove.bind(this),document.addEventListener("touchmove",this.OnTouchMove)}return PointerInputManager.prototype.OnMouseDown=function(e){this.MouseDown.raise(this,e)},PointerInputManager.prototype.OnMouseUp=function(e){this.MouseUp.raise(this,e)},PointerInputManager.prototype.OnMouseMove=function(e){this.MouseMove.raise(this,e)},PointerInputManager.prototype.OnTouchStart=function(e){App.FocusManager.IsTouchTarget(e)&&e.preventDefault(),App.FocusManager.ActiveIsNotBody()&&!App.FocusManager.IsActive()&&App.FocusManager.BlurActive(),this.TouchAssumed=!0,this.TouchStart.raise(this,e)},PointerInputManager.prototype.OnTouchEnd=function(e){App.FocusManager.IsTouchTarget(e)&&e.preventDefault(),this.TouchEnd.raise(this,e)},PointerInputManager.prototype.OnTouchMove=function(e){App.FocusManager.IsTouchTarget(e)&&e.preventDefault(),this.TouchMove.raise(this,e)},PointerInputManager.prototype.OnMouseWheel=function(e){App.FocusManager.IsTouchTarget(e)&&(e.preventDefault(),e.stopPropagation()),this.MouseWheel.raise(this,e)},PointerInputManager}();exports.PointerInputManager=PointerInputManager});var Utils;(function(Utils){var Async=function(){function Async(){}return Async.waitFor=function(test,successCallback,failureCallback,interval,maxTries,numTries){interval||(interval=200),maxTries||(maxTries=100),numTries||(numTries=0),numTries+=1,numTries>maxTries?failureCallback&&failureCallback():test()?successCallback():setTimeout(function(){Async.waitFor(test,successCallback,failureCallback,interval,maxTries,numTries)},interval)},Async}();Utils.Async=Async})(Utils||(Utils={}));var Utils;(function(Utils){var Bools=function(){function Bools(){}return Bools.getBool=function(val,defaultVal){return val===null||typeof val=="undefined"?defaultVal:val},Bools}();Utils.Bools=Bools})(Utils||(Utils={}));var Utils;(function(Utils){var Clipboard=function(){function Clipboard(){}return Clipboard.copy=function(text){var $tempDiv=$("<div style='position:absolute;left:-9999px'>"),brRegex=/<br\s*[\/]?>/gi;text=text.replace(brRegex,"\n"),$("body").append($tempDiv),$tempDiv.append(text);var $tempInput=$("<textarea>");$tempDiv.append($tempInput),$tempInput.val($tempDiv.text()).select(),document.execCommand("copy"),$tempDiv.remove()},Clipboard.supportsCopy=function(){return document.queryCommandSupported&&document.queryCommandSupported("copy")},Clipboard}();Utils.Clipboard=Clipboard})(Utils||(Utils={}));var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},Utils;(function(Utils){var Collections;(function(Collections){var collections=Collections,_hasOwnProperty=Object.prototype.hasOwnProperty,has=function(obj,prop){return _hasOwnProperty.call(obj,prop)};function defaultCompare(a,b){return a<b?-1:a===b?0:1}Collections.defaultCompare=defaultCompare;function defaultEquals(a,b){return a===b}Collections.defaultEquals=defaultEquals;function defaultToString(item){return item===null?"COLLECTION_NULL":collections.isUndefined(item)?"COLLECTION_UNDEFINED":collections.isString(item)?"$s"+item:"$o"+item.toString()}Collections.defaultToString=defaultToString;function makeString(item,join){join===void 0&&(join=",");if(item===null)return"COLLECTION_NULL";if(collections.isUndefined(item))return"COLLECTION_UNDEFINED";if(collections.isString(item))return item.toString();var toret="{",first=!0;for(var prop in item)has(item,prop)&&(first?first=!1:toret+=join,toret=toret+prop+":"+item[prop]);return toret+"}"}Collections.makeString=makeString;function isFunction(func){return typeof func=="function"}Collections.isFunction=isFunction;function isUndefined(obj){return typeof obj=="undefined"}Collections.isUndefined=isUndefined;function isString(obj){return Object.prototype.toString.call(obj)==="[object String]"}Collections.isString=isString;function reverseCompareFunction(compareFunction){return collections.isFunction(compareFunction)?function(d,v){return compareFunction(d,v)*-1}:function(a,b){return a<b?1:a===b?0:-1}}Collections.reverseCompareFunction=reverseCompareFunction;function compareToEquals(compareFunction){return function(a,b){return compareFunction(a,b)===0}}Collections.compareToEquals=compareToEquals;var arrays;(function(arrays){function indexOf(array,item,equalsFunction){var equals=equalsFunction||collections.defaultEquals,length=array.length;for(var i=0;i<length;i++)if(equals(array[i],item))return i;return-1}arrays.indexOf=indexOf;function lastIndexOf(array,item,equalsFunction){var equals=equalsFunction||collections.defaultEquals,length=array.length;for(var i=length-1;i>=0;i--)if(equals(array[i],item))return i;return-1}arrays.lastIndexOf=lastIndexOf;function contains(array,item,equalsFunction){return arrays.indexOf(array,item,equalsFunction)>=0}arrays.contains=contains;function remove(array,item,equalsFunction){var index=arrays.indexOf(array,item,equalsFunction);return index<0?!1:(array.splice(index,1),!0)}arrays.remove=remove;function frequency(array,item,equalsFunction){var equals=equalsFunction||collections.defaultEquals,length=array.length,freq=0;for(var i=0;i<length;i++)equals(array[i],item)&&freq++;return freq}arrays.frequency=frequency;function equals(array1,array2,equalsFunction){var equals=equalsFunction||collections.defaultEquals;if(array1.length!==array2.length)return!1;var length=array1.length;for(var i=0;i<length;i++)if(!equals(array1[i],array2[i]))return!1;return!0}arrays.equals=equals;function copy(array){return array.concat()}arrays.copy=copy;function swap(array,i,j){if(i<0||i>=array.length||j<0||j>=array.length)return!1;var temp=array[i];return array[i]=array[j],array[j]=temp,!0}arrays.swap=swap;function toString(array){return"["+array.toString()+"]"}arrays.toString=toString;function forEach(array,callback){var lenght=array.length;for(var i=0;i<lenght;i++)if(callback(array[i])===!1)return}arrays.forEach=forEach})(arrays=Collections.arrays||(Collections.arrays={}));var LinkedList=function(){function LinkedList(){this.firstNode=null,this.lastNode=null,this.nElements=0}return LinkedList.prototype.add=function(item,index){collections.isUndefined(index)&&(index=this.nElements);if(index<0||index>this.nElements||collections.isUndefined(item))return!1;var newNode=this.createNode(item);if(this.nElements===0)this.firstNode=newNode,this.lastNode=newNode;else if(index===this.nElements)this.lastNode.next=newNode,this.lastNode=newNode;else if(index===0)newNode.next=this.firstNode,this.firstNode=newNode;else{var prev=this.nodeAtIndex(index-1);newNode.next=prev.next,prev.next=newNode}return this.nElements++,!0},LinkedList.prototype.first=function(){return this.firstNode!==null?this.firstNode.element:undefined},LinkedList.prototype.last=function(){return this.lastNode!==null?this.lastNode.element:undefined},LinkedList.prototype.elementAtIndex=function(index){var node=this.nodeAtIndex(index);return node===null?undefined:node.element},LinkedList.prototype.indexOf=function(item,equalsFunction){var equalsF=equalsFunction||collections.defaultEquals;if(collections.isUndefined(item))return-1;var currentNode=this.firstNode,index=0;while(currentNode!==null){if(equalsF(currentNode.element,item))return index;index++,currentNode=currentNode.next}return-1},LinkedList.prototype.contains=function(item,equalsFunction){return this.indexOf(item,equalsFunction)>=0},LinkedList.prototype.remove=function(item,equalsFunction){var equalsF=equalsFunction||collections.defaultEquals;if(this.nElements<1||collections.isUndefined(item))return!1;var previous=null,currentNode=this.firstNode;while(currentNode!==null){if(equalsF(currentNode.element,item))return currentNode===this.firstNode?(this.firstNode=this.firstNode.next,currentNode===this.lastNode&&(this.lastNode=null)):currentNode===this.lastNode?(this.lastNode=previous,previous.next=currentNode.next,currentNode.next=null):(previous.next=currentNode.next,currentNode.next=null),this.nElements--,!0;previous=currentNode,currentNode=currentNode.next}return!1},LinkedList.prototype.clear=function(){this.firstNode=null,this.lastNode=null,this.nElements=0},LinkedList.prototype.equals=function(other,equalsFunction){var eqF=equalsFunction||collections.defaultEquals;return other instanceof collections.LinkedList?this.size()!==other.size()?!1:this.equalsAux(this.firstNode,other.firstNode,eqF):!1},LinkedList.prototype.equalsAux=function(n1,n2,eqF){while(n1!==null){if(!eqF(n1.element,n2.element))return!1;n1=n1.next,n2=n2.next}return!0},LinkedList.prototype.removeElementAtIndex=function(index){if(index<0||index>=this.nElements)return undefined;var element;if(this.nElements===1)element=this.firstNode.element,this.firstNode=null,this.lastNode=null;else{var previous=this.nodeAtIndex(index-1);previous===null?(element=this.firstNode.element,this.firstNode=this.firstNode.next):previous.next===this.lastNode&&(element=this.lastNode.element,this.lastNode=previous),previous!==null&&(element=previous.next.element,previous.next=previous.next.next)}return this.nElements--,element},LinkedList.prototype.forEach=function(callback){var currentNode=this.firstNode;while(currentNode!==null){if(callback(currentNode.element)===!1)break;currentNode=currentNode.next}},LinkedList.prototype.reverse=function(){var previous=null,current=this.firstNode,temp=null;while(current!==null)temp=current.next,current.next=previous,previous=current,current=temp;temp=this.firstNode,this.firstNode=this.lastNode,this.lastNode=temp},LinkedList.prototype.toArray=function(){var array=[],currentNode=this.firstNode;while(currentNode!==null)array.push(currentNode.element),currentNode=currentNode.next;return array},LinkedList.prototype.size=function(){return this.nElements},LinkedList.prototype.isEmpty=function(){return this.nElements<=0},LinkedList.prototype.toString=function(){return collections.arrays.toString(this.toArray())},LinkedList.prototype.nodeAtIndex=function(index){if(index<0||index>=this.nElements)return null;if(index===this.nElements-1)return this.lastNode;var node=this.firstNode;for(var i=0;i<index;i++)node=node.next;return node},LinkedList.prototype.createNode=function(item){return{element:item,next:null}},LinkedList}();Collections.LinkedList=LinkedList;var Dictionary=function(){function Dictionary(toStrFunction){this.table={},this.nElements=0,this.toStr=toStrFunction||collections.defaultToString}return Dictionary.prototype.getValue=function(key){var pair=this.table["$"+this.toStr(key)];return collections.isUndefined(pair)?undefined:pair.value},Dictionary.prototype.setValue=function(key,value){if(collections.isUndefined(key)||collections.isUndefined(value))return undefined;var ret,k="$"+this.toStr(key),previousElement=this.table[k];return collections.isUndefined(previousElement)?(this.nElements++,ret=undefined):ret=previousElement.value,this.table[k]={key:key,value:value},ret},Dictionary.prototype.remove=function(key){var k="$"+this.toStr(key),previousElement=this.table[k];return collections.isUndefined(previousElement)?undefined:(delete this.table[k],this.nElements--,previousElement.value)},Dictionary.prototype.keys=function(){var array=[];for(var name in this.table)if(has(this.table,name)){var pair=this.table[name];array.push(pair.key)}return array},Dictionary.prototype.values=function(){var array=[];for(var name in this.table)if(has(this.table,name)){var pair=this.table[name];array.push(pair.value)}return array},Dictionary.prototype.forEach=function(callback){for(var name in this.table)if(has(this.table,name)){var pair=this.table[name],ret=callback(pair.key,pair.value);if(ret===!1)return}},Dictionary.prototype.containsKey=function(key){return!collections.isUndefined(this.getValue(key))},Dictionary.prototype.clear=function(){this.table={},this.nElements=0},Dictionary.prototype.size=function(){return this.nElements},Dictionary.prototype.isEmpty=function(){return this.nElements<=0},Dictionary.prototype.toString=function(){var toret="{";return this.forEach(function(k,v){toret=toret+"\n	"+k.toString()+" : "+v.toString()}),toret+"\n}"},Dictionary}();Collections.Dictionary=Dictionary;var LinkedDictionaryPair=function(){function LinkedDictionaryPair(key,value){this.key=key,this.value=value}return LinkedDictionaryPair.prototype.unlink=function(){this.prev.next=this.next,this.next.prev=this.prev},LinkedDictionaryPair}(),LinkedDictionary=function(_super){__extends(LinkedDictionary,_super);function LinkedDictionary(toStrFunction){_super.call(this,toStrFunction),this.head=new LinkedDictionaryPair(null,null),this.tail=new LinkedDictionaryPair(null,null),this.head.next=this.tail,this.tail.prev=this.head}return LinkedDictionary.prototype.appendToTail=function(entry){var lastNode=this.tail.prev;lastNode.next=entry,entry.prev=lastNode,entry.next=this.tail,this.tail.prev=entry},LinkedDictionary.prototype.getLinkedDictionaryPair=function(key){if(collections.isUndefined(key))return undefined;var k="$"+this.toStr(key),pair=this.table[k];return pair},LinkedDictionary.prototype.getValue=function(key){var pair=this.getLinkedDictionaryPair(key);return collections.isUndefined(pair)?undefined:pair.value},LinkedDictionary.prototype.remove=function(key){var pair=this.getLinkedDictionaryPair(key);return collections.isUndefined(pair)?undefined:(_super.prototype.remove.call(this,key),pair.unlink(),pair.value)},LinkedDictionary.prototype.clear=function(){_super.prototype.clear.call(this),this.head.next=this.tail,this.tail.prev=this.head},LinkedDictionary.prototype.replace=function(oldPair,newPair){var k="$"+this.toStr(newPair.key);newPair.next=oldPair.next,newPair.prev=oldPair.prev,this.remove(oldPair.key),newPair.prev.next=newPair,newPair.next.prev=newPair,this.table[k]=newPair,++this.nElements},LinkedDictionary.prototype.setValue=function(key,value){if(collections.isUndefined(key)||collections.isUndefined(value))return undefined;var existingPair=this.getLinkedDictionaryPair(key),newPair=new LinkedDictionaryPair(key,value),k="$"+this.toStr(key);return collections.isUndefined(existingPair)?(this.appendToTail(newPair),this.table[k]=newPair,++this.nElements,undefined):(this.replace(existingPair,newPair),existingPair.value)},LinkedDictionary.prototype.keys=function(){var array=[];return this.forEach(function(key,value){array.push(key)}),array},LinkedDictionary.prototype.values=function(){var array=[];return this.forEach(function(key,value){array.push(value)}),array},LinkedDictionary.prototype.forEach=function(callback){var crawlNode=this.head.next;while(crawlNode.next!=null){var ret=callback(crawlNode.key,crawlNode.value);if(ret===!1)return;crawlNode=crawlNode.next}},LinkedDictionary}(Dictionary);Collections.LinkedDictionary=LinkedDictionary;var MultiDictionary=function(){function MultiDictionary(toStrFunction,valuesEqualsFunction,allowDuplicateValues){allowDuplicateValues===void 0&&(allowDuplicateValues=!1),this.dict=new Dictionary(toStrFunction),this.equalsF=valuesEqualsFunction||collections.defaultEquals,this.allowDuplicate=allowDuplicateValues}return MultiDictionary.prototype.getValue=function(key){var values=this.dict.getValue(key);return collections.isUndefined(values)?[]:collections.arrays.copy(values)},MultiDictionary.prototype.setValue=function(key,value){if(collections.isUndefined(key)||collections.isUndefined(value))return!1;if(!this.containsKey(key))return this.dict.setValue(key,[value]),!0;var array=this.dict.getValue(key);return!this.allowDuplicate&&collections.arrays.contains(array,value,this.equalsF)?!1:(array.push(value),!0)},MultiDictionary.prototype.remove=function(key,value){if(collections.isUndefined(value)){var v=this.dict.remove(key);return!collections.isUndefined(v)}var array=this.dict.getValue(key);return collections.arrays.remove(array,value,this.equalsF)?(array.length===0&&this.dict.remove(key),!0):!1},MultiDictionary.prototype.keys=function(){return this.dict.keys()},MultiDictionary.prototype.values=function(){var values=this.dict.values(),array=[];for(var i=0;i<values.length;i++){var v=values[i];for(var j=0;j<v.length;j++)array.push(v[j])}return array},MultiDictionary.prototype.containsKey=function(key){return this.dict.containsKey(key)},MultiDictionary.prototype.clear=function(){this.dict.clear()},MultiDictionary.prototype.size=function(){return this.dict.size()},MultiDictionary.prototype.isEmpty=function(){return this.dict.isEmpty()},MultiDictionary}();Collections.MultiDictionary=MultiDictionary;var Heap=function(){function Heap(compareFunction){this.data=[],this.compare=compareFunction||collections.defaultCompare}return Heap.prototype.leftChildIndex=function(nodeIndex){return 2*nodeIndex+1},Heap.prototype.rightChildIndex=function(nodeIndex){return 2*nodeIndex+2},Heap.prototype.parentIndex=function(nodeIndex){return Math.floor((nodeIndex-1)/2)},Heap.prototype.minIndex=function(leftChild,rightChild){return rightChild>=this.data.length?leftChild>=this.data.length?-1:leftChild:this.compare(this.data[leftChild],this.data[rightChild])<=0?leftChild:rightChild},Heap.prototype.siftUp=function(index){var parent=this.parentIndex(index);while(index>0&&this.compare(this.data[parent],this.data[index])>0)collections.arrays.swap(this.data,parent,index),index=parent,parent=this.parentIndex(index)},Heap.prototype.siftDown=function(nodeIndex){var min=this.minIndex(this.leftChildIndex(nodeIndex),this.rightChildIndex(nodeIndex));while(min>=0&&this.compare(this.data[nodeIndex],this.data[min])>0)collections.arrays.swap(this.data,min,nodeIndex),nodeIndex=min,min=this.minIndex(this.leftChildIndex(nodeIndex),this.rightChildIndex(nodeIndex))},Heap.prototype.peek=function(){return this.data.length>0?this.data[0]:undefined},Heap.prototype.add=function(element){return collections.isUndefined(element)?undefined:(this.data.push(element),this.siftUp(this.data.length-1),!0)},Heap.prototype.removeRoot=function(){if(this.data.length>0){var obj=this.data[0];return this.data[0]=this.data[this.data.length-1],this.data.splice(this.data.length-1,1),this.data.length>0&&this.siftDown(0),obj}return undefined},Heap.prototype.contains=function(element){var equF=collections.compareToEquals(this.compare);return collections.arrays.contains(this.data,element,equF)},Heap.prototype.size=function(){return this.data.length},Heap.prototype.isEmpty=function(){return this.data.length<=0},Heap.prototype.clear=function(){this.data.length=0},Heap.prototype.forEach=function(callback){collections.arrays.forEach(this.data,callback)},Heap}();Collections.Heap=Heap;var Stack=function(){function Stack(){this.list=new LinkedList}return Stack.prototype.push=function(elem){return this.list.add(elem,0)},Stack.prototype.add=function(elem){return this.list.add(elem,0)},Stack.prototype.pop=function(){return this.list.removeElementAtIndex(0)},Stack.prototype.peek=function(){return this.list.first()},Stack.prototype.size=function(){return this.list.size()},Stack.prototype.contains=function(elem,equalsFunction){return this.list.contains(elem,equalsFunction)},Stack.prototype.isEmpty=function(){return this.list.isEmpty()},Stack.prototype.clear=function(){this.list.clear()},Stack.prototype.forEach=function(callback){this.list.forEach(callback)},Stack}();Collections.Stack=Stack;var Queue=function(){function Queue(){this.list=new LinkedList}return Queue.prototype.enqueue=function(elem){return this.list.add(elem)},Queue.prototype.add=function(elem){return this.list.add(elem)},Queue.prototype.dequeue=function(){if(this.list.size()!==0){var el=this.list.first();return this.list.removeElementAtIndex(0),el}return undefined},Queue.prototype.peek=function(){return this.list.size()!==0?this.list.first():undefined},Queue.prototype.size=function(){return this.list.size()},Queue.prototype.contains=function(elem,equalsFunction){return this.list.contains(elem,equalsFunction)},Queue.prototype.isEmpty=function(){return this.list.size()<=0},Queue.prototype.clear=function(){this.list.clear()},Queue.prototype.forEach=function(callback){this.list.forEach(callback)},Queue}();Collections.Queue=Queue;var PriorityQueue=function(){function PriorityQueue(compareFunction){this.heap=new Heap(collections.reverseCompareFunction(compareFunction))}return PriorityQueue.prototype.enqueue=function(element){return this.heap.add(element)},PriorityQueue.prototype.add=function(element){return this.heap.add(element)},PriorityQueue.prototype.dequeue=function(){if(this.heap.size()!==0){var el=this.heap.peek();return this.heap.removeRoot(),el}return undefined},PriorityQueue.prototype.peek=function(){return this.heap.peek()},PriorityQueue.prototype.contains=function(element){return this.heap.contains(element)},PriorityQueue.prototype.isEmpty=function(){return this.heap.isEmpty()},PriorityQueue.prototype.size=function(){return this.heap.size()},PriorityQueue.prototype.clear=function(){this.heap.clear()},PriorityQueue.prototype.forEach=function(callback){this.heap.forEach(callback)},PriorityQueue}();Collections.PriorityQueue=PriorityQueue;var Set=function(){function Set(toStringFunction){this.dictionary=new Dictionary(toStringFunction)}return Set.prototype.contains=function(element){return this.dictionary.containsKey(element)},Set.prototype.add=function(element){return this.contains(element)||collections.isUndefined(element)?!1:(this.dictionary.setValue(element,element),!0)},Set.prototype.intersection=function(otherSet){var set=this;this.forEach(function(element){return otherSet.contains(element)||set.remove(element),!0})},Set.prototype.union=function(otherSet){var set=this;otherSet.forEach(function(element){return set.add(element),!0})},Set.prototype.difference=function(otherSet){var set=this;otherSet.forEach(function(element){return set.remove(element),!0})},Set.prototype.isSubsetOf=function(otherSet){if(this.size()>otherSet.size())return!1;var isSub=!0;return this.forEach(function(element){return otherSet.contains(element)?!0:(isSub=!1,!1)}),isSub},Set.prototype.remove=function(element){return this.contains(element)?(this.dictionary.remove(element),!0):!1},Set.prototype.forEach=function(callback){this.dictionary.forEach(function(k,v){return callback(v)})},Set.prototype.toArray=function(){return this.dictionary.values()},Set.prototype.isEmpty=function(){return this.dictionary.isEmpty()},Set.prototype.size=function(){return this.dictionary.size()},Set.prototype.clear=function(){this.dictionary.clear()},Set.prototype.toString=function(){return collections.arrays.toString(this.toArray())},Set}();Collections.Set=Set;var Bag=function(){function Bag(toStrFunction){this.toStrF=toStrFunction||collections.defaultToString,this.dictionary=new Dictionary(this.toStrF),this.nElements=0}return Bag.prototype.add=function(element,nCopies){nCopies===void 0&&(nCopies=1);if(collections.isUndefined(element)||nCopies<=0)return!1;if(!this.contains(element)){var node={value:element,copies:nCopies};this.dictionary.setValue(element,node)}else this.dictionary.getValue(element).copies+=nCopies;return this.nElements+=nCopies,!0},Bag.prototype.count=function(element){return this.contains(element)?this.dictionary.getValue(element).copies:0},Bag.prototype.contains=function(element){return this.dictionary.containsKey(element)},Bag.prototype.remove=function(element,nCopies){nCopies===void 0&&(nCopies=1);if(collections.isUndefined(element)||nCopies<=0)return!1;if(!this.contains(element))return!1;var node=this.dictionary.getValue(element);return nCopies>node.copies?this.nElements-=node.copies:this.nElements-=nCopies,node.copies-=nCopies,node.copies<=0&&this.dictionary.remove(element),!0},Bag.prototype.toArray=function(){var a=[],values=this.dictionary.values(),vl=values.length;for(var i=0;i<vl;i++){var node=values[i],element=node.value,copies=node.copies;for(var j=0;j<copies;j++)a.push(element)}return a},Bag.prototype.toSet=function(){var toret=new Set(this.toStrF),elements=this.dictionary.values(),l=elements.length;for(var i=0;i<l;i++){var value=elements[i].value;toret.add(value)}return toret},Bag.prototype.forEach=function(callback){this.dictionary.forEach(function(k,v){var value=v.value,copies=v.copies;for(var i=0;i<copies;i++)if(callback(value)===!1)return!1;return!0})},Bag.prototype.size=function(){return this.nElements},Bag.prototype.isEmpty=function(){return this.nElements===0},Bag.prototype.clear=function(){this.nElements=0,this.dictionary.clear()},Bag}();Collections.Bag=Bag;var BSTree=function(){function BSTree(compareFunction){this.root=null,this.compare=compareFunction||collections.defaultCompare,this.nElements=0}return BSTree.prototype.add=function(element){return collections.isUndefined(element)?!1:this.insertNode(this.createNode(element))!==null?(this.nElements++,!0):!1},BSTree.prototype.clear=function(){this.root=null,this.nElements=0},BSTree.prototype.isEmpty=function(){return this.nElements===0},BSTree.prototype.size=function(){return this.nElements},BSTree.prototype.contains=function(element){return collections.isUndefined(element)?!1:this.searchNode(this.root,element)!==null},BSTree.prototype.remove=function(element){var node=this.searchNode(this.root,element);return node===null?!1:(this.removeNode(node),this.nElements--,!0)},BSTree.prototype.inorderTraversal=function(callback){this.inorderTraversalAux(this.root,callback,{stop:!1})},BSTree.prototype.preorderTraversal=function(callback){this.preorderTraversalAux(this.root,callback,{stop:!1})},BSTree.prototype.postorderTraversal=function(callback){this.postorderTraversalAux(this.root,callback,{stop:!1})},BSTree.prototype.levelTraversal=function(callback){this.levelTraversalAux(this.root,callback)},BSTree.prototype.minimum=function(){return this.isEmpty()?undefined:this.minimumAux(this.root).element},BSTree.prototype.maximum=function(){return this.isEmpty()?undefined:this.maximumAux(this.root).element},BSTree.prototype.forEach=function(callback){this.inorderTraversal(callback)},BSTree.prototype.toArray=function(){var array=[];return this.inorderTraversal(function(element){return array.push(element),!0}),array},BSTree.prototype.height=function(){return this.heightAux(this.root)},BSTree.prototype.searchNode=function(node,element){var cmp=null;while(node!==null&&cmp!==0)cmp=this.compare(element,node.element),cmp<0?node=node.leftCh:cmp>0&&(node=node.rightCh);return node},BSTree.prototype.transplant=function(n1,n2){n1.parent===null?this.root=n2:n1===n1.parent.leftCh?n1.parent.leftCh=n2:n1.parent.rightCh=n2,n2!==null&&(n2.parent=n1.parent)},BSTree.prototype.removeNode=function(node){if(node.leftCh===null)this.transplant(node,node.rightCh);else if(node.rightCh===null)this.transplant(node,node.leftCh);else{var y=this.minimumAux(node.rightCh);y.parent!==node&&(this.transplant(y,y.rightCh),y.rightCh=node.rightCh,y.rightCh.parent=y),this.transplant(node,y),y.leftCh=node.leftCh,y.leftCh.parent=y}},BSTree.prototype.inorderTraversalAux=function(node,callback,signal){if(node===null||signal.stop)return;this.inorderTraversalAux(node.leftCh,callback,signal);if(signal.stop)return;signal.stop=callback(node.element)===!1;if(signal.stop)return;this.inorderTraversalAux(node.rightCh,callback,signal)},BSTree.prototype.levelTraversalAux=function(node,callback){var queue=new Queue;node!==null&&queue.enqueue(node);while(!queue.isEmpty()){node=queue.dequeue();if(callback(node.element)===!1)return;node.leftCh!==null&&queue.enqueue(node.leftCh),node.rightCh!==null&&queue.enqueue(node.rightCh)}},BSTree.prototype.preorderTraversalAux=function(node,callback,signal){if(node===null||signal.stop)return;signal.stop=callback(node.element)===!1;if(signal.stop)return;this.preorderTraversalAux(node.leftCh,callback,signal);if(signal.stop)return;this.preorderTraversalAux(node.rightCh,callback,signal)},BSTree.prototype.postorderTraversalAux=function(node,callback,signal){if(node===null||signal.stop)return;this.postorderTraversalAux(node.leftCh,callback,signal);if(signal.stop)return;this.postorderTraversalAux(node.rightCh,callback,signal);if(signal.stop)return;signal.stop=callback(node.element)===!1},BSTree.prototype.minimumAux=function(node){while(node.leftCh!==null)node=node.leftCh;return node},BSTree.prototype.maximumAux=function(node){while(node.rightCh!==null)node=node.rightCh;return node},BSTree.prototype.heightAux=function(node){return node===null?-1:Math.max(this.heightAux(node.leftCh),this.heightAux(node.rightCh))+1},BSTree.prototype.insertNode=function(node){var parent=null,position=this.root,cmp=null;while(position!==null){cmp=this.compare(node.element,position.element);if(cmp===0)return null;cmp<0?(parent=position,position=position.leftCh):(parent=position,position=position.rightCh)}return node.parent=parent,parent===null?this.root=node:this.compare(node.element,parent.element)<0?parent.leftCh=node:parent.rightCh=node,node},BSTree.prototype.createNode=function(element){return{element:element,leftCh:null,rightCh:null,parent:null}},BSTree}();Collections.BSTree=BSTree})(Collections=Utils.Collections||(Utils.Collections={}))})(Utils||(Utils={}));var Utils;(function(Utils){var Colors=function(){function Colors(){}return Colors.float32ColorToARGB=function(float32Color){var a=(float32Color&4278190080)>>>24,r=(float32Color&16711680)>>>16,g=(float32Color&65280)>>>8,b=float32Color&255,result=[a,r,g,b];return result},Colors._componentToHex=function(c){var hex=c.toString(16);return hex.length==1?"0"+hex:hex},Colors.rgbToHexString=function(rgb){return Colors.coalesce(rgb),"#"+Colors._componentToHex(rgb[0])+Colors._componentToHex(rgb[1])+Colors._componentToHex(rgb[2])},Colors.argbToHexString=function(argb){return"#"+Colors._componentToHex(argb[0])+Colors._componentToHex(argb[1])+Colors._componentToHex(argb[2])+Colors._componentToHex(argb[3])},Colors.coalesce=function(arr){for(var i=1;i<arr.length;i++)typeof arr[i]=="undefined"&&(arr[i]=arr[i-1])},Colors}();Utils.Colors=Colors})(Utils||(Utils={}));var Utils;(function(Utils){var Dates=function(){function Dates(){}return Dates.getTimeStamp=function(){return(new Date).getTime()},Dates}();Utils.Dates=Dates})(Utils||(Utils={}));var Utils;(function(Utils){var Device=function(){function Device(){}return Device.getPixelRatio=function(ctx){var dpr=window.devicePixelRatio||1,bsr=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1;return dpr/bsr},Device.isTouch=function(){return"ontouchstart"in window||window.navigator.msMaxTouchPoints>0},Device}();Utils.Device=Device})(Utils||(Utils={}));var Utils;(function(Utils){var Documents=function(){function Documents(){}return Documents.isInIFrame=function(){try{return window.self!==window.top}catch(e){return!0}},Documents.supportsFullscreen=function(){var doc=document.documentElement,support=doc.requestFullscreen||doc.mozRequestFullScreen||doc.webkitRequestFullScreen||doc.msRequestFullscreen;return support!=undefined},Documents.isHidden=function(){var prop=Documents.getHiddenProp();return prop?document[prop]:!1},Documents.getHiddenProp=function(){var prefixes=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var i=0;i<prefixes.length;i++)if(prefixes[i]+"Hidden"in document)return prefixes[i]+"Hidden";return null},Documents}();Utils.Documents=Documents})(Utils||(Utils={}));var Utils;(function(Utils){var Events=function(){function Events(){}return Events.debounce=function(fn,debounceDuration){return debounceDuration=debounceDuration||100,function(){if(!fn.debouncing){var args=Array.prototype.slice.apply(arguments);fn.lastReturnVal=fn.apply(window,args),fn.debouncing=!0}return clearTimeout(fn.debounceTimeout),fn.debounceTimeout=setTimeout(function(){fn.debouncing=!1},debounceDuration),fn.lastReturnVal}},Events}();Utils.Events=Events})(Utils||(Utils={}));var Utils;(function(Utils){var Files=function(){function Files(){}return Files.simplifyMimeType=function(mime){switch(mime){case"text/plain":return"txt";case"image/jpeg":return"jpg";case"application/msword":return"doc";case"application/vnd.openxmlformats-officedocument.wordprocessingml.document":return"docx";default:var parts=mime.split("/");return parts[parts.length-1]}},Files}();Utils.Files=Files})(Utils||(Utils={}));var Utils;(function(Utils){var Keyboard=function(){function Keyboard(){}return Keyboard.getCharCode=function(e){var charCode=typeof e.which=="number"?e.which:e.keyCode;return charCode},Keyboard}();Utils.Keyboard=Keyboard})(Utils||(Utils={}));var Utils;(function(Utils){var Maths;(function(Maths){var Vector=function(){function Vector(x,y){this.X=x,this.Y=y}return Vector.prototype.get=function(){return new Vector(this.X,this.Y)},Vector.prototype.set=function(x,y){this.X=x,this.Y=y},Vector.prototype.add=function(v){this.X+=v.X,this.Y+=v.Y},Vector.add=function(v1,v2){return new Vector(v1.X+v2.X,v1.Y+v2.Y)},Vector.prototype.sub=function(v){this.X-=v.X,this.Y-=v.Y},Vector.sub=function(v1,v2){return new Vector(v1.X-v2.X,v1.Y-v2.Y)},Vector.prototype.mult=function(n){this.X=this.X*n,this.Y=this.Y*n},Vector.mult=function(v1,v2){return new Vector(v1.X*v2.X,v1.Y*v2.Y)},Vector.multN=function(v1,n){return new Vector(v1.X*n,v1.Y*n)},Vector.prototype.Div=function(n){this.X=this.X/n,this.Y=this.Y/n},Vector.div=function(v1,v2){return new Vector(v1.X/v2.X,v1.Y/v2.Y)},Vector.divN=function(v1,n){return new Vector(v1.X/n,v1.Y/n)},Vector.prototype.mag=function(){return Math.sqrt(this.X*this.X+this.Y*this.Y)},Vector.prototype.magSq=function(){return this.X*this.X+this.Y*this.Y},Vector.prototype.normalise=function(){var m=this.mag();m!=0&&m!=1&&this.Div(m)},Vector.prototype.limit=function(max){this.magSq()>max*max&&(this.normalise(),this.mult(max))},Vector.prototype.equals=function(v){return this.X==v.X&&this.Y==v.Y},Vector.prototype.heading=function(){var angle=Math.atan2(-this.Y,this.X);return-1*angle},Vector.random2D=function(){return Vector.fromAngle(Math.random()*Math.TAU)},Vector.fromAngle=function(angle){return new Vector(Math.cos(angle),Math.sin(angle))},Vector}();Maths.Vector=Vector})(Maths=Utils.Maths||(Utils.Maths={}))})(Utils||(Utils={}));var Utils;(function(Utils){var Measurements;(function(Measurements){var Size=function(){function Size(width,height){this.width=width,this.height=height}return Size}();Measurements.Size=Size;var Dimensions=function(){function Dimensions(){}return Dimensions.fitRect=function(width1,height1,width2,height2){var ratio1=height1/width1,ratio2=height2/width2,width,height,scale;return ratio1<ratio2&&(scale=width2/width1,width=width1*scale,height=height1*scale),ratio2<ratio1&&(scale=height2/height1,width=width1*scale,height=height1*scale),new Size(Math.floor(width),Math.floor(height))},Dimensions.hitRect=function(x,y,w,h,mx,my){return mx>x&&mx<x+w&&my>y&&my<y+h?!0:!1},Dimensions}();Measurements.Dimensions=Dimensions})(Measurements=Utils.Measurements||(Utils.Measurements={}))})(Utils||(Utils={}));var Utils;(function(Utils){var Numbers=function(){function Numbers(){}return Numbers.numericalInput=function(event){return event.keyCode==46||event.keyCode==8||event.keyCode==9||event.keyCode==27||event.keyCode==65&&event.ctrlKey===!0||event.keyCode>=35&&event.keyCode<=39?!0:event.shiftKey||(event.keyCode<48||event.keyCode>57)&&(event.keyCode<96||event.keyCode>105)?(event.preventDefault(),!1):!0},Numbers}();Utils.Numbers=Numbers})(Utils||(Utils={}));var Utils;(function(Utils){var Storage=function(){function Storage(){}return Storage.clear=function(storageType){storageType===void 0&&(storageType=Utils.StorageType.memory);switch(storageType.value){case Utils.StorageType.memory.value:this._memoryStorage={};break;case Utils.StorageType.session.value:sessionStorage.clear();break;case Utils.StorageType.local.value:localStorage.clear()}},Storage.clearExpired=function(storageType){storageType===void 0&&(storageType=Utils.StorageType.memory);var items=this.getItems(storageType);for(var i=0;i<items.length;i++){var item=items[i];this._isExpired(item)&&this.remove(item.key)}},Storage.get=function(key,storageType){storageType===void 0&&(storageType=Utils.StorageType.memory);var data;switch(storageType.value){case Utils.StorageType.memory.value:data=this._memoryStorage[key];break;case Utils.StorageType.session.value:data=sessionStorage.getItem(key);break;case Utils.StorageType.local.value:data=localStorage.getItem(key)}if(!data)return null;var item=JSON.parse(data);return this._isExpired(item)?null:(item.key=key,item)},Storage._isExpired=function(item){return(new Date).getTime()<item.expiresAt?!1:!0},Storage.getItems=function(storageType){storageType===void 0&&(storageType=Utils.StorageType.memory);var items=[];switch(storageType.value){case Utils.StorageType.memory.value:var keys=Object.keys(this._memoryStorage);for(var i=0;i<keys.length;i++){var item=this.get(keys[i],Utils.StorageType.memory);item&&items.push(item)}break;case Utils.StorageType.session.value:for(var i=0;i<sessionStorage.length;i++){var key=sessionStorage.key(i),item=this.get(key,Utils.StorageType.session);item&&items.push(item)}break;case Utils.StorageType.local.value:for(var i=0;i<localStorage.length;i++){var key=localStorage.key(i),item=this.get(key,Utils.StorageType.local);item&&items.push(item)}}return items},Storage.remove=function(key,storageType){storageType===void 0&&(storageType=Utils.StorageType.memory);switch(storageType.value){case Utils.StorageType.memory.value:delete this._memoryStorage[key];break;case Utils.StorageType.session.value:sessionStorage.removeItem(key);break;case Utils.StorageType.local.value:localStorage.removeItem(key)}},Storage.set=function(key,value,expirationSecs,storageType){storageType===void 0&&(storageType=Utils.StorageType.memory);var expirationMS=expirationSecs*1e3,record=new Utils.StorageItem;record.value=value,record.expiresAt=(new Date).getTime()+expirationMS;switch(storageType.value){case Utils.StorageType.memory.value:this._memoryStorage[key]=JSON.stringify(record);break;case Utils.StorageType.session.value:sessionStorage.setItem(key,JSON.stringify(record));break;case Utils.StorageType.local.value:localStorage.setItem(key,JSON.stringify(record))}return record},Storage._memoryStorage={},Storage}();Utils.Storage=Storage})(Utils||(Utils={}));var Utils;(function(Utils){var StorageItem=function(){function StorageItem(){}return StorageItem}();Utils.StorageItem=StorageItem})(Utils||(Utils={}));var Utils;(function(Utils){var StorageType=function(){function StorageType(value){this.value=value}return StorageType.prototype.toString=function(){return this.value},StorageType.memory=new StorageType("memory"),StorageType.session=new StorageType("session"),StorageType.local=new StorageType("local"),StorageType}();Utils.StorageType=StorageType})(Utils||(Utils={}));var Utils;(function(Utils){var Strings=function(){function Strings(){}return Strings.ellipsis=function(text,chars){if(text.length<=chars)return text;var trimmedText=text.substr(0,chars),lastSpaceIndex=trimmedText.lastIndexOf(" ");return lastSpaceIndex!=-1&&(trimmedText=trimmedText.substr(0,Math.min(trimmedText.length,lastSpaceIndex))),trimmedText+"&hellip;"},Strings.htmlDecode=function(encoded){var div=document.createElement("div");return div.innerHTML=encoded,div.firstChild.nodeValue},Strings}();Utils.Strings=Strings})(Utils||(Utils={}));var Utils;(function(Utils){var Urls=function(){function Urls(){}return Urls.getHashParameter=function(key,doc){doc||(doc=window.document);var regex=new RegExp("#.*[?&]"+key+"=([^&]+)(&|$)"),match=regex.exec(doc.location.hash);return match?decodeURIComponent(match[1].replace(/\+/g," ")):null},Urls.setHashParameter=function(key,value,doc){doc||(doc=window.document);var kvp=this.updateURIKeyValuePair(doc.location.hash.replace("#?",""),key,value),newHash="#?"+kvp,url=doc.URL,index=url.indexOf("#");index!=-1&&(url=url.substr(0,url.indexOf("#"))),doc.location.replace(url+newHash)},Urls.getQuerystringParameter=function(key,w){return w||(w=window),this.getQuerystringParameterFromString(key,w.location.search)},Urls.getQuerystringParameterFromString=function(key,querystring){key=key.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+key+"=([^&#]*)"),match=regex.exec(querystring);return match?decodeURIComponent(match[1].replace(/\+/g," ")):null},Urls.setQuerystringParameter=function(key,value,doc){doc||(doc=window.document);var kvp=this.updateURIKeyValuePair(doc.location.hash.replace("#?",""),key,value);window.location.search=kvp},Urls.updateURIKeyValuePair=function(uriSegment,key,value){key=encodeURIComponent(key),value=encodeURIComponent(value);var kvp=uriSegment.split("&");kvp[0]==""&&kvp.shift();var i=kvp.length,x;while(i--){x=kvp[i].split("=");if(x[0]==key){x[1]=value,kvp[i]=x.join("=");break}}return i<0&&(kvp[kvp.length]=[key,value].join("=")),kvp.join("&")},Urls.getUrlParts=function(url){var a=document.createElement("a");return a.href=url,a},Urls.convertToRelativeUrl=function(url){var parts=this.getUrlParts(url),relUri=parts.pathname+parts.searchWithin;return relUri.startsWith("/")||(relUri="/"+relUri),relUri},Urls}();Utils.Urls=Urls})(Utils||(Utils={})),define("utils",function(global){return function(){var ret,fn;return ret||global.Utils}}(this)),define("Core/Resources/PooledFactoryResource",["require","exports","utils","etch"],function(require,exports){var ArgumentException=etch.exceptions.ArgumentException,Queue=Utils.Collections.Queue,PooledFactoryResource=function(){function PooledFactoryResource(minimumPoolSize,maximumPoolSize,type,propertyDescriptor){this._ValidatePoolLimits(minimumPoolSize,maximumPoolSize),this._PooledObjects=new Queue,this._Type=type,this._PropertyDescriptor=propertyDescriptor,this.MinimumPoolSize=minimumPoolSize,this.MaximumPoolSize=maximumPoolSize,this._PooledObjects=new Queue,this._AdjustPoolSizeToBounds()}return Object.defineProperty(PooledFactoryResource.prototype,"ObjectsInPoolCount",{get:function(){return this._PooledObjects.size()},enumerable:!0,configurable:!0}),Object.defineProperty(PooledFactoryResource.prototype,"MinimumPoolSize",{get:function(){return this._MinimumPoolSize},set:function(value){this._ValidatePoolLimits(value,this.MaximumPoolSize),this._MinimumPoolSize=value,this._AdjustPoolSizeToBounds()},enumerable:!0,configurable:!0}),Object.defineProperty(PooledFactoryResource.prototype,"MaximumPoolSize",{get:function(){return this._MaximumPoolSize},set:function(value){this._ValidatePoolLimits(this.MinimumPoolSize,value),this._MaximumPoolSize=value,this._AdjustPoolSizeToBounds()},enumerable:!0,configurable:!0}),PooledFactoryResource.prototype._ValidatePoolLimits=function(minimumPoolSize,maximumPoolSize){if(minimumPoolSize<0)throw new ArgumentException("Minimum pool size must be greater or equals to zero.");if(maximumPoolSize<1)throw new ArgumentException("Maximum pool size must be greater than zero.");if(minimumPoolSize>maximumPoolSize)throw new ArgumentException("Maximum pool size must be greater than the maximum pool size.")},PooledFactoryResource.prototype._AdjustPoolSizeToBounds=function(){while(this.ObjectsInPoolCount<this._MinimumPoolSize)this._PooledObjects.enqueue(this._CreatePooledObject());while(this.ObjectsInPoolCount>this._MaximumPoolSize)this._PooledObjects.dequeue()},PooledFactoryResource.prototype._CreatePooledObject=function(){var _this=this,obj=Object.create(this._Type,this._PropertyDescriptor);return obj.ReturnToPool=function(){_this._ReturnObjectToPool(obj)},obj},PooledFactoryResource.prototype.GetObject=function(){return this.ObjectsInPoolCount||this._AdjustPoolSizeToBounds(),this._PooledObjects.dequeue()},PooledFactoryResource.prototype._ReturnObjectToPool=function(objectToReturnToPool){if(this.ObjectsInPoolCount<this.MaximumPoolSize){if(!objectToReturnToPool.Reset()){this._DestroyPooledObject(objectToReturnToPool);return}this._PooledObjects.enqueue(objectToReturnToPool)}else this._DestroyPooledObject(objectToReturnToPool)},PooledFactoryResource.prototype._DestroyPooledObject=function(objectToDestroy){objectToDestroy.Disposed||objectToDestroy.Dispose()},PooledFactoryResource}();exports.PooledFactoryResource=PooledFactoryResource}),define("CommandHandlers/RedoCommandHandler",["require","exports","../Commands","../CommandCategories"],function(require,exports,Commands_1,CommandCategories_1){var RedoCommandHandler=function(){function RedoCommandHandler(){}return RedoCommandHandler.prototype.Execute=function(){if(App.OperationManager.CanRedo())return App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.REDO.toString()),App.OperationManager.Redo()},RedoCommandHandler}();exports.RedoCommandHandler=RedoCommandHandler}),define("Core/Resources/ResourceManager",["require","exports","etch"],function(require,exports){var ObservableCollection=etch.collections.ObservableCollection,RoutedEvent=etch.events.RoutedEvent,RoutedEventArgs=etch.events.RoutedEventArgs,ResourceManager=function(){function ResourceManager(){this._Resources=new ObservableCollection,this.ResourceAdded=new RoutedEvent}return ResourceManager.prototype.AddResource=function(resource){this._Resources.Add(resource),this.ResourceAdded.raise(resource,new RoutedEventArgs)},ResourceManager}();exports.ResourceManager=ResourceManager}),define("Operations/SaveOperation",["require","exports"],function(require,exports){var SaveOperation=function(){function SaveOperation(json,compositionId,sessionId){this._JSON=new PostData(compositionId?compositionId:"",json,sessionId?sessionId:""),this._LZMA=new LZMA("/lib/lzma/src/lzma_worker.js")}return SaveOperation.prototype.Compress=function(data){var _this=this;return new Promise(function(resolve){var compressionLevel=5;_this._LZMA.compress(data,compressionLevel,function(result){resolve(result.toString())},function(percent){})})},SaveOperation.prototype.Do=function(){var that=this;return new Promise(function(resolve,reject){that.Compress(that._JSON.Data).then(function(compressed){that._JSON.Data=compressed;var data=JSON.stringify(that._JSON),url=App.IsLocalhost()?"https://blokdust.com/api/save":"https://blokdust.com/api/save";$.ajax({url:url,type:"POST",crossDomain:!0,dataType:"json",contentType:"application/json",data:data}).done(function(saved){resolve(saved)}).fail(function(jqXHR,textStatus){reject(textStatus)})})})},SaveOperation.prototype.Dispose=function(){},SaveOperation}();exports.SaveOperation=SaveOperation;var PostData=function(){function PostData(Id,Data,SessionId){this.Id=Id,this.Data=Data,this.SessionId=SessionId}return PostData}();exports.PostData=PostData});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Errors",["require","exports","./StringValue"],function(require,exports,StringValue_1){var Error=function(_super){__extends(Error,_super);function Error(){_super.apply(this,arguments)}return Error}(StringValue_1.StringValue),Errors=function(){function Errors(){}return Errors.LOAD_FAILED=new Error("loadFailed"),Errors.SAVE_FAILED=new Error("saveFailed"),Errors.SAVE_AS_FAILED=new Error("saveAsFailed"),Errors}();exports.Errors=Errors}),define("CommandHandlers/SaveAsCommandHandler",["require","exports","../Operations/SaveOperation","../Commands","../CommandCategories","../Errors"],function(require,exports,SaveOperation_1,Commands_1,CommandCategories_1,Errors_1){var SaveAsCommandHandler=function(){function SaveAsCommandHandler(){}return SaveAsCommandHandler.prototype.Execute=function(){var op=new SaveOperation_1.SaveOperation(App.Serialize(),null,null);return App.OperationManager.Do(op).then(function(result){result?(App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.SAVE_AS.toString(),App.CompositionId),App.CompositionId=result.Id,App.MainScene.SharePanel.ReturnLink(result.Id),App.SessionId=result.SessionId):(App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Errors_1.Errors.SAVE_AS_FAILED.toString(),App.CompositionId),App.MainScene.SharePanel.ClosePanel(),App.Message(App.L10n.Errors.SaveError))})},SaveAsCommandHandler}();exports.SaveAsCommandHandler=SaveAsCommandHandler}),define("CommandHandlers/SaveCommandHandler",["require","exports","../Commands","../Operations/SaveOperation","../CommandCategories","../Errors"],function(require,exports,Commands_1,SaveOperation_1,CommandCategories_1,Errors_1){var SaveCommandHandler=function(){function SaveCommandHandler(){}return SaveCommandHandler.prototype.Execute=function(){var op=new SaveOperation_1.SaveOperation(App.Serialize(),App.CompositionId,App.SessionId);return App.OperationManager.Do(op).then(function(result){result?(App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.SAVE.toString(),App.CompositionId),App.CompositionId=result.Id,App.MainScene.SharePanel.ReturnLink(result.Id),App.SessionId=result.SessionId):(App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Errors_1.Errors.SAVE_FAILED.toString(),App.CompositionId),App.MainScene.SharePanel.ClosePanel(),App.Message(App.L10n.Errors.SaveError))})},SaveCommandHandler}();exports.SaveCommandHandler=SaveCommandHandler}),define("SaveFile",["require","exports"],function(require,exports){var SaveFile=function(){function SaveFile(){}return SaveFile}();exports.SaveFile=SaveFile}),define("_Version",["require","exports"],function(require,exports){exports.Version="1.0.12"}),define("Serializer",["require","exports","./Blocks/Effect","./SaveFile","./Blocks/Source","./_Version"],function(require,exports,Effect_1,SaveFile_1,Source_1,_Version_1){var Point=etch.primitives.Point,Serializer=function(){function Serializer(){}return Serializer.Serialize=function(){this._Debug&&console.log("START SERIALIZATION");var blocks=App.Blocks;this._Debug&&console.log("BLOCKS",blocks),this._SerializationDictionary={};for(var i=0;i<blocks.length;i++){var b=blocks[i];this._SerializationDictionary[b.Id]=!1}this._Debug&&console.log("DICTIONARY",this._SerializationDictionary);var json={ColorThemeNo:App.ThemeManager.CurrentThemeNo,Composition:[],DragOffset:App.DragOffset,Parent:App.CompositionId?App.CompositionId:"",Version:_Version_1.Version,ZoomLevel:App.ZoomLevel};this._SerializeBlocks(json.Composition,blocks);var result=JSON.stringify(json);return this._Debug&&console.log("END SERIALIZATION",result),result},Serializer._SerializeBlocks=function(list,blocks,parentBlock){for(var i=0;i<blocks.length;i++){var b=this._SerializeBlock(blocks[i],parentBlock);b&&list.push(b),this._Debug&&(console.log("DICTIONARY",this._SerializationDictionary),console.log("SERIALIZED LIST",list))}},Serializer._GetBlockSerializationType=function(block){return block.constructor.name},Serializer._SerializeBlock=function(block,parentBlock){this._Debug&&console.log("SERIALIZING",block);var d=this._SerializationDictionary[block.Id];if(d){this._Debug&&console.log("ALREADY SERIALIZED");return}this._SerializationDictionary[block.Id]=!0;var b={};return b.Id=block.Id,b.Type=this._GetBlockSerializationType(block),b.Position=block.Position,b.ZIndex=block.ZIndex,block.Params&&(b.Params=block.Params),block instanceof Source_1.Source&&block.Connections.Count&&(b.Effects=[],parentBlock&&b.Effects.push(parentBlock.Id),this._SerializeBlocks(b.Effects,block.Connections.ToArray(),b)),block instanceof Effect_1.Effect&&block.Connections.Count&&(b.Sources=[],parentBlock&&b.Sources.push(parentBlock.Id),this._SerializeBlocks(b.Sources,block.Connections.ToArray(),b)),b},Serializer.Deserialize=function(json){this._Debug&&console.log("START DESERIALIZATION",json),this._DeserializationDictionary={};var parsed=JSON.parse(json),saveFile=new SaveFile_1.SaveFile;return saveFile.ZoomLevel=parsed.ZoomLevel,parsed.DragOffset?saveFile.DragOffset=new Point(parsed.DragOffset.x,parsed.DragOffset.y):(saveFile.DragOffset=new Point(0,0),saveFile.ZoomLevel=1),saveFile.Composition=this._DeserializeBlocks(parsed.Composition),parsed.ColorThemeNo?saveFile.ColorThemeNo=parsed.ColorThemeNo:saveFile.ColorThemeNo=0,saveFile},Serializer._DeserializeBlocks=function(blocks){var deserializedBlocks=[];for(var i=0;i<blocks.length;i++){var b=blocks[i],block=this._DeserializeBlock(b);deserializedBlocks.push(block)}return deserializedBlocks},Serializer._DeserializeBlock=function(b){var block;(b.Id==null||!b.Id.isInteger())&&Serializer._DeserializationDictionary[b]?block=Serializer._DeserializationDictionary[b]:(block=this._GetBlockDeserializationType(b),block.Id=b.Id,block.Position=new Point(b.Position.x,b.Position.y),block.LastPosition=new Point(b.Position.x,b.Position.y),block.Params=b.Params,block.ZIndex=b.ZIndex,Serializer._DeserializationDictionary[b.Id]=block);if(b.Effects){var effects=Serializer._DeserializeBlocks(b.Effects);block.Connections.AddRange(effects)}if(b.Sources){var sources=Serializer._DeserializeBlocks(b.Sources);block.Connections.AddRange(sources)}return block},Serializer._GetBlockDeserializationType=function(b){return App.BlockCreator.GetBlock(b.Type)},Serializer._Debug=!1,Serializer}();exports.Serializer=Serializer}),define("Core/Audio/SoundCloud/SoundCloudAPI",["require","exports"],function(require,exports){var SoundCloudAPI=function(){function SoundCloudAPI(){}return SoundCloudAPI.Initialize=function(){typeof SC!="undefined"&&SC.initialize({client_id:App.Config.SoundCloudClientId}),this.QueryTotal=5},SoundCloudAPI.PickRandomTrack=function(t){switch(t){case 0:var defaults=App.Config.SoundCloudDefaultTracks;break;case 1:var defaults=App.Config.GranularDefaultTracks;break;case 2:var defaults=App.Config.ConvolverDefaultTracks;break;default:var defaults=App.Config.SoundCloudDefaultTracks}var track=defaults[Math.floor(Math.random()*defaults.length)];return"https://api.soundcloud.com/tracks/"+track+"/stream?client_id="+App.Config.SoundCloudClientId},SoundCloudAPI.PickTrack=function(t,n){switch(t){case 0:var defaults=App.Config.SoundCloudDefaultTracks;break;case 1:var defaults=App.Config.GranularDefaultTracks;break;case 2:var defaults=App.Config.ConvolverDefaultTracks;break;default:var defaults=App.Config.SoundCloudDefaultTracks}var track=defaults[n];return"https://api.soundcloud.com/tracks/"+track+"/stream?client_id="+App.Config.SoundCloudClientId},SoundCloudAPI.LoadTrack=function(track){var trackUrl=track.URI;return""+trackUrl+"/stream?client_id="+App.Config.SoundCloudClientId},SoundCloudAPI.Monitor=function(){window.SC&&SC.get("/apps",{}).then(function(app){console.log(app)})},SoundCloudAPI.Search=function(query,seconds,successResponse,failedResponse){var _this=this;window.SC?SC.get("/tracks",{q:query,duration:{to:seconds*1e3},limit:200,offset:0}).then(function(tracks){if(tracks){var tracksRemainAfterElimination=!1;tracks.forEach(function(track){track.streamable&&track.sharing==="public"&&(track.license.indexOf("all-rights-reserved")===-1||track.tag_list.toLowerCase().indexOf("blokdust")!==-1)&&(tracksRemainAfterElimination=!0,successResponse(track))});if(!tracksRemainAfterElimination){var err={status:452,message:App.L10n.Errors.SoundCloud.FailedTrackFiltering};_this.SearchError(err),failedResponse(err)}}},function(error){_this.SearchError(error),failedResponse(error)}):(App.Message(App.L10n.Errors.SoundCloud.Uninitialized),console.error(App.L10n.Errors.SoundCloud.Uninitialized))},SoundCloudAPI.MultiSearch=function(query,seconds,block){var _this=this;window.SC?(this._QueryReturns=0,this.QueryList=[],this.OptionSearch(query,seconds,{license:"cc-by"},function(tracks){_this.MultiCallback(block,tracks,"cc-by")},function(error){_this.MultiCallback(block,[],"error")}),this.OptionSearch(query,seconds,{license:"cc-by-nc-sa"},function(tracks){_this.MultiCallback(block,tracks,"cc-by-nc-sa")},function(error){_this.MultiCallback(block,[],"error")}),this.OptionSearch(query,seconds,{license:"to_use_commercially"},function(tracks){_this.MultiCallback(block,tracks,"to_use_commercially")},function(error){_this.MultiCallback(block,[],"error")}),this.OptionSearch(query,seconds,{license:"to_share"},function(tracks){_this.MultiCallback(block,tracks,"to_share")},function(error){_this.MultiCallback(block,[],"error")}),this.OptionSearch(query,seconds,{tag:"blokdust"},function(tracks){_this.MultiCallback(block,tracks,"blokdust")},function(error){_this.MultiCallback(block,[],"error")})):(App.Message(App.L10n.Errors.SoundCloud.Uninitialized),console.error(App.L10n.Errors.SoundCloud.Uninitialized))},SoundCloudAPI.OptionSearch=function(query,seconds,options,successResponse,failedResponse){var _this=this;options=options||{};var searchOptions={};options.license?searchOptions={q:query,license:options.license,duration:{to:seconds*1e3},limit:200}:options.tag?searchOptions={q:query,tags:options.tag,duration:{to:seconds*1e3},limit:200}:searchOptions={q:query,duration:{to:seconds*1e3},limit:200},SC.get("/tracks",searchOptions).then(function(tracks){if(tracks){var trackList=[];tracks.forEach(function(track){track.streamable&&track.sharing==="public"&&trackList.push(track)}),successResponse(trackList)}},function(error){_this.SearchError(error),failedResponse(error)})},SoundCloudAPI.MultiCallback=function(block,results,string){var i,maxResults=200;if(results.length){var count=0;if(this.QueryList.length===0)for(i=0;i<results.length;i++)this.QueryList.push(results[i]);else for(i=0;i<results.length;i++)this.Exists(this.QueryList,results[i].id)||this.QueryList.length<maxResults&&this.QueryList.push(results[i])}this._QueryReturns+=1,this._QueryReturns===this.QueryTotal&&block.SetSearchResults(this.QueryList)},SoundCloudAPI.Exists=function(list,id){var len=list.length;for(var h=0;h<len;h++)if(id===list[h].id)return!0;return!1},SoundCloudAPI.SearchError=function(error){switch(error.status){case 429:App.Message(App.L10n.Errors.SoundCloud.TooManyRequests);break;case 452:break;case 500:App.Message(App.L10n.Errors.SoundCloud.InternalServerError);break;case 503:App.Message(App.L10n.Errors.SoundCloud.ServiceUnavailable);break;default:error.message?App.Message("SoundCloud error: "+error.message):App.Message("SoundCloud error, check console")}console.error(error)},SoundCloudAPI.Connect=function(){SC.connect().then(function(){return SC.get("/me")}).then(function(me){alert("Hello, "+me.username)},function(error){App.Message("SoundCloud couldn't connect: "+error.message),console.log(error.message,error.status)})},SoundCloudAPI.Upload=function(blob,title){SC.upload({file:blob,title:title,tag_list:"blokdust",license:"cc-by-nc",sharing:"public",progress:function(e){var percentCompleted=e.loaded/e.total*100;console.log(percentCompleted+"% completed")}}).then(function(track){alert("Upload is done! Check your sound at "+track.permalink_url)},function(error){console.error(error)})},SoundCloudAPI}();exports.SoundCloudAPI=SoundCloudAPI});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/AnimationsLayer",["require","exports"],function(require,exports){var DisplayObject=etch.drawing.DisplayObject,AnimationsLayer=function(_super){__extends(AnimationsLayer,_super);function AnimationsLayer(){_super.apply(this,arguments),this.ActiveBlocks=[],this.Loop=0,this.Spinning=!1}return AnimationsLayer.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo)},AnimationsLayer.prototype.Update=function(){_super.prototype.Update.call(this),this.Spinning&&(this.Loop+=1),this.Loop===60&&(this.Loop=0)},AnimationsLayer.prototype.Spin=function(){this.ActiveBlocks.length<1&&(this.Loop+=1),this.Loop===60&&(this.Loop=0)},AnimationsLayer.prototype.AddToList=function(block){this.RemoveFromList(block),this.ActiveBlocks.push(block)},AnimationsLayer.prototype.RemoveFromList=function(block){var b=this.ActiveBlocks.indexOf(block);b!=-1&&this.ActiveBlocks.splice(b,1)},AnimationsLayer.prototype.Draw=function(){if(this.ActiveBlocks.length>0){for(var i=0;i<this.ActiveBlocks.length;i++){var block=this.ActiveBlocks[i],blockPos=App.Metrics.PointOnGrid(block.Position);this.DrawBubble(blockPos.x,blockPos.y),this.DrawSprite(this.Ctx,"loading",blockPos.x,blockPos.y,6,!1)}this.Spinning=!0}},AnimationsLayer.prototype.DrawBubble=function(x,y){var grd=App.GridSize;App.FillColor(this.Ctx,App.Palette[2]),this.Ctx.globalAlpha=.95,this.Ctx.beginPath(),this.Ctx.moveTo(x-grd,y-2*grd),this.Ctx.lineTo(x,y-2*grd),this.Ctx.lineTo(x,y),this.Ctx.lineTo(x-grd,y-grd),this.Ctx.fill(),this.Ctx.globalAlpha=1},AnimationsLayer.prototype.DrawSprite=function(ctx,index,x,y,w,c){var units=App.Unit,grd=App.GridSize;c&&(grd=0),this.Spinning=!0,ctx.globalAlpha=1,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]);switch(index){case"loading":var angle=this.Loop/60*2*Math.PI,v1=App.Metrics.VectorFromAngle(angle+Math.PI*.25),v2=App.Metrics.VectorFromAngle(angle+Math.PI*.75),vx=x-.5*grd,vy=y-1.5*grd,r=w*.75*units;ctx.beginPath(),ctx.moveTo(vx+v1.x*r,vy+v1.y*r),ctx.lineTo(vx+v2.x*r,vy+v2.y*r),ctx.lineTo(vx-v1.x*r,vy-v1.y*r),ctx.lineTo(vx-v2.x*r,vy-v2.y*r),ctx.closePath(),ctx.fill()}},AnimationsLayer}(DisplayObject);exports.AnimationsLayer=AnimationsLayer});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/CreateNew",["require","exports"],function(require,exports){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,Point=minerva.Point,CreateNew=function(_super){__extends(CreateNew,_super);function CreateNew(){_super.apply(this,arguments),this._RollOvers=[]}return CreateNew.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.BlockCount=0,this.Hover=!1,this.IconPos=new Point(25,App.Metrics.HeaderHeight*.5),this.IconOffset=new Point(-1,0),this.Open=!1,this.PanelOffset=new Point(0,-1),this.PanelOffset2=new Point(0,1),this.Selected=0,this.Tweens=[],this.Verify=App.L10n.UI.CreateNew.Verify.toUpperCase(),this.Message=App.L10n.UI.CreateNew.NewMessage.toUpperCase(),this.MessagePos=new Point(100,30),this.TickX=130,this.CrossX=this.TickX+60},CreateNew.prototype.CheckState=function(){App.Blocks.length>1?this.IconOffset.x<0&&App.Blocks.length!==this.BlockCount&&(this.StopAllTweens(),this.DelayTo(this.IconOffset,0,.6,0,"x"),this.DelayTo(App.MainScene.Header,30,.6,0,"CreateNewMargin")):this.IconOffset.x>-1&&(this.StopAllTweens(),this.Open&&(this.Open=!1,this.DelayTo(this,0,.3,0,"Selected"),this.DelayTo(this.PanelOffset,-1,.3,0,"y")),this.PanelOffset2.y===0&&this.CloseMessage(),this.DelayTo(this.IconOffset,-1,.6,0,"x"),this.DelayTo(App.MainScene.Header,0,.6,0,"CreateNewMargin")),this.BlockCount=App.Blocks.length},CreateNew.prototype.Draw=function(){var ctx=this.Ctx,units=App.Unit,midType=App.Metrics.TxtMid,italicType=App.Metrics.TxtItalic2,x=this.IconPos.x,y=this.IconPos.y,yx=this.TickX*units,nx=this.CrossX*units,xOffset=this.IconOffset.x*this.IconPos.x*units*2,header=App.MainScene.Header,height=header.Height*units,width=50*units,panelOffset=this.PanelOffset.y*header.Height*2*units,panelOffset2=this.PanelOffset2.y*500*units;if(this.PanelOffset.y>-1){var ym=1;this._RollOvers[1]&&(ym=1.2);var nm=1;this._RollOvers[2]&&(nm=1.2),ctx.textAlign="left",ctx.font=midType,ctx.save(),ctx.beginPath(),ctx.moveTo(0,Math.round(header.Height*header.Rows*units)),ctx.lineTo(App.Width,Math.round(header.Height*header.Rows*units)),ctx.lineTo(App.Width,App.Height*.5),ctx.lineTo(0,App.Height*.5),ctx.closePath(),ctx.clip(),App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.16,ctx.fillRect(0,Math.round(header.Height*header.Rows*units+panelOffset),nx+30*units,height+5*units),ctx.globalAlpha=.9,ctx.fillRect(0,Math.round(header.Height*header.Rows*units+panelOffset),nx+30*units,height);var sy=Math.round(header.Height*(header.Rows+.5)*units+panelOffset);ctx.globalAlpha=1,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillText(this.Verify,x,sy+10*units*.38),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(yx-12*ym*units,sy),ctx.lineTo(yx-4*ym*units,sy+8*ym*units),ctx.lineTo(yx+12*ym*units,sy-8*ym*units),ctx.moveTo(nx-8*nm*units,sy-8*nm*units),ctx.lineTo(nx+8*nm*units,sy+8*nm*units),ctx.moveTo(nx+8*nm*units,sy-8*nm*units),ctx.lineTo(nx-8*nm*units,sy+8*nm*units),ctx.stroke(),App.StrokeColor(ctx,App.Palette[1]),ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(yx+30*units,sy-16*units),ctx.lineTo(yx+30*units,sy+16*units),ctx.stroke(),ctx.restore(),App.StrokeColor(ctx,App.Palette[1]),ctx.lineWidth=1,this.PanelOffset.y>-0.5&&(ctx.beginPath(),ctx.moveTo(20*units,Math.round(header.Height*header.Rows*units)),ctx.lineTo(nx+10*units,Math.round(header.Height*header.Rows*units)),ctx.stroke())}this.Selected&&(App.FillColor(ctx,App.Palette[App.ThemeManager.MenuOrder[1]]),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(width,0),ctx.lineTo(width,height*this.Selected),ctx.lineTo(width*.5+10*units,height*this.Selected),ctx.lineTo(width*.5,(height+10*units)*this.Selected),ctx.lineTo(width*.5-10*units,height*this.Selected),ctx.lineTo(0,height*this.Selected),ctx.closePath(),ctx.fill());var m=1;this._RollOvers[0]&&(m=1.2),ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo((x-2*m)*units+xOffset,(y-2*m)*units),ctx.lineTo((x+8*m)*units+xOffset,(y-2*m)*units),ctx.moveTo((x+3*m)*units+xOffset,(y-7*m)*units),ctx.lineTo((x+3*m)*units+xOffset,(y+3*m)*units),ctx.moveTo((x-5*m)*units+xOffset,(y-2*m)*units),ctx.lineTo((x-5*m)*units+xOffset,(y+6*m)*units),ctx.lineTo((x+3*m)*units+xOffset,(y+6*m)*units),ctx.stroke();if(this.PanelOffset2.y<.5){var mm=1;this._RollOvers[3]&&(mm=1.01);var w=this.MessagePos.x;y=this.MessagePos.y,ctx.beginPath(),ctx.moveTo(App.Width*.5-w*mm*units,App.Height-y*units-16*mm*units+panelOffset2),ctx.lineTo(App.Width*.5+w*mm*units,App.Height-y*units-16*mm*units+panelOffset2),ctx.lineTo(App.Width*.5+w*mm*units,App.Height-y*units+16*mm*units+panelOffset2),ctx.lineTo(App.Width*.5-w*mm*units,App.Height-y*units+16*mm*units+panelOffset2),ctx.closePath(),ctx.stroke(),ctx.beginPath(),ctx.moveTo(App.Width*.5+(w+6)*units,App.Height-(y+19)*units+panelOffset2),ctx.lineTo(App.Width*.5+(w+14)*units,App.Height-(y+11)*units+panelOffset2),ctx.moveTo(App.Width*.5+(w+14)*units,App.Height-(y+19)*units+panelOffset2),ctx.lineTo(App.Width*.5+(w+6)*units,App.Height-(y+11)*units+panelOffset2),ctx.stroke(),ctx.textAlign="center",App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillText(this.Message,App.Width*.5,App.Height-30*units+10*units*.38+panelOffset2)}},CreateNew.prototype.DelayTo=function(panel,destination,t,delay,v){var offsetTween=new window.TWEEN.Tween({x:panel[""+v]});offsetTween.to({x:destination},t*1e3),offsetTween.onUpdate(function(){panel[""+v]=this.x}),offsetTween.onComplete(function(){v=="OffsetY"&&destination!==0&&(panel.Open=!1)}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick),this.Tweens.push(offsetTween)},CreateNew.prototype.StopAllTweens=function(){if(this.Tweens.length){for(var j=0;j<this.Tweens.length;j++)this.Tweens[j].stop();this.Tweens=[]}},CreateNew.prototype.OpenPanel=function(){this.Open=!0,App.MainScene.Header.ClosePanel(),this.DelayTo(this,1,.3,0,"Selected"),this.DelayTo(this.PanelOffset,0,.5,.1,"y"),this.DelayTo(App.MainScene.Header,50,.3,0,"CreateNewMargin")},CreateNew.prototype.ClosePanel=function(){this.Open=!1,this.DelayTo(this,0,.3,0,"Selected"),this.DelayTo(this.PanelOffset,-1,.3,0,"y"),this.DelayTo(App.MainScene.Header,30,.3,0,"CreateNewMargin")},CreateNew.prototype.ShowMessage=function(){this.PanelOffset2.y=0},CreateNew.prototype.CloseMessage=function(){this.DelayTo(this.PanelOffset2,1,.6,0,"y")},CreateNew.prototype.MouseDown=function(point){this.HitTests(point);if(this._RollOvers[0]){this.OpenPanel();return}if(this.Open){if(this._RollOvers[1]){this.CreateNewScene();return}this.ClosePanel();return}if(this._RollOvers[3]){this.CreateNewScene(),App.MainScene.Tutorial.CheckLaunch();return}this._RollOvers[4]&&this.CloseMessage()},CreateNew.prototype.MouseUp=function(point){},CreateNew.prototype.MouseMove=function(point){this.HitTests(point)},CreateNew.prototype.HitTests=function(point){this.Hover=!1;var ctx=this.Ctx,units=App.Unit,xOffset=this.IconOffset.x*this.IconPos.x*units*2,yx=this.TickX*units,nx=this.CrossX*units,header=App.MainScene.Header,height=header.Height*units,panelOffset=this.PanelOffset.y*header.Height*2*units,panelOffset2=this.PanelOffset2.y*500*units;this._RollOvers[0]=Dimensions.hitRect((this.IconPos.x-20)*units+xOffset,(this.IconPos.y-20)*units,40*units,40*units,point.x,point.y),this._RollOvers[1]=Dimensions.hitRect(yx-20*units,height*(header.Rows+.5)-20*units+panelOffset,40*units,40*units,point.x,point.y),this._RollOvers[2]=Dimensions.hitRect(nx-20*units,height*(header.Rows+.5)-20*units+panelOffset,40*units,40*units,point.x,point.y),this._RollOvers[3]=Dimensions.hitRect(App.Width*.5-this.MessagePos.x*units,App.Height-(this.MessagePos.y+20)*units+panelOffset2,this.MessagePos.x*2*units,40*units,point.x,point.y),this._RollOvers[4]=Dimensions.hitRect(App.Width*.5+this.MessagePos.x*units,App.Height-(this.MessagePos.y+31)*units+panelOffset2,30*units,30*units,point.x,point.y);if(this._RollOvers[0]||this._RollOvers[1]||this._RollOvers[2]||this._RollOvers[3]||this._RollOvers[4])this.Hover=!0},CreateNew.prototype.CreateNewScene=function(){this.BlockCount=0,App.Stage.MainScene.ResetScene()},CreateNew}(DisplayObject);exports.CreateNew=CreateNew}),define("MathObjects/Line",["require","exports"],function(require,exports){var Line=function(){function Line(){this.Points=[]}return Line}();exports.Line=Line});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/ConnectionLines",["require","exports","../MathObjects/Line"],function(require,exports,Line_1){var DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,ConnectionLines=function(_super){__extends(ConnectionLines,_super);function ConnectionLines(){_super.apply(this,arguments)}return ConnectionLines.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.UpdateList()},ConnectionLines.prototype.Draw=function(){var grd=App.ScaledGridSize;App.StrokeColor(this.Ctx,App.Palette[15]),this.Ctx.lineWidth=1,this.Ctx.beginPath();for(var j=0;j<this._Unpowered.length;j++){var myPos=App.Metrics.PointOnGrid(this._Unpowered[j].Points[0]);this.Ctx.moveTo(myPos.x,myPos.y);for(var i=1;i<this._Unpowered[j].Points.length;i++){var myPos=App.Metrics.PointOnGrid(this._Unpowered[j].Points[i]);this.Ctx.lineTo(myPos.x,myPos.y)}}this.Ctx.stroke(),this.Ctx.lineWidth=2,this.Ctx.beginPath();for(var j=0;j<this._Powered.length;j++){var myPos=App.Metrics.PointOnGrid(this._Powered[j].Points[0]);this.Ctx.moveTo(myPos.x,myPos.y);for(var i=1;i<this._Powered[j].Points.length;i++){var myPos=App.Metrics.PointOnGrid(this._Powered[j].Points[i]);this.Ctx.lineTo(myPos.x,myPos.y)}}this.Ctx.stroke()},ConnectionLines.prototype.UpdateList=function(){this._Powered=[],this._Unpowered=[];for(var j=0;j<App.Sources.length;j++){var block=App.Sources[j];if(block.Connections.Count){var modifiers=block.Connections.ToArray(),grd=App.ScaledGridSize;for(var i=0;i<modifiers.length;i++){var target=modifiers[i],myPos=block.Position,targetPos=target.Position,myLine=new Line_1.Line,xDif=targetPos.x-myPos.x,yDif=targetPos.y-myPos.y;myLine.Points.push(new Point(myPos.x,myPos.y)),xDif>0&&(yDif<0&&(-yDif<xDif&&myLine.Points.push(new Point(Math.round(myPos.x+(xDif- -yDif)),Math.round(myPos.y))),-yDif>xDif&&myLine.Points.push(new Point(Math.round(myPos.x),Math.round(myPos.y-(-yDif-xDif))))),yDif>0&&(yDif<xDif&&myLine.Points.push(new Point(Math.round(myPos.x+(xDif-yDif)),Math.round(myPos.y))),yDif>xDif&&myLine.Points.push(new Point(Math.round(myPos.x),Math.round(myPos.y+(yDif-xDif)))))),xDif<0&&(yDif<0&&(yDif>xDif&&myLine.Points.push(new Point(Math.round(myPos.x-(yDif-xDif)),Math.round(myPos.y))),yDif<xDif&&myLine.Points.push(new Point(Math.round(myPos.x),Math.round(myPos.y-(xDif-yDif))))),yDif>0&&(yDif<-xDif&&myLine.Points.push(new Point(Math.round(myPos.x-(-xDif-yDif)),Math.round(myPos.y))),yDif>-xDif&&myLine.Points.push(new Point(Math.round(myPos.x),Math.round(myPos.y+(yDif- -xDif)))))),myLine.Points.push(new Point(targetPos.x,targetPos.y)),block.IsPowered()?this._Powered.push(myLine):this._Unpowered.push(myLine)}}}},ConnectionLines}(DisplayObject);exports.ConnectionLines=ConnectionLines}),define("UI/MenuCategory",["require","exports"],function(require,exports){var MenuCategory=function(){function MenuCategory(position,size,name,offset){this.Items=[],this.Position=position,this.Size=size,this.Name=name,this.Selected=0,this.Hover=!1,this.XOffset=0,this.YOffset=offset,this.CurrentPage=0}return MenuCategory.prototype.Draw=function(ctx,units,header,offset){ctx.globalAlpha=1;var dataType=units*10,thisHeight=Math.round(header.Height*units),dropDown=Math.round(header.DropDown*units),x=this.Position.x,width=this.Size.width*.5;ctx.beginPath(),ctx.moveTo(x-width,offset),ctx.lineTo(x+width,offset),ctx.lineTo(x+width,offset+thisHeight*this.Selected),ctx.lineTo(x+10*units,offset+thisHeight*this.Selected),ctx.lineTo(x,offset+(thisHeight+10*units)*this.Selected),ctx.lineTo(x-10*units,offset+thisHeight*this.Selected),ctx.lineTo(x-width,offset+thisHeight*this.Selected),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillText(this.Name,x,offset+thisHeight*.5+dataType*.38),this.Hover&&dropDown<1&&(App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.9,ctx.beginPath(),ctx.moveTo(x-10*units,offset+thisHeight),ctx.lineTo(x,offset+thisHeight+10*units),ctx.lineTo(x+10*units,offset+thisHeight),ctx.closePath(),ctx.fill())},MenuCategory}();exports.MenuCategory=MenuCategory}),define("UI/MenuItem",["require","exports"],function(require,exports){var Point=etch.primitives.Point,MenuItem=function(){function MenuItem(position,size,name,id,description,sketch){this.Position=position,this.Size=size,this.Name=name,this.ID=id,this.Description=description,this.Selected=0,this.Hover=!1,this.InfoHover=!1,this.BackHover=!1,this.InfoOffset=0,this._MainScene=sketch,this.MouseIsDown=!1}return MenuItem.prototype.Draw=function(displayContext,units,x,y){this.Ctx=displayContext.Ctx,this.Ctx.globalAlpha=1;var y=this.Position.y-y*units-this.InfoOffset*units;App.FillColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(this.Ctx,App.Palette[App.ThemeManager.Txt]);var dataType=units*10;this.Ctx.textAlign="center",this.Ctx.font=App.Metrics.TxtMid,this.Ctx.fillText(this.Name,x,y+40*units),this.Ctx.lineWidth=1;var ix=x-40*units,iy=y-30*units,diamond=11;this.Ctx.beginPath(),this.Ctx.moveTo(ix-diamond*units,iy),this.Ctx.lineTo(ix,iy-diamond*units),this.Ctx.lineTo(ix+diamond*units,iy),this.Ctx.lineTo(ix,iy+diamond*units),this.Ctx.closePath(),this.Ctx.stroke(),this.Ctx.fillText("?",ix,iy+dataType*.38);if(this.InfoOffset!==0){this.Ctx.lineWidth=2;var ay=y+this.Size.height*1.5-30*units;this.Ctx.beginPath(),this.Ctx.moveTo(x-diamond*units,ay),this.Ctx.lineTo(x,ay+diamond*units),this.Ctx.lineTo(x+diamond*units,ay),this.Ctx.stroke(),this.Ctx.textAlign="left";var bodyType=units*7.5;this.Ctx.font=App.Metrics.TxtItalic,this.PrintAtWordWrap(this.Ctx,this.Description,x-this.Size.width*.5+10*units,y+this.Size.height-30*units,bodyType*1.5,this.Size.width-20*units),App.StrokeColor(this.Ctx,App.Palette[1]),this.Ctx.beginPath(),this.Ctx.moveTo(Math.round(x-this.Size.width*.5)+1,y+this.Size.height*.5+20*units),this.Ctx.lineTo(Math.round(x-this.Size.width*.5)+1,y+this.Size.height*1.5-20*units),this.Ctx.moveTo(Math.round(x+this.Size.width*.5)-1,y+this.Size.height*.5+20*units),this.Ctx.lineTo(Math.round(x+this.Size.width*.5)-1,y+this.Size.height*1.5-20*units),this.Ctx.stroke()}App.BlockSprites.DrawSprite(displayContext,new Point(x,y-7.5*units),!1,this.Name.toLowerCase())},MenuItem.prototype.PrintAtWordWrap=function(context,text,x,y,lineHeight,fitWidth){fitWidth=fitWidth||0;if(fitWidth<=0){context.fillText(text,x,y);return}var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),context.fillText(words.slice(0,idx-1).join(" "),x,y+lineHeight*currentLine),currentLine++,words=words.splice(idx-1),idx=1):idx++}idx>0&&context.fillText(words.join(" "),x,y+lineHeight*currentLine)},MenuItem.prototype.MouseDown=function(point){this.MouseIsDown=!0,this.MousePoint=new Point(point.x,point.y)},MenuItem.prototype.MouseMove=function(point,header,cutoff){this.MouseIsDown&&this.InfoOffset==0&&(this.MousePoint=new Point(point.x,point.y),point.y>cutoff&&(header.ClosePanel(),this.MouseIsDown=!1,this._MainScene.CreateBlockFromType(this.ID)))},MenuItem.prototype.MouseUp=function(){this.MouseIsDown=!1},MenuItem}();exports.MenuItem=MenuItem});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Header",["require","exports","../Device","./MenuCategory","./MenuItem"],function(require,exports,Device_1,MenuCategory_1,MenuItem_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,Size=minerva.Size,Header=function(_super){__extends(Header,_super);function Header(){_super.apply(this,arguments),this.MenuItems=[]}return Header.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this._Units=1.7,this.Height=App.Metrics.HeaderHeight,this.Rows=1,this.MenuItems=[],this.ItemsPerPage=App.Metrics.ItemsPerPage,this.DropDownHeight=App.Width/(this.ItemsPerPage+1)/App.Unit,this.DropDown=0,this._SelectedCategory=0,this._MenuCols=App.ThemeManager.MenuOrder,this.Margin=0,this.CreateNewMargin=0,this._LeftOver=!1,this._RightOver=!1,this.MenuOver=!1,this.Tweens=[],this.MenuJson=App.BlockCreator.MenuJson,this.Populate(this.MenuJson)},Header.prototype.Populate=function(json){var units=App.Unit,dataType=units*10,gutter=60,menuCats=[];this.Rows=1,App.Metrics.Device===Device_1.Device.tablet&&(gutter=40,this.Rows=2),App.Metrics.Device===Device_1.Device.mobile&&(this.Rows=2),this.ItemsPerPage=App.Metrics.ItemsPerPage,this.DropDownHeight=this.DrawTo.Width/(this.ItemsPerPage+1)/units;var n=json.categories.length;this.Ctx.font="400 "+dataType+"px Dosis",this.Ctx.textAlign="left";var catWidth=[],menuWidth=0;for(var i=0;i<n;i++)catWidth[i]=this.Ctx.measureText(json.categories[i].name.toUpperCase()).width+gutter*units,menuWidth+=catWidth[i];var catX=this.DrawTo.Width*.5-menuWidth*.5,rowOffset=(this.Rows-1)*this.Height*units;for(var i=0;i<n;i++){var name=json.categories[i].name.toUpperCase(),point=new Point(catX+catWidth[i]*.5,rowOffset),size=new Size(catWidth[i],16);menuCats[i]=new MenuCategory_1.MenuCategory(point,size,name,this.DropDownHeight),catX+=catWidth[i];var itemN=json.categories[i].items.length;menuCats[i].Pages=Math.floor((itemN-1)/this.ItemsPerPage);for(var j=0;j<itemN;j++){var name=json.categories[i].items[j].name.toUpperCase(),id=json.categories[i].items[j].id,description="";json.categories[i].items[j].description&&(description=json.categories[i].items[j].description);var point=new Point(0,(this.Height+this.DropDownHeight*.5)*units+rowOffset),size=new Size(this.DropDownHeight*units,this.DropDownHeight*units);menuCats[i].Items.push(new MenuItem_1.MenuItem(point,size,name,id,description,this.DrawTo))}}this.MenuItems=menuCats,this.DelayTo(this,0,300,0,"DropDown")},Header.prototype.Draw=function(){_super.prototype.Draw.call(this);var units=App.Unit,dataType=units*10,headerType=Math.round(units*28),thisHeight=Math.round(this.Height*units),dropDown=Math.round(this.DropDown*units),rowOffset=(this.Rows-1)*this.Height*units;App.FillColor(this.Ctx,App.Palette[2]),this.Ctx.globalAlpha=.16,this.Ctx.fillRect(0,0,this.DrawTo.Width,thisHeight+5*units+dropDown+rowOffset),this.Ctx.globalAlpha=.9,this.Ctx.fillRect(0,0,this.DrawTo.Width,thisHeight+dropDown+rowOffset),this.Ctx.globalAlpha=1,App.FillColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),this.Ctx.font="200 "+headerType+"px Dosis",this.Rows>1?(this.Ctx.textAlign="center",this.Ctx.fillText("BLOKDUST",App.Width*.5,thisHeight*.5+headerType*.38)):(this.Ctx.textAlign="left",this.Ctx.fillText("BLOKDUST",(20+this.CreateNewMargin)*units,thisHeight*.5+headerType*.38)),App.StrokeColor(this.Ctx,App.Palette[1]),this.Ctx.globalAlpha=1,this.Ctx.lineWidth=1,dropDown>0&&(this.Ctx.beginPath(),this.Ctx.moveTo(20*units,thisHeight+rowOffset),this.Ctx.lineTo(this.DrawTo.Width-20*units,thisHeight+rowOffset),this.Ctx.stroke()),this.Rows>1&&(this.Ctx.beginPath(),this.Ctx.moveTo(20*units,thisHeight),this.Ctx.lineTo(this.DrawTo.Width-20*units,thisHeight),this.Ctx.stroke());var margin=this.DropDownHeight*.5;this.Ctx.beginPath();for(var i=0;i<this.MenuItems.length;i++){var cat=this.MenuItems[i],menuX=cat.Position.x;i>0&&(this.Ctx.moveTo(Math.round(menuX-cat.Size.width*.5),rowOffset+thisHeight*.5-16*units),this.Ctx.lineTo(Math.round(menuX-cat.Size.width*.5),rowOffset+thisHeight*.5+16*units))}this.Ctx.moveTo(Math.round(this.DrawTo.Width-margin*units),thisHeight*.5-16*units),this.Ctx.lineTo(Math.round(this.DrawTo.Width-margin*units),thisHeight*.5+16*units),this.Ctx.stroke(),this.Ctx.textAlign="center",this.Ctx.font="400 "+dataType+"px Dosis";for(var i=0;i<this.MenuItems.length;i++){this.Ctx.globalAlpha=1,cat=this.MenuItems[i];var col=this._MenuCols[i-Math.floor(i/this._MenuCols.length)*this._MenuCols.length];App.FillColor(this.Ctx,App.Palette[col]),cat.Draw(this.Ctx,units,this,rowOffset);if(this.DropDown>0&&cat.YOffset<this.DropDownHeight){var itemN=cat.Items.length;margin=20+this.Margin*.666,this.Ctx.lineWidth=1;var clipHeight=this.DropDown-cat.YOffset;clipHeight<0&&(clipHeight=0),this.Ctx.save(),this.Ctx.beginPath(),this.Ctx.moveTo(Math.floor(margin*units),this.Height*units+rowOffset),this.Ctx.lineTo(Math.ceil(this.DrawTo.Width-margin*units),this.Height*units+rowOffset),this.Ctx.lineTo(Math.ceil(this.DrawTo.Width-margin*units),(this.Height+clipHeight)*units+rowOffset),this.Ctx.lineTo(Math.floor(margin*units),(this.Height+clipHeight)*units+rowOffset),this.Ctx.closePath(),this.Ctx.clip();for(var j=0;j<itemN;j++){var xPos=(margin+this.DropDownHeight*.5+this.DropDownHeight*j+cat.XOffset)*units,yPos=cat.YOffset;cat.Items[j].Position.x=xPos,xPos>0&&xPos<this.DrawTo.Width&&cat.Items[j].Draw(this,units,xPos,yPos)}this.Ctx.restore();for(var j=0;j<itemN;j++)cat.Items[j].MouseIsDown&&cat.Items[j].InfoOffset==0&&(this.Ctx.globalAlpha=.5,App.BlockSprites.DrawSprite(this,cat.Items[j].MousePoint,!1,cat.Items[j].Name.toLowerCase()))}}if(this.DropDown>0){var cat=this.MenuItems[this._SelectedCategory];margin=this.Margin,App.StrokeColor(this.Ctx,App.Palette[1]),this.Ctx.lineWidth=2,this.Ctx.save(),this.Ctx.beginPath(),this.Ctx.moveTo(0,this.Height*units+rowOffset),this.Ctx.lineTo(this.DrawTo.Width,this.Height*units+rowOffset),this.Ctx.lineTo(this.DrawTo.Width,(this.Height+this.DropDown)*units+rowOffset),this.Ctx.lineTo(0,(this.Height+this.DropDown)*units+rowOffset),this.Ctx.closePath(),this.Ctx.clip(),App.StrokeColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),cat.CurrentPage==0&&App.StrokeColor(this.Ctx,App.Palette[1]),this.Ctx.beginPath(),this.Ctx.moveTo(margin*units-20*units,(this.Height+this.DropDown*.5-20)*units+rowOffset),this.Ctx.lineTo(margin*units-40*units,(this.Height+this.DropDown*.5)*units+rowOffset),this.Ctx.lineTo(margin*units-20*units,(this.Height+this.DropDown*.5+20)*units+rowOffset),this.Ctx.stroke(),App.StrokeColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),cat.CurrentPage==cat.Pages&&App.StrokeColor(this.Ctx,App.Palette[1]),this.Ctx.beginPath(),this.Ctx.moveTo(this.DrawTo.Width-margin*units+20*units,(this.Height+this.DropDown*.5-20)*units+rowOffset),this.Ctx.lineTo(this.DrawTo.Width-margin*units+40*units,(this.Height+this.DropDown*.5)*units+rowOffset),this.Ctx.lineTo(this.DrawTo.Width-margin*units+20*units,(this.Height+this.DropDown*.5+20)*units+rowOffset),this.Ctx.stroke(),this.Ctx.restore()}var btnWidth=this.Ctx.measureText("SHARE").width+40*units;App.FillColor(this.Ctx,App.Palette[2]),this.Ctx.globalAlpha=.9;if(this._ShareOver){var shx=this.DrawTo.Width-margin*units-btnWidth*.5;this.Ctx.beginPath(),this.Ctx.moveTo(shx-10*units,this.Height*units),this.Ctx.lineTo(shx,(this.Height+10)*units),this.Ctx.lineTo(shx+10*units,this.Height*units),this.Ctx.closePath(),this.Ctx.fill()}if(this._SettingsOver){var shx=this.DrawTo.Width-margin*units+30*units;this.Ctx.beginPath(),this.Ctx.moveTo(shx-10*units,this.Height*units),this.Ctx.lineTo(shx,(this.Height+10)*units),this.Ctx.lineTo(shx+10*units,this.Height*units),this.Ctx.closePath(),this.Ctx.fill()}this.Ctx.globalAlpha=1,margin=this.DropDownHeight*.5,App.FillColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),this.Ctx.lineWidth=2,this.Ctx.beginPath(),this.Ctx.moveTo(this.DrawTo.Width-margin*units+20*units,(this.Height*.5-1)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units+26.6*units,(this.Height*.5-7)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units+33.2*units,(this.Height*.5-1)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units+40*units,(this.Height*.5-7)*units),this.Ctx.moveTo(this.DrawTo.Width-margin*units+20*units,(this.Height*.5+7)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units+26.6*units,(this.Height*.5+1)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units+33.2*units,(this.Height*.5+7)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units+40*units,(this.Height*.5+1)*units),this.Ctx.moveTo(this.DrawTo.Width-margin*units-btnWidth*.5-5*units,(this.Height*.75-6)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units-btnWidth*.5,(this.Height*.75-1)*units),this.Ctx.lineTo(this.DrawTo.Width-margin*units-btnWidth*.5+5*units,(this.Height*.75-6)*units),this.Ctx.stroke(),this.Ctx.textAlign="right",this.Ctx.fillText("SHARE",this.DrawTo.Width-margin*units-20*units,this.Height*.5*units+dataType*.38),this.Ctx.textAlign="center"},Header.prototype.IsPaginated=function(cat,units){var itemN=cat.Items.length;return itemN>this.ItemsPerPage},Header.prototype.DelayTo=function(panel,destination,t,delay,v){var offsetTween=new window.TWEEN.Tween({x:panel[""+v]});offsetTween.to({x:destination},t),offsetTween.onUpdate(function(){panel[""+v]=this.x}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick),this.Tweens.push(offsetTween)},Header.prototype.StopAllTweens=function(){if(this.Tweens.length){for(var j=0;j<this.Tweens.length;j++)this.Tweens[j].stop();this.Tweens=[]}},Header.prototype.MouseDown=function(point){this.HitTests(point);var units=App.Unit;for(var i=0;i<this.MenuItems.length;i++)if(this.MenuItems[i].Hover&&!(this._SelectedCategory==i&&this.DropDown>0)){this.StopAllTweens(),this.CloseOptions();var cat=this.MenuItems[i];for(var j=0;j<cat.Items.length;j++)cat.Items[j].InfoOffset=0;this.DelayTo(this,this.DropDownHeight,500,0,"DropDown"),this.DelayTo(cat,1,400,0,"Selected"),this.DelayTo(cat,0,600,250,"YOffset"),this.IsPaginated(cat,units)?this.DelayTo(this,this.DropDownHeight*.5,600,50,"Margin"):this.DelayTo(this,0,600,50,"Margin"),this._SelectedCategory=i;for(var j=0;j<this.MenuItems.length;j++)if(j!==i){var cat=this.MenuItems[j];this.DelayTo(cat,0,250,0,"Selected"),this.DelayTo(cat,this.DropDownHeight,250,0,"YOffset")}}if(this.DropDown>0&&!this._LeftOver&&!this._RightOver){var cat=this.MenuItems[this._SelectedCategory];for(var i=0;i<cat.Items.length;i++){var item=cat.Items[i];if(item.InfoOffset==0)if(item.InfoHover){this.DelayTo(item,this.DropDownHeight,350,0,"InfoOffset");for(var j=0;j<cat.Items.length;j++)i!==j&&this.DelayTo(cat.Items[j],0,350,0,"InfoOffset")}else cat.Items[i].Hover&&item.MouseDown(point);else cat.Items[i].BackHover&&this.DelayTo(item,0,350,0,"InfoOffset")}}if(this._LeftOver){var cat=this.MenuItems[this._SelectedCategory];cat.CurrentPage>0&&(cat.CurrentPage-=1,this.DelayTo(cat,-(this.ItemsPerPage*cat.CurrentPage*this.DropDownHeight),500,0,"XOffset"))}if(this._RightOver){var cat=this.MenuItems[this._SelectedCategory];cat.CurrentPage<cat.Pages&&(cat.CurrentPage+=1,this.DelayTo(cat,-(this.ItemsPerPage*cat.CurrentPage*this.DropDownHeight),500,0,"XOffset"))}this._ShareOver&&(this.CloseOptions(),App.MainScene.SharePanel.OpenPanel()),this._SettingsOver&&(this.CloseOptions(),App.MainScene.SettingsPanel.OpenPanel()),!this.MenuOver&&this.DropDown>0&&this.ClosePanel()},Header.prototype.ClosePanel=function(){this.StopAllTweens(),this.DelayTo(this,0,300,0,"DropDown"),this.DelayTo(this,0,600,50,"Margin");for(var i=0;i<this.MenuItems.length;i++)this.DelayTo(this.MenuItems[i],0,250,0,"Selected"),this.DelayTo(this.MenuItems[i],this.DropDownHeight,250,0,"YOffset")},Header.prototype.CloseOptions=function(){App.MainScene.OptionsPanel.Scale>0&&App.MainScene.OptionsPanel.Close()},Header.prototype.MouseMove=function(point){this.HitTests(point)},Header.prototype.HitTests=function(point){var units=App.Unit,grd=App.GridSize,rowOffset=(this.Rows-1)*this.Height*units;for(var i=0;i<this.MenuItems.length;i++){var cat=this.MenuItems[i];cat.Hover=Dimensions.hitRect(cat.Position.x-cat.Size.width*.5+2*units,rowOffset+5*units,cat.Size.width-4*units,this.Height*units-10*units,point.x,point.y);if(this._SelectedCategory==i)for(var j=0;j<cat.Items.length;j++){var item=cat.Items[j];item.Hover=Dimensions.hitRect(item.Position.x-2*grd,item.Position.y-2*grd,4*grd,4*grd,point.x,point.y),item.InfoHover=Dimensions.hitRect(item.Position.x-52*units,item.Position.y-42*units,24*units,24*units,point.x,point.y),item.BackHover=Dimensions.hitRect(item.Position.x-this.DropDownHeight*.5*units,item.Position.y-this.DropDownHeight*.5*units,this.DropDownHeight*units,this.DropDownHeight*units,point.x,point.y),item.MouseMove(point,this,(this.Height+this.DropDown-20)*units)}}this._LeftOver=Dimensions.hitRect(0,(this.Height+20)*units+rowOffset,this.Margin*units,(this.DropDown-40)*units,point.x,point.y),this._RightOver=Dimensions.hitRect(this.DrawTo.Width-this.Margin*units,(this.Height+20)*units+rowOffset,this.Margin*units,(this.DropDown-40)*units,point.x,point.y),this.Ctx.font="400 "+units*10+"px Dosis";var btnWidth=this.Ctx.measureText("SHARE").width+40*units;this._ShareOver=Dimensions.hitRect(this.DrawTo.Width-this.DropDownHeight*.5*units-btnWidth,5*units,btnWidth,this.Height*units-10*units,point.x,point.y),this._SettingsOver=Dimensions.hitRect(this.DrawTo.Width-this.DropDownHeight*.5*units,5*units,this.DropDownHeight*.5*units,this.Height*units-10*units,point.x,point.y),this.MenuOver=point.y<(this.Height+this.DropDown)*units+rowOffset},Header.prototype.MouseUp=function(){var cat=this.MenuItems[this._SelectedCategory];for(var i=0;i<cat.Items.length;i++)cat.Items[i].MouseUp()},Header}(DisplayObject);exports.Header=Header});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/Laser",["require","exports","./PowerSource"],function(require,exports,PowerSource_1){var Point=etch.primitives.Point,Laser=function(_super){__extends(Laser,_super);function Laser(){_super.apply(this,arguments)}return Laser.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Power.Blocks.Laser.name,this.Defaults={angle:-90,range:275,rotate:0,selfPoweredMode:!1},this.PopulateParams(),this.UpdateCollision=!0,this.Collisions=[],this.CheckRange=this.Params.range,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(1,-1),new Point(1,0),new Point(0,1),new Point(-1,0))},Laser.prototype.UpdateConnections=function(){this.UpdateCollision=!0},Laser.prototype.Update=function(){_super.prototype.Update.call(this),this.IsPowered()&&Math.round(this.Params.rotate)!==0&&(this.UpdateCollision=!0,this.Params.angle+=this.Params.rotate/100,this.Params.angle>90&&(this.Params.angle-=360),this.Params.angle<-270&&(this.Params.angle+=360))},Laser.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Laser.prototype.AddPower=function(){_super.prototype.AddPower.call(this),this.UpdateCollision=!0},Laser.prototype.RemovePower=function(){_super.prototype.RemovePower.call(this),this.UpdateCollision=!0},Laser.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Laser",updateeveryframe:!0,parameters:[{type:"slider",name:"Angle",setting:"angle",props:{value:this.Params.angle+90,min:-180,max:180,quantised:!0,centered:!0}},{type:"slider",name:"Rotate",setting:"rotate",props:{value:this.Params.rotate,min:-500,max:500,quantised:!0,centered:!0,snap:!0}},{type:"slider",name:"Range",setting:"range",props:{value:this.Params.range,min:50,max:1200,quantised:!0,centered:!1}}]}},Laser.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="angle"&&(val=value-90);if(param=="angle"||param=="range")this.UpdateCollision=!0;this.Params[""+param]=val,this.CheckRange=this.Params.range},Laser}(PowerSource_1.PowerSource);exports.Laser=Laser});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/Logic/Logic",["require","exports","./../PowerEffect"],function(require,exports,PowerEffect_1){var Logic=function(_super){__extends(Logic,_super);function Logic(){_super.apply(this,arguments),this.ScheduledLogic=!1}return Logic.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo)},Logic.prototype.Update=function(){_super.prototype.Update.call(this),this.ScheduledLogic&&(this.ScheduledLogic=!1,this.PerformLogic())},Logic.prototype.ParticleCollision=function(particle){this.PerformLogic(),particle.Dispose()},Logic.prototype.PerformLogic=function(){},Logic.prototype.ScheduleLogic=function(){this.ScheduledLogic=!0},Logic}(PowerEffect_1.PowerEffect);exports.Logic=Logic});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/Void",["require","exports","../Block"],function(require,exports,Block_1){var Point=etch.primitives.Point,Void=function(_super){__extends(Void,_super);function Void(){_super.apply(this,arguments)}return Void.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.BlockName=App.L10n.Blocks.Power.Blocks.Void.name,this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,0),new Point(0,1)),this.StarPos=this.RandomStarPos()},Void.prototype.RandomStarPos=function(){var x=Math.round(Math.random()*10),y=Math.round(Math.random()*(10-x)),dice=Math.floor(Math.random()*2);return dice==0&&(x=-x),dice=Math.floor(Math.random()*2),dice==0&&(y=-y),new Point(x,y)},Void.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName,this.StarPos)},Void.prototype.Dispose=function(){_super.prototype.Dispose.call(this)},Void}(Block_1.Block);exports.Void=Void});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("LaserBeams",["require","exports","./Blocks/Power/Laser","./Blocks/Power/Logic/Logic","./Blocks/Source","./Blocks/Power/Void"],function(require,exports,Laser_1,Logic_1,Source_1,Void_1){var Vector=Utils.Maths.Vector,DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,LaserBeams=function(_super){__extends(LaserBeams,_super);function LaserBeams(){_super.apply(this,arguments)}return LaserBeams.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.UpdateAllLasers=!1},LaserBeams.prototype.Update=function(){this.UpdateCollisions()},LaserBeams.prototype.QuadPartition=function(p1,p2,angle){var margin=App.ScaledGridSize*1.7,laser=p1,target=p2;return angle<0&&angle>-180&&target.y>laser.y+margin?!1:(angle>0||angle<-180)&&target.y<laser.y-margin?!1:angle<=-90&&target.x>laser.x+margin?!1:angle>-90&&target.x<laser.x-margin?!1:!0},LaserBeams.prototype.PointFromLine=function(x,y,x0,y0,x1,y1,o){function lineLength(x,y,x0,y0){return Math.sqrt((x-=x0)*x+(y-=y0)*y)}if(o&&!(o=function(x,y,x0,y0,x1,y1){if(!(x1-x0))return{x:x0,y:y};if(!(y1-y0))return{x:x,y:y0};var left,tg=-1/((y1-y0)/(x1-x0));return{x:left=(x1*(x*tg-y+y0)+x0*(x*-tg+y-y1))/(tg*(x1-x0)+y0-y1),y:tg*left-tg*x+y}}(x,y,x0,y0,x1,y1),o.x>=Math.min(x0,x1)&&o.x<=Math.max(x0,x1)&&o.y>=Math.min(y0,y1)&&o.y<=Math.max(y0,y1))){var l1=lineLength(x,y,x0,y0),l2=lineLength(x,y,x1,y1);return l1>l2?l2:l1}var a=y0-y1,b=x1-x0,c=x0*y1-y0*x1;return Math.abs(a*x+b*y+c)/Math.sqrt(a*a+b*b)},LaserBeams.prototype.PointFromPoint=function(x,y,x0,y0){return Math.sqrt((x-=x0)*x+(y-=y0)*y)},LaserBeams.prototype.UpdateCollisions=function(){if(App.Audio.ConnectionManager.IsConnected){var p1,p2,vector,line,outline,rectSize=1.7,grd=App.ScaledGridSize*rectSize,voidlist=[],sourcelist=[],laserlist=[],checklist=[];for(var i=0;i<App.Blocks.length;i++){var block=App.Blocks[i];block instanceof Void_1.Void&&voidlist.push(block),(block instanceof Source_1.Source||block instanceof Logic_1.Logic)&&sourcelist.push(block),block instanceof Laser_1.Laser&&laserlist.push(block),checklist=voidlist.concat(sourcelist)}for(var i=0;i<laserlist.length;i++){var laser=laserlist[i];this.UpdateAllLasers&&(laser.UpdateCollision=!0);if(laser.UpdateCollision){laser.UpdateCollision=!1,laser.CheckRange=laser.Params.range;var collisions=[];if(laser.Params.selfPoweredMode||laser.IsPowered()){vector=Vector.multN(Vector.fromAngle(Math.degreesToRadians(laser.Params.angle)),App.ScaledUnit),line=Vector.multN(vector,laser.CheckRange);for(var j=0;j<checklist.length;j++){var block=checklist[j];if(block!==laser){outline=[],p1=App.Metrics.UndraggedPointOnGrid(laser.Position),p2=App.Metrics.UndraggedPointOnGrid(block.Position);if(this.PointFromPoint(p1.x,p1.y,p2.x,p2.y)<laser.CheckRange*App.ScaledUnit+grd&&this.QuadPartition(p1,p2,laser.Params.angle)&&this.PointFromLine(p2.x,p2.y,p1.x,p1.y,p1.x+line.X,p1.y+line.Y,!1)<grd){for(var k=0;k<block.Outline.length;k++)outline.push(App.Metrics.UndraggedPointOnGrid(App.Metrics.GetRelativePoint(block.Outline[k],block.Position)));p2=new Point(p1.x+line.X,p1.y+line.Y);var intersection=Intersection.intersectLinePolygon(p1,p2,outline);if(intersection.status=="Intersection")if(block instanceof Void_1.Void){var intersect=intersection.points;for(var h=0;h<intersect.length;h++){var dist=this.PointFromPoint(p1.x,p1.y,intersect[h].x,intersect[h].y)/App.ScaledUnit;dist<laser.CheckRange&&(laser.CheckRange=dist)}}else{collisions.push(block);if(laser.Collisions.length==0||$.inArray(block,laser.Collisions)==-1)block instanceof Logic_1.Logic?block.ScheduleLogic():(block.AddPower(),this.DrawTo.ConnectionLines.UpdateList())}}}}}if(laser.Collisions&&laser.Collisions.length)for(var j=0;j<laser.Collisions.length;j++){var block=laser.Collisions[j];if(collisions.length==0||$.inArray(block,collisions)==-1)block instanceof Logic_1.Logic||(block.RemovePower(),this.DrawTo.ConnectionLines.UpdateList())}laser.Collisions=collisions}}this.UpdateAllLasers=!1}},LaserBeams.prototype.Draw=function(){var unit=App.ScaledUnit,myPos,vector;App.StrokeColor(this.Ctx,App.Palette[App.ThemeManager.Power]),this.Ctx.globalAlpha=1,this.Ctx.lineWidth=unit*2*(.8+Math.random()*.5),this.Ctx.beginPath();for(var j=0;j<App.Sources.length;j++){var laser=App.Sources[j];laser instanceof Laser_1.Laser&&(laser.Params.selfPoweredMode||laser.IsPowered())&&(myPos=App.Metrics.PointOnGrid(laser.Position),vector=Vector.fromAngle(Math.degreesToRadians(laser.Params.angle)),vector.mult(laser.CheckRange*unit),this.Ctx.moveTo(myPos.x,myPos.y),this.Ctx.lineTo(myPos.x+vector.X,myPos.y+vector.Y))}this.Ctx.stroke(),this.Ctx.lineWidth=1},LaserBeams}(DisplayObject);exports.LaserBeams=LaserBeams});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/MessagePanel",["require","exports"],function(require,exports){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,MessagePanel=function(_super){__extends(MessagePanel,_super);function MessagePanel(){_super.apply(this,arguments)}return MessagePanel.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this._Roll=[],this.Hover=!1,this.Open=!1,this._CloseX=0,this._Lines=0,this._Defaults={string:"Message Text Missing...",seconds:3,confirmation:!1,buttonText:"",buttonEvent:this.DefaultFunction},this._Value={string:this._Defaults.string,seconds:this._Defaults.seconds,confirmation:this._Defaults.confirmation,buttonText:this._Defaults.buttonText,buttonEvent:this._Defaults.buttonEvent}},MessagePanel.prototype.Draw=function(){var units=App.Unit,ctx=this.Ctx,midType=App.Metrics.TxtMid,y=this.DrawTo.Height*.75,cx=this.DrawTo.Width*.5,w=this.DrawTo.Width;if(this._Alpha>0){ctx.textAlign="center",ctx.font=midType;var clx=this._CloseX;App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=this._Alpha*.16,ctx.fillRect(0,y-25*units,w,60*units+this._Lines*16*units),ctx.globalAlpha=this._Alpha*.9,ctx.fillRect(0,y-30*units,w,60*units+this._Lines*16*units),ctx.globalAlpha=this._Alpha,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),this.WordWrap(ctx,this._Value.string.toUpperCase(),cx,y+5*units,16*units,w-30*units),this._Value.confirmation&&(App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=this._Alpha*.9,ctx.beginPath(),ctx.moveTo(clx-20*units,y-30*units),ctx.lineTo(clx+20*units,y-30*units),ctx.lineTo(clx,y-50*units),ctx.closePath(),ctx.fill(),ctx.globalAlpha=this._Alpha,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(clx-4*units,y-34*units),ctx.lineTo(clx+4*units,y-26*units),ctx.moveTo(clx-4*units,y-26*units),ctx.lineTo(clx+4*units,y-34*units),ctx.stroke(),ctx.lineWidth=1),this._Value.buttonText!==""&&(App.FillColor(ctx,App.Palette[4]),ctx.fillRect(clx,y-15*units,this._ButtonWidth,30*units),this._Roll[1]&&(ctx.beginPath(),ctx.moveTo(clx+this._ButtonWidth*.5-10*units,y+15*units-1),ctx.lineTo(clx+this._ButtonWidth*.5+10*units,y+15*units-1),ctx.lineTo(clx+this._ButtonWidth*.5,y+25*units-1),ctx.closePath(),ctx.fill()),ctx.textAlign="left",App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillText(this._Value.buttonText.toUpperCase(),clx+10*units,y+5*units))}},MessagePanel.prototype.WordWrap=function(context,text,x,y,lineHeight,fitWidth){fitWidth=fitWidth||0;if(fitWidth<=0){context.fillText(text,x,y);return}var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),context.fillText(words.slice(0,idx-1).join(" "),x,y+lineHeight*currentLine),currentLine++,words=words.splice(idx-1),idx=1):idx++}idx>0&&context.fillText(words.join(" "),x,y+lineHeight*currentLine)},MessagePanel.prototype.LineCount=function(context,text,fitWidth){fitWidth=fitWidth||0,this._Lines=0;if(fitWidth<=0)return;var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),this._Lines+=1,currentLine++,words=words.splice(idx-1),idx=1):idx++}},MessagePanel.prototype.NewMessage=function(string,options){options=options||{},this._Value.string=string||this._Defaults.string,this._Value.seconds=options.seconds||this._Defaults.seconds,this._Value.confirmation=options.confirmation||this._Defaults.confirmation,this._Value.buttonText=options.buttonText||this._Defaults.buttonText,this._Value.buttonEvent=options.buttonEvent||this._Defaults.buttonEvent,this._Value.buttonText!==""&&(this._Value.confirmation=!0);var units=App.Unit,ctx=this.Ctx;ctx.font=App.Metrics.TxtMid,this.LineCount(ctx,this._Value.string.toUpperCase(),App.Width-30*units);if(this._Value.confirmation){var cx=this.DrawTo.Width*.5;this._CloseX=cx+20*units+ctx.measureText(this._Value.string.toUpperCase()).width*.5,this._ButtonWidth=20*units+ctx.measureText(this._Value.buttonText.toUpperCase()).width}this.Open||(this.Tween(this,"_Alpha",1,0,400),this.Open=!0),clearTimeout(this._Timeout);var message=this;this._Timeout=setTimeout(function(){message._Value.confirmation||message.Close()},this._Value.seconds*1e3)},MessagePanel.prototype.Close=function(){this.Tween(this,"_Alpha",0,0,1e3),this.Hover=!1,this.Open=!1},MessagePanel.prototype.DefaultFunction=function(){},MessagePanel.prototype.Tween=function(panel,value,destination,delay,time){var pTween=new window.TWEEN.Tween({x:panel[""+value]});pTween.to({x:destination},time),pTween.onUpdate(function(){panel[""+value]=this.x}),pTween.delay(delay),pTween.start(this.LastVisualTick),pTween.easing(window.TWEEN.Easing.Quintic.InOut)},MessagePanel.prototype.MouseDown=function(point){this.RolloverCheck(point),this.Open&&this._Roll[0]&&this.Close(),this.Open&&this._Roll[1]&&(this._Value.buttonEvent(),this.Close())},MessagePanel.prototype.MouseMove=function(point){this.RolloverCheck(point)},MessagePanel.prototype.RolloverCheck=function(point){this.Hover=!1;var units=App.Unit;this._Value.confirmation?this._Roll[0]=Dimensions.hitRect(this._CloseX-20*units,this.DrawTo.Height*.75-50*units,40*units,40*units,point.x,point.y):this._Roll[0]=!1,this._Value.buttonText!==""?this._Roll[1]=Dimensions.hitRect(this._CloseX,this.DrawTo.Height*.75-15*units,this._ButtonWidth,30*units,point.x,point.y):this._Roll[1]=!1;if(this._Roll[0]||this._Roll[1])this.Hover=!0},MessagePanel}(DisplayObject);exports.MessagePanel=MessagePanel}),define("UI/Options/Option",["require","exports"],function(require,exports){var Point=etch.primitives.Point,Option=function(){function Option(){}return Option.prototype.Draw=function(ctx,units,i,panel,yoveride){},Option.prototype.PlotGraph=function(){},Option.prototype.MonitorReset=function(){},Option.prototype.Refresh=function(i,json){},Option.prototype.DiagonalFill=function(ctx,x,y,w,h,s){var pr=App.Metrics.PixelRatio;s*=pr;var lineNo=Math.round((w+h)/s),pos1=new Point(0,0),pos2=new Point(0,0);ctx.beginPath();for(var j=0;j<lineNo;j++)pos1.x=s*.5+s*j,pos1.y=0,pos2.x=pos1.x-h,pos2.y=h,pos2.x<0&&(pos2.y=h+pos2.x,pos2.x=0),pos1.x>w&&(pos1.y=pos1.x-w,pos1.x=w),ctx.moveTo(x+pos1.x,y+pos1.y),ctx.lineTo(x+pos2.x,y+pos2.y);ctx.stroke()},Option}();exports.Option=Option});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionADSR",["require","exports","./Option"],function(require,exports,Option_1){var OptionADSR=function(_super){__extends(OptionADSR,_super);function OptionADSR(position,size,name,handle0,handle1,handle2){_super.call(this),this.Type="ADSR",this.Position=position,this.Size=size,this.Name=name,this.Handles=[],this._Node=[],this.EValue=[],this.EMin=[],this.EMax=[],this.EPerc=[],this.HandleRoll=[],this.Handles[0]=handle0,this.Handles[1]=handle1,this.Handles[2]=handle2}return OptionADSR.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel);var a=this.Handles[0].Position.x,d=this.Handles[1].Position.x,s=this.Handles[1].Position.y,r=this.Handles[2].Position.x,y=this.Position.y,height=this.Size.height;ctx.globalAlpha=1;var vert=.6;App.StrokeColor(ctx,App.Palette[1]),ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height*.1),ctx.lineTo(panel.Margin-units,y+height*.9),ctx.moveTo(panel.Range*vert+panel.Margin+units,y+height*.1),ctx.lineTo(panel.Range*vert+panel.Margin+units,y+height*.9),ctx.moveTo(panel.Range+panel.Margin+units,y+height*.1),ctx.lineTo(panel.Range+panel.Margin+units,y+height*.9),ctx.stroke(),ctx.save(),ctx.beginPath(),ctx.moveTo(panel.Margin,y+height*.9),ctx.lineTo(panel.Margin+a,y+height*.1),ctx.lineTo(panel.Margin+a+d,y+height*.9-s),ctx.lineTo(panel.Margin+panel.Range*vert,y+height*.9-s),ctx.lineTo(panel.Margin+panel.Range*vert+r,y+height*.9),ctx.lineTo(panel.Range+panel.Margin+units,y+height*.9),ctx.closePath(),ctx.clip(),panel.diagonalFill(panel.Margin-units,y+units,panel.Range+2*units,height-2*units,9),ctx.restore(),ctx.lineWidth=2,ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(panel.Margin,y+height*.9),ctx.lineTo(panel.Margin+a,y+height*.1),ctx.lineTo(panel.Margin+a+d,y+height*.9-s),ctx.lineTo(panel.Margin+panel.Range*vert,y+height*.9-s),ctx.lineTo(panel.Margin+panel.Range*vert+r,y+height*.9),ctx.lineTo(panel.Range+panel.Margin+units,y+height*.9),ctx.stroke(),ctx.lineWidth=1;var dragWidth=height*.06;App.FillColor(ctx,App.Palette[3]),ctx.beginPath(),ctx.moveTo(a+panel.Margin-dragWidth,y+height*.1),ctx.lineTo(a+panel.Margin,y+height*.1-dragWidth),ctx.lineTo(a+panel.Margin+dragWidth,y+height*.1),ctx.lineTo(a+panel.Margin,y+height*.1+dragWidth),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[4]),ctx.beginPath(),ctx.moveTo(a+d+panel.Margin-dragWidth,y+height*.9-s),ctx.lineTo(a+d+panel.Margin,y+height*.9-dragWidth-s),ctx.lineTo(a+d+panel.Margin+dragWidth,y+height*.9-s),ctx.lineTo(a+d+panel.Margin,y+height*.9+dragWidth-s),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[5]),ctx.beginPath(),ctx.moveTo(panel.Range*vert+r+panel.Margin-dragWidth,y+height*.9),ctx.lineTo(panel.Range*vert+r+panel.Margin,y+height*.9-dragWidth),ctx.lineTo(panel.Range*vert+r+panel.Margin+dragWidth,y+height*.9),ctx.lineTo(panel.Range*vert+r+panel.Margin,y+height*.9+dragWidth),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[8]),ctx.beginPath(),ctx.moveTo(a+panel.Margin-dragWidth,y+height*.1),ctx.lineTo(a+panel.Margin,y+height*.1-dragWidth),ctx.lineTo(a+panel.Margin+dragWidth*.5,y+height*.1-dragWidth*.5),ctx.lineTo(a+panel.Margin-dragWidth*.5,y+height*.1+dragWidth*.5),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(a+d+panel.Margin-dragWidth,y+height*.9-s),ctx.lineTo(a+d+panel.Margin,y+height*.9-dragWidth-s),ctx.lineTo(a+d+panel.Margin+dragWidth*.5,y+height*.9-s-dragWidth*.5),ctx.lineTo(a+d+panel.Margin-dragWidth*.5,y+height*.9-s+dragWidth*.5),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(panel.Range*vert+r+panel.Margin-dragWidth,y+height*.9),ctx.lineTo(panel.Range*vert+r+panel.Margin,y+height*.9-dragWidth),ctx.lineTo(panel.Range*vert+r+panel.Margin+dragWidth*.5,y+height*.9-dragWidth*.5),ctx.lineTo(panel.Range*vert+r+panel.Margin-dragWidth*.5,y+height*.9+dragWidth*.5),ctx.closePath(),ctx.fill()},OptionADSR}(Option_1.Option);exports.OptionADSR=OptionADSR});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionButtonArray",["require","exports","./Option"],function(require,exports,Option_1){var ButtonArray=function(_super){__extends(ButtonArray,_super);function ButtonArray(position,size,name,setting,buttons,mode){_super.call(this),this.Type="buttons",this.Position=position,this.Size=size,this.Name=name,this.Setting=setting,this.Buttons=buttons,this.ButtonMode=mode,this.HandleRoll=[]}return ButtonArray.prototype.Draw=function(ctx,units,i,panel){var x=this.Position.x,y=this.Position.y,height=this.Size.height,midType=Math.round(units*10);App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke());for(var j=0;j<this.Buttons.length;j++){if(j>0){App.StrokeColor(ctx,App.Palette[1]);var bx=panel.Margin+this.Buttons[j].Position.x;ctx.beginPath(),ctx.moveTo(Math.round(x+bx),y+height*.15),ctx.lineTo(Math.round(x+bx),y+height*.85),ctx.closePath(),ctx.stroke()}this.Buttons[j].Draw(ctx,panel,units,panel.Margin,height,i,this.ButtonMode)}App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+midType*.4)},ButtonArray}(Option_1.Option);exports.ButtonArray=ButtonArray});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionActionButton",["require","exports","./Option"],function(require,exports,Option_1){var OptionActionButton=function(_super){__extends(OptionActionButton,_super);function OptionActionButton(position,size,name,text,setting){_super.call(this),this.Type="actionbutton",this.Position=position,this.Size=size,this.Name=name,this._Text=text,this.Setting=setting,this.HandleRoll=[]}return OptionActionButton.prototype.Draw=function(ctx,units,i,panel,yoveride){_super.prototype.Draw.call(this,ctx,units,i,panel);var x=this.Position.x,y=this.Position.y;yoveride&&(y=yoveride);var height=this.Size.height,origin=this.Origin,dataType=Math.round(units*10),headerType=Math.round(units*33);ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke()),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+dataType*.4),ctx.textAlign="center";var txtWidth=ctx.measureText(this._Text.toUpperCase()).width,boxWidth=txtWidth*.5+15*units;ctx.fillText(this._Text.toUpperCase(),panel.Margin+panel.Range*.5,y+height*.5+dataType*.4),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(panel.Margin+panel.Range*.5-boxWidth,y+height*.25),ctx.lineTo(panel.Margin+panel.Range*.5-boxWidth,y+height*.75),ctx.lineTo(panel.Margin+panel.Range*.5+boxWidth,y+height*.75),ctx.lineTo(panel.Margin+panel.Range*.5+boxWidth,y+height*.25),ctx.closePath(),ctx.stroke()},OptionActionButton}(Option_1.Option);exports.OptionActionButton=OptionActionButton}),define("UI/Options/OptionButton",["require","exports"],function(require,exports){var OptionButton=function(){function OptionButton(position,name,selected,value,size){this.Position=position,this.Name=name,this.Value=value,this.Selected=selected,this.Size=size}return OptionButton.prototype.Draw=function(ctx,panel,units,x,h,i,mode){x+=this.Position.x;var y=this.Position.y,w=this.Size.width;ctx.lineWidth=2,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]);var col=panel.SliderColours[i-Math.floor(i/panel.SliderColours.length)*panel.SliderColours.length];App.FillColor(ctx,col),this.Selected?ctx.fillRect(x+w*.4,y+h*.8,w*.2,h*.05):this.Value>0,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]);if(mode=="string")ctx.font=App.Metrics.TxtMid,ctx.textAlign="center",ctx.fillText(this.Name.toUpperCase(),x+w*.5,y+h*.5+units*4);else if(mode=="wave"){var cx=x+w*.5,cy=y+h*.5;ctx.beginPath();switch(this.Value){case 0:ctx.moveTo(cx-10*units,cy-5*units),ctx.bezierCurveTo(cx+2.5*units,cy-5*units,cx-2.5*units,cy+5*units,cx+10*units,cy+5*units);break;case 1:ctx.moveTo(cx-10*units,cy-5*units),ctx.lineTo(cx,cy-5*units),ctx.lineTo(cx,cy+5*units),ctx.lineTo(cx+10*units,cy+5*units);break;case 2:ctx.moveTo(cx-15*units,cy+5*units),ctx.lineTo(cx-5*units,cy-5*units),ctx.lineTo(cx+5*units,cy+5*units),ctx.lineTo(cx+15*units,cy-5*units);break;case 3:ctx.moveTo(cx-10*units,cy+5*units),ctx.lineTo(cx,cy-5*units),ctx.lineTo(cx,cy+5*units),ctx.lineTo(cx+10*units,cy-5*units),ctx.lineTo(cx+10*units,cy+5*units)}ctx.stroke()}ctx.lineWidth=1},OptionButton}();exports.OptionButton=OptionButton}),define("UI/Options/OptionHandle",["require","exports"],function(require,exports){var OptionHandle=function(){function OptionHandle(position,xval,xmin,xmax,xrange,yval,ymin,ymax,yrange,xsetting,ysetting){this.Position=position,this.XValue=xval,this.XMin=xmin,this.XMax=xmax,this.XRange=xrange,this.XSetting=xsetting,this.YValue=yval,this.YMin=ymin,this.YMax=ymax,this.YRange=yrange,this.YSetting=ysetting||"",this.Log=!1,this.XLog=!1,this.YLog=!1,this.Selected=!1}return OptionHandle.prototype.Draw=function(ctx,x,y,size,col){App.FillColor(ctx,col),ctx.beginPath(),ctx.moveTo(x-size,y),ctx.lineTo(x,y-size),ctx.lineTo(x+size,y),ctx.lineTo(x,y+size),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[8]),ctx.beginPath(),ctx.moveTo(x-size,y),ctx.lineTo(x,y-size),ctx.lineTo(x+size*.5,y-size*.5),ctx.lineTo(x-size*.5,y+size*.5),ctx.closePath(),ctx.fill()},OptionHandle}();exports.OptionHandle=OptionHandle});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionSample",["require","exports","./Option"],function(require,exports,Option_1){var OptionSample=function(_super){__extends(OptionSample,_super);function OptionSample(position,size,name,track,user,permalink,setting){_super.call(this),this.Type="sample",this.Position=position,this.Size=size,this.Name=name,this.Track=track,this.User=user,this.Permalink=permalink,this.Setting=setting,this.HandleRoll=[],this.Permalink||(this.Permalink="")}return OptionSample.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel);var x=this.Position.x,y=this.Position.y,height=this.Size.height,origin=this.Origin,dataType=Math.round(units*10),headerType=Math.round(units*33);ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke()),ctx.beginPath(),ctx.moveTo(panel.Margin+panel.Range*.5,y+height*.2),ctx.lineTo(panel.Margin+panel.Range*.5,y+height*.8),ctx.moveTo(panel.Margin+panel.Range*.65,y+height*.2),ctx.lineTo(panel.Margin+panel.Range*.65,y+height*.8),ctx.stroke(),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+dataType*.4),this.Permalink===""?App.StrokeColor(ctx,App.Palette[1]):App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.textAlign="center";var ix=panel.Margin+panel.Range*.575,iy=y+height*.5,diamond=7;ctx.beginPath(),ctx.moveTo(ix+diamond*.5*units,iy-diamond*units),ctx.lineTo(ix-diamond*units,iy-diamond*units),ctx.lineTo(ix-diamond*units,iy+diamond*units),ctx.lineTo(ix+diamond*.5*units,iy+diamond*units),ctx.moveTo(ix-diamond*.5*units,iy),ctx.lineTo(ix+diamond*units,iy),ctx.moveTo(ix+diamond*.5*units,iy-diamond*.5*units),ctx.lineTo(ix+diamond*units,iy),ctx.lineTo(ix+diamond*.5*units,iy+diamond*.5*units),ctx.stroke(),ctx.font=App.Metrics.TxtItalic,ctx.textAlign="left",ctx.fillText(this.Track,panel.Margin,y+height*.5-2*units),ctx.fillText("By "+this.User,panel.Margin,y+height*.5+dataType-2*units),ctx.textAlign="center",App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(panel.Margin+panel.Range*.65,y+height*.25),ctx.lineTo(panel.Margin+panel.Range*.65,y+height*.75),ctx.lineTo(panel.Margin+panel.Range,y+height*.75),ctx.lineTo(panel.Margin+panel.Range,y+height*.25),ctx.closePath(),ctx.stroke(),ctx.font=App.Metrics.TxtMid,ctx.fillText("LOAD NEW SAMPLE",panel.Margin+panel.Range*.82,y+height*.5+dataType*.35),ctx.lineWidth=1},OptionSample}(Option_1.Option);exports.OptionSample=OptionSample});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionSampleLocal",["require","exports","./Option"],function(require,exports,Option_1){var OptionSampleLocal=function(_super){__extends(OptionSampleLocal,_super);function OptionSampleLocal(position,size,name,track,setting){_super.call(this),this.Type="samplelocal",this.Position=position,this.Size=size,this.Name=name,this.Track=track,this.Setting=setting,this.HandleRoll=[],this.Permalink||(this.Permalink="")}return OptionSampleLocal.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel);var x=this.Position.x,y=this.Position.y,height=this.Size.height,origin=this.Origin,dataType=Math.round(units*10),headerType=Math.round(units*33);ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke()),ctx.beginPath(),ctx.moveTo(panel.Margin+panel.Range*.65,y+height*.2),ctx.lineTo(panel.Margin+panel.Range*.65,y+height*.8),ctx.stroke(),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+dataType*.4),ctx.lineWidth=2,ctx.textAlign="center";var ix=panel.Margin+panel.Range*.575,iy=y+height*.5,diamond=7;ctx.font=App.Metrics.TxtItalic,ctx.textAlign="left",ctx.fillText(this.Track,panel.Margin,y+height*.5+dataType*.35),ctx.textAlign="center",App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(panel.Margin+panel.Range*.65,y+height*.25),ctx.lineTo(panel.Margin+panel.Range*.65,y+height*.75),ctx.lineTo(panel.Margin+panel.Range,y+height*.75),ctx.lineTo(panel.Margin+panel.Range,y+height*.25),ctx.closePath(),ctx.stroke(),ctx.font=App.Metrics.TxtMid,ctx.fillText("UPLOAD SAMPLE",panel.Margin+panel.Range*.82,y+height*.5+dataType*.35),ctx.lineWidth=1},OptionSampleLocal}(Option_1.Option);exports.OptionSampleLocal=OptionSampleLocal}),define("UI/Options/OptionSubHandle",["require","exports"],function(require,exports){var OptionSubHandle=function(){function OptionSubHandle(position,val,min,max,rangemin,rangemax,setting){this.Position=position,this.Value=val,this.Min=min,this.Max=max,this.RangeMin=rangemin,this.RangeMax=rangemax,this.Setting=setting}return OptionSubHandle.prototype.SetVal=function(pos){var scale=(this.Max-this.Min)/(this.RangeMax-this.RangeMin);return(pos-this.RangeMin)*scale+this.Min},OptionSubHandle.prototype.SetPos=function(value){var scale=(this.Max-this.Min)/(this.RangeMax-this.RangeMin);return this.RangeMin+(value-this.Min)/scale},OptionSubHandle.prototype.Draw=function(ctx,x,y,size,col){var w=this.Position.x;App.FillColor(ctx,col),ctx.beginPath(),ctx.moveTo(x-w-size,y),ctx.lineTo(x-w,y-size),ctx.lineTo(x+w,y-size),ctx.lineTo(x+w+size,y),ctx.lineTo(x+w,y+size),ctx.lineTo(x-w,y+size),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[8]),ctx.beginPath(),ctx.moveTo(x-w-size,y),ctx.lineTo(x-w,y-size),ctx.lineTo(x-w+size*.5,y-size*.5),ctx.lineTo(x-w-size*.5,y+size*.5),ctx.closePath(),ctx.fill()},OptionSubHandle}();exports.OptionSubHandle=OptionSubHandle}),define("UI/Options/OptionSwitch",["require","exports"],function(require,exports){var OptionSwitch=function(){function OptionSwitch(position,name,setting,value,size,lit,mode){this.Position=position,this.Name=name,this.Setting=setting,this.Selected=value,this.Size=size,this._Lit=lit,this.Mode=mode}return OptionSwitch.prototype.Draw=function(ctx,panel,units,x,h,i){var style=1,col=panel.SliderColours[i-Math.floor(i/panel.SliderColours.length)*panel.SliderColours.length];x+=this.Position.x;var y=this.Position.y,w=this.Size.width,mode=this.Mode;if(style==0)App.FillColor(ctx,App.Palette[1]),ctx.fillRect(x,y+h*.16,w,h*.43),App.FillColor(ctx,col),this.Selected?(this._Lit&&App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillRect(x+w*.5,y+h*.16,w*.5,h*.42)):ctx.fillRect(x,y+h*.16,w*.5,h*.42);else if(style==1){App.StrokeColor(ctx,App.Palette[1]),ctx.beginPath(),ctx.moveTo(Math.round(x+w*.5),y+h*.15),ctx.lineTo(Math.round(x+w*.5),y+h*.55),ctx.closePath(),ctx.stroke(),this.Selected?(App.FillColor(ctx,col),ctx.fillRect(x+w*.5,y+h*.55,w*.5,h*.05)):(App.FillColor(ctx,col),ctx.fillRect(x,y+h*.55,w*.5,h*.05)),ctx.lineWidth=2,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]);var cx=x+w*.5,cy=y+h*.35,lx=x+w*.25,rx=x+w*.75;ctx.beginPath();switch(mode){case"fewMany":ctx.moveTo(lx-5*units,cy-5*units),ctx.lineTo(lx+5*units,cy+5*units),ctx.moveTo(rx-10*units,cy-5*units),ctx.lineTo(rx,cy+5*units),ctx.moveTo(rx-5*units,cy-5*units),ctx.lineTo(rx+5*units,cy+5*units),ctx.moveTo(rx,cy-5*units),ctx.lineTo(rx+10*units,cy+5*units);break;case"offOn":ctx.moveTo(lx-5*units,cy),ctx.lineTo(lx+5*units,cy),ctx.moveTo(rx+5*units,cy),ctx.lineTo(rx,cy-5*units),ctx.lineTo(rx-5*units,cy),ctx.lineTo(rx,cy+5*units),ctx.lineTo(rx+5*units,cy);break;case"eitherOr":}ctx.stroke(),ctx.lineWidth=1}App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="center",ctx.fillText(this.Name.toUpperCase(),x+w*.5,y+h*.84)},OptionSwitch}();exports.OptionSwitch=OptionSwitch});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionParametric",["require","exports","./Option"],function(require,exports,Option_1){var Point=etch.primitives.Point,Parametric=function(_super){__extends(Parametric,_super);function Parametric(position,size,name,handle0,handle1,handle2,handle3){_super.call(this),this.Type="parametric",this.Position=position,this.Size=size,this.Name=name,this.Handles=[],this.HandleRoll=[],this.SubHandles=[],this.SubHandleRoll=[],this.Handles[0]=handle0,this.Handles[1]=handle1,this.Handles[2]=handle2,this.Handles[3]=handle3,this.Smoothness=300,this.LineGain=[];for(var j=0;j<this.Smoothness;j++)this.LineGain[j]=0}return Parametric.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel);var p=[this.Handles[0].Position,this.Handles[1].Position,this.Handles[2].Position,this.Handles[3].Position],y=this.Position.y,height=this.Size.height;ctx.globalAlpha=1;var ly=Math.round(y+height*.45);App.StrokeColor(ctx,App.Palette[1]),ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height*.1),ctx.lineTo(panel.Margin-units,y+height*.8),ctx.moveTo(panel.Range+panel.Margin+units,y+height*.1),ctx.lineTo(panel.Range+panel.Margin+units,y+height*.8),ctx.moveTo(panel.Range+panel.Margin+units,Math.round(y+height*.45)),ctx.lineTo(panel.Margin-units,Math.round(y+height*.45)),ctx.stroke();var markers=[20,50,100,200,1e3,2e3,5e3,1e4,2e4],markerNames=["20","50","100","200","1k","2k","5k","10k","20k"];ctx.textAlign="center";var bodyType=units*5;ctx.font="400 "+bodyType+"px PT Sans",App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]);for(var j=0;j<markers.length;j++){ctx.globalAlpha=1;var xPos=this.logPosition(0,panel.Range,20,2e4,markers[j]);ctx.fillText(markerNames[j],panel.Margin+xPos,y+height);if(markers[j]==100||markers[j]==1e3)App.StrokeColor(ctx,App.Palette[1]),ctx.globalAlpha=.5,ctx.beginPath(),ctx.moveTo(Math.round(panel.Margin+xPos)+.5,y+height*.1),ctx.lineTo(Math.round(panel.Margin+xPos)+.5,y+height*.8),ctx.stroke()}ctx.save(),ctx.beginPath(),ctx.moveTo(panel.Margin,y+height*.8),ctx.lineTo(panel.Margin,ly-this.LineGain[0]);for(var j=0;j<this.Smoothness;j++)ctx.lineTo(panel.Margin+panel.Range/this.Smoothness*(j+1),ly-this.LineGain[j]);ctx.lineTo(panel.Margin+panel.Range,y+height*.8),ctx.closePath(),ctx.clip(),App.StrokeColor(ctx,App.Palette[1]),panel.diagonalFill(panel.Margin-units,y+units,panel.Range+2*units,height-2*units,9),ctx.restore(),ctx.lineWidth=2,ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(panel.Margin,ly-this.LineGain[0]);for(var j=0;j<this.Smoothness;j++)ctx.lineTo(panel.Margin+panel.Range/this.Smoothness*(j+1),ly-this.LineGain[j]);ctx.stroke(),ctx.lineWidth=1;for(var j=0;j<4;j++){var hx=panel.Margin+p[j].x,size=2*units;if(j==0||j==3)App.FillColor(ctx,App.Palette[3+j]),ctx.beginPath(),ctx.moveTo(hx-size,y+height*.9),ctx.lineTo(hx,y+height*.9-size),ctx.lineTo(hx+size,y+height*.9),ctx.lineTo(hx,y+height*.9+size),ctx.closePath(),ctx.fill()}ctx.save(),ctx.beginPath(),ctx.moveTo(panel.Margin,y+height*.8),ctx.lineTo(panel.Margin+panel.Range,y+height*.8),ctx.lineTo(panel.Margin+panel.Range,y+height),ctx.lineTo(panel.Margin,y+height),ctx.closePath(),ctx.clip();for(var j=0;j<4;j++){var hx=panel.Margin+p[j].x;j!==0&&j!==3&&this.SubHandles[j].Draw(ctx,hx,y+height*.9,height*.02,App.Palette[3+j])}ctx.restore();for(var j=0;j<4;j++){var hx=panel.Margin+p[j].x,hy=y+height*.8-p[j].y;this.Handles[j].Draw(ctx,hx,hy,height*.05,App.Palette[3+j])}},Parametric.prototype.PlotGraph=function(){_super.prototype.PlotGraph.call(this);var p=[];for(var j=0;j<4;j++){var x=Math.round(this.Smoothness/this.Size.width*this.Handles[j].Position.x)-1,y=this.Handles[j].Position.y-this.Size.height*.35;p[j]=new Point(x,y)}var q1a=this.Smoothness/26.5*(14.5-this.SubHandles[1].Value),q2a=this.Smoothness/26.5*(14.5-this.SubHandles[2].Value);q1a=this.linValue(this.SubHandles[1].RangeMin,this.SubHandles[1].RangeMax,this.Smoothness*.02,this.Smoothness*.55,this.SubHandles[1].Position.x),q2a=this.linValue(this.SubHandles[2].RangeMin,this.SubHandles[2].RangeMax,this.Smoothness*.02,this.Smoothness*.55,this.SubHandles[2].Position.x),this._Gain1=this.CurvePass("lowshelf",p[0].x,30,p[0].y),this._Gain2=this.CurvePass("peaking",p[1].x,q1a,p[1].y),this._Gain3=this.CurvePass("peaking",p[2].x,q2a,p[2].y),this._Gain4=this.CurvePass("highshelf",p[3].x,30,p[3].y);for(var j=0;j<this.Smoothness;j++)this.LineGain[j]=this._Gain1[j]+this._Gain2[j]+this._Gain3[j]+this._Gain4[j],this.LineGain[j]>this.Size.height*.35&&(this.LineGain[j]=this.Size.height*.35),this.LineGain[j]<-(this.Size.height*.35)&&(this.LineGain[j]=-(this.Size.height*.35))},Parametric.prototype.CurvePass=function(type,freq,q,gain){var tempGain=[];for(var h=0;h<this.Smoothness;h++)tempGain[h+freq]=this.Bell(h,0,gain,q);for(var h=0;h<this.Smoothness;h++)tempGain[freq-h]=this.Bell(h,0,gain,q);tempGain[freq]=gain;if(type=="lowshelf")for(var h=0;h<freq;h++)tempGain[h]=gain;if(type=="highshelf")for(var h=freq+1;h<this.Smoothness;h++)tempGain[h]=gain;return tempGain},Parametric.prototype.Bell=function(t,b,c,d){return c*Math.exp(-(t*t)/Math.pow(d*.5,2))+b},Parametric.prototype.logPosition=function(minpos,maxpos,minval,maxval,value){var minlval=Math.log(minval),maxlval=Math.log(maxval),scale=(maxlval-minlval)/(maxpos-minpos);return minpos+(Math.log(value)-minlval)/scale},Parametric.prototype.linValue=function(minpos,maxpos,minval,maxval,position){var scale=(maxval-minval)/(maxpos-minpos);return(position-minpos)*scale+minval},Parametric}(Option_1.Option);exports.Parametric=Parametric});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionSlider",["require","exports","./Option"],function(require,exports,Option_1){var Slider=function(_super){__extends(Slider,_super);function Slider(position,size,origin,value,min,max,quantised,name,setting,log){_super.call(this),this.Type="slider",this.Position=position,this.Size=size,this.Origin=origin,this.Value=value,this.Min=min,this.Max=max,this.Quantised=quantised,this.Name=name,this.Setting=setting,this.Log=log,this.Selected=!1}return Slider.prototype.Draw=function(ctx,units,i,panel,yoveride){_super.prototype.Draw.call(this,ctx,units,i,panel);var x=this.Position.x,y=this.Position.y;yoveride&&(y=yoveride);var height=this.Size.height,origin=this.Origin,dataType=Math.round(units*10),headerType=Math.round(units*33);ctx.globalAlpha=1,App.FillColor(ctx,App.Palette[1]),App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke()),ctx.beginPath(),ctx.moveTo(panel.Range*.5+panel.Margin-2*units,y+height*.5),ctx.lineTo(panel.Range*.5+panel.Margin,y+height*.5-2*units),ctx.lineTo(panel.Range*.5+panel.Margin+2*units,y+height*.5),ctx.lineTo(panel.Range*.5+panel.Margin,y+height*.5+2*units),ctx.closePath(),ctx.fill(),origin!==panel.Margin&&panel.diagonalFill(panel.Margin-units,y+units,panel.Range+2*units,height-2*units,9);var offset=0;origin==panel.Margin&&(offset=-units),ctx.globalAlpha=1;var col=panel.SliderColours[i-Math.floor(i/panel.SliderColours.length)*panel.SliderColours.length];App.FillColor(ctx,col),ctx.beginPath(),ctx.moveTo(origin+offset,y),ctx.lineTo(x+panel.Margin,y),ctx.lineTo(x+panel.Margin,y+height),ctx.lineTo(origin+offset,y+height),ctx.closePath(),ctx.fill(),ctx.fillRect(x+panel.Margin-units,y,2*units,height);var dragWidth=height*.2;ctx.beginPath(),ctx.moveTo(x+panel.Margin-dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5-dragWidth),ctx.lineTo(x+panel.Margin+dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5+dragWidth),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[8]),ctx.beginPath(),ctx.moveTo(x+panel.Margin-dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5-dragWidth),ctx.lineTo(x+panel.Margin+dragWidth*.5,y+height*.5-dragWidth*.5),ctx.lineTo(x+panel.Margin-dragWidth*.5,y+height*.5+dragWidth*.5),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+dataType*.4);if(this.Selected){ctx.textAlign="left",ctx.font=App.Metrics.TxtSlider;var string="";this.DisplayConversion?string=""+this.DisplayConversion(this.Value):string=panel.NumberWithCommas(""+Math.round(this.Value*100)/100),ctx.fillText(string,x+panel.Margin+25*units,y+height*.5+headerType*.35)}},Slider}(Option_1.Option);exports.Slider=Slider});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionSwitchArray",["require","exports","./Option"],function(require,exports,Option_1){var SwitchArray=function(_super){__extends(SwitchArray,_super);function SwitchArray(position,size,switches){_super.call(this),this.Type="switches",this.Position=position,this.Size=size,this.Switches=switches,this.HandleRoll=[]}return SwitchArray.prototype.Refresh=function(i,json){var switches=json.parameters[i].switches;for(var j=0;j<this.Switches.length;j++)this.Switches[j].Selected=switches[j].value},SwitchArray.prototype.Draw=function(ctx,units,i,panel){var x=this.Position.x,y=this.Position.y,height=this.Size.height;App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke());for(var j=0;j<this.Switches.length;j++)this.Switches[j].Draw(ctx,panel,units,panel.Margin,this.Size.height,i)},SwitchArray}(Option_1.Option);exports.SwitchArray=SwitchArray});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionWave",["require","exports","./Option"],function(require,exports,Option_1){var WaveForm=function(_super){__extends(WaveForm,_super);function WaveForm(waveform,emptystring){_super.call(this),this.Waveform=waveform,this.EmptyString=emptystring||""}return WaveForm.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel);var x=this.Position.x,y=this.Position.y,height=this.Size.height,dataType=Math.round(units*10);ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke());if(!this.Waveform.length){App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]);var ax=panel.Range*.5+panel.Margin,ay=y+height*.5;this.EmptyString.length>1?(ctx.textAlign="center",ctx.font=App.Metrics.TxtMid,ctx.fillText(this.EmptyString.toUpperCase(),ax,ay+dataType*.4)):App.AnimationsLayer.DrawSprite(ctx,"loading",ax,ay,11,!0)}this.Handles&&this.Waveform.length&&this.Mode&&(App.StrokeColor(ctx,App.Palette[1]),panel.diagonalFill(panel.Margin+this.Handles[2].Position.x,y,this.Handles[3].Position.x-this.Handles[2].Position.x,height,9)),App.FillColor(ctx,App.Palette[1]),ctx.beginPath(),ctx.moveTo(panel.Margin,y+height*.5);if(this.Waveform.length!==0){for(var j=0;j<this.Waveform.length;j++)ctx.lineTo(panel.Range/this.Waveform.length*j+panel.Margin,y+height*.5-this.Waveform[j]*height*.45);ctx.lineTo(panel.Range+panel.Margin,y+height*.5);for(var j=this.Waveform.length-1;j>-1;j--)ctx.lineTo(panel.Range/this.Waveform.length*j+panel.Margin,y+height*.5+this.Waveform[j]*height*.45)}ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+dataType*.4)},WaveForm}(Option_1.Option);exports.WaveForm=WaveForm});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionWaveImage",["require","exports","./OptionWave"],function(require,exports,OptionWave_1){var WaveImage=function(_super){__extends(WaveImage,_super);function WaveImage(position,size,origin,name,waveform,emptystring){_super.call(this,waveform,emptystring),this.Type="waveimage",this.Position=position,this.Size=size,this.Origin=origin,this.Name=name}return WaveImage.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel)},WaveImage}(OptionWave_1.WaveForm);exports.WaveImage=WaveImage});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionWaveRegion",["require","exports","./OptionWave"],function(require,exports,OptionWave_1){var WaveRegion=function(_super){__extends(WaveRegion,_super);function WaveRegion(position,size,origin,value,min,max,quantised,name,setting,log,waveform,handles,mode,emptystring){_super.call(this,waveform,emptystring),this.Type="waveregion",this.Position=position,this.Size=size,this.Origin=origin,this.Value=value,this.Min=min,this.Max=max,this.Quantised=quantised,this.Name=name,this.Setting=setting,this.Log=log,this.Selected=!1,this.Handles=handles,this.Mode=mode,this.HandleRoll=[]}return WaveRegion.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel);var y=this.Position.y,height=this.Size.height,origin=this.Origin,dataType=Math.round(units*10),xs=[this.Handles[0].Position.x,this.Handles[1].Position.x,this.Handles[2].Position.x,this.Handles[3].Position.x],col=panel.SliderColours[i-Math.floor(i/panel.SliderColours.length)*panel.SliderColours.length];if(this.Waveform.length){ctx.lineWidth=1,ctx.globalAlpha=1,ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]);var x=xs[2],sliderNo=2;this.Mode&&(ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(xs[2]+panel.Margin,y),ctx.lineTo(xs[2]+panel.Margin,y+height),ctx.moveTo(xs[3]+panel.Margin,y),ctx.lineTo(xs[3]+panel.Margin,y+height),ctx.stroke(),ctx.lineWidth=1,sliderNo=1);var offset=0;origin==panel.Margin&&(offset=-units),ctx.globalAlpha=1;for(var j=0;j<sliderNo;j++){App.FillColor(ctx,col),x=xs[j],ctx.fillRect(x+panel.Margin-units,y,2*units,height);var dragWidth=height*.16;ctx.beginPath(),ctx.moveTo(x+panel.Margin-dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5-dragWidth),ctx.lineTo(x+panel.Margin+dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5+dragWidth),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[8]),ctx.beginPath(),ctx.moveTo(x+panel.Margin-dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5-dragWidth),ctx.lineTo(x+panel.Margin+dragWidth*.5,y+height*.5-dragWidth*.5),ctx.lineTo(x+panel.Margin-dragWidth*.5,y+height*.5+dragWidth*.5),ctx.closePath(),ctx.fill()}App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]);if(this.Mode)for(var j=2;j<4;j++){x=xs[j];var dragWidth=height*.16;ctx.beginPath(),ctx.moveTo(x+panel.Margin-dragWidth*.5,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5-dragWidth*.5),ctx.lineTo(x+panel.Margin+dragWidth*.5,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5+dragWidth*.5),ctx.closePath(),ctx.fill()}ctx.font=App.Metrics.TxtItalic,ctx.textAlign="left",ctx.fillText("Start",xs[0]+panel.Margin+5*units,y+dataType*.8),this.Mode?ctx.fillText("Loop",xs[2]+panel.Margin+5*units,y+height-dataType*.4):ctx.fillText("End",xs[1]+panel.Margin+5*units,y+height-dataType*.4)}},WaveRegion}(OptionWave_1.WaveForm);exports.WaveRegion=WaveRegion});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionWaveSlider",["require","exports","./OptionWave"],function(require,exports,OptionWave_1){var WaveSlider=function(_super){__extends(WaveSlider,_super);function WaveSlider(position,size,origin,value,min,max,quantised,name,setting,log,waveform,spread,emptystring){_super.call(this,waveform,emptystring),this.Type="waveslider",this.Position=position,this.Size=size,this.Origin=origin,this.Value=value,this.Min=min,this.Max=max,this.Quantised=quantised,this.Name=name,this.Setting=setting,this.Log=log,this.Selected=!1,this.Spread=spread}return WaveSlider.prototype.Draw=function(ctx,units,i,panel){_super.prototype.Draw.call(this,ctx,units,i,panel);var x=this.Position.x,y=this.Position.y,height=this.Size.height,origin=this.Origin,headerType=Math.round(units*33);if(this.Waveform.length){ctx.lineWidth=2,ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]);var spread=panel.Range/(this.Max-this.Min)*this.Spread,leftSpread=x+panel.Margin-spread*.5;leftSpread<panel.Margin&&(leftSpread=panel.Margin);var rightSpread=x+panel.Margin+spread*.5;rightSpread>panel.Margin+panel.Range&&(rightSpread=panel.Margin+panel.Range),ctx.beginPath(),ctx.moveTo(leftSpread,y),ctx.lineTo(leftSpread,y+height),ctx.moveTo(rightSpread,y),ctx.lineTo(rightSpread,y+height),ctx.stroke(),ctx.lineWidth=1;var col=panel.SliderColours[i-Math.floor(i/panel.SliderColours.length)*panel.SliderColours.length],offset=0;origin==panel.Margin&&(offset=-units),ctx.globalAlpha=1,App.FillColor(ctx,col),ctx.fillRect(x+panel.Margin-units,y,2*units,height);var dragWidth=height*.2;ctx.beginPath(),ctx.moveTo(x+panel.Margin-dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5-dragWidth),ctx.lineTo(x+panel.Margin+dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5+dragWidth),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[8]),ctx.beginPath(),ctx.moveTo(x+panel.Margin-dragWidth,y+height*.5),ctx.lineTo(x+panel.Margin,y+height*.5-dragWidth),ctx.lineTo(x+panel.Margin+dragWidth*.5,y+height*.5-dragWidth*.5),ctx.lineTo(x+panel.Margin-dragWidth*.5,y+height*.5+dragWidth*.5),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]);if(this.Selected){ctx.textAlign="left",ctx.font=App.Metrics.TxtSlider;var string=panel.NumberWithCommas(""+Math.round(this.Value*100)/100);ctx.fillText(string,rightSpread+25*units,y+height*.5+headerType*.35)}}},WaveSlider}(OptionWave_1.WaveForm);exports.WaveSlider=WaveSlider});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/OptionsPanel",["require","exports","./Options/OptionADSR","./Options/OptionButtonArray","../Device","./Options/OptionActionButton","./Options/OptionButton","./Options/OptionHandle","./Options/OptionSample","./Options/OptionSampleLocal","./Options/OptionSubHandle","./Options/OptionSwitch","./Options/OptionParametric","./Options/OptionSlider","./Options/OptionSwitchArray","./Options/OptionWaveImage","./Options/OptionWaveRegion","./Options/OptionWaveSlider"],function(require,exports,OptionADSR_1,OptionButtonArray_1,Device_1,OptionActionButton_1,OptionButton_1,OptionHandle_1,OptionSample_1,OptionSampleLocal_1,OptionSubHandle_1,OptionSwitch_1,OptionParametric_1,OptionSlider_1,OptionSwitchArray_1,OptionWaveImage_1,OptionWaveRegion_1,OptionWaveSlider_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,Size=minerva.Size,OptionsPanel=function(_super){__extends(OptionsPanel,_super);function OptionsPanel(){_super.call(this),this.Outline=[]}return OptionsPanel.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this._Units=1.7,this.Position=new Point(0,0),this.Size=new Size(1,1),this.Scale=0,this.Margin=0,this.Range=100,this._Name="",this._NameWidth=0,this.Hover=!1,this.Opening=!1,this._DrawReady=!1,this.Animating=!1,this.Sketch=drawTo,this.Options=[],this.SliderColours=[],this._SliderRoll=[],this.InitJson={name:"Init",parameters:[]},this.Canvas=App.SubCanvas[0],this.Populate(this.InitJson,!1)},Object.defineProperty(OptionsPanel.prototype,"Ctx",{get:function(){return this.Canvas.getContext("2d")},enumerable:!0,configurable:!0}),OptionsPanel.prototype.Populate=function(json,open){this._JsonMemory=json;var units=App.Unit,ctx=this.Ctx,dataType=units*10;this._PanelCloseRoll=!1;var n=json.parameters.length,panelH,maxHeight=240,getHeight=0,heightScale=1,optionHeight=[];for(var i=0;i<n;i++)json.parameters[i].type=="slider"?(getHeight+=48,optionHeight[i]=48*units):json.parameters[i].type=="sample"?(getHeight+=48,optionHeight[i]=48*units):json.parameters[i].type=="samplelocal"?(getHeight+=48,optionHeight[i]=48*units):json.parameters[i].type=="actionbutton"?(getHeight+=48,optionHeight[i]=48*units):json.parameters[i].type=="waveslider"?(getHeight+=48,optionHeight[i]=48*units):json.parameters[i].type=="waveimage"?(getHeight+=48,optionHeight[i]=48*units):json.parameters[i].type=="waveregion"?(getHeight+=60,optionHeight[i]=60*units):json.parameters[i].type=="buttons"?(getHeight+=48,optionHeight[i]=48*units):json.parameters[i].type=="ADSR"?(getHeight+=120,optionHeight[i]=120*units):json.parameters[i].type=="parametric"?(getHeight+=140,optionHeight[i]=140*units):json.parameters[i].type=="switches"?(getHeight+=60,optionHeight[i]=60*units):console.log("Option type not recognised");getHeight>maxHeight&&(heightScale=1/getHeight*maxHeight,getHeight=maxHeight),panelH=(getHeight+40)*units;var panelM=0;ctx.font="300 "+dataType+"px Dosis";if(n!=1||json.parameters[0].type!="ADSR"&&json.parameters[0].type!="parametric"){for(var i=0;i<n;i++)ctx.measureText(json.parameters[i].name.toUpperCase()).width>panelM&&(panelM=ctx.measureText(json.parameters[i].name.toUpperCase()).width);panelM+=79*units}else panelM=69*units;var panelW;App.Metrics.Device!==Device_1.Device.mobile?panelW=450*units:panelW=App.Width+44*units;var panelR=panelW-(panelM+25*units),name=json.name,nameW=ctx.measureText(name.toUpperCase()).width;this.Size.width=panelW,this.Size.height=panelH,this.Margin=panelM,this.Range=panelR,this._Name=json.name,this._NameWidth=nameW;var order=App.ThemeManager.OptionsOrder;this.SliderColours=[App.Palette[order[0]],App.Palette[order[1]],App.Palette[order[2]],App.Palette[order[3]],App.Palette[order[4]]];var topY=-(panelH*.5),margin=this.Margin;this.Outline=[],this.Outline.push(new Point(0,0),new Point(44*units,0),new Point(44*units,topY),new Point(margin-25*units,topY),new Point(margin-5*units,topY-20*units),new Point(margin+5*units+this._NameWidth,topY-20*units),new Point(margin+25*units+this._NameWidth,topY),new Point(panelW-40*units,topY),new Point(panelW-20*units,topY-20*units),new Point(panelW,topY),new Point(panelW,panelH*.5),new Point(44*units,panelH*.5),new Point(44*units,44*units));var optionTotalY=0,optionList=[];for(var i=0;i<n;i++){var option=json.parameters[i];optionHeight[i]=Math.round(optionHeight[i]*heightScale);var optionY=Math.round(-(this.Size.height*.5)+20*units+optionTotalY);if(option.type=="slider"){var sliderO=this.Margin;option.props.centered==1&&(sliderO+=this.Range/100*50);var log=option.props.logarithmic,sliderX;log==1?sliderX=this.logPosition(0,this.Range,option.props.min,option.props.max,option.props.value):(sliderX=this.linPosition(0,this.Range,option.props.min,option.props.max,option.props.value),log=!1),optionList.push(new OptionSlider_1.Slider(new Point(sliderX,optionY),new Size(1,optionHeight[i]),sliderO,option.props.value,option.props.min,option.props.max,option.props.quantised,option.name,option.setting,log)),option.props.convertDisplay&&(optionList[i].DisplayConversion=option.props.convertDisplay)}else if(option.type=="waveslider"){var sliderO=this.Margin,waveform=[];option.props.wavearray&&(waveform=option.props.wavearray);var log=option.props.logarithmic,sliderX;log==1?sliderX=this.logPosition(0,this.Range,option.props.min,option.props.max,option.props.value):(sliderX=this.linPosition(0,this.Range,option.props.min,option.props.max,option.props.value),log=!1),optionList.push(new OptionWaveSlider_1.WaveSlider(new Point(sliderX,optionY),new Size(1,optionHeight[i]),sliderO,option.props.value,option.props.min,option.props.max,option.props.quantised,option.name,option.setting,log,waveform,option.props.spread))}else if(option.type=="waveimage"){var sliderO=this.Margin,waveform=[];option.props.wavearray&&(waveform=option.props.wavearray),optionList.push(new OptionWaveImage_1.WaveImage(new Point(0,optionY),new Size(1,optionHeight[i]),sliderO,option.name,waveform))}else if(option.type=="waveregion"){var handles=[],sliderO=this.Margin,waveform=[];option.props.wavearray&&(waveform=option.props.wavearray);var emptystring="";option.props.emptystring&&(emptystring=option.props.emptystring);var startX=this.linPosition(0,this.Range,option.props.min,option.props.max,option.nodes[0].value),endX=this.linPosition(0,this.Range,option.props.min,option.props.max,option.nodes[1].value),loopStartX=this.linPosition(0,this.Range,option.props.min,option.props.max,option.nodes[2].value),loopEndX=this.linPosition(0,this.Range,option.props.min,option.props.max,option.nodes[3].value),xs=[startX,endX,loopStartX,loopEndX];for(var j=0;j<4;j++)handles[j]=new OptionHandle_1.OptionHandle(new Point(xs[j],optionY),option.nodes[j].value,option.props.min,option.props.max,this.Range,0,0,0,0,option.nodes[j].setting,"");optionList.push(new OptionWaveRegion_1.WaveRegion(new Point(0,optionY),new Size(1,optionHeight[i]),sliderO,option.props.value,option.props.min,option.props.max,option.props.quantised,option.name,option.setting,log,waveform,handles,option.props.mode,emptystring))}else if(option.type=="sample")optionList.push(new OptionSample_1.OptionSample(new Point(sliderX,optionY),new Size(1,optionHeight[i]),option.name,option.props.track,option.props.user,option.props.permalink,option.setting));else if(option.type=="samplelocal")optionList.push(new OptionSampleLocal_1.OptionSampleLocal(new Point(sliderX,optionY),new Size(1,optionHeight[i]),option.name,option.props.track,option.setting));else if(option.type=="actionbutton")optionList.push(new OptionActionButton_1.OptionActionButton(new Point(sliderX,optionY),new Size(1,optionHeight[i]),option.name,option.props.text,option.setting));else if(option.type=="switches"){var switches=[],margin=20*units,switchWidth=60*units;switchWidth=(this.Range-margin*3)/4;var switchStartX=this.Range*.5-(switchWidth*option.switches.length+margin*(option.switches.length-1))*.5,switchX=0;for(var j=0;j<option.switches.length;j++)switchX=switchStartX+j*(switchWidth+margin),switches[j]=new OptionSwitch_1.OptionSwitch(new Point(switchX,optionY),option.switches[j].name,option.switches[j].setting,option.switches[j].value,new Size(switchWidth,optionHeight[i]*.43),option.switches[j].lit,option.switches[j].mode);optionList.push(new OptionSwitchArray_1.SwitchArray(new Point(sliderX,optionY),new Size(1,optionHeight[i]),switches))}else if(option.type=="buttons"){var buttons=[],margin=20*units,buttonWidth=(this.Range-margin*(option.buttons.length-1))/option.buttons.length;buttonWidth=this.Range/5;var buttonStartX=this.Range*.5-buttonWidth*option.buttons.length*.5,buttonX=0;for(var j=0;j<option.buttons.length;j++)buttonX=buttonStartX+j*buttonWidth,buttons[j]=new OptionButton_1.OptionButton(new Point(buttonX,optionY),option.buttons[j].name,j==option.props.value,j,new Size(buttonWidth,optionHeight[i]));optionList.push(new OptionButtonArray_1.ButtonArray(new Point(0,optionY),new Size(this.Range,optionHeight[i]),option.name,option.setting,buttons,option.props.mode))}else if(option.type=="ADSR"){var Xrange,handleX,Yrange,handleY,handles=[];Xrange=option.nodes[0].max-option.nodes[0].min,handleX=this.Range*.28/Xrange*(option.nodes[0].value-option.nodes[0].min),Yrange=option.nodes[2].max-option.nodes[2].min,handleY=optionHeight[i]*.8/Yrange*(option.nodes[2].value-option.nodes[2].min),handles[0]=new OptionHandle_1.OptionHandle(new Point(handleX,handleY),option.nodes[0].value,option.nodes[0].min,option.nodes[0].max,this.Range*.28,0,0,0,0,option.nodes[0].setting,""),Xrange=option.nodes[1].max-option.nodes[1].min,handleX=this.Range*.28/Xrange*(option.nodes[1].value-option.nodes[1].min),handles[1]=new OptionHandle_1.OptionHandle(new Point(handleX,handleY),option.nodes[1].value,option.nodes[1].min,option.nodes[1].max,this.Range*.28,option.nodes[2].value,option.nodes[2].min,option.nodes[2].max,optionHeight[i]*.8,option.nodes[1].setting,option.nodes[2].setting),Xrange=option.nodes[3].max-option.nodes[3].min,handleX=this.Range*.4/Xrange*(option.nodes[3].value-option.nodes[3].min),handles[2]=new OptionHandle_1.OptionHandle(new Point(handleX,handleY),option.nodes[3].value,option.nodes[3].min,option.nodes[3].max,this.Range*.4,0,0,0,0,option.nodes[3].setting,""),optionList.push(new OptionADSR_1.OptionADSR(new Point(0,optionY),new Size(this.Range,optionHeight[i]),option.name,handles[0],handles[1],handles[2]))}else if(option.type=="parametric"){var handles=[],subHandles=[],Xmin,Xmax,Xval,Xrange,handleX,Ymin,Ymax,Yval,Yrange,handleY,Qmin,Qmax,Qval,QRmin,QRmax,QX;for(var j=0;j<4;j++)Xmin=option.nodes[j].x_min,Xmax=option.nodes[j].x_max,Xval=option.nodes[j].x_value,Ymin=option.nodes[j].y_min,Ymax=option.nodes[j].y_max,Yval=option.nodes[j].y_value,Xrange=Xmax-Xmin,handleX=this.Range/Xrange*(Xval-Xmin),handleX=this.logPosition(0,this.Range,Xmin,Xmax,Xval),Yrange=Ymax-Ymin,handleY=optionHeight[i]*.7/Yrange*(Yval-Ymin),handles[j]=new OptionHandle_1.OptionHandle(new Point(handleX,handleY),Xval,Xmin,Xmax,this.Range,Yval,Ymin,Ymax,optionHeight[i]*.7,option.nodes[j].x_setting,option.nodes[j].y_setting),handles[j].XLog=!0,Qmin=option.nodes[j].q_min,Qmax=option.nodes[j].q_max,Qval=option.nodes[j].q_value,QRmin=this.Range/100*2,QRmax=this.Range/100*10,QX=this.logPosition(QRmin,QRmax,Qmin,Qmax,Qval),subHandles[j]=new OptionSubHandle_1.OptionSubHandle(new Point(QX,handleY),Qval,Qmin,Qmax,QRmin,QRmax,option.nodes[j].q_setting);optionList.push(new OptionParametric_1.Parametric(new Point(0,optionY),new Size(this.Range,optionHeight[i]),option.name,handles[0],handles[1],handles[2],handles[3])),optionList[i].SubHandles=subHandles,optionList[i].PlotGraph()}optionTotalY+=optionHeight[i]}this.Options=optionList,this._DrawReady=!0},OptionsPanel.prototype.RefreshOption=function(i,json){this.Options[i].Refresh(i,json),this._DrawReady=!0},OptionsPanel.prototype.UpdateOptions=function(){this.SelectedBlock.UpdateOptionsForm();var json=this.SelectedBlock.OptionsForm,n=json.parameters.length;for(var i=0;i<n;i++){var option=json.parameters[i];if(option.type=="slider"){this.Options[i].Value=option.props.value;var sliderO=this.Margin;option.props.centered==1&&(sliderO+=this.Range/100*50);var log=option.props.logarithmic;log==1?this.Options[i].Position.x=this.logPosition(0,this.Range,option.props.min,option.props.max,option.props.value):this.Options[i].Position.x=this.linPosition(0,this.Range,option.props.min,option.props.max,option.props.value)}else option.type=="waveslider"&&(this.Options[i].Value=option.props.value,this.Options[i].Spread=option.props.spread,this.Options[i].Mode=option.props.mode)}this._DrawReady=!0},OptionsPanel.prototype.Update=function(){this._JsonMemory.updateeveryframe==1,this.Animating&&(this._DrawReady=!0)},OptionsPanel.prototype.Draw=function(){var units=App.Unit,ctxOuter=App.Canvas.Ctx,ctx=this.Ctx;this._DrawReady&&(this.DrawToOffscreenCanvas(ctx),this._DrawReady=!1);if(this.Scale>0){ctxOuter.globalAlpha=1;var xOff=0;App.Metrics.Device===Device_1.Device.mobile&&(xOff=44*units),ctxOuter.setTransform(this.Scale,0,0,this.Scale,this.Position.x+xOff,this.Position.y),ctxOuter.drawImage(this.Canvas,0,-Math.round(App.Metrics.C.y)),ctxOuter.setTransform(1,0,0,1,0,0)}},OptionsPanel.prototype.DrawToOffscreenCanvas=function(ctx){ctx.clearRect(0,0,App.Width,App.Height);var units=App.Unit,xOff=0;App.Metrics.Device===Device_1.Device.mobile&&(xOff=-44*units),ctx.setTransform(1,0,0,1,xOff,Math.round(App.Metrics.C.y));var sx=0,sy=0;ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.16,this.panelDraw(sx,sy+5*units),ctx.globalAlpha=.9,this.panelDraw(sx,sy),ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(sx+this.Size.width-24*units,sy-this.Size.height*.5+4*units),ctx.lineTo(sx+this.Size.width-16*units,sy-this.Size.height*.5-4*units),ctx.moveTo(sx+this.Size.width-24*units,sy-this.Size.height*.5-4*units),ctx.lineTo(sx+this.Size.width-16*units,sy-this.Size.height*.5+4*units),ctx.stroke(),ctx.lineWidth=1,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.textAlign="left",ctx.fillText(this._Name.toUpperCase(),this.Margin,-this.Size.height*.5);for(var i=0;i<this.Options.length;i++)this.Options[i].Draw(ctx,units,i,this);ctx.setTransform(1,0,0,1,0,0)},OptionsPanel.prototype.panelDraw=function(x,y){var units=App.Unit,ctx=this.Ctx;ctx.beginPath(),ctx.moveTo(x+44*units,y-this.Size.height*.5),ctx.lineTo(x+this.Margin-25*units,y-this.Size.height*.5),ctx.lineTo(x+this.Margin-5*units,y-this.Size.height*.5-20*units),ctx.lineTo(x+this.Margin+5*units+this._NameWidth,y-this.Size.height*.5-20*units),ctx.lineTo(x+this.Margin+25*units+this._NameWidth,y-this.Size.height*.5),ctx.lineTo(x+this.Size.width-40*units,y-this.Size.height*.5),ctx.lineTo(x+this.Size.width-20*units,y-this.Size.height*.5-20*units),ctx.lineTo(x+this.Size.width,y-this.Size.height*.5),ctx.lineTo(x+this.Size.width,y+this.Size.height*.5),ctx.lineTo(x+44*units,y+this.Size.height*.5),ctx.lineTo(x+44*units,y+44*units),ctx.lineTo(x,y),ctx.lineTo(x+44*units,y),ctx.closePath(),ctx.fill()},OptionsPanel.prototype.diagonalFill=function(x,y,w,h,s){var pr=App.Metrics.PixelRatio;s*=pr;var ctx=this.Ctx,lineNo=Math.round((w+h)/s),pos1=new Point(0,0),pos2=new Point(0,0);ctx.beginPath();for(var j=0;j<lineNo;j++)pos1.x=s*.5+s*j,pos1.y=0,pos2.x=pos1.x-h,pos2.y=h,pos2.x<0&&(pos2.y=h+pos2.x,pos2.x=0),pos1.x>w&&(pos1.y=pos1.x-w,pos1.x=w),ctx.moveTo(x+pos1.x,y+pos1.y),ctx.lineTo(x+pos2.x,y+pos2.y);ctx.stroke()},OptionsPanel.prototype.NumberWithCommas=function(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},OptionsPanel.prototype.PanelScale=function(panel,destination,t){var psTween=new window.TWEEN.Tween({x:panel.Scale});psTween.to({x:destination},t),psTween.onUpdate(function(){panel.Scale=this.x}),psTween.start(this.LastVisualTick),psTween.easing(window.TWEEN.Easing.Quintic.InOut)},OptionsPanel.prototype.Open=function(block){block.UpdateOptionsForm();if(block.OptionsForm){var newBlock=block!==this.SelectedBlock;this.Scale==1&&newBlock&&this.Close(),this.Opening=!0,this.SelectedBlock=block,App.MainScene.MainSceneDragger.Jump(block.Position,new Point(App.Metrics.OptionsPoint.x,App.Metrics.OptionsPoint.y));var me=this;setTimeout(function(){me.Opening=!1,me.Populate(block.OptionsForm,!0),me.PanelScale(me,1,200)},400)}},OptionsPanel.prototype.Refresh=function(){this.Scale==1&&(this.SelectedBlock.UpdateOptionsForm(),this.Populate(this.SelectedBlock.OptionsForm,!1))},OptionsPanel.prototype.Resize=function(){if(!App.Width)return;App.Metrics.Device!==Device_1.Device.mobile?(this.Position.x=Math.round(App.Width*App.Metrics.OptionsPoint.x),this.Position.y=Math.round(App.Height*App.Metrics.OptionsPoint.y)):(this.Position.x=-44*App.Unit,this.Position.y=Math.round(App.Height*.65))},OptionsPanel.prototype.Close=function(){this.PanelScale(this,0,200);if(App.Stage){var tut=App.MainScene.Tutorial;tut.Open&&tut.CheckTask()}},OptionsPanel.prototype.MouseDown=function(mx,my){this.RolloverCheck(mx,my);var tut=App.MainScene.Tutorial;tut.Open&&(tut.OptionsInteract=!0);for(var i=0;i<this.Options.length;i++){this._SliderRoll[i]&&(this.Options[i].Selected=!0,this.SliderSet(i,mx));if(this.Options[i].Type=="ADSR"){var xStart=[0,this.Options[i].Handles[0].Position.x,this.Range*.6];for(var j=0;j<this.Options[i].Handles.length;j++)this.Options[i].HandleRoll[j]&&(this.Options[i].Handles[j].Selected=!0,this.HandleSet(i,j,xStart[j],this.Options[i].Size.height*.9,mx,my))}if(this.Options[i].Type=="waveregion")for(var j=this.Options[i].Handles.length-1;j>-1;j--)if(this.Options[i].HandleRoll[j]){var handles=this.Options[i].Handles;handles[j].Selected=!0,this.HandleSet(i,j,0,this.Options[i].Size.height,mx,my),handles[3].Position.x<handles[2].Position.x+1&&this.HandleSet(i,3,0,this.Options[i].Size.height,handles[2].Position.x+1+this.Position.x+this.Margin,my),handles[3].Position.x<handles[0].Position.x&&this.HandleSet(i,3,0,this.Options[i].Size.height,handles[0].Position.x+this.Position.x+this.Margin,my),handles[1].Position.x<handles[0].Position.x+1&&this.HandleSet(i,1,0,this.Options[i].Size.height,handles[0].Position.x+1+this.Position.x+this.Margin,my);return}if(this.Options[i].Type=="switches")for(var j=0;j<this.Options[i].Switches.length;j++)if(this.Options[i].HandleRoll[j]){this.SwitchValue(this.Options[i].Switches[j],"Selected","Setting");return}if(this.Options[i].Type=="buttons")for(var j=0;j<this.Options[i].Buttons.length;j++)if(this.Options[i].HandleRoll[j]){for(var h=0;h<this.Options[i].Buttons.length;h++)this.Options[i].Buttons[h].Selected=!1;this.Options[i].Buttons[j].Selected=!0,this.PushValue(this.Options[i],j,"Setting");return}if(this.Options[i].Type=="parametric"){for(var j=0;j<this.Options[i].Handles.length;j++)if(this.Options[i].HandleRoll[j]){this.Options[i].Handles[j].Selected=!0,this.HandleSet(i,j,0,this.Options[i].Size.height*.8,mx,my),this.Options[i].PlotGraph();break}for(var j=0;j<this.Options[i].SubHandles.length;j++)if(this.Options[i].SubHandleRoll[j]){this.Options[i].SubHandles[j].Selected=!0,this.SubHandleSet(this.Options[i].SubHandles[j],this.Options[i].Handles[j].Position.x,mx),this.Options[i].PlotGraph();break}}if(this.Options[i].Type=="sample"){if(this.Options[i].HandleRoll[0]){this.Sketch.SoundcloudPanel.OpenPanel();return}if(this.Options[i].HandleRoll[1]&&this.Options[i].Permalink!==""){window.open(""+this.Options[i].Permalink,"_blank");return}}if(this.Options[i].Type=="samplelocal"&&this.Options[i].HandleRoll[0]){var val=0;this.SelectedBlock.SetParam(this.Options[i].Setting,val);return}if(this.Options[i].Type=="actionbutton"&&this.Options[i].HandleRoll[0]){var val=0;this.SelectedBlock.SetParam(this.Options[i].Setting,val);return}}this._PanelCloseRoll&&this.Close()},OptionsPanel.prototype.MouseUp=function(){for(var i=0;i<this.Options.length;i++){this.Options[i].Selected=!1;if(this.Options[i].Type=="ADSR"||this.Options[i].Type=="waveregion")for(var j=0;j<this.Options[i].Handles.length;j++)this.Options[i].Handles[j].Selected=!1;if(this.Options[i].Type=="parametric")for(var j=0;j<this.Options[i].Handles.length;j++)this.Options[i].Handles[j].Selected=!1,this.Options[i].SubHandles[j].Selected=!1}this._DrawReady=!0},OptionsPanel.prototype.MouseMove=function(mx,my){this.RolloverCheck(mx,my);for(var i=0;i<this.Options.length;i++){(this.Options[i].Type=="slider"||this.Options[i].Type=="waveslider")&&this.Options[i].Selected&&this.SliderSet(i,mx);if(this.Options[i].Type=="ADSR"){var xStart=[0,this.Options[i].Handles[0].Position.x,this.Range*.6];for(var j=0;j<this.Options[i].Handles.length;j++)this.Options[i].Handles[j].Selected&&this.HandleSet(i,j,xStart[j],this.Options[i].Size.height*.9,mx,my)}if(this.Options[i].Type=="waveregion"){for(var j=0;j<this.Options[i].Handles.length;j++){var handles=this.Options[i].Handles;handles[j].Selected&&this.HandleSet(i,j,0,this.Options[i].Size.height,mx,my)}handles[3].Position.x<handles[2].Position.x+1&&this.HandleSet(i,3,0,this.Options[i].Size.height,handles[2].Position.x+1+this.Position.x+this.Margin,my),handles[3].Position.x<handles[0].Position.x&&this.HandleSet(i,3,0,this.Options[i].Size.height,handles[0].Position.x+this.Position.x+this.Margin,my),handles[1].Position.x<handles[0].Position.x+1&&this.HandleSet(i,1,0,this.Options[i].Size.height,handles[0].Position.x+1+this.Position.x+this.Margin,my)}if(this.Options[i].Type=="parametric"){for(var j=0;j<this.Options[i].Handles.length;j++)this.Options[i].Handles[j].Selected&&(this.HandleSet(i,j,0,this.Options[i].Size.height*.8,mx,my),this.Options[i].PlotGraph());for(var j=0;j<this.Options[i].SubHandles.length;j++)this.Options[i].SubHandles[j].Selected&&(this.SubHandleSet(this.Options[i].SubHandles[j],this.Options[i].Handles[j].Position.x,mx),this.Options[i].PlotGraph())}}},OptionsPanel.prototype.RolloverCheck=function(mx,my){var units=App.Unit;this.Hover=this.OutlineTest(new Point(mx,my));for(var i=0;i<this.Options.length;i++)if(this.Options[i].Type=="slider"||this.Options[i].Type=="waveslider")this._SliderRoll[i]=Dimensions.hitRect(this.Position.x+this.Margin-10*units,this.Position.y+this.Options[i].Position.y,this.Range+20*units,this.Options[i].Size.height,mx,my);else if(this.Options[i].Type=="ADSR")this.Options[i].HandleRoll[0]=Dimensions.hitRect(this.Position.x+this.Margin+this.Options[i].Handles[0].Position.x-10*units,this.Position.y+this.Options[i].Position.y+this.Options[i].Size.height*.1-10*units,20*units,20*units,mx,my),this.Options[i].HandleRoll[1]=Dimensions.hitRect(this.Position.x+this.Margin+this.Options[i].Handles[0].Position.x+this.Options[i].Handles[1].Position.x-10*units,this.Position.y+this.Options[i].Position.y+this.Options[i].Size.height*.9-this.Options[i].Handles[1].Position.y-10*units,20*units,20*units,mx,my),this.Options[i].HandleRoll[2]=Dimensions.hitRect(this.Position.x+this.Margin+this.Range*.6+this.Options[i].Handles[2].Position.x-10*units,this.Position.y+this.Options[i].Position.y+this.Options[i].Size.height*.9-10*units,20*units,20*units,mx,my);else if(this.Options[i].Type=="waveregion")for(var j=0;j<4;j++)!this.Options[i].Mode&&j>1||this.Options[i].Mode&&j==1?this.Options[i].HandleRoll[j]=!1:this.Options[i].HandleRoll[j]=Dimensions.hitRect(this.Position.x+this.Margin+this.Options[i].Handles[j].Position.x-10*units,this.Position.y+this.Options[i].Position.y,20*units,this.Options[i].Size.height,mx,my);else if(this.Options[i].Type=="switches")for(var j=0;j<this.Options[i].Switches.length;j++)this.Options[i].HandleRoll[j]=Dimensions.hitRect(this.Position.x+this.Margin+this.Options[i].Switches[j].Position.x,this.Position.y+this.Options[i].Position.y,this.Options[i].Switches[j].Size.width,this.Options[i].Size.height*.7,mx,my);else if(this.Options[i].Type=="buttons")for(var j=0;j<this.Options[i].Buttons.length;j++)this.Options[i].HandleRoll[j]=Dimensions.hitRect(this.Position.x+this.Margin+this.Options[i].Buttons[j].Position.x,this.Position.y+this.Options[i].Position.y,this.Options[i].Buttons[j].Size.width,this.Options[i].Size.height,mx,my);else if(this.Options[i].Type=="parametric")for(var j=0;j<this.Options[i].Handles.length;j++)this.Options[i].HandleRoll[j]=Dimensions.hitRect(this.Position.x+this.Margin+this.Options[i].Handles[j].Position.x-10*units,this.Position.y+this.Options[i].Position.y+this.Options[i].Size.height*.8-this.Options[i].Handles[j].Position.y-10*units,20*units,20*units,mx,my),j!==0&&j!==this.Options[i].Handles.length-1&&(this.Options[i].SubHandleRoll[j]=Dimensions.hitRect(this.Position.x+this.Margin+this.Options[i].Handles[j].Position.x-this.Options[i].SubHandles[j].Position.x-10*units,this.Position.y+this.Options[i].Position.y+this.Options[i].Size.height*.9-10*units,this.Options[i].SubHandles[j].Position.x*2+20*units,20*units,mx,my));else this.Options[i].Type=="sample"?(this.Options[i].HandleRoll[0]=Dimensions.hitRect(this.Position.x+this.Margin+this.Range*.65,this.Position.y+this.Options[i].Position.y,this.Range*.35,this.Options[i].Size.height,mx,my),this.Options[i].HandleRoll[1]=Dimensions.hitRect(this.Position.x+this.Margin+this.Range*.5,this.Position.y+this.Options[i].Position.y,this.Range*.15,this.Options[i].Size.height,mx,my)):this.Options[i].Type=="samplelocal"?this.Options[i].HandleRoll[0]=Dimensions.hitRect(this.Position.x+this.Margin+this.Range*.65,this.Position.y+this.Options[i].Position.y,this.Range*.35,this.Options[i].Size.height,mx,my):this.Options[i].Type=="actionbutton"&&(this.Options[i].HandleRoll[0]=Dimensions.hitRect(this.Position.x+this.Margin+this.Range*.25,this.Position.y+this.Options[i].Position.y,this.Range*.5,this.Options[i].Size.height,mx,my));this.Scale==1&&(this._PanelCloseRoll=Dimensions.hitRect(this.Position.x+this.Size.width-30*units,this.Position.y-this.Size.height*.5-10*units,20*units,20*units,mx,my))},OptionsPanel.prototype.OutlineTest=function(point){this.Ctx.beginPath(),this.Ctx.moveTo(this.Position.x+this.Outline[0].x,this.Position.y+this.Outline[0].y);for(var i=1;i<this.Outline.length;i++)this.Ctx.lineTo(this.Position.x+this.Outline[i].x,this.Position.y+this.Outline[i].y);return this.Ctx.closePath(),this.Ctx.isPointInPath(point.x,point.y)},OptionsPanel.prototype.HandleSet=function(n,h,xStart,yRange,mx,my){var mPosX=mx-(this.Position.x+this.Margin+xStart),mPosY=my-(this.Position.y+this.Options[n].Position.y+yRange);this.Options[n].Handles[h].Position.x=mPosX,this.Options[n].Handles[h].Position.y=-mPosY,this.Options[n].Handles[h].Position.x=this.ValueInRange(this.Options[n].Handles[h].Position.x,0,this.Options[n].Handles[h].XRange),this.Options[n].Handles[h].Position.y=this.ValueInRange(this.Options[n].Handles[h].Position.y,0,this.Options[n].Handles[h].YRange);var log=!1;this.Options[n].Handles[h].Log==1&&(log=!0);var xlog=!1;this.Options[n].Handles[h].XLog==1&&(xlog=!0);var ylog=!1;this.Options[n].Handles[h].YLog==1&&(ylog=!0),this.UpdateValue(this.Options[n].Handles[h],"XValue","XMin","XMax",0,this.Options[n].Handles[h].XRange,"XSetting","x",xlog),this.Options[n].Handles[h].YSetting!==""&&this.UpdateValue(this.Options[n].Handles[h],"YValue","YMin","YMax",0,this.Options[n].Handles[h].YRange,"YSetting","y",ylog)},OptionsPanel.prototype.SubHandleSet=function(handle,origin,mx){var mPosX=mx-(this.Position.x+this.Margin+origin);mPosX<0&&(mPosX=-mPosX),handle.Position.x=mPosX,handle.Position.x=this.ValueInRange(handle.Position.x,handle.RangeMin,handle.RangeMax),this.UpdateValue(handle,"Value","Min","Max",handle.RangeMin,handle.RangeMax,"Setting","x",!0)},OptionsPanel.prototype.SliderSet=function(n,mx){var mPos=mx-(this.Position.x+this.Margin);this.Options[n].Position.x=mPos,this.Options[n].Position.x=this.ValueInRange(this.Options[n].Position.x,0,this.Range);var log=!1;this.Options[n].Log==1&&(log=!0),this.UpdateValue(this.Options[n],"Value","Min","Max",0,this.Range,"Setting","x",log)},OptionsPanel.prototype.UpdateValue=function(object,value,min,max,rangemin,rangemax,setting,axis,log){this._DrawReady=!0,log==1?object[""+value]=this.logValue(rangemin,rangemax,object[""+min],object[""+max],object.Position[""+axis]):object[""+value]=this.linValue(rangemin,rangemax,object[""+min],object[""+max],object.Position[""+axis]),object.Quantised&&(object[""+value]=Math.round(object[""+value]),log==1?object.Position[""+axis]=this.logPosition(rangemin,rangemax,object[""+min],object[""+max],object[""+value]):object.Position[""+axis]=this.linPosition(rangemin,rangemax,object[""+min],object[""+max],object[""+value])),this.SelectedBlock.SetParam(object[""+setting],object[""+value]),this._Name.toUpperCase()=="GRANULAR"&&""+object[""+setting]=="spread"&&this.UpdateOptions()},OptionsPanel.prototype.SwitchValue=function(object,value,setting){this._DrawReady=!0,object[""+value]=!object[""+value];var val=0;object[""+value]&&(val=1),this.SelectedBlock.SetParam(object[""+setting],val)},OptionsPanel.prototype.PushValue=function(object,value,setting){this._DrawReady=!0,this.SelectedBlock.SetParam(object[""+setting],value)},OptionsPanel.prototype.ValueInRange=function(value,floor,ceiling){return value<floor&&(value=floor),value>ceiling&&(value=ceiling),value},OptionsPanel.prototype.logValue=function(minpos,maxpos,minval,maxval,position){var minlval=Math.log(minval),maxlval=Math.log(maxval),scale=(maxlval-minlval)/(maxpos-minpos);return Math.exp((position-minpos)*scale+minlval)},OptionsPanel.prototype.logPosition=function(minpos,maxpos,minval,maxval,value){var minlval=Math.log(minval),maxlval=Math.log(maxval),scale=(maxlval-minlval)/(maxpos-minpos);return minpos+(Math.log(value)-minlval)/scale},OptionsPanel.prototype.linValue=function(minpos,maxpos,minval,maxval,position){var scale=(maxval-minval)/(maxpos-minpos);return(position-minpos)*scale+minval},OptionsPanel.prototype.linPosition=function(minpos,maxpos,minval,maxval,value){var scale=(maxval-minval)/(maxpos-minpos);return minpos+(value-minval)/scale},OptionsPanel}(DisplayObject);exports.OptionsPanel=OptionsPanel});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/ParticleEmitter",["require","exports","./PowerSource"],function(require,exports,PowerSource_1){var Vector=Utils.Maths.Vector,Point=etch.primitives.Point,ParticleEmitter=function(_super){__extends(ParticleEmitter,_super);function ParticleEmitter(){_super.apply(this,arguments),this._emittable=!0}return ParticleEmitter.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Power.Blocks.ParticleEmitter.name,this.Defaults={angle:-90,speed:3,rate:80,range:600,selfPoweredMode:!1},this.PopulateParams(),this._rateCounter=0,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-2,0),new Point(-1,0),new Point(0,-1),new Point(1,0),new Point(2,0),new Point(0,2))},ParticleEmitter.prototype.EmitParticle=function(){if(this._emittable){var position=App.Metrics.ConvertGridUnitsToAbsolute(this.Position),vector=Vector.fromAngle(Math.degreesToRadians(this.Params.angle));vector.mult(this.Params.speed);var size=2+Math.random(),life=Math.round(this.Params.range/this.Params.speed),p=App.ParticlesPool.GetObject();p.Position=position,p.Vector=vector,p.Life=life,p.Size=size,App.Particles.push(p),this._emittable=!1}},ParticleEmitter.prototype.Update=function(){_super.prototype.Update.call(this),this.Params.selfPoweredMode||this.IsPowered()?this._rateCounter!==undefined&&(this._rateCounter+=1,this._rateCounter>=this.Params.rate&&(this.EmitParticle(),this._rateCounter=0),this.Params.angle>360&&(this.Params.angle=1)):this._rateCounter=this.Params.rate,this._emittable=!0},ParticleEmitter.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},ParticleEmitter.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Particle Emitter",parameters:[{type:"slider",name:"Angle",setting:"angle",props:{value:this.Params.angle+90,min:-180,max:180,quantised:!0,centered:!0}},{type:"slider",name:"Fire Rate",setting:"rate",props:{value:510-this.Params.rate,min:1,max:500,quantised:!0,centered:!1}},{type:"slider",name:"P. Speed",setting:"speed",props:{value:this.Params.speed,min:1,max:12,quantised:!1,centered:!1}},{type:"slider",name:"Range",setting:"range",props:{value:this.Params.range,min:50,max:2e3,quantised:!0,centered:!1}}]}},ParticleEmitter.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="angle"?val=value-90:param=="rate"&&(val=510-value),this.Params[""+param]=val},ParticleEmitter}(PowerSource_1.PowerSource);exports.ParticleEmitter=ParticleEmitter});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("ParticleLayer",["require","exports","./Blocks/Power/Logic/Logic","./Blocks/Power/ParticleEmitter","./Blocks/Source","./Blocks/Power/Void"],function(require,exports,Logic_1,ParticleEmitter_1,Source_1,Void_1){var DisplayObject=etch.drawing.DisplayObject,ParticleLayer=function(_super){__extends(ParticleLayer,_super);function ParticleLayer(){_super.apply(this,arguments)}return ParticleLayer.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo)},ParticleLayer.prototype.Update=function(){App.Particles.length&&this.UpdateParticles()},ParticleLayer.prototype.UpdateParticles=function(){var currentParticles=[];for(var i=0;i<App.Particles.length;i++){var particle=App.Particles[i];particle.Life-=1;if(particle.Life<1){particle.Reset(),particle.ReturnToPool();continue}this.ParticleCollision(App.Metrics.FloatOnGrid(particle.Position),particle),particle.Move(),currentParticles.push(particle)}App.Particles=currentParticles},ParticleLayer.prototype.ParticleCollision=function(point,particle){for(var i=App.Blocks.length-1;i>=0;i--){var block=App.Blocks[i];if(block instanceof ParticleEmitter_1.ParticleEmitter)continue;var quadCheck=this.QuadPartition(particle.Position,App.Metrics.ConvertGridUnitsToAbsolute(block.Position),particle.Vector);if(!quadCheck)continue;if(block instanceof Void_1.Void&&block.HitTest(point)){particle.Dispose();return}if(block instanceof Logic_1.Logic||block instanceof Source_1.Source)if(block.HitTest(point)){block.ParticleCollision(particle);return}}},ParticleLayer.prototype.QuadPartition=function(particle,target,vector){var margin=App.ScaledGridSize*2;return vector.Y<0&&target.y>particle.y+margin?!1:vector.Y>0&&target.y<particle.y-margin?!1:vector.X<0&&target.x>particle.x+margin?!1:vector.X>0&&target.x<particle.x-margin?!1:!0},ParticleLayer.prototype.Draw=function(){for(var i=0;i<App.Particles.length;i++){var particle=App.Particles[i],pos=App.Metrics.FloatOnGrid(particle.Position),unit=App.ScaledUnit,sx=pos.x,sy=pos.y,size=particle.Size*unit;App.FillColor(this.Ctx,App.Palette[App.ThemeManager.Power]),this.Ctx.globalAlpha=1,this.Ctx.beginPath(),this.Ctx.moveTo(sx-size,sy),this.Ctx.lineTo(sx,sy-size),this.Ctx.lineTo(sx+size,sy),this.Ctx.lineTo(sx,sy+size),this.Ctx.closePath(),this.Ctx.fill()}},ParticleLayer}(DisplayObject);exports.ParticleLayer=ParticleLayer}),define("Core/Audio/Components/SignalToValue",["require","exports"],function(require,exports){var SignalToValue=function(){function SignalToValue(){this._Channels=1,this._Smoothing=0,this._ClipMemory=0,this._Value=0,this.Signal=new Tone.Signal,this._Meter=new Tone.Meter(this._Channels,this._Smoothing,this._ClipMemory),this.Signal.connect(this._Meter)}return SignalToValue.prototype.UpdateValue=function(){var meter=this._Meter.getValue();return meter===0?this._Value=0:this._Value=(meter-1)*2,this._Value},SignalToValue}();exports.SignalToValue=SignalToValue});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/SamplerBase",["require","exports","../Source","../../Core/Audio/Components/SignalToValue"],function(require,exports,Source_1,SignalToValue_1){var SamplerBase=function(_super){__extends(SamplerBase,_super);function SamplerBase(){_super.apply(this,arguments)}return SamplerBase.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.CreateSource(),this.CreateFirstVoice(),this.PlaybackSignal=new SignalToValue_1.SignalToValue},SamplerBase.prototype.CreateSource=function(){var _this=this;this.Sources.push(new Tone.Simpler),this.Sources.forEach(function(s,i){s.player.loop=_this.Params.loop,s.player.loopStart=_this.Params.loopStart,s.player.loopEnd=_this.Params.loopEnd,i>0&&(s.player.buffer=_this.Sources[0].player.buffer)});if(this.Sources[this.Sources.length-1])return this.Sources[this.Sources.length-1]},SamplerBase.prototype.GetDuration=function(buffer){return buffer?buffer.duration:0},SamplerBase.prototype.Update=function(){_super.prototype.Update.call(this);if(this.PlaybackSignal){var value=this.PlaybackSignal.UpdateValue();value!==0?(this.Params.detune=value,this.NoteUpdate()):this.Params.detune=0}},SamplerBase.prototype.TriggerAttack=function(index){var _this=this;index===void 0&&(index=0),index==="all"?this.Sources.forEach(function(s){s.triggerAttack(_this.Params.startPosition,_this.Params.endPosition-_this.Params.startPosition)}):this.Sources[index].triggerAttack(this.Params.startPosition,this.Params.endPosition-this.Params.startPosition)},SamplerBase.prototype.TriggerAttackRelease=function(index,duration){var _this=this;index===void 0&&(index=0),duration===void 0&&(duration=App.Config.PulseLength),index==="all"?this.Sources.forEach(function(s){s.triggerAttackRelease(duration,_this.Params.startPosition,_this.Params.endPosition-_this.Params.startPosition)}):this.Sources[index].triggerAttackRelease(duration,this.Params.startPosition,this.Params.endPosition-this.Params.startPosition)},SamplerBase.prototype.TriggerRelease=function(index,forceRelease){index===void 0&&(index=0),index==="all"?this.Sources.forEach(function(s){s.triggerRelease()}):this.Sources[index].triggerRelease()},SamplerBase.prototype.MouseUp=function(){this.FirstSetup(),_super.prototype.MouseUp.call(this)},SamplerBase.prototype.FirstSetup=function(){},SamplerBase.prototype.LoadTrack=function(track,fullUrl){},SamplerBase.prototype.ReverseTrack=function(){var _this=this;this.WaveForm=[],this.RefreshOptionsPanel("animate"),App.AnimationsLayer.AddToList(this);if(this.ReverseBuffer){this.SwitchBuffer();return}var sourceBuffer;this.PrimaryBuffer.buffer?sourceBuffer=this.PrimaryBuffer.buffer:this.PrimaryBuffer._buffer?sourceBuffer=this.PrimaryBuffer._buffer:sourceBuffer=this.PrimaryBuffer,setTimeout(function(){App.Audio.ReverseBuffer(_this.Id,sourceBuffer)},20)},SamplerBase.prototype.SwitchBuffer=function(){var sourceBuffer;this.Params.reverse?sourceBuffer=this.ReverseBuffer.buffer:this.PrimaryBuffer.buffer?sourceBuffer=this.PrimaryBuffer.buffer:this.PrimaryBuffer._buffer?sourceBuffer=this.PrimaryBuffer._buffer:sourceBuffer=this.PrimaryBuffer,this.Sources.forEach(function(s){s.player.buffer=sourceBuffer}),this.RetriggerActiveVoices(),App.AnimationsLayer.RemoveFromList(this),this.WaveForm=App.Audio.Waveform.GetWaveformFromBuffer(sourceBuffer,200,5,95),this.RefreshOptionsPanel()},SamplerBase.prototype.SetReversedBuffer=function(buffer){var _this=this;this.ReverseBuffer=App.Audio.ctx.createBufferSource(),this.ReverseBuffer.buffer=App.Audio.ctx.createBuffer(buffer.length,buffer[0].length,44100);for(var i=0;i<buffer.length;i++)this.ReverseBuffer.buffer.copyToChannel(buffer[i],i,0);this.Sources.forEach(function(s){s.player.buffer=_this.ReverseBuffer.buffer}),this.RetriggerActiveVoices(),App.AnimationsLayer.RemoveFromList(this),this.WaveForm=App.Audio.Waveform.GetWaveformFromBuffer(this.ReverseBuffer.buffer,200,5,95),this.RefreshOptionsPanel()},SamplerBase.prototype.Dispose=function(){_super.prototype.Dispose.call(this),this.Sources.forEach(function(s){s.dispose()}),this.Envelopes.forEach(function(e){e.dispose()})},SamplerBase}(Source_1.Source);exports.SamplerBase=SamplerBase});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/Recorder",["require","exports","./SamplerBase"],function(require,exports,SamplerBase_1){var Point=etch.primitives.Point,Recorder=function(_super){__extends(Recorder,_super);function Recorder(){_super.apply(this,arguments),this.IsRecording=!1}return Recorder.prototype.Init=function(drawTo){var _this=this;this.BlockName=App.L10n.Blocks.Source.Blocks.Recorder.name,this.Defaults={playbackRate:0,detune:0,reverse:!1,startPosition:0,endPosition:0,loop:!0,loopStart:0,loopEnd:0,volume:20,track:null,trackName:"",permalink:""},this.PopulateParams(),this.WaveForm=[],_super.prototype.Init.call(this,drawTo),this.PrimaryBuffer=App.Audio.ctx.createBufferSource(),this.Recorder=new RecorderJS(App.Audio.Master,{workerPath:App.Config.RecorderWorkerPath}),this.Envelopes.forEach(function(e,i){e=_this.Sources[i].envelope}),this.Sources.forEach(function(s){s.connect(_this.AudioInput),s.volume.value=_this.Params.volume}),this.Filename="BlokdustRecording.wav",this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,-1),new Point(2,0),new Point(2,1),new Point(1,2))},Recorder.prototype.Update=function(){_super.prototype.Update.call(this)},Recorder.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Recorder.prototype.ToggleRecording=function(){this.IsRecording?this.StopRecording():this.StartRecording()},Recorder.prototype.StartRecording=function(){this.Recorder.clear(),App.Message("Started Recording",{seconds:1}),this.IsRecording=!0,this.Recorder.record(),this.ReverseBuffer=null,this.Params.reverse=!1},Recorder.prototype.StopRecording=function(){this.Recorder.stop(),this.IsRecording=!1,App.Message("Stopped Recording",{seconds:1}),this.SetBuffers()},Recorder.prototype.SetBuffers=function(){var _this=this;this.Recorder.getBuffers(function(buffers){_this.PrimaryBuffer?_this.PrimaryBuffer&&_this.PrimaryBuffer.buffer!==null&&(_this.PrimaryBuffer=null,_this.PrimaryBuffer=App.Audio.ctx.createBufferSource()):_this.PrimaryBuffer=App.Audio.ctx.createBufferSource(),_this.PrimaryBuffer.buffer=App.Audio.ctx.createBuffer(1,buffers[0].length,44100),_this.PrimaryBuffer.buffer.getChannelData(0).set(buffers[0]),_this.PrimaryBuffer.buffer.getChannelData(0).set(buffers[1]),_this.UpdateWaveform(),_this.Sources.forEach(function(s){s.player.buffer=_this.PrimaryBuffer.buffer,s.player.loopStart=_this.Params.loopStart,s.player.loopEnd=_this.Params.loopEnd}),_this.RetriggerActiveVoices()})},Recorder.prototype.UpdateWaveform=function(){this.WaveForm=App.Audio.Waveform.GetWaveformFromBuffer(this.PrimaryBuffer.buffer,200,2,95);var duration=this.GetDuration();this.Params.startPosition=0,this.Params.endPosition=duration,this.Params.loopStart=duration*.5,this.Params.loopEnd=duration,this.RefreshOptionsPanel()},Recorder.prototype.GetDuration=function(){return this.PrimaryBuffer&&this.PrimaryBuffer.buffer!==null?this.PrimaryBuffer.buffer.duration:10},Recorder.prototype.DownloadRecording=function(){var _this=this;this.Recorder.exportWAV(function(blob){console.log("Downloading audio... Filename: "+_this.Filename+", Size: "+blob.size+" bytes"),_this.Recorder.setupDownload(blob,_this.Filename)})},Recorder.prototype.Dispose=function(){_super.prototype.Dispose.call(this),this.PrimaryBuffer=null,this.Recorder.clear(),this.Recorder=null,this.RecordedBlob=null},Recorder.prototype.CreateSource=function(){var _this=this;this.Sources.push(new Tone.Simpler(this.PrimaryBuffer)),this.Sources.forEach(function(s,i){s.player.loop=_this.Params.loop,s.player.loopStart=_this.Params.loopStart,s.player.loopEnd=_this.Params.loopEnd,s.volume.value=_this.Params.volume,i>0&&(s.player.buffer=_this.Sources[0].player.buffer)});if(this.Sources[this.Sources.length-1])return this.Sources[this.Sources.length-1]},Recorder.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Recorder",parameters:[{type:"waveregion",name:"Recording",setting:"region",props:{value:5,min:0,max:this.GetDuration(),quantised:!1,centered:!1,wavearray:this.WaveForm,mode:this.Params.loop,emptystring:"No Sample"},nodes:[{setting:"startPosition",value:this.Params.startPosition},{setting:"endPosition",value:this.Params.endPosition},{setting:"loopStart",value:this.Params.loopStart},{setting:"loopEnd",value:this.Params.loopEnd}]},{type:"switches",name:"Loop",setting:"loop",switches:[{name:"Reverse",setting:"reverse",value:this.Params.reverse,lit:!0,mode:"offOn"},{name:"Looping",setting:"loop",value:this.Params.loop,lit:!0,mode:"offOn"}]},{type:"slider",name:"playback",setting:"playbackRate",props:{value:this.Params.playbackRate,min:-App.Config.PlaybackRange,max:App.Config.PlaybackRange,quantised:!1,centered:!0}},{type:"actionbutton",name:"",setting:"download",props:{text:"Download Recording"}}]}},Recorder.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;switch(param){case"playbackRate":this.Params.playbackRate=value,this.NoteUpdate();break;case"reverse":value=value?!0:!1,this.Params[param]=val,this.ReverseTrack();break;case"loop":value=value?!0:!1,this.Sources.forEach(function(s){s.player.loop=value}),value===!0&&this.IsPowered()&&this.Sources.forEach(function(s){s.player.stop(),s.player.start(s.player.startPosition)}),this.Params[param]=val,this.RefreshOptionsPanel();break;case"loopStart":this.Sources.forEach(function(s){s.player.loopStart=value});break;case"loopEnd":this.Sources.forEach(function(s){s.player.loopEnd=value});break;case"download":this.PrimaryBuffer.buffer===null?App.Message("This block doesn't have a recording to download yet."):this.DownloadRecording()}this.Params[param]=val},Recorder}(SamplerBase_1.SamplerBase);exports.Recorder=Recorder});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/RecorderPanel",["require","exports","../Blocks/Sources/Recorder"],function(require,exports,Recorder_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,RecorderPanel=function(_super){__extends(RecorderPanel,_super);function RecorderPanel(){_super.apply(this,arguments)}return RecorderPanel.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this._Blocks=[],this._Roll=[],this.Hover=!1},RecorderPanel.prototype.Update=function(){var blocks=[];for(var i=0;i<App.Blocks.length;i++){var block=App.Blocks[i];block instanceof Recorder_1.Recorder&&blocks.push(block)}this._Blocks=blocks},RecorderPanel.prototype.Draw=function(){for(var i=0;i<this._Blocks.length;i++){var block=this._Blocks[i],myPos=App.Metrics.PointOnGrid(block.Position);this.DrawPanel(myPos.x,myPos.y,block.IsRecording,this._Roll[i])}},RecorderPanel.prototype.DrawPanel=function(x,y,rec,hover){var units=App.Unit,grd=App.GridSize,ctx=this.Ctx,w=grd*3,h=grd*3;App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.16,this.BGDraw(x,y+5*units,w,h,ctx),ctx.globalAlpha=.9,this.BGDraw(x,y,w,h,ctx),ctx.globalAlpha=1;var bw=grd;hover&&(bw=grd*1.1),rec?App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]):App.FillColor(ctx,App.Palette[13]),ctx.beginPath(),ctx.moveTo(x-bw,y-w*.5-h*.5),ctx.lineTo(x,y-w*.5-h*.5-bw),ctx.lineTo(x+bw,y-w*.5-h*.5),ctx.lineTo(x,y-w*.5-h*.5+bw),ctx.closePath(),ctx.fill(),rec?App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]):App.FillColor(ctx,App.Palette[12]),ctx.beginPath(),ctx.moveTo(x-bw,y-w*.5-h*.5),ctx.lineTo(x,y-w*.5-h*.5-bw),ctx.lineTo(x,y-w*.5-h*.5+bw),ctx.closePath(),ctx.fill()},RecorderPanel.prototype.BGDraw=function(x,y,w,h,ctx){ctx.beginPath(),ctx.moveTo(x,y),ctx.lineTo(x-w*.5,y-w*.5),ctx.lineTo(x-w*.5,y-w*.5-h),ctx.lineTo(x+w*.5,y-w*.5-h),ctx.lineTo(x+w*.5,y-w*.5),ctx.lineTo(x,y-w*.5),ctx.closePath(),ctx.fill()},RecorderPanel.prototype.MouseDown=function(point){this.RolloverCheck(point);for(var i=0;i<this._Blocks.length;i++)this._Roll[i]&&this._Blocks[i].ToggleRecording()},RecorderPanel.prototype.MouseMove=function(point){this.RolloverCheck(point)},RecorderPanel.prototype.RolloverCheck=function(point){this.Hover=!1;var grd=App.GridSize,w=grd*3,h=grd*3;for(var i=0;i<this._Blocks.length;i++){var block=this._Blocks[i],myPos=App.Metrics.PointOnGrid(block.Position);this._Roll[i]=Dimensions.hitRect(myPos.x-w*.5,myPos.y-w*.5-h,w,h,point.x,point.y),this._Roll[i]==1&&(this.Hover=!0)}},RecorderPanel}(DisplayObject);exports.RecorderPanel=RecorderPanel});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionColorTheme",["require","exports","./Option"],function(require,exports,Option_1){var ThemeSelector=function(_super){__extends(ThemeSelector,_super);function ThemeSelector(name){_super.call(this),this.Type="themeSelector",this.Name=name,this.HandleRoll=[]}return ThemeSelector.prototype.Draw=function(ctx,units,i,panel,yoveride){_super.prototype.Draw.call(this,ctx,units,i,panel);var width=panel.Range,height=60*units,x=panel.Margin,y=yoveride||0,dataType=Math.round(units*10);ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke()),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(App.ThemeManager.CurrentTheme.Name,x+width*.5-15*units,y+height*.5+6*units),ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+dataType*.4),ctx.beginPath(),ctx.moveTo(x+20*units,y+height*.5-20*units),ctx.lineTo(x,y+height*.5),ctx.lineTo(x+20*units,y+height*.5+20*units),ctx.moveTo(x+width-20*units,y+height*.5-20*units),ctx.lineTo(x+width,y+height*.5),ctx.lineTo(x+width-20*units,y+height*.5+20*units),ctx.stroke();var grd=App.GridSize*.5,dx=x+width*.5,dy=y+height*.5-grd*.5,startX=3;App.FillColor(ctx,App.Palette[0]),this.DrawDiamond(ctx,dx+grd*startX,dy),App.FillColor(ctx,App.Palette[1]),this.DrawDiamond(ctx,dx+grd*(startX+1),dy+grd),App.FillColor(ctx,App.Palette[3]),this.DrawDiamond(ctx,dx+grd*(startX+2),dy),App.FillColor(ctx,App.Palette[4]),this.DrawDiamond(ctx,dx+grd*(startX+3),dy+grd),App.FillColor(ctx,App.Palette[5]),this.DrawDiamond(ctx,dx+grd*(startX+4),dy),App.FillColor(ctx,App.Palette[6]),this.DrawDiamond(ctx,dx+grd*(startX+5),dy+grd),App.FillColor(ctx,App.Palette[7]),this.DrawDiamond(ctx,dx+grd*(startX+6),dy),App.FillColor(ctx,App.Palette[8]),this.DrawDiamond(ctx,dx+grd*(startX+7),dy+grd),App.FillColor(ctx,App.Palette[9]),this.DrawDiamond(ctx,dx+grd*(startX+8),dy),App.FillColor(ctx,App.Palette[10]),this.DrawDiamond(ctx,dx+grd*(startX+9),dy+grd),App.FillColor(ctx,App.Palette[14]),this.DrawDiamond(ctx,dx+grd*(startX+10),dy),App.StrokeColor(ctx,App.Palette[1]),ctx.beginPath(),ctx.moveTo(x+width*.5,y+5*units),ctx.lineTo(x+width*.5,y+height-5*units),ctx.stroke()},ThemeSelector.prototype.DrawDiamond=function(ctx,x,y){var grd=App.GridSize*.5;ctx.beginPath(),ctx.moveTo(x,y-grd),ctx.lineTo(x-grd,y),ctx.lineTo(x,y+grd),ctx.lineTo(x+grd,y),ctx.closePath(),ctx.fill()},ThemeSelector}(Option_1.Option);exports.ThemeSelector=ThemeSelector});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Options/OptionMeter",["require","exports","./Option"],function(require,exports,Option_1){var OptionMeter=function(_super){__extends(OptionMeter,_super);function OptionMeter(name){_super.call(this),this.Type="meter",this.Name=name,this.Level=0,this.Peak=0,this._Zero=0}return OptionMeter.prototype.Draw=function(ctx,units,i,panel,yoveride){_super.prototype.Draw.call(this,ctx,units,i,panel);var width=panel.Range,height=48*units,x=panel.Margin,y=yoveride||0,dataType=Math.round(units*10);this.Monitor(panel),ctx.globalAlpha=1,App.StrokeColor(ctx,App.Palette[1]),i!==panel.Options.length-1&&(ctx.beginPath(),ctx.moveTo(panel.Margin-units,y+height),ctx.lineTo(panel.Range+panel.Margin+units,y+height),ctx.stroke()),this.DiagonalFill(ctx,x+this._Zero,y+units,panel.Range-this._Zero,46*units,9),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtMid,ctx.textAlign="right",ctx.fillText(this.Name.toUpperCase(),panel.Margin-15*units,y+height*.5+dataType*.4);var bodyType=units*5;ctx.font="400 "+bodyType+"px PT Sans",ctx.textAlign="right",ctx.fillText("0dB",x+this._Zero-5*units,y+height*.5+2.5*units);var col=panel.SliderColours[i-Math.floor(i/panel.SliderColours.length)*panel.SliderColours.length];App.FillColor(ctx,col),ctx.fillRect(x-units,y+9*units,units+this.Level,30*units),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillRect(x+this.Peak-.5*units,y+9*units,units,30*units),ctx.beginPath(),ctx.moveTo(x+this.Peak-2*units,y+height*.5),ctx.lineTo(x+this.Peak,y+height*.5-2*units),ctx.lineTo(x+this.Peak+2*units,y+height*.5),ctx.lineTo(x+this.Peak,y+height*.5+2*units),ctx.closePath(),ctx.fill()},OptionMeter.prototype.Monitor=function(panel){App.Audio.Monitor();var min=-50,max=10;this.Level=panel.linPosition(0,panel.Range,min,max,App.Audio.Level),this.Level=panel.ValueInRange(this.Level,0,panel.Range),this._Zero=panel.linPosition(0,panel.Range,min,max,0),this.Level>this.Peak&&(this.Peak=this.Level)},OptionMeter.prototype.MonitorReset=function(){App.Audio.MonitorReset(),this.Peak=0},OptionMeter}(Option_1.Option);exports.OptionMeter=OptionMeter});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/SettingsPanel",["require","exports","../Device","./MenuCategory","./Options/OptionColorTheme","./../_Version","./Options/OptionSlider","./Options/OptionMeter","./Options/OptionActionButton"],function(require,exports,Device_1,MenuCategory_1,OptionColorTheme_1,_Version_1,OptionSlider_1,OptionMeter_1,OptionActionButton_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,Size=minerva.Size,SettingsPanel=function(_super){__extends(SettingsPanel,_super);function SettingsPanel(){_super.apply(this,arguments),this.MenuItems=[]}return SettingsPanel.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Open=!1,this.OffsetY=-this.DrawTo.Height,this._RollOvers=[],this.Height=60,this.MenuItems=[],this._MenuCols=App.ThemeManager.MenuOrder,this._OpenTab=0,this._VersionNumber=_Version_1.Version,this.Range=0,this.Margin=0,this.SliderColours=[],this.Options=[],this._OptionsRoll=[],this._Attribution=App.L10n.Attribution,this._Attribution.build=String.format(this._Attribution.build,this._VersionNumber),this.MenuJson={categories:[{name:"settings"},{name:"connect"},{name:"about"}]},this._CopyJson={guideLine:"Visit the BlokDust companion guide for an in depth Wiki, tutorials, news & more:",guideURL:"BlokDust Guide",copyLine:"Spread the word about BlokDust:",connectLine:"Connect with BlokDust elsewhere:",generateLine:"Randomise Title",facebook:"share on facebook",twitter:"share on twitter",google:"share on google +",bookmark:"bookmark creation",tweetText:"Browser-based music making with @blokdust - ",links:["FACEBOOK","TWITTER","YOUTUBE","GITHUB"],urls:["guide.blokdust.com","facebook.com/blokdust","twitter.com/blokdust","youtube.com/channel/UCukBbnIMiUZBbD4fJHrcHZQ","github.com/BlokDust/BlokDust"]},this.Populate(this.MenuJson)},SettingsPanel.prototype.Populate=function(json){var units=App.Unit,ctx=this.Ctx,dataType=units*10,gutter=60,menuCats=[];App.Metrics.Device!==Device_1.Device.desktop&&(gutter=40);var n=json.categories.length;ctx.font="400 "+dataType+"px Dosis",ctx.textAlign="left";var catWidth=[];if(App.Metrics.Device===Device_1.Device.mobile)var menuWidth=this.DrawTo.Width/7*5;else var menuWidth=this.DrawTo.Width/7*4;for(var i=0;i<n;i++)catWidth[i]=ctx.measureText(json.categories[i].name.toUpperCase()).width+gutter*units;var catX=this.DrawTo.Width*.5-menuWidth*.5;for(var i=0;i<n;i++){var name=json.categories[i].name.toUpperCase(),point=new Point(catX+catWidth[i]*.5,0),size=new Size(catWidth[i],16),offset=-this.DrawTo.Height;this._OpenTab===i&&(offset=0),menuCats[i]=new MenuCategory_1.MenuCategory(point,size,name,offset),catX+=catWidth[i]}this.MenuItems=menuCats,this.MenuItems[this._OpenTab].Selected=1,this._LinkWidth=[],this._LinksWidth=0;for(var i=0;i<this._CopyJson.links.length;i++)this._LinkWidth[i]=ctx.measureText(this._CopyJson.links[i]).width,this._LinksWidth+=this._LinkWidth[i];this.PopulateOptions()},SettingsPanel.prototype.Draw=function(){var ctx=this.Ctx,midType=App.Metrics.TxtMid,headType=App.Metrics.TxtHeader,largeType=App.Metrics.TxtLarge,urlType=App.Metrics.TxtUrl2,italicType2=App.Metrics.TxtItalic2,units=App.Unit,grid=App.GridSize,centerY=this.OffsetY+App.Height*.5,tabY=this.OffsetY;if(App.Metrics.Device===Device_1.Device.mobile)var menuWidth=this.DrawTo.Width/7*5;else var menuWidth=this.DrawTo.Width/7*4;var halfWidth=menuWidth*.5,dx=App.Width*.5,leftX=dx-halfWidth,pageY=tabY+120*units,tab;if(this.Open){App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.95,this.Open&&ctx.fillRect(0,this.OffsetY,App.Width,App.Height),ctx.globalAlpha=1;var closeY=tabY+30*units;ctx.lineWidth=2,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(dx+halfWidth+12.5*units,closeY-7.5*units),ctx.lineTo(dx+halfWidth+27.5*units,closeY+7.5*units),ctx.moveTo(dx+halfWidth+27.5*units,closeY-7.5*units),ctx.lineTo(dx+halfWidth+12.5*units,closeY+7.5*units),ctx.stroke();var gutter=40*units,thirdWidth=(menuWidth-gutter*2)/3,thirdY=pageY+130*units,x1=dx-halfWidth,x2=dx-halfWidth+thirdWidth+gutter,x3=dx-halfWidth+thirdWidth*2+gutter*2;App.Metrics.Device==Device_1.Device.desktop&&(ctx.textAlign="left",ctx.font=headType,ctx.fillText(this._Attribution.title.toUpperCase(),20*units,this.OffsetY+30*units+11*units)),ctx.save(),ctx.beginPath(),ctx.moveTo(dx-App.Width*.5,tabY+60*units),ctx.lineTo(dx+App.Width*.5,tabY+60*units),ctx.lineTo(dx+App.Width*.5,App.Height),ctx.lineTo(dx-App.Width*.5,App.Height),ctx.closePath(),ctx.clip(),tab=this.MenuItems[0].YOffset,this.Options[0].Draw(ctx,units,0,this,pageY+tab),this.Options[1].Draw(ctx,units,1,this,pageY+tab+60*units),this.Options[2].Draw(ctx,units,2,this,pageY+tab+108*units),this.Options[3].Draw(ctx,units,3,this,pageY+tab+156*units),tab=this.MenuItems[1].YOffset,App.FillColor(ctx,App.Palette[App.ThemeManager.MenuOrder[3]]),ctx.fillRect(dx-210*units,pageY+tab+10*units,420*units,40*units),this._RollOvers[7]&&(ctx.beginPath(),ctx.moveTo(dx,pageY+tab+59*units),ctx.lineTo(dx+10*units,pageY+tab+49*units),ctx.lineTo(dx-10*units,pageY+tab+49*units),ctx.closePath(),ctx.fill()),ctx.font=urlType,ctx.textAlign="center",App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillText(this._CopyJson.guideURL.toUpperCase(),dx,pageY+tab+39*units);var shareY=pageY+tab+155*units,elsewhereY=pageY+tab+110*units;ctx.fillStyle="#fc4742",ctx.fillRect(dx+80*units,shareY,130*units,30*units),this._RollOvers[10]&&(ctx.beginPath(),ctx.moveTo(dx+145*units,shareY+39*units),ctx.lineTo(dx+135*units,shareY+29*units),ctx.lineTo(dx+155*units,shareY+29*units),ctx.closePath(),ctx.fill()),ctx.fillStyle="#2db0e7",ctx.fillRect(dx-65*units,shareY,130*units,30*units),this._RollOvers[9]&&(ctx.beginPath(),ctx.moveTo(dx,shareY+39*units),ctx.lineTo(dx-10*units,shareY+29*units),ctx.lineTo(dx+10*units,shareY+29*units),ctx.closePath(),ctx.fill()),ctx.fillStyle="#2152ad",ctx.fillRect(dx-210*units,shareY,130*units,30*units),this._RollOvers[8]&&(ctx.beginPath(),ctx.moveTo(dx-145*units,shareY+39*units),ctx.lineTo(dx-135*units,shareY+29*units),ctx.lineTo(dx-155*units,shareY+29*units),ctx.closePath(),ctx.fill()),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.textAlign="center",ctx.font=italicType2,ctx.fillText(this._CopyJson.copyLine,dx,shareY-10*units),ctx.fillText(this._CopyJson.connectLine,dx,elsewhereY-25*units),ctx.fillText(this._CopyJson.guideLine,dx,pageY+tab),ctx.textAlign="center",ctx.font=midType,ctx.fillText(this._CopyJson.facebook.toUpperCase(),dx-145*units,shareY+18.5*units),ctx.fillText(this._CopyJson.twitter.toUpperCase(),dx,shareY+18.5*units),ctx.fillText(this._CopyJson.google.toUpperCase(),dx+145*units,shareY+18.5*units);var spacer=30*units,linkWidth=this._LinkWidth,linksWidth=this._LinksWidth+spacer*3;ctx.textAlign="left",ctx.fillText(this._CopyJson.links[0],dx-linksWidth*.5,elsewhereY),ctx.fillText(this._CopyJson.links[1],dx-linksWidth*.5+linkWidth[0]+spacer,elsewhereY),ctx.fillText(this._CopyJson.links[2],dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+spacer*2,elsewhereY),ctx.fillText(this._CopyJson.links[3],dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+linkWidth[2]+spacer*3,elsewhereY),App.StrokeColor(ctx,App.Palette[1]),ctx.beginPath(),ctx.moveTo(dx-linksWidth*.5+linkWidth[0]+spacer*.5,elsewhereY-15*units),ctx.lineTo(dx-linksWidth*.5+linkWidth[0]+spacer*.5,elsewhereY+10*units),ctx.moveTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+spacer*1.5,elsewhereY-15*units),ctx.lineTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+spacer*1.5,elsewhereY+10*units),ctx.moveTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+linkWidth[2]+spacer*2.5,elsewhereY-15*units),ctx.lineTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+linkWidth[2]+spacer*2.5,elsewhereY+10*units),ctx.stroke(),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=1,ctx.beginPath(),this._RollOvers[11]&&(ctx.moveTo(dx-linksWidth*.5,elsewhereY+2*units),ctx.lineTo(dx-linksWidth*.5+linkWidth[0],elsewhereY+2*units)),this._RollOvers[12]&&(ctx.moveTo(dx-linksWidth*.5+linkWidth[0]+spacer,elsewhereY+2*units),ctx.lineTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+spacer,elsewhereY+2*units)),this._RollOvers[13]&&(ctx.moveTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+spacer*2,elsewhereY+2*units),ctx.lineTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+linkWidth[2]+spacer*2,elsewhereY+2*units)),this._RollOvers[14]&&(ctx.moveTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+linkWidth[2]+spacer*3,elsewhereY+2*units),ctx.lineTo(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+linkWidth[2]+linkWidth[3]+spacer*3,elsewhereY+2*units)),ctx.stroke(),tab=this.MenuItems[2].YOffset,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=largeType,ctx.textAlign="left",this.WordWrap(ctx,this._Attribution.about,dx-halfWidth,pageY+tab,units*16,Math.ceil(menuWidth));var xs=[x1,x2,x3],widths=[],strings=[this._Attribution.twyman.url,this._Attribution.phillips.url,this._Attribution.silverton.url,this._Attribution.twyman.twitter,this._Attribution.phillips.twitter,this._Attribution.silverton.twitter];ctx.font=italicType2;for(var i=1;i<=strings.length;i++)widths.push(ctx.measureText(strings[i-1]).width);App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=1;for(var i=1;i<4;i++)this._RollOvers[i]&&(ctx.beginPath(),ctx.moveTo(xs[i-1],thirdY+44*units+tab),ctx.lineTo(xs[i-1]+widths[i-1],thirdY+44*units+tab),ctx.stroke()),this._RollOvers[i+3]&&(ctx.beginPath(),ctx.moveTo(xs[i-1],thirdY+58*units+tab),ctx.lineTo(xs[i-1]+widths[i+2],thirdY+58*units+tab),ctx.stroke());App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),this.WordWrap(ctx,this._Attribution.twyman.blurb,x1,thirdY+tab,units*14,Math.ceil(thirdWidth)),this.WordWrap(ctx,this._Attribution.phillips.blurb,x2,thirdY+tab,units*14,Math.ceil(thirdWidth)),this.WordWrap(ctx,this._Attribution.silverton.blurb,x3,thirdY+tab,units*14,Math.ceil(thirdWidth)),ctx.fillText(this._Attribution.twyman.url,x1,thirdY+42*units+tab),ctx.fillText(this._Attribution.phillips.url,x2,thirdY+42*units+tab),ctx.fillText(this._Attribution.silverton.url,x3,thirdY+42*units+tab),ctx.fillText(this._Attribution.twyman.twitter,x1,thirdY+56*units+tab),ctx.fillText(this._Attribution.phillips.twitter,x2,thirdY+56*units+tab),ctx.fillText(this._Attribution.silverton.twitter,x3,thirdY+56*units+tab);var blockY=thirdY-grid-10*units+tab;App.FillColor(ctx,App.Palette[4]),ctx.beginPath(),ctx.moveTo(x1,blockY-grid*3),ctx.lineTo(x1+grid,blockY-grid*3),ctx.lineTo(x1+grid*2,blockY-grid*2),ctx.lineTo(x1+grid,blockY-grid),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(x1+grid,blockY),ctx.lineTo(x1+grid*2,blockY-grid),ctx.lineTo(x1+grid*2,blockY),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[5]),ctx.beginPath(),ctx.moveTo(x2,blockY),ctx.lineTo(x2,blockY-grid),ctx.lineTo(x2+grid,blockY-grid*2),ctx.lineTo(x2+grid*3,blockY-grid*2),ctx.lineTo(x2+grid,blockY),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[7]),ctx.beginPath(),ctx.moveTo(x3,blockY),ctx.lineTo(x3+grid,blockY-grid*3),ctx.lineTo(x3+grid*2,blockY-grid*3),ctx.lineTo(x3+grid*2,blockY-grid),ctx.lineTo(x3+grid,blockY),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[3]),ctx.beginPath(),ctx.moveTo(x1,blockY),ctx.lineTo(x1,blockY-grid*3),ctx.lineTo(x1+grid,blockY-grid*2),ctx.lineTo(x1+grid,blockY-grid),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[10]),ctx.beginPath(),ctx.moveTo(x2,blockY),ctx.lineTo(x2,blockY-grid),ctx.lineTo(x2+grid,blockY-grid*2),ctx.lineTo(x2+grid,blockY),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(x2,blockY-grid*3),ctx.lineTo(x2+grid,blockY-grid*3),ctx.lineTo(x2,blockY-grid*2),ctx.closePath(),ctx.fill(),App.FillColor(ctx,App.Palette[9]),ctx.beginPath(),ctx.moveTo(x3,blockY),ctx.lineTo(x3,blockY-grid*2),ctx.lineTo(x3+grid,blockY-grid*3),ctx.lineTo(x3+grid,blockY-grid),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(x3+grid*2,blockY),ctx.lineTo(x3+grid*3,blockY),ctx.lineTo(x3+grid*3,blockY-grid),ctx.closePath(),ctx.fill(),ctx.restore(),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=largeType,ctx.textAlign="center",ctx.fillText("Chrome Recommended",App.Width*.5,this.OffsetY+this.DrawTo.Height-20*units),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(App.Width*.5-60*units,this.OffsetY+this.DrawTo.Height-27*units),ctx.lineTo(App.Width*.5-63.89*units,this.OffsetY+this.DrawTo.Height-20*units),ctx.lineTo(App.Width*.5-56.11*units,this.OffsetY+this.DrawTo.Height-20*units),ctx.closePath(),ctx.stroke(),ctx.font=italicType2,ctx.textAlign="right",ctx.fillText(this._Attribution.build,this.DrawTo.Width-20*units,this.OffsetY+this.DrawTo.Height-20*units),App.StrokeColor(ctx,App.Palette[1]),ctx.beginPath(),ctx.moveTo(dx-halfWidth,tabY+60*units-1),ctx.lineTo(dx+halfWidth,tabY+60*units-1);for(var i=0;i<this.MenuItems.length;i++){var cat=this.MenuItems[i],menuX=cat.Position.x;i>0&&(ctx.moveTo(Math.round(menuX-cat.Size.width*.5),tabY+16*units),ctx.lineTo(Math.round(menuX-cat.Size.width*.5),tabY+44*units))}ctx.stroke(),ctx.textAlign="center",ctx.font=midType;for(var i=0;i<this.MenuItems.length;i++){ctx.globalAlpha=1;var cat=this.MenuItems[i],col=this._MenuCols[i-Math.floor(i/this._MenuCols.length)*this._MenuCols.length];App.FillColor(ctx,App.Palette[col]),cat.Draw(ctx,units,this,tabY)}}},SettingsPanel.prototype.WordWrap=function(context,text,x,y,lineHeight,fitWidth){fitWidth=fitWidth||0;if(fitWidth<=0){context.fillText(text,x,y);return}var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),context.fillText(words.slice(0,idx-1).join(" "),x,y+lineHeight*currentLine),currentLine++,words=words.splice(idx-1),idx=1):idx++}idx>0&&context.fillText(words.join(" "),x,y+lineHeight*currentLine)},SettingsPanel.prototype.NumberWithCommas=function(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},SettingsPanel.prototype.DelayTo=function(panel,destination,t,delay,v){var offsetTween=new window.TWEEN.Tween({x:panel[""+v]});offsetTween.to({x:destination},t),offsetTween.onUpdate(function(){panel[""+v]=this.x}),offsetTween.onComplete(function(){v==="OffsetY"&&destination!==0&&(panel.Open=!1)}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick)},SettingsPanel.prototype.OpenPanel=function(){this.Open=!0,this.OffsetY=-this.DrawTo.Height,this.DelayTo(this,0,500,0,"OffsetY"),this.MenuItems[this._OpenTab].YOffset=0},SettingsPanel.prototype.ClosePanel=function(){this.DelayTo(this,-this.DrawTo.Height,500,0,"OffsetY")},SettingsPanel.prototype.PopulateOptions=function(){var optionList=[],optionY=[],optionNames=["Color Theme","Master Volume","DB Meter","Tour"],units=App.Unit,centerY=this.OffsetY+this.DrawTo.Height*.5,tabY=this.OffsetY,pageY=tabY+120*units,dx=this.DrawTo.Width*.5;if(App.Metrics.Device===Device_1.Device.mobile)var menuWidth=this.DrawTo.Width/7*5;else var menuWidth=this.DrawTo.Width/7*4;var halfWidth=menuWidth*.5,mw=0;this.Ctx.font=App.Metrics.TxtMid;for(var i=0;i<optionNames.length;i++){var nw=this.Ctx.measureText(optionNames[i].toUpperCase()).width;nw>mw&&(mw=nw)}var marginWidth=mw+15*units;this.Margin=dx-halfWidth+marginWidth,this.Range=menuWidth-marginWidth;var order=App.ThemeManager.OptionsOrder;this.SliderColours=[App.Palette[order[0]],App.Palette[order[1]],App.Palette[order[2]],App.Palette[order[3]],App.Palette[order[4]]],optionList.push(new OptionColorTheme_1.ThemeSelector(optionNames[0]));var sliderValue=App.Audio.Master.volume.value+70,sliderSetting="volume",sliderX=this.linPosition(0,this.Range,0,60,sliderValue),sliderO=this.Margin;optionList.push(new OptionSlider_1.Slider(new Point(sliderX,pageY+this.MenuItems[1].YOffset+60*units),new Size(1,48*App.Unit),sliderO,sliderValue,0,60,!0,optionNames[1],sliderSetting,!1)),optionList.push(new OptionMeter_1.OptionMeter(optionNames[2])),optionList.push(new OptionActionButton_1.OptionActionButton(new Point(0,pageY+this.MenuItems[1].YOffset+156*units),new Size(1,48*App.Unit),optionNames[3],"Launch Tutorial","tutorial")),this.Options=optionList},SettingsPanel.prototype.MouseDown=function(point){this.HitTests(point);if(this._RollOvers[0]){this.ClosePanel();return}if(this._OpenTab===0)for(var i=0;i<this.Options.length;i++)if(this._OptionsRoll[i]){this.Options[i].Selected=!0;if(this.Options[i].Type=="themeSelector"){var option=this.Options[i];option.HandleRoll[0]&&(App.ThemeManager.CurrentThemeNo-=1,App.ThemeManager.CurrentThemeNo<0&&(App.ThemeManager.CurrentThemeNo=App.ThemeManager.Themes.length-1),App.ThemeManager.LoadTheme(App.ThemeManager.CurrentThemeNo,!1)),option.HandleRoll[1]&&(App.ThemeManager.CurrentThemeNo+=1,App.ThemeManager.CurrentThemeNo>App.ThemeManager.Themes.length-1&&(App.ThemeManager.CurrentThemeNo=0),App.ThemeManager.LoadTheme(App.ThemeManager.CurrentThemeNo,!1))}this.Options[i].Type=="slider"&&this.SliderSet(i,point.x),this.Options[i].Type=="meter"&&this.Options[i].MonitorReset(),this.Options[i].Type=="actionbutton"&&this.Options[i].HandleRoll[0]&&this.ActionButton(this.Options[i].Setting)}for(var i=0;i<this.MenuItems.length;i++)if(this.MenuItems[i].Hover){window.TWEEN.removeAll();var cat=this.MenuItems[i];this.DelayTo(cat,1,400,0,"Selected"),this.DelayTo(cat,0,400,400,"YOffset"),this._OpenTab=i;for(var j=0;j<this.MenuItems.length;j++)if(j!==i){var cat=this.MenuItems[j];this.DelayTo(cat,0,250,0,"Selected"),this.DelayTo(cat,-this.DrawTo.Height,250,0,"YOffset")}return}if(this._OpenTab===1){var bdUrls=this._CopyJson.urls;this._RollOvers[7]&&window.open("http://"+bdUrls[0],"_blank"),this._RollOvers[8]&&this.ShareFacebook(),this._RollOvers[9]&&this.ShareTwitter(),this._RollOvers[10]&&this.ShareGoogle(),this._RollOvers[11]&&window.open("http://"+bdUrls[1],"_blank"),this._RollOvers[12]&&window.open("http://"+bdUrls[2],"_blank"),this._RollOvers[13]&&window.open("http://"+bdUrls[3],"_blank"),this._RollOvers[14]&&window.open("http://"+bdUrls[4],"_blank")}if(this._OpenTab===2){var urls=[this._Attribution.twyman.url,this._Attribution.phillips.url,this._Attribution.silverton.url,this._Attribution.twyman.twitter,this._Attribution.phillips.twitter,this._Attribution.silverton.twitter];for(var i=1;i<7;i++)this._RollOvers[i]&&(i>3?window.open("http://twitter.com/"+urls[i-1],"_blank"):window.open("http://"+urls[i-1],"_blank"))}},SettingsPanel.prototype.MouseMove=function(point){this.HitTests(point);for(var i=0;i<this.Options.length;i++)this.Options[i].Selected&&this.Options[i].Type=="slider"&&this.SliderSet(i,point.x)},SettingsPanel.prototype.HitTests=function(point){var units=App.Unit,centerY=this.OffsetY+this.DrawTo.Height*.5,tabY=this.OffsetY,pageY=tabY+120*units,closeY=tabY+30*units,dx=this.DrawTo.Width*.5;if(App.Metrics.Device===Device_1.Device.mobile)var menuWidth=this.DrawTo.Width/7*5;else var menuWidth=this.DrawTo.Width/7*4;var halfWidth=menuWidth*.5,gutter=40*units,thirdWidth=(menuWidth-gutter*2)/3,thirdY=pageY+130*units,x1=dx-halfWidth,x2=dx-halfWidth+thirdWidth+gutter,x3=dx-halfWidth+thirdWidth*2+gutter*2,xs=[x1,x2,x3],tab;this._RollOvers[0]=Dimensions.hitRect(dx+halfWidth,closeY-20*units,40*units,40*units,point.x,point.y);for(var i=1;i<4;i++)this._RollOvers[i]=Dimensions.hitRect(xs[i-1],thirdY+25*units+this.MenuItems[2].YOffset,thirdWidth,20*units,point.x,point.y),this._RollOvers[i+3]=Dimensions.hitRect(xs[i-1],thirdY+45*units+this.MenuItems[2].YOffset,thirdWidth,20*units,point.x,point.y);tab=this.MenuItems[1].YOffset,this._RollOvers[7]=Dimensions.hitRect(dx-210*units,pageY+tab+10*units,420*units,40*units,point.x,point.y),this._RollOvers[8]=Dimensions.hitRect(dx-210*units,pageY+tab+155*units,130*units,30*units,point.x,point.y),this._RollOvers[9]=Dimensions.hitRect(dx-65*units,pageY+tab+155*units,130*units,30*units,point.x,point.y),this._RollOvers[10]=Dimensions.hitRect(dx+80*units,pageY+tab+155*units,130*units,30*units,point.x,point.y);var spacer=30*units,linkWidth=this._LinkWidth,linksWidth=this._LinksWidth+spacer*3;this._RollOvers[11]=Dimensions.hitRect(dx-linksWidth*.5-spacer*.5,pageY+tab+90*units,linkWidth[0]+spacer,30*units,point.x,point.y),this._RollOvers[12]=Dimensions.hitRect(dx-linksWidth*.5+linkWidth[0]+spacer*.5,pageY+tab+90*units,linkWidth[1]+spacer,30*units,point.x,point.y),this._RollOvers[13]=Dimensions.hitRect(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+spacer*1.5,pageY+tab+90*units,linkWidth[2]+spacer,30*units,point.x,point.y),this._RollOvers[14]=Dimensions.hitRect(dx-linksWidth*.5+linkWidth[0]+linkWidth[1]+linkWidth[2]+spacer*2.5,pageY+tab+90*units,linkWidth[3]+spacer,30*units,point.x,point.y);for(var i=0;i<this.MenuItems.length;i++){var cat=this.MenuItems[i];cat.Hover=Dimensions.hitRect(cat.Position.x-cat.Size.width*.5+2*units,tabY+5*units,cat.Size.width-4*units,this.Height*units-10*units,point.x,point.y)}tab=this.MenuItems[0].YOffset;for(var i=0;i<this.Options.length;i++)this.Options[i].Type=="slider"&&(this._OptionsRoll[i]=Dimensions.hitRect(this.Margin-10*units,pageY+tab+60*units,this.Range+20*units,48*App.Unit,point.x,point.y)),this.Options[i].Type=="meter"&&(this._OptionsRoll[i]=Dimensions.hitRect(this.Margin-10*units,pageY+tab+108*units,this.Range+20*units,48*App.Unit,point.x,point.y)),this.Options[i].Type=="themeSelector"&&(this._OptionsRoll[i]=Dimensions.hitRect(this.Margin-10*units,pageY+tab,this.Range+20*units,60*App.Unit,point.x,point.y),this.Options[i].HandleRoll[0]=Dimensions.hitRect(this.Margin-10*units,pageY+tab,40*units,60*units,point.x,point.y),this.Options[i].HandleRoll[1]=Dimensions.hitRect(this.Margin+this.Range-30*units,pageY+tab,40*units,60*units,point.x,point.y)),this.Options[i].Type=="actionbutton"&&(this._OptionsRoll[i]=Dimensions.hitRect(this.Margin-10*units,pageY+tab+156*units,this.Range+20*units,48*App.Unit,point.x,point.y),this.Options[i].HandleRoll[0]=Dimensions.hitRect(this.Margin+this.Range*.25,pageY+tab+156*units,this.Range*.5,this.Options[i].Size.height,point.x,point.y))},SettingsPanel.prototype.MouseUp=function(point){for(var i=0;i<this.Options.length;i++)this.Options[i].Selected=!1},SettingsPanel.prototype.SliderSet=function(n,mx){var units=App.Unit,centerY=this.OffsetY+this.DrawTo.Height*.5,tabY=this.OffsetY,pageY=tabY+120*units,dx=this.DrawTo.Width*.5,menuWidth=this.DrawTo.Width/7*4,halfWidth=menuWidth*.5;this.Options[n].Position.x=mx-this.Margin,this.Options[n].Position.x=this.ValueInRange(this.Options[n].Position.x,0,this.Range);var log=!1;this.UpdateValue(this.Options[n],"Value","Min","Max",0,this.Range,"Setting","x",log)},SettingsPanel.prototype.ActionButton=function(setting){switch(setting){case"tutorial":this.ClosePanel(),App.MainScene.Tutorial.OpenSplash()}},SettingsPanel.prototype.UpdateValue=function(object,value,min,max,rangemin,rangemax,setting,axis,log){object[""+value]=this.linValue(rangemin,rangemax,object[""+min],object[""+max],object.Position[""+axis]),object.Quantised&&(object[""+value]=Math.round(object[""+value]),object.Position[""+axis]=this.linPosition(rangemin,rangemax,object[""+min],object[""+max],object[""+value]));var val=object[""+value];switch(object[""+setting]){case"volume":App.Audio.Master.volume.value=val-70,val===0&&(App.Audio.Master.volume.value=val-200)}},SettingsPanel.prototype.ShareFacebook=function(){var href="http://www.facebook.com/sharer.php?";href=""+href+"u=http://blokdust.com",window.open(href,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")},SettingsPanel.prototype.ShareTwitter=function(){var href="https://twitter.com/intent/tweet?text=";href=""+href+encodeURIComponent(this._CopyJson.tweetText),href=""+href+"&url=http://blokdust.com",window.open(href,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")},SettingsPanel.prototype.ShareGoogle=function(){var href="https://plus.google.com/share?url=";href=""+href+"http://blokdust.com",window.open(href,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")},SettingsPanel.prototype.ValueInRange=function(value,floor,ceiling){return value<floor&&(value=floor),value>ceiling&&(value=ceiling),value},SettingsPanel.prototype.linValue=function(minpos,maxpos,minval,maxval,position){var scale=(maxval-minval)/(maxpos-minpos);return(position-minpos)*scale+minval},SettingsPanel.prototype.linPosition=function(minpos,maxpos,minval,maxval,value){var scale=(maxval-minval)/(maxpos-minpos);return minpos+(value-minval)/scale},SettingsPanel.prototype.Resize=function(){},SettingsPanel}(DisplayObject);exports.SettingsPanel=SettingsPanel});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/SharePanel",["require","exports","../Device","./../Commands","./../Blocks/Sources/Recorder"],function(require,exports,Device_1,Commands_1,Recorder_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,SharePanel=function(_super){__extends(SharePanel,_super);function SharePanel(){_super.apply(this,arguments),this._Blink=0}return SharePanel.prototype.Init=function(drawTo){var _this=this;_super.prototype.Init.call(this,drawTo),this.Open=!1,this._FirstSession=!0,this._Saving=!1,this._Warning=!1,this._NoBlocks=!0,this._NameUrl="",this.SessionURL="",this._SessionId="",this.OffsetX=0,this.OffsetY=-this.DrawTo.Height,this._UrlSelecting=!1,this._RollOvers=[],this.TitleInputContainer=document.getElementById("shareTitle"),this.URLInputContainer=document.getElementById("shareUrl"),this.TitleInput=document.getElementById("shareTitleInput"),this.URLInput=document.getElementById("shareUrlText"),this.TitleInput.addEventListener("input",function(event){_this.TestString(_this.TitleInput),_this.UpdateString(_this.TitleInput)}),this.TitleInput.addEventListener("keydown",function(event){_this.EnterCheck(event)}),this._CommandManager=App.CommandManager,this._CopyJson={genUrl:"Generate share link",shareLine:"Made something cool? Generate your own unique link to share it with the world (we'd love to see):",copyLine:"Share your creation with this unique URL:",titleLine:"Title",generateLine:"Randomise Title",domain:this.GetUrl()+"?c=",facebook:"post to facebook",twitter:"post to twitter",subreddit:"post to BD subreddit",bookmark:"bookmark creation",save:"overwrite",saveAs:"create new",saving:"saving...",tweetText:"I made this @blokdust creation: "},App.SessionId&&(this._FirstSession=!1),App.CompositionId&&(this._SessionId=App.CompositionId),this.GetTitleFromUrl(),this.Resize()},SharePanel.prototype.GetUrl=function(){return[location.protocol,"//",location.host,location.pathname].join("")},SharePanel.prototype.GetTitleFromUrl=function(){var decoded=decodeURI(window.location.href),getName=decoded.split("&t=");getName.length>1?(this.UpdateFormText(this.TitleInput,getName[1]),this.TestString(this.TitleInput),this.UpdateString(this.TitleInput)):this.SessionTitle=this.GenerateLabel()},SharePanel.prototype.TestString=function(element){var caretPos=element.selectionStart;caretPos>0&&(caretPos-=1),/[.,\/#\?\"\'$Â£%\^&\*;:{|}<=>\\@\`\+~()]/.test(element.value)&&(element.value=element.value.replace(/[.,\/#\?\"\'$Â£%\^&\*;:{|}<=>\\@\`\+~()]/g,""),element.selectionStart=caretPos,element.selectionEnd=caretPos)},SharePanel.prototype.UpdateString=function(element){var string=element.value;this.SessionTitle=string,this.SetNameUrl(string),this.UpdateUrlText()},SharePanel.prototype.UpdateUrlText=function(){this.SessionURL=""+this._CopyJson.domain+this._SessionId+this._NameUrl,this.UpdateFormText(this.URLInput,this.SessionURL),this._SessionId&&App.AddressBarManager.UpdateURL(this.SessionURL)},SharePanel.prototype.SetNameUrl=function(string){this._NameUrl="&t="+encodeURI(this.Capitalise(string))},SharePanel.prototype.UpdateFormText=function(element,str){element.value=str},SharePanel.prototype.EnterCheck=function(e){var key=e.which||e.keyCode;key===13&&this.Submit()},SharePanel.prototype.Submit=function(){this.TitleInput.blur(),this.ClearScroll()},SharePanel.prototype.GetWarning=function(){var warnBlocks=[];for(var i=0;i<App.Blocks.length;i++){var block=App.Blocks[i];block instanceof Recorder_1.Recorder&&warnBlocks.push(block)}this._Warning=warnBlocks.length>0,this._NoBlocks=!App.Blocks.length},SharePanel.prototype.Draw=function(){var ctx=this.Ctx,midType=App.Metrics.TxtMid,headType=App.Metrics.TxtHeader,urlType=App.Metrics.TxtUrl2,italicType=App.Metrics.TxtItalic2,units=App.Unit,centerY=this.OffsetY+App.Height*.5,shareX=this.OffsetX+App.Width*1.5,buttonY=centerY+35*units,appWidth=App.Width,appHeight=App.Height;if(this.Open){App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.95,ctx.fillRect(0,this.OffsetY,appWidth,appHeight),ctx.globalAlpha=1,App.FillColor(ctx,App.Palette[1]),ctx.fillRect(shareX+appWidth*.5-210*units,centerY-20*units,420*units,40*units);var arrowX=275,arrowY=0;App.Metrics.Device===Device_1.Device.tablet&&(arrowX=245),App.Metrics.Device===Device_1.Device.mobile&&(arrowX=190,arrowY=110),this._FirstSession?(this._Saving||this._NoBlocks?App.FillColor(ctx,App.Palette[1]):App.FillColor(ctx,App.Palette[App.ThemeManager.MenuOrder[3]]),ctx.fillRect(this.OffsetX+appWidth*.5-210*units,centerY-20*units,420*units,40*units),this._RollOvers[3]&&!this._Saving&&(ctx.beginPath(),ctx.moveTo(this.OffsetX+appWidth*.5,centerY+29*units),ctx.lineTo(this.OffsetX+appWidth*.5-10*units,centerY+19*units),ctx.lineTo(this.OffsetX+appWidth*.5+10*units,centerY+19*units),ctx.closePath(),ctx.fill()),ctx.font=urlType,ctx.textAlign="center",App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillText(this._CopyJson.genUrl.toUpperCase(),this.OffsetX+appWidth*.5,centerY+9*units),ctx.font=italicType,ctx.textAlign="left",this.WordWrap(ctx,this._CopyJson.shareLine,this.OffsetX+appWidth*.5-210*units,centerY-59*units,14*units,210*units)):(this._Saving||this._NoBlocks?App.FillColor(ctx,App.Palette[1]):App.FillColor(ctx,App.Palette[App.ThemeManager.MenuOrder[3]]),ctx.fillRect(this.OffsetX+appWidth*.5-210*units,centerY-20*units,202.5*units,40*units),this._RollOvers[4]&&!this._Saving&&(ctx.beginPath(),ctx.moveTo(this.OffsetX+appWidth*.5-108.75*units,centerY+29*units),ctx.lineTo(this.OffsetX+appWidth*.5-118.75*units,centerY+19*units),ctx.lineTo(this.OffsetX+appWidth*.5-98.75*units,centerY+19*units),ctx.closePath(),ctx.fill()),this._Saving||this._NoBlocks?App.FillColor(ctx,App.Palette[1]):App.FillColor(ctx,App.Palette[App.ThemeManager.MenuOrder[1]]),ctx.fillRect(this.OffsetX+appWidth*.5+7.5*units,centerY-20*units,202.5*units,40*units),this._RollOvers[5]&&!this._Saving&&(ctx.beginPath(),ctx.moveTo(this.OffsetX+appWidth*.5+108.75*units,centerY+29*units),ctx.lineTo(this.OffsetX+appWidth*.5+118.75*units,centerY+19*units),ctx.lineTo(this.OffsetX+appWidth*.5+98.75*units,centerY+19*units),ctx.closePath(),ctx.fill()),ctx.font=urlType,ctx.textAlign="center",App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.fillText(this._CopyJson.save.toUpperCase(),this.OffsetX+appWidth*.5-108.75*units,centerY+9*units),ctx.fillText(this._CopyJson.saveAs.toUpperCase(),this.OffsetX+appWidth*.5+108.75*units,centerY+9*units),ctx.font=italicType,ctx.textAlign="left",this.WordWrap(ctx,this._CopyJson.shareLine,this.OffsetX+appWidth*.5-210*units,centerY-59*units,14*units,210*units),ctx.lineWidth=2,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(this.OffsetX+appWidth*.5+arrowX*units,centerY+(arrowY-20)*units),ctx.lineTo(this.OffsetX+appWidth*.5+(arrowX+20)*units,centerY+arrowY*units),ctx.lineTo(this.OffsetX+appWidth*.5+arrowX*units,centerY+(arrowY+20)*units),ctx.stroke(),ctx.font=midType,ctx.fillText("SKIP",this.OffsetX+appWidth*.5+arrowX*units,centerY+(arrowY+35)*units)),this._Saving?(ctx.font=midType,ctx.textAlign="center",ctx.fillText(this._CopyJson.saving.toUpperCase(),this.OffsetX+appWidth*.5,centerY+75*units),App.AnimationsLayer.DrawSprite(ctx,"loading",appWidth*.5,centerY+50*units,16,!0)):(this._Warning&&(ctx.font=italicType,ctx.textAlign="left",this.WordWrap(ctx,App.L10n.UI.SharePanel.SaveWarning,this.OffsetX+appWidth*.5-210*units,centerY+75*units,14*units,420*units)),this._NoBlocks&&(ctx.font=italicType,ctx.textAlign="left",this.WordWrap(ctx,App.L10n.UI.SharePanel.NoBlocks,this.OffsetX+appWidth*.5-210*units,centerY+75*units,14*units,420*units))),ctx.lineWidth=2,App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(shareX+appWidth*.5-arrowX*units,centerY+(arrowY-20)*units),ctx.lineTo(shareX+appWidth*.5-(arrowX+20)*units,centerY+arrowY*units),ctx.lineTo(shareX+appWidth*.5-arrowX*units,centerY+(arrowY+20)*units),ctx.stroke(),ctx.fillStyle="#fc4742",ctx.fillRect(shareX+appWidth*.5+80*units,buttonY,130*units,30*units),this._RollOvers[8]&&(ctx.beginPath(),ctx.moveTo(shareX+appWidth*.5+145*units,buttonY+39*units),ctx.lineTo(shareX+appWidth*.5+135*units,buttonY+29*units),ctx.lineTo(shareX+appWidth*.5+155*units,buttonY+29*units),ctx.closePath(),ctx.fill()),ctx.fillStyle="#2db0e7",ctx.fillRect(shareX+appWidth*.5-65*units,buttonY,130*units,30*units),this._RollOvers[7]&&(ctx.beginPath(),ctx.moveTo(shareX+appWidth*.5,buttonY+39*units),ctx.lineTo(shareX+appWidth*.5-10*units,buttonY+29*units),ctx.lineTo(shareX+appWidth*.5+10*units,buttonY+29*units),ctx.closePath(),ctx.fill()),ctx.fillStyle="#2152ad",ctx.fillRect(shareX+appWidth*.5-210*units,buttonY,130*units,30*units),this._RollOvers[6]&&(ctx.beginPath(),ctx.moveTo(shareX+appWidth*.5-145*units,buttonY+39*units),ctx.lineTo(shareX+appWidth*.5-135*units,buttonY+29*units),ctx.lineTo(shareX+appWidth*.5-155*units,buttonY+29*units),ctx.closePath(),ctx.fill()),App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.textAlign="left",ctx.font=midType,ctx.font=italicType,ctx.fillText(this._CopyJson.copyLine,shareX+appWidth*.5-210*units,centerY-33*units),ctx.textAlign="center",ctx.font=midType,ctx.fillText(this._CopyJson.facebook.toUpperCase(),shareX+appWidth*.5-145*units,buttonY+18.5*units),ctx.fillText(this._CopyJson.twitter.toUpperCase(),shareX+appWidth*.5,buttonY+18.5*units),ctx.fillText(this._CopyJson.subreddit.toUpperCase(),shareX+appWidth*.5+145*units,buttonY+18.5*units),App.Metrics.Device===Device_1.Device.mobile?(ctx.textAlign="left",ctx.fillText(this._CopyJson.titleLine.toUpperCase(),appWidth*.5-210*units,centerY-150*units)):(ctx.textAlign="right",ctx.fillText(this._CopyJson.titleLine.toUpperCase(),appWidth*.5-225*units,centerY-106*units)),ctx.beginPath(),ctx.moveTo(appWidth*.5-210*units,centerY-90*units),ctx.lineTo(appWidth*.5+210*units,centerY-90*units),ctx.stroke(),ctx.textAlign="left",ctx.font=headType;var titleW=ctx.measureText(this.SessionTitle.toUpperCase()).width;ctx.font=headType,ctx.fillText("SHARE",20*units,this.OffsetY+30*units+11*units),ctx.font=midType;var genW=ctx.measureText(this._CopyJson.generateLine.toUpperCase()).width;ctx.fillText(this._CopyJson.generateLine.toUpperCase(),appWidth*.5+205*units-genW,centerY-106*units),ctx.beginPath(),ctx.moveTo(appWidth*.5+210*units,centerY-120*units),ctx.lineTo(appWidth*.5+200*units-genW,centerY-120*units),ctx.lineTo(appWidth*.5+200*units-genW,centerY-100*units),ctx.lineTo(appWidth*.5+210*units,centerY-100*units),ctx.closePath(),ctx.stroke();var clx=230,cly=130;App.Metrics.Device===Device_1.Device.mobile&&(clx=202.5,cly=150),ctx.beginPath(),ctx.moveTo(appWidth*.5+(clx-7.5)*units,centerY-(cly-7.5)*units),ctx.lineTo(appWidth*.5+(clx+7.5)*units,centerY-(cly+7.5)*units),ctx.moveTo(appWidth*.5+(clx+7.5)*units,centerY-(cly-7.5)*units),ctx.lineTo(appWidth*.5+(clx-7.5)*units,centerY-(cly+7.5)*units),ctx.stroke()}},SharePanel.prototype.WordWrap=function(context,text,x,y,lineHeight,fitWidth){fitWidth=fitWidth||0;if(fitWidth<=0){context.fillText(text,x,y);return}var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),context.fillText(words.slice(0,idx-1).join(" "),x,y+lineHeight*currentLine),currentLine++,words=words.splice(idx-1),idx=1):idx++}idx>0&&context.fillText(words.join(" "),x,y+lineHeight*currentLine)},SharePanel.prototype.Capitalise=function(string){var s=string.toLowerCase();s=this.UppercaseAt(s,0);for(var i=0;i<s.length;i++)s.charAt(i)===" "&&(s=this.UppercaseAt(s,i+1));return s},SharePanel.prototype.UppercaseAt=function(str,index){if(index>str.length-1)return str;var chr=str.substr(index,1).toUpperCase();return str.substr(0,index)+chr+str.substr(index+1)},SharePanel.prototype.DelayTo=function(panel,destination,t,delay,v){var offsetTween=new window.TWEEN.Tween({x:panel[""+v]});offsetTween.to({x:destination},t),offsetTween.onUpdate(function(){panel[""+v]=this.x,v=="OffsetX"&&panel.TweenDom(panel.URLInputContainer,this.x,"x",200,1.5),v=="OffsetY"&&(panel.TweenDom(panel.URLInputContainer,this.x,"y",20,0),panel.TweenDom(panel.TitleInputContainer,this.x,"y",132,0))}),offsetTween.onComplete(function(){if(v=="OffsetY"){destination!==0&&(panel.Open=!1,panel.HideDom()),panel.OffsetX=0;var shareUrl=document.getElementById("shareUrl");shareUrl.style.left="1000%"}v=="OffsetX"&&panel._FirstSession&&(panel._FirstSession=!1)}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick)},SharePanel.prototype.GenerateLabel=function(){var label="",diceRoll,prefixA=["al","aal","blok","bjÃ¸r","brÃ¸","drÃ¸","du","ef","en","jen","ja","lek","lu","mal","svi","svar","sku","spru","kÃ¸","kin","kvi","kna","kvar","hof","tje","fja","ub","rÃ¸","vÃ¸","vol","va","ey","ly","sky","ske","skÃ¸","sji","yÃ¸","Ã¸"],syllableA=["jen","ke","kil","kol","kof","nÃ¸","ken","ren","re","rol","sen","se","sa","then","tol","te","ty","ple","pa","ka","y"],suffixA=["berg","holm","sorg","fla","trad","stad","mark","dt","de","s","kla","ken","kjen","gen","gan","likt","tra","tet","tal","man","la","tt","bb","na","k","ka","bÃ¸","dÃ¸","gÃ¸","jÃ¸","kÃ¸","lÃ¸","mÃ¸","nÃ¸","pÃ¸","sÃ¸","slÃ¸","tÃ¸","vÃ¸","lok","vik","slik","dust"],joinerA=["berg","sorg","fla","lag","tra","tet","tal","du","na","bÃ¸","dÃ¸","gÃ¸","jÃ¸","kÃ¸","lÃ¸","mÃ¸","nÃ¸","pÃ¸","sÃ¸","slÃ¸","tÃ¸","vÃ¸","lok","vik","dust","dok","blok"],prefixB=["al","aal","blok","bjÃ¶r","brÃ¶","drÃ¶","du","ef","en","jen","jÃ¤","lek","lÃ¼","mal","svi","svar","sku","spru","ko","kin","kvi","kna","kvÃ¤r","hÃ¶f","tje","fjÃ¤","ub","ro","vo","vol","vÃ¤","ey","ly","sky","ske","sko","sji","yÃ¶","Ã¶"],syllableB=["jen","ke","kil","kol","kof","nÃ¶","ken","ren","re","rol","sen","se","sa","then","tol","te","ty","ple","pa","ka","y"],suffixB=["berg","holm","sorg","fla","trÃ¤d","stÃ¤d","mark","dt","de","s","kla","ken","kjen","gen","gan","likt","tra","tet","tal","man","la","tt","bb","na","k","ka","bÃ¶","dÃ¶","gÃ¶","jÃ¶","kÃ¶","lÃ¶","mÃ¶","nÃ¶","pÃ¶","sÃ¶","slÃ¶","tÃ¶","vÃ¶","lok","vik","slik","dust"],joinerB=["berg","sorg","fla","lag","tra","tet","tal","dÃ¼","na","bÃ¶","dÃ¶","gÃ¶","jÃ¶","kÃ¶","lÃ¶","mÃ¶","nÃ¶","pÃ¶","sÃ¶","slÃ¶","tÃ¶","vÃ¶","lok","vik","dust","dok","blok"],prefixes=[prefixA,prefixB],syllables=[syllableA,syllableB],suffixes=[suffixA,suffixB],joiners=[joinerA,joinerB],dialect=Math.round(Math.random()),prefix=prefixes[dialect],syllable=syllables[dialect],suffix=suffixes[dialect],joiner=joiners[dialect];return label=""+label+prefix[Math.floor(Math.random()*prefix.length)],diceRoll=Math.floor(Math.random()*8),diceRoll==0&&(label=""+label+syllable[Math.floor(Math.random()*syllable.length)]),label=""+label+suffix[Math.floor(Math.random()*suffix.length)],diceRoll=Math.floor(Math.random()*10),diceRoll==0&&(label=""+label+" "+joiner[Math.floor(Math.random()*joiner.length)]),diceRoll=Math.floor(Math.random()*2),diceRoll!==0&&(label=""+label+" "+prefix[Math.floor(Math.random()*prefix.length)],diceRoll=Math.floor(Math.random()*5),diceRoll==0&&(label=""+label+syllable[Math.floor(Math.random()*syllable.length)]),label=""+label+suffix[Math.floor(Math.random()*suffix.length)]),this.SetNameUrl(label),this.UpdateFormText(this.TitleInput,label),this.UpdateUrlText(),label},SharePanel.prototype.OpenPanel=function(){this.Open=!0,this.OffsetY=-App.Height,this.GetWarning(),this.ShowDom(),this.DelayTo(this,0,500,0,"OffsetY")},SharePanel.prototype.ClosePanel=function(){this._Saving=!1,this.DelayTo(this,-App.Height,500,0,"OffsetY")},SharePanel.prototype.GenerateLink=function(){this._NoBlocks||(this._Saving=!0,this._CommandManager.ExecuteCommand(Commands_1.Commands.SAVE_AS))},SharePanel.prototype.UpdateLink=function(){this._NoBlocks||(this._Saving=!0,this._CommandManager.ExecuteCommand(Commands_1.Commands.SAVE))},SharePanel.prototype.ReturnLink=function(id){this._Saving=!1,this._SessionId=id,this.UpdateUrlText(),this.DelayTo(this,-(App.Width*1.5),500,0,"OffsetX")},SharePanel.prototype.ShareFacebook=function(){var href="http://www.facebook.com/sharer.php?u=";href=""+href+encodeURIComponent(this.SessionURL),window.open(href,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")},SharePanel.prototype.ShareTwitter=function(){var href="https://twitter.com/intent/tweet?text=";href=""+href+encodeURIComponent(this._CopyJson.tweetText),href=""+href+"&url="+encodeURIComponent(this.SessionURL),window.open(href,"","menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600")},SharePanel.prototype.ShareSubreddit=function(){var title=encodeURIComponent(Utils.Urls.getQuerystringParameterFromString("t",this.SessionURL)),url=encodeURIComponent(this.SessionURL),href="https://www.reddit.com/r/blokdust/submit?title="+title+"&url="+url;window.open(href,"ShareToBlokDustSubreddit")},SharePanel.prototype.MouseDown=function(point){this.HitTests(point);if(!this._RollOvers[0]){if(this._RollOvers[1]){this.ClosePanel();return}if(this._RollOvers[2]){this.SessionTitle=this.GenerateLabel();return}if(this._RollOvers[3]){this.GenerateLink();return}if(this._RollOvers[4]){this.UpdateLink();return}if(this._RollOvers[5]){this.GenerateLink();return}if(this._RollOvers[6]){this.ShareFacebook();return}if(this._RollOvers[7]){this.ShareTwitter();return}if(this._RollOvers[8]){this.ShareSubreddit();return}if(this._RollOvers[9]){this.DelayTo(this,0,500,0,"OffsetX");return}if(this._RollOvers[10]){this.DelayTo(this,-(App.Width*1.5),500,0,"OffsetX");return}this._UrlSelecting=!1}else this._UrlSelecting=!0},SharePanel.prototype.MouseUp=function(point,isTouch){},SharePanel.prototype.MouseMove=function(point){this.HitTests(point)},SharePanel.prototype.HitTests=function(point){var units=App.Unit,shareX=this.OffsetX+App.Width*1.5,centerY=this.OffsetY+App.Height*.5,buttonY=centerY+35*units,ctx=this.Ctx,midType=App.Metrics.TxtMid,appWidth=App.Width;ctx.font=midType;var genW=ctx.measureText(this._CopyJson.generateLine.toUpperCase()).width,clx=230,cly=130,arrowX=285,arrowY=0;App.Metrics.Device===Device_1.Device.tablet&&(arrowX=255),App.Metrics.Device===Device_1.Device.mobile&&(clx=202.5,cly=150,arrowX=200,arrowY=110),this._RollOvers[0]=Dimensions.hitRect(shareX+appWidth*.5-210*units,centerY-20*units,420*units,40*units,point.x,point.y),this._RollOvers[1]=Dimensions.hitRect(appWidth*.5+(clx-20)*units,centerY-(cly+20)*units,40*units,40*units,point.x,point.y),this._RollOvers[2]=Dimensions.hitRect(appWidth*.5+200*units-genW,centerY-130*units,genW+10*units,40*units,point.x,point.y),this._FirstSession?(this._RollOvers[3]=Dimensions.hitRect(this.OffsetX+appWidth*.5-210*units,centerY-20*units,420*units,40*units,point.x,point.y),this._RollOvers[4]=!1,this._RollOvers[5]=!1,this._RollOvers[10]=!1):(this._RollOvers[3]=!1,this._RollOvers[4]=Dimensions.hitRect(this.OffsetX+appWidth*.5-210*units,centerY-20*units,202.5*units,40*units,point.x,point.y),this._RollOvers[5]=Dimensions.hitRect(this.OffsetX+appWidth*.5+7.5*units,centerY-20*units,202.5*units,40*units,point.x,point.y),this._RollOvers[10]=Dimensions.hitRect(this.OffsetX+appWidth*.5+(arrowX-15)*units,centerY+units*(arrowY-20),30*units,40*units,point.x,point.y)),this._RollOvers[6]=Dimensions.hitRect(shareX+appWidth*.5-210*units,buttonY,130*units,30*units,point.x,point.y),this._RollOvers[7]=Dimensions.hitRect(shareX+appWidth*.5-65*units,buttonY,130*units,30*units,point.x,point.y),this._RollOvers[8]=Dimensions.hitRect(shareX+appWidth*.5+80*units,buttonY,130*units,30*units,point.x,point.y),this._RollOvers[9]=Dimensions.hitRect(shareX+appWidth*.5-(arrowX+15)*units,centerY+units*(arrowY-20),30*units,40*units,point.x,point.y)},SharePanel.prototype.Reset=function(){this._FirstSession=!0,App.SessionId&&(this._FirstSession=!1),this._SessionId=App.CompositionId,this._SessionId||(this.SessionTitle=this.GenerateLabel())},SharePanel.prototype.Resize=function(){this.OffsetX!==0&&(this.OffsetX=-(App.Width*1.5)),this.ClearScroll(),this.URLInput&&(this.StyleDom(this.URLInputContainer,400,40,200,20,this.OffsetX+App.Width*1.5,App.Metrics.TxtUrl),this.StyleDom(this.TitleInputContainer,300,42,210,132,0,App.Metrics.TxtHeaderPR))},SharePanel.prototype.TweenDom=function(element,value,mode,position,offset){var units=App.Unit,pr=App.Metrics.PixelRatio;switch(mode){case"x":element.style.left=""+(value+App.Width*(.5+offset)-units*position)/pr+"px";break;case"y":element.style.top=""+(value+App.Height*.5-units*position)/pr+"px"}},SharePanel.prototype.StyleDom=function(element,width,height,x,y,xOffset,font){var units=App.Unit,pr=App.Metrics.PixelRatio;element.style.font=font,element.style.width=""+units*(width/pr)+"px",element.style.height=""+units*(height/pr)+"px",element.style.lineHeight=""+units*(height/pr)+"px",element.style.display="block",this.Open||(this.OffsetY=-App.Height,element.style.display="none",element.style.visibility="false");var offsetX=xOffset/pr,offsetY=this.OffsetY/pr,width=App.Width/pr,height=App.Height/pr;element.style.left=""+(offsetX+width*.5-units*(x/pr))+"px",element.style.top=""+(offsetY+height*.5-units*(y/pr))+"px"},SharePanel.prototype.ShowDom=function(){var shareUrl=this.URLInputContainer,shareTitle=this.TitleInputContainer;shareUrl.style.display="block",shareUrl.style.visibility="true",shareTitle.style.display="block",shareTitle.style.visibility="true"},SharePanel.prototype.HideDom=function(){var shareUrl=this.URLInputContainer,shareTitle=this.TitleInputContainer;shareUrl.style.display="none",shareUrl.style.visibility="false",shareTitle.style.display="none",shareTitle.style.visibility="false"},SharePanel.prototype.ClearScroll=function(){window.scrollTo(0,0)},SharePanel}(DisplayObject);exports.SharePanel=SharePanel});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/SoundcloudPanel",["require","exports","../Device"],function(require,exports,Device_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,SoundcloudPanel=function(_super){__extends(SoundcloudPanel,_super);function SoundcloudPanel(){_super.apply(this,arguments),this._Page=1,this._ItemNo=5,this._Blink=0}return SoundcloudPanel.prototype.Init=function(drawTo){var _this=this;_super.prototype.Init.call(this,drawTo),this.Open=!1,this.OffsetX=0,this.OffsetY=-this.DrawTo.Height,this._RollOvers=[],this.SearchString="Hello",this.SearchInputContainer=document.getElementById("soundCloudSearch"),this.SearchInput=document.getElementById("soundCloudSearchInput"),this.SearchInput.addEventListener("input",function(event){_this.TestString(_this.SearchInput),_this.UpdateString(_this.SearchInput)}),this.SearchInput.addEventListener("keydown",function(event){_this.EnterCheck(event)}),this._CopyJson={titleLine:"Title",searchLine:"Search SoundCloud",randomLine:"Randomise",saving:"saving...",noResults:"No results found"};var colors=["black","grey","white","red","yellow","pink","green","orange","purple","blue","cream"],animals=["cat","dog","horse","rat","deer","snake","bat","mouse","wolf","hound","fox","bird"],places=["home","house","work","country","county","land","mountain","lake","sea","valley","desert","plains","ocean","space","sky","temple","church","shrine"],objects=["train","car","plane","jet","rocket","satellite","hand","head","back","eyes","legs","mouth","paper","crystal","skull","bones","flag","dust","rock","metal","plant","flower","sun","moon","day","night","gun","blood","gang","sample","drum","clap","echo","sound","song"],descriptions=["wet","dry","hot","cold","good","bad","evil","soft","hard","light","dark","heavy","clean","dirty","short","long","royal","magic","holy"];this._RandomWords=colors.concat(animals,places,objects,descriptions)},SoundcloudPanel.prototype.TestString=function(element){var caretPos=element.selectionStart;caretPos>0&&(caretPos-=1),/[.,\/#\?\"\'$Â£%\^&\*;:{|}<=>\\@\`\+~()]/.test(element.value)&&(element.value=element.value.replace(/[.,\/#\?\"\'$Â£%\^&\*;:{|}<=>\\@\`\+~()]/g,""),element.selectionStart=caretPos,element.selectionEnd=caretPos)},SoundcloudPanel.prototype.UpdateString=function(element){var string=element.value;this.SearchString=string},SoundcloudPanel.prototype.UpdateFormText=function(element,str){element.value=str},SoundcloudPanel.prototype.EnterCheck=function(e){var key=e.which||e.keyCode;key===13&&this.Submit()},SoundcloudPanel.prototype.Submit=function(){this.SearchInput.blur(),this._SelectedBlock.SearchString=this.SearchString,this._SelectedBlock.Search(this.SearchString),this._Page=1,this.OffsetX=0,this.ClearScroll()},SoundcloudPanel.prototype.Draw=function(){var ctx=this.Ctx,midType=App.Metrics.TxtMid,headType=App.Metrics.TxtHeader,units=App.Unit,centerY=this.OffsetY+App.Height*.5,appWidth=App.Width,appHeight=App.Height,margin=appWidth*.5-210*units,pageW=420*units;if(this.Open){App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.95,ctx.fillRect(0,this.OffsetY,appWidth,appHeight),ctx.globalAlpha=1,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[1]),ctx.lineWidth=2;var block=this._SelectedBlock,results=block.SearchResults.length,itemNo=this._ItemNo,pageNo=this._Page;ctx.font=App.Metrics.TxtItalic,ctx.textAlign="left",ctx.save(),ctx.beginPath(),ctx.moveTo(margin-5*units,centerY-100*units),ctx.lineTo(margin-5*units,centerY+130*units),ctx.lineTo(margin+pageW+10*units,centerY+130*units),ctx.lineTo(margin+pageW+10*units,centerY-100*units),ctx.closePath(),ctx.clip();for(var i=0;i<results;i++){var p=Math.floor(i/itemNo),n=i-p*itemNo,x=this.OffsetX+(pageW+10*units)*p,y=centerY-70*units+n*40*units;if(p>this._Page-3&&p<this._Page+1){n<4&&i<results-1&&(ctx.beginPath(),ctx.moveTo(x+margin,y+12*units),ctx.lineTo(x+margin+pageW,y+12*units),ctx.stroke());if(p==this._Page-1&&this._RollOvers[5+n]){var sy=centerY-98*units+40*n*units;App.FillColor(ctx,App.Palette[App.ThemeManager.MenuOrder[3]]),ctx.fillRect(margin-5*units,sy,pageW+10*units,40*units),ctx.beginPath(),ctx.moveTo(appWidth*.5,sy+45*units),ctx.lineTo(appWidth*.5-10*units,sy+35*units),ctx.lineTo(appWidth*.5+10*units,sy+35*units),ctx.closePath(),ctx.fill()}App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]);var track=block.SearchResults[i],title=track.Title,user=track.User;ctx.fillText(title,x+margin+units,y-10*units),ctx.fillText("By "+user,x+margin+units,y),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(x+margin+pageW-25*units,y-10.5*units),ctx.lineTo(x+margin+pageW-20*units,y-5.5*units),ctx.lineTo(x+margin+pageW-15*units,y-10.5*units),ctx.stroke(),App.StrokeColor(ctx,App.Palette[1])}}ctx.restore(),ctx.font=App.Metrics.TxtMid;var maxNo=itemNo*pageNo;maxNo>results&&(maxNo=results),results>0?ctx.fillText(""+(1+itemNo*(pageNo-1))+" - "+maxNo+" of "+results,margin,centerY+160*units):block.Searching?App.AnimationsLayer.DrawSprite(ctx,"loading",appWidth*.5,centerY,16,!0):(ctx.font=App.Metrics.TxtHeader,ctx.textAlign="center",ctx.fillText(this._CopyJson.noResults.toLocaleUpperCase(),appWidth*.5,centerY+10*units));var pageX=margin-75*units,pageY=-68,arrowX=275,arrowY=0;App.Metrics.Device===Device_1.Device.tablet&&(pageX=margin-45*units,arrowX=245),App.Metrics.Device===Device_1.Device.mobile&&(pageX=appWidth*.5,pageY=170,arrowX=60,arrowY=160);if(results>itemNo){ctx.font=App.Metrics.TxtHeader;var pNo=""+this._Page,pTotal=""+Math.ceil(results/itemNo);ctx.textAlign="center",ctx.fillText(pNo+"/"+pTotal,pageX,centerY+pageY*units)}App.StrokeColor(ctx,App.Palette[1]),this._Page>1&&App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(appWidth*.5-arrowX*units,centerY+(arrowY-20)*units),ctx.lineTo(appWidth*.5-(arrowX+20)*units,centerY+arrowY*units),ctx.lineTo(appWidth*.5-arrowX*units,centerY+(arrowY+20)*units),ctx.stroke(),App.StrokeColor(ctx,App.Palette[1]),this._Page<Math.ceil(results/itemNo)&&App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(appWidth*.5+arrowX*units,centerY+(arrowY-20)*units),ctx.lineTo(appWidth*.5+(arrowX+20)*units,centerY+arrowY*units),ctx.lineTo(appWidth*.5+arrowX*units,centerY+(arrowY+20)*units),ctx.stroke(),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.beginPath(),ctx.moveTo(margin,centerY-110*units),ctx.lineTo(margin+pageW,centerY-110*units),ctx.stroke(),ctx.textAlign="left",ctx.font=midType;var searchW=ctx.measureText(this._CopyJson.searchLine.toUpperCase()).width;ctx.fillText(this._CopyJson.searchLine.toUpperCase(),appWidth*.5+205*units-searchW,centerY-126*units),ctx.beginPath(),ctx.moveTo(appWidth*.5+210*units,centerY-140*units),ctx.lineTo(appWidth*.5+200*units-searchW,centerY-140*units),ctx.lineTo(appWidth*.5+200*units-searchW,centerY-120*units),ctx.lineTo(appWidth*.5+210*units,centerY-120*units),ctx.closePath(),ctx.stroke(),searchW=ctx.measureText(this._CopyJson.randomLine.toUpperCase()).width,ctx.fillText(this._CopyJson.randomLine.toUpperCase(),appWidth*.5+210*units-searchW,centerY+160*units);var rx=appWidth*.5+210*units-searchW*.5;ctx.beginPath(),ctx.moveTo(rx-7.5*units,centerY+165*units),ctx.lineTo(rx-2.5*units,centerY+170*units),ctx.lineTo(rx+2.5*units,centerY+165*units),ctx.lineTo(rx+7.5*units,centerY+170*units),ctx.stroke();var clx=230,cly=150;App.Metrics.Device===Device_1.Device.mobile&&(clx=202.5,cly=170),ctx.beginPath(),ctx.moveTo(appWidth*.5+(clx-7.5)*units,centerY-(cly-7.5)*units),ctx.lineTo(appWidth*.5+(clx+7.5)*units,centerY-(cly+7.5)*units),ctx.moveTo(appWidth*.5+(clx+7.5)*units,centerY-(cly-7.5)*units),ctx.lineTo(appWidth*.5+(clx-7.5)*units,centerY-(cly+7.5)*units),ctx.stroke()}},SoundcloudPanel.prototype.WordWrap=function(context,text,x,y,lineHeight,fitWidth){fitWidth=fitWidth||0;if(fitWidth<=0){context.fillText(text,x,y);return}var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),context.fillText(words.slice(0,idx-1).join(" "),x,y+lineHeight*currentLine),currentLine++,words=words.splice(idx-1),idx=1):idx++}idx>0&&context.fillText(words.join(" "),x,y+lineHeight*currentLine)},SoundcloudPanel.prototype.DelayTo=function(panel,destination,t,delay,v){var offsetTween=new window.TWEEN.Tween({x:panel[""+v]});offsetTween.to({x:destination},t),offsetTween.onUpdate(function(){panel[""+v]=this.x,v=="OffsetY"&&panel.TweenDom(panel.SearchInputContainer,this.x,"y",152,0)}),offsetTween.onComplete(function(){v=="OffsetY"&&destination!==0&&(panel.Open=!1,panel.HideDom())}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick)},SoundcloudPanel.prototype.OpenPanel=function(){this._SelectedBlock=App.MainScene.OptionsPanel.SelectedBlock,this._SelectedBlock.SearchString||this._SelectedBlock.Search(this.RandomSearch(this._SelectedBlock)),this._Page=this._SelectedBlock.ResultsPage,this.SearchString=this._SelectedBlock.SearchString,this.UpdateFormText(this.SearchInput,this.SearchString),this.Open=!0,this.OffsetY=-App.Height,this.OffsetX=-((this._Page-1)*430*App.Unit),this.DelayTo(this,0,500,0,"OffsetY"),this.ShowDom()},SoundcloudPanel.prototype.ClosePanel=function(){this._SelectedBlock.ResultsPage=this._Page,this.DelayTo(this,-App.Height,500,0,"OffsetY")},SoundcloudPanel.prototype.MouseDown=function(point){this.HitTests(point);var block=this._SelectedBlock;if(this._RollOvers[1]){this.ClosePanel();return}if(this._RollOvers[2]){this.Submit();return}if(this._RollOvers[10]){block.Search(this.RandomSearch(this._SelectedBlock)),this._Page=1,this.OffsetX=0;return}if(this._RollOvers[3]){this._Page>1&&(this._Page-=1,this.DelayTo(this,-((this._Page-1)*430*App.Unit),350,0,"OffsetX"));return}if(this._RollOvers[4]){this._Page<Math.ceil(block.SearchResults.length/this._ItemNo)&&(this._Page+=1,this.DelayTo(this,-((this._Page-1)*430*App.Unit),350,0,"OffsetX"));return}for(var i=5;i<10;i++)if(this._RollOvers[i]){var n=(this._Page-2)*this._ItemNo+i,track=block.SearchResults[n];track&&(block.LoadTrack(track),this.ClosePanel());return}},SoundcloudPanel.prototype.MouseUp=function(point){},SoundcloudPanel.prototype.MouseMove=function(point){this.HitTests(point)},SoundcloudPanel.prototype.HitTests=function(point){var units=App.Unit,shareX=this.OffsetX+App.Width,centerY=this.OffsetY+App.Height*.5,ctx=this.Ctx,midType=App.Metrics.TxtMid,appWidth=App.Width;ctx.font=midType;var searchW=ctx.measureText(this._CopyJson.searchLine.toUpperCase()).width,randomW=ctx.measureText(this._CopyJson.randomLine.toUpperCase()).width,clx=230,cly=150,arrowX=285,arrowY=0;App.Metrics.Device===Device_1.Device.tablet&&(arrowX=255),App.Metrics.Device===Device_1.Device.mobile&&(clx=202.5,cly=170,arrowX=70,arrowY=160),this._RollOvers[0]=Dimensions.hitRect(shareX+appWidth*.5-210*units,centerY-20*units,420*units,40*units,point.x,point.y),this._RollOvers[1]=Dimensions.hitRect(appWidth*.5+(clx-20)*units,centerY-(cly+20)*units,40*units,40*units,point.x,point.y),this._RollOvers[2]=Dimensions.hitRect(appWidth*.5+200*units-searchW,centerY-150*units,searchW+10*units,40*units,point.x,point.y),this._RollOvers[3]=Dimensions.hitRect(appWidth*.5-(arrowX+15)*units,centerY+units*(arrowY-20),30*units,40*units,point.x,point.y),this._RollOvers[4]=Dimensions.hitRect(appWidth*.5+(arrowX-15)*units,centerY+units*(arrowY-20),30*units,40*units,point.x,point.y),this._RollOvers[5]=Dimensions.hitRect(appWidth*.5-210*units,centerY-units*98,420*units,40*units,point.x,point.y),this._RollOvers[6]=Dimensions.hitRect(appWidth*.5-210*units,centerY-units*58,420*units,40*units,point.x,point.y),this._RollOvers[7]=Dimensions.hitRect(appWidth*.5-210*units,centerY-units*18,420*units,40*units,point.x,point.y),this._RollOvers[8]=Dimensions.hitRect(appWidth*.5-210*units,centerY+units*22,420*units,40*units,point.x,point.y),this._RollOvers[9]=Dimensions.hitRect(appWidth*.5-210*units,centerY+units*62,420*units,40*units,point.x,point.y),this._RollOvers[10]=Dimensions.hitRect(appWidth*.5+205*units-randomW,centerY+136*units,randomW+10*units,40*units,point.x,point.y)},SoundcloudPanel.prototype.Resize=function(){this.OffsetX=-((this._Page-1)*430*App.Unit),this.ClearScroll(),this.SearchInput&&this.StyleDom(this.SearchInputContainer,300,42,210,152,0,App.Metrics.TxtHeaderPR)},SoundcloudPanel.prototype.RandomSearch=function(block){var words=this._RandomWords,q=""+words[Math.floor(Math.random()*words.length)]+" "+words[Math.floor(Math.random()*words.length)];return this.SearchString=q,block.SearchString=q,this.UpdateFormText(this.SearchInput,q),q},SoundcloudPanel.prototype.TweenDom=function(element,value,mode,position,offset){var units=App.Unit,pr=App.Metrics.PixelRatio;switch(mode){case"x":element.style.left=""+(value+App.Width*(.5+offset)-units*position)/pr+"px";break;case"y":element.style.top=""+(value+App.Height*.5-units*position)/pr+"px"}},SoundcloudPanel.prototype.StyleDom=function(element,width,height,x,y,xOffset,font){var units=App.Unit,pr=App.Metrics.PixelRatio;element.style.font=font,element.style.width=""+units*(width/pr)+"px",element.style.height=""+units*(height/pr)+"px",element.style.lineHeight=""+units*(height/pr)+"px",element.style.display="block",this.Open||(this.OffsetY=-App.Height,element.style.display="none",element.style.visibility="false");var offsetX=xOffset/pr,offsetY=this.OffsetY/pr,width=App.Width/pr,height=App.Height/pr;element.style.left=""+(offsetX+width*.5-units*(x/pr))+"px",element.style.top=""+(offsetY+height*.5-units*(y/pr))+"px"},SoundcloudPanel.prototype.ShowDom=function(){var search=this.SearchInputContainer;search.style.display="block",search.style.visibility="true"},SoundcloudPanel.prototype.HideDom=function(){var search=this.SearchInputContainer;search.style.display="none",search.style.visibility="false"},SoundcloudPanel.prototype.ClearScroll=function(){window.scrollTo(0,0)},SoundcloudPanel}(DisplayObject);exports.SoundcloudPanel=SoundcloudPanel});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/StageDragger",["require","exports"],function(require,exports){var DisplayObject=etch.drawing.DisplayObject,Point=minerva.Point,StageDragger=function(_super){__extends(StageDragger,_super);function StageDragger(){_super.apply(this,arguments),this._Dragging=!1}return StageDragger.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Tweens=[],this.Destination=new Point(App.DragOffset.x,App.DragOffset.y)},StageDragger.prototype.Update=function(){if(Math.round(App.DragOffset.x)!==Math.round(this.Destination.x)||Math.round(App.DragOffset.y)!==Math.round(this.Destination.y)){var speed=App.Config.ScrollEasing;App.DragOffset.x+=(this.Destination.x-App.DragOffset.x)/100*speed,App.DragOffset.y+=(this.Destination.y-App.DragOffset.y)/100*speed,App.Metrics.UpdateGridScale()}},StageDragger.prototype.Draw=function(){if(this._Dragging&&(App.DragOffset.x!==this._OffsetStart.x||App.DragOffset.y!==this._OffsetStart.y)){var cx=App.Metrics.C.x,cy=App.Metrics.C.y,units=App.Unit,ctx=App.MainScene.Ctx;App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(cx-5*units,cy),ctx.lineTo(cx+5*units,cy),ctx.moveTo(cx,cy-5*units),ctx.lineTo(cx,cy+5*units),ctx.stroke()}},StageDragger.prototype.DelayTo=function(panel,destination,t,delay,v){var me=this,offsetTween=new window.TWEEN.Tween({x:panel[""+v].x,y:panel[""+v].y});offsetTween.to({x:destination.x,y:destination.y},t),offsetTween.onUpdate(function(){panel[""+v].x=this.x,panel[""+v].y=this.y,me.Destination.x=this.x,me.Destination.y=this.y,panel.Metrics.UpdateGridScale()}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick),this.Tweens.push(offsetTween)},StageDragger.prototype.StopAllTweens=function(){if(this.Tweens.length){for(var j=0;j<this.Tweens.length;j++)this.Tweens[j].stop();this.Tweens=[]}},StageDragger.prototype.MouseDown=function(point){this._DragStart=new Point(point.x,point.y),this._OffsetStart=new Point(App.DragOffset.x,App.DragOffset.y),this._Dragging=!0},StageDragger.prototype.MouseMove=function(point){this._Dragging&&this.Drag(point)},StageDragger.prototype.MouseUp=function(){this._Dragging=!1},StageDragger.prototype.Drag=function(point){var speed=App.Config.ScrollSpeed;this.Destination.x=this._OffsetStart.x+(point.x-this._DragStart.x)/App.Unit*(speed/App.ZoomLevel),this.Destination.y=this._OffsetStart.y+(point.y-this._DragStart.y)/App.Unit*(speed/App.ZoomLevel)},StageDragger.prototype.Jump=function(point,to,time){time=time||400,this.StopAllTweens();var blockX=-point.x*App.GridSize,blockY=-point.y*App.GridSize,screenX=App.Width*to.x-App.Metrics.C.x,screenY=App.Height*to.y-App.Metrics.C.y,x=(blockX+screenX/App.ZoomLevel)/App.Unit,y=(blockY+screenY/App.ZoomLevel)/App.Unit;this.DelayTo(App,new Point(x,y),time,0,"DragOffset"),App.MainScene.ToolTipClose()},StageDragger}(DisplayObject);exports.StageDragger=StageDragger});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/ToolTip",["require","exports"],function(require,exports){var DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,ToolTip=function(_super){__extends(ToolTip,_super);function ToolTip(){_super.apply(this,arguments)}return ToolTip.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Name="",this.Alpha=0,this.Open=!1,this.Position=new Point(0,0)},ToolTip.prototype.Draw=function(){var units=App.Unit,ctx=this.Ctx,dataType=Math.round(units*10),thisAlpha=this.Alpha/100;ctx.font=App.Metrics.TxtMid;var thisWidth=ctx.measureText(this.Name.toUpperCase()).width+40*units,x=this.Position.x,y=this.Position.y;ctx.globalAlpha=thisAlpha*.9,App.FillColor(ctx,App.Palette[2]),ctx.beginPath(),ctx.moveTo(x,y),ctx.lineTo(x+thisWidth,y),ctx.lineTo(x+thisWidth,y+20*units),ctx.lineTo(x+20*units,y+20*units),ctx.closePath(),ctx.fill(),ctx.globalAlpha=thisAlpha,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.textAlign="left",ctx.fillText(this.Name.toUpperCase(),x+30*units,y+10*units+dataType*.36)},ToolTip.prototype.AlphaTo=function(panel,destination,t){this._AlphaTween&&this._AlphaTween.stop(),window.TWEEN.remove(this._AlphaTween),this._AlphaTween=new window.TWEEN.Tween({x:this.Alpha}),this._AlphaTween.to({x:destination},t),this._AlphaTween.onUpdate(function(){panel.Alpha=this.x}),this._AlphaTween.easing(window.TWEEN.Easing.Quintic.InOut),this._AlphaTween.start(this.LastVisualTick)},ToolTip.prototype.StopTween=function(){window.TWEEN.remove(this._AlphaTween)},ToolTip}(DisplayObject);exports.ToolTip=ToolTip});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/TrashCan",["require","exports"],function(require,exports){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,TrashCan=function(_super){__extends(TrashCan,_super);function TrashCan(){_super.apply(this,arguments)}return TrashCan.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this._RollOver=!1},TrashCan.prototype.Draw=function(){var units=App.Unit,ctx=this.Ctx,tx=this.DrawTo.Width-30*units,ty=this.DrawTo.Height-30*units,s=1;this._RollOver&&this.DrawTo.IsDraggingABlock&&(s=1.2),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(tx-11*s*units,ty-11*s*units),ctx.lineTo(tx+11*s*units,ty-11*s*units),ctx.lineTo(tx+8*s*units,ty+11*s*units),ctx.lineTo(tx-8*s*units,ty+11*s*units),ctx.closePath(),ctx.stroke(),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(tx-4*s*units,ty-4*s*units),ctx.lineTo(tx+4*s*units,ty+4*s*units),ctx.moveTo(tx+4*s*units,ty-4*s*units),ctx.lineTo(tx-4*s*units,ty+4*s*units),ctx.stroke(),ctx.lineWidth=1},TrashCan.prototype.MouseMove=function(point){var units=App.Unit;this._RollOver=Dimensions.hitRect(this.DrawTo.Width-60*units,this.DrawTo.Height-60*units,60*units,60*units,point.x,point.y)},TrashCan.prototype.MouseUp=function(){return this._RollOver?(this.DrawTo.DeleteSelectedBlock(),!0):!1},TrashCan}(DisplayObject);exports.TrashCan=TrashCan});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/ToneSource",["require","exports","../Source"],function(require,exports,Source_1){var Point=etch.primitives.Point,ToneSource=function(_super){__extends(ToneSource,_super);function ToneSource(){_super.apply(this,arguments)}return ToneSource.prototype.Init=function(drawTo){var _this=this;this.BlockName=App.L10n.Blocks.Source.Blocks.Tone.name,this.Defaults={waveform:2,transpose:0,fine:0},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),this.CreateSource(),this.CreateEnvelope(),this.CreateFirstVoice(),this.Envelopes.forEach(function(e){e.connect(_this.AudioInput)}),this.Sources.forEach(function(s,i){s.connect(_this.Envelopes[i]),s.start()}),this.Outline.push(new Point(-2,0),new Point(0,-2),new Point(2,0),new Point(1,1),new Point(-1,1))},ToneSource.prototype.BackwardsCompatibilityPatch=function(){this.Params.frequency=this.GetFrequency(),this.Params.baseFrequency=this.GetFrequency()},ToneSource.prototype.CreateSource=function(){return this.Sources.push(new Tone.Oscillator(this.GetFrequency(),App.Audio.WaveformTypeIndex[this.Params.waveform])),_super.prototype.CreateSource.call(this)},ToneSource.prototype.CreateEnvelope=function(){return this.Envelopes.push(new Tone.AmplitudeEnvelope(this.Settings.envelope.attack,this.Settings.envelope.decay,this.Settings.envelope.sustain,this.Settings.envelope.release)),_super.prototype.CreateEnvelope.call(this)},ToneSource.prototype.Dispose=function(){_super.prototype.Dispose.call(this),this.Sources.forEach(function(s){s.dispose()}),this.Envelopes.forEach(function(e){e.dispose()})},ToneSource.prototype.Update=function(){_super.prototype.Update.call(this)},ToneSource.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},ToneSource.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Tone",parameters:[{type:"slider",name:"Note",setting:"transpose",props:{value:this.Params.transpose,min:-48,max:48,quantised:!0,centered:!0,convertDisplay:this.DisplayNote}},{type:"slider",name:"Fine",setting:"fine",props:{value:this.Params.fine,min:-1,max:1,quantised:!1,centered:!0}},{type:"buttons",name:"Wave",setting:"waveform",props:{value:this.Params.waveform,mode:"wave"},buttons:[{name:"Sine"},{name:"Square"},{name:"Triangle"},{name:"Saw"}]}]}},ToneSource.prototype.SetParam=function(param,value){switch(param){case"transpose":this.Params.transpose=value,this.NoteUpdate();break;case"fine":this.Params.fine=value,this.NoteUpdate();break;case"waveform":this.Sources.forEach(function(s){s.type=App.Audio.WaveformTypeIndex[value]})}this.Params[param]=value},ToneSource.prototype.DisplayNote=function(value){var octave=ToneSource.GetOctaveFromTransposeValue(value),note=ToneSource.GetNoteFromTransposeValue(value);return""+note+""+octave},ToneSource.GetOctaveFromTransposeValue=function(value){return Math.floor(value/12)+4},ToneSource.GetNoteFromTransposeValue=function(value){return value%=12,value<0&&(value+=12),App.Audio.NoteIndex[value]},ToneSource.prototype.GetFrequency=function(transpose,fine){return transpose=typeof transpose=="number"?transpose:this.Params.transpose,fine=typeof fine=="number"?fine:this.Params.fine,App.Config.BaseNote*App.Audio.Tone.intervalToFrequencyRatio(transpose+fine)},ToneSource}(Source_1.Source);exports.ToneSource=ToneSource});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Interaction/Keyboard",["require","exports","./Controller"],function(require,exports,Controller_1){var Keyboard=function(_super){__extends(Keyboard,_super);function Keyboard(){_super.apply(this,arguments)}return Keyboard.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.KeysDown={}},Keyboard.prototype.Draw=function(){_super.prototype.Draw.call(this)},Keyboard.prototype.UpdateConnections=function(){var _this=this;this.KeysDown={};var connections=this.Connections.ToArray();connections.forEach(function(source){_this.Params.isPolyphonic&&source.CreateVoices()})},Keyboard.prototype.SetParam=function(param,value){var _this=this;_super.prototype.SetParam.call(this,param,value);if(param==="glide")value/=100;else if(param==="transpose")this.Transposition=value*this.TranspositionAmount,this.UpdateMods();else if(param==="polyphonic"){this.Params.isPolyphonic=value;var connections=this.Connections.ToArray();connections.forEach(function(source){_this.Params.isPolyphonic?source.CreateVoices():source.RemoveExtraVoices()}),App.Audio.ConnectionManager.Update()}this.Params[param]=value},Keyboard.prototype.Dispose=function(){this.KeysDown=null},Keyboard}(Controller_1.Controller);exports.Keyboard=Keyboard});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Interaction/ComputerKeyboard",["require","exports","./Keyboard"],function(require,exports,Keyboard_1){var Point=etch.primitives.Point,ComputerKeyboard=function(_super){__extends(ComputerKeyboard,_super);function ComputerKeyboard(){_super.apply(this,arguments),this.KeyboardCommands={OctaveUp:"octave-up",OctaveDown:"octave-down"}}return ComputerKeyboard.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Interaction.Blocks.ComputerKeyboard.name,this.Defaults={transpose:0,glide:.05,isPolyphonic:!1},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),App.PianoKeyboardManager.KeyDownChange.on(this.KeyDownCallback,this),App.PianoKeyboardManager.KeyUpChange.on(this.KeyUpCallback,this),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(2,1),new Point(1,2),new Point(-1,2))},ComputerKeyboard.prototype.KeyDownCallback=function(e){if(e.KeyDown&&e.KeyDown>0&&e.KeyDown<1e3){var note=e.KeyDown;this.KeysDown[""+note]=!0,this.NoteOn(note)}else this.ExecuteCodeCommand(e.KeyDown)},ComputerKeyboard.prototype.KeyUpCallback=function(e){if(e.KeyUp&&e.KeyUp>0&&e.KeyUp<1e3){var note=e.KeyUp;delete this.KeysDown[""+note],this.NoteOff(note)}},ComputerKeyboard.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},ComputerKeyboard.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Computer Keyboard",parameters:[{type:"switches",name:"",switches:[{name:"Mono/Poly",setting:"polyphonic",value:this.Params.isPolyphonic,mode:"fewMany"}]},{type:"slider",name:"Octave",setting:"transpose",props:{value:this.Params.transpose,min:-this.TranspositionRange,max:this.TranspositionRange,quantised:!0,centered:!0}},{type:"slider",name:"Glide",setting:"glide",props:{value:this.Params.glide*100,min:.001,max:100,truemin:0,truemax:1,quantised:!1,centered:!1}}]}},ComputerKeyboard.prototype.Dispose=function(){_super.prototype.Dispose.call(this),App.Audio.ConnectionManager.Update(),App.PianoKeyboardManager.KeyDownChange.off(this.KeyDownCallback,this),App.PianoKeyboardManager.KeyUpChange.off(this.KeyUpCallback,this),this.Params.transpose=null,this.KeyboardCommands=null},ComputerKeyboard.prototype.Stop=function(){App.PianoKeyboardManager.KeyDownChange.off(this.KeyDownCallback,this),App.PianoKeyboardManager.KeyUpChange.off(this.KeyUpCallback,this)},ComputerKeyboard}(Keyboard_1.Keyboard);exports.ComputerKeyboard=ComputerKeyboard});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Chopper",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Chopper=function(_super){__extends(Chopper,_super);function Chopper(){_super.apply(this,arguments)}return Chopper.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Chopper.name,this.Defaults={rate:8,depth:1,spread:0,waveform:2,mix:1},this.PopulateParams(),this.Effect=(new Tone.Tremolo({frequency:this.Params.rate,depth:this.Params.depth,spread:this.Params.spread,type:App.Audio.WaveformTypeIndex[this.Params.waveform],wet:this.Params.mix})).start(),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,-1),new Point(1,1),new Point(0,2),new Point(-1,1))},Chopper.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Chopper.prototype.Dispose=function(){this.Effect.stop(),this.Effect.dispose()},Chopper.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Chopper.name,parameters:[{type:"slider",name:"Rate",setting:"rate",props:{value:this.Params.rate,min:0,max:50,quantised:!1,centered:!1}},{type:"slider",name:"Depth",setting:"depth",props:{value:this.Params.depth,min:0,max:1,quantised:!1,centered:!1}},{type:"buttons",name:"Wave",setting:"waveform",props:{value:this.Params.waveform,mode:"wave"},buttons:[{name:"Sine"},{name:"Square"},{name:"Triangle"},{name:"Saw"}]},{type:"slider",name:"Spread",setting:"spread",props:{value:this.Params.spread,min:0,max:180,quantised:!1,centered:!1}}]}},Chopper.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);switch(param){case"rate":this.Effect.frequency.value=value;break;case"depth":this.Effect.depth.value=value;break;case"waveform":this.Effect.type=App.Audio.WaveformTypeIndex[value];break;case"spread":this.Effect.spread=value}this.Params[param]=value},Chopper}(PostEffect_1.PostEffect);exports.Chopper=Chopper});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/Tutorial",["require","exports","../Device","./../Blocks/Sources/ToneSource","./../Blocks/Interaction/ComputerKeyboard","./../Blocks/Effects/Post/Chopper","./../Blocks/Power/Power","./../Blocks/Power/ParticleEmitter"],function(require,exports,Device_1,ToneSource_1,ComputerKeyboard_1,Chopper_1,Power_1,ParticleEmitter_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,Tutorial=function(_super){__extends(Tutorial,_super);function Tutorial(){_super.apply(this,arguments),this.Debug=!0,this.Hover=!1,this._TutKeys=!1,this._RollOvers=[],this.WatchedBlocks=[],this.OptionsInteract=!1}return Tutorial.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.Open=!1,this.HotSpots=[],this.IntroLines=0,this.TaskLines=0,this.TextWidth=190,this._LineHeight=14,this.Offset=new Point(-20,0),this.Offset2=new Point(-1,0),this._AnimateCount=0,this.AnimatePolarity=1,this.Text=App.L10n.UI.Tutorial,this.CurrentScene=1,this.TotalScenes=this.Text.Scenes.length},Tutorial.prototype.CheckLaunch=function(){this.Debug?this.OpenSplash():App.SkipTutorial||this.OpenSplash()},Tutorial.prototype.CheckTask=function(){if(this.Open){var check=!1;this.WatchedBlocks=[];var i,tone,toneConnections,controller,controllerUnplugged,effect,effectUnplugged,particle,power,powerConnections,particleConnected;for(i=0;i<App.Blocks.length;i++)App.Blocks[i]instanceof ToneSource_1.ToneSource&&!tone&&(tone=App.Blocks[i],this.WatchedBlocks[0]=tone),App.Blocks[i]instanceof ComputerKeyboard_1.ComputerKeyboard&&!controllerUnplugged&&(controllerUnplugged=App.Blocks[i],this.WatchedBlocks[1]=controllerUnplugged),App.Blocks[i]instanceof Chopper_1.Chopper&&!effectUnplugged&&(effectUnplugged=App.Blocks[i],this.WatchedBlocks[4]=effectUnplugged),App.Blocks[i]instanceof ParticleEmitter_1.ParticleEmitter&&!particle&&(particle=App.Blocks[i],this.WatchedBlocks[5]=particle),App.Blocks[i]instanceof Power_1.Power&&!power&&(power=App.Blocks[i],this.WatchedBlocks[6]=power);if(tone&&tone.Connections.Count){toneConnections=tone.Connections.ToArray();for(i=0;i<toneConnections.length;i++)toneConnections[i]instanceof ComputerKeyboard_1.ComputerKeyboard&&!controller&&(controller=toneConnections[i],this.WatchedBlocks[2]=controller),toneConnections[i]instanceof Chopper_1.Chopper&&!effect&&(effect=toneConnections[i],this.WatchedBlocks[3]=effect)}if(power&&power.Connections.Count){powerConnections=power.Connections.ToArray();for(i=0;i<powerConnections.length;i++)powerConnections[i]instanceof ParticleEmitter_1.ParticleEmitter&&!particleConnected&&(particleConnected=powerConnections[i],this.WatchedBlocks[7]=particleConnected)}var cx=.5;App.Metrics.Device===Device_1.Device.mobile&&(cx=.35);if(this._TutKeys)switch(this.CurrentScene){case 1:tone&&!App.MainScene.IsDraggingABlock&&(check=!0,App.MainScene.MainSceneDragger.Jump(tone.Position,new Point(cx,.5),1e3));break;case 2:controller&&!App.MainScene.IsDraggingABlock&&(check=!0);break;case 3:effect&&!App.MainScene.IsDraggingABlock&&(check=!0);break;case 4:this.OptionsInteract&&App.MainScene.SelectedBlock==effect&&(check=!0,App.MainScene.MainSceneDragger.Jump(tone.Position,new Point(cx,.5),1e3));break;case 5:!controller&&!controllerUnplugged&&!App.MainScene.IsDraggingABlock&&(check=!0,App.MainScene.MainSceneDragger.Jump(tone.Position,new Point(cx,.35),1e3));break;case 6:particle&&!App.MainScene.IsDraggingABlock&&(check=!0);break;case 7:particleConnected&&!App.MainScene.IsDraggingABlock&&(check=!0);break;default:}else switch(this.CurrentScene){case 1:tone&&!App.MainScene.IsDraggingABlock&&(check=!0,App.MainScene.MainSceneDragger.Jump(tone.Position,new Point(cx,.5),1e3));break;case 2:particle&&!App.MainScene.IsDraggingABlock&&(check=!0);break;case 3:particleConnected&&!App.MainScene.IsDraggingABlock&&(check=!0);break;case 4:effect&&!App.MainScene.IsDraggingABlock&&(check=!0);break;case 5:this.OptionsInteract&&App.MainScene.SelectedBlock==effect&&(check=!0,App.MainScene.MainSceneDragger.Jump(tone.Position,new Point(cx,.5),1e3));break;default:}check&&this.NextScene()}},Tutorial.prototype.Update=function(){this.Open&&this.UpdateHotspots(),this.SplashOpen},Tutorial.prototype.Draw=function(){var ctx=this.Ctx,units=App.Unit,midType=App.Metrics.TxtMid,italicType=App.Metrics.TxtItalic3,headerType=App.Metrics.TxtHeader,x=App.Width-this.Offset.x*units,y=App.Height*.5+this.Offset.y*units-20*units,lineHeight=this._LineHeight*units,introOffset=(this.IntroLines+2)*lineHeight,taskOffset=this.TaskLines*lineHeight,splashOffset=App.Width*this.Offset2.x;ctx.globalAlpha=1,ctx.textAlign="center",App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]);if(this.Offset2.x>-1){var mes=this.Text.Splash1.Message,yes=this.Text.Splash1.Y.toUpperCase(),no=this.Text.Splash1.N.toUpperCase();App.Blocks.length&&(mes=this.Text.Splash2.Message,yes=this.Text.Splash2.Y.toUpperCase(),no=this.Text.Splash2.N.toUpperCase(),App.FillColor(ctx,App.Palette[2]),ctx.globalAlpha=.16,ctx.fillRect(App.Width*.5+splashOffset-140*units,App.Height*.5-55*units,280*units,140*units),ctx.globalAlpha=.9,ctx.fillRect(App.Width*.5+splashOffset-140*units,App.Height*.5-60*units,280*units,140*units),ctx.globalAlpha=1,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt])),ctx.font=headerType,ctx.fillText(mes,App.Width*.5+splashOffset,App.Height*.5-10*units);var padding=60*units,iconY=App.Height*.5+20*units;ctx.font=midType,ctx.fillText(yes,App.Width*.5-padding+splashOffset,iconY+30*units),ctx.fillText(no,App.Width*.5+padding+splashOffset,iconY+30*units);var ym=1,nm=1;this._RollOvers[0]&&(ym=1.2),this._RollOvers[1]&&(nm=1.2),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(App.Width*.5-padding+splashOffset-16*ym*units,iconY+4*ym*units*this.AnimatePolarity),ctx.lineTo(App.Width*.5-padding+splashOffset-14*ym*units,iconY+6*ym*units*this.AnimatePolarity),ctx.moveTo(App.Width*.5-padding+splashOffset-12*ym*units,iconY+8*ym*units*this.AnimatePolarity),ctx.lineTo(App.Width*.5-padding+splashOffset-8*ym*units,iconY+12*ym*units*this.AnimatePolarity),ctx.lineTo(App.Width*.5-padding+splashOffset+8*ym*units,iconY-4*ym*units*this.AnimatePolarity),ctx.lineTo(App.Width*.5-padding+splashOffset+12*ym*units,iconY),ctx.moveTo(App.Width*.5-padding+splashOffset-12*ym*units,iconY),ctx.lineTo(App.Width*.5-padding+splashOffset-8*ym*units,iconY+4*ym*units*this.AnimatePolarity),ctx.lineTo(App.Width*.5-padding+splashOffset+8*ym*units,iconY-12*ym*units*this.AnimatePolarity),ctx.lineTo(App.Width*.5-padding+splashOffset+12*ym*units,iconY-8*ym*units*this.AnimatePolarity),ctx.moveTo(App.Width*.5-padding+splashOffset+14*ym*units,iconY-6*ym*units*this.AnimatePolarity),ctx.lineTo(App.Width*.5-padding+splashOffset+16*ym*units,iconY-4*ym*units*this.AnimatePolarity),ctx.moveTo(App.Width*.5+padding+splashOffset-8*nm*units,iconY-8*nm*units),ctx.lineTo(App.Width*.5+padding+splashOffset,iconY),ctx.lineTo(App.Width*.5+padding+splashOffset-8*nm*units,iconY+8*nm*units),ctx.moveTo(App.Width*.5+padding+splashOffset,iconY-8*nm*units),ctx.lineTo(App.Width*.5+padding+splashOffset+8*nm*units,iconY),ctx.lineTo(App.Width*.5+padding+splashOffset,iconY+8*nm*units),ctx.stroke(),App.StrokeColor(ctx,App.Palette[1]),ctx.lineWidth=1,ctx.beginPath(),ctx.moveTo(App.Width*.5+splashOffset,App.Height*.5+5*units),ctx.lineTo(App.Width*.5+splashOffset,App.Height*.5+55*units),ctx.stroke()}if(this.Offset.x>-20){ctx.textAlign="left",ctx.font=headerType;var numberText="0"+this.CurrentScene+"/0"+this.TotalScenes,numberWidth=ctx.measureText(numberText).width;ctx.fillText(numberText,x,y-20*units),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(x,y),ctx.lineTo(x+this.TextWidth*units,y),ctx.stroke();var btnY=50*units;ctx.font=midType;var btnTxt="",roll=0;this._RollOvers[2]&&(roll=units);if(this.CurrentScene<this.TotalScenes)btnTxt=this.Text.SkipButton.toUpperCase(),ctx.fillText(btnTxt,x+10*units,y+btnY+14*units+introOffset+taskOffset),ctx.beginPath(),ctx.moveTo(x-roll,y+btnY+introOffset+taskOffset-roll),ctx.lineTo(x+20*units+this._SkipBtnWidth+roll,y+btnY+introOffset+taskOffset-roll),ctx.lineTo(x+20*units+this._SkipBtnWidth+roll,y+btnY+20*units+introOffset+taskOffset+roll),ctx.lineTo(x-roll,y+btnY+20*units+introOffset+taskOffset+roll),ctx.closePath(),ctx.stroke();else{taskOffset=(this.TaskLines-2)*lineHeight,btnTxt=this.Text.DoneButton.toUpperCase(),ctx.fillText(btnTxt,x+10*units,y+btnY+14*units+introOffset+taskOffset),ctx.beginPath(),ctx.moveTo(x-roll,y+btnY+introOffset+taskOffset-roll),ctx.lineTo(x+20*units+this._DoneBtnWidth+roll,y+btnY+introOffset+taskOffset-roll),ctx.lineTo(x+20*units+this._DoneBtnWidth+roll,y+btnY+20*units+introOffset+taskOffset+roll),ctx.lineTo(x-roll,y+btnY+20*units+introOffset+taskOffset+roll),ctx.closePath(),ctx.stroke();var yx=x+numberWidth+20*units,yy=y-28*units;ctx.beginPath(),ctx.moveTo(yx-12*units,yy),ctx.lineTo(yx-4*units,yy+8*units),ctx.lineTo(yx+12*units,yy-8*units),ctx.stroke()}ctx.font=italicType;var string=this.Text.Scenes[this.CurrentScene-1].Intro;this.WordWrap(ctx,string,x,y+25*units,lineHeight,this.TextWidth*units);var string=this.Text.Scenes[this.CurrentScene-1].Task;if(string!==""){this.WordWrap(ctx,string,x,y+25*units+introOffset,lineHeight,this.TextWidth*units);var dx=x-10*units,dy=y+22*units+introOffset;ctx.beginPath(),ctx.moveTo(dx,dy-2*units),ctx.lineTo(dx+2*units,dy),ctx.lineTo(dx,dy+2*units),ctx.lineTo(dx-2*units,dy),ctx.closePath(),ctx.fill();var size=5;ctx.beginPath(),ctx.moveTo(dx,dy-size*units),ctx.lineTo(dx+size*units,dy),ctx.lineTo(dx,dy+size*units),ctx.lineTo(dx-size*units,dy),ctx.closePath(),ctx.stroke()}}},Tutorial.prototype.AnimateButton=function(){this._AnimateCount+=1,this._AnimateCount>60&&(this.DelayTo(this,-this.AnimatePolarity,.3,0,"AnimatePolarity"),this._AnimateCount=0)},Tutorial.prototype.WordWrap=function(context,text,x,y,lineHeight,fitWidth){fitWidth=fitWidth||0;if(fitWidth<=0){context.fillText(text,x,y);return}var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),context.fillText(words.slice(0,idx-1).join(" "),x,y+lineHeight*currentLine),currentLine++,words=words.splice(idx-1),idx=1):idx++}idx>0&&context.fillText(words.join(" "),x,y+lineHeight*currentLine)},Tutorial.prototype.LineCount=function(context,text,fitWidth){fitWidth=fitWidth||0;if(fitWidth<=0)return 1;var words=text.split(" "),currentLine=0,idx=1;while(words.length>0&&idx<=words.length){var str=words.slice(0,idx).join(" "),w=context.measureText(str).width;w>fitWidth?(idx==1&&(idx=2),currentLine++,words=words.splice(idx-1),idx=1):idx++}return currentLine},Tutorial.prototype.NumberWithCommas=function(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},Tutorial.prototype.DelayTo=function(panel,destination,t,delay,v){var offsetTween=new window.TWEEN.Tween({x:panel[""+v]});offsetTween.to({x:destination},t*1e3),offsetTween.onUpdate(function(){panel[""+v]=this.x}),offsetTween.onComplete(function(){v=="OffsetY"&&destination!==0&&(panel.Open=!1)}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick)},Tutorial.prototype.OpenSplash=function(){this.SplashOpen=!0,this.DelayTo(this.Offset2,0,1,0,"x"),App.Stage&&App.MainScene.Header.DropDown&&App.MainScene.Header.ClosePanel(),this.Open&&this.ClosePanel()},Tutorial.prototype.CloseSplash=function(){this.SplashOpen=!1,this.DelayTo(this.Offset2,-1,.6,0,"x")},Tutorial.prototype.OpenPanel=function(){App.Blocks.length&&App.Stage.MainScene.ResetScene(),App.MainScene.ZoomButtons.ZoomReset(!1),this.OptionsInteract=!1,App.PointerInputManager.TouchAssumed?(this.Text=App.L10n.UI.TutorialTouch,this._TutKeys=!1):(this.Text=App.L10n.UI.Tutorial,this._TutKeys=!0),this.CurrentScene=1,this.TotalScenes=this.Text.Scenes.length,this.Open=!0,this.CountIntroLines(),this.DelayTo(this.Offset,this.TextWidth+20,1,0,"x")},Tutorial.prototype.ClosePanel=function(){this.Open=!1,App.MainScene.TutorialHotspots.Points=[],this.WatchedBlocks=[],this.DelayTo(this.Offset,-20,.5,0,"x")},Tutorial.prototype.NextScene=function(){var t=.4;this.DelayTo(this.Offset,-20,t,0,"x");var that=this;setTimeout(function(){that.CurrentScene<that.TotalScenes&&(that.CurrentScene+=1,that.CountIntroLines(),that.DelayTo(that.Offset,that.TextWidth+20,t,0,"x"))},t*1e3)},Tutorial.prototype.Skip=function(){App.SkipTutorial=!0},Tutorial.prototype.UpdateHotspots=function(){var ctx=this.Ctx,units=App.Unit,header=App.MainScene.Header,menuH=header.Height*header.Rows*units,itemWidth=App.Width/(header.ItemsPerPage+1),hotspots=[],itemX;if(this._TutKeys)switch(this.CurrentScene){case 1:this.WatchedBlocks[0]||(header.DropDown&&header.MenuItems[0].Selected?header.MenuItems[0].CurrentPage===0&&(itemX=this.GutterCheck(0,itemWidth,header.MenuItems[0],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[0].Position.x,menuH)));break;case 2:this.WatchedBlocks[1]||(header.DropDown&&header.MenuItems[3].Selected?header.MenuItems[3].CurrentPage===0&&(itemX=this.GutterCheck(0,itemWidth,header.MenuItems[3],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[3].Position.x,menuH)));break;case 3:this.WatchedBlocks[4]||(header.DropDown&&header.MenuItems[1].Selected?header.MenuItems[1].CurrentPage===0&&(itemX=this.GutterCheck(3,itemWidth,header.MenuItems[1],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[1].Position.x,menuH)));break;case 4:if(this.WatchedBlocks[3]&&!App.MainScene.IsDraggingABlock){var blockPos=new Point(this.WatchedBlocks[3].Position.x,this.WatchedBlocks[3].Position.y+2);blockPos=App.Metrics.PointOnGrid(blockPos),hotspots.push(new Point(blockPos.x,blockPos.y+6*units))}break;case 5:if(this.WatchedBlocks[1]){if(!App.MainScene.IsDraggingABlock){var blockPos=new Point(this.WatchedBlocks[1].Position.x,this.WatchedBlocks[1].Position.y+2);blockPos=App.Metrics.PointOnGrid(blockPos),hotspots.push(new Point(blockPos.x,blockPos.y+6*units))}hotspots.push(new Point(App.Width-46*units,App.Height-30*units))}break;case 6:this.WatchedBlocks[5]||(header.DropDown&&header.MenuItems[2].Selected?header.MenuItems[2].CurrentPage===0&&(itemX=this.GutterCheck(0,itemWidth,header.MenuItems[2],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[2].Position.x,menuH)));if(!this.WatchedBlocks[5]||App.MainScene.IsDraggingABlock){var blockPos=new Point(this.WatchedBlocks[0].Position.x,this.WatchedBlocks[0].Position.y+12);blockPos=App.Metrics.PointOnGrid(blockPos),hotspots.push(new Point(blockPos.x,blockPos.y))}break;case 7:this.WatchedBlocks[6]||(header.DropDown&&header.MenuItems[2].Selected?header.MenuItems[2].CurrentPage===0&&(itemX=this.GutterCheck(1,itemWidth,header.MenuItems[2],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[2].Position.x,menuH)));break;default:}else switch(this.CurrentScene){case 1:this.WatchedBlocks[0]||(header.DropDown&&header.MenuItems[0].Selected?header.MenuItems[0].CurrentPage===0&&(itemX=this.GutterCheck(0,itemWidth,header.MenuItems[0],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[0].Position.x,menuH)));break;case 2:this.WatchedBlocks[5]||(header.DropDown&&header.MenuItems[2].Selected?header.MenuItems[2].CurrentPage===0&&(itemX=this.GutterCheck(0,itemWidth,header.MenuItems[2],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[2].Position.x,menuH)));if(!this.WatchedBlocks[5]||App.MainScene.IsDraggingABlock){var blockPos=new Point(this.WatchedBlocks[0].Position.x,this.WatchedBlocks[0].Position.y+12);blockPos=App.Metrics.PointOnGrid(blockPos),hotspots.push(new Point(blockPos.x,blockPos.y))}break;case 3:this.WatchedBlocks[6]||(header.DropDown&&header.MenuItems[2].Selected?header.MenuItems[2].CurrentPage===0&&(itemX=this.GutterCheck(1,itemWidth,header.MenuItems[2],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[2].Position.x,menuH)));break;case 4:this.WatchedBlocks[4]||(header.DropDown&&header.MenuItems[1].Selected?header.MenuItems[1].CurrentPage===0&&(itemX=this.GutterCheck(3,itemWidth,header.MenuItems[1],units),hotspots.push(new Point(itemX,menuH+header.DropDown*units))):hotspots.push(new Point(header.MenuItems[1].Position.x,menuH)));break;case 5:if(this.WatchedBlocks[3]&&!App.MainScene.IsDraggingABlock){var blockPos=new Point(this.WatchedBlocks[3].Position.x,this.WatchedBlocks[3].Position.y+2);blockPos=App.Metrics.PointOnGrid(blockPos),hotspots.push(new Point(blockPos.x,blockPos.y+6*units))}break;default:}App.MainScene.TutorialHotspots.Points=hotspots},Tutorial.prototype.GutterCheck=function(n,w,cat,units){return cat.Pages===0?w*(n+.5)+20*units:w*(n+1)},Tutorial.prototype.SplashMouseDown=function(point){this.HitTests(point),this.SplashOpen&&(this._RollOvers[0]&&this.OpenPanel(),this._RollOvers[1]&&this.Skip(),this.CloseSplash())},Tutorial.prototype.MouseDown=function(point){this.HitTests(point),this._RollOvers[2]&&(this.ClosePanel(),this.Skip())},Tutorial.prototype.MouseUp=function(point){},Tutorial.prototype.MouseMove=function(point){this.HitTests(point)},Tutorial.prototype.HitTests=function(point){var ctx=this.Ctx,units=App.Unit,x=App.Width-this.Offset.x*units,y=App.Height*.5+this.Offset.y*units-20*units,btnY=50*units,lineHeight=this._LineHeight*units,introOffset=(this.IntroLines+2)*lineHeight,taskOffset=this.TaskLines*lineHeight,padding=60*units,iconY=App.Height*.5+20*units;this._RollOvers[0]=Dimensions.hitRect(App.Width*.5-padding*2,iconY-20*units,padding*2,60*units,point.x,point.y),this._RollOvers[1]=Dimensions.hitRect(App.Width*.5,iconY-20*units,padding*2,60*units,point.x,point.y),this.CurrentScene<this.TotalScenes?this._RollOvers[2]=Dimensions.hitRect(x-10*units,y+btnY+introOffset+taskOffset-10*units,40*units+this._SkipBtnWidth,40*units,point.x,point.y):(taskOffset=(this.TaskLines-2)*lineHeight,this._RollOvers[2]=Dimensions.hitRect(x-10*units,y+btnY+introOffset+taskOffset-10*units,40*units+this._DoneBtnWidth,40*units,point.x,point.y)),this.Hover=!1,this.Open&&this._RollOvers[2]&&(this.Hover=!0),this.SplashOpen&&(this._RollOvers[0]||this._RollOvers[1])&&(this.Hover=!0)},Tutorial.prototype.Resize=function(){this.Text&&this.Open&&this.CountIntroLines()},Tutorial.prototype.CountIntroLines=function(){var units=App.Unit;this.Ctx.font=App.Metrics.TxtMid,this._SkipBtnWidth=this.Ctx.measureText(this.Text.SkipButton.toUpperCase()).width,this._DoneBtnWidth=this.Ctx.measureText(this.Text.DoneButton.toUpperCase()).width;var scene=this.Text.Scenes[this.CurrentScene-1];this.Ctx.font=App.Metrics.TxtItalic3,this.IntroLines=this.LineCount(this.Ctx,scene.Intro,this.TextWidth*units),this.TaskLines=this.LineCount(this.Ctx,scene.Task,this.TextWidth*units)},Tutorial}(DisplayObject);exports.Tutorial=Tutorial});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/TutorialHotspots",["require","exports"],function(require,exports){var DisplayObject=etch.drawing.DisplayObject,TutorialHotspots=function(_super){__extends(TutorialHotspots,_super);function TutorialHotspots(){_super.apply(this,arguments),this.Points=[]}return TutorialHotspots.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this._Pulse=0,this._Polarity=1},TutorialHotspots.prototype.Update=function(){this.Points.length&&(this._Polarity===1?(this._Pulse+=1,this._Pulse>100&&(this._Polarity=-this._Polarity)):(this._Pulse-=1,this._Pulse<0&&(this._Polarity=-this._Polarity)))},TutorialHotspots.prototype.Draw=function(){var ctx=this.Ctx,units=App.Unit;this.Ctx.globalAlpha=1,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]);if(this.Points.length)for(var i=0;i<this.Points.length;i++){var x=this.Points[i].x,y=this.Points[i].y,size=2;ctx.beginPath(),ctx.moveTo(x,y-size*units),ctx.lineTo(x-size*units,y),ctx.lineTo(x,y+size*units),ctx.lineTo(x+size*units,y),ctx.closePath(),ctx.fill(),this.Ctx.lineWidth=2;var size=4+this._Pulse*.06+Math.random();ctx.beginPath(),ctx.moveTo(x,y-size*units),ctx.lineTo(x-size*units,y),ctx.lineTo(x,y+size*units),ctx.lineTo(x+size*units,y),ctx.closePath(),ctx.stroke()}},TutorialHotspots}(DisplayObject);exports.TutorialHotspots=TutorialHotspots});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("UI/ZoomButtons",["require","exports"],function(require,exports){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,Point=minerva.Point,ZoomButtons=function(_super){__extends(ZoomButtons,_super);function ZoomButtons(){_super.apply(this,arguments)}return ZoomButtons.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo),this.InRoll=this.OutRoll=!1,this.Tweens=[],this._ZoomSlots=[.25,.5,1,2,4],this.CurrentSlot=2,this.ZoomAlpha=0},ZoomButtons.prototype.UpdateSlot=function(zoom){this.CurrentSlot=this._ZoomSlots.indexOf(zoom)},ZoomButtons.prototype.Draw=function(){var units=App.Unit,ctx=this.Ctx;ctx.globalAlpha=1,ctx.lineWidth=2,App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]);var zin=this._InPos,zout=this._OutPos,im=1,om=1;this.InRoll&&(im=1.2),this.OutRoll&&(om=1.2);var diamond=11;ctx.beginPath(),ctx.moveTo(zin.x,zin.y-5*im*units),ctx.lineTo(zin.x,zin.y+5*im*units),ctx.moveTo(zin.x-5*im*units,zin.y),ctx.lineTo(zin.x+5*im*units,zin.y),ctx.stroke(),ctx.beginPath(),ctx.moveTo(zout.x-5*om*units,zout.y),ctx.lineTo(zout.x+5*om*units,zout.y),ctx.stroke(),ctx.lineWidth=1;var x=zin.x+(zout.x-zin.x)*.5;ctx.beginPath(),ctx.moveTo(x,zin.y-diamond*units),ctx.lineTo(x,zin.y+diamond*units),ctx.closePath(),ctx.stroke();if(this.ZoomAlpha>0){ctx.globalAlpha=this.ZoomAlpha,ctx.textAlign="center",ctx.font=App.Metrics.TxtUrl2;var string="x "+Math.round(App.ZoomLevel*100)/100;ctx.fillText(string,50*units,App.Height-50*units)}ctx.globalAlpha=1},ZoomButtons.prototype.DelayTo=function(panel,destination,t,delay,v){var offsetTween=new window.TWEEN.Tween({x:panel[""+v]});offsetTween.to({x:destination},t),offsetTween.onUpdate(function(){panel[""+v]=this.x,v==="ZoomLevel"&&panel.Metrics.UpdateGridScale()}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick),this.Tweens.push(offsetTween)},ZoomButtons.prototype.StopAllTweens=function(){if(this.Tweens.length){for(var j=0;j<this.Tweens.length;j++)this.Tweens[j].stop();this.Tweens=[]}},ZoomButtons.prototype.MouseMove=function(point){this.HitTests(point)},ZoomButtons.prototype.MouseDown=function(point){this.HitTests(point),this.InRoll&&this.ZoomIn(),this.OutRoll&&this.ZoomOut()},ZoomButtons.prototype.MouseWheel=function(e){},ZoomButtons.prototype.HitTests=function(point){var units=App.Unit,zin=this._InPos,zout=this._OutPos,area=30*units;this.InRoll=Dimensions.hitRect(zin.x-area*.5,zin.y-area*.5,area,area,point.x,point.y),this.OutRoll=Dimensions.hitRect(zout.x-area*.5,zout.y-area*.5,area,area,point.x,point.y)},ZoomButtons.prototype.ZoomIn=function(){this.CurrentSlot<this._ZoomSlots.length-1&&(App.MainScene.OptionsPanel.Close(),this.CurrentSlot+=1,this.StopAllTweens(),this.ZoomAlpha=1,this.DelayTo(App,this._ZoomSlots[this.CurrentSlot],500,0,"ZoomLevel"),this.DelayTo(this,0,500,700,"ZoomAlpha"))},ZoomButtons.prototype.ZoomOut=function(){this.CurrentSlot>0&&(App.MainScene.OptionsPanel.Close(),this.CurrentSlot-=1,this.StopAllTweens(),this.ZoomAlpha=1,this.DelayTo(App,this._ZoomSlots[this.CurrentSlot],500,0,"ZoomLevel"),this.DelayTo(this,0,500,700,"ZoomAlpha"))},ZoomButtons.prototype.ZoomReset=function(display){display=display||!1,this.CurrentSlot=2,this.StopAllTweens(),this.DelayTo(App,this._ZoomSlots[this.CurrentSlot],500,0,"ZoomLevel"),display&&(this.ZoomAlpha=1,this.DelayTo(this,0,500,700,"ZoomAlpha"))},ZoomButtons.prototype.Resize=function(){var units=App.Unit;this._InPos=new Point(30*units,App.Height-30*units),this._OutPos=new Point(70*units,App.Height-30*units)},ZoomButtons}(DisplayObject);exports.ZoomButtons=ZoomButtons});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("MainScene",["require","exports","./UI/AnimationsLayer","./UI/CreateNew","./Commands","./UI/ConnectionLines","./Blocks/Interaction/Controller","./UI/Header","./LaserBeams","./UI/MessagePanel","./UI/OptionsPanel","./ParticleLayer","./Blocks/Power/PowerEffect","./Blocks/Power/PowerSource","./UI/RecorderPanel","./UI/SettingsPanel","./UI/SharePanel","./UI/SoundcloudPanel","./UI/StageDragger","./UI/ToolTip","./UI/TrashCan","./UI/Tutorial","./UI/TutorialHotspots","./UI/ZoomButtons"],function(require,exports,AnimationsLayer_1,CreateNew_1,Commands_1,ConnectionLines_1,Controller_1,Header_1,LaserBeams_1,MessagePanel_1,OptionsPanel_1,ParticleLayer_1,PowerEffect_1,PowerSource_1,RecorderPanel_1,SettingsPanel_1,SharePanel_1,SoundcloudPanel_1,StageDragger_1,ToolTip_1,TrashCan_1,Tutorial_1,TutorialHotspots_1,ZoomButtons_1){var Dimensions=Utils.Measurements.Dimensions,DisplayObject=etch.drawing.DisplayObject,Point=etch.primitives.Point,MainScene=function(_super){__extends(MainScene,_super);function MainScene(){_super.call(this),this._IsPointerDown=!1,this.IsDraggingABlock=!1}return MainScene.prototype.Setup=function(){var _this=this;_super.prototype.Setup.call(this),App.PointerInputManager.MouseDown.on(function(s,e){_this.MouseDown(e)},this),App.PointerInputManager.MouseUp.on(function(s,e){_this.MouseUp(e)},this),App.PointerInputManager.MouseMove.on(function(s,e){_this.MouseMove(e)},this),App.PointerInputManager.MouseWheel.on(function(s,e){_this.MouseWheel(e)},this),App.PointerInputManager.TouchStart.on(function(s,e){_this.TouchStart(e)},this),App.PointerInputManager.TouchEnd.on(function(s,e){_this.TouchEnd(e)},this),App.PointerInputManager.TouchMove.on(function(s,e){_this.TouchMove(e)},this),App.OperationManager.OperationComplete.on(function(operation){_this._Invalidate()},this),App.CompositionLoaded.on(function(s,e){_this.CompositionLoaded(e)},this),OptionTimeout=!1,this._PointerPoint=new Point,this._SelectedBlockPosition=new Point,this.ConnectionLines=new ConnectionLines_1.ConnectionLines,this.DisplayList.Add(this.ConnectionLines),this.ConnectionLines.Init(this),this.BlocksContainer=new DisplayObject,this.DisplayList.Add(this.BlocksContainer),this.BlocksContainer.Init(this),this.LaserBeams=new LaserBeams_1.LaserBeams,this.DisplayList.Add(this.LaserBeams),this.LaserBeams.Init(this),this.Particles=new ParticleLayer_1.ParticleLayer,this.DisplayList.Add(this.Particles),this.Particles.Init(this),this._ToolTip=new ToolTip_1.ToolTip,this.DisplayList.Add(this._ToolTip),this._ToolTip.Init(this),this.AnimationsLayer=new AnimationsLayer_1.AnimationsLayer,this.DisplayList.Add(this.AnimationsLayer),this.AnimationsLayer.Init(this),this._RecorderPanel=new RecorderPanel_1.RecorderPanel,this.DisplayList.Add(this._RecorderPanel),this._RecorderPanel.Init(this),this.ZoomButtons=new ZoomButtons_1.ZoomButtons,this.DisplayList.Add(this.ZoomButtons),this.ZoomButtons.Init(this),this.MainSceneDragger=new StageDragger_1.StageDragger,this.DisplayList.Add(this.MainSceneDragger),this.MainSceneDragger.Init(this),this._TrashCan=new TrashCan_1.TrashCan,this.DisplayList.Add(this._TrashCan),this._TrashCan.Init(this),this.Tutorial=new Tutorial_1.Tutorial,this.DisplayList.Add(this.Tutorial),this.Tutorial.Init(this),this.OptionsPanel=new OptionsPanel_1.OptionsPanel,this.DisplayList.Add(this.OptionsPanel),this.OptionsPanel.Init(this),this.Header=new Header_1.Header,this.DisplayList.Add(this.Header),this.Header.Init(this),this.CreateNew=new CreateNew_1.CreateNew,this.DisplayList.Add(this.CreateNew),this.CreateNew.Init(this),this.TutorialHotspots=new TutorialHotspots_1.TutorialHotspots,this.DisplayList.Add(this.TutorialHotspots),this.TutorialHotspots.Init(this),this.SharePanel=new SharePanel_1.SharePanel,this.DisplayList.Add(this.SharePanel),this.SharePanel.Init(this),this.SettingsPanel=new SettingsPanel_1.SettingsPanel,this.DisplayList.Add(this.SettingsPanel),this.SettingsPanel.Init(this),this.SoundcloudPanel=new SoundcloudPanel_1.SoundcloudPanel,this.DisplayList.Add(this.SoundcloudPanel),this.SoundcloudPanel.Init(this),this.MessagePanel=new MessagePanel_1.MessagePanel,this.DisplayList.Add(this.MessagePanel),this.MessagePanel.Init(this),this._Invalidate(),App.CompositionId||this.Tutorial.CheckLaunch()},MainScene.prototype.Update=function(){if(this.IsPaused)return;_super.prototype.Update.call(this)},MainScene.prototype.Draw=function(){_super.prototype.Draw.call(this),App.FillColor(this.Ctx,App.Palette[0]),this.Ctx.globalAlpha=1,this.Ctx.fillRect(0,0,this.Width,this.Height)},MainScene.prototype.MouseDown=function(e){var position=new Point(e.clientX,e.clientY+window.pageYOffset);this._PointerDown(position)},MainScene.prototype.MouseUp=function(e){var position=new Point(e.clientX,e.clientY+window.pageYOffset);this._PointerUp(position),this._CheckHover(position)},MainScene.prototype.MouseMove=function(e){var position=new Point(e.clientX,e.clientY+window.pageYOffset);this._PointerMove(position)},MainScene.prototype.MouseWheel=function(e){this._MouseWheel(e)},MainScene.prototype.TouchStart=function(e){var touch=e.touches[0],point=new Point(touch.clientX,touch.clientY+window.pageYOffset);this._PointerDown(point)},MainScene.prototype.TouchEnd=function(e){var touch=e.changedTouches[0],point=new Point(touch.clientX,touch.clientY+window.pageYOffset);this._PointerUp(point,!0)},MainScene.prototype.TouchMove=function(e){var touch=e.touches[0],point=new Point(touch.clientX,touch.clientY+window.pageYOffset);this._PointerMove(point)},MainScene.prototype._PointerDown=function(point){App.Metrics.ConvertToPixelRatioPoint(point);if(!App.Stage.Splash.IsAnimationFinished)return;this._IsPointerDown=!0,this._PointerPoint=point;var UIInteraction,collision,tooltip=this._ToolTip,zoom=this.ZoomButtons,header=this.Header,soundcloud=this.SoundcloudPanel,share=this.SharePanel,settings=this.SettingsPanel,recorder=this._RecorderPanel,options=this.OptionsPanel,message=this.MessagePanel,create=this.CreateNew,tutorial=this.Tutorial;tooltip.Open&&this.ToolTipClose();if(message.Open&&message.Hover){message.MouseDown(point);return}if(share.Open){share.MouseDown(point);return}if(settings.Open){settings.MouseDown(point);return}if(soundcloud.Open){soundcloud.MouseDown(point);return}if(!share.Open&&!settings.Open&&!soundcloud.Open){if(tutorial.SplashOpen){tutorial.SplashMouseDown(point);if(tutorial.Hover)return}create.MouseDown(point);if(create.Hover)return;header.MouseDown(point);if(header.MenuOver)return;zoom.MouseDown(point);if(zoom.InRoll||zoom.OutRoll)return;if(options.Scale===1){options.MouseDown(point.x,point.y);if(options.Hover)return}if(tutorial.Open){tutorial.MouseDown(point);if(tutorial.Hover)return}recorder.MouseDown(point);if(recorder.Hover)return}collision=this._CheckCollision(point),collision&&(this.IsDraggingABlock=!0,this._SelectedBlockPosition=this.SelectedBlock.Position),collision||this.MainSceneDragger.MouseDown(point)},MainScene.prototype._PointerUp=function(point,isTouch){App.Metrics.ConvertToPixelRatioPoint(point),this._IsPointerDown=!1;if(this.IsDraggingABlock)var blockDelete=this._TrashCan.MouseUp();this.IsDraggingABlock=!1,blockDelete||(this.SelectedBlock&&this.SelectedBlock.IsPressed&&(this.SelectedBlock.MouseUp(),Point.isEqual(this.SelectedBlock.Position,this.SelectedBlock.LastPosition)||App.CommandManager.ExecuteCommand(Commands_1.Commands.MOVE_BLOCK,this.SelectedBlock)),OptionTimeout&&this.OptionsPanel.Open(this.SelectedBlock)),this.SharePanel.Open?this.SharePanel.MouseUp(point,isTouch):this.SettingsPanel.Open?this.SettingsPanel.MouseUp(point):(this.Header.MouseUp(),this.OptionsPanel.Scale===1&&this.OptionsPanel.MouseUp(),this.MainSceneDragger.MouseUp())},MainScene.prototype._PointerMove=function(point){App.Metrics.ConvertToPixelRatioPoint(point),App.Canvas.Style.cursor="default",this._CheckHover(point),this.SelectedBlock&&(this.SelectedBlock.MouseMove(point),this._CheckProximity(),this.IsDraggingABlock&&(Math.round(this.SelectedBlock.Position.x)!==Math.round(this._SelectedBlockPosition.x)||Math.round(this.SelectedBlock.Position.y)!==Math.round(this._SelectedBlockPosition.y))&&(this._SelectedBlockPosition=this.SelectedBlock.Position,this._ABlockHasBeenMoved(),this.OptionsPanel.Scale===1&&this.OptionsPanel.Close())),this.OptionsPanel.Scale===1&&this.OptionsPanel.MouseMove(point.x,point.y),this.SharePanel.Open&&this.SharePanel.MouseMove(point),this.SettingsPanel.Open&&this.SettingsPanel.MouseMove(point),this.SoundcloudPanel.Open&&this.SoundcloudPanel.MouseMove(point),this.MessagePanel.Open&&this.MessagePanel.MouseMove(point),this.Header.MouseMove(point),this._RecorderPanel.MouseMove(point),this.CreateNew.MouseMove(point),(this.Tutorial.Open||this.Tutorial.SplashOpen)&&this.Tutorial.MouseMove(point),this.ZoomButtons.MouseMove(point),this._TrashCan.MouseMove(point),this.MainSceneDragger.MouseMove(point)},MainScene.prototype._MouseWheel=function(e){this.ZoomButtons.MouseWheel(e)},MainScene.prototype._CheckProximity=function(){for(var j=0;j<App.Sources.length;j++){var source=App.Sources[j];for(var i=0;i<App.Effects.length;i++){var effect=App.Effects[i],catchmentArea=App.Metrics.ConvertGridUnitsToAbsolute(new Point(effect.CatchmentArea,effect.CatchmentArea)),distanceFromEffect=source.DistanceFrom(App.Metrics.ConvertGridUnitsToAbsolute(effect.Position));distanceFromEffect<=catchmentArea.x?source.Connections.Contains(effect)||!(source instanceof PowerSource_1.PowerSource&&effect instanceof Controller_1.Controller)&&(source instanceof PowerSource_1.PowerSource&&effect instanceof PowerEffect_1.PowerEffect||!(source instanceof PowerSource_1.PowerSource))&&(effect.AddSource(source),source.AddEffect(effect),this._Invalidate(),App.Audio.ConnectionManager.Update()):source.Connections.Contains(effect)&&(effect.RemoveSource(source),source.RemoveEffect(effect),this._Invalidate(),App.Audio.ConnectionManager.Update())}}},MainScene.prototype._CheckCollision=function(point){for(var i=App.Blocks.length-1;i>=0;i--){var block=App.Blocks[i];if(block.HitTest(point))return block.MouseDown(),this.SelectedBlock=block,OptionTimeout=!0,setTimeout(function(){OptionTimeout=!1},App.Config.SingleClickTime),!0}return this.OptionsPanel.Close(),!1},MainScene.prototype._CheckHover=function(point){var panelCheck=!1,blockHover=!1,panel=this._ToolTip;this.OptionsPanel.Scale===1&&(panelCheck=Dimensions.hitRect(this.OptionsPanel.Position.x,this.OptionsPanel.Position.y-this.OptionsPanel.Size.height*.5,this.OptionsPanel.Size.width,this.OptionsPanel.Size.height,point.x,point.y));if(!panelCheck&&!this._IsPointerDown)for(var i=App.Blocks.length-1;i>=0;i--){var block=App.Blocks[i];if(block.HitTest(point)){panel.Name=block.BlockName;var blockPos=App.Metrics.PointOnGrid(block.Position);panel.Position.x=blockPos.x,panel.Position.y=blockPos.y,blockHover=!0;break}}blockHover&&!panel.Open&&!this.OptionsPanel.Opening&&(panel.Open=!0,panel.Alpha>0?panel.AlphaTo(panel,100,600):this._ToolTipTimeout=setTimeout(function(){panel.Alpha===0&&panel.AlphaTo(panel,100,600)},550)),!blockHover&&panel.Open&&this.ToolTipClose()},MainScene.prototype.ToolTipClose=function(){var panel=this._ToolTip;clearTimeout(this._ToolTipTimeout),panel.StopTween(),panel.AlphaTo(panel,0,200),panel.Open=!1},MainScene.prototype._ABlockHasBeenMoved=function(){this.LaserBeams.UpdateAllLasers=!0,this.ConnectionLines.UpdateList()},MainScene.prototype._UIInteraction=function(){var zoom=this.ZoomButtons,header=this.Header,share=this.SharePanel,settings=this.SettingsPanel,soundcloud=this.SoundcloudPanel,recorder=this._RecorderPanel,options=this.OptionsPanel,message=this.MessagePanel,create=this.CreateNew,tutorial=this.Tutorial;return zoom.InRoll||zoom.OutRoll||header.MenuOver||share.Open||settings.Open||soundcloud.Open||recorder.Hover||message.Open&&message.Hover||create.Hover||(tutorial.Open||tutorial.SplashOpen)&&tutorial.Hover||options.Scale===1&&options.Hover?!0:!1},Object.defineProperty(MainScene.prototype,"SelectedBlock",{get:function(){return this._SelectedBlock},set:function(block){!block&&this._SelectedBlock?(this._SelectedBlock.IsSelected=!1,this._SelectedBlock=null):(this._SelectedBlock&&(this._SelectedBlock.IsSelected=!1),block&&(block.IsSelected=!0,this._SelectedBlock=block,this.BlockToFront(block)))},enumerable:!0,configurable:!0}),MainScene.prototype.BlockToFront=function(block){this.BlocksContainer.DisplayList.ToFront(block)},MainScene.prototype._Invalidate=function(){this._ValidateBlocks(),this._CheckProximity(),this.CreateNew.CheckState(),this.Tutorial.CheckTask()},MainScene.prototype._ValidateBlocks=function(){for(var i=0;i<App.Sources.length;i++){var src=App.Sources[i];src.ValidateEffects()}for(var i=0;i<App.Effects.length;i++){var effect=App.Effects[i];effect.ValidateSources()}},MainScene.prototype.DuplicateParams=function(params){var paramsCopy={};for(var key in params)paramsCopy[""+key]=params[""+key];return paramsCopy},MainScene.prototype.CreateBlockFromType=function(t,params){var block=new t;return block.Id=App.GetBlockId(),block.Position=App.Metrics.CursorToGrid(this._PointerPoint),params&&(block.Params=this.DuplicateParams(params)),block.Init(this),block.Type=t,App.CommandManager.ExecuteCommand(Commands_1.Commands.CREATE_BLOCK,block),block.MouseDown(),this.SelectedBlock=block,this.BlockToFront(block),this.IsDraggingABlock=!0,block},MainScene.prototype.CompositionLoaded=function(e){this.BlocksContainer.DisplayList.AddRange(App.Blocks);for(var i=0;i<this.BlocksContainer.DisplayList.Count;i++){var block=this.BlocksContainer.DisplayList.GetValueAt(i);block.Init(this)}this.MainSceneDragger&&(this.MainSceneDragger.Destination=new Point(e.SaveFile.DragOffset.x,e.SaveFile.DragOffset.y)),this.ZoomButtons.UpdateSlot(e.SaveFile.ZoomLevel),this.SharePanel.Reset(),App.Metrics.UpdateGridScale(),this._Invalidate();if(App.Stage.Splash.IOSPause)return;this.Begin()},MainScene.prototype.Begin=function(){var _this=this;setTimeout(function(){_this.Play(),_this.ConnectionLines.UpdateList()},2400);var volume=-30,volumeFade=setInterval(function(){volume<App.Audio.MasterVolume?(App.Audio.Master.volume.value=volume,volume+=2):clearInterval(volumeFade)},70)},MainScene.prototype.DeleteSelectedBlock=function(){var _this=this;if(!this.SelectedBlock)return;this.SelectedBlock.IsPressed&&this.SelectedBlock.MouseUp(),this.OptionsPanel.Close(),App.CommandManager.ExecuteCommand(Commands_1.Commands.DELETE_BLOCK,this.SelectedBlock),this.SelectedBlock=null,setTimeout(function(){_this.ConnectionLines.UpdateList()},1)},MainScene.prototype.DeleteBlock=function(block){this.BlocksContainer.DisplayList.Remove(block),App.Blocks.remove(block),block.Dispose(),block=null},MainScene.prototype.DeleteAllBlocks=function(){var blockList=[];for(var i=0;i<App.Blocks.length;i++)blockList.push(App.Blocks[i]);for(i=0;i<blockList.length;i++)this.DeleteBlock(blockList[i])},MainScene.prototype.ResetScene=function(){this.Tutorial.Open&&this.Tutorial.ClosePanel(),this.DeleteAllBlocks(),this.Tutorial.WatchedBlocks=[],this.ConnectionLines.UpdateList(),this.SelectedBlock=null,App.DragOffset.x=0,App.DragOffset.y=0,this.ZoomButtons.CurrentSlot=2,this.MainSceneDragger.Destination=new Point(App.DragOffset.x,App.DragOffset.y),App.ZoomLevel=1,App.Particles=[],App.Metrics.UpdateGridScale(),this.OptionsPanel.Close(),App.AddressBarManager.StripURL(),App.CompositionId=null,App.SessionId=null,this.SharePanel.Reset(),this._Invalidate()},MainScene.prototype.Resize=function(){this.OptionsPanel.Close(),this.Header.Populate(this.Header.MenuJson),this.SettingsPanel.Populate(this.SettingsPanel.MenuJson)},MainScene}(DisplayObject);exports.MainScene=MainScene}),define("Core/Audio/Utils/Utils",["require","exports"],function(require,exports){function hasAudioContextStarted(context){return context!==null&&context.state==="running"}exports.hasAudioContextStarted=hasAudioContextStarted;function unlockAudioContext(context,cb){var source=createEmptyBuffer(context);setTimeout(function(){(source.playbackState===source.PLAYING_STATE||source.playbackState===source.FINISHED_STATE)&&cb()},1)}exports.unlockAudioContext=unlockAudioContext;function createEmptyBuffer(context){var buffer=context.createBuffer(1,1,22050),source=context.createBufferSource();return source.buffer=buffer,source.connect(context.destination),source.start(context.currentTime),source.stop(context.currentTime+.5),source}exports.createEmptyBuffer=createEmptyBuffer;function isIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}exports.isIOS=isIOS});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Splash",["require","exports","./Core/Audio/Utils/Utils","etch"],function(require,exports,Utils_1){var DisplayObject=etch.drawing.DisplayObject,Point=minerva.Point,Splash=function(_super){__extends(Splash,_super);function Splash(){_super.apply(this,arguments),this.IOSPause=!1,this.IsAnimationFinished=!1,this.IsTransitionFinished=!1,this.AnimationFinished=new nullstone.Event,this._hasTouchMoved=!1}return Splash.prototype.Init=function(drawTo){_super.prototype.Init.call(this,drawTo)},Splash.prototype.Setup=function(){var _this=this;_super.prototype.Setup.call(this),this._Offset=new Point(0,0),this.XOffset=0,this.YOffset=-1,this.LoadOffset=-1,this.ButtonOffset=-1,App.PointerInputManager.MouseDown.on(function(s,e){_this.MouseDown(e)},this),App.PointerInputManager.TouchEnd.on(function(s,e){_this.TouchEnd(e)},this),App.PointerInputManager.TouchMove.on(function(s,e){_this._hasTouchMoved=!0},this)},Splash.prototype.Draw=function(){_super.prototype.Draw.call(this);if(this.IsTransitionFinished)return;this.IsFirstFrame()&&this.TransitionIn();var colorful=!1,units=App.Unit,ctx=this.Ctx;this._Scale=100*units,this.Ctx.globalAlpha=1;if(App.IsLoadingComposition){var dx=0,dy=App.Height*this.LoadOffset;App.FillColor(this.Ctx,App.Palette[0]),this.Ctx.fillRect(dx,dy,App.Width,App.Height);var dx=App.Width*.5,dy=App.Height*.5+App.Height*this.LoadOffset;App.FillColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),this.Ctx.textAlign="center",this.Ctx.font=App.Metrics.TxtHeader,this.Ctx.fillText("LOADING SCENE",dx,dy+26*units),App.AnimationsLayer.DrawSprite(this.Ctx,"loading",dx,dy-16*units,16,!0)}this._Offset=new Point(0,1),App.FillRGBA(this.Ctx,10,10,10,1),this.CenterRect(),this._Center=new Point(-0.5,-0.5),this._Offset=new Point(0,0),App.FillColor(this.Ctx,App.Palette[3]),colorful||App.FillColor(this.Ctx,App.Palette[2]),this.CenterRect(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(2,0),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(-1,-1),this.DrawLineTo(0,0),this.DrawLineTo(0,2),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[6]),this.DrawMoveTo(0,0),this.DrawLineTo(1,0),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this._Center=new Point(-0.5,0),this._Offset=new Point(-1,0),App.FillColor(this.Ctx,App.Palette[4]),colorful||App.FillColor(this.Ctx,App.Palette[0]),this.CenterRect(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[5]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(2,1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[3]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,0),this.DrawLineTo(1,1),this.DrawLineTo(0,1),this.Ctx.closePath(),this.Ctx.fill(),this._Center=new Point(0,-0.5),this._Offset=new Point(-1,-1),App.FillColor(this.Ctx,App.Palette[5]),colorful||App.FillColor(this.Ctx,App.Palette[2]),this.CenterRect(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[4]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,0),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[8]),this.DrawMoveTo(-1,0),this.DrawLineTo(0,-1),this.DrawLineTo(1,-1),this.DrawLineTo(0,0),this.Ctx.closePath(),this.Ctx.fill(),this._Center=new Point(0,-0.5),this._Offset=new Point(0,-1),App.FillColor(this.Ctx,App.Palette[6]),colorful||App.FillColor(this.Ctx,App.Palette[0]),this.CenterRect(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[7]),this.DrawMoveTo(-1,-1),this.DrawLineTo(1,-1),this.DrawLineTo(1,0),this.DrawLineTo(-1,2),this.Ctx.closePath(),this.Ctx.fill(),this.Ctx.beginPath(),App.FillColor(this.Ctx,App.Palette[9]),this.DrawLineTo(-1,-1),this.DrawLineTo(0,-1),this.DrawLineTo(0,0),this.DrawLineTo(-1,1),this.Ctx.closePath(),this.Ctx.fill(),this._Center=new Point(0,0),this._Offset=new Point(1,-1),App.FillColor(this.Ctx,App.Palette[2]),this.CenterRect();var dx=App.Width*.5+this._Center.x*this._Scale+App.Width*(this._Offset.x+this.XOffset),dy=App.Height*.5+this._Center.y*this._Scale+App.Height*(this._Offset.y+this.YOffset),headerType=100*units;App.FillColor(this.Ctx,App.Palette[App.ThemeManager.Txt]),this.Ctx.textAlign="center",this.Ctx.font="200 "+headerType+"px Dosis",this.Ctx.fillText("BLOKDUST",dx,dy+headerType*.38);var by=App.Height*this.ButtonOffset;App.FillColor(this.Ctx,App.Palette[0]),this.Ctx.fillRect(0,by,App.Width,App.Height),App.FillColor(this.Ctx,App.Palette[7]),ctx.beginPath(),ctx.moveTo(App.Width*.5-this._Scale*.5,by+App.Height*.5-this._Scale),ctx.lineTo(App.Width*.5-this._Scale*.5,by+App.Height*.5+this._Scale),ctx.lineTo(App.Width*.5+this._Scale*.5,by+App.Height*.5),ctx.fill();var chY=this.LoadOffset*App.Height;App.FillColor(ctx,App.Palette[App.ThemeManager.Txt]),App.StrokeColor(ctx,App.Palette[App.ThemeManager.Txt]),ctx.font=App.Metrics.TxtLarge,ctx.textAlign="center",ctx.fillText("Chrome Recommended",App.Width*.5,chY+this.DrawTo.Height-20*units),ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(App.Width*.5-60*units,chY+this.DrawTo.Height-27*units),ctx.lineTo(App.Width*.5-63.89*units,chY+this.DrawTo.Height-20*units),ctx.lineTo(App.Width*.5-56.11*units,chY+this.DrawTo.Height-20*units),ctx.closePath(),ctx.stroke()},Splash.prototype.DrawMoveTo=function(x,y){var scale=this._Scale,dx=App.Width*.5+this._Center.x*scale+App.Width*(this._Offset.x+this.XOffset),dy=App.Height*.5+this._Center.y*scale+App.Height*(this._Offset.y+this.YOffset);this.Ctx.moveTo(dx+x*scale,dy+y*scale)},Splash.prototype.DrawLineTo=function(x,y){var scale=this._Scale,dx=App.Width*.5+this._Center.x*scale+App.Width*(this._Offset.x+this.XOffset),dy=App.Height*.5+this._Center.y*scale+App.Height*(this._Offset.y+this.YOffset);this.Ctx.lineTo(dx+x*scale,dy+y*scale)},Splash.prototype.CenterRect=function(){var dx=App.Width*(this._Offset.x+this.XOffset),dy=App.Height*(this._Offset.y+this.YOffset);this.Ctx.fillRect(dx,dy,App.Width,App.Height)},Splash.prototype.DelayTo=function(panel,destination,t,delay,v,s){var offsetTween=new window.TWEEN.Tween({x:s});offsetTween.to({x:destination},t),offsetTween.onUpdate(function(){panel[""+v]=this.x}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.delay(delay),offsetTween.start(this.LastVisualTick)},Splash.prototype.TransitionIn=function(){var initDelay=300,tweenLength=250,viewLength=350;this.DelayTo(this,0,tweenLength,initDelay,"LoadOffset",-1),Utils_1.isIOS()?(this.DelayTo(this,0,tweenLength,initDelay,"ButtonOffset",-1),this.IOSPause=!0):this.Animate(initDelay,tweenLength,viewLength)},Splash.prototype.Animate=function(initDelay,tweenLength,viewLength){var _this=this;this.DelayTo(this,0,tweenLength,initDelay,"YOffset",-1),this.DelayTo(this,1,tweenLength,viewLength+tweenLength+initDelay,"XOffset",0),this.DelayTo(this,1,tweenLength,viewLength*2+tweenLength*2+initDelay,"YOffset",0),this.DelayTo(this,0,tweenLength,viewLength*3+tweenLength*3+initDelay,"XOffset",1),this.DelayTo(this,-1,tweenLength,viewLength*4+tweenLength*4+initDelay,"XOffset",0),this.DelayTo(this,2,tweenLength+200,viewLength*5+tweenLength*5+initDelay+200,"YOffset",1),setTimeout(function(){_this.IsAnimationFinished=!0,_this.AnimationFinished.raise(_this,null)},viewLength*5+tweenLength*5+initDelay+200)},Splash.prototype.TransitionOut=function(){var _this=this;this.DelayTo(this,1,450,300,"LoadOffset",0),setTimeout(function(){_this.IsTransitionFinished=!0},800)},Splash.prototype.MouseDown=function(e){this.IOSPause&&this.StartButtonPressed()},Splash.prototype.TouchEnd=function(e){this.IOSPause&&!this._hasTouchMoved&&this.StartButtonPressed(),this._hasTouchMoved=!1},Splash.prototype.StartButtonPressed=function(){var _this=this;Utils_1.hasAudioContextStarted(App.Audio.ctx)?this.StartAppAfterPause():Utils_1.unlockAudioContext(App.Audio.ctx,function(){_this.StartAppAfterPause()})},Splash.prototype.StartAppAfterPause=function(){this.IOSPause=!1;var initDelay=300,tweenLength=250,viewLength=350;this.DelayTo(this,1,tweenLength,initDelay,"ButtonOffset",0),this.Animate(initDelay,tweenLength,viewLength),App.IsLoadingComposition||App.MainScene.Begin()},Splash}(DisplayObject);exports.Splash=Splash});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Stage",["require","exports","./MainScene","./Splash"],function(require,exports,MainScene_1,Splash_1){var Stage=function(_super){__extends(Stage,_super);function Stage(){var _this=this;_super.call(this),this.MainScene=new MainScene_1.MainScene,this.DisplayList.Add(this.MainScene),this.MainScene.Init(App.Canvas),this.MainScene.Hide(),this.Splash=new Splash_1.Splash,this.DisplayList.Add(this.Splash),this.Splash.Init(App.Canvas),this.Splash.AnimationFinished.on(function(s){App.IsLoadingComposition||(_this.MainScene.Show(),_this.Splash.TransitionOut())},this),App.CompositionLoaded.on(function(s,e){_this.CompositionLoaded(e)},this),App.CompositionLoadFailed.on(function(s,e){_this.CompositionLoadFailed(e)},this)}return Stage.prototype.CompositionLoaded=function(e){this.Splash.IsAnimationFinished&&(this.Splash.TransitionOut(),this.MainScene.Show())},Stage.prototype.CompositionLoadFailed=function(e){this.Splash.Hide(),this.MainScene.Show(),this.MainScene.MessagePanel.NewMessage(App.L10n.Errors.LoadError)},Stage}(etch.drawing.Stage);exports.Stage=Stage}),define("Core/Visual/ColorTheme",["require","exports"],function(require,exports){var ColorTheme=function(){function ColorTheme(name,url,options){this.Name=name,this.PaletteURL=url,this.Options=options||{}}return ColorTheme}();exports.ColorTheme=ColorTheme}),define("Core/Visual/ThemeChangeEventArgs",["require","exports"],function(require,exports){var ThemeChangeEventArgs=function(){function ThemeChangeEventArgs(index,palette){Object.defineProperty(this,"Index",{value:index,writable:!1}),Object.defineProperty(this,"Palette",{value:palette,writable:!1})}return ThemeChangeEventArgs}();exports.ThemeChangeEventArgs=ThemeChangeEventArgs}),define("Core/Visual/ThemeManager",["require","exports","./ColorTheme","./ThemeChangeEventArgs"],function(require,exports,ColorTheme_1,ThemeChangeEventArgs_1){var ThemeManager=function(){function ThemeManager(){this.ThemeChanged=new nullstone.Event,this.Loaded=!1,this.Themes=[new ColorTheme_1.ColorTheme("MODE STEREO",App.Config.PixelPaletteImagePath[0],{options:[3,4,7,5,9]}),new ColorTheme_1.ColorTheme("PENCIL CONTROL",App.Config.PixelPaletteImagePath[2]),new ColorTheme_1.ColorTheme("FJORD",App.Config.PixelPaletteImagePath[1]),new ColorTheme_1.ColorTheme("CONSOLE",App.Config.PixelPaletteImagePath[10],{menu:[3,5,7,4,6],options:[3,4,5,7,6]}),new ColorTheme_1.ColorTheme("FRIENDS",App.Config.PixelPaletteImagePath[3],{menu:[3,5,7,4,6]}),new ColorTheme_1.ColorTheme("KORAL",App.Config.PixelPaletteImagePath[4],{options:[7,6,9,4,3]}),new ColorTheme_1.ColorTheme("SEA CUCUMBER",App.Config.PixelPaletteImagePath[9],{menu:[3,9,10,4,6],options:[3,4,9,10,6]}),new ColorTheme_1.ColorTheme("RIKI",App.Config.PixelPaletteImagePath[7]),new ColorTheme_1.ColorTheme("ARROW MOUNTAIN",App.Config.PixelPaletteImagePath[8],{menu:[6,5,7,4,3]}),new ColorTheme_1.ColorTheme("ASH PEAK",App.Config.PixelPaletteImagePath[12],{menu:[6,5,8,4,3],options:[3,4,5,6,7],txt:11}),new ColorTheme_1.ColorTheme("VOLCANOLOGIST",App.Config.PixelPaletteImagePath[13],{menu:[3,8,7,4,10],txt:11}),new ColorTheme_1.ColorTheme("IKKO",App.Config.PixelPaletteImagePath[14],{txt:11}),new ColorTheme_1.ColorTheme("LUCKY SIGN",App.Config.PixelPaletteImagePath[16],{menu:[9,5,7,8,3],txt:11,power:4})],this._Defaults={txt:8,menu:[9,5,7,4,3],options:[3,4,9,7,5],power:8},this._Value={txt:this._Defaults.txt,menu:this._Defaults.menu,options:this._Defaults.options,power:this._Defaults.power},this.Txt=16,this.MenuOrder=[17,18,19,20,21],this.OptionsOrder=[22,23,24,25,26],this.Power=27}return ThemeManager.prototype.LoadTheme=function(theme,firstLoad,disableThemeStorage){var _this=this;this.Themes[theme]||(theme=0),disableThemeStorage||(App.ThemeNo=theme),this.CurrentThemeNo=theme,this.CurrentTheme=this.Themes[theme];var selectedtheme=this.Themes[theme];this._Value.txt=selectedtheme.Options.txt||this._Defaults.txt,this._Value.menu=selectedtheme.Options.menu||this._Defaults.menu,this._Value.options=selectedtheme.Options.options||this._Defaults.options,this._Value.power=selectedtheme.Options.power||this._Defaults.power,this.Loaded=!1;var pixelPalette=new PixelPalette(selectedtheme.PaletteURL);pixelPalette.Load(function(palette){var i,l;_this.Txt=palette.length,palette.push(palette[_this._Value.txt].clone()),_this.NewPalette=palette,l=palette.length,_this.MenuOrder=[l,l+1,l+2,l+3,l+4];for(i=0;i<_this._Value.menu.length;i++)palette.push(palette[_this._Value.menu[i]].clone());l=palette.length,_this.OptionsOrder=[l,l+1,l+2,l+3,l+4];for(i=0;i<_this._Value.options.length;i++)palette.push(palette[_this._Value.options[i]].clone());_this.Power=palette.length,palette.push(palette[_this._Value.power].clone());var shareUrl=document.getElementById("shareUrl");shareUrl.style.color=App.ColorManager.ColorString(_this.NewPalette[_this.Txt]);var shareTitle=document.getElementById("shareTitle");shareTitle.style.color=App.ColorManager.ColorString(_this.NewPalette[_this.Txt]);var scSearch=document.getElementById("soundCloudSearch");scSearch.style.color=App.ColorManager.ColorString(_this.NewPalette[_this.Txt]);var bgLuminosity=App.ColorManager.GetLuminosity(_this.NewPalette[1]),highlightCol;bgLuminosity>127?highlightCol=App.ColorManager.DarkerColor(_this.NewPalette[1],40):highlightCol=App.ColorManager.LighterColor(_this.NewPalette[1],95);var col=App.ColorManager.ColorString(highlightCol),styleElem=document.getElementById("selectStyle");styleElem.innerHTML="::selection{ background-color: "+col+"; background-blend-mode: normal; mix-blend-mode: normal;}",_this.Loaded=!0;if(firstLoad)_this.ThemeChanged.raise(_this,new ThemeChangeEventArgs_1.ThemeChangeEventArgs(theme,palette));else for(i=0;i<palette.length;i++)_this.ColorTo(App.Palette[i],_this.NewPalette[i],800)})},ThemeManager.prototype.ColorTo=function(color,destination,t){var offsetTween=new window.TWEEN.Tween({r:color.R,g:color.G,b:color.B,a:color.A});offsetTween.to({r:destination.R,g:destination.G,b:destination.B,a:destination.A},t),offsetTween.onUpdate(function(){color.R=Math.round(this.r),color.G=Math.round(this.g),color.B=Math.round(this.b),color.A=Math.round(this.a),color.toString=function(){return"rgba("+color.R+","+color.G+","+color.B+","+color.A+")"}}),offsetTween.easing(window.TWEEN.Easing.Exponential.InOut),offsetTween.start(App.Stage.LastVisualTick)},ThemeManager}();exports.ThemeManager=ThemeManager});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Core/Inputs/TypingManager",["require","exports","./KeyboardInputManager","./KeyDownEventArgs"],function(require,exports,KeyboardInputManager_1,KeyDownEventArgs_1){var TypingManager=function(_super){__extends(TypingManager,_super);function TypingManager(){_super.call(this),this.KeyDownChange=new nullstone.Event,this.IsEnabled=!1,this._String="",this._CharLimit=20}return TypingManager.prototype.KeyboardDown=function(e){_super.prototype.KeyboardDown.call(this,e);var code=e.keyCode;this.KeyDownChange.raise(this,new KeyDownEventArgs_1.KeyDownEventArgs(code))},TypingManager.prototype.KeyboardUp=function(e){_super.prototype.KeyboardUp.call(this,e);if(!this.IsEnabled)return},TypingManager.prototype.AddToString=function(code){if(!this.IsModifierDown()&&this._String.length<this._CharLimit)if(code>47&&code<91||code>105&&code<112||code>185&&code<193||code>218&&code<223||code==32){var key=""+String.fromCharCode(code);this._String=""+this._String+key,this._Panel.UpdateString(this._String)}},TypingManager.prototype.RemoveFromString=function(){this.IsKeyCodeDown(KeyCodes.KeyDown.Backspace)&&(this._String=this._String.substring(0,this._String.length-1),this._Panel.UpdateString(this._String))},TypingManager.prototype.StringReturn=function(){this.IsKeyCodeDown(KeyCodes.KeyDown.Enter)&&this._Panel.StringReturn()},TypingManager.prototype.Enable=function(panel){this.IsEnabled=!0,this._Panel=panel,this._String=panel.GetString(),App.PianoKeyboardManager.IsEnabled=!1},TypingManager.prototype.Disable=function(){this.IsEnabled=!1,App.PianoKeyboardManager.IsEnabled=!0},TypingManager}(KeyboardInputManager_1.KeyboardInputManager);exports.TypingManager=TypingManager}),define("CommandHandlers/UndoCommandHandler",["require","exports","../Commands","../CommandCategories"],function(require,exports,Commands_1,CommandCategories_1){var UndoCommandHandler=function(){function UndoCommandHandler(){}return UndoCommandHandler.prototype.Execute=function(){if(App.OperationManager.CanUndo())return App.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Commands_1.Commands.UNDO.toString()),App.OperationManager.Undo()},UndoCommandHandler}();exports.UndoCommandHandler=UndoCommandHandler}),define("Core/Audio/SoundCloud/SoundcloudTrack",["require","exports"],function(require,exports){var SoundCloudTrack=function(){function SoundCloudTrack(title,user,uri,permalink){this._Long=65,this._Short=30,title.length>this._Long?this.Title=title.substring(0,this._Long)+"...":this.Title=title,title.length>this._Short?this.TitleShort=title.substring(0,this._Short)+"...":this.TitleShort=title,this.Title=this.Title.toUpperCase(),this.TitleShort=this.TitleShort.toUpperCase(),user.length>this._Long?this.User=user.substring(0,this._Long)+"...":this.User=user,user.length>this._Short?this.UserShort=user.substring(0,this._Short)+"...":this.UserShort=user,this.User=this.Capitalise(this.User),this.UserShort=this.Capitalise(this.UserShort),this.URI=uri,this.Permalink=permalink}return SoundCloudTrack.prototype.Capitalise=function(string){return string.charAt(0).toUpperCase()+string.slice(1)},SoundCloudTrack}();exports.SoundCloudTrack=SoundCloudTrack});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/Granular",["require","exports","../../Core/Audio/Components/SignalToValue","../../Core/Audio/SoundCloud/SoundCloudAPI","../../Core/Audio/SoundCloud/SoundcloudTrack","../Source"],function(require,exports,SignalToValue_1,SoundCloudAPI_1,SoundcloudTrack_1,Source_1){var Point=etch.primitives.Point,Granular=function(_super){__extends(Granular,_super);function Granular(){_super.apply(this,arguments),this.Grains=[],this.GrainEnvelopes=[],this._FirstRelease=!0,this._CurrentGrain=0,this._NoteOn=!1,this._LoadFromShare=!1}return Granular.prototype.Init=function(drawTo){var _this=this;this.BlockName=App.L10n.Blocks.Source.Blocks.Granular.name,this.Params&&(this._LoadFromShare=!0,setTimeout(function(){_this.FirstSetup()},100)),this.Defaults={playbackRate:0,detune:0,density:10,region:0,spread:1.5,grainlength:.25,track:"https://files.blokdust.io/samples/sequence_fuzz_pad2.wav",trackName:"Fuzz Pad 2",user:"BlokDust",permalink:""},this.PopulateParams(),this.GrainsAmount=12,this._RampLength=.4,this._tempPlaybackRate=this.Params.playbackRate,this._WaveForm=[],this.SearchResults=[],this.Searching=!1,this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(this.Params.trackName,this.Params.user,this.Params.track,this.Params.permalink),_super.prototype.Init.call(this,drawTo),this.CreateSource(),this.CreateEnvelope(),this.CreateGrains(),this.CreateFirstVoice(),this.PlaybackSignal=new SignalToValue_1.SignalToValue,this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,-1),new Point(2,0),new Point(2,1),new Point(1,2))},Granular.prototype.Reset=function(){this.Grains.length=0,this.GrainEnvelopes.length=0},Granular.prototype.Search=function(query){this.Searching=!0,App.MainScene.OptionsPanel.Animating=!0,this.ResultsPage=1,this.SearchResults=[],SoundCloudAPI_1.SoundCloudAPI.MultiSearch(query,App.Config.GranularMaxTrackLength,this)},Granular.prototype.SetSearchResults=function(results){_super.prototype.SetSearchResults.call(this,results),this.Searching=!1,App.MainScene.OptionsPanel.Animating=!1;var len=results.length;for(var i=0;i<len;i++){var track=results[i];this.SearchResults.push(new SoundcloudTrack_1.SoundCloudTrack(track.title,track.user.username,track.uri,track.permalink_url))}},Granular.prototype.LoadTrack=function(track,fullUrl){fullUrl=fullUrl||!1,fullUrl?this.Params.track=track.URI:this.Params.track=SoundCloudAPI_1.SoundCloudAPI.LoadTrack(track),this.Params.permalink=track.Permalink,this.Params.trackName=track.TitleShort,this.Params.user=track.UserShort,this._WaveForm=[],this.SetupGrains(),this.RefreshOptionsPanel("animate")},Granular.prototype.TrackFallBack=function(){this._LoadFromShare=!1,this.Params.track===this._FallBackTrack.URI&&(this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(this.Defaults.trackName,this.Defaults.user,this.Defaults.track,this.Defaults.permalink)),this.LoadTrack(this._FallBackTrack,!0),App.Message("Load Failed: This Track Is Unavailable. Reloading last track.")},Granular.prototype.CreateGrains=function(){var _this=this;if(!this.Grains[0]){for(var i=0;i<this.GrainsAmount;i++)this.Grains[i]=new Tone.SimplePlayer,this.GrainEnvelopes[i]=new Tone.AmplitudeEnvelope(this.Params.grainlength*this._RampLength,.01,1,this.Params.grainlength*this._RampLength),this.Grains[i].connect(this.GrainEnvelopes[i]),this.GrainEnvelopes[i].connect(this.Sources[0]),Tone.isSafari?this.Grains[i].playbackRate=this.Params.playbackRate:this.Grains[i].playbackRate.value=this.Params.playbackRate;this.Envelopes.forEach(function(e){e.connect(_this.AudioInput)}),this.Sources.forEach(function(s,i){s.connect(_this.Envelopes[i])})}},Granular.prototype.SetupGrains=function(){var _this=this;this._IsLoaded=!1;var duration=this.GetDuration();App.AnimationsLayer.AddToList(this),this._FirstBuffer&&this._FirstBuffer.dispose(),this._FirstBuffer=new Tone.SimplePlayer(this.Params.track,function(e){clearTimeout(_this.LoadTimeout),_this._WaveForm=App.Audio.Waveform.GetWaveformFromBuffer(e.buffer._buffer,200,2,80),App.AnimationsLayer.RemoveFromList(_this),_this._IsLoaded=!0;for(var i=0;i<_this.GrainsAmount;i++)_this.Grains[i].buffer=e.buffer;var duration=_this.GetDuration();_this._LoadFromShare||(_this.Params.region=duration/2),_this._LoadFromShare=!1,_this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(_this.Params.trackName,_this.Params.user,_this.Params.track,_this.Params.permalink),_this.RefreshOptionsPanel(),_this.GrainLoop()});var me=this;clearTimeout(this.LoadTimeout),this.LoadTimeout=setTimeout(function(){me.TrackFallBack()},App.Config.SoundCloudLoadTimeout*1e3),this._FirstBuffer.onerror=function(){me.TrackFallBack()}},Granular.prototype.FirstSetup=function(){var _this=this;this._FirstRelease&&(this.Sources.forEach(function(s,i){s.connect(_this.Envelopes[i])}),this.Envelopes.forEach(function(e){e.connect(_this.AudioInput)}),this.SetupGrains(),this._FirstRelease=!1)},Granular.prototype.GetDuration=function(){return this._FirstBuffer?this._FirstBuffer.buffer.duration:0},Granular.prototype.Update=function(){_super.prototype.Update.call(this);if(this.PlaybackSignal){var value=this.PlaybackSignal.UpdateValue();value!==0?(this.Params.detune=value,this.NoteUpdate()):this.Params.detune=0}},Granular.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Granular.prototype.CreateSource=function(){return this.Sources.push(new Tone.Signal),_super.prototype.CreateSource.call(this)},Granular.prototype.CreateEnvelope=function(){return this.Envelopes.push(new Tone.AmplitudeEnvelope(this.Settings.envelope.attack,this.Settings.envelope.decay,this.Settings.envelope.sustain,this.Settings.envelope.release)),_super.prototype.CreateEnvelope.call(this)},Granular.prototype.TriggerAttack=function(index){_super.prototype.TriggerAttack.call(this,index),this._IsLoaded&&(this._NoteOn||(this._NoteOn=!0,this.GrainLoop()))},Granular.prototype.TriggerRelease=function(index){_super.prototype.TriggerRelease.call(this,index);var that=this;this.EndTimeout=setTimeout(function(){that.ActiveVoices.length===0&&(that._NoteOn=!1)},this.Envelopes[0].release*1e3)},Granular.prototype.TriggerAttackRelease=function(index,duration){var _this=this;index===void 0&&(index=0),duration===void 0&&(duration=App.Config.PulseLength),this._IsLoaded&&(clearTimeout(this.EndTimeout),this._NoteOn||(this._NoteOn=!0,this.GrainLoop())),this.ReleaseTimeout=setTimeout(function(){_this.EndTimeout=setTimeout(function(){_this._NoteOn=!1},_this.GrainEnvelopes[0].release*1e3)},duration)},Granular.prototype.MouseUp=function(){this.FirstSetup(),_super.prototype.MouseUp.call(this)},Granular.prototype.GrainLoop=function(){var _this=this;if(this.GrainEnvelopes[this._CurrentGrain]&&(this.IsPowered()||this._NoteOn)){var location=this.LocationRange(this.Params.region-this.Params.spread*.5+Math.random()*this.Params.spread);this.Grains[this._CurrentGrain].stop();if(this.GetDuration()>0){this.Grains[this._CurrentGrain].start(location,this.Params.grainlength*this._tempPlaybackRate*1.9);var grain=this.GrainEnvelopes[this._CurrentGrain];this.GrainEnvelopes[this._CurrentGrain].triggerAttack(),setTimeout(function(){grain.triggerRelease()},Math.round(this.Params.grainlength*(1-this._RampLength)*1e3))}clearTimeout(this.Timeout),this.Timeout=setTimeout(function(){_this.GrainLoop()},Math.round(this.Params.grainlength*2/this.Params.density*1500)),this._CurrentGrain+=1,this._CurrentGrain>=this.Params.density&&(this._CurrentGrain=0)}},Granular.prototype.LocationRange=function(location){var locationCap=this.GetDuration()-this.Params.grainlength;return location<0?location=0:location>locationCap&&(location=locationCap),location},Granular.prototype.SetPitch=function(note,voiceNo,glide){_super.prototype.SetPitch.call(this,note,voiceNo,glide),this._tempPlaybackRate=this.MidiToPlayback(note)},Granular.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);switch(param){case"density":this.Params.density=value;break;case"grainlength":this.Params.grainlength=value;for(var i=0;i<this.GrainsAmount;i++)this.GrainEnvelopes[i].attack=value*this._RampLength,this.GrainEnvelopes[i].release=value*this._RampLength;break;case"spread":this.Params.spread=value;break;case"region":this.Params.region=value}},Granular.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Granular",parameters:[{type:"waveslider",name:"Location",setting:"region",props:{value:this.Params.region,min:0,max:this.GetDuration(),quantised:!1,centered:!1,wavearray:this._WaveForm,spread:this.Params.spread}},{type:"sample",name:"Sample",setting:"sample",props:{track:this.Params.trackName,user:this.Params.user,permalink:this.Params.permalink}},{type:"slider",name:"Spread",setting:"spread",props:{value:this.Params.spread,min:0,max:4,quantised:!1,centered:!1}},{type:"slider",name:"Grain Size",setting:"grainlength",props:{value:this.Params.grainlength,min:.03,max:.6,quantised:!1,centered:!1}},{type:"slider",name:"Density",setting:"density",props:{value:this.Params.density,min:2,max:this.GrainsAmount,quantised:!0,centered:!1}}]}},Granular.prototype.Dispose=function(){_super.prototype.Dispose.call(this),clearTimeout(this.Timeout),this._NoteOn=!1,this.Grains.forEach(function(g){g.dispose()}),this.GrainEnvelopes.forEach(function(e){e.dispose()}),this.Envelopes.forEach(function(e){e.dispose()}),this.Sources.forEach(function(s){s.dispose()}),this.Grains.length=0,this.GrainEnvelopes.length=0},Granular}(Source_1.Source);exports.Granular=Granular});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/Microphone",["require","exports","../Source"],function(require,exports,Source_1){var Point=etch.primitives.Point,Microphone=function(_super){__extends(Microphone,_super);function Microphone(){_super.apply(this,arguments),this.Muted=!1,this._unmutedVolume=1}return Microphone.prototype.Init=function(drawTo){var _this=this;this.BlockName=App.L10n.Blocks.Source.Blocks.Microphone.name,this.Defaults={gain:1,monitor:!0},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),navigator.getUserMedia||App.Message("Unfortunately the microphone will not work in this browser because it doesn't support 'getUserMedia'. Try using the latest Chrome"),this.CreateSource(),this.CreateFirstVoice(),this.Volume=App.Audio.ctx.createGain(),this.Sources.forEach(function(s){s.open(function(){s.connect(_this.Volume),s.start()})}),this.Volume.gain.value=this.Params.gain,this.Volume.connect(this.AudioInput),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,-1),new Point(1,1),new Point(0,2),new Point(-1,1))},Microphone.prototype.Mute=function(){this.Muted||(this._unmutedVolume=this.Volume.gain.value,this.Volume.gain.value=0,this.Muted=!0)},Microphone.prototype.Unmute=function(){this.Muted&&(this.Volume.gain.value=this._unmutedVolume,this.Muted=!1)},Microphone.prototype.CreateSource=function(){return this.Sources.push(new Tone.Microphone),this.Sources[this.Sources.length-1]},Microphone.prototype.UpdateConnections=function(chain){this.Chain=chain,this.IsPressed||this.TriggerRelease()},Microphone.prototype.TriggerAttack=function(index){this.Unmute()},Microphone.prototype.TriggerRelease=function(index){this.IsPowered()||this.Mute()},Microphone.prototype.TriggerAttackRelease=function(duration){var _this=this;this.Unmute(),duration||(duration=App.Config.PulseLength),setTimeout(function(){_this.Mute()},this.Sources[0].toSeconds(duration)*1e3)},Microphone.prototype.SetParam=function(param,value){var val=value;param=="monitor",this.Params[""+param]=val,_super.prototype.SetParam.call(this,param,value)},Microphone.prototype.Update=function(){_super.prototype.Update.call(this)},Microphone.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Microphone.prototype.Dispose=function(){_super.prototype.Dispose.call(this),this.Sources.forEach(function(s){s.dispose()}),this.Volume=null,this.Muted=null},Microphone}(Source_1.Source);exports.Microphone=Microphone});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/Noise",["require","exports","../Source"],function(require,exports,Source_1){var Point=etch.primitives.Point,Noise=function(_super){__extends(Noise,_super);function Noise(){_super.apply(this,arguments)}return Noise.prototype.Init=function(drawTo){var _this=this;this.BlockName=App.L10n.Blocks.Source.Blocks.Noise.name,this.Defaults={playbackRate:1,waveform:2},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),this.CreateSource(),this.CreateEnvelope(),this.CreateFirstVoice(),this.Envelopes.forEach(function(e){e.connect(_this.AudioInput)}),this.Sources.forEach(function(s,i){s.connect(_this.Envelopes[i]).start()}),this.DelayedRelease=0,this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,-1),new Point(1,0),new Point(-1,2))},Noise.prototype.CreateSource=function(){return this.Sources.push(new Tone.Noise(App.Audio.WaveformTypeIndexNoise[this.Params.waveform])),_super.prototype.CreateSource.call(this)},Noise.prototype.CreateEnvelope=function(){return this.Envelopes.push(new Tone.AmplitudeEnvelope(this.Settings.envelope.attack,this.Settings.envelope.decay,this.Settings.envelope.sustain,this.Settings.envelope.release)),_super.prototype.CreateEnvelope.call(this)},Noise.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Noise.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Noise",parameters:[{type:"buttons",name:"Wave",setting:"waveform",props:{value:this.Params.waveform,mode:"string"},buttons:[{name:"White"},{name:"Pink"},{name:"Brown"}]}]}},Noise.prototype.SetParam=function(param,value){switch(param){case"waveform":this.Sources.forEach(function(s){s.type=App.Audio.WaveformTypeIndexNoise[value]})}this.Params[param]=value},Noise.prototype.Dispose=function(){_super.prototype.Dispose.call(this),this.Sources.forEach(function(s){s.dispose()}),this.Envelopes.forEach(function(e){e.dispose()})},Noise}(Source_1.Source);exports.Noise=Noise});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/Sample",["require","exports","./SamplerBase","../../Core/Audio/SoundCloud/SoundCloudAPI","../../Core/Audio/SoundCloud/SoundcloudTrack"],function(require,exports,SamplerBase_1,SoundCloudAPI_1,SoundcloudTrack_1){var Point=etch.primitives.Point,Sample=function(_super){__extends(Sample,_super);function Sample(){_super.apply(this,arguments),this._FirstRelease=!0,this._LoadFromShare=!1}return Sample.prototype.Init=function(drawTo){var _this=this;this.BlockName=App.L10n.Blocks.Source.Blocks.Sample.name,this.Params&&(this._LoadFromShare=!0,setTimeout(function(){_this.FirstSetup()},100)),this.Defaults={playbackRate:0,detune:0,reverse:!1,startPosition:0,endPosition:null,loop:!0,loopStart:0,loopEnd:0,volume:11,track:"https://files.blokdust.io/impulse-responses/teufelsberg01.wav",trackName:"TEUFELSBERG",user:"Balance Mastering",permalink:""},this.PopulateParams(),this.WaveForm=[],this.SearchResults=[],this.Searching=!1,this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(this.Params.trackName,this.Params.user,this.Params.track,this.Params.permalink),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,-1),new Point(2,0),new Point(1,1),new Point(0,1))},Sample.prototype.FirstSetup=function(){var _this=this;this._FirstRelease&&(this.SetBuffers(),this.Envelopes.forEach(function(e,i){e=_this.Sources[i].envelope}),this.Sources.forEach(function(s){s.connect(_this.AudioInput)}),this._FirstRelease=!1)},Sample.prototype.Search=function(query){this.Searching=!0,App.MainScene.OptionsPanel.Animating=!0,this.ResultsPage=1,this.SearchResults=[],SoundCloudAPI_1.SoundCloudAPI.MultiSearch(query,App.Config.SoundCloudMaxTrackLength,this)},Sample.prototype.SetSearchResults=function(results){_super.prototype.SetSearchResults.call(this,results),this.Searching=!1,App.MainScene.OptionsPanel.Animating=!1;var len=results.length;for(var i=0;i<len;i++){var track=results[i];this.SearchResults.push(new SoundcloudTrack_1.SoundCloudTrack(track.title,track.user.username,track.uri,track.permalink_url))}},Sample.prototype.LoadTrack=function(track,fullUrl){_super.prototype.LoadTrack.call(this,track,fullUrl),fullUrl=fullUrl||!1,fullUrl?this.Params.track=track.URI:this.Params.track=SoundCloudAPI_1.SoundCloudAPI.LoadTrack(track),this.Params.permalink=track.Permalink,this.Params.trackName=track.TitleShort,this.Params.user=track.UserShort,this.Params.reverse=!1,this.WaveForm=[],this.SetBuffers(),this.RefreshOptionsPanel("animate")},Sample.prototype.TrackFallBack=function(){this._LoadFromShare=!1,this.Params.track===this._FallBackTrack.URI&&(this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(this.Defaults.trackName,this.Defaults.user,this.Defaults.track,this.Defaults.permalink)),this.LoadTrack(this._FallBackTrack,!0),App.Message("Load Failed: This Track Is Unavailable. Reloading last track.")},Sample.prototype.SetBuffers=function(){var _this=this;this.Sources.forEach(function(s){s.triggerRelease()}),App.AnimationsLayer.AddToList(this),this.PrimaryBuffer&&this.PrimaryBuffer.dispose(),this.PrimaryBuffer=new Tone.Buffer(this.Params.track,function(e){clearTimeout(_this.LoadTimeout);var duration=_this.GetDuration(_this.PrimaryBuffer);_this._LoadFromShare||(console.log("not load from share"),_this.Params.startPosition=0,_this.Params.endPosition=duration,_this.Params.loopStart=duration*.5,_this.Params.loopEnd=duration),_this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(_this.Params.trackName,_this.Params.user,_this.Params.track,_this.Params.permalink),_this.Sources.forEach(function(s){s.player.buffer=e,s.player.loopStart=_this.Params.loopStart,s.player.loopEnd=_this.Params.loopEnd}),_this.ReverseBuffer&&(_this.ReverseBuffer=null),_this._LoadFromShare&&_this.Params.reverse&&_this.ReverseTrack(),_this._LoadFromShare=!1,App.AnimationsLayer.RemoveFromList(_this),_this.WaveForm=App.Audio.Waveform.GetWaveformFromBuffer(e._buffer,200,5,95),_this.RefreshOptionsPanel(),_this.RetriggerActiveVoices()}),clearTimeout(this.LoadTimeout),this.LoadTimeout=setTimeout(function(){_this.TrackFallBack()},App.Config.SoundCloudLoadTimeout*1e3),this.PrimaryBuffer.onerror=function(){_this.TrackFallBack()}},Sample.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Sample.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Source.Blocks.Sample.name,parameters:[{type:"waveregion",name:"Region",setting:"region",props:{value:5,min:0,max:this.GetDuration(this.PrimaryBuffer),quantised:!1,centered:!1,wavearray:this.WaveForm,mode:this.Params.loop},nodes:[{setting:"startPosition",value:this.Params.startPosition},{setting:"endPosition",value:this.Params.endPosition},{setting:"loopStart",value:this.Params.loopStart},{setting:"loopEnd",value:this.Params.loopEnd}]},{type:"sample",name:"Sample",setting:"sample",props:{track:this.Params.trackName,user:this.Params.user,permalink:this.Params.permalink}},{type:"switches",name:"Loop",setting:"loop",switches:[{name:"Reverse",setting:"reverse",value:this.Params.reverse,lit:!0,mode:"offOn"},{name:"Looping",setting:"loop",value:this.Params.loop,lit:!0,mode:"offOn"}]},{type:"slider",name:"playback",setting:"playbackRate",props:{value:this.Params.playbackRate,min:-App.Config.PlaybackRange,max:App.Config.PlaybackRange,quantised:!1,centered:!0}}]}},Sample.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;switch(param){case"playbackRate":this.Params.playbackRate=value,this.NoteUpdate();break;case"reverse":value=value?!0:!1,this.Params[param]=val,this.ReverseTrack();break;case"loop":value=value?!0:!1,this.Sources.forEach(function(s){s.player.loop=value}),value===!0&&this.IsPowered()&&this.Sources.forEach(function(s){s.player.stop(),s.player.start(s.player.startPosition)}),this.Params[param]=val,this.RefreshOptionsPanel();break;case"loopStart":this.Sources.forEach(function(s){s.player.loopStart=value});break;case"loopEnd":this.Sources.forEach(function(s){s.player.loopEnd=value})}this.Params[param]=value},Sample.prototype.Dispose=function(){_super.prototype.Dispose.call(this)},Sample}(SamplerBase_1.SamplerBase);exports.Sample=Sample}),define("WaveVoice",["require","exports"],function(require,exports){var WaveVoice=function(){function WaveVoice(type,wave,frequency,gain,drift,sequence,slide){this.Frequency=frequency,this.Value=0,this.Polarity=1,this.VoiceType=type,this.WaveType=wave,this.Volume=gain,this.Drift=drift,this.Sequence=sequence,this.Slide=slide,this.FDest=frequency}return WaveVoice}();exports.WaveVoice=WaveVoice});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Sources/SampleGen",["require","exports","./SamplerBase","../../WaveVoice"],function(require,exports,SamplerBase_1,WaveVoice_1){var Point=etch.primitives.Point,SampleGen=function(_super){__extends(SampleGen,_super);function SampleGen(){_super.apply(this,arguments),this._FirstRelease=!0,this._LoadFromShare=!1}return SampleGen.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Source.Blocks.SampleGen.name;if(this.Params){this._LoadFromShare=!0;var me=this;setTimeout(function(){me.FirstSetup()},100)}this.Defaults={playbackRate:0,detune:0,reverse:!1,startPosition:0,endPosition:null,loop:!0,loopStart:0,loopEnd:0,volume:11,generate:null,seed:{}},this.PopulateParams(),this.WaveForm=[],this._WaveVoices=[],this._SeedLoad=!0,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(0,-1),new Point(1,0),new Point(1,2),new Point(0,2),new Point(-1,1))},SampleGen.prototype.Arp=function(mode,notes,octave,range,length){var seq=[];switch(mode){case 1:for(var j=0;j<length;j++)seq.push(this.Sources[0].noteToFrequency(""+notes[0]+(octave+Math.floor(Math.random()*range))));return seq;case 2:for(var j=0;j<length;j++)seq.push(this.Sources[0].noteToFrequency(""+notes[Math.floor(Math.random()*notes.length)]+(octave+Math.floor(Math.random()*range))));return seq;case 3:var dir=1;this.Dice(2)&&(dir=-1);var change=3+Math.round(Math.random()*5),note=Math.floor(Math.random()*notes.length),thisOctave=Math.floor(Math.random()*range);for(var j=0;j<length;j++)seq.push(this.Sources[0].noteToFrequency(""+notes[note]+(octave+thisOctave))),this.Dice(change)&&(dir=-dir),note+=dir,note<0&&(thisOctave>0?(note=notes.length-1,thisOctave-=1):(note+=2,dir=1)),note>notes.length-1&&(thisOctave<range?(note=0,thisOctave+=1):(note-=2,dir=-1));return seq}},SampleGen.prototype.Dice=function(sides){return Math.floor(Math.random()*sides)==0},SampleGen.prototype.DataToBuffer=function(){var seconds=2,sampleRate=App.Audio.sampleRate,gain=1,noise=0;this.Dice(2)&&(noise=Math.random()*.5);var waveType=Math.floor(Math.random()*3),octaving=0,organise=!1;this.Dice(8)&&(this.Dice(3)?octaving=2:octaving=1,this.Dice(3)&&(organise=!0));var following=!1;this.Dice(4)&&(following=!0);var glide=1+Math.round(Math.random()*20),noGlide=!1;this.Dice(2)&&(noGlide=!0);var notes=["c","d","e","f","g","a","b"],wonder=["c","e","f","a"],minor=["c","d#","g","g#"],jpent=["c","c#","f","g","a#"],second=["c","f","g","g#"],jazz=["c","d","d#","g","a","a#"],scales=[wonder,minor,jpent,second,jazz],scale,sequenceLength=Math.pow(2,1+Math.round(Math.random()*6));sequenceLength==2&&this.Dice(2)&&(sequenceLength=4);var octave=4,range=1,arpMode;switch(Math.floor(Math.random()*10)){case 0:arpMode=1;break;case 1:case 2:case 3:case 4:case 5:case 6:arpMode=2;break;case 7:case 8:case 9:arpMode=3}var octaveLower=0;this.Dice(2)&&(octaveLower=Math.ceil(Math.random()*2)),arpMode==1&&(octave=2+Math.round(Math.random()*(3-octaveLower)),range=2+Math.round(Math.random()*(4-(octave-2))),sequenceLength<8&&this.Dice(2)&&(sequenceLength=8),scale=notes),arpMode==2&&(octave=1+Math.round(Math.random()*(6-octaveLower)),range=1+Math.floor(Math.random()*(6-(octave-1))),scale=notes,this.Dice(4)&&(scale=scales[Math.floor(Math.random()*scales.length)])),arpMode==3&&(octave=1+Math.round(Math.random()*(5-octaveLower)),range=1+Math.floor(Math.random()*(6-(octave-1))),sequenceLength<8&&(sequenceLength=8),scale=scales[Math.floor(Math.random()*scales.length)]),this._BufferData=new Float32Array(sampleRate*seconds);var data=this._BufferData,voices,harmonics,lfo;this._WaveVoices=[],voices=1+Math.round(Math.random()*3),harmonics=Math.round(Math.random()*13),lfo=Math.round(Math.random()),this.Dice(8)&&(voices=1+Math.round(Math.random()*20),harmonics=3+Math.round(Math.random()*6)),this.Dice(8)&&(voices=10+Math.round(Math.random()*10),harmonics=3,lfo=0);var totalGain=0;for(var i=0;i<voices+harmonics+lfo;i++){var t,w,f,vol,d,s,sl;vol=.05+Math.random()*30,f=440,d=1,s=[],sl=!1,w=waveType;if(i<voices){t=0,arpMode>0&&(i==0?s=this.Arp(arpMode,scale,octave,range,sequenceLength):this.Dice(3)&&(s=this.Arp(arpMode,scale,octave,range,sequenceLength)));if(w==1){f*=.5;if(s.length>0)for(j=0;j<s.length;j++)s[j]*=.5}organise&&i>0&&(vol=this._WaveVoices[0].Volume),this.Dice(3)&&(d=.9999+Math.random()*2e-4),following&&i>0&&(d=this._WaveVoices[0].Drift),this.Dice(4)&&!noGlide&&(sl=!0)}else i>=voices&&i<voices+harmonics?(t=1,this.Dice(4)&&!noGlide&&(sl=!0)):(t=2,vol=10+Math.random()*100,f=1+Math.round(Math.random()*15));this._WaveVoices.push(new WaveVoice_1.WaveVoice(t,w,f,vol,d,s,sl)),totalGain+=vol}var amp=1/totalGain;if(this.Params.seed.waveVoices&&this._SeedLoad&&this._LoadFromShare){var seed=this.Params.seed;sequenceLength=seed.sequenceLength,seconds=seed.seconds,gain=seed.gain,noise=seed.noise,octaving=seed.octaving,glide=seed.glide,this._WaveVoices=seed.waveVoices,voices=seed.voices,harmonics=seed.harmonics,amp=seed.amp,this._SeedLoad=!1}this.Params.seed={sequenceLength:sequenceLength,seconds:seconds,gain:gain,noise:noise,octaving:octaving,glide:glide,waveVoices:this._WaveVoices,voices:voices,harmonics:harmonics,amp:amp};var waveVoices=this._WaveVoices,overflow=800,dataLength=data.length;for(var i=0;i<dataLength+overflow;i++){var totalVal=0;for(var j=0;j<waveVoices.length;j++){var v=waveVoices[j];switch(v.VoiceType){case 0:i==Math.round(dataLength/sequenceLength)*Math.round(sequenceLength/dataLength*i)&&i<dataLength&&(v.Sequence.length==0?(octaving==1?v.FDest=waveVoices[0].Frequency*2*j:octaving==2?v.FDest=waveVoices[0].Frequency/(2*j):v.FDest=waveVoices[0].Frequency+5*j,v.Slide||(v.Frequency=v.FDest)):(v.FDest=v.Sequence[Math.floor(sequenceLength/dataLength*i)],v.Slide||(v.Frequency=v.FDest))),v.Slide&&(v.Frequency+=(v.FDest-v.Frequency)/1e4*glide),v.Frequency*=v.Drift;break;case 1:v.FDest=waveVoices[0].Frequency*j,v.Slide?v.Frequency+=(v.FDest-v.Frequency)/1e4*glide:v.Frequency=v.FDest}var maxFreq=2e4;v.Frequency>maxFreq&&(v.Frequency=maxFreq),v.Frequency<1&&(v.Frequency=1),totalVal+=v.Value*v.Volume;if(v.WaveType<2){var step=v.Frequency*(amp*4/sampleRate);v.Value+=step*v.Polarity;if(v.Value>amp){var spill=v.Value-amp;v.WaveType==1&&j<voices+harmonics?v.Value=-(amp-spill):(v.Value=amp-spill,v.Polarity=-v.Polarity)}if(v.Value<-amp){var spill=v.Value- -amp;v.Value=-amp-spill,v.Polarity=-v.Polarity}}else{var a1=v.Frequency*i*Math.PI*2/sampleRate;v.Value=Math.sin(a1)*amp}}var roam=1-noise*.5+Math.random()*noise,totalTotal=totalVal*roam*gain;if(i<dataLength-1)data[i]=totalTotal;else{var ni=i-(dataLength-1),gainA=1-1/overflow*ni,gainB=1/overflow*ni;data[ni]=totalTotal*gainA+data[ni]*gainB}}this.PopulateBuffer(sampleRate)},SampleGen.prototype.PopulateBuffer=function(sampleRate){var _this=this;this.PrimaryBuffer||(this.PrimaryBuffer=App.Audio.ctx.createBuffer(1,this._BufferData.length,sampleRate)),this.PrimaryBuffer.copyToChannel(this._BufferData,0,0),this.WaveForm=App.Audio.Waveform.GetWaveformFromBuffer(this.PrimaryBuffer,200,5,95);var duration=this.GetDuration(this.PrimaryBuffer);this._LoadFromShare||(this.Params.startPosition=0,this.Params.loopStart=0,this.Params.loopEnd=this.Params.endPosition=duration,this.Params.reverse=!1),this.RefreshOptionsPanel(),this.Sources.forEach(function(s){s.player.buffer=_this.PrimaryBuffer,s.player.loopStart=_this.Params.loopStart,s.player.loopEnd=_this.Params.loopEnd}),this.ReverseBuffer&&(this.ReverseBuffer=null),this._LoadFromShare&&this.Params.reverse&&this.ReverseTrack();if(this.IsPowered()&&this._LoadFromShare){this.Sources.forEach(function(s){s.triggerRelease()});var that=this;setTimeout(function(){that.TriggerAttack()},1e3)}this._LoadFromShare=!1},SampleGen.prototype.FirstSetup=function(){var _this=this;this._FirstRelease&&(this.DataToBuffer(),this.Envelopes.forEach(function(e,i){e=_this.Sources[i].envelope}),this.Sources.forEach(function(s){s.connect(_this.AudioInput)}),this._FirstRelease=!1)},SampleGen.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},SampleGen.prototype.MouseUp=function(){this.FirstSetup(),_super.prototype.MouseUp.call(this)},SampleGen.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Source.Blocks.SampleGen.name,parameters:[{type:"waveregion",name:"Wave",setting:"region",props:{value:5,min:0,max:this.GetDuration(this.PrimaryBuffer),quantised:!1,centered:!1,wavearray:this.WaveForm,mode:this.Params.loop,emptystring:"Generating Wave"},nodes:[{setting:"startPosition",value:this.Params.startPosition},{setting:"endPosition",value:this.Params.endPosition},{setting:"loopStart",value:this.Params.loopStart},{setting:"loopEnd",value:this.Params.loopEnd}]},{type:"actionbutton",name:"Generate",setting:"generate",props:{text:"Generate Wave"}},{type:"switches",name:"Loop",setting:"loop",switches:[{name:"Reverse",setting:"reverse",value:this.Params.reverse,lit:!0,mode:"offOn"},{name:"Looping",setting:"loop",value:this.Params.loop,lit:!0,mode:"offOn"}]},{type:"slider",name:"playback",setting:"playbackRate",props:{value:this.Params.playbackRate,min:-App.Config.PlaybackRange,max:App.Config.PlaybackRange,quantised:!1,centered:!0}}]}},SampleGen.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;switch(param){case"playbackRate":this.Params.playbackRate=value,this.NoteUpdate();break;case"generate":this.WaveForm=[],this.RefreshOptionsPanel();var me=this;setTimeout(function(){me.DataToBuffer()},16);break;case"reverse":value=value?!0:!1,this.Params[param]=val,this.ReverseTrack();break;case"loop":value=value?!0:!1,this.Sources.forEach(function(s){s.player.loop=value}),value===!0&&this.IsPowered()&&this.Sources.forEach(function(s){s.player.stop(),s.player.start(s.player.startPosition)}),this.Params[param]=value,this.RefreshOptionsPanel();break;case"loopStart":this.Sources.forEach(function(s){s.player.loopStart=value});break;case"loopEnd":this.Sources.forEach(function(s){s.player.loopEnd=value})}this.Params[param]=value},SampleGen.prototype.Dispose=function(){_super.prototype.Dispose.call(this)},SampleGen.prototype.ReverseTheBuffer=function(buffer){var newBuffer=new Float32Array(buffer.length);for(var i=0;i<buffer.length;i++)newBuffer[i]=buffer[buffer.length-1-i];return newBuffer},SampleGen}(SamplerBase_1.SamplerBase);exports.SampleGen=SampleGen});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/AutoWah",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,AutoWah=function(_super){__extends(AutoWah,_super);function AutoWah(){_super.apply(this,arguments)}return AutoWah.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.AutoWah.name,this.Defaults={octaves:5,baseFrequency:100,mix:.3,attack:.75,release:.3},this.PopulateParams(),this.Effect=new Tone.AutoWah({baseFrequency:this.Params.baseFrequency,octaves:this.Params.octaves,sensitivity:-10,gain:30,rolloff:-18,follower:{attack:this.Params.attack,release:this.Params.release}}),this.Effect.wet.value=this.Params.mix,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(0,-1),new Point(1,-1),new Point(1,1),new Point(-2,1))},AutoWah.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},AutoWah.prototype.Dispose=function(){this.Effect.dispose()},AutoWah.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param==="mix"?this.Effect.wet.value=val:param==="octaves"?this.Effect.octaves=val:param==="baseFrequency"?this.Effect.baseFrequency=val:param==="attack"?this.Effect.follower.attack=val:param==="release"&&(this.Effect.follower.release=val),this.Params[param]=val},AutoWah.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.AutoWah.name,parameters:[{type:"slider",name:"Range",setting:"octaves",props:{value:this.Params.octaves,min:1,max:8,quantised:!1,centered:!1}},{type:"slider",name:"Frequency",setting:"baseFrequency",props:{value:this.Params.baseFrequency,min:50,max:1200,quantised:!0,centered:!1}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}},{type:"slider",name:"Attack",setting:"attack",props:{value:this.Params.attack,min:.01,max:2,quantised:!1,centered:!1}},{type:"slider",name:"Release",setting:"release",props:{value:this.Params.release,min:.01,max:2,quantised:!1,centered:!1}}]}},AutoWah}(PostEffect_1.PostEffect);exports.AutoWah=AutoWah});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/BitCrusher",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,BitCrusher=function(_super){__extends(BitCrusher,_super);function BitCrusher(){_super.apply(this,arguments)}return BitCrusher.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.BitCrusher.name,this.Defaults={bits:7,mix:.5},this.PopulateParams(),this.Effect=new Tone.BitCrusher(this.Params.bits),this.Effect.wet.value=this.Params.mix,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(1,-2),new Point(1,0),new Point(0,1),new Point(-1,1))},BitCrusher.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},BitCrusher.prototype.Dispose=function(){this.Effect.dispose()},BitCrusher.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value),param==="bits"?this.Effect.bits=value:param==="mix"&&(this.Effect.wet.value=value),this.Params[param]=value},BitCrusher.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.BitCrusher.name,parameters:[{type:"slider",name:"Bits",setting:"bits",props:{value:this.Params.bits,min:1,max:8,quantised:!1,centered:!1}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}}]}},BitCrusher}(PostEffect_1.PostEffect);exports.BitCrusher=BitCrusher});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Chomp",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Chomp=function(_super){__extends(Chomp,_super);function Chomp(){_super.apply(this,arguments)}return Chomp.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Chomp.name,this.Defaults={rate:13,Q:.6,gain:15},this.PopulateParams(),this.Effect=new Tone.Filter({type:"peaking",frequency:Math.round(101-this.Params.rate),rolloff:-12,Q:this.Params.Q,gain:this.Params.gain}),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,0),new Point(1,1),new Point(0,2),new Point(-1,2)),this.SetFrequency()},Chomp.prototype.SetFrequency=function(){var me=this;this.Timer=setTimeout(function(){me.Effect&&(me.Effect.frequency.value=100+Math.round(Math.random()*1e4),me.SetFrequency())},this.Params.rate)},Chomp.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Chomp.prototype.Dispose=function(){clearTimeout(this.Timer),this.Effect.dispose()},Chomp.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="rate"?val=Math.round(101-val):param=="Q"?this.Effect.Q.value=val:param=="gain"&&(this.Effect.gain.value=val),this.Params[param]=val},Chomp.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Chomp.name,parameters:[{type:"slider",name:"Rate",setting:"rate",props:{value:Math.round(101-this.Params.rate),min:1,max:100,quantised:!0,centered:!1}},{type:"slider",name:"Width",setting:"Q",props:{value:this.Params.Q,min:.1,max:5,quantised:!1,centered:!1}},{type:"slider",name:"Gain",setting:"gain",props:{value:this.Params.gain,min:0,max:20,quantised:!1,centered:!1}}]}},Chomp}(PostEffect_1.PostEffect);exports.Chomp=Chomp});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Chorus",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Chorus=function(_super){__extends(Chorus,_super);function Chorus(){_super.apply(this,arguments)}return Chorus.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Chorus.name,this.Defaults={rate:1.5,delayTime:1.5,depth:.75,feedback:.4},this.PopulateParams(),this.Effect=new Tone.Chorus({frequency:this.Params.rate,delayTime:this.Params.delayTime,type:"sine",depth:this.Params.depth,feedback:this.Params.feedback}),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(0,-1),new Point(1,0),new Point(0,1),new Point(-1,1))},Chorus.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Chorus.prototype.Dispose=function(){this.Effect.dispose()},Chorus.prototype.SetParam=function(param,value){var val=value;param==="rate"?this.Effect.frequency.value=val:param==="feedback"?this.Effect.feedback.value=val:this.Effect[param]=val,this.Params[param]=val},Chorus.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Chorus.name,parameters:[{type:"slider",name:"Rate",setting:"rate",props:{value:this.Params.rate,min:0,max:5,quantised:!1,centered:!1}},{type:"slider",name:"Delay Time",setting:"delayTime",props:{value:this.Params.delayTime,min:.5,max:8,quantised:!1,centered:!1}},{type:"slider",name:"Depth",setting:"depth",props:{value:this.Params.depth,min:0,max:1,quantised:!1,centered:!1}},{type:"slider",name:"Feedback",setting:"feedback",props:{value:this.Params.feedback,min:0,max:.496,quantised:!1,centered:!1}}]}},Chorus}(PostEffect_1.PostEffect);exports.Chorus=Chorus});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/ConvolutionReverb",["require","exports","../PostEffect","../../../Core/Audio/SoundCloud/SoundCloudAPI","../../../Core/Audio/SoundCloud/SoundcloudTrack"],function(require,exports,PostEffect_1,SoundCloudAPI_1,SoundcloudTrack_1){var Point=etch.primitives.Point,Convolver=function(_super){__extends(Convolver,_super);function Convolver(){_super.apply(this,arguments),this._FirstRelease=!0}return Convolver.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Convolution.name;if(this.Params){var me=this;setTimeout(function(){me.FirstSetup()},100)}this.Defaults={mix:.5,track:"https://files.blokdust.io/impulse-responses/teufelsberg01.wav",trackName:"TEUFELSBERG",user:"Balance Mastering",permalink:""},this.PopulateParams(),this._WaveForm=[],this.SearchResults=[],this.Searching=!1,this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(this.Params.trackName,this.Params.user,this.Params.track,this.Params.permalink),this.Effect=new Tone.Convolver,this.Effect.wet.value=this.Params.mix,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(1,-1),new Point(2,0),new Point(0,2),new Point(-1,1))},Convolver.prototype.SetBuffer=function(){var _this=this;App.AnimationsLayer.AddToList(this),this._FirstBuffer&&this._FirstBuffer.dispose(),this._FirstBuffer=new Tone.Buffer(this.Params.track,function(e){clearTimeout(_this.LoadTimeout),_this._WaveForm=App.Audio.Waveform.GetWaveformFromBuffer(e._buffer,200,5,95),App.AnimationsLayer.RemoveFromList(_this),_this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(_this.Params.trackName,_this.Params.user,_this.Params.track,_this.Params.permalink),_this.RefreshOptionsPanel(),_this.Effect.buffer=e});var me=this;clearTimeout(this.LoadTimeout),this.LoadTimeout=setTimeout(function(){me.TrackFallBack()},App.Config.SoundCloudLoadTimeout*1e3),this._FirstBuffer.onerror=function(){me.TrackFallBack()}},Convolver.prototype.Search=function(query){this.Searching=!0,App.MainScene.OptionsPanel.Animating=!0,this.ResultsPage=1,this.SearchResults=[],SoundCloudAPI_1.SoundCloudAPI.MultiSearch(query,App.Config.ConvolverMaxTrackLength,this)},Convolver.prototype.SetSearchResults=function(results){_super.prototype.SetSearchResults.call(this,results),this.Searching=!1,App.MainScene.OptionsPanel.Animating=!1;var len=results.length;for(var i=0;i<len;i++){var track=results[i];this.SearchResults.push(new SoundcloudTrack_1.SoundCloudTrack(track.title,track.user.username,track.uri,track.permalink_url))}},Convolver.prototype.LoadTrack=function(track,fullUrl){fullUrl=fullUrl||!1,fullUrl?this.Params.track=track.URI:this.Params.track=SoundCloudAPI_1.SoundCloudAPI.LoadTrack(track),this.Params.permalink=track.Permalink,this.Params.trackName=track.TitleShort,this.Params.user=track.UserShort,this._WaveForm=[],this.SetBuffer(),this.RefreshOptionsPanel("animate")},Convolver.prototype.TrackFallBack=function(){this.Params.track===this._FallBackTrack.URI&&(this._FallBackTrack=new SoundcloudTrack_1.SoundCloudTrack(this.Defaults.trackName,this.Defaults.user,this.Defaults.track,this.Defaults.permalink)),this.LoadTrack(this._FallBackTrack,!0),App.Message("Load Failed: This Track Is Unavailable. Reloading last track.")},Convolver.prototype.FirstSetup=function(){this._FirstRelease&&(this.SetBuffer(),this._FirstRelease=!1)},Convolver.prototype.GetDuration=function(){return this._FirstBuffer?this._FirstBuffer.duration:0},Convolver.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Convolver.prototype.MouseUp=function(){this.FirstSetup(),_super.prototype.MouseUp.call(this)},Convolver.prototype.Dispose=function(){this.Effect.dispose()},Convolver.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="mix"&&(this.Effect.wet.value=val),this.Params[param]=val},Convolver.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Convolution.name,parameters:[{type:"waveimage",name:"Wave",setting:"region",props:{wavearray:this._WaveForm}},{type:"sample",name:"Sample",setting:"sample",props:{track:this.Params.trackName,user:this.Params.user,permalink:this.Params.permalink}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}}]}},Convolver}(PostEffect_1.PostEffect);exports.Convolver=Convolver});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Distortion",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Distortion=function(_super){__extends(Distortion,_super);function Distortion(){_super.apply(this,arguments)}return Distortion.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Distortion.name,this.Defaults={drive:.65,mix:.75},this.PopulateParams(),this.Effect=new Tone.Distortion(this.Params.drive),this.Effect.wet.value=this.Params.mix,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(1,-1),new Point(1,0),new Point(-1,2))},Distortion.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Distortion.prototype.Dispose=function(){this.Effect.dispose()},Distortion.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="mix"?this.Effect.wet.value=val:this.Effect.distortion=val,this.Params[param]=val},Distortion.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Distortion.name,parameters:[{type:"slider",name:"Drive",setting:"drive",props:{value:this.Params.drive,min:.1,max:1,quantised:!1,centered:!1}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}}]}},Distortion}(PostEffect_1.PostEffect);exports.Distortion=Distortion});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Pre/Envelope",["require","exports","../PreEffect"],function(require,exports,PreEffect_1){var Point=etch.primitives.Point,Envelope=function(_super){__extends(Envelope,_super);function Envelope(){_super.apply(this,arguments)}return Envelope.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Envelope.name,this.Defaults={attack:1,decay:.5,sustain:.7,release:1},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(1,-1),new Point(1,1),new Point(0,2),new Point(-1,1))},Envelope.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Envelope.prototype.UpdateConnections=function(chain){var _this=this;_super.prototype.UpdateConnections.call(this,chain),chain.Sources.forEach(function(source){source.Envelopes.length?source.Envelopes.forEach(function(e){e.attack=_this.Params.attack,e.decay=_this.Params.decay,e.sustain=_this.Params.sustain,e.release=_this.Params.release}):source.Sources[0]instanceof Tone.Simpler&&source.Sources.forEach(function(s){var e=s.envelope;e.attack=_this.Params.attack,e.decay=_this.Params.decay,e.sustain=_this.Params.sustain,e.release=_this.Params.release})})},Envelope.prototype.SetParam=function(param,value){var _this=this;_super.prototype.SetParam.call(this,param,value),this.Params[param]=value,this.Chain&&this.Chain.Sources&&this.Chain.Sources.forEach(function(source){source.Envelopes.length?source.Envelopes.forEach(function(e){e.attack=_this.Params.attack,e.decay=_this.Params.decay,e.sustain=_this.Params.sustain,e.release=_this.Params.release}):source.Sources[0]instanceof Tone.Simpler&&source.Sources.forEach(function(s){var e=s.envelope;e.attack=_this.Params.attack,e.decay=_this.Params.decay,e.sustain=_this.Params.sustain,e.release=_this.Params.release})})},Envelope.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Envelope",parameters:[{type:"ADSR",name:"ADSR",setting:"adsr",nodes:[{setting:"attack",value:this.Params.attack,min:.01,max:5},{setting:"decay",value:this.Params.decay,min:.01,max:5},{setting:"sustain",value:this.Params.sustain,min:0,max:1},{setting:"release",value:this.Params.release,min:.01,max:5}]}]}},Envelope}(PreEffect_1.PreEffect);exports.Envelope=Envelope});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/EQ",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,EQ=function(_super){__extends(EQ,_super);function EQ(){_super.apply(this,arguments)}return EQ.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Eq.name,this.Defaults={frequency_1:50,Q_1:1,gain_1:0,frequency_2:440,Q_2:1,gain_2:0,frequency_3:2e3,Q_3:2.5,gain_3:0,frequency_4:1e4,Q_4:1,gain_4:0},this.PopulateParams(),this.Effect=new Tone.EQMultiband([{type:"lowshelf",frequency:this.Params.frequency_1,rolloff:-12,Q:this.Params.Q_1,gain:this.Params.gain_1},{type:"peaking",frequency:this.Params.frequency_2,rolloff:-12,Q:this.Params.Q_2,gain:this.Params.gain_2},{type:"peaking",frequency:this.Params.frequency_3,rolloff:-12,Q:this.Params.Q_3,gain:this.Params.gain_3},{type:"highshelf",frequency:this.Params.frequency_4,rolloff:-12,Q:this.Params.Q_4,gain:this.Params.gain_4}]),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,-1),new Point(2,0),new Point(1,1),new Point(0,1))},EQ.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},EQ.prototype.Dispose=function(){this.Effect.dispose()},EQ.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value,paramWithBand=param.split("_"),paramtype=paramWithBand[0],band=parseInt(paramWithBand[1]);switch(paramtype){case"frequency":this.Effect.setFrequency(val,band);break;case"Q":this.Effect.setQ(val,band);break;case"gain":this.Effect.setGain(val,band)}this.Params[param]=val},EQ.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Eq.name,parameters:[{type:"parametric",name:"Filter",setting:"parametric",nodes:[{x_setting:"frequency_1",x_value:this.Params.frequency_1,x_min:20,x_max:2e4,y_setting:"gain_1",y_value:this.Params.gain_1,y_min:-50,y_max:50,q_setting:"Q_1",q_value:this.Params.Q_1,q_min:20,q_max:1},{x_setting:"frequency_2",x_value:this.Params.frequency_2,x_min:20,x_max:2e4,y_setting:"gain_2",y_value:this.Params.gain_2,y_min:-50,y_max:50,q_setting:"Q_2",q_value:this.Params.Q_2,q_min:14,q_max:.5},{x_setting:"frequency_3",x_value:this.Params.frequency_3,x_min:20,x_max:2e4,y_setting:"gain_3",y_value:this.Params.gain_3,y_min:-50,y_max:50,q_setting:"Q_3",q_value:this.Params.Q_3,q_min:14,q_max:.5},{x_setting:"frequency_4",x_value:this.Params.frequency_4,x_min:20,x_max:2e4,y_setting:"gain_4",y_value:this.Params.gain_4,y_min:-50,y_max:50,q_setting:"Q_4",q_value:this.Params.Q_4,q_min:20,q_max:1}]}]}},EQ}(PostEffect_1.PostEffect);exports.EQ=EQ});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Filter",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Filter=function(_super){__extends(Filter,_super);function Filter(){_super.apply(this,arguments)}return Filter.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Filter.name,this.Defaults={frequency:440,gain:0},this.PopulateParams(),this.Effect=new Tone.Filter({type:"peaking",frequency:this.Params.frequency,rolloff:-12,Q:1,gain:this.Params.gain}),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-2),new Point(1,0),new Point(1,2),new Point(-1,0))},Filter.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Filter.prototype.Dispose=function(){this.Effect.dispose()},Filter.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;this.Effect[param].value=val,this.Params[param]=val},Filter.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Filter.name,parameters:[{type:"slider",name:"Frequency",setting:"frequency",props:{value:this.Params.frequency,min:20,max:2e4,quantised:!0,centered:!1,logarithmic:!0}},{type:"slider",name:"Gain",setting:"gain",props:{value:this.Params.gain,min:-35,max:35,quantised:!1,centered:!0}}]}},Filter}(PostEffect_1.PostEffect);exports.Filter=Filter});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Volume",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Volume=function(_super){__extends(Volume,_super);function Volume(){_super.apply(this,arguments)}return Volume.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Volume.name,this.Defaults={gain:0},this.PopulateParams(),this.Effect=new Tone.Volume(this.Params.gain),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(2,1),new Point(0,1))},Volume.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Volume.prototype.Dispose=function(){this.Effect.dispose(),this.Effect=null},Volume.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value),this.Effect.volume.value=value,this.Params[param]=value},Volume.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Volume.name,parameters:[{type:"slider",name:"Level",setting:"gain",props:{value:this.Params.gain,min:-20,max:20,quantised:!1,centered:!0}}]}},Volume}(PostEffect_1.PostEffect);exports.Volume=Volume});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Phaser",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Phaser=function(_super){__extends(Phaser,_super);function Phaser(){_super.apply(this,arguments)}return Phaser.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Phaser.name,this.Defaults={rate:1.8,depth:3.2,baseFrequency:400,mix:.5},this.PopulateParams(),this.Effect=new Tone.Phaser({frequency:this.Params.rate,octaves:this.Params.depth,Q:1,baseFrequency:this.Params.baseFrequency}),this.Effect.wet.value=this.Params.mix,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(-1,-2),new Point(1,0),new Point(1,2))},Phaser.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Phaser.prototype.Dispose=function(){this.Effect.dispose()},Phaser.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="mix"?this.Effect.wet.value=val:param=="rate"?this.Effect.frequency.value=val:param=="depth"?this.Effect.octaves=val:this.Effect[param]=val,this.Params[param]=val},Phaser.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Phaser.name,parameters:[{type:"slider",name:"Rate",setting:"rate",props:{value:this.Params.rate,min:0,max:10,quantised:!1,centered:!1}},{type:"slider",name:"Width",setting:"depth",props:{value:this.Params.depth,min:1,max:10,quantised:!1,centered:!1}},{type:"slider",name:"Frequency",setting:"baseFrequency",props:{value:this.Params.baseFrequency,min:10,max:2e3,quantised:!0,centered:!1}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}}]}},Phaser}(PostEffect_1.PostEffect);exports.Phaser=Phaser});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/PitchShifter",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,PitchShifter=function(_super){__extends(PitchShifter,_super);function PitchShifter(){_super.apply(this,arguments)}return PitchShifter.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.PitchShifter.name,this.Defaults={mix:.5,pitchOffset:6.9,windowSize:.07},this.PopulateParams(),this.Effect=new Tone.PitchShift(this.Params.pitchOffset),this.Effect.wet.value=this.Params.mix,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(2,-1),new Point(0,1))},PitchShifter.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},PitchShifter.prototype.Dispose=function(){this.Effect.dispose()},PitchShifter.prototype.SetParam=function(param,value){param=="pitchOffset"?this.Effect.pitch=value:param=="windowSize"?this.Effect.windowSize=value:param==="mix"&&(this.Effect.wet.value=value),this.Params[param]=value},PitchShifter.prototype.UpdateOptionsForm=function(){this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.PitchShifter.name,parameters:[{type:"slider",name:"Pitchshift",setting:"pitchOffset",props:{value:this.Params.pitchOffset,min:-12,max:12,quantised:!1,centered:!0}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}}]}},PitchShifter}(PostEffect_1.PostEffect);exports.PitchShifter=PitchShifter});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/Reverb",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,Reverb=function(_super){__extends(Reverb,_super);function Reverb(){_super.apply(this,arguments)}return Reverb.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Reverb.name,this.Defaults={dampening:.7,roomSize:.5,mix:.5},this.PopulateParams(),this.Effect=new Tone.Freeverb(this.Params.dampening,this.Params.roomSize),this.Effect.wet.value=this.Params.mix,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(1,-1),new Point(2,0),new Point(0,2),new Point(-1,1))},Reverb.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Reverb.prototype.Dispose=function(){this.Effect.dispose()},Reverb.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="mix"?this.Effect.wet.value=val:param=="dampening"?this.Effect.dampening.value=val:param=="roomSize"&&(this.Effect.roomSize.value=val),this.Params[param]=val},Reverb.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.Reverb.name,parameters:[{type:"slider",name:"Room Size",setting:"roomSize",props:{value:this.Params.roomSize,min:.1,max:.95,quantised:!1,centered:!1}},{type:"slider",name:"Dampening",setting:"dampening",props:{value:this.Params.dampening,min:.1,max:1,quantised:!1,centered:!1}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}}]}},Reverb}(PostEffect_1.PostEffect);exports.Reverb=Reverb});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Pre/LFObase",["require","exports","../../Sources/Granular","../PreEffect"],function(require,exports,Granular_1,PreEffect_1){var LFObase=function(_super){__extends(LFObase,_super);function LFObase(){_super.apply(this,arguments)}return LFObase.prototype.Dispose=function(){this.OscLFO.stop(),this.SamplerLFO.stop(),this.OscLFO.dispose(),this.SamplerLFO.dispose()},LFObase.prototype.InitializeLFOs=function(){this.OscLFO=new Tone.LFO,this.SamplerLFO=new Tone.LFO,this.OscLFO.frequency.value=this.Params.rate,this.SamplerLFO.frequency.value=this.Params.rate,this.OscLFO.min=-this.Params.depth,this.SamplerLFO.min=LFObase.ConvertLFODepthToPlaybackDepth(-this.Params.depth),this.OscLFO.max=this.Params.depth,this.SamplerLFO.max=LFObase.ConvertLFODepthToPlaybackDepth(this.Params.depth),this.OscLFO.type=App.Audio.WaveformTypeIndex[this.Params.waveform],this.SamplerLFO.type=App.Audio.WaveformTypeIndex[this.Params.waveform],this.OscLFO.start(),this.SamplerLFO.start()},LFObase.prototype.SetParam=function(param,value){var val=value;param=="rate"?(this.OscLFO.frequency.value=val,this.SamplerLFO.frequency.value=val):param=="depth"?(this.OscLFO.min=-val,this.SamplerLFO.min=LFObase.ConvertLFODepthToPlaybackDepth(-val),this.OscLFO.max=val,this.SamplerLFO.max=LFObase.ConvertLFODepthToPlaybackDepth(val)):param=="waveform"&&(this.OscLFO.type=App.Audio.WaveformTypeIndex[val],this.SamplerLFO.type=App.Audio.WaveformTypeIndex[val]),this.Params[param]=val},LFObase.prototype.UpdateConnections=function(chain){_super.prototype.UpdateConnections.call(this,chain),this.OscLFO.disconnect(),this.SamplerLFO.disconnect();for(var i=0;i<chain.Sources.length;i++){var source=chain.Sources[i];if(source instanceof Granular_1.Granular)this.SamplerLFO.connect(source.PlaybackSignal.Signal);else for(var j=0;j<source.Sources.length;j++){var s=source.Sources[j];s.detune?this.OscLFO.connect(s.detune):s.player&&s.player.detune?this.SamplerLFO.connect(s.player.detune):s.player&&s.player.playbackRate?this.SamplerLFO.connect(source.PlaybackSignal.Signal):s.playbackRate&&this.SamplerLFO.connect(s.playbackRate)}}},LFObase.ConvertLFODepthToPlaybackDepth=function(val){return App.Audio.HasBufferSourceDetuneCapability?val:val/400+1},LFObase}(PreEffect_1.PreEffect);exports.LFObase=LFObase});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Pre/Scuzz",["require","exports","./LFObase"],function(require,exports,LFObase_1){var Point=etch.primitives.Point,Scuzz=function(_super){__extends(Scuzz,_super);function Scuzz(){_super.apply(this,arguments)}return Scuzz.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Scuzz.name,this.Defaults={depth:1e3,rate:100,waveform:2},this.PopulateParams(),this.InitializeLFOs(),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,-1),new Point(2,-1),new Point(0,1),new Point(-1,0))},Scuzz.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Scuzz.prototype.UpdateOptionsForm=function(){this.OptionsForm={name:"Scuzz",parameters:[{type:"slider",name:"Power",setting:"depth",props:{value:this.Params.depth,min:1e3,max:1e4,quantised:!0,centered:!1}},{type:"slider",name:"Pulverisation",setting:"rate",props:{value:this.Params.rate,min:100,max:1e4,quantised:!0,centered:!1}}]}},Scuzz}(LFObase_1.LFObase);exports.Scuzz=Scuzz});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Post/StereoDelay",["require","exports","../PostEffect"],function(require,exports,PostEffect_1){var Point=etch.primitives.Point,StereoDelay=function(_super){__extends(StereoDelay,_super);function StereoDelay(){_super.apply(this,arguments)}return StereoDelay.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.StereoDelay.name,this.Defaults={delayTime:.25,feedback:.4,mix:.5},this.PopulateParams(),this.Effect=new Tone.PingPongDelay(this.Params.delayTime),this.Effect.feedback.value=this.Params.feedback,this.Effect.wet.value=this.Params.mix,this._SliderTime=.1,_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,0),new Point(1,2),new Point(0,1),new Point(-1,2))},StereoDelay.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},StereoDelay.prototype.Dispose=function(){this.Effect.dispose()},StereoDelay.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);var val=value;param=="mix"?this.Effect.wet.value=val:param=="delayTime"?this.Effect.delayTime.rampTo(val,this._SliderTime):param=="sliderTime"?this._SliderTime=val:this.Effect[param].value=val,this.Params[param]=val},StereoDelay.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:App.L10n.Blocks.Effect.Blocks.StereoDelay.name,parameters:[{type:"slider",name:"Delay Time",setting:"delayTime",props:{value:this.Params.delayTime,min:.05,max:.5,quantised:!1,centered:!1}},{type:"slider",name:"Feedback",setting:"feedback",props:{value:this.Params.feedback,min:0,max:.9,quantised:!1,centered:!1}},{type:"slider",name:"Mix",setting:"mix",props:{value:this.Params.mix,min:0,max:1,quantised:!1,centered:!1}}]}},StereoDelay}(PostEffect_1.PostEffect);exports.StereoDelay=StereoDelay});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Effects/Pre/Vibrato",["require","exports","./LFObase"],function(require,exports,LFObase_1){var Point=etch.primitives.Point,Vibrato=function(_super){__extends(Vibrato,_super);function Vibrato(){_super.apply(this,arguments)}return Vibrato.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Effect.Blocks.Vibrato.name,this.Defaults={rate:2,depth:20,waveform:2},this.PopulateParams(),this.InitializeLFOs(),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(1,0),new Point(1,2))},Vibrato.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Vibrato.prototype.UpdateOptionsForm=function(){this.OptionsForm={name:"Vibrato",parameters:[{type:"slider",name:"Rate",setting:"rate",props:{value:this.Params.rate,min:0,max:20,quantised:!1,centered:!1}},{type:"slider",name:"Depth",setting:"depth",props:{value:this.Params.depth,min:0,max:200,quantised:!1,centered:!1}},{type:"buttons",name:"Wave",setting:"waveform",props:{value:this.Params.waveform,mode:"wave"},buttons:[{name:"Sine"},{name:"Square"},{name:"Triangle"},{name:"Saw"}]}]}},Vibrato}(LFObase_1.LFObase);exports.Vibrato=Vibrato});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/Logic/Pulse",["require","exports","./Logic","./../ParticleEmitter"],function(require,exports,Logic_1,ParticleEmitter_1){var Point=etch.primitives.Point,Pulse=function(_super){__extends(Pulse,_super);function Pulse(){_super.apply(this,arguments)}return Pulse.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Power.Blocks.PulsePower.name,this.Defaults={logic:!1,pulseLength:App.Config.PulseLength/1e3},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(0,-1),new Point(1,-1),new Point(1,1),new Point(0,2),new Point(-1,2),new Point(-1,0))},Pulse.prototype.UpdateConnections=function(){},Pulse.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Pulse.prototype.Dispose=function(){_super.prototype.Dispose.call(this)},Pulse.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Pulse Power",parameters:[{type:"slider",name:"Pulse length",setting:"pulseLength",props:{value:this.Params.pulseLength,min:.01,max:2,quantised:!1,centered:!1}},{type:"switches",name:"Power",setting:"",switches:[{name:"Pulse On",setting:"logic",value:this.Params.logic,lit:!0,mode:"offOn"}]}]}},Pulse.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value);switch(param){case"logic":this.PerformLogic();break;case"pulseLength":this.Params.pulseLength=value}},Pulse.prototype.PerformLogic=function(){var _this=this,pulseLength=this.Params.pulseLength*1e3;this.Params.logic=!0;var connections=this.Connections.ToArray();connections.forEach(function(source){source.AddPower(),setTimeout(function(){source.RemovePower()},pulseLength),source instanceof ParticleEmitter_1.ParticleEmitter&&source.EmitParticle()}),this.RefreshOption(1),setTimeout(function(){_this.RefreshOption(1)},pulseLength),this.Params.logic=!1},Pulse}(Logic_1.Logic);exports.Pulse=Pulse});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Power/Logic/Toggle",["require","exports","./Logic"],function(require,exports,Logic_1){var Point=etch.primitives.Point,Toggle=function(_super){__extends(Toggle,_super);function Toggle(){_super.apply(this,arguments)}return Toggle.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Power.Blocks.TogglePower.name,this.Defaults={logic:!1},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),this.Outline.push(new Point(0,-1),new Point(1,0),new Point(1,2),new Point(0,2),new Point(-1,1),new Point(-1,-1))},Toggle.prototype.UpdateConnections=function(){var _this=this,newConnections=this.Connections.ToArray();this.OldConnections.forEach(function(source){_this.Params.logic&&newConnections.indexOf(source)===-1&&source.RemovePower()}),newConnections.forEach(function(source){_this.Params.logic&&_this.OldConnections.indexOf(source)===-1&&source.AddPower()}),this.OldConnections=newConnections},Toggle.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},Toggle.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"Toggle Power",parameters:[{type:"switches",name:"Power",setting:"",switches:[{name:"Off/On",setting:"logic",value:this.Params.logic,lit:!0,mode:"offOn"}]}]}},Toggle.prototype.SetParam=function(param,value){_super.prototype.SetParam.call(this,param,value),param=="logic"&&this.PerformLogic(),this.Params[""+param]=value},Toggle.prototype.PerformLogic=function(){if(this.Params.logic){this.Params.logic=!1;var connections=this.Connections.ToArray();connections.forEach(function(source){source.RemovePower()})}else{this.Params.logic=!0;var connections=this.Connections.ToArray();connections.forEach(function(source){source.AddPower()})}this.RefreshOption(0)},Toggle.prototype.Stop=function(){if(this.Params.logic){var connections=this.Connections.ToArray();connections.forEach(function(source){source.RemovePower()})}},Toggle}(Logic_1.Logic);exports.Toggle=Toggle});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("Blocks/Interaction/MIDIController",["require","exports","./Keyboard"],function(require,exports,Keyboard_1){var Point=etch.primitives.Point,MIDIController=function(_super){__extends(MIDIController,_super);function MIDIController(){_super.apply(this,arguments)}return MIDIController.prototype.Init=function(drawTo){this.BlockName=App.L10n.Blocks.Interaction.Blocks.MIDIController.name,this.Defaults={transpose:0,glide:.05,isPolyphonic:!1},this.PopulateParams(),_super.prototype.Init.call(this,drawTo),App.Audio.MIDIManager.MIDIMessage.on(this._OnMIDIMessage,this),this.Outline.push(new Point(-1,0),new Point(0,-1),new Point(2,1),new Point(1,2),new Point(-1,2))},MIDIController.prototype._OnMIDIMessage=function(MIDIManager,e){var cmd=e.MIDI.cmd,channel=e.MIDI.channel,type=e.MIDI.type,note=e.MIDI.note,velocity=e.MIDI.velocity;if(channel==9)return;cmd==8||cmd==9&&velocity==0?(delete this.KeysDown[""+note],this.NoteOff(note)):cmd===9?(this.KeysDown[""+note]=!0,this.NoteOn(note)):cmd==14&&(this.Bend=(velocity*128+note-8192)/8192*6*App.Config.PitchBendRange,this.UpdateMods())},MIDIController.prototype.Draw=function(){_super.prototype.Draw.call(this),this.DrawSprite(this.BlockName)},MIDIController.prototype.UpdateOptionsForm=function(){_super.prototype.UpdateOptionsForm.call(this),this.OptionsForm={name:"MIDI Keyboard",parameters:[{type:"switches",name:"",setting:"",props:{value:0,min:0,max:1,quantised:!0},switches:[{name:"Mono/Poly",setting:"polyphonic",value:this.Params.isPolyphonic,mode:"fewMany"}]},{type:"slider",name:"Octave",setting:"transpose",props:{value:this.Params.transpose,min:-this.TranspositionRange,max:this.TranspositionRange,quantised:!0,centered:!0}},{type:"slider",name:"Glide",setting:"glide",props:{value:this.Params.glide*100,min:.001,max:100,truemin:0,truemax:1,quantised:!1,centered:!1}}]}},MIDIController.prototype.Dispose=function(){App.Audio.MIDIManager.MIDIMessage.off(this._OnMIDIMessage,this),_super.prototype.Dispose.call(this)},MIDIController.prototype.Stop=function(){App.Audio.MIDIManager.MIDIMessage.off(this._OnMIDIMessage,this)},MIDIController}(Keyboard_1.Keyboard);exports.MIDIController=MIDIController}),define("BlockCreator",["require","exports","./Blocks/Sources/Granular","./Blocks/Sources/Microphone","./Blocks/Sources/Noise","./Blocks/Sources/Recorder","./Blocks/Sources/Sample","./Blocks/Sources/ToneSource","./Blocks/Sources/SampleGen","Blocks/Effects/Post/AutoWah","Blocks/Effects/Post/BitCrusher","Blocks/Effects/Post/Chomp","Blocks/Effects/Post/Chopper","Blocks/Effects/Post/Chorus","Blocks/Effects/Post/ConvolutionReverb","Blocks/Effects/Post/Distortion","Blocks/Effects/Pre/Envelope","Blocks/Effects/Post/EQ","Blocks/Effects/Post/Filter","Blocks/Effects/Post/Volume","Blocks/Effects/Post/Phaser","Blocks/Effects/Post/PitchShifter","Blocks/Effects/Post/Reverb","Blocks/Effects/Pre/Scuzz","Blocks/Effects/Post/StereoDelay","Blocks/Effects/Pre/Vibrato","./Blocks/Power/Laser","./Blocks/Power/Logic/Pulse","./Blocks/Power/ParticleEmitter","./Blocks/Power/Power","./Blocks/Power/Logic/Toggle","./Blocks/Power/Void","Blocks/Interaction/ComputerKeyboard","Blocks/Interaction/MIDIController"],function(require,exports,Granular_1,Microphone_1,Noise_1,Recorder_1,Sample_1,ToneSource_1,SampleGen_1,AutoWah_1,BitCrusher_1,Chomp_1,Chopper_1,Chorus_1,ConvolutionReverb_1,Distortion_1,Envelope_1,EQ_1,Filter_1,Volume_1,Phaser_1,PitchShifter_1,Reverb_1,Scuzz_1,StereoDelay_1,Vibrato_1,Laser_1,Pulse_1,ParticleEmitter_1,Power_1,Toggle_1,Void_1,ComputerKeyboard_1,MIDIController_1){var BlockCreator=function(){function BlockCreator(){this.Granular=Granular_1.Granular,this.Microphone=Microphone_1.Microphone,this.Noise=Noise_1.Noise,this.Recorder=Recorder_1.Recorder,this.Sample=Sample_1.Sample,this.ToneSource=ToneSource_1.ToneSource,this.SampleGen=SampleGen_1.SampleGen,this.AutoWah=AutoWah_1.AutoWah,this.BitCrusher=BitCrusher_1.BitCrusher,this.Chomp=Chomp_1.Chomp,this.Chopper=Chopper_1.Chopper,this.Chorus=Chorus_1.Chorus,this.Convolver=ConvolutionReverb_1.Convolver,this.Distortion=Distortion_1.Distortion,this.Envelope=Envelope_1.Envelope,this.EQ=EQ_1.EQ,this.Filter=Filter_1.Filter,this.Phaser=Phaser_1.Phaser,this.PitchShifter=PitchShifter_1.PitchShifter,this.Reverb=Reverb_1.Reverb,this.Scuzz=Scuzz_1.Scuzz,this.StereoDelay=StereoDelay_1.StereoDelay,this.Vibrato=Vibrato_1.Vibrato,this.Volume=Volume_1.Volume,this.Laser=Laser_1.Laser,this.ParticleEmitter=ParticleEmitter_1.ParticleEmitter,this.Power=Power_1.Power,this.Pulse=Pulse_1.Pulse,this.Toggle=Toggle_1.Toggle,this.Void=Void_1.Void,this.ComputerKeyboard=ComputerKeyboard_1.ComputerKeyboard,this.MIDIController=MIDIController_1.MIDIController,this.MenuJson={categories:[{name:App.L10n.Blocks.Source.Label,items:[{name:App.L10n.Blocks.Source.Blocks.Tone.name,id:ToneSource_1.ToneSource,description:App.L10n.Blocks.Source.Blocks.Tone.description},{name:App.L10n.Blocks.Source.Blocks.Noise.name,id:Noise_1.Noise,description:App.L10n.Blocks.Source.Blocks.Noise.description},{name:App.L10n.Blocks.Source.Blocks.Microphone.name,id:Microphone_1.Microphone,description:App.L10n.Blocks.Source.Blocks.Microphone.description},{name:App.L10n.Blocks.Source.Blocks.Sample.name,id:Sample_1.Sample,description:App.L10n.Blocks.Source.Blocks.Sample.description},{name:App.L10n.Blocks.Source.Blocks.Granular.name,id:Granular_1.Granular,description:App.L10n.Blocks.Source.Blocks.Granular.description},{name:App.L10n.Blocks.Source.Blocks.Recorder.name,id:Recorder_1.Recorder,description:App.L10n.Blocks.Source.Blocks.Recorder.description},{name:App.L10n.Blocks.Source.Blocks.SampleGen.name,id:SampleGen_1.SampleGen,description:App.L10n.Blocks.Source.Blocks.SampleGen.description}]},{name:App.L10n.Blocks.Effect.Label,items:[{name:App.L10n.Blocks.Effect.Blocks.AutoWah.name,id:AutoWah_1.AutoWah,description:App.L10n.Blocks.Effect.Blocks.AutoWah.description},{name:App.L10n.Blocks.Effect.Blocks.BitCrusher.name,id:BitCrusher_1.BitCrusher,description:App.L10n.Blocks.Effect.Blocks.BitCrusher.description},{name:App.L10n.Blocks.Effect.Blocks.Chomp.name,id:Chomp_1.Chomp,description:App.L10n.Blocks.Effect.Blocks.Chomp.description},{name:App.L10n.Blocks.Effect.Blocks.Chopper.name,id:Chopper_1.Chopper,description:App.L10n.Blocks.Effect.Blocks.Chopper.description},{name:App.L10n.Blocks.Effect.Blocks.Chorus.name,id:Chorus_1.Chorus,description:App.L10n.Blocks.Effect.Blocks.Chorus.description},{name:App.L10n.Blocks.Effect.Blocks.Convolution.name,id:ConvolutionReverb_1.Convolver,description:App.L10n.Blocks.Effect.Blocks.Convolution.description},{name:App.L10n.Blocks.Effect.Blocks.Distortion.name,id:Distortion_1.Distortion,description:App.L10n.Blocks.Effect.Blocks.Distortion.description},{name:App.L10n.Blocks.Effect.Blocks.Envelope.name,id:Envelope_1.Envelope,description:App.L10n.Blocks.Effect.Blocks.Envelope.description},{name:App.L10n.Blocks.Effect.Blocks.Eq.name,id:EQ_1.EQ,description:App.L10n.Blocks.Effect.Blocks.Eq.description},{name:App.L10n.Blocks.Effect.Blocks.Filter.name,id:Filter_1.Filter,description:App.L10n.Blocks.Effect.Blocks.Filter.description},{name:App.L10n.Blocks.Effect.Blocks.Phaser.name,id:Phaser_1.Phaser,description:App.L10n.Blocks.Effect.Blocks.Phaser.description},{name:App.L10n.Blocks.Effect.Blocks.PitchShifter.name,id:PitchShifter_1.PitchShifter,description:App.L10n.Blocks.Effect.Blocks.PitchShifter.description},{name:App.L10n.Blocks.Effect.Blocks.Reverb.name,id:Reverb_1.Reverb,description:App.L10n.Blocks.Effect.Blocks.Reverb.description},{name:App.L10n.Blocks.Effect.Blocks.Scuzz.name,id:Scuzz_1.Scuzz,description:App.L10n.Blocks.Effect.Blocks.Scuzz.description},{name:App.L10n.Blocks.Effect.Blocks.StereoDelay.name,id:StereoDelay_1.StereoDelay,description:App.L10n.Blocks.Effect.Blocks.StereoDelay.description},{name:App.L10n.Blocks.Effect.Blocks.Vibrato.name,id:Vibrato_1.Vibrato,description:App.L10n.Blocks.Effect.Blocks.Vibrato.description},{name:App.L10n.Blocks.Effect.Blocks.Volume.name,id:Volume_1.Volume,description:App.L10n.Blocks.Effect.Blocks.Volume.description}]},{name:App.L10n.Blocks.Power.Label,items:[{name:App.L10n.Blocks.Power.Blocks.ParticleEmitter.name,id:ParticleEmitter_1.ParticleEmitter,description:App.L10n.Blocks.Power.Blocks.ParticleEmitter.description},{name:App.L10n.Blocks.Power.Blocks.Power.name,id:Power_1.Power,description:App.L10n.Blocks.Power.Blocks.Power.description},{name:App.L10n.Blocks.Power.Blocks.TogglePower.name,id:Toggle_1.Toggle,description:App.L10n.Blocks.Power.Blocks.TogglePower.description},{name:App.L10n.Blocks.Power.Blocks.Void.name,id:Void_1.Void,description:App.L10n.Blocks.Power.Blocks.Void.description},{name:App.L10n.Blocks.Power.Blocks.PulsePower.name,id:Pulse_1.Pulse,description:App.L10n.Blocks.Power.Blocks.PulsePower.description},{name:App.L10n.Blocks.Power.Blocks.Laser.name,id:Laser_1.Laser,description:App.L10n.Blocks.Power.Blocks.Laser.description}]},{name:App.L10n.Blocks.Interaction.Label,items:[{name:App.L10n.Blocks.Interaction.Blocks.ComputerKeyboard.name,id:ComputerKeyboard_1.ComputerKeyboard,description:App.L10n.Blocks.Interaction.Blocks.ComputerKeyboard.description},{name:App.L10n.Blocks.Interaction.Blocks.MIDIController.name,id:MIDIController_1.MIDIController,description:App.L10n.Blocks.Interaction.Blocks.MIDIController.description}]}]}}return BlockCreator.prototype.GetBlock=function(type){type=this.BackwardsCompatibilityCheck(type);var b=eval("new this."+type+"()");return b.Type=eval("this."+type),b},BlockCreator.prototype.BackwardsCompatibilityCheck=function(type){switch(type){case"Gain":type="Volume";break;case"Pitch":type="PitchShifter";break;case"LFO":type="Vibrato";break;case"WaveGen":type="SampleGen";break;case"Momentary":type="Pulse";break;case"Soundcloud":type="Sample";break;case"Delay":type="StereoDelay"}return type},BlockCreator}();exports.BlockCreator=BlockCreator});var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};define("GAVariables",["require","exports","./StringValue"],function(require,exports,StringValue_1){var GAVariable=function(_super){__extends(GAVariable,_super);function GAVariable(){_super.apply(this,arguments)}return GAVariable}(StringValue_1.StringValue),GAVariables=function(){function GAVariables(){}return GAVariables.THEME=new GAVariable("theme"),GAVariables}();exports.GAVariables=GAVariables}),define("CompositionLoadFailedEventArgs",["require","exports"],function(require,exports){var CompositionLoadFailedEventArgs=function(){function CompositionLoadFailedEventArgs(compositionId){Object.defineProperty(this,"CompositionId",{value:compositionId,writable:!1})}return CompositionLoadFailedEventArgs}();exports.CompositionLoadFailedEventArgs=CompositionLoadFailedEventArgs}),define("App",["require","exports","./Core/Visual/AddressBarManager","./Core/Audio/Audio","./Blocks/BlockSprites","./Core/Visual/ColorManager","./Core/Resources/CommandHandlerFactory","./Core/Commands/CommandManager","./Core/Inputs/CommandsInputManager","./Commands","./CompositionLoadedEventArgs","./CommandHandlers/CreateBlockCommandHandler","./CommandHandlers/DeleteBlockCommandHandler","./Blocks/Effect","./Core/Inputs/FocusManager","./CommandHandlers/LoadCommandHandler","./Metrics","./CommandHandlers/MoveBlockCommandHandler","./Core/Operations/OperationManager","./Particle","./Core/Inputs/PianoKeyboardManager","./Core/Inputs/PointerInputManager","./Core/Resources/PooledFactoryResource","./Blocks/Power/PowerEffect","./Blocks/Power/PowerSource","./CommandHandlers/RedoCommandHandler","./Core/Resources/ResourceManager","./CommandHandlers/SaveAsCommandHandler","./CommandHandlers/SaveCommandHandler","./Serializer","./Core/Audio/SoundCloud/SoundCloudAPI","./Blocks/Source","./Stage","./Core/Visual/ThemeManager","./Core/Inputs/TypingManager","./CommandHandlers/UndoCommandHandler","./BlockCreator","./CommandCategories","./Errors","./GAVariables","./CompositionLoadFailedEventArgs"],function(require,exports,AddressBarManager_1,Audio_1,BlockSprites_1,ColorManager_1,CommandHandlerFactory_1,CommandManager_1,CommandsInputManager_1,Commands_1,CompositionLoadedEventArgs_1,CreateBlockCommandHandler_1,DeleteBlockCommandHandler_1,Effect_1,FocusManager_1,LoadCommandHandler_1,Metrics_1,MoveBlockCommandHandler_1,OperationManager_1,Particle_1,PianoKeyboardManager_1,PointerInputManager_1,PooledFactoryResource_1,PowerEffect_1,PowerSource_1,RedoCommandHandler_1,ResourceManager_1,SaveAsCommandHandler_1,SaveCommandHandler_1,Serializer_1,SoundCloudAPI_1,Source_1,Stage_1,ThemeManager_1,TypingManager_1,UndoCommandHandler_1,BlockCreator_1,CommandCategories_1,Errors_1,GAVariables_1,CompositionLoadFailedEventArgs_1){var Canvas=etch.drawing.Canvas,Point=minerva.Point,App=function(){function App(config,l10n){this.CompositionLoaded=new nullstone.Event,this.CompositionLoadFailed=new nullstone.Event,this.Audio=new Audio_1.Audio,this.Blocks=[],this.DragOffset=new Point(0,0),this.IsLoadingComposition=!1,this.Palette=[],this.Particles=[],this.Config=JSON.parse(config),this.L10n=JSON.parse(l10n)}return Object.defineProperty(App.prototype,"AnimationsLayer",{get:function(){return this.MainScene.AnimationsLayer},enumerable:!0,configurable:!0}),Object.defineProperty(App.prototype,"MainScene",{get:function(){return this.Stage.MainScene},enumerable:!0,configurable:!0}),Object.defineProperty(App.prototype,"Sources",{get:function(){return this.Blocks.en().where(function(b){return b instanceof Source_1.Source}).toArray()},enumerable:!0,configurable:!0}),Object.defineProperty(App.prototype,"Effects",{get:function(){return this.Blocks.en().where(function(b){return b instanceof Effect_1.Effect}).toArray()},enumerable:!0,configurable:!0}),Object.defineProperty(App.prototype,"PowerEffects",{get:function(){return this.Blocks.en().where(function(b){return b instanceof PowerEffect_1.PowerEffect}).toArray()},enumerable:!0,configurable:!0}),Object.defineProperty(App.prototype,"PowerSources",{get:function(){return this.Blocks.en().where(function(b){return b instanceof PowerSource_1.PowerSource}).toArray()},enumerable:!0,configurable:!0}),App.prototype.GetBlockId=function(){var max=0;for(var i=0;i<this.Blocks.length;i++){var b=this.Blocks[i];b.Id>max&&(max=b.Id)}return max+1},Object.defineProperty(App.prototype,"SessionId",{get:function(){if(this._SessionId)return this._SessionId;var storageItem=Utils.Storage.get(this.CompositionId,Utils.StorageType.local);if(storageItem)return storageItem.value},set:function(value){this._SessionId=value,Utils.Storage.set(this.CompositionId,this._SessionId,this.Config.StorageTime,Utils.StorageType.local)},enumerable:!0,configurable:!0}),Object.defineProperty(App.prototype,"ThemeNo",{get:function(){var storageItem=Utils.Storage.get("ColorTheme",Utils.StorageType.local);if(storageItem)return storageItem.value},set:function(value){Utils.Storage.set("ColorTheme",value,this.Config.StorageTime,Utils.StorageType.local)},enumerable:!0,configurable:!0}),Object.defineProperty(App.prototype,"SkipTutorial",{get:function(){var storageItem=Utils.Storage.get("SkipTutorial",Utils.StorageType.local);if(storageItem)return storageItem.value},set:function(value){Utils.Storage.set("SkipTutorial",value,this.Config.StorageTime,Utils.StorageType.local)},enumerable:!0,configurable:!0}),App.prototype.Setup=function(){var _this=this;this.Canvas=new Canvas,this.Canvas.HTMLElement.id="mainCanvas",document.body.classList.add("app-active"),this.BlockCreator=new BlockCreator_1.BlockCreator,this.Metrics=new Metrics_1.Metrics,this.BlockSprites=new BlockSprites_1.BlockSprites,this.SubCanvas=[],this.CreateSubCanvas(0),window.onresize=function(){_this.Resize()},this.Audio.Init(),this._FontsLoaded=0,WebFont.load({custom:{families:["Merriweather Sans:i3","Dosis:n2,n4"]},fontactive:function(font,fvd){_this.FontsLoaded(font,fvd)},timeout:3e3}),setTimeout(function(){_this.FontsNotLoaded()},3020),this.OperationManager=new OperationManager_1.OperationManager,this.OperationManager.MaxOperations=this.Config.MaxOperations,this.ResourceManager=new ResourceManager_1.ResourceManager,this.CommandManager=new CommandManager_1.CommandManager(this.ResourceManager),this.TypingManager=new TypingManager_1.TypingManager,this.PianoKeyboardManager=new PianoKeyboardManager_1.PianoKeyboardManager,this.CommandsInputManager=new CommandsInputManager_1.CommandsInputManager(this.CommandManager),this.PointerInputManager=new PointerInputManager_1.PointerInputManager,this.ColorManager=new ColorManager_1.ColorManager,this.ThemeManager=new ThemeManager_1.ThemeManager,this.FocusManager=new FocusManager_1.FocusManager,this.AddressBarManager=new AddressBarManager_1.AddressBarManager,this.FocusManager.FocusChanged.on(function(s,e){e.HasFocus||(_this.TypingManager.ClearKeysDown(),_this.PianoKeyboardManager.ClearKeysDown(),_this.CommandsInputManager.ClearKeysDown())},this),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.CREATE_BLOCK,CreateBlockCommandHandler_1.CreateBlockCommandHandler.prototype)),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.DELETE_BLOCK,DeleteBlockCommandHandler_1.DeleteBlockCommandHandler.prototype)),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.MOVE_BLOCK,MoveBlockCommandHandler_1.MoveBlockCommandHandler.prototype)),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.SAVE,SaveCommandHandler_1.SaveCommandHandler.prototype)),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.SAVE_AS,SaveAsCommandHandler_1.SaveAsCommandHandler.prototype)),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.LOAD,LoadCommandHandler_1.LoadCommandHandler.prototype)),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.UNDO,UndoCommandHandler_1.UndoCommandHandler.prototype)),this.ResourceManager.AddResource(new CommandHandlerFactory_1.CommandHandlerFactory(Commands_1.Commands.REDO,RedoCommandHandler_1.RedoCommandHandler.prototype)),this.ParticlesPool=new PooledFactoryResource_1.PooledFactoryResource(10,100,Particle_1.Particle.prototype);var tempClientIDs=["7258ff07f16ddd167b55b8f9b9a3ed33","33ebf0c1ffa4e462157606a432bd7b5f","ce852127c5413fe70816d488694d7921"],tempClientIDs2=["3291559d547bd9c545cbf393f522ea68","3833cf666207c249e9767699a4d22a79","cb6c82fd11c903be63bdc4df4c5c7e09","6c5bafb2050dc09d8f5d738030aa9fed"];this.Config.SoundCloudClientId=tempClientIDs2[Math.floor(Math.random()*tempClientIDs2.length)],SoundCloudAPI_1.SoundCloudAPI.Initialize(),this.ThemeManager.ThemeChanged.on(function(s,e){_this.TrackVariable(GAVariables_1.GAVariables.THEME.toString(),e.Index.toString()),_this.TrackEvent(CommandCategories_1.CommandCategories.SETTINGS.toString(),Commands_1.Commands.CHANGE_THEME.toString(),""+_this.ThemeManager.Themes[e.Index].Name);var firstLoad=_this.Palette.length===0;_this.Palette=e.Palette,firstLoad&&_this.LoadReady()},this);var themeNo=this.ThemeNo;this.ThemeNo||(themeNo=0),this.ThemeManager.LoadTheme(themeNo,!0)},App.prototype.FontsLoaded=function(font,fvd){this._FontsLoaded+=1,this._FontsLoaded===3&&this.LoadReady()},App.prototype.FontsNotLoaded=function(){this._FontsLoaded!==3&&(console.log("FONTS ARE MISSING"),this._FontsLoaded=3,this.LoadReady())},App.prototype.LoadReady=function(){this._FontsLoaded===3&&this.ThemeManager.Loaded&&this.LoadComposition()},App.prototype.LoadComposition=function(){var _this=this,that=this;this.CompositionId=Utils.Urls.getQuerystringParameter("c"),this.CompositionName=Utils.Urls.getQuerystringParameter("t"),this.CompositionId&&(this.IsLoadingComposition=!0,this.CommandManager.ExecuteCommand(Commands_1.Commands.LOAD,this.CompositionId).then(function(data){that.CompositionLoadComplete(data)}).catch(function(error){that.TrackEvent(CommandCategories_1.CommandCategories.COMPOSITIONS.toString(),Errors_1.Errors.LOAD_FAILED.toString(),that.CompositionId),that.CompositionId=null,_this.IsLoadingComposition=!1,_this.CompositionLoadFailed.raise(_this,new CompositionLoadFailedEventArgs_1.CompositionLoadFailedEventArgs(that.CompositionId))})),this.CreateStage()},App.prototype.CreateStage=function(){this.Stage=new Stage_1.Stage,this.Stage.Init(this.Canvas),this.Stage.Drawn.on(function(s,time){window.TWEEN.update(time)},this),this.Resize()},App.prototype.CompositionLoadComplete=function(data){console.log('Loaded "'+this.CompositionName+'"'),this.Deserialize(data);for(var i=0;i<this.Blocks.length;i++)this.Blocks[i].Duplicable=!0;this.ThemeManager.LoadTheme(this._SaveFile.ColorThemeNo,!1,!0),this.ZoomLevel=this._SaveFile.ZoomLevel,this.Audio.Master.volume.value=-100,this.Audio.ConnectionManager.Update(),this.IsLoadingComposition=!1,this.SkipTutorial||this.MainScene.CreateNew.ShowMessage(),this.CompositionLoaded.raise(this,new CompositionLoadedEventArgs_1.CompositionLoadedEventArgs(this._SaveFile))},App.prototype.Serialize=function(){return Serializer_1.Serializer.Serialize()},App.prototype.Deserialize=function(json){this._SaveFile=Serializer_1.Serializer.Deserialize(json),this.Blocks=this._SaveFile.Composition.en().traverseUnique(function(block){return block.Connections}).toArray(),this.Blocks.sort(function(a,b){return a.ZIndex-b.ZIndex})},App.prototype.Message=function(message,options){this.MainScene&&(this.MainScene.MessagePanel.Show(),this.MainScene.MessagePanel.NewMessage(message,options))},App.prototype.CreateSubCanvas=function(i){this.SubCanvas[i]=document.createElement("canvas"),document.body.appendChild(this.SubCanvas[i])},App.prototype.TrackEvent=function(category,action,label){window.trackEvent(category,action,label)},App.prototype.TrackVariable=function(name,value){window.trackVariable(name,value)},App.prototype.IsLocalhost=function(){return document.location.href.indexOf("localhost")!=-1},App.prototype.Resize=function(){this.Metrics.Compute(),this.Stage.Resize()},App.prototype.FillColor=function(ctx,col){this.ColorManager.FillColor(ctx,col)},App.prototype.FillRGBA=function(ctx,r,g,b,a){this.ColorManager.FillRGBA(ctx,r,g,b,a)},App.prototype.StrokeColor=function(ctx,col){this.ColorManager.StrokeColor(ctx,col)},App.prototype.StrokeRGBA=function(ctx,r,g,b,a){this.ColorManager.StrokeRGBA(ctx,r,g,b,a)},App}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=App}),define("text!config.json",[],function(){return'{\n    "MaxOperations": 1,\n    "PixelPaletteImagePath": [\n        "img/modestereo.gif",\n        "img/palette9.gif",\n        "img/palette10.gif",\n        "img/palette14.gif",\n        "img/palette18.gif",\n        "img/palette25.gif",\n        "img/palette27.gif",\n        "img/riki.gif",\n        "img/palette28.gif",\n        "img/seacucumber.gif",\n        "img/palette29.gif",\n        "img/palette.gif",\n        "img/experiment.gif",\n        "img/experiment2.gif",\n        "img/ikko.gif",\n        "img/ikko2.gif",\n        "img/ikko3.gif",\n        "img/ikko4.gif"\n    ],\n    "SoundCloudClientId": "7258ff07f16ddd167b55b8f9b9a3ed33",\n    "SoundCloudDefaultTracks": [\n        "24456532",\n        "25216773",\n        "5243666",\n        "51167662",\n        "172375224",\n        "43883752"\n    ],\n    "SoundCloudMaxTrackLength": 510,\n    "GranularDefaultTracks": [\n        "257636616",\n        "24456532",\n        "183588346",\n        "48387282",\n        "127905486",\n        "50894420",\n        "76097469",\n        "130501492"\n    ],\n    "GranularMaxTrackLength": 240,\n    "ConvolverDefaultTracks": [],\n    "ConvolverMaxTrackLength": 12,\n    "RecorderWorkerPath": "Assets/Recorder/recorderWorker.js",\n    "PolyphonicVoices": 8,\n    "PulseLength": 150,\n    "BaseNote": 261.6,\n    "DefaultNote": 60,\n    "PlaybackRange": 24,\n    "PitchBendRange": 2,\n    "SoundCloudLoadTimeout": 20,\n    "ResetPitchesOnInteractionDisconnect": true,\n    "ScrollSpeed": 1.5,\n    "ScrollEasing": 25,\n    "SingleClickTime": 140,\n    "StorageTime": 315360000\n}\n'}),define("text!l10n.json",[],function(){return'{\n  "Attribution": {\n    "title": "General",\n    "about": "BlokDust is a collaboration between Luke Twyman, Luke Phillips and Edward Silverton. Developed in Brighton UK and released in 2016, BlokDust uses the Web Audio API and makes use of Tone.js as an audio framework.",\n    "twyman": {\n      "blurb": "Luke Twyman - project concept, design & UI.",\n      "url": "whitevinyldesign.com",\n      "twitter": "@whitevinylUK"\n    },\n    "phillips": {\n      "blurb": "Luke Phillips - audio development & musical interaction.",\n      "url": "femurdesign.com",\n      "twitter": "@lukephills"\n    },\n    "silverton": {\n      "blurb": "Edward Silverton - client & server architecture & core development.",\n      "url": "edsilv.com",\n      "twitter": "@edsilv"\n    },\n    "thanks": "Thanks also to Yotam Mann and Brad Sickles.",\n    "build": "Current Build: {0}"\n  },\n  "Blocks": {\n    "Source": {\n      "Label": "Source",\n      "Blocks": {\n        "Tone": {\n          "name": "Tone",\n          "description": "A single oscillator. Creates a waveform used as the basis of most synths."\n        },\n        "Noise": {\n          "name": "Noise",\n          "description": "A noise generator with \'White\', \'Brown\' and \'Pink\' waveform types."\n        },\n        "Microphone": {\n          "name": "Microphone",\n          "description": "Captures sound from your device\'s microphone input. Connect to a Power source & avoid feedback by using headphones."\n        },\n        "Sample": {\n          "name": "Sample",\n          "description": "A sample player loaded with a Soundcloud track. The track must be creative commons or tagged #blokdust."\n        },\n        "Granular": {\n          "name": "Granular",\n          "description": "It takes a SoundCloud sample of your choice and chops it into tiny pieces which are used as a sound source."\n        },\n        "Recorder": {\n          "name": "Recorder",\n          "description": "It can record the master output and then be used as a sample player."\n        },\n        "SampleGen": {\n          "name": "SampleGen",\n          "description": "Procedurally generates a new audio sample, for creating unique textures or arpeggiated loops."\n        }\n      }\n    },\n    "Effect": {\n      "Label": "Effect",\n      "Blocks": {\n        "AutoWah": {\n          "name": "AutoWah",\n          "description": "Creates a filter sweep in response to the volume of audio input."\n        },\n        "BitCrusher": {\n          "name": "Bit Crusher",\n          "description": "Creates distortion by reducing the audio resolution."\n        },\n        "Chomp": {\n          "name": "Chomp",\n          "description": "A randomised filter with adjustable rate & width."\n        },\n        "Chopper": {\n          "name": "Chopper",\n          "description": "A tremolo effect that modulates the volume with an adjustable rate & depth."\n        },\n        "Chorus": {\n          "name": "Chorus",\n          "description": "Stereo chorus. Creates a delayed & modulated copy of the audio."\n        },\n        "Convolution": {\n          "name": "Convolution",\n          "description": "A convolution reverb which simulates a physical space by using a recorded sample."\n        },\n        "StereoDelay": {\n          "name": "Stereo Delay",\n          "description": "A stereo delay/echo with adjustable time & feedback."\n        },\n        "Distortion": {\n          "name": "Distortion",\n          "description": "A digital clipping distortion."\n        },\n        "Envelope": {\n          "name": "Envelope",\n          "description": "An ADSR envelope which alters the volume of sound over time."\n        },\n        "Eq": {\n          "name": "EQ",\n          "description": "A \'parametric\' EQ with 4 filters."\n        },\n        "Filter": {\n          "name": "Filter",\n          "description": "A \'peaking\' filter used for boosting or suppressing frequencies."\n        },\n        "Vibrato": {\n          "name": "Vibrato",\n          "description": "An oscillation effect that modulates pitch and playback rate."\n        },\n        "Phaser": {\n          "name": "Phaser",\n          "description": "A modulating phaser effect that sweeps through a spectrum of sound frequencies."\n        },\n        "PitchShifter": {\n          "name": "Pitch Shifter",\n          "description": "Shifts the pitch of any sound."\n        },\n        "Reverb": {\n          "name": "Reverb",\n          "description": "A digital reverb with adjustable room size and dampening."\n        },\n        "Scuzz": {\n          "name": "Scuzz",\n          "description": "Frequency modulation (FM) synthesis style effect that can create harmonic and overtone signals."\n        },\n        "Volume": {\n          "name": "Volume",\n          "description": "Increase or decrease the volume."\n        }\n      }\n    },\n    "Power": {\n      "Label": "Power",\n      "Blocks": {\n        "ParticleEmitter": {\n          "name": "Particle Emitter",\n          "description": "Fires energy particles. When a particle hits a source block, that source is momentarily triggered."\n        },\n        "Power": {\n          "name": "Power",\n          "description": "Provides energy for sources, particle emitters & lasers. This allows them to be constantly on."\n        },\n        "TogglePower": {\n          "name": "Toggle Power",\n          "description": "When \'on\', provides energy for sources, particle emitters & lasers."\n        },\n        "Void": {\n          "name": "Void",\n          "description": "Absorbs any laser beams or particles that collide with it."\n        },\n        "PulsePower": {\n          "name": "Pulse Power",\n          "description": "Provides a short fire of energy for sources, particle emitters & lasers."\n        },\n        "Laser": {\n          "name": "Laser",\n          "description": "A laser beam that gives energy to sources, particle emitters & other lasers in its path."\n        }\n      }\n    },\n    "Interaction": {\n      "Label": "Interaction",\n      "Blocks": {\n        "ComputerKeyboard": {\n          "name": "Computer Keyboard",\n          "description": "Trigger sources using your computer keys arranged into a 2 1/2 octave piano."\n        },\n        "MIDIController": {\n          "name": "MIDI Controller",\n          "description": "Trigger sources using any connected USB MIDI device. Chrome only"\n        }\n      }\n    }\n  },\n  "Errors": {\n    "LoadError": "Composition failed to load.",\n    "SaveError": "Save failed, please try again.",\n    "SoundCloud": {\n      "FailedTrackFiltering": "Tracks were found, but cannot be used. Make sure the track you\'re searching for is streamable for public use and is either tagged \'blokdust\' or has a creative commons license.",\n      "InternalServerError": "Error: Something went wrong with SoundCloud\'s servers.",\n      "ServiceUnavailable": "SoundCloud\'s servers were too busy. Please try again.",\n      "TooManyRequests":"Error: Too many requests. SoundCloud\'s 15,000 limit has been reached. Try again tomorrow",\n      "Uninitialized": "SoundCloud API isn\'t connected. Check your internet connection, save & refresh the page.",\n      "Unknown": "Something went wrong with SoundCloud. Check console for errors."\n    }\n  },\n\n  "UI": {\n\n    "CreateNew": {\n      "Verify": "Clear the Stage?",\n      "NewMessage": "Begin your own BlokDust creation"\n    },\n\n    "SharePanel": {\n      "SaveWarning": "Note: Recorder block samples will not be saved. If you want to share what you\'ve recorded, download the recording from the block\'s options panel, upload it to SoundCloud, and load it back into BlokDust using a Sample block.",\n      "NoBlocks": "Create some blocks before you can save & share!"\n    },\n\n    "Tutorial": {\n      "Scenes": [\n\n        {\n          "Intro": "Let\'s get started by adding some blocks. You can create blocks by dragging them from the top menu.",\n          "Task": "Open up the SOURCE category, and drag a TONE block from it."\n        },\n\n        {\n          "Intro": "SOURCE blocks generate sound, and you can connect EFFECT & INTERACTION blocks to them.",\n          "Task": "From the INTERACTION category, create a COMPUTER KEYBOARD block. Connect it to your TONE block by simply dragging it nearby until a connection line appears."\n        },\n\n        {\n          "Intro": "Youâve just made a basic interactive synth! Now you can play your TONE block using your computer keyboard  - give it a go.",\n          "Task": "Let\'s make it a bit more interesting, add a CHOPPER block from the EFFECT category and connect it."\n        },\n\n        {\n          "Intro": "You can single-click a block to open up the options panel and adjust itâs settings to your liking.",\n          "Task": "Click on the CHOPPER block and have a play with its settings. Close the options panel when you\'re done."\n        },\n\n        {\n          "Intro": "Finally letâs look at POWER. We wonât need that COMPUTER KEYBOARD block you made for this.",\n          "Task": "Delete the COMPUTER KEYBOARD block by dragging it into the trashcan, bottom-right of the screen."\n        },\n\n        {\n          "Intro": "Blocks from the POWER category allow you to come up with different ways of triggering sounds.",\n          "Task": "From the POWER category, create a PARTICLE EMITTER block and place it on the marker below your TONE block."\n        },\n\n        {\n          "Intro": "When powered, the PARTICLE EMITTER will fire energy particles at the TONE block, triggering sound as they hit.",\n          "Task": "From the POWER category again, create a POWER block and connect it to your PARTICLE EMITTER block."\n        },\n\n        {\n          "Intro": "Explore and experiment for yourself, or visit the BlokDust Guide for an in-depth Wiki and more tutorials. When youâve made something cool, click SHARE to generate a unique URL to let others see what youâve made!",\n          "Task": ""\n        }\n\n      ],\n\n      "SkipButton": "Skip Tour",\n      "DoneButton": "Okay Done",\n      "TourComplete": "Tour Complete",\n      "Splash1": {\n        "Message": "Welcome to BlokDust.",\n        "Y": "Take the Tour",\n        "N": "Skip for Now"\n      },\n      "Splash2": {\n        "Message": "Welcome to the Tour.",\n        "Y": "Clear the Stage",\n        "N": "Skip for Now"\n      }\n    },\n\n    "TutorialTouch": {\n      "Scenes": [\n\n        {\n          "Intro": "Let\'s get started by adding some blocks. You can create blocks by dragging them from the top menu.",\n          "Task": "Open up the SOURCE category, and drag a TONE block from it."\n        },\n\n        {\n          "Intro": "SOURCE blocks generate sound, and you can trigger them using POWER & INTERACTION blocks.",\n          "Task": "From the POWER category, create a PARTICLE EMITTER block and place it on the marker below your TONE block."\n        },\n\n        {\n          "Intro": "When powered, the PARTICLE EMITTER will fire energy particles at the TONE block, triggering sound as they hit.",\n          "Task": "From the POWER category again, create a POWER block and connect it to your PARTICLE EMITTER block by simply dragging it nearby until a connection line appears."\n        },\n\n        {\n          "Intro": "Great, now we\'re making some sound, but let\'s make it a bit more interesting.",\n          "Task": "From the EFFECT category, create a CHOPPER block and connect it to your TONE block."\n        },\n\n        {\n          "Intro": "You can single-click a block to open up the options panel and adjust its settings to your liking.",\n          "Task": "Click on the CHOPPER block and have a play with its settings. Close the options panel when you\'re done."\n        },\n\n        {\n          "Intro": "Explore and experiment for yourself, or visit the BlokDust Guide for an in-depth Wiki and more tutorials. When youâve made something cool, click SHARE to generate a unique URL to let others see what youâve made!",\n          "Task": ""\n        }\n\n      ],\n\n      "SkipButton": "Skip Tour",\n      "DoneButton": "Okay Done",\n      "TourComplete": "Tour Complete",\n      "Splash1": {\n        "Message": "Welcome to BlokDust.",\n        "Y": "Take the Tour",\n        "N": "Skip for Now"\n      },\n      "Splash2": {\n        "Message": "Welcome to the Tour.",\n        "Y": "Clear the Stage",\n        "N": "Skip for Now"\n      }\n    }\n  }\n}\n'}),function(global){function PxLoader(settings){settings=settings||{},this.settings=settings,settings.statusInterval==null&&(settings.statusInterval=5e3),settings.loggingDelay==null&&(settings.loggingDelay=2e4),settings.noProgressTimeout==null&&(settings.noProgressTimeout=Infinity);var entries=[],progressListeners=[],timeStarted,progressChanged=Date.now(),ResourceState={QUEUED:0,WAITING:1,LOADED:2,ERROR:3,TIMEOUT:4},ensureArray=function(val){return val==null?[]:Array.isArray(val)?val:[val]};this.add=function(resource){resource.tags=new PxLoaderTags(resource.tags),resource.priority==null&&(resource.priority=Infinity),entries.push({resource:resource,status:ResourceState.QUEUED})},this.addProgressListener=function(callback,tags){progressListeners.push({callback:callback,tags:new PxLoaderTags(tags)})},this.addCompletionListener=function(callback,tags){progressListeners.push({tags:new PxLoaderTags(tags),callback:function(e){e.completedCount===e.totalCount&&callback(e)}})};var getResourceSort=function(orderedTags){orderedTags=ensureArray(orderedTags);var getTagOrder=function(entry){var resource=entry.resource,bestIndex=Infinity;for(var i=0;i<resource.tags.length;i++)for(var j=0;j<Math.min(orderedTags.length,bestIndex);j++){if(resource.tags.all[i]===orderedTags[j]&&j<bestIndex){bestIndex=j;if(bestIndex===0)break}if(bestIndex===0)break}return bestIndex};return function(a,b){var aOrder=getTagOrder(a),bOrder=getTagOrder(b);return aOrder<bOrder?-1:aOrder>bOrder?1:a.priority<b.priority?-1:a.priority>b.priority?1:0}};this.start=function(orderedTags){timeStarted=Date.now();var compareResources=getResourceSort(orderedTags);entries.sort(compareResources);for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];entry.status=ResourceState.WAITING,entry.resource.start(this)}setTimeout(statusCheck,100)};var statusCheck=function(){var checkAgain=!1,noProgressTime=Date.now()-progressChanged,timedOut=noProgressTime>=settings.noProgressTimeout,shouldLog=noProgressTime>=settings.loggingDelay;for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];if(entry.status!==ResourceState.WAITING)continue;entry.resource.checkStatus&&entry.resource.checkStatus(),entry.status===ResourceState.WAITING&&(timedOut?entry.resource.onTimeout():checkAgain=!0)}shouldLog&&checkAgain&&log(),checkAgain&&setTimeout(statusCheck,settings.statusInterval)};this.isBusy=function(){for(var i=0,len=entries.length;i<len;i++)if(entries[i].status===ResourceState.QUEUED||entries[i].status===ResourceState.WAITING)return!0;return!1};var onProgress=function(resource,statusType){var entry=null,i,len,numResourceTags,listener,shouldCall;for(i=0,len=entries.length;i<len;i++)if(entries[i].resource===resource){entry=entries[i];break}if(entry==null||entry.status!==ResourceState.WAITING)return;entry.status=statusType,progressChanged=Date.now(),numResourceTags=resource.tags.length;for(i=0,len=progressListeners.length;i<len;i++)listener=progressListeners[i],listener.tags.length===0?shouldCall=!0:shouldCall=resource.tags.intersects(listener.tags),shouldCall&&sendProgress(entry,listener)};this.onLoad=function(resource){onProgress(resource,ResourceState.LOADED)},this.onError=function(resource){onProgress(resource,ResourceState.ERROR)},this.onTimeout=function(resource){onProgress(resource,ResourceState.TIMEOUT)};var sendProgress=function(updatedEntry,listener){var completed=0,total=0,i,len,entry,includeResource;for(i=0,len=entries.length;i<len;i++)entry=entries[i],includeResource=!1,listener.tags.length===0?includeResource=!0:includeResource=entry.resource.tags.intersects(listener.tags),includeResource&&(total++,(entry.status===ResourceState.LOADED||entry.status===ResourceState.ERROR||entry.status===ResourceState.TIMEOUT)&&completed++);listener.callback({resource:updatedEntry.resource,loaded:updatedEntry.status===ResourceState.LOADED,error:updatedEntry.status===ResourceState.ERROR,timeout:updatedEntry.status===ResourceState.TIMEOUT,completedCount:completed,totalCount:total})},log=this.log=function(showAll){if(!window.console)return;var elapsedSeconds=Math.round((Date.now()-timeStarted)/1e3);window.console.log("PxLoader elapsed: "+elapsedSeconds+" sec");for(var i=0,len=entries.length;i<len;i++){var entry=entries[i];if(!showAll&&entry.status!==ResourceState.WAITING)continue;var message="PxLoader: #"+i+" "+entry.resource.getName();switch(entry.status){case ResourceState.QUEUED:message+=" (Not Started)";break;case ResourceState.WAITING:message+=" (Waiting)";break;case ResourceState.LOADED:message+=" (Loaded)";break;case ResourceState.ERROR:message+=" (Error)";break;case ResourceState.TIMEOUT:message+=" (Timeout)"}entry.resource.tags.length>0&&(message+=" Tags: ["+entry.resource.tags.all.join(",")+"]"),window.console.log(message)}}}function PxLoaderTags(values){this.all=[],this.first=null,this.length=0,this.lookup={};if(values){if(Array.isArray(values))this.all=values.slice(0);else if(typeof values=="object")for(var key in values)values.hasOwnProperty(key)&&this.all.push(key);else this.all.push(values);this.length=this.all.length,this.length>0&&(this.first=this.all[0]);for(var i=0;i<this.length;i++)this.lookup[this.all[i]]=!0}}PxLoaderTags.prototype.intersects=function(other){if(this.length===0||other.length===0)return!1;if(this.length===1&&other.length===1)return this.first===other.first;if(other.length<this.length)return other.intersects(this);for(var key in this.lookup)if(other.lookup[key])return!0;return!1},typeof define=="function"&&define.amd&&define("PxLoader",[],function(){return PxLoader}),global.PxLoader=PxLoader}(this),Date.now||(Date.now=function now(){return(new Date).getTime()}),Array.isArray||(Array.isArray=function(arg){return Object.prototype.toString.call(arg)==="[object Array]"});function PxLoaderImage(url,tags,priority){var self=this,loader=null;this.img=new Image,this.tags=tags,this.priority=priority;var onReadyStateChange=function(){self.img.readyState==="complete"&&(removeEventHandlers(),loader.onLoad(self))},onLoad=function(){removeEventHandlers(),loader.onLoad(self)},onError=function(){removeEventHandlers(),loader.onError(self)},removeEventHandlers=function(){self.unbind("load",onLoad),self.unbind("readystatechange",onReadyStateChange),self.unbind("error",onError)};this.start=function(pxLoader){loader=pxLoader,self.bind("load",onLoad),self.bind("readystatechange",onReadyStateChange),self.bind("error",onError),self.img.src=url},this.checkStatus=function(){self.img.complete&&(removeEventHandlers(),loader.onLoad(self))},this.onTimeout=function(){removeEventHandlers(),self.img.complete?loader.onLoad(self):loader.onTimeout(self)},this.getName=function(){return url},this.bind=function(eventName,eventHandler){self.img.addEventListener?self.img.addEventListener(eventName,eventHandler,!1):self.img.attachEvent&&self.img.attachEvent("on"+eventName,eventHandler)},this.unbind=function(eventName,eventHandler){self.img.removeEventListener?self.img.removeEventListener(eventName,eventHandler,!1):self.img.detachEvent&&self.img.detachEvent("on"+eventName,eventHandler)}}PxLoader.prototype.addImage=function(url,tags,priority){var imageLoader=new PxLoaderImage(url,tags,priority);return this.add(imageLoader),imageLoader.img},typeof define=="function"&&define.amd&&define("PxLoaderImage",[],function(){return PxLoaderImage}),!function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define("PixelPalette",e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.PixelPalette=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){function RGBA(r,g,b,a){this.R=r,this.G=g,this.B=b,this.A=a,this.toString=function(){return"rgba("+r+","+g+","+b+","+a+")"},this.clone=function(){return new RGBA(r,g,b,a)}}var PixelPalette=function(){function PixelPalette(imgPath){this.imgPath=imgPath}return PixelPalette.prototype.Load=function(cb){var loader=new PxLoader,img=loader.addImage(this.imgPath),canvas=document.createElement("canvas"),context=canvas.getContext("2d");loader.addCompletionListener(function(){var len=img.width;context.drawImage(img,0,0,len,1);var imgd=context.getImageData(0,0,len,1),pal=imgd.data,palette=[];for(var i=0;i<len*4;i+=4)palette[i/4]=new RGBA(pal[i],pal[i+1],pal[i+2],pal[i+3]);cb(palette)}),loader.start()},PixelPalette}();module.exports=PixelPalette},{}]},{},[1])(1)}),define("Tone/core/Tone",[],function(){"use strict";function isUndef(val){return val===void 0}function isFunction(val){return typeof val=="function"}var audioContext;isUndef(window.AudioContext)&&(window.AudioContext=window.webkitAudioContext),isUndef(window.OfflineAudioContext)&&(window.OfflineAudioContext=window.webkitOfflineAudioContext);if(!isUndef(AudioContext)){audioContext=new AudioContext,isFunction(AudioContext.prototype.createGain)||(AudioContext.prototype.createGain=AudioContext.prototype.createGainNode),isFunction(AudioContext.prototype.createDelay)||(AudioContext.prototype.createDelay=AudioContext.prototype.createDelayNode),isFunction(AudioContext.prototype.createPeriodicWave)||(AudioContext.prototype.createPeriodicWave=AudioContext.prototype.createWaveTable),isFunction(AudioBufferSourceNode.prototype.start)||(AudioBufferSourceNode.prototype.start=AudioBufferSourceNode.prototype.noteGrainOn),isFunction(AudioBufferSourceNode.prototype.stop)||(AudioBufferSourceNode.prototype.stop=AudioBufferSourceNode.prototype.noteOff),isFunction(AudioBuffer.prototype.copyToChannel)||(AudioBuffer.prototype.copyToChannel=function(source,channelNumber,startInChannel){var clipped=source.subarray(0,Math.min(source.length,this.length-(startInChannel|0)));this.getChannelData(channelNumber|0).set(clipped,startInChannel|0)}),isFunction(OscillatorNode.prototype.start)||(OscillatorNode.prototype.start=OscillatorNode.prototype.noteOn),isFunction(OscillatorNode.prototype.stop)||(OscillatorNode.prototype.stop=OscillatorNode.prototype.noteOff),isFunction(OscillatorNode.prototype.setPeriodicWave)||(OscillatorNode.prototype.setPeriodicWave=OscillatorNode.prototype.setWaveTable),AudioNode.prototype._nativeConnect=AudioNode.prototype.connect,AudioNode.prototype.connect=function(B,outNum,inNum){if(B.input)Array.isArray(B.input)?(isUndef(inNum)&&(inNum=0),this.connect(B.input[inNum])):this.connect(B.input,outNum,inNum);else try{B instanceof AudioNode?this._nativeConnect(B,outNum,inNum):this._nativeConnect(B,outNum)}catch(e){throw new Error("error connecting to node: "+B)}};var Tone=function(inputs,outputs){isUndef(inputs)||inputs===1?this.input=this.context.createGain():inputs>1&&(this.input=new Array(inputs)),isUndef(outputs)||outputs===1?this.output=this.context.createGain():outputs>1&&(this.output=new Array(inputs))};Tone.prototype.set=function(params,value,rampTime){if(this.isObject(params))rampTime=value;else if(this.isString(params)){var tmpObj={};tmpObj[params]=value,params=tmpObj}for(var attr in params){value=params[attr];var parent=this;if(attr.indexOf(".")!==-1){var attrSplit=attr.split(".");for(var i=0;i<attrSplit.length-1;i++)parent=parent[attrSplit[i]];attr=attrSplit[attrSplit.length-1]}var param=parent[attr];if(isUndef(param))continue;Tone.Signal&&param instanceof Tone.Signal||Tone.Param&&param instanceof Tone.Param?param.value!==value&&(isUndef(rampTime)?param.value=value:param.rampTo(value,rampTime)):param instanceof AudioParam?param.value!==value&&(param.value=value):param instanceof Tone?param.set(value):param!==value&&(parent[attr]=value)}return this},Tone.prototype.get=function(params){isUndef(params)?params=this._collectDefaults(this.constructor):this.isString(params)&&(params=[params]);var ret={};for(var i=0;i<params.length;i++){var attr=params[i],parent=this,subRet=ret;if(attr.indexOf(".")!==-1){var attrSplit=attr.split(".");for(var j=0;j<attrSplit.length-1;j++){var subAttr=attrSplit[j];subRet[subAttr]=subRet[subAttr]||{},subRet=subRet[subAttr],parent=parent[subAttr]}attr=attrSplit[attrSplit.length-1]}var param=parent[attr];this.isObject(params[attr])?subRet[attr]=param.get():Tone.Signal&&param instanceof Tone.Signal?subRet[attr]=param.value:Tone.Param&&param instanceof Tone.Param?subRet[attr]=param.value:param instanceof AudioParam?subRet[attr]=param.value:param instanceof Tone?subRet[attr]=param.get():!isFunction(param)&&!isUndef(param)&&(subRet[attr]=param)}return ret},Tone.prototype._collectDefaults=function(constr){var ret=[];isUndef(constr.defaults)||(ret=Object.keys(constr.defaults));if(!isUndef(constr._super)){var superDefs=this._collectDefaults(constr._super);for(var i=0;i<superDefs.length;i++)ret.indexOf(superDefs[i])===-1&&ret.push(superDefs[i])}return ret},Tone.prototype.toString=function(){for(var className in Tone){var isLetter=className[0].match(/^[A-Z]$/),sameConstructor=Tone[className]===this.constructor;if(isFunction(Tone[className])&&isLetter&&sameConstructor)return className}return"Tone"},Tone.context=audioContext,Tone.prototype.context=Tone.context,Tone.prototype.bufferSize=2048,Tone.prototype.blockTime=128/Tone.context.sampleRate,Tone.prototype.dispose=function(){return this.isUndef(this.input)||(this.input instanceof AudioNode&&this.input.disconnect(),this.input=null),this.isUndef(this.output)||(this.output instanceof AudioNode&&this.output.disconnect(),this.output=null),this};var _silentNode=null;Tone.prototype.noGC=function(){return this.output.connect(_silentNode),this},AudioNode.prototype.noGC=function(){return this.connect(_silentNode),this},Tone.prototype.connect=function(unit,outputNum,inputNum){return Array.isArray(this.output)?(outputNum=this.defaultArg(outputNum,0),this.output[outputNum].connect(unit,0,inputNum)):this.output.connect(unit,outputNum,inputNum),this},Tone.prototype.disconnect=function(outputNum){return Array.isArray(this.output)?(outputNum=this.defaultArg(outputNum,0),this.output[outputNum].disconnect()):this.output.disconnect(),this},Tone.prototype.connectSeries=function(){if(arguments.length>1){var currentUnit=arguments[0];for(var i=1;i<arguments.length;i++){var toUnit=arguments[i];currentUnit.connect(toUnit),currentUnit=toUnit}}return this},Tone.prototype.connectParallel=function(){var connectFrom=arguments[0];if(arguments.length>1)for(var i=1;i<arguments.length;i++){var connectTo=arguments[i];connectFrom.connect(connectTo)}return this},Tone.prototype.chain=function(){if(arguments.length>0){var currentUnit=this;for(var i=0;i<arguments.length;i++){var toUnit=arguments[i];currentUnit.connect(toUnit),currentUnit=toUnit}}return this},Tone.prototype.fan=function(){if(arguments.length>0)for(var i=0;i<arguments.length;i++)this.connect(arguments[i]);return this},AudioNode.prototype.chain=Tone.prototype.chain,AudioNode.prototype.fan=Tone.prototype.fan,Tone.prototype.defaultArg=function(given,fallback){if(this.isObject(given)&&this.isObject(fallback)){var ret={};for(var givenProp in given)ret[givenProp]=this.defaultArg(fallback[givenProp],given[givenProp]);for(var fallbackProp in fallback)ret[fallbackProp]=this.defaultArg(given[fallbackProp],fallback[fallbackProp]);return ret}return isUndef(given)?fallback:given},Tone.prototype.optionsObject=function(values,keys,defaults){var options={};if(values.length===1&&this.isObject(values[0]))options=values[0];else for(var i=0;i<keys.length;i++)options[keys[i]]=values[i];return this.isUndef(defaults)?options:this.defaultArg(options,defaults)},Tone.prototype.isUndef=isUndef,Tone.prototype.isFunction=isFunction,Tone.prototype.isNumber=function(arg){return typeof arg=="number"},Tone.prototype.isObject=function(arg){return Object.prototype.toString.call(arg)==="[object Object]"&&arg.constructor===Object},Tone.prototype.isBoolean=function(arg){return typeof arg=="boolean"},Tone.prototype.isArray=function(arg){return Array.isArray(arg)},Tone.prototype.isString=function(arg){return typeof arg=="string"},Tone.noOp=function(){},Tone.prototype._readOnly=function(property){if(Array.isArray(property))for(var i=0;i<property.length;i++)this._readOnly(property[i]);else Object.defineProperty(this,property,{writable:!1,enumerable:!0})},Tone.prototype._writable=function(property){if(Array.isArray(property))for(var i=0;i<property.length;i++)this._writable(property[i]);else Object.defineProperty(this,property,{writable:!0})},Tone.State={Started:"started",Stopped:"stopped",Paused:"paused"},Tone.prototype.equalPowerScale=function(percent){var piFactor=.5*Math.PI;return Math.sin(percent*piFactor)},Tone.prototype.dbToGain=function(db){return Math.pow(2,db/6)},Tone.prototype.gainToDb=function(gain){return 20*(Math.log(gain)/Math.LN10)},Tone.prototype.now=function(){return this.context.currentTime},Tone.extend=function(child,parent){isUndef(parent)&&(parent=Tone);function TempConstructor(){}TempConstructor.prototype=parent.prototype,child.prototype=new TempConstructor,child.prototype.constructor=child,child._super=parent};var newContextCallbacks=[];return Tone._initAudioContext=function(callback){callback(Tone.context),newContextCallbacks.push(callback)},Tone.setContext=function(ctx){Tone.prototype.context=ctx,Tone.context=ctx;for(var i=0;i<newContextCallbacks.length;i++)newContextCallbacks[i](ctx)},Tone.startMobile=function(){var osc=Tone.context.createOscillator(),silent=Tone.context.createGain();silent.gain.value=0,osc.connect(silent),silent.connect(Tone.context.destination);var now=Tone.context.currentTime;osc.start(now),osc.stop(now+1)},Tone.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,Tone._initAudioContext(function(audioContext){Tone.prototype.blockTime=128/audioContext.sampleRate,_silentNode=audioContext.createGain(),_silentNode.gain.value=0,_silentNode.connect(audioContext.destination)}),Tone.version="r6",console.log("%c * Tone.js "+Tone.version+" * ","background: #000; color: #fff"),Tone}throw new Error("Web Audio is not supported in this browser")});var exjs;(function(exjs){exjs.version="0.4.0"})(exjs||(exjs={}));var exjs;(function(exjs){Array.isArray||(Array.isArray=function(arg){return Object.prototype.toString.call(arg)==="[object Array]"})})(exjs||(exjs={}));var exjs;(function(exjs){var Enumerable=function(){function Enumerable(){}return Enumerable.prototype.getEnumerator=function(){return{moveNext:function(){return!1},current:undefined}},Enumerable.prototype.aggregate=function(seed,accumulator){var active=seed;for(var enumerator=this.getEnumerator();enumerator.moveNext();)active=accumulator(active,enumerator.current);return active},Enumerable.prototype.all=function(predicate){if(predicate){var e=this.getEnumerator(),i=0;while(e.moveNext()){if(!predicate(e.current,i))return!1;i++}}return!0},Enumerable.prototype.any=function(predicate){var e=this.getEnumerator(),i=0;while(e.moveNext()){if(!predicate)return!0;if(predicate(e.current,i))return!0;i++}return!1},Enumerable.prototype.append=function(){var items=[];for(var _i=0;_i<arguments.length;_i++)items[_i-0]=arguments[_i];throw new Error("Not implemented")},Enumerable.prototype.apply=function(action){throw new Error("Not implemented")},Enumerable.prototype.at=function(index){var e=this.getEnumerator(),i=0;while(e.moveNext()){if(i===index)return e.current;i++}return undefined},Enumerable.prototype.average=function(selector){var count=0,total=0;selector=selector||function(t){if(typeof t!="number")throw new Error("Object is not a number.");return t};var e=this.getEnumerator();while(e.moveNext())total+=selector(e.current),count++;return count===0?0:total/count},Enumerable.prototype.concat=function(second){throw new Error("Not implemented")},Enumerable.prototype.count=function(predicate){var count=0,e=this.getEnumerator();while(e.moveNext())(!predicate||predicate(e.current))&&count++;return count},Enumerable.prototype.difference=function(second,comparer){return comparer=comparer||function(f2,s2){return f2===s2},second instanceof Array&&(second=second.en()),{intersection:this.intersect(second,comparer).toArray().en(),aNotB:this.except(second,comparer).toArray().en(),bNotA:second.except(this,comparer).toArray().en()}},Enumerable.prototype.distinct=function(comparer){throw new Error("Not implemented")},Enumerable.prototype.except=function(second,comparer){throw new Error("Not implemented")},Enumerable.prototype.first=function(match){var e=this.getEnumerator();while(e.moveNext())if(!match||match(e.current))return e.current;return undefined},Enumerable.prototype.firstIndex=function(match){for(var e=this.getEnumerator(),i=0;e.moveNext();i++)if(!match||match(e.current))return i;return-1},Enumerable.prototype.forEach=function(action){for(var en=this.getEnumerator();en.moveNext();)action(en.current)},Enumerable.prototype.groupBy=function(keySelector,comparer){throw new Error("Not implemented")},Enumerable.prototype.intersect=function(second,comparer){throw new Error("Not implemented")},Enumerable.prototype.join=function(inner,outerKeySelector,innerKeySelector,resultSelector,comparer){throw new Error("Not implemented")},Enumerable.prototype.last=function(match){var e=this.getEnumerator(),l;while(e.moveNext())if(!match||match(e.current))l=e.current;return l},Enumerable.prototype.lastIndex=function(match){var j=-1;for(var e=this.getEnumerator(),i=0;e.moveNext();i++)if(!match||match(e.current))j=i;return j},Enumerable.prototype.max=function(selector){var e=this.getEnumerator();if(!e.moveNext())return 0;selector=selector||function(t){if(typeof t!="number")throw new Error("Object is not a number.");return t};var max=selector(e.current);while(e.moveNext())max=Math.max(max,selector(e.current));return max},Enumerable.prototype.min=function(selector){var e=this.getEnumerator();if(!e.moveNext())return 0;selector=selector||function(t){if(typeof t!="number")throw new Error("Object is not a number.");return t};var min=selector(e.current);while(e.moveNext())min=Math.min(min,selector(e.current));return min},Enumerable.prototype.orderBy=function(keySelector,comparer){throw new Error("Not implemented")},Enumerable.prototype.orderByDescending=function(keySelector,comparer){throw new Error("Not implemented")},Enumerable.prototype.prepend=function(){var items=[];for(var _i=0;_i<arguments.length;_i++)items[_i-0]=arguments[_i];throw new Error("Not implemented")},Enumerable.prototype.reverse=function(){throw new Error("Not implemented")},Enumerable.prototype.select=function(selector){throw new Error("Not implemented")},Enumerable.prototype.selectMany=function(selector){throw new Error("Not implemented")},Enumerable.prototype.skip=function(count){throw new Error("Not implemented")},Enumerable.prototype.skipWhile=function(predicate){throw new Error("Not implemented")},Enumerable.prototype.standardDeviation=function(selector){var avg=this.average(selector),sum=0,count=0;selector=selector||function(t){if(typeof t!="number")throw new Error("Object is not a number.");return t};var e=this.getEnumerator();while(e.moveNext()){var diff=selector(e.current)-avg;sum+=diff*diff,count++}return Math.sqrt(sum/count)},Enumerable.prototype.sum=function(selector){var sum=0;selector=selector||function(t){if(typeof t!="number")throw new Error("Object is not a number.");return t};var e=this.getEnumerator();while(e.moveNext())sum+=selector(e.current);return sum},Enumerable.prototype.take=function(count){throw new Error("Not implemented")},Enumerable.prototype.takeWhile=function(predicate){throw new Error("Not implemented")},Enumerable.prototype.traverse=function(selector){throw new Error("Not implemented")},Enumerable.prototype.traverseUnique=function(selector,matcher){throw new Error("Not implemented")},Enumerable.prototype.toArray=function(){var arr=[],enumerator=this.getEnumerator();while(enumerator.moveNext())arr.push(enumerator.current);return arr},Enumerable.prototype.toMap=function(keySelector,valueSelector){throw new Error("Not implemented")},Enumerable.prototype.toList=function(){throw new Error("Not implemented")},Enumerable.prototype.union=function(second,comparer){throw new Error("Not implemented")},Enumerable.prototype.where=function(filter){throw new Error("Not implemented")},Enumerable.prototype.zip=function(second,resultSelector){throw new Error("Not implemented")},Enumerable}();exjs.Enumerable=Enumerable})(exjs||(exjs={}));var Symbol,exjs;(function(exjs){Symbol&&Symbol.iterator&&(exjs.Enumerable.prototype[Symbol.iterator]=function(){return iteratorFromEnumerable(this)});function iteratorFromEnumerable(enu){var en;return{next:function(){var res={done:!0,value:undefined};return enu?(en=en||enu.getEnumerator(),en?(res.done=!en.moveNext(),res.value=en.current,res):res):res}}}})(exjs||(exjs={}));var exjs;(function(exjs){var Map=function(){function Map(enumerable){this._keys=[],this._values=[];var enu;enumerable instanceof Array?enu=enumerable.en():enumerable&&enumerable.getEnumerator instanceof Function&&(enu=enumerable);if(!enu)return;for(var en=enu.getEnumerator();en&&en.moveNext();)this.set(en.current[0],en.current[1])}return Object.defineProperty(Map.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Map.prototype.clear=function(){this._keys.length=0,this._values.length=0},Map.prototype.delete=function(key){var index=this._keys.indexOf(key);return index>-1?(this._keys.splice(index,1),this._values.splice(index,1),!0):!1},Map.prototype.entries=function(){var _this=this;return exjs.range(0,this.size).select(function(i){return[_this._keys[i],_this._values[i]]})},Map.prototype.forEach=function(callbackFn,thisArg){thisArg==null&&(thisArg=this);for(var i=0,keys=this._keys,vals=this._values,len=keys.length;i<len;i++)callbackFn.call(thisArg,vals[i],keys[i],this)},Map.prototype.get=function(key){var index=this._keys.indexOf(key);return this._values[index]},Map.prototype.has=function(key){return this._keys.indexOf(key)>-1},Map.prototype.keys=function(){return this._keys.en()},Map.prototype.set=function(key,value){var index=this._keys.indexOf(key);return index>-1?this._values[index]=value:(this._keys.push(key),this._values.push(value)),undefined},Map.prototype.values=function(){return this._values.en()},Map}();exjs.Map=Map,exjs.Enumerable.prototype.toMap=function(keySelector,valueSelector){var m=new Map;for(var en=this.getEnumerator();en.moveNext();)m.set(keySelector(en.current),valueSelector(en.current));return m},exjs.List&&(exjs.List.prototype.toMap=exjs.Enumerable.prototype.toMap)})(exjs||(exjs={})),function(_global){_global.Map||(_global.Map=exjs.Map)}(typeof window=="undefined"?global:window);var exjs;(function(exjs){function anonymous(iterator){var enumerable=new exjs.Enumerable;return enumerable.getEnumerator=function(){var enumerator={current:undefined,moveNext:function(){return iterator(enumerator)}};return enumerator},enumerable}exjs.anonymous=anonymous})(exjs||(exjs={}));var exjs;(function(exjs){function appendEnumerator(prev,items){var stage=1,firstit,secondit,e={current:undefined,moveNext:function(){if(stage<2){firstit=firstit||prev.getEnumerator();if(firstit.moveNext())return e.current=firstit.current,!0;stage++}return secondit=secondit||items.en().getEnumerator(),secondit.moveNext()?(e.current=secondit.current,!0):(e.current=undefined,!1)}};return e}exjs.Enumerable.prototype.append=function(){var _this=this,items=[];for(var _i=0;_i<arguments.length;_i++)items[_i-0]=arguments[_i];var e=new exjs.Enumerable;return e.getEnumerator=function(){return appendEnumerator(_this,items)},e},exjs.List&&(exjs.List.prototype.append=exjs.Enumerable.prototype.append)})(exjs||(exjs={}));var exjs;(function(exjs){function applyEnumerator(prev,action){var t,i=0,e={current:undefined,moveNext:function(){return t||(t=prev.getEnumerator()),t.moveNext()?(action(e.current=t.current,i),i++,!0):!1}};return e}exjs.Enumerable.prototype.apply=function(action){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return applyEnumerator(_this,action)},e},exjs.List&&(exjs.List.prototype.apply=exjs.Enumerable.prototype.apply)})(exjs||(exjs={}));var __extends=this&&this.__extends||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p]);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)},exjs;(function(exjs){function arrayEnumerator(arr){var len=arr.length,e={moveNext:undefined,current:undefined},index=-1;return e.moveNext=function(){return index++,index>=len?(e.current=undefined,!1):(e.current=arr[index],!0)},e}var ArrayEnumerable=function(_super){__extends(ArrayEnumerable,_super);function ArrayEnumerable(arr){_super.call(this),this.getEnumerator=function(){return arrayEnumerator(arr)},this.toArray=function(){return arr.slice(0)}}return ArrayEnumerable}(exjs.Enumerable);function en(){return this&&Array.isArray(this)?new ArrayEnumerable(this):new exjs.Enumerable}try{Object.defineProperty(Array.prototype,"en",{value:en,enumerable:!1,writable:!1,configurable:!1})}catch(e){Array.prototype.en=en}})(exjs||(exjs={}));var exjs;(function(exjs){function concatEnumerator(prev,second){var t,s=!1,e={current:undefined,moveNext:function(){return t||(t=prev.getEnumerator()),e.current=undefined,t.moveNext()?(e.current=t.current,!0):s?!1:(s=!0,t=second.getEnumerator(),t.moveNext()?(e.current=t.current,!0):!1)}};return e}exjs.Enumerable.prototype.concat=function(second){var _this=this,en=second instanceof Array?second.en():second,e=new exjs.Enumerable;return e.getEnumerator=function(){return concatEnumerator(_this,en)},e},exjs.List&&(exjs.List.prototype.concat=exjs.Enumerable.prototype.concat)})(exjs||(exjs={}));var exjs;(function(exjs){function distinctEnumerator(prev,comparer){var t,visited=[],e={current:undefined,moveNext:function(){t||(t=prev.getEnumerator()),e.current=undefined;if(!comparer){while(t.moveNext())if(visited.indexOf(t.current)<0)return visited.push(e.current=t.current),!0;return!1}while(t.moveNext()){for(var i=0,len=visited.length,hit=!1;i<len&&!hit;i++)hit=!!comparer(visited[i],t.current);if(!hit)return visited.push(e.current=t.current),!0}return!1}};return e}exjs.Enumerable.prototype.distinct=function(comparer){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return distinctEnumerator(_this,comparer)},e},exjs.List&&(exjs.List.prototype.distinct=exjs.Enumerable.prototype.distinct)})(exjs||(exjs={}));var exjs;(function(exjs){function exceptEnumerator(prev,second,comparer){comparer=comparer||function(f,s){return f===s};var t,e={current:undefined,moveNext:function(){t||(t=prev.getEnumerator()),e.current=undefined;while(t.moveNext()){for(var hit=!1,x=second.getEnumerator();x.moveNext()&&!hit;)hit=comparer(t.current,x.current);if(!hit)return e.current=t.current,!0}return!1}};return e}exjs.Enumerable.prototype.except=function(second,comparer){var _this=this,en=second instanceof Array?second.en():second,e=new exjs.Enumerable;return e.getEnumerator=function(){return exceptEnumerator(_this,en,comparer)},e},exjs.List&&(exjs.List.prototype.except=exjs.Enumerable.prototype.except)})(exjs||(exjs={})),Function.prototype.fromJson=function(o,mappingOverrides){var rv=new this;if(o==null)return rv;var mapped=[];for(var key in mappingOverrides){var j=mapSubProperty(o[key],mappingOverrides[key]);if(j===undefined)continue;rv[key]=j,mapped.push(key)}for(var key in this.$jsonMappings){if(mapped.indexOf(key)>-1)continue;var j=mapSubProperty(o[key],this.$jsonMappings[key]);if(j===undefined)continue;rv[key]=j,mapped.push(key)}for(var key in o){if(mapped.indexOf(key)>-1)continue;rv[key]=o[key]}return rv;function mapSubProperty(j,mapping){if(j==null)return j;if(mapping instanceof Function)return mapping(j);if(mapping instanceof Array){mapping=mapping[0];if(mapping instanceof Function&&j instanceof Array){var arr=[];for(var i=0;i<j.length;i++)arr.push(mapping(j[i]));return arr}return undefined}return undefined}};var exjs;(function(exjs){function groupByEnumerator(prev,keySelector,comparer){var grps,i=0,e={current:undefined,moveNext:function(){return grps||(grps=createGroups(prev,keySelector,comparer)),e.current=undefined,i>=grps.length?!1:(e.current=grps[i],i++,!0)}};return e}function createGroups(prev,keySelector,comparer){comparer=comparer||function(k1,k2){return k1===k2};var grps=[],keys=[],e=prev.getEnumerator(),key;while(e.moveNext()){key=keySelector(e.current);var index=-1;for(var i=0,len=keys.length;i<len;i++)if(comparer(key,keys[i])){index=i;break}var grp;index<0?(keys.push(key),grps.push(grp=new Group(key))):grp=grps[index],grp._add(e.current)}return grps}var Group=function(_super){__extends(Group,_super);function Group(key){var _this=this;_super.call(this),this.key=key,this._arr=[],this.getEnumerator=function(){return _this._arr.en().getEnumerator()}}return Group.prototype._add=function(e){this._arr.push(e)},Group}(exjs.Enumerable);exjs.Enumerable.prototype.groupBy=function(keySelector,comparer){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return groupByEnumerator(_this,keySelector,comparer)},e},exjs.List&&(exjs.List.prototype.groupBy=exjs.Enumerable.prototype.groupBy)})(exjs||(exjs={}));var exjs;(function(exjs){function intersectEnumerator(prev,second,comparer){comparer=comparer||function(f,s){return f===s};var t,e={current:undefined,moveNext:function(){t||(t=exjs.en(prev).distinct().getEnumerator()),e.current=undefined;while(t.moveNext()){for(var hit=!1,x=second.getEnumerator();x.moveNext()&&!hit;)hit=comparer(t.current,x.current);if(hit)return e.current=t.current,!0}return!1}};return e}exjs.Enumerable.prototype.intersect=function(second,comparer){var _this=this,en=second instanceof Array?second.en():second,e=new exjs.Enumerable;return e.getEnumerator=function(){return intersectEnumerator(_this,en,comparer)},e},exjs.List&&(exjs.List.prototype.intersect=exjs.Enumerable.prototype.intersect)})(exjs||(exjs={}));var exjs;(function(exjs){function joinEnumerator(prev,inner,outerKeySelector,innerKeySelector,resultSelector,comparer){comparer=comparer||function(k1,k2){return k1===k2};var s,ins,j=0,e={current:undefined,moveNext:function(){e.current=undefined;if(!s){s=prev.getEnumerator();if(!s.moveNext())return!1;ins=exjs.en(inner).toArray()}var cur;do{for(;j<ins.length;j++){cur=ins[j];if(comparer(outerKeySelector(s.current),innerKeySelector(cur)))return j++,e.current=resultSelector(s.current,cur),!0}j=0}while(s.moveNext());return!1}};return e}exjs.Enumerable.prototype.join=function(inner,outerKeySelector,innerKeySelector,resultSelector,comparer){var _this=this,en=inner instanceof Array?inner.en():inner,e=new exjs.Enumerable;return e.getEnumerator=function(){return joinEnumerator(_this,en,outerKeySelector,innerKeySelector,resultSelector,comparer)},e},exjs.List&&(exjs.List.prototype.join=exjs.Enumerable.prototype.join)})(exjs||(exjs={}));var exjs;(function(exjs){exjs.Enumerable.prototype.toList=function(){var l=new List,enumerator=this.getEnumerator();while(enumerator.moveNext())l.push(enumerator.current);return l};var List=function(_super){__extends(List,_super);function List(){_super.apply(this,arguments)}return List.prototype.toString=function(){throw new Error("Not implemented")},List.prototype.toLocaleString=function(){throw new Error("Not implemented")},List.prototype.pop=function(){throw new Error("Not implemented")},List.prototype.push=function(){var items=[];for(var _i=0;_i<arguments.length;_i++)items[_i-0]=arguments[_i];throw new Error("Not implemented")},List.prototype.shift=function(){throw new Error("Not implemented")},List.prototype.slice=function(start,end){throw new Error("Not implemented")},List.prototype.sort=function(compareFn){throw new Error("Not implemented")},List.prototype.splice=function(){throw new Error("Not implemented")},List.prototype.unshift=function(){var items=[];for(var _i=0;_i<arguments.length;_i++)items[_i-0]=arguments[_i];throw new Error("Not implemented")},List.prototype.indexOf=function(searchElement,fromIndex){throw new Error("Not implemented")},List.prototype.lastIndexOf=function(searchElement,fromIndex){throw new Error("Not implemented")},List.prototype.every=function(callbackfn,thisArg){throw new Error("Not implemented")},List.prototype.some=function(callbackfn,thisArg){throw new Error("Not implemented")},List.prototype.forEach=function(callbackfn,thisArg){throw new Error("Not implemented")},List.prototype.map=function(callbackfn,thisArg){throw new Error("Not implemented")},List.prototype.filter=function(callbackfn,thisArg){throw new Error("Not implemented")},List.prototype.reduce=function(callbackfn,initialValue){throw new Error("Not implemented")},List.prototype.reduceRight=function(callbackfn,initialValue){throw new Error("Not implemented")},List.prototype.remove=function(item){throw new Error("Not implemented")},List.prototype.removeWhere=function(predicate){throw new Error("Not implemented")},List}(exjs.Enumerable);exjs.List=List;for(var p in Array)Array.hasOwnProperty(p)&&(List[p]=Array[p]);function __(){this.constructor=List}__.prototype=Array.prototype,List.prototype=new __;for(var key in exjs.Enumerable.prototype){if(key==="getEnumerator")continue;List.prototype[key]=exjs.Enumerable.prototype[key]}List.prototype.getEnumerator=function(){var list=this,len=list.length,e={moveNext:undefined,current:undefined},index=-1;return e.moveNext=function(){return index++,index>=len?(e.current=undefined,!1):(e.current=list[index],!0)},e},List.prototype.remove=function(item){return this.removeWhere(function(t){return t===item}).any()},List.prototype.removeWhere=function(predicate){var removed=[],cur;for(var i=this.length-1;i>=0;i--)cur=this[i],predicate(cur,i)===!0&&(this.splice(i,1),removed.push(cur));return removed.en().reverse()}})(exjs||(exjs={}));var exjs;(function(exjs){function orderByEnumerable(source,keySelector,isDescending,comparer){return new OrderedEnumerable(source,keySelector,isDescending,comparer)}var OrderedEnumerable=function(_super){__extends(OrderedEnumerable,_super);function OrderedEnumerable(source,keySelector,isDescending,keyComparer){_super.call(this),this.Source=source,keyComparer=keyComparer||function(f,s){return f>s?1:f<s?-1:0};var factor=isDescending===!0?-1:1;this.Sorter=function(a,b){return factor*keyComparer(keySelector(a),keySelector(b))}}return OrderedEnumerable.prototype.getEnumerator=function(){var source=this.Source,sorter=this.Sorter,arr,i=0,e={current:undefined,moveNext:function(){return arr||(arr=exjs.en(source).toArray(),arr.sort(sorter)),e.current=undefined,i>=arr.length?!1:(e.current=arr[i],i++,!0)}};return e},OrderedEnumerable.prototype.thenBy=function(keySelector,comparer){return new ThenEnumerable(this,keySelector,!1,comparer)},OrderedEnumerable.prototype.thenByDescending=function(keySelector,comparer){return new ThenEnumerable(this,keySelector,!0,comparer)},OrderedEnumerable}(exjs.Enumerable),ThenEnumerable=function(_super){__extends(ThenEnumerable,_super);function ThenEnumerable(source,keySelector,isDescending,keyComparer){_super.call(this,source,keySelector,isDescending,keyComparer);var parentSorter=source.Sorter,thisSorter=this.Sorter;this.Sorter=function(a,b){return parentSorter(a,b)||thisSorter(a,b)}}return ThenEnumerable}(OrderedEnumerable),fn=exjs.Enumerable.prototype;fn.orderBy=function(keySelector,comparer){return orderByEnumerable(this,keySelector,!1,comparer)},fn.orderByDescending=function(keySelector,comparer){return orderByEnumerable(this,keySelector,!0,comparer)},exjs.List&&(exjs.List.prototype.orderBy=exjs.Enumerable.prototype.orderBy,exjs.List.prototype.orderByDescending=exjs.Enumerable.prototype.orderByDescending)})(exjs||(exjs={}));var exjs;(function(exjs){function prependEnumerator(prev,items){var stage=1,firstit,secondit,e={current:undefined,moveNext:function(){if(stage<2){firstit=firstit||items.en().getEnumerator();if(firstit.moveNext())return e.current=firstit.current,!0;stage++}return secondit=secondit||prev.getEnumerator(),secondit.moveNext()?(e.current=secondit.current,!0):(e.current=undefined,!1)}};return e}exjs.Enumerable.prototype.prepend=function(){var _this=this,items=[];for(var _i=0;_i<arguments.length;_i++)items[_i-0]=arguments[_i];var e=new exjs.Enumerable;return e.getEnumerator=function(){return prependEnumerator(_this,items)},e},exjs.List&&(exjs.List.prototype.prepend=exjs.Enumerable.prototype.prepend)})(exjs||(exjs={}));var exjs;(function(exjs){function rangeEnumerator(start,end,increment){var i=start-increment,e={current:undefined,moveNext:function(){return i+=increment,i>=end?!1:(e.current=i,!0)}};return e}function range(start,end,increment){start=start||0,end=end||0;if(start>end)throw new Error("Start cannot be greater than end.");increment==null&&(increment=1);var e=new exjs.Enumerable;return e.getEnumerator=function(){return rangeEnumerator(start,end,increment)},e}exjs.range=range})(exjs||(exjs={}));var exjs;(function(exjs){function reverseEnumerator(prev){var a,i=0,e={current:undefined,moveNext:function(){return a||(a=exjs.en(prev).toArray(),i=a.length),i--,e.current=a[i],i>=0}};return e}exjs.Enumerable.prototype.reverse=function(){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return reverseEnumerator(_this)},e},exjs.List&&(exjs.List.prototype.reverse=exjs.Enumerable.prototype.reverse)})(exjs||(exjs={}));var exjs;(function(exjs){function round(value,digits){digits=digits||0;if(digits===0)return Math.round(value);var shift=Math.pow(10,digits);return Math.round(value*shift)/shift}exjs.round=round})(exjs||(exjs={}));var exjs;(function(exjs){function selectEnumerator(prev,selector){var t,i=0,e={current:undefined,moveNext:function(){return t||(t=prev.getEnumerator()),t.moveNext()?(e.current=selector(t.current,i),i++,!0):!1}};return e}function selectManyEnumerator(prev,selector){var t,active,e={current:undefined,moveNext:function(){e.current=undefined,t||(t=prev.getEnumerator());while(!active||!active.moveNext()){if(!t.moveNext())return!1;active=exjs.selectorEnumerator(selector(t.current))}return e.current=active.current,!0}};return e}exjs.Enumerable.prototype.select=function(selector){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return selectEnumerator(_this,selector)},e},exjs.Enumerable.prototype.selectMany=function(selector){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return selectManyEnumerator(_this,selector)},e},exjs.List&&(exjs.List.prototype.select=exjs.Enumerable.prototype.select,exjs.List.prototype.selectMany=exjs.Enumerable.prototype.selectMany)})(exjs||(exjs={}));var exjs;(function(exjs){function selectorEnumerator(obj){return Array.isArray(obj)?obj.en().getEnumerator():obj!=null&&typeof obj.getEnumerator=="function"?obj.getEnumerator():null}exjs.selectorEnumerator=selectorEnumerator})(exjs||(exjs={}));var exjs;(function(exjs){function skipEnumerator(prev,count){var t,e={current:undefined,moveNext:function(){if(!t){t=prev.getEnumerator();for(var i=0;i<count;i++)if(!t.moveNext())return!1}return t.moveNext()?(e.current=t.current,!0):(e.current=undefined,!1)}};return e}function skipWhileEnumerator(prev,predicate){var t,e={current:undefined,moveNext:function(){if(!t){t=prev.getEnumerator();for(var i=0;t.moveNext();i++)if(!predicate(e.current=t.current,i))return!0;return e.current=undefined,!1}return t.moveNext()?(e.current=t.current,!0):(e.current=undefined,!1)}};return e}exjs.Enumerable.prototype.skip=function(count){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return skipEnumerator(_this,count)},e},exjs.Enumerable.prototype.skipWhile=function(predicate){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return skipWhileEnumerator(_this,predicate)},e},exjs.List&&(exjs.List.prototype.skip=exjs.Enumerable.prototype.skip,exjs.List.prototype.skipWhile=exjs.Enumerable.prototype.skipWhile)})(exjs||(exjs={}));var exjs;(function(exjs){function takeEnumerator(prev,count){var t,i=0,e={current:undefined,moveNext:function(){return t||(t=prev.getEnumerator()),i++,i>count?!1:(e.current=undefined,t.moveNext()?(e.current=t.current,!0):!1)}};return e}function takeWhileEnumerator(prev,predicate){var t,i=0,e={current:undefined,moveNext:function(){return t||(t=prev.getEnumerator()),!t.moveNext()||!predicate(t.current,i)?(e.current=undefined,!1):(i++,e.current=t.current,!0)}};return e}exjs.Enumerable.prototype.take=function(count){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return takeEnumerator(_this,count)},e},exjs.Enumerable.prototype.takeWhile=function(predicate){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return takeWhileEnumerator(_this,predicate)},e},exjs.List&&(exjs.List.prototype.take=exjs.Enumerable.prototype.take,exjs.List.prototype.takeWhile=exjs.Enumerable.prototype.takeWhile)})(exjs||(exjs={}));var exjs;(function(exjs){function traverseEnumerator(prev,selector){var started=!1,enstack=[],t,e={current:undefined,moveNext:function(){if(!started)t=prev.getEnumerator(),started=!0;else{if(t==null)return!1;enstack.push(t),t=exjs.selectorEnumerator(selector(e.current))}while(!t||!t.moveNext()){if(enstack.length<1)break;t=enstack.pop()}return e.current=t==null?undefined:t.current,e.current!==undefined}};return e}function traverseUniqueEnumerator(prev,selector,turnstile){var started=!1,enstack=[],t,e={current:undefined,moveNext:function(){if(!started)t=prev.getEnumerator(),started=!0;else{if(t==null)return!1;enstack.push(t),t=exjs.selectorEnumerator(selector(e.current))}do{while(!t||!t.moveNext()){if(enstack.length<1)break;t=enstack.pop()}e.current=t==null?undefined:t.current}while(turnstile(e.current));return e.current!==undefined}};return e}exjs.Enumerable.prototype.traverse=function(selector){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return traverseEnumerator(_this,selector)},e},exjs.Enumerable.prototype.traverseUnique=function(selector,matcher){var _this=this,existing=[],e=new exjs.Enumerable;return matcher?e.getEnumerator=function(){return traverseUniqueEnumerator(_this,selector,function(x){return existing.some(function(e){return matcher(x,e)})?!0:(existing.push(x),!1)})}:e.getEnumerator=function(){return traverseUniqueEnumerator(_this,selector,function(x){return existing.indexOf(x)>-1?!0:(existing.push(x),!1)})},e},exjs.List&&(exjs.List.prototype.traverse=exjs.Enumerable.prototype.traverse,exjs.List.prototype.traverseUnique=exjs.Enumerable.prototype.traverseUnique)})(exjs||(exjs={}));var exjs;(function(exjs){function unionEnumerator(prev,second,comparer){comparer=comparer||function(f,s){return f===s};var t,visited=[],s,e={current:undefined,moveNext:function(){t||(t=exjs.en(prev).distinct().getEnumerator()),e.current=undefined;if(!s&&t.moveNext())return visited.push(e.current=t.current),!0;s=s||exjs.en(second).distinct().getEnumerator();while(s.moveNext()){for(var i=0,hit=!1,len=visited.length;i<len&&!hit;i++)hit=comparer(visited[i],s.current);if(!hit)return e.current=s.current,!0}return!1}};return e}exjs.Enumerable.prototype.union=function(second,comparer){var _this=this,en=second instanceof Array?second.en():second,e=new exjs.Enumerable;return e.getEnumerator=function(){return unionEnumerator(_this,en,comparer)},e},exjs.List&&(exjs.List.prototype.union=exjs.Enumerable.prototype.union)})(exjs||(exjs={}));var exjs;(function(exjs){function whereEnumerator(prev,filter){var t,e={current:undefined,moveNext:function(){t||(t=prev.getEnumerator());var c;while(t.moveNext())if(filter(c=t.current))return e.current=c,!0;return!1}};return e}exjs.Enumerable.prototype.where=function(filter){var _this=this,e=new exjs.Enumerable;return e.getEnumerator=function(){return whereEnumerator(_this,filter)},e},exjs.List&&(exjs.List.prototype.where=exjs.Enumerable.prototype.where)})(exjs||(exjs={}));var exjs;(function(exjs){function en(enu){var x=new exjs.Enumerable;return x.getEnumerator=function(){return wrapEnumerator(enu)},x}exjs.en=en;function wrapEnumerator(enu){var wrapped=enu.getEnumerator(),x={current:undefined,moveNext:undefined};return x.moveNext=function(){return wrapped.moveNext()?(x.current=wrapped.current,!0):(x.current=undefined,!1)},x}})(exjs||(exjs={}));var ex=exjs.en,exjs;(function(exjs){function zipEnumerator(prev,second,resultSelector){var s,t,e={current:undefined,moveNext:function(){return s||(s=prev.getEnumerator()),t||(t=second.getEnumerator()),e.current=undefined,!s.moveNext()||!t.moveNext()?!1:(e.current=resultSelector(s.current,t.current),!0)}};return e}exjs.Enumerable.prototype.zip=function(second,resultSelector){var _this=this,en=second instanceof Array?second.en():second,e=new exjs.Enumerable;return e.getEnumerator=function(){return zipEnumerator(_this,en,resultSelector)},e},exjs.List&&(exjs.List.prototype.zip=exjs.Enumerable.prototype.zip)})(exjs||(exjs={})),define("exjs",function(global){return function(){var ret,fn;return ret||global.exjs}}(this)),Array.prototype.clone||(Array.prototype.clone=function(){return this.slice(0)}),Array.prototype.contains||(Array.prototype.contains=function(val){return this.indexOf(val)!==-1}),Array.prototype.indexOf||(Array.prototype.indexOf=function(searchElement,fromIndex){var i=fromIndex||0,j=this.length;for(i;i<j;i++)if(this[i]===searchElement)return i;return-1}),Array.prototype.indexOfTest=function(test,fromIndex){var i=fromIndex||0,j=this.length;for(i;i<j;i++)if(test(this[i]))return i;return-1},Array.prototype.insert=function(item,index){this.splice(index,0,item)},Array.prototype.last||(Array.prototype.last=function(){return this[this.length-1]}),Array.prototype.move=function(fromIndex,toIndex){this.splice(toIndex,0,this.splice(fromIndex,1)[0])},Array.prototype.remove=function(item){var index=this.indexOf(item);index>-1&&this.splice(index,1)},Array.prototype.removeAt=function(index){this.splice(index,1)},Math.clamp=function(value,min,max){return Math.min(Math.max(value,min),max)},Math.constrain=function(value,low,high){return Math.clamp(value,low,high)},Math.degreesToRadians=function(degrees){return Math.TAU*(degrees/360)},Math.distanceBetween=function(x1,y1,x2,y2){return Math.sqrt(Math.sq(x2-x1)+Math.sq(y2-y1))},Math.lerp=function(start,stop,amount){return start+(stop-start)*amount},Math.mag=function(a,b,c){return Math.sqrt(a*a+b*b+c*c)},Math.map=function(value,start1,stop1,start2,stop2){return start2+(stop2-start2)*((value-start1)/(stop1-start1))},Math.median=function(values){values.sort(function(a,b){return a-b});var half=Math.floor(values.length/2);return values.length%2?values[half]:(values[half-1]+values[half])/2},Math.normalise=function(num,min,max){return(num-min)/(max-min)},Math.radiansToDegrees=function(radians){return radians*360/Math.TAU},Math.randomBetween=function(low,high){return high||(high=low,low=0),low>=high?low:low+(high-low)*Math.random()},Math.roundToDecimalPlace=function(num,dec){return Math.round(num*Math.pow(10,dec))/Math.pow(10,dec)},Math.sq=function(n){return n*n},Math.TAU=Math.PI*2,Number.prototype.isInteger||(Number.prototype.isInteger=function(){return this%1===0}),typeof Object.create!="function"&&(Object.create=function(o,props){function F(){}F.prototype=o;var result=new F;if(typeof props=="object")for(var prop in props)props.hasOwnProperty(prop)&&(result[prop]=props[prop].value);return result}),Object.keys||(Object.keys=function(){var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){if(typeof obj!="object"&&typeof obj!="function"||obj===null)throw new TypeError("Object.keys called on non-object");var result=[];for(var prop in obj)hasOwnProperty.call(obj,prop)&&result.push(prop);if(hasDontEnumBug)for(var i=0;i<dontEnumsLength;i++)hasOwnProperty.call(obj,dontEnums[i])&&result.push(dontEnums[i]);return result}}()),String.prototype.b64_to_utf8=function(){return decodeURIComponent(escape(window.atob(this)))},String.prototype.contains=function(str){return this.indexOf(str)!==-1},String.prototype.endsWith||(String.prototype.endsWith=function(str){return this.indexOf(str,this.length-str.length)!==-1}),String.format=function(){var s=arguments[0];for(var i=0;i<arguments.length-1;i++){var reg=new RegExp("\\{"+i+"\\}","gm");s=s.replace(reg,arguments[i+1])}return s},String.prototype.hashCode=function(){var hash=0,i,chr,len;if(this.length===0)return hash.toString();for(i=0,len=this.length;i<len;i++)chr=this.charCodeAt(i),hash=(hash<<5)-hash+chr,hash|=0;return hash.toString()},String.prototype.isAlphanumeric=function(){return/^[a-zA-Z0-9]*$/.test(this)},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},String.prototype.startsWith||(String.prototype.startsWith=function(str){return this.indexOf(str)==0}),String.prototype.toCssClass=function(){return this.replace(/[^a-z0-9]/g,function(s){var c=s.charCodeAt(0);return c==32?"-":c>=65&&c<=90?"_"+s.toLowerCase():"__"+("000"+c.toString(16)).slice(-4)})},String.prototype.toFileName=function(){return this.replace(/[^a-z0-9]/gi,"_").toLowerCase()},String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}),String.prototype.utf8_to_b64=function(){return window.btoa(unescape(encodeURIComponent(this)))},define("extensions",function(){});function Intersection(status){arguments.length>0&&this.init(status)}Intersection.prototype.init=function(status){this.status=status,this.points=new Array},Intersection.prototype.appendPoint=function(point){this.points.push(point)},Intersection.prototype.appendPoints=function(points){this.points=this.points.concat(points)},Intersection.intersectShapes=function(shape1,shape2){var ip1=shape1.getIntersectionParams(),ip2=shape2.getIntersectionParams(),result;if(ip1!=null&&ip2!=null)if(ip1.name=="Path")result=Intersection.intersectPathShape(shape1,shape2);else if(ip2.name=="Path")result=Intersection.intersectPathShape(shape2,shape1);else{var method,params;ip1.name<ip2.name?(method="intersect"+ip1.name+ip2.name,params=ip1.params.concat(ip2.params)):(method="intersect"+ip2.name+ip1.name,params=ip2.params.concat(ip1.params));if(!(method in Intersection))throw new Error("Intersection not available: "+method);result=Intersection[method].apply(null,params)}else result=new Intersection("No Intersection");return result},Intersection.intersectPathShape=function(path,shape){return path.intersectShape(shape)},Intersection.intersectBezier2Bezier2=function(a1,a2,a3,b1,b2,b3){var a,b,c12,c11,c10,c22,c21,c20,result=new Intersection("No Intersection"),poly;a=a2.multiply(-2),c12=a1.add(a.add(a3)),a=a1.multiply(-2),b=a2.multiply(2),c11=a.add(b),c10=new Point2D(a1.x,a1.y),a=b2.multiply(-2),c22=b1.add(a.add(b3)),a=b1.multiply(-2),b=b2.multiply(2),c21=a.add(b),c20=new Point2D(b1.x,b1.y);if(c12.y==0){var v0=c12.x*(c10.y-c20.y),v1=v0-c11.x*c11.y,v2=v0+v1,v3=c11.y*c11.y;poly=new Polynomial(c12.x*c22.y*c22.y,2*c12.x*c21.y*c22.y,c12.x*c21.y*c21.y-c22.x*v3-c22.y*v0-c22.y*v1,-c21.x*v3-c21.y*v0-c21.y*v1,(c10.x-c20.x)*v3+(c10.y-c20.y)*v1)}else{var v0=c12.x*c22.y-c12.y*c22.x,v1=c12.x*c21.y-c21.x*c12.y,v2=c11.x*c12.y-c11.y*c12.x,v3=c10.y-c20.y,v4=c12.y*(c10.x-c20.x)-c12.x*v3,v5=-c11.y*v2+c12.y*v4,v6=v2*v2;poly=new Polynomial(v0*v0,2*v0*v1,(-c22.y*v6+c12.y*v1*v1+c12.y*v0*v4+v0*v5)/c12.y,(-c21.y*v6+c12.y*v1*v4+v1*v5)/c12.y,(v3*v6+v4*v5)/c12.y)}var roots=poly.getRoots();for(var i=0;i<roots.length;i++){var s=roots[i];if(0<=s&&s<=1){var xRoots=(new Polynomial(c12.x,c11.x,c10.x-c20.x-s*c21.x-s*s*c22.x)).getRoots(),yRoots=(new Polynomial(c12.y,c11.y,c10.y-c20.y-s*c21.y-s*s*c22.y)).getRoots();if(xRoots.length>0&&yRoots.length>0){var TOLERANCE=1e-4;checkRoots:for(var j=0;j<xRoots.length;j++){var xRoot=xRoots[j];if(0<=xRoot&&xRoot<=1)for(var k=0;k<yRoots.length;k++)if(Math.abs(xRoot-yRoots[k])<TOLERANCE){result.points.push(c22.multiply(s*s).add(c21.multiply(s).add(c20)));break checkRoots}}}}}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier2Bezier3=function(a1,a2,a3,b1,b2,b3,b4){var a,b,c,d,c12,c11,c10,c23,c22,c21,c20,result=new Intersection("No Intersection");a=a2.multiply(-2),c12=a1.add(a.add(a3)),a=a1.multiply(-2),b=a2.multiply(2),c11=a.add(b),c10=new Point2D(a1.x,a1.y),a=b1.multiply(-1),b=b2.multiply(3),c=b3.multiply(-3),d=a.add(b.add(c.add(b4))),c23=new Vector2D(d.x,d.y),a=b1.multiply(3),b=b2.multiply(-6),c=b3.multiply(3),d=a.add(b.add(c)),c22=new Vector2D(d.x,d.y),a=b1.multiply(-3),b=b2.multiply(3),c=a.add(b),c21=new Vector2D(c.x,c.y),c20=new Vector2D(b1.x,b1.y);var c10x2=c10.x*c10.x,c10y2=c10.y*c10.y,c11x2=c11.x*c11.x,c11y2=c11.y*c11.y,c12x2=c12.x*c12.x,c12y2=c12.y*c12.y,c20x2=c20.x*c20.x,c20y2=c20.y*c20.y,c21x2=c21.x*c21.x,c21y2=c21.y*c21.y,c22x2=c22.x*c22.x,c22y2=c22.y*c22.y,c23x2=c23.x*c23.x,c23y2=c23.y*c23.y,poly=new Polynomial(-2*c12.x*c12.y*c23.x*c23.y+c12x2*c23y2+c12y2*c23x2,-2*c12.x*c12.y*c22.x*c23.y-2*c12.x*c12.y*c22.y*c23.x+2*c12y2*c22.x*c23.x+2*c12x2*c22.y*c23.y,-2*c12.x*c21.x*c12.y*c23.y-2*c12.x*c12.y*c21.y*c23.x-2*c12.x*c12.y*c22.x*c22.y+2*c21.x*c12y2*c23.x+c12y2*c22x2+c12x2*(2*c21.y*c23.y+c22y2),2*c10.x*c12.x*c12.y*c23.y+2*c10.y*c12.x*c12.y*c23.x+c11.x*c11.y*c12.x*c23.y+c11.x*c11.y*c12.y*c23.x-2*c20.x*c12.x*c12.y*c23.y-2*c12.x*c20.y*c12.y*c23.x-2*c12.x*c21.x*c12.y*c22.y-2*c12.x*c12.y*c21.y*c22.x-2*c10.x*c12y2*c23.x-2*c10.y*c12x2*c23.y+2*c20.x*c12y2*c23.x+2*c21.x*c12y2*c22.x-c11y2*c12.x*c23.x-c11x2*c12.y*c23.y+c12x2*(2*c20.y*c23.y+2*c21.y*c22.y),2*c10.x*c12.x*c12.y*c22.y+2*c10.y*c12.x*c12.y*c22.x+c11.x*c11.y*c12.x*c22.y+c11.x*c11.y*c12.y*c22.x-2*c20.x*c12.x*c12.y*c22.y-2*c12.x*c20.y*c12.y*c22.x-2*c12.x*c21.x*c12.y*c21.y-2*c10.x*c12y2*c22.x-2*c10.y*c12x2*c22.y+2*c20.x*c12y2*c22.x-c11y2*c12.x*c22.x-c11x2*c12.y*c22.y+c21x2*c12y2+c12x2*(2*c20.y*c22.y+c21y2),2*c10.x*c12.x*c12.y*c21.y+2*c10.y*c12.x*c21.x*c12.y+c11.x*c11.y*c12.x*c21.y+c11.x*c11.y*c21.x*c12.y-2*c20.x*c12.x*c12.y*c21.y-2*c12.x*c20.y*c21.x*c12.y-2*c10.x*c21.x*c12y2-2*c10.y*c12x2*c21.y+2*c20.x*c21.x*c12y2-c11y2*c12.x*c21.x-c11x2*c12.y*c21.y+2*c12x2*c20.y*c21.y,-2*c10.x*c10.y*c12.x*c12.y-c10.x*c11.x*c11.y*c12.y-c10.y*c11.x*c11.y*c12.x+2*c10.x*c12.x*c20.y*c12.y+2*c10.y*c20.x*c12.x*c12.y+c11.x*c20.x*c11.y*c12.y+c11.x*c11.y*c12.x*c20.y-2*c20.x*c12.x*c20.y*c12.y-2*c10.x*c20.x*c12y2+c10.x*c11y2*c12.x+c10.y*c11x2*c12.y-2*c10.y*c12x2*c20.y-c20.x*c11y2*c12.x-c11x2*c20.y*c12.y+c10x2*c12y2+c10y2*c12x2+c20x2*c12y2+c12x2*c20y2),roots=poly.getRootsInInterval(0,1);for(var i=0;i<roots.length;i++){var s=roots[i],xRoots=(new Polynomial(c12.x,c11.x,c10.x-c20.x-s*c21.x-s*s*c22.x-s*s*s*c23.x)).getRoots(),yRoots=(new Polynomial(c12.y,c11.y,c10.y-c20.y-s*c21.y-s*s*c22.y-s*s*s*c23.y)).getRoots();if(xRoots.length>0&&yRoots.length>0){var TOLERANCE=1e-4;checkRoots:for(var j=0;j<xRoots.length;j++){var xRoot=xRoots[j];if(0<=xRoot&&xRoot<=1)for(var k=0;k<yRoots.length;k++)if(Math.abs(xRoot-yRoots[k])<TOLERANCE){result.points.push(c23.multiply(s*s*s).add(c22.multiply(s*s).add(c21.multiply(s).add(c20))));break checkRoots}}}}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier2Circle=function(p1,p2,p3,c,r){return Intersection.intersectBezier2Ellipse(p1,p2,p3,c,r,r)},Intersection.intersectBezier2Ellipse=function(p1,p2,p3,ec,rx,ry){var a,b,c2,c1,c0,result=new Intersection("No Intersection");a=p2.multiply(-2),c2=p1.add(a.add(p3)),a=p1.multiply(-2),b=p2.multiply(2),c1=a.add(b),c0=new Point2D(p1.x,p1.y);var rxrx=rx*rx,ryry=ry*ry,roots=(new Polynomial(ryry*c2.x*c2.x+rxrx*c2.y*c2.y,2*(ryry*c2.x*c1.x+rxrx*c2.y*c1.y),ryry*(2*c2.x*c0.x+c1.x*c1.x)+rxrx*(2*c2.y*c0.y+c1.y*c1.y)-2*(ryry*ec.x*c2.x+rxrx*ec.y*c2.y),2*(ryry*c1.x*(c0.x-ec.x)+rxrx*c1.y*(c0.y-ec.y)),ryry*(c0.x*c0.x+ec.x*ec.x)+rxrx*(c0.y*c0.y+ec.y*ec.y)-2*(ryry*ec.x*c0.x+rxrx*ec.y*c0.y)-rxrx*ryry)).getRoots();for(var i=0;i<roots.length;i++){var t=roots[i];0<=t&&t<=1&&result.points.push(c2.multiply(t*t).add(c1.multiply(t).add(c0)))}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier2Line=function(p1,p2,p3,a1,a2){var a,b,c2,c1,c0,cl,n,min=a1.min(a2),max=a1.max(a2),result=new Intersection("No Intersection");a=p2.multiply(-2),c2=p1.add(a.add(p3)),a=p1.multiply(-2),b=p2.multiply(2),c1=a.add(b),c0=new Point2D(p1.x,p1.y),n=new Vector2D(a1.y-a2.y,a2.x-a1.x),cl=a1.x*a2.y-a2.x*a1.y,roots=(new Polynomial(n.dot(c2),n.dot(c1),n.dot(c0)+cl)).getRoots();for(var i=0;i<roots.length;i++){var t=roots[i];if(0<=t&&t<=1){var p4=p1.lerp(p2,t),p5=p2.lerp(p3,t),p6=p4.lerp(p5,t);a1.x==a2.x?min.y<=p6.y&&p6.y<=max.y&&(result.status="Intersection",result.appendPoint(p6)):a1.y==a2.y?min.x<=p6.x&&p6.x<=max.x&&(result.status="Intersection",result.appendPoint(p6)):p6.gte(min)&&p6.lte(max)&&(result.status="Intersection",result.appendPoint(p6))}}return result},Intersection.intersectBezier2Polygon=function(p1,p2,p3,points){var result=new Intersection("No Intersection"),length=points.length;for(var i=0;i<length;i++){var a1=points[i],a2=points[(i+1)%length],inter=Intersection.intersectBezier2Line(p1,p2,p3,a1,a2);result.appendPoints(inter.points)}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier2Rectangle=function(p1,p2,p3,r1,r2){var min=r1.min(r2),max=r1.max(r2),topRight=new Point2D(max.x,min.y),bottomLeft=new Point2D(min.x,max.y),inter1=Intersection.intersectBezier2Line(p1,p2,p3,min,topRight),inter2=Intersection.intersectBezier2Line(p1,p2,p3,topRight,max),inter3=Intersection.intersectBezier2Line(p1,p2,p3,max,bottomLeft),inter4=Intersection.intersectBezier2Line(p1,p2,p3,bottomLeft,min),result=new Intersection("No Intersection");return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier3Bezier3=function(a1,a2,a3,a4,b1,b2,b3,b4){var a,b,c,d,c13,c12,c11,c10,c23,c22,c21,c20,result=new Intersection("No Intersection");a=a1.multiply(-1),b=a2.multiply(3),c=a3.multiply(-3),d=a.add(b.add(c.add(a4))),c13=new Vector2D(d.x,d.y),a=a1.multiply(3),b=a2.multiply(-6),c=a3.multiply(3),d=a.add(b.add(c)),c12=new Vector2D(d.x,d.y),a=a1.multiply(-3),b=a2.multiply(3),c=a.add(b),c11=new Vector2D(c.x,c.y),c10=new Vector2D(a1.x,a1.y),a=b1.multiply(-1),b=b2.multiply(3),c=b3.multiply(-3),d=a.add(b.add(c.add(b4))),c23=new Vector2D(d.x,d.y),a=b1.multiply(3),b=b2.multiply(-6),c=b3.multiply(3),d=a.add(b.add(c)),c22=new Vector2D(d.x,d.y),a=b1.multiply(-3),b=b2.multiply(3),c=a.add(b),c21=new Vector2D(c.x,c.y),c20=new Vector2D(b1.x,b1.y);var c10x2=c10.x*c10.x,c10x3=c10.x*c10.x*c10.x,c10y2=c10.y*c10.y,c10y3=c10.y*c10.y*c10.y,c11x2=c11.x*c11.x,c11x3=c11.x*c11.x*c11.x,c11y2=c11.y*c11.y,c11y3=c11.y*c11.y*c11.y,c12x2=c12.x*c12.x,c12x3=c12.x*c12.x*c12.x,c12y2=c12.y*c12.y,c12y3=c12.y*c12.y*c12.y,c13x2=c13.x*c13.x,c13x3=c13.x*c13.x*c13.x,c13y2=c13.y*c13.y,c13y3=c13.y*c13.y*c13.y,c20x2=c20.x*c20.x,c20x3=c20.x*c20.x*c20.x,c20y2=c20.y*c20.y,c20y3=c20.y*c20.y*c20.y,c21x2=c21.x*c21.x,c21x3=c21.x*c21.x*c21.x,c21y2=c21.y*c21.y,c22x2=c22.x*c22.x,c22x3=c22.x*c22.x*c22.x,c22y2=c22.y*c22.y,c23x2=c23.x*c23.x,c23x3=c23.x*c23.x*c23.x,c23y2=c23.y*c23.y,c23y3=c23.y*c23.y*c23.y,poly=new Polynomial(-c13x3*c23y3+c13y3*c23x3-3*c13.x*c13y2*c23x2*c23.y+3*c13x2*c13.y*c23.x*c23y2,-6*c13.x*c22.x*c13y2*c23.x*c23.y+6*c13x2*c13.y*c22.y*c23.x*c23.y+3*c22.x*c13y3*c23x2-3*c13x3*c22.y*c23y2-3*c13.x*c13y2*c22.y*c23x2+3*c13x2*c22.x*c13.y*c23y2,-6*c21.x*c13.x*c13y2*c23.x*c23.y-6*c13.x*c22.x*c13y2*c22.y*c23.x+6*c13x2*c22.x*c13.y*c22.y*c23.y+3*c21.x*c13y3*c23x2+3*c22x2*c13y3*c23.x+3*c21.x*c13x2*c13.y*c23y2-3*c13.x*c21.y*c13y2*c23x2-3*c13.x*c22x2*c13y2*c23.y+c13x2*c13.y*c23.x*(6*c21.y*c23.y+3*c22y2)+c13x3*(-c21.y*c23y2-2*c22y2*c23.y-c23.y*(2*c21.y*c23.y+c22y2)),c11.x*c12.y*c13.x*c13.y*c23.x*c23.y-c11.y*c12.x*c13.x*c13.y*c23.x*c23.y+6*c21.x*c22.x*c13y3*c23.x+3*c11.x*c12.x*c13.x*c13.y*c23y2+6*c10.x*c13.x*c13y2*c23.x*c23.y-3*c11.x*c12.x*c13y2*c23.x*c23.y-3*c11.y*c12.y*c13.x*c13.y*c23x2-6*c10.y*c13x2*c13.y*c23.x*c23.y-6*c20.x*c13.x*c13y2*c23.x*c23.y+3*c11.y*c12.y*c13x2*c23.x*c23.y-2*c12.x*c12y2*c13.x*c23.x*c23.y-6*c21.x*c13.x*c22.x*c13y2*c23.y-6*c21.x*c13.x*c13y2*c22.y*c23.x-6*c13.x*c21.y*c22.x*c13y2*c23.x+6*c21.x*c13x2*c13.y*c22.y*c23.y+2*c12x2*c12.y*c13.y*c23.x*c23.y+c22x3*c13y3-3*c10.x*c13y3*c23x2+3*c10.y*c13x3*c23y2+3*c20.x*c13y3*c23x2+c12y3*c13.x*c23x2-c12x3*c13.y*c23y2-3*c10.x*c13x2*c13.y*c23y2+3*c10.y*c13.x*c13y2*c23x2-2*c11.x*c12.y*c13x2*c23y2+c11.x*c12.y*c13y2*c23x2-c11.y*c12.x*c13x2*c23y2+2*c11.y*c12.x*c13y2*c23x2+3*c20.x*c13x2*c13.y*c23y2-c12.x*c12y2*c13.y*c23x2-3*c20.y*c13.x*c13y2*c23x2+c12x2*c12.y*c13.x*c23y2-3*c13.x*c22x2*c13y2*c22.y+c13x2*c13.y*c23.x*(6*c20.y*c23.y+6*c21.y*c22.y)+c13x2*c22.x*c13.y*(6*c21.y*c23.y+3*c22y2)+c13x3*(-2*c21.y*c22.y*c23.y-c20.y*c23y2-c22.y*(2*c21.y*c23.y+c22y2)-c23.y*(2*c20.y*c23.y+2*c21.y*c22.y)),6*c11.x*c12.x*c13.x*c13.y*c22.y*c23.y+c11.x*c12.y*c13.x*c22.x*c13.y*c23.y+c11.x*c12.y*c13.x*c13.y*c22.y*c23.x-c11.y*c12.x*c13.x*c22.x*c13.y*c23.y-c11.y*c12.x*c13.x*c13.y*c22.y*c23.x-6*c11.y*c12.y*c13.x*c22.x*c13.y*c23.x-6*c10.x*c22.x*c13y3*c23.x+6*c20.x*c22.x*c13y3*c23.x+6*c10.y*c13x3*c22.y*c23.y+2*c12y3*c13.x*c22.x*c23.x-2*c12x3*c13.y*c22.y*c23.y+6*c10.x*c13.x*c22.x*c13y2*c23.y+6*c10.x*c13.x*c13y2*c22.y*c23.x+6*c10.y*c13.x*c22.x*c13y2*c23.x-3*c11.x*c12.x*c22.x*c13y2*c23.y-3*c11.x*c12.x*c13y2*c22.y*c23.x+2*c11.x*c12.y*c22.x*c13y2*c23.x+4*c11.y*c12.x*c22.x*c13y2*c23.x-6*c10.x*c13x2*c13.y*c22.y*c23.y-6*c10.y*c13x2*c22.x*c13.y*c23.y-6*c10.y*c13x2*c13.y*c22.y*c23.x-4*c11.x*c12.y*c13x2*c22.y*c23.y-6*c20.x*c13.x*c22.x*c13y2*c23.y-6*c20.x*c13.x*c13y2*c22.y*c23.x-2*c11.y*c12.x*c13x2*c22.y*c23.y+3*c11.y*c12.y*c13x2*c22.x*c23.y+3*c11.y*c12.y*c13x2*c22.y*c23.x-2*c12.x*c12y2*c13.x*c22.x*c23.y-2*c12.x*c12y2*c13.x*c22.y*c23.x-2*c12.x*c12y2*c22.x*c13.y*c23.x-6*c20.y*c13.x*c22.x*c13y2*c23.x-6*c21.x*c13.x*c21.y*c13y2*c23.x-6*c21.x*c13.x*c22.x*c13y2*c22.y+6*c20.x*c13x2*c13.y*c22.y*c23.y+2*c12x2*c12.y*c13.x*c22.y*c23.y+2*c12x2*c12.y*c22.x*c13.y*c23.y+2*c12x2*c12.y*c13.y*c22.y*c23.x+3*c21.x*c22x2*c13y3+3*c21x2*c13y3*c23.x-3*c13.x*c21.y*c22x2*c13y2-3*c21x2*c13.x*c13y2*c23.y+c13x2*c22.x*c13.y*(6*c20.y*c23.y+6*c21.y*c22.y)+c13x2*c13.y*c23.x*(6*c20.y*c22.y+3*c21y2)+c21.x*c13x2*c13.y*(6*c21.y*c23.y+3*c22y2)+c13x3*(-2*c20.y*c22.y*c23.y-c23.y*(2*c20.y*c22.y+c21y2)-c21.y*(2*c21.y*c23.y+c22y2)-c22.y*(2*c20.y*c23.y+2*c21.y*c22.y)),c11.x*c21.x*c12.y*c13.x*c13.y*c23.y+c11.x*c12.y*c13.x*c21.y*c13.y*c23.x+c11.x*c12.y*c13.x*c22.x*c13.y*c22.y-c11.y*c12.x*c21.x*c13.x*c13.y*c23.y-c11.y*c12.x*c13.x*c21.y*c13.y*c23.x-c11.y*c12.x*c13.x*c22.x*c13.y*c22.y-6*c11.y*c21.x*c12.y*c13.x*c13.y*c23.x-6*c10.x*c21.x*c13y3*c23.x+6*c20.x*c21.x*c13y3*c23.x+2*c21.x*c12y3*c13.x*c23.x+6*c10.x*c21.x*c13.x*c13y2*c23.y+6*c10.x*c13.x*c21.y*c13y2*c23.x+6*c10.x*c13.x*c22.x*c13y2*c22.y+6*c10.y*c21.x*c13.x*c13y2*c23.x-3*c11.x*c12.x*c21.x*c13y2*c23.y-3*c11.x*c12.x*c21.y*c13y2*c23.x-3*c11.x*c12.x*c22.x*c13y2*c22.y+2*c11.x*c21.x*c12.y*c13y2*c23.x+4*c11.y*c12.x*c21.x*c13y2*c23.x-6*c10.y*c21.x*c13x2*c13.y*c23.y-6*c10.y*c13x2*c21.y*c13.y*c23.x-6*c10.y*c13x2*c22.x*c13.y*c22.y-6*c20.x*c21.x*c13.x*c13y2*c23.y-6*c20.x*c13.x*c21.y*c13y2*c23.x-6*c20.x*c13.x*c22.x*c13y2*c22.y+3*c11.y*c21.x*c12.y*c13x2*c23.y-3*c11.y*c12.y*c13.x*c22x2*c13.y+3*c11.y*c12.y*c13x2*c21.y*c23.x+3*c11.y*c12.y*c13x2*c22.x*c22.y-2*c12.x*c21.x*c12y2*c13.x*c23.y-2*c12.x*c21.x*c12y2*c13.y*c23.x-2*c12.x*c12y2*c13.x*c21.y*c23.x-2*c12.x*c12y2*c13.x*c22.x*c22.y-6*c20.y*c21.x*c13.x*c13y2*c23.x-6*c21.x*c13.x*c21.y*c22.x*c13y2+6*c20.y*c13x2*c21.y*c13.y*c23.x+2*c12x2*c21.x*c12.y*c13.y*c23.y+2*c12x2*c12.y*c21.y*c13.y*c23.x+2*c12x2*c12.y*c22.x*c13.y*c22.y-3*c10.x*c22x2*c13y3+3*c20.x*c22x2*c13y3+3*c21x2*c22.x*c13y3+c12y3*c13.x*c22x2+3*c10.y*c13.x*c22x2*c13y2+c11.x*c12.y*c22x2*c13y2+2*c11.y*c12.x*c22x2*c13y2-c12.x*c12y2*c22x2*c13.y-3*c20.y*c13.x*c22x2*c13y2-3*c21x2*c13.x*c13y2*c22.y+c12x2*c12.y*c13.x*(2*c21.y*c23.y+c22y2)+c11.x*c12.x*c13.x*c13.y*(6*c21.y*c23.y+3*c22y2)+c21.x*c13x2*c13.y*(6*c20.y*c23.y+6*c21.y*c22.y)+c12x3*c13.y*(-2*c21.y*c23.y-c22y2)+c10.y*c13x3*(6*c21.y*c23.y+3*c22y2)+c11.y*c12.x*c13x2*(-2*c21.y*c23.y-c22y2)+c11.x*c12.y*c13x2*(-4*c21.y*c23.y-2*c22y2)+c10.x*c13x2*c13.y*(-6*c21.y*c23.y-3*c22y2)+c13x2*c22.x*c13.y*(6*c20.y*c22.y+3*c21y2)+c20.x*c13x2*c13.y*(6*c21.y*c23.y+3*c22y2)+c13x3*(-2*c20.y*c21.y*c23.y-c22.y*(2*c20.y*c22.y+c21y2)-c20.y*(2*c21.y*c23.y+c22y2)-c21.y*(2*c20.y*c23.y+2*c21.y*c22.y)),-c10.x*c11.x*c12.y*c13.x*c13.y*c23.y+c10.x*c11.y*c12.x*c13.x*c13.y*c23.y+6*c10.x*c11.y*c12.y*c13.x*c13.y*c23.x-6*c10.y*c11.x*c12.x*c13.x*c13.y*c23.y-c10.y*c11.x*c12.y*c13.x*c13.y*c23.x+c10.y*c11.y*c12.x*c13.x*c13.y*c23.x+c11.x*c11.y*c12.x*c12.y*c13.x*c23.y-c11.x*c11.y*c12.x*c12.y*c13.y*c23.x+c11.x*c20.x*c12.y*c13.x*c13.y*c23.y+c11.x*c20.y*c12.y*c13.x*c13.y*c23.x+c11.x*c21.x*c12.y*c13.x*c13.y*c22.y+c11.x*c12.y*c13.x*c21.y*c22.x*c13.y-c20.x*c11.y*c12.x*c13.x*c13.y*c23.y-6*c20.x*c11.y*c12.y*c13.x*c13.y*c23.x-c11.y*c12.x*c20.y*c13.x*c13.y*c23.x-c11.y*c12.x*c21.x*c13.x*c13.y*c22.y-c11.y*c12.x*c13.x*c21.y*c22.x*c13.y-6*c11.y*c21.x*c12.y*c13.x*c22.x*c13.y-6*c10.x*c20.x*c13y3*c23.x-6*c10.x*c21.x*c22.x*c13y3-2*c10.x*c12y3*c13.x*c23.x+6*c20.x*c21.x*c22.x*c13y3+2*c20.x*c12y3*c13.x*c23.x+2*c21.x*c12y3*c13.x*c22.x+2*c10.y*c12x3*c13.y*c23.y-6*c10.x*c10.y*c13.x*c13y2*c23.x+3*c10.x*c11.x*c12.x*c13y2*c23.y-2*c10.x*c11.x*c12.y*c13y2*c23.x-4*c10.x*c11.y*c12.x*c13y2*c23.x+3*c10.y*c11.x*c12.x*c13y2*c23.x+6*c10.x*c10.y*c13x2*c13.y*c23.y+6*c10.x*c20.x*c13.x*c13y2*c23.y-3*c10.x*c11.y*c12.y*c13x2*c23.y+2*c10.x*c12.x*c12y2*c13.x*c23.y+2*c10.x*c12.x*c12y2*c13.y*c23.x+6*c10.x*c20.y*c13.x*c13y2*c23.x+6*c10.x*c21.x*c13.x*c13y2*c22.y+6*c10.x*c13.x*c21.y*c22.x*c13y2+4*c10.y*c11.x*c12.y*c13x2*c23.y+6*c10.y*c20.x*c13.x*c13y2*c23.x+2*c10.y*c11.y*c12.x*c13x2*c23.y-3*c10.y*c11.y*c12.y*c13x2*c23.x+2*c10.y*c12.x*c12y2*c13.x*c23.x+6*c10.y*c21.x*c13.x*c22.x*c13y2-3*c11.x*c20.x*c12.x*c13y2*c23.y+2*c11.x*c20.x*c12.y*c13y2*c23.x+c11.x*c11.y*c12y2*c13.x*c23.x-3*c11.x*c12.x*c20.y*c13y2*c23.x-3*c11.x*c12.x*c21.x*c13y2*c22.y-3*c11.x*c12.x*c21.y*c22.x*c13y2+2*c11.x*c21.x*c12.y*c22.x*c13y2+4*c20.x*c11.y*c12.x*c13y2*c23.x+4*c11.y*c12.x*c21.x*c22.x*c13y2-2*c10.x*c12x2*c12.y*c13.y*c23.y-6*c10.y*c20.x*c13x2*c13.y*c23.y-6*c10.y*c20.y*c13x2*c13.y*c23.x-6*c10.y*c21.x*c13x2*c13.y*c22.y-2*c10.y*c12x2*c12.y*c13.x*c23.y-2*c10.y*c12x2*c12.y*c13.y*c23.x-6*c10.y*c13x2*c21.y*c22.x*c13.y-c11.x*c11.y*c12x2*c13.y*c23.y-2*c11.x*c11y2*c13.x*c13.y*c23.x+3*c20.x*c11.y*c12.y*c13x2*c23.y-2*c20.x*c12.x*c12y2*c13.x*c23.y-2*c20.x*c12.x*c12y2*c13.y*c23.x-6*c20.x*c20.y*c13.x*c13y2*c23.x-6*c20.x*c21.x*c13.x*c13y2*c22.y-6*c20.x*c13.x*c21.y*c22.x*c13y2+3*c11.y*c20.y*c12.y*c13x2*c23.x+3*c11.y*c21.x*c12.y*c13x2*c22.y+3*c11.y*c12.y*c13x2*c21.y*c22.x-2*c12.x*c20.y*c12y2*c13.x*c23.x-2*c12.x*c21.x*c12y2*c13.x*c22.y-2*c12.x*c21.x*c12y2*c22.x*c13.y-2*c12.x*c12y2*c13.x*c21.y*c22.x-6*c20.y*c21.x*c13.x*c22.x*c13y2-c11y2*c12.x*c12.y*c13.x*c23.x+2*c20.x*c12x2*c12.y*c13.y*c23.y+6*c20.y*c13x2*c21.y*c22.x*c13.y+2*c11x2*c11.y*c13.x*c13.y*c23.y+c11x2*c12.x*c12.y*c13.y*c23.y+2*c12x2*c20.y*c12.y*c13.y*c23.x+2*c12x2*c21.x*c12.y*c13.y*c22.y+2*c12x2*c12.y*c21.y*c22.x*c13.y+c21x3*c13y3+3*c10x2*c13y3*c23.x-3*c10y2*c13x3*c23.y+3*c20x2*c13y3*c23.x+c11y3*c13x2*c23.x-c11x3*c13y2*c23.y-c11.x*c11y2*c13x2*c23.y+c11x2*c11.y*c13y2*c23.x-3*c10x2*c13.x*c13y2*c23.y+3*c10y2*c13x2*c13.y*c23.x-c11x2*c12y2*c13.x*c23.y+c11y2*c12x2*c13.y*c23.x-3*c21x2*c13.x*c21.y*c13y2-3*c20x2*c13.x*c13y2*c23.y+3*c20y2*c13x2*c13.y*c23.x+c11.x*c12.x*c13.x*c13.y*(6*c20.y*c23.y+6*c21.y*c22.y)+c12x3*c13.y*(-2*c20.y*c23.y-2*c21.y*c22.y)+c10.y*c13x3*(6*c20.y*c23.y+6*c21.y*c22.y)+c11.y*c12.x*c13x2*(-2*c20.y*c23.y-2*c21.y*c22.y)+c12x2*c12.y*c13.x*(2*c20.y*c23.y+2*c21.y*c22.y)+c11.x*c12.y*c13x2*(-4*c20.y*c23.y-4*c21.y*c22.y)+c10.x*c13x2*c13.y*(-6*c20.y*c23.y-6*c21.y*c22.y)+c20.x*c13x2*c13.y*(6*c20.y*c23.y+6*c21.y*c22.y)+c21.x*c13x2*c13.y*(6*c20.y*c22.y+3*c21y2)+c13x3*(-2*c20.y*c21.y*c22.y-c20y2*c23.y-c21.y*(2*c20.y*c22.y+c21y2)-c20.y*(2*c20.y*c23.y+2*c21.y*c22.y)),-c10.x*c11.x*c12.y*c13.x*c13.y*c22.y+c10.x*c11.y*c12.x*c13.x*c13.y*c22.y+6*c10.x*c11.y*c12.y*c13.x*c22.x*c13.y-6*c10.y*c11.x*c12.x*c13.x*c13.y*c22.y-c10.y*c11.x*c12.y*c13.x*c22.x*c13.y+c10.y*c11.y*c12.x*c13.x*c22.x*c13.y+c11.x*c11.y*c12.x*c12.y*c13.x*c22.y-c11.x*c11.y*c12.x*c12.y*c22.x*c13.y+c11.x*c20.x*c12.y*c13.x*c13.y*c22.y+c11.x*c20.y*c12.y*c13.x*c22.x*c13.y+c11.x*c21.x*c12.y*c13.x*c21.y*c13.y-c20.x*c11.y*c12.x*c13.x*c13.y*c22.y-6*c20.x*c11.y*c12.y*c13.x*c22.x*c13.y-c11.y*c12.x*c20.y*c13.x*c22.x*c13.y-c11.y*c12.x*c21.x*c13.x*c21.y*c13.y-6*c10.x*c20.x*c22.x*c13y3-2*c10.x*c12y3*c13.x*c22.x+2*c20.x*c12y3*c13.x*c22.x+2*c10.y*c12x3*c13.y*c22.y-6*c10.x*c10.y*c13.x*c22.x*c13y2+3*c10.x*c11.x*c12.x*c13y2*c22.y-2*c10.x*c11.x*c12.y*c22.x*c13y2-4*c10.x*c11.y*c12.x*c22.x*c13y2+3*c10.y*c11.x*c12.x*c22.x*c13y2+6*c10.x*c10.y*c13x2*c13.y*c22.y+6*c10.x*c20.x*c13.x*c13y2*c22.y-3*c10.x*c11.y*c12.y*c13x2*c22.y+2*c10.x*c12.x*c12y2*c13.x*c22.y+2*c10.x*c12.x*c12y2*c22.x*c13.y+6*c10.x*c20.y*c13.x*c22.x*c13y2+6*c10.x*c21.x*c13.x*c21.y*c13y2+4*c10.y*c11.x*c12.y*c13x2*c22.y+6*c10.y*c20.x*c13.x*c22.x*c13y2+2*c10.y*c11.y*c12.x*c13x2*c22.y-3*c10.y*c11.y*c12.y*c13x2*c22.x+2*c10.y*c12.x*c12y2*c13.x*c22.x-3*c11.x*c20.x*c12.x*c13y2*c22.y+2*c11.x*c20.x*c12.y*c22.x*c13y2+c11.x*c11.y*c12y2*c13.x*c22.x-3*c11.x*c12.x*c20.y*c22.x*c13y2-3*c11.x*c12.x*c21.x*c21.y*c13y2+4*c20.x*c11.y*c12.x*c22.x*c13y2-2*c10.x*c12x2*c12.y*c13.y*c22.y-6*c10.y*c20.x*c13x2*c13.y*c22.y-6*c10.y*c20.y*c13x2*c22.x*c13.y-6*c10.y*c21.x*c13x2*c21.y*c13.y-2*c10.y*c12x2*c12.y*c13.x*c22.y-2*c10.y*c12x2*c12.y*c22.x*c13.y-c11.x*c11.y*c12x2*c13.y*c22.y-2*c11.x*c11y2*c13.x*c22.x*c13.y+3*c20.x*c11.y*c12.y*c13x2*c22.y-2*c20.x*c12.x*c12y2*c13.x*c22.y-2*c20.x*c12.x*c12y2*c22.x*c13.y-6*c20.x*c20.y*c13.x*c22.x*c13y2-6*c20.x*c21.x*c13.x*c21.y*c13y2+3*c11.y*c20.y*c12.y*c13x2*c22.x+3*c11.y*c21.x*c12.y*c13x2*c21.y-2*c12.x*c20.y*c12y2*c13.x*c22.x-2*c12.x*c21.x*c12y2*c13.x*c21.y-c11y2*c12.x*c12.y*c13.x*c22.x+2*c20.x*c12x2*c12.y*c13.y*c22.y-3*c11.y*c21x2*c12.y*c13.x*c13.y+6*c20.y*c21.x*c13x2*c21.y*c13.y+2*c11x2*c11.y*c13.x*c13.y*c22.y+c11x2*c12.x*c12.y*c13.y*c22.y+2*c12x2*c20.y*c12.y*c22.x*c13.y+2*c12x2*c21.x*c12.y*c21.y*c13.y-3*c10.x*c21x2*c13y3+3*c20.x*c21x2*c13y3+3*c10x2*c22.x*c13y3-3*c10y2*c13x3*c22.y+3*c20x2*c22.x*c13y3+c21x2*c12y3*c13.x+c11y3*c13x2*c22.x-c11x3*c13y2*c22.y+3*c10.y*c21x2*c13.x*c13y2-c11.x*c11y2*c13x2*c22.y+c11.x*c21x2*c12.y*c13y2+2*c11.y*c12.x*c21x2*c13y2+c11x2*c11.y*c22.x*c13y2-c12.x*c21x2*c12y2*c13.y-3*c20.y*c21x2*c13.x*c13y2-3*c10x2*c13.x*c13y2*c22.y+3*c10y2*c13x2*c22.x*c13.y-c11x2*c12y2*c13.x*c22.y+c11y2*c12x2*c22.x*c13.y-3*c20x2*c13.x*c13y2*c22.y+3*c20y2*c13x2*c22.x*c13.y+c12x2*c12.y*c13.x*(2*c20.y*c22.y+c21y2)+c11.x*c12.x*c13.x*c13.y*(6*c20.y*c22.y+3*c21y2)+c12x3*c13.y*(-2*c20.y*c22.y-c21y2)+c10.y*c13x3*(6*c20.y*c22.y+3*c21y2)+c11.y*c12.x*c13x2*(-2*c20.y*c22.y-c21y2)+c11.x*c12.y*c13x2*(-4*c20.y*c22.y-2*c21y2)+c10.x*c13x2*c13.y*(-6*c20.y*c22.y-3*c21y2)+c20.x*c13x2*c13.y*(6*c20.y*c22.y+3*c21y2)+c13x3*(-2*c20.y*c21y2-c20y2*c22.y-c20.y*(2*c20.y*c22.y+c21y2)),-c10.x*c11.x*c12.y*c13.x*c21.y*c13.y+c10.x*c11.y*c12.x*c13.x*c21.y*c13.y+6*c10.x*c11.y*c21.x*c12.y*c13.x*c13.y-6*c10.y*c11.x*c12.x*c13.x*c21.y*c13.y-c10.y*c11.x*c21.x*c12.y*c13.x*c13.y+c10.y*c11.y*c12.x*c21.x*c13.x*c13.y-c11.x*c11.y*c12.x*c21.x*c12.y*c13.y+c11.x*c11.y*c12.x*c12.y*c13.x*c21.y+c11.x*c20.x*c12.y*c13.x*c21.y*c13.y+6*c11.x*c12.x*c20.y*c13.x*c21.y*c13.y+c11.x*c20.y*c21.x*c12.y*c13.x*c13.y-c20.x*c11.y*c12.x*c13.x*c21.y*c13.y-6*c20.x*c11.y*c21.x*c12.y*c13.x*c13.y-c11.y*c12.x*c20.y*c21.x*c13.x*c13.y-6*c10.x*c20.x*c21.x*c13y3-2*c10.x*c21.x*c12y3*c13.x+6*c10.y*c20.y*c13x3*c21.y+2*c20.x*c21.x*c12y3*c13.x+2*c10.y*c12x3*c21.y*c13.y-2*c12x3*c20.y*c21.y*c13.y-6*c10.x*c10.y*c21.x*c13.x*c13y2+3*c10.x*c11.x*c12.x*c21.y*c13y2-2*c10.x*c11.x*c21.x*c12.y*c13y2-4*c10.x*c11.y*c12.x*c21.x*c13y2+3*c10.y*c11.x*c12.x*c21.x*c13y2+6*c10.x*c10.y*c13x2*c21.y*c13.y+6*c10.x*c20.x*c13.x*c21.y*c13y2-3*c10.x*c11.y*c12.y*c13x2*c21.y+2*c10.x*c12.x*c21.x*c12y2*c13.y+2*c10.x*c12.x*c12y2*c13.x*c21.y+6*c10.x*c20.y*c21.x*c13.x*c13y2+4*c10.y*c11.x*c12.y*c13x2*c21.y+6*c10.y*c20.x*c21.x*c13.x*c13y2+2*c10.y*c11.y*c12.x*c13x2*c21.y-3*c10.y*c11.y*c21.x*c12.y*c13x2+2*c10.y*c12.x*c21.x*c12y2*c13.x-3*c11.x*c20.x*c12.x*c21.y*c13y2+2*c11.x*c20.x*c21.x*c12.y*c13y2+c11.x*c11.y*c21.x*c12y2*c13.x-3*c11.x*c12.x*c20.y*c21.x*c13y2+4*c20.x*c11.y*c12.x*c21.x*c13y2-6*c10.x*c20.y*c13x2*c21.y*c13.y-2*c10.x*c12x2*c12.y*c21.y*c13.y-6*c10.y*c20.x*c13x2*c21.y*c13.y-6*c10.y*c20.y*c21.x*c13x2*c13.y-2*c10.y*c12x2*c21.x*c12.y*c13.y-2*c10.y*c12x2*c12.y*c13.x*c21.y-c11.x*c11.y*c12x2*c21.y*c13.y-4*c11.x*c20.y*c12.y*c13x2*c21.y-2*c11.x*c11y2*c21.x*c13.x*c13.y+3*c20.x*c11.y*c12.y*c13x2*c21.y-2*c20.x*c12.x*c21.x*c12y2*c13.y-2*c20.x*c12.x*c12y2*c13.x*c21.y-6*c20.x*c20.y*c21.x*c13.x*c13y2-2*c11.y*c12.x*c20.y*c13x2*c21.y+3*c11.y*c20.y*c21.x*c12.y*c13x2-2*c12.x*c20.y*c21.x*c12y2*c13.x-c11y2*c12.x*c21.x*c12.y*c13.x+6*c20.x*c20.y*c13x2*c21.y*c13.y+2*c20.x*c12x2*c12.y*c21.y*c13.y+2*c11x2*c11.y*c13.x*c21.y*c13.y+c11x2*c12.x*c12.y*c21.y*c13.y+2*c12x2*c20.y*c21.x*c12.y*c13.y+2*c12x2*c20.y*c12.y*c13.x*c21.y+3*c10x2*c21.x*c13y3-3*c10y2*c13x3*c21.y+3*c20x2*c21.x*c13y3+c11y3*c21.x*c13x2-c11x3*c21.y*c13y2-3*c20y2*c13x3*c21.y-c11.x*c11y2*c13x2*c21.y+c11x2*c11.y*c21.x*c13y2-3*c10x2*c13.x*c21.y*c13y2+3*c10y2*c21.x*c13x2*c13.y-c11x2*c12y2*c13.x*c21.y+c11y2*c12x2*c21.x*c13.y-3*c20x2*c13.x*c21.y*c13y2+3*c20y2*c21.x*c13x2*c13.y,c10.x*c10.y*c11.x*c12.y*c13.x*c13.y-c10.x*c10.y*c11.y*c12.x*c13.x*c13.y+c10.x*c11.x*c11.y*c12.x*c12.y*c13.y-c10.y*c11.x*c11.y*c12.x*c12.y*c13.x-c10.x*c11.x*c20.y*c12.y*c13.x*c13.y+6*c10.x*c20.x*c11.y*c12.y*c13.x*c13.y+c10.x*c11.y*c12.x*c20.y*c13.x*c13.y-c10.y*c11.x*c20.x*c12.y*c13.x*c13.y-6*c10.y*c11.x*c12.x*c20.y*c13.x*c13.y+c10.y*c20.x*c11.y*c12.x*c13.x*c13.y-c11.x*c20.x*c11.y*c12.x*c12.y*c13.y+c11.x*c11.y*c12.x*c20.y*c12.y*c13.x+c11.x*c20.x*c20.y*c12.y*c13.x*c13.y-c20.x*c11.y*c12.x*c20.y*c13.x*c13.y-2*c10.x*c20.x*c12y3*c13.x+2*c10.y*c12x3*c20.y*c13.y-3*c10.x*c10.y*c11.x*c12.x*c13y2-6*c10.x*c10.y*c20.x*c13.x*c13y2+3*c10.x*c10.y*c11.y*c12.y*c13x2-2*c10.x*c10.y*c12.x*c12y2*c13.x-2*c10.x*c11.x*c20.x*c12.y*c13y2-c10.x*c11.x*c11.y*c12y2*c13.x+3*c10.x*c11.x*c12.x*c20.y*c13y2-4*c10.x*c20.x*c11.y*c12.x*c13y2+3*c10.y*c11.x*c20.x*c12.x*c13y2+6*c10.x*c10.y*c20.y*c13x2*c13.y+2*c10.x*c10.y*c12x2*c12.y*c13.y+2*c10.x*c11.x*c11y2*c13.x*c13.y+2*c10.x*c20.x*c12.x*c12y2*c13.y+6*c10.x*c20.x*c20.y*c13.x*c13y2-3*c10.x*c11.y*c20.y*c12.y*c13x2+2*c10.x*c12.x*c20.y*c12y2*c13.x+c10.x*c11y2*c12.x*c12.y*c13.x+c10.y*c11.x*c11.y*c12x2*c13.y+4*c10.y*c11.x*c20.y*c12.y*c13x2-3*c10.y*c20.x*c11.y*c12.y*c13x2+2*c10.y*c20.x*c12.x*c12y2*c13.x+2*c10.y*c11.y*c12.x*c20.y*c13x2+c11.x*c20.x*c11.y*c12y2*c13.x-3*c11.x*c20.x*c12.x*c20.y*c13y2-2*c10.x*c12x2*c20.y*c12.y*c13.y-6*c10.y*c20.x*c20.y*c13x2*c13.y-2*c10.y*c20.x*c12x2*c12.y*c13.y-2*c10.y*c11x2*c11.y*c13.x*c13.y-c10.y*c11x2*c12.x*c12.y*c13.y-2*c10.y*c12x2*c20.y*c12.y*c13.x-2*c11.x*c20.x*c11y2*c13.x*c13.y-c11.x*c11.y*c12x2*c20.y*c13.y+3*c20.x*c11.y*c20.y*c12.y*c13x2-2*c20.x*c12.x*c20.y*c12y2*c13.x-c20.x*c11y2*c12.x*c12.y*c13.x+3*c10y2*c11.x*c12.x*c13.x*c13.y+3*c11.x*c12.x*c20y2*c13.x*c13.y+2*c20.x*c12x2*c20.y*c12.y*c13.y-3*c10x2*c11.y*c12.y*c13.x*c13.y+2*c11x2*c11.y*c20.y*c13.x*c13.y+c11x2*c12.x*c20.y*c12.y*c13.y-3*c20x2*c11.y*c12.y*c13.x*c13.y-c10x3*c13y3+c10y3*c13x3+c20x3*c13y3-c20y3*c13x3-3*c10.x*c20x2*c13y3-c10.x*c11y3*c13x2+3*c10x2*c20.x*c13y3+c10.y*c11x3*c13y2+3*c10.y*c20y2*c13x3+c20.x*c11y3*c13x2+c10x2*c12y3*c13.x-3*c10y2*c20.y*c13x3-c10y2*c12x3*c13.y+c20x2*c12y3*c13.x-c11x3*c20.y*c13y2-c12x3*c20y2*c13.y-c10.x*c11x2*c11.y*c13y2+c10.y*c11.x*c11y2*c13x2-3*c10.x*c10y2*c13x2*c13.y-c10.x*c11y2*c12x2*c13.y+c10.y*c11x2*c12y2*c13.x-c11.x*c11y2*c20.y*c13x2+3*c10x2*c10.y*c13.x*c13y2+c10x2*c11.x*c12.y*c13y2+2*c10x2*c11.y*c12.x*c13y2-2*c10y2*c11.x*c12.y*c13x2-c10y2*c11.y*c12.x*c13x2+c11x2*c20.x*c11.y*c13y2-3*c10.x*c20y2*c13x2*c13.y+3*c10.y*c20x2*c13.x*c13y2+c11.x*c20x2*c12.y*c13y2-2*c11.x*c20y2*c12.y*c13x2+c20.x*c11y2*c12x2*c13.y-c11.y*c12.x*c20y2*c13x2-c10x2*c12.x*c12y2*c13.y-3*c10x2*c20.y*c13.x*c13y2+3*c10y2*c20.x*c13x2*c13.y+c10y2*c12x2*c12.y*c13.x-c11x2*c20.y*c12y2*c13.x+2*c20x2*c11.y*c12.x*c13y2+3*c20.x*c20y2*c13x2*c13.y-c20x2*c12.x*c12y2*c13.y-3*c20x2*c20.y*c13.x*c13y2+c12x2*c20y2*c12.y*c13.x),roots=poly.getRootsInInterval(0,1);for(var i=0;i<roots.length;i++){var s=roots[i],xRoots=(new Polynomial(c13.x,c12.x,c11.x,c10.x-c20.x-s*c21.x-s*s*c22.x-s*s*s*c23.x)).getRoots(),yRoots=(new Polynomial(c13.y,c12.y,c11.y,c10.y-c20.y-s*c21.y-s*s*c22.y-s*s*s*c23.y)).getRoots();if(xRoots.length>0&&yRoots.length>0){var TOLERANCE=1e-4;checkRoots:for(var j=0;j<xRoots.length;j++){var xRoot=xRoots[j];if(0<=xRoot&&xRoot<=1)for(var k=0;k<yRoots.length;k++)if(Math.abs(xRoot-yRoots[k])<TOLERANCE){result.points.push(c23.multiply(s*s*s).add(c22.multiply(s*s).add(c21.multiply(s).add(c20))));break checkRoots}}}}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier3Circle=function(p1,p2,p3,p4,c,r){return Intersection.intersectBezier3Ellipse(p1,p2,p3,p4,c,r,r)},Intersection.intersectBezier3Ellipse=function(p1,p2,p3,p4,ec,rx,ry){var a,b,c,d,c3,c2,c1,c0,result=new Intersection("No Intersection");a=p1.multiply(-1),b=p2.multiply(3),c=p3.multiply(-3),d=a.add(b.add(c.add(p4))),c3=new Vector2D(d.x,d.y),a=p1.multiply(3),b=p2.multiply(-6),c=p3.multiply(3),d=a.add(b.add(c)),c2=new Vector2D(d.x,d.y),a=p1.multiply(-3),b=p2.multiply(3),c=a.add(b),c1=new Vector2D(c.x,c.y),c0=new Vector2D(p1.x,p1.y);var rxrx=rx*rx,ryry=ry*ry,poly=new Polynomial(c3.x*c3.x*ryry+c3.y*c3.y*rxrx,2*(c3.x*c2.x*ryry+c3.y*c2.y*rxrx),2*(c3.x*c1.x*ryry+c3.y*c1.y*rxrx)+c2.x*c2.x*ryry+c2.y*c2.y*rxrx,2*c3.x*ryry*(c0.x-ec.x)+2*c3.y*rxrx*(c0.y-ec.y)+2*(c2.x*c1.x*ryry+c2.y*c1.y*rxrx),2*c2.x*ryry*(c0.x-ec.x)+2*c2.y*rxrx*(c0.y-ec.y)+c1.x*c1.x*ryry+c1.y*c1.y*rxrx,2*c1.x*ryry*(c0.x-ec.x)+2*c1.y*rxrx*(c0.y-ec.y),c0.x*c0.x*ryry-2*c0.y*ec.y*rxrx-2*c0.x*ec.x*ryry+c0.y*c0.y*rxrx+ec.x*ec.x*ryry+ec.y*ec.y*rxrx-rxrx*ryry),roots=poly.getRootsInInterval(0,1);for(var i=0;i<roots.length;i++){var t=roots[i];result.points.push(c3.multiply(t*t*t).add(c2.multiply(t*t).add(c1.multiply(t).add(c0))))}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier3Line=function(p1,p2,p3,p4,a1,a2){var a,b,c,d,c3,c2,c1,c0,cl,n,min=a1.min(a2),max=a1.max(a2),result=new Intersection("No Intersection");a=p1.multiply(-1),b=p2.multiply(3),c=p3.multiply(-3),d=a.add(b.add(c.add(p4))),c3=new Vector2D(d.x,d.y),a=p1.multiply(3),b=p2.multiply(-6),c=p3.multiply(3),d=a.add(b.add(c)),c2=new Vector2D(d.x,d.y),a=p1.multiply(-3),b=p2.multiply(3),c=a.add(b),c1=new Vector2D(c.x,c.y),c0=new Vector2D(p1.x,p1.y),n=new Vector2D(a1.y-a2.y,a2.x-a1.x),cl=a1.x*a2.y-a2.x*a1.y,roots=(new Polynomial(n.dot(c3),n.dot(c2),n.dot(c1),n.dot(c0)+cl)).getRoots();for(var i=0;i<roots.length;i++){var t=roots[i];if(0<=t&&t<=1){var p5=p1.lerp(p2,t),p6=p2.lerp(p3,t),p7=p3.lerp(p4,t),p8=p5.lerp(p6,t),p9=p6.lerp(p7,t),p10=p8.lerp(p9,t);a1.x==a2.x?min.y<=p10.y&&p10.y<=max.y&&(result.status="Intersection",result.appendPoint(p10)):a1.y==a2.y?min.x<=p10.x&&p10.x<=max.x&&(result.status="Intersection",result.appendPoint(p10)):p10.gte(min)&&p10.lte(max)&&(result.status="Intersection",result.appendPoint(p10))}}return result},Intersection.intersectBezier3Polygon=function(p1,p2,p3,p4,points){var result=new Intersection("No Intersection"),length=points.length;for(var i=0;i<length;i++){var a1=points[i],a2=points[(i+1)%length],inter=Intersection.intersectBezier3Line(p1,p2,p3,p4,a1,a2);result.appendPoints(inter.points)}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectBezier3Rectangle=function(p1,p2,p3,p4,r1,r2){var min=r1.min(r2),max=r1.max(r2),topRight=new Point2D(max.x,min.y),bottomLeft=new Point2D(min.x,max.y),inter1=Intersection.intersectBezier3Line(p1,p2,p3,p4,min,topRight),inter2=Intersection.intersectBezier3Line(p1,p2,p3,p4,topRight,max),inter3=Intersection.intersectBezier3Line(p1,p2,p3,p4,max,bottomLeft),inter4=Intersection.intersectBezier3Line(p1,p2,p3,p4,bottomLeft,min),result=new Intersection("No Intersection");return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectCircleCircle=function(c1,r1,c2,r2){var result,r_max=r1+r2,r_min=Math.abs(r1-r2),c_dist=c1.distanceFrom(c2);if(c_dist>r_max)result=new Intersection("Outside");else if(c_dist<r_min)result=new Intersection("Inside");else{result=new Intersection("Intersection");var a=(r1*r1-r2*r2+c_dist*c_dist)/(2*c_dist),h=Math.sqrt(r1*r1-a*a),p=c1.lerp(c2,a/c_dist),b=h/c_dist;result.points.push(new Point2D(p.x-b*(c2.y-c1.y),p.y+b*(c2.x-c1.x))),result.points.push(new Point2D(p.x+b*(c2.y-c1.y),p.y-b*(c2.x-c1.x)))}return result},Intersection.intersectCircleEllipse=function(cc,r,ec,rx,ry){return Intersection.intersectEllipseEllipse(cc,r,r,ec,rx,ry)},Intersection.intersectCircleLine=function(c,r,a1,a2){var result,a=(a2.x-a1.x)*(a2.x-a1.x)+(a2.y-a1.y)*(a2.y-a1.y),b=2*((a2.x-a1.x)*(a1.x-c.x)+(a2.y-a1.y)*(a1.y-c.y)),cc=c.x*c.x+c.y*c.y+a1.x*a1.x+a1.y*a1.y-2*(c.x*a1.x+c.y*a1.y)-r*r,deter=b*b-4*a*cc;if(deter<0)result=new Intersection("Outside");else if(deter==0)result=new Intersection("Tangent");else{var e=Math.sqrt(deter),u1=(-b+e)/(2*a),u2=(-b-e)/(2*a);(u1<0||u1>1)&&(u2<0||u2>1)?u1<0&&u2<0||u1>1&&u2>1?result=new Intersection("Outside"):result=new Intersection("Inside"):(result=new Intersection("Intersection"),0<=u1&&u1<=1&&result.points.push(a1.lerp(a2,u1)),0<=u2&&u2<=1&&result.points.push(a1.lerp(a2,u2)))}return result},Intersection.intersectCirclePolygon=function(c,r,points){var result=new Intersection("No Intersection"),length=points.length,inter;for(var i=0;i<length;i++){var a1=points[i],a2=points[(i+1)%length];inter=Intersection.intersectCircleLine(c,r,a1,a2),result.appendPoints(inter.points)}return result.points.length>0?result.status="Intersection":result.status=inter.status,result},Intersection.intersectCircleRectangle=function(c,r,r1,r2){var min=r1.min(r2),max=r1.max(r2),topRight=new Point2D(max.x,min.y),bottomLeft=new Point2D(min.x,max.y),inter1=Intersection.intersectCircleLine(c,r,min,topRight),inter2=Intersection.intersectCircleLine(c,r,topRight,max),inter3=Intersection.intersectCircleLine(c,r,max,bottomLeft),inter4=Intersection.intersectCircleLine(c,r,bottomLeft,min),result=new Intersection("No Intersection");return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0?result.status="Intersection":result.status=inter1.status,result},Intersection.intersectEllipseEllipse=function(c1,rx1,ry1,c2,rx2,ry2){var a=[ry1*ry1,0,rx1*rx1,-2*ry1*ry1*c1.x,-2*rx1*rx1*c1.y,ry1*ry1*c1.x*c1.x+rx1*rx1*c1.y*c1.y-rx1*rx1*ry1*ry1],b=[ry2*ry2,0,rx2*rx2,-2*ry2*ry2*c2.x,-2*rx2*rx2*c2.y,ry2*ry2*c2.x*c2.x+rx2*rx2*c2.y*c2.y-rx2*rx2*ry2*ry2],yPoly=Intersection.bezout(a,b),yRoots=yPoly.getRoots(),epsilon=.001,norm0=(a[0]*a[0]+2*a[1]*a[1]+a[2]*a[2])*epsilon,norm1=(b[0]*b[0]+2*b[1]*b[1]+b[2]*b[2])*epsilon,result=new Intersection("No Intersection");for(var y=0;y<yRoots.length;y++){var xPoly=new Polynomial(a[0],a[3]+yRoots[y]*a[1],a[5]+yRoots[y]*(a[4]+yRoots[y]*a[2])),xRoots=xPoly.getRoots();for(var x=0;x<xRoots.length;x++){var test=(a[0]*xRoots[x]+a[1]*yRoots[y]+a[3])*xRoots[x]+(a[2]*yRoots[y]+a[4])*yRoots[y]+a[5];Math.abs(test)<norm0&&(test=(b[0]*xRoots[x]+b[1]*yRoots[y]+b[3])*xRoots[x]+(b[2]*yRoots[y]+b[4])*yRoots[y]+b[5],Math.abs(test)<norm1&&result.appendPoint(new Point2D(xRoots[x],yRoots[y])))}}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectEllipseLine=function(c,rx,ry,a1,a2){var result,origin=new Vector2D(a1.x,a1.y),dir=Vector2D.fromPoints(a1,a2),center=new Vector2D(c.x,c.y),diff=origin.subtract(center),mDir=new Vector2D(dir.x/(rx*rx),dir.y/(ry*ry)),mDiff=new Vector2D(diff.x/(rx*rx),diff.y/(ry*ry)),a=dir.dot(mDir),b=dir.dot(mDiff),c=diff.dot(mDiff)-1,d=b*b-a*c;if(d<0)result=new Intersection("Outside");else if(d>0){var root=Math.sqrt(d),t_a=(-b-root)/a,t_b=(-b+root)/a;(t_a<0||1<t_a)&&(t_b<0||1<t_b)?t_a<0&&t_b<0||t_a>1&&t_b>1?result=new Intersection("Outside"):result=new Intersection("Inside"):(result=new Intersection("Intersection"),0<=t_a&&t_a<=1&&result.appendPoint(a1.lerp(a2,t_a)),0<=t_b&&t_b<=1&&result.appendPoint(a1.lerp(a2,t_b)))}else{var t=-b/a;0<=t&&t<=1?(result=new Intersection("Intersection"),result.appendPoint(a1.lerp(a2,t))):result=new Intersection("Outside")}return result},Intersection.intersectEllipsePolygon=function(c,rx,ry,points){var result=new Intersection("No Intersection"),length=points.length;for(var i=0;i<length;i++){var b1=points[i],b2=points[(i+1)%length],inter=Intersection.intersectEllipseLine(c,rx,ry,b1,b2);result.appendPoints(inter.points)}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectEllipseRectangle=function(c,rx,ry,r1,r2){var min=r1.min(r2),max=r1.max(r2),topRight=new Point2D(max.x,min.y),bottomLeft=new Point2D(min.x,max.y),inter1=Intersection.intersectEllipseLine(c,rx,ry,min,topRight),inter2=Intersection.intersectEllipseLine(c,rx,ry,topRight,max),inter3=Intersection.intersectEllipseLine(c,rx,ry,max,bottomLeft),inter4=Intersection.intersectEllipseLine(c,rx,ry,bottomLeft,min),result=new Intersection("No Intersection");return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectLineLine=function(a1,a2,b1,b2){var result,ua_t=(b2.x-b1.x)*(a1.y-b1.y)-(b2.y-b1.y)*(a1.x-b1.x),ub_t=(a2.x-a1.x)*(a1.y-b1.y)-(a2.y-a1.y)*(a1.x-b1.x),u_b=(b2.y-b1.y)*(a2.x-a1.x)-(b2.x-b1.x)*(a2.y-a1.y);if(u_b!=0){var ua=ua_t/u_b,ub=ub_t/u_b;0<=ua&&ua<=1&&0<=ub&&ub<=1?(result=new Intersection("Intersection"),result.points.push({x:a1.x+ua*(a2.x-a1.x),y:a1.y+ua*(a2.y-a1.y)})):result=new Intersection("No Intersection")}else ua_t==0||ub_t==0?result=new Intersection("Coincident"):result=new Intersection("Parallel");return result},Intersection.intersectLinePolygon=function(a1,a2,points){var result=new Intersection("No Intersection"),length=points.length;for(var i=0;i<length;i++){var b1=points[i],b2=points[(i+1)%length],inter=Intersection.intersectLineLine(a1,a2,b1,b2);result.appendPoints(inter.points)}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectLineRectangle=function(a1,a2,r1,r2){var min=r1.min(r2),max=r1.max(r2),topRight=new Point2D(max.x,min.y),bottomLeft=new Point2D(min.x,max.y),inter1=Intersection.intersectLineLine(min,topRight,a1,a2),inter2=Intersection.intersectLineLine(topRight,max,a1,a2),inter3=Intersection.intersectLineLine(max,bottomLeft,a1,a2),inter4=Intersection.intersectLineLine(bottomLeft,min,a1,a2),result=new Intersection("No Intersection");return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectPolygonPolygon=function(points1,points2){var result=new Intersection("No Intersection"),length=points1.length;for(var i=0;i<length;i++){var a1=points1[i],a2=points1[(i+1)%length],inter=Intersection.intersectLinePolygon(a1,a2,points2);result.appendPoints(inter.points)}return result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectPolygonRectangle=function(points,r1,r2){var min=r1.min(r2),max=r1.max(r2),topRight=new Point2D(max.x,min.y),bottomLeft=new Point2D(min.x,max.y),inter1=Intersection.intersectLinePolygon(min,topRight,points),inter2=Intersection.intersectLinePolygon(topRight,max,points),inter3=Intersection.intersectLinePolygon(max,bottomLeft,points),inter4=Intersection.intersectLinePolygon(bottomLeft,min,points),result=new Intersection("No Intersection");return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0&&(result.status="Intersection"),result},Intersection.intersectRayRay=function(a1,a2,b1,b2){var result,ua_t=(b2.x-b1.x)*(a1.y-b1.y)-(b2.y-b1.y)*(a1.x-b1.x),ub_t=(a2.x-a1.x)*(a1.y-b1.y)-(a2.y-a1.y)*(a1.x-b1.x),u_b=(b2.y-b1.y)*(a2.x-a1.x)-(b2.x-b1.x)*(a2.y-a1.y);if(u_b!=0){var ua=ua_t/u_b;result=new Intersection("Intersection"),result.points.push(new Point2D(a1.x+ua*(a2.x-a1.x),a1.y+ua*(a2.y-a1.y)))}else ua_t==0||ub_t==0?result=new Intersection("Coincident"):result=new Intersection("Parallel");return result},Intersection.intersectRectangleRectangle=function(a1,a2,b1,b2){var min=a1.min(a2),max=a1.max(a2),topRight=new Point2D(max.x,min.y),bottomLeft=new Point2D(min.x,max.y),inter1=Intersection.intersectLineRectangle(min,topRight,b1,b2),inter2=Intersection.intersectLineRectangle(topRight,max,b1,b2),inter3=Intersection.intersectLineRectangle(max,bottomLeft,b1,b2),inter4=Intersection.intersectLineRectangle(bottomLeft,min,b1,b2),result=new Intersection("No Intersection");return result.appendPoints(inter1.points),result.appendPoints(inter2.points),result.appendPoints(inter3.points),result.appendPoints(inter4.points),result.points.length>0&&(result.status="Intersection"),result},Intersection.bezout=function(e1,e2){var AB=e1[0]*e2[1]-e2[0]*e1[1],AC=e1[0]*e2[2]-e2[0]*e1[2],AD=e1[0]*e2[3]-e2[0]*e1[3],AE=e1[0]*e2[4]-e2[0]*e1[4],AF=e1[0]*e2[5]-e2[0]*e1[5],BC=e1[1]*e2[2]-e2[1]*e1[2],BE=e1[1]*e2[4]-e2[1]*e1[4],BF=e1[1]*e2[5]-e2[1]*e1[5],CD=e1[2]*e2[3]-e2[2]*e1[3],DE=e1[3]*e2[4]-e2[3]*e1[4],DF=e1[3]*e2[5]-e2[3]*e1[5],BFpDE=BF+DE,BEmCD=BE-CD;return new Polynomial(AB*BC-AC*AC,AB*BEmCD+AD*BC-2*AC*AE,AB*BFpDE+AD*BEmCD-AE*AE-2*AC*AF,AB*DF+AD*BFpDE-2*AE*AF,AD*DF-AF*AF)},define("intersection",function(){});var KeyCodes;(function(KeyCodes){var KeyDown;(function(KeyDown){KeyDown.Backspace=8,KeyDown.Tab=9,KeyDown.Enter=13,KeyDown.Shift=16,KeyDown.Ctrl=17,KeyDown.Alt=18,KeyDown.PauseBreak=19,KeyDown.CapsLock=20,KeyDown.Escape=27,KeyDown.Spacebar=32,KeyDown.PageUp=33,KeyDown.PageDown=34,KeyDown.End=35,KeyDown.Home=36,KeyDown.LeftArrow=37,KeyDown.UpArrow=38,KeyDown.RightArrow=39,KeyDown.DownArrow=40,KeyDown.PrintScrn=44,KeyDown.Insert=45,KeyDown.Delete=46,KeyDown.Zero=48,KeyDown.One=49,KeyDown.Two=50,KeyDown.Three=51,KeyDown.Four=52,KeyDown.Five=53,KeyDown.Six=54,KeyDown.Seven=55,KeyDown.Eight=56,KeyDown.Nine=57,KeyDown.a=65,KeyDown.b=66,KeyDown.c=67,KeyDown.d=68,KeyDown.e=69,KeyDown.f=70,KeyDown.g=71,KeyDown.h=72,KeyDown.i=73,KeyDown.j=74,KeyDown.k=75,KeyDown.l=76,KeyDown.m=77,KeyDown.n=78,KeyDown.o=79,KeyDown.p=80,KeyDown.q=81,KeyDown.r=82,KeyDown.s=83,KeyDown.t=84,KeyDown.u=85,KeyDown.v=86,KeyDown.w=87,KeyDown.x=88,KeyDown.y=89,KeyDown.z=90,KeyDown.LeftWindowKey=91,KeyDown.RightWindowKey=92,KeyDown.SelectKey=93,KeyDown.Numpad0=96,KeyDown.Numpad1=97,KeyDown.Numpad2=98,KeyDown.Numpad3=99,KeyDown.Numpad4=100,KeyDown.Numpad5=101,KeyDown.Numpad6=102,KeyDown.Numpad7=103,KeyDown.Numpad8=104,KeyDown.Numpad9=105,KeyDown.Multiply=106,KeyDown.NumpadPlus=107,KeyDown.NumpadMinus=109,KeyDown.DecimalPoint=110,KeyDown.Divide=111,KeyDown.F1=112,KeyDown.F2=113,KeyDown.F3=114,KeyDown.F4=115,KeyDown.F5=116,KeyDown.F6=117,KeyDown.F7=118,KeyDown.F8=119,KeyDown.F9=120,KeyDown.F10=121,KeyDown.F11=122,KeyDown.F12=123,KeyDown.NumLock=144,KeyDown.ScrollLock=145,KeyDown.Semicolon=186,KeyDown.Equals=187,KeyDown.Comma=188,KeyDown.LessThan=188,KeyDown.Dash=189,KeyDown.Period=190,KeyDown.GreaterThan=190,KeyDown.ForwardSlash=191,KeyDown.QuestionMark=191,KeyDown.GraveAccent=192,KeyDown.Tilde=192,KeyDown.OpenCurlyBracket=219,KeyDown.OpenSquareBracket=219,KeyDown.BackSlash=220,KeyDown.VerticalPipe=220,KeyDown.CloseCurlyBracket=221,KeyDown.CloseSquareBracket=221,KeyDown.Quote=222,KeyDown.CommandFF=224})(KeyDown=KeyCodes.KeyDown||(KeyCodes.KeyDown={}))})(KeyCodes||(KeyCodes={}));var KeyCodes;(function(KeyCodes){var KeyPress;(function(KeyPress){KeyPress.Backspace=8,KeyPress.Enter=13,KeyPress.Spacebar=32,KeyPress.Hash=35,KeyPress.GraveAccent=39,KeyPress.ForwardSlash=32,KeyPress.Asterisk=42,KeyPress.Plus=43,KeyPress.Comma=44,KeyPress.Minus=45,KeyPress.Period=46,KeyPress.ForwardSlash=47,KeyPress.Zero=48,KeyPress.One=49,KeyPress.Two=50,KeyPress.Three=51,KeyPress.Four=52,KeyPress.Five=53,KeyPress.Six=54,KeyPress.Seven=55,KeyPress.Eight=56,KeyPress.Nine=57,KeyPress.Colon=58,KeyPress.Semicolon=59,KeyPress.LessThan=60,KeyPress.Equals=61,KeyPress.GreaterThan=62,KeyPress.QuestionMark=63,KeyPress.At=64,KeyPress.OpenSquareBracket=91,KeyPress.BackSlash=92,KeyPress.CloseSquareBracket=93,KeyPress.a=97,KeyPress.b=98,KeyPress.c=99,KeyPress.d=100,KeyPress.e=101,KeyPress.f=102,KeyPress.g=103,KeyPress.h=104,KeyPress.i=105,KeyPress.j=106,KeyPress.k=107,KeyPress.l=108,KeyPress.m=109,KeyPress.n=110,KeyPress.o=111,KeyPress.p=112,KeyPress.q=113,KeyPress.r=114,KeyPress.s=115,KeyPress.t=116,KeyPress.u=117,KeyPress.v=118,KeyPress.w=119,KeyPress.x=120,KeyPress.y=121,KeyPress.z=122,KeyPress.OpenCurlyBracket=123,KeyPress.VerticalPipe=124,KeyPress.CloseCurlyBracket=125,KeyPress.Tilde=126})(KeyPress=KeyCodes.KeyPress||(KeyCodes.KeyPress={}))})(KeyCodes||(KeyCodes={})),define("keycodes",function(){}),typeof Worker=="undefined"||typeof location!="undefined"&&location.protocol==="file:"?typeof global!="undefined"&&typeof require!="undefined"?this.LZMA=function(lzma_path){return require(lzma_path||"./lzma_worker.js").LZMA}:typeof window!="undefined"&&window.document?function(){var that=this,global_var,req=function req(path){var script_tag=document.createElement("script");script_tag.type="text/javascript",script_tag.src=path,script_tag.onload=function(){that.LZMA=non_worker_lzma},document.getElementsByTagName("head")[0].appendChild(script_tag)};typeof window!="undefined"?global_var=window:global&&(global_var=global);function non_worker_lzma(path){var fake_lzma;return req(path),fake_lzma={compress:function compress(mixed,mode,on_finish,on_progress){global_var.LZMA_WORKER?global_var.LZMA_WORKER.compress(mixed,mode,on_finish,on_progress):setTimeout(function(){fake_lzma.compress(mixed,mode,on_finish,on_progress)},50)},decompress:function decompress(byte_arr,on_finish,on_progress){global_var.LZMA_WORKER?global_var.LZMA_WORKER.decompress(byte_arr,on_finish,on_progress):setTimeout(function(){fake_lzma.decompress(byte_arr,on_finish,on_progress)},50)},worker:function worker(){return null}},fake_lzma}that.LZMA=non_worker_lzma}():console.error("Can't load the worker. Sorry."):this.LZMA=function(lzma_path){var action_compress=1,action_decompress=2,action_progress=3,callback_obj={},lzma_worker=new Worker(lzma_path||"./lzma_worker-min.js");return lzma_worker.onmessage=function onmessage(e){e.data.action===action_progress?callback_obj[e.data.cbn]&&typeof callback_obj[e.data.cbn].on_progress=="function"&&callback_obj[e.data.cbn].on_progress(e.data.result):callback_obj[e.data.cbn]&&typeof callback_obj[e.data.cbn].on_finish=="function"&&(callback_obj[e.data.cbn].on_finish(e.data.result,e.data.error),delete callback_obj[e.data.cbn])},lzma_worker.onerror=function(event){var err=new Error(event.message+" ("+event.filename+":"+event.lineno+")");for(var cbn in callback_obj)callback_obj[cbn].on_finish(null,err);console.error("Uncaught error in lzma_worker",err)},function(){function send_to_worker(action,data,mode,on_finish,on_progress){var cbn;do cbn=Math.floor(Math.random()*1e7);while(typeof callback_obj[cbn]!="undefined");callback_obj[cbn]={on_finish:on_finish,on_progress:on_progress},lzma_worker.postMessage({action:action,cbn:cbn,data:data,mode:mode})}return{compress:function compress(mixed,mode,on_finish,on_progress){send_to_worker(action_compress,mixed,mode,on_finish,on_progress)},decompress:function decompress(byte_arr,on_finish,on_progress){send_to_worker(action_decompress,byte_arr,!1,on_finish,on_progress)},worker:function worker(){return lzma_worker}}}()},define("lzma",function(){}),function(window){var WORKER_PATH="recorderWorker.js",RecorderJS=function(source,cfg){var config=cfg||{},bufferLen=config.bufferLen||4096;this.context=source.context,this.context.createScriptProcessor?this.node=this.context.createScriptProcessor(bufferLen,2,2):this.node=this.context.createJavaScriptNode(bufferLen,2,2);var worker=new Worker(config.workerPath||WORKER_PATH);worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate}});var recording=!1,currCallback;this.node.onaudioprocess=function(e){if(!recording)return;worker.postMessage({command:"record",buffer:[e.inputBuffer.getChannelData(0),e.inputBuffer.getChannelData(1)]})},this.configure=function(cfg){for(var prop in cfg)cfg.hasOwnProperty(prop)&&(config[prop]=cfg[prop])},this.record=function(){recording=!0},this.stop=function(){recording=!1},this.clear=function(){worker.postMessage({command:"clear"})},this.getBuffers=function(cb){currCallback=cb||config.callback,worker.postMessage({command:"getBuffers"})},this.exportWAV=function(cb,type){currCallback=cb||config.callback,type=type||config.type||"audio/wav";if(!currCallback)throw new Error("Callback not set");worker.postMessage({command:"exportWAV",type:type})},this.exportMonoWAV=function(cb,type){currCallback=cb||config.callback,type=type||config.type||"audio/wav";if(!currCallback)throw new Error("Callback not set");worker.postMessage({command:"exportMonoWAV",type:type})},this.setupDownload=function(blob,filename){var url=(window.URL||window.webkitURL).createObjectURL(blob),link=window.document.createElement("a");link.href=url,link.download=filename||"output.wav",document.body.appendChild(link),link.innerHTML="DOWNLOAD";var click=document.createEvent("Event");click.initEvent("click",!0,!0),link.dispatchEvent(click)},worker.onmessage=function(e){var blob=e.data;currCallback(blob)},source.connect(this.node),this.node.connect(this.context.destination)};window.RecorderJS=RecorderJS}(window),define("Recorderjs/recorder",function(){}),define("Tone/signal/SignalBase",["Tone/core/Tone"],function(Tone){"use strict";return Tone.SignalBase=function(){},Tone.extend(Tone.SignalBase),Tone.SignalBase.prototype.connect=function(node,outputNumber,inputNumber){return Tone.Signal&&Tone.Signal===node.constructor||Tone.Param&&Tone.Param===node.constructor||Tone.TimelineSignal&&Tone.TimelineSignal===node.constructor?(node._param.cancelScheduledValues(0),node._param.value=0,node.overridden=!0):node instanceof AudioParam&&(node.cancelScheduledValues(0),node.value=0),Tone.prototype.connect.call(this,node,outputNumber,inputNumber),this},Tone.SignalBase}),define("Tone/signal/WaveShaper",["Tone/core/Tone","Tone/signal/SignalBase"],function(Tone){"use strict";return Tone.WaveShaper=function(mapping,bufferLen){this._shaper=this.input=this.output=this.context.createWaveShaper(),this._curve=null,Array.isArray(mapping)?this.curve=mapping:isFinite(mapping)||this.isUndef(mapping)?this._curve=new Float32Array(this.defaultArg(mapping,1024)):this.isFunction(mapping)&&(this._curve=new Float32Array(this.defaultArg(bufferLen,1024)),this.setMap(mapping))},Tone.extend(Tone.WaveShaper,Tone.SignalBase),Tone.WaveShaper.prototype.setMap=function(mapping){for(var i=0,len=this._curve.length;i<len;i++){var normalized=i/len*2-1;this._curve[i]=mapping(normalized,i)}return this._shaper.curve=this._curve,this},Object.defineProperty(Tone.WaveShaper.prototype,"curve",{get:function(){return this._shaper.curve},set:function(mapping){this._curve=new Float32Array(mapping),this._shaper.curve=this._curve}}),Object.defineProperty(Tone.WaveShaper.prototype,"oversample",{get:function(){return this._shaper.oversample},set:function(oversampling){if(["none","2x","4x"].indexOf(oversampling)===-1)throw new Error("invalid oversampling: "+oversampling);this._shaper.oversample=oversampling}}),Tone.WaveShaper.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._shaper.disconnect(),this._shaper=null,this._curve=null,this},Tone.WaveShaper}),define("Tone/core/Type",["Tone/core/Tone"],function(Tone){"use strict";Tone.Type={Default:"number",Time:"time",Frequency:"frequency",NormalRange:"normalRange",AudioRange:"audioRange",Decibels:"db",Interval:"interval",BPM:"bpm",Positive:"positive",Cents:"cents",Degrees:"degrees",MIDI:"midi",TransportTime:"transportTime",Ticks:"tick",Note:"note",Milliseconds:"milliseconds",Notation:"notation"},Tone.prototype.isNowRelative=function(){var nowRelative=new RegExp(/^\s*\+(.)+/i);return function(note){return nowRelative.test(note)}}(),Tone.prototype.isTicks=function(){var tickFormat=new RegExp(/^\d+i$/i);return function(note){return tickFormat.test(note)}}(),Tone.prototype.isNotation=function(){var notationFormat=new RegExp(/^[0-9]+[mnt]$/i);return function(note){return notationFormat.test(note)}}(),Tone.prototype.isTransportTime=function(){var transportTimeFormat=new RegExp(/^(\d+(\.\d+)?\:){1,2}(\d+(\.\d+)?)?$/i);return function(transportTime){return transportTimeFormat.test(transportTime)}}(),Tone.prototype.isNote=function(){var noteFormat=new RegExp(/^[a-g]{1}(b|#|x|bb)?-?[0-9]+$/i);return function(note){return noteFormat.test(note)}}(),Tone.prototype.isFrequency=function(){var freqFormat=new RegExp(/^\d*\.?\d+hz$/i);return function(freq){return freqFormat.test(freq)}}();function getTransportBpm(){return Tone.Transport&&Tone.Transport.bpm?Tone.Transport.bpm.value:120}function getTransportTimeSignature(){return Tone.Transport&&Tone.Transport.timeSignature?Tone.Transport.timeSignature:4}Tone.prototype.notationToSeconds=function(notation,bpm,timeSignature){bpm=this.defaultArg(bpm,getTransportBpm()),timeSignature=this.defaultArg(timeSignature,getTransportTimeSignature());var beatTime=60/bpm;notation==="1n"&&(notation="1m");var subdivision=parseInt(notation,10),beats=0;subdivision===0&&(beats=0);var lastLetter=notation.slice(-1);return lastLetter==="t"?beats=4/subdivision*2/3:lastLetter==="n"?beats=4/subdivision:lastLetter==="m"?beats=subdivision*timeSignature:beats=0,beatTime*beats},Tone.prototype.transportTimeToSeconds=function(transportTime,bpm,timeSignature){bpm=this.defaultArg(bpm,getTransportBpm()),timeSignature=this.defaultArg(timeSignature,getTransportTimeSignature());var measures=0,quarters=0,sixteenths=0,split=transportTime.split(":");split.length===2?(measures=parseFloat(split[0]),quarters=parseFloat(split[1])):split.length===1?quarters=parseFloat(split[0]):split.length===3&&(measures=parseFloat(split[0]),quarters=parseFloat(split[1]),sixteenths=parseFloat(split[2]));var beats=measures*timeSignature+quarters+sixteenths/4;return beats*(60/bpm)},Tone.prototype.ticksToSeconds=function(ticks,bpm){if(this.isUndef(Tone.Transport))return 0;ticks=parseFloat(ticks),bpm=this.defaultArg(bpm,getTransportBpm());var tickTime=60/bpm/Tone.Transport.PPQ;return tickTime*ticks},Tone.prototype.frequencyToSeconds=function(freq){return 1/parseFloat(freq)},Tone.prototype.samplesToSeconds=function(samples){return samples/this.context.sampleRate},Tone.prototype.secondsToSamples=function(seconds){return seconds*this.context.sampleRate},Tone.prototype.secondsToTransportTime=function(seconds,bpm,timeSignature){bpm=this.defaultArg(bpm,getTransportBpm()),timeSignature=this.defaultArg(timeSignature,getTransportTimeSignature());var quarterTime=60/bpm,quarters=seconds/quarterTime,measures=Math.floor(quarters/timeSignature),sixteenths=quarters%1*4;quarters=Math.floor(quarters)%timeSignature;var progress=[measures,quarters,sixteenths];return progress.join(":")},Tone.prototype.secondsToFrequency=function(seconds){return 1/seconds},Tone.prototype.toTransportTime=function(time,bpm,timeSignature){var seconds=this.toSeconds(time);return this.secondsToTransportTime(seconds,bpm,timeSignature)},Tone.prototype.toFrequency=function(freq,now){return this.isFrequency(freq)?parseFloat(freq):this.isNotation(freq)||this.isTransportTime(freq)?this.secondsToFrequency(this.toSeconds(freq,now)):this.isNote(freq)?this.noteToFrequency(freq):freq},Tone.prototype.toTicks=function(time){if(this.isUndef(Tone.Transport))return 0;var bpm=Tone.Transport.bpm.value,plusNow=0;if(this.isNowRelative(time))time=time.replace("+",""),plusNow=Tone.Transport.ticks;else if(this.isUndef(time))return Tone.Transport.ticks;var seconds=this.toSeconds(time),quarter=60/bpm,quarters=seconds/quarter,tickNum=quarters*Tone.Transport.PPQ;return Math.round(tickNum+plusNow)},Tone.prototype.toSamples=function(time){var seconds=this.toSeconds(time);return Math.round(seconds*this.context.sampleRate)},Tone.prototype.toSeconds=function(time,now){now=this.defaultArg(now,this.now());if(this.isNumber(time))return time;if(this.isString(time)){var plusTime=0;this.isNowRelative(time)&&(time=time.replace("+",""),plusTime=now);var betweenParens=time.match(/\(([^)(]+)\)/g);if(betweenParens)for(var j=0;j<betweenParens.length;j++){var symbol=betweenParens[j].replace(/[\(\)]/g,""),symbolVal=this.toSeconds(symbol);time=time.replace(betweenParens[j],symbolVal)}if(time.indexOf("@")!==-1){var quantizationSplit=time.split("@");if(!!this.isUndef(Tone.Transport))throw new Error("quantization requires Tone.Transport");var toQuantize=quantizationSplit[0].trim();toQuantize===""&&(toQuantize=undefined),plusTime>0&&(toQuantize="+"+toQuantize,plusTime=0);var subdivision=quantizationSplit[1].trim();time=Tone.Transport.quantize(toQuantize,subdivision)}else{var components=time.split(/[\(\)\-\+\/\*]/);if(components.length>1){var originalTime=time;for(var i=0;i<components.length;i++){var symb=components[i].trim();if(symb!==""){var val=this.toSeconds(symb);time=time.replace(symb,val)}}try{time=eval(time)}catch(e){throw new EvalError("cannot evaluate Time: "+originalTime)}}else this.isNotation(time)?time=this.notationToSeconds(time):this.isTransportTime(time)?time=this.transportTimeToSeconds(time):this.isFrequency(time)?time=this.frequencyToSeconds(time):this.isTicks(time)?time=this.ticksToSeconds(time):time=parseFloat(time)}return time+plusTime}return now},Tone.prototype.toNotation=function(time,bpm,timeSignature){var testNotations=["1m","2n","4n","8n","16n","32n","64n","128n"],retNotation=toNotationHelper.call(this,time,bpm,timeSignature,testNotations),testTripletNotations=["1m","2n","2t","4n","4t","8n","8t","16n","16t","32n","32t","64n","64t","128n"],retTripletNotation=toNotationHelper.call(this,time,bpm,timeSignature,testTripletNotations);return retTripletNotation.split("+").length<retNotation.split("+").length?retTripletNotation:retNotation};function toNotationHelper(time,bpm,timeSignature,testNotations){var seconds=this.toSeconds(time),threshold=this.notationToSeconds(testNotations[testNotations.length-1],bpm,timeSignature),retNotation="";for(var i=0;i<testNotations.length;i++){var notationTime=this.notationToSeconds(testNotations[i],bpm,timeSignature),multiple=seconds/notationTime,floatingPointError=1e-6;1-multiple%1<floatingPointError&&(multiple+=floatingPointError),multiple=Math.floor(multiple);if(multiple>0){multiple===1?retNotation+=testNotations[i]:retNotation+=multiple.toString()+"*"+testNotations[i],seconds-=multiple*notationTime;if(seconds<threshold)break;retNotation+=" + "}}return retNotation===""&&(retNotation="0"),retNotation}Tone.prototype.fromUnits=function(val,units){if(!this.convert&&!this.isUndef(this.convert))return val;switch(units){case Tone.Type.Time:return this.toSeconds(val);case Tone.Type.Frequency:return this.toFrequency(val);case Tone.Type.Decibels:return this.dbToGain(val);case Tone.Type.NormalRange:return Math.min(Math.max(val,0),1);case Tone.Type.AudioRange:return Math.min(Math.max(val,-1),1);case Tone.Type.Positive:return Math.max(val,0);default:return val}},Tone.prototype.toUnits=function(val,units){if(!this.convert&&!this.isUndef(this.convert))return val;switch(units){case Tone.Type.Decibels:return this.gainToDb(val);default:return val}};var noteToScaleIndex={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13},scaleIndexToNote=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];return Tone.A4=440,Tone.prototype.noteToFrequency=function(note){var parts=note.split(/(-?\d+)/);if(parts.length===3){var index=noteToScaleIndex[parts[0].toLowerCase()],octave=parts[1],noteNumber=index+(parseInt(octave,10)+1)*12;return this.midiToFrequency(noteNumber)}return 0},Tone.prototype.frequencyToNote=function(freq){var log=Math.log(freq/Tone.A4)/Math.LN2,noteNumber=Math.round(12*log)+57,octave=Math.floor(noteNumber/12);octave<0&&(noteNumber+=-12*octave);var noteName=scaleIndexToNote[noteNumber%12];return noteName+octave.toString()},Tone.prototype.intervalToFrequencyRatio=function(interval){return Math.pow(2,interval/12)},Tone.prototype.midiToNote=function(midiNumber){var octave=Math.floor(midiNumber/12)-1,note=midiNumber%12;return scaleIndexToNote[note]+octave},Tone.prototype.noteToMidi=function(note){var parts=note.split(/(\d+)/);if(parts.length===3){var index=noteToScaleIndex[parts[0].toLowerCase()],octave=parts[1];return index+(parseInt(octave,10)+1)*12}return 0},Tone.prototype.midiToFrequency=function(midi){return Tone.A4*Math.pow(2,(midi-69)/12)},Tone}),define("Tone/core/Param",["Tone/core/Tone","Tone/core/Type"],function(Tone){"use strict";return Tone.Param=function(){var options=this.optionsObject(arguments,["param","units","convert"],Tone.Param.defaults);this._param=this.input=options.param,this.units=options.units,this.convert=options.convert,this.overridden=!1,this.isUndef(options.value)||(this.value=options.value)},Tone.extend(Tone.Param),Tone.Param.defaults={units:Tone.Type.Default,convert:!0,param:undefined},Object.defineProperty(Tone.Param.prototype,"value",{get:function(){return this._toUnits(this._param.value)},set:function(value){var convertedVal=this._fromUnits(value);this._param.value=convertedVal}}),Tone.Param.prototype._fromUnits=function(val){if(!this.convert&&!this.isUndef(this.convert))return val;switch(this.units){case Tone.Type.Time:return this.toSeconds(val);case Tone.Type.Frequency:return this.toFrequency(val);case Tone.Type.Decibels:return this.dbToGain(val);case Tone.Type.NormalRange:return Math.min(Math.max(val,0),1);case Tone.Type.AudioRange:return Math.min(Math.max(val,-1),1);case Tone.Type.Positive:return Math.max(val,0);default:return val}},Tone.Param.prototype._toUnits=function(val){if(!this.convert&&!this.isUndef(this.convert))return val;switch(this.units){case Tone.Type.Decibels:return this.gainToDb(val);default:return val}},Tone.Param.prototype._minOutput=1e-5,Tone.Param.prototype.setValueAtTime=function(value,time){return value=this._fromUnits(value),this._param.setValueAtTime(value,this.toSeconds(time)),this},Tone.Param.prototype.setRampPoint=function(now){now=this.defaultArg(now,this.now());var currentVal=this._param.value;return this._param.setValueAtTime(currentVal,now),this},Tone.Param.prototype.linearRampToValueAtTime=function(value,endTime){return value=this._fromUnits(value),this._param.linearRampToValueAtTime(value,this.toSeconds(endTime)),this},Tone.Param.prototype.exponentialRampToValueAtTime=function(value,endTime){return value=this._fromUnits(value),value=Math.max(this._minOutput,value),this._param.exponentialRampToValueAtTime(value,this.toSeconds(endTime)),this},Tone.Param.prototype.exponentialRampToValue=function(value,rampTime){var now=this.now(),currentVal=this.value;return this.setValueAtTime(Math.max(currentVal,this._minOutput),now),this.exponentialRampToValueAtTime(value,now+this.toSeconds(rampTime)),this},Tone.Param.prototype.linearRampToValue=function(value,rampTime){var now=this.now();return this.setRampPoint(now),this.linearRampToValueAtTime(value,now+this.toSeconds(rampTime)),this},Tone.Param.prototype.setTargetAtTime=function(value,startTime,timeConstant){return value=this._fromUnits(value),value=Math.max(this._minOutput,value),timeConstant=Math.max(this._minOutput,timeConstant),this._param.setTargetAtTime(value,this.toSeconds(startTime),timeConstant),this},Tone.Param.prototype.setValueCurveAtTime=function(values,startTime,duration){for(var i=0;i<values.length;i++)values[i]=this._fromUnits(values[i]);return this._param.setValueCurveAtTime(values,this.toSeconds(startTime),this.toSeconds(duration)),this},Tone.Param.prototype.cancelScheduledValues=function(startTime){return this._param.cancelScheduledValues(this.toSeconds(startTime)),this},Tone.Param.prototype.rampTo=function(value,rampTime){return rampTime=this.defaultArg(rampTime,0),this.units===Tone.Type.Frequency||this.units===Tone.Type.BPM?this.exponentialRampToValue(value,rampTime):this.linearRampToValue(value,rampTime),this},Tone.Param.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._param=null,this},Tone.Param}),define("Tone/core/Gain",["Tone/core/Tone","Tone/core/Param","Tone/core/Type"],function(Tone){"use strict";return Tone.Gain=function(){var options=this.optionsObject(arguments,["gain","units"],Tone.Gain.defaults);this.input=this.output=this._gainNode=this.context.createGain(),this.gain=new Tone.Param({param:this._gainNode.gain,units:options.units,value:options.gain,convert:options.convert}),this._readOnly("gain")},Tone.extend(Tone.Gain),Tone.Gain.defaults={gain:1,convert:!0},Tone.Gain.prototype.dispose=function(){Tone.Param.prototype.dispose.call(this),this._gainNode.disconnect(),this._gainNode=null,this._writable("gain"),this.gain.dispose(),this.gain=null},Tone.Gain}),define("Tone/signal/Signal",["Tone/core/Tone","Tone/signal/WaveShaper","Tone/core/Type","Tone/core/Param","Tone/core/Gain"],function(Tone){"use strict";return Tone.Signal=function(){var options=this.optionsObject(arguments,["value","units"],Tone.Signal.defaults);this.output=this._gain=this.context.createGain(),options.param=this._gain.gain,Tone.Param.call(this,options),this.input=this._param=this._gain.gain,Tone.Signal._constant.chain(this._gain)},Tone.extend(Tone.Signal,Tone.Param),Tone.Signal.defaults={value:0,units:Tone.Type.Default,convert:!0},Tone.Signal.prototype.connect=Tone.SignalBase.prototype.connect,Tone.Signal.prototype.dispose=function(){return Tone.Param.prototype.dispose.call(this),this._param=null,this._gain.disconnect(),this._gain=null,this},Tone.Signal._constant=null,Tone._initAudioContext(function(audioContext){var buffer=audioContext.createBuffer(1,128,audioContext.sampleRate),arr=buffer.getChannelData(0);for(var i=0;i<arr.length;i++)arr[i]=1;Tone.Signal._constant=audioContext.createBufferSource(),Tone.Signal._constant.channelCount=1,Tone.Signal._constant.channelCountMode="explicit",Tone.Signal._constant.buffer=buffer,Tone.Signal._constant.loop=!0,Tone.Signal._constant.start(0),Tone.Signal._constant.noGC()}),Tone.Signal}),define("Tone/signal/Pow",["Tone/core/Tone","Tone/signal/WaveShaper"],function(Tone){"use strict";return Tone.Pow=function(exp){this._exp=this.defaultArg(exp,1),this._expScaler=this.input=this.output=new Tone.WaveShaper(this._expFunc(this._exp),8192)},Tone.extend(Tone.Pow,Tone.SignalBase),Object.defineProperty(Tone.Pow.prototype,"value",{get:function(){return this._exp},set:function(exp){this._exp=exp,this._expScaler.setMap(this._expFunc(this._exp))}}),Tone.Pow.prototype._expFunc=function(exp){return function(val){return Math.pow(Math.abs(val),exp)}},Tone.Pow.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._expScaler.dispose(),this._expScaler=null,this},Tone.Pow}),define("Tone/component/SimpleEnvelope",["Tone/core/Tone","Tone/signal/Signal","Tone/signal/Pow","Tone/core/Type"],function(Tone){"use strict";return Tone.SimpleEnvelope=function(){var options=this.optionsObject(arguments,["attack","decay","sustain","release"],Tone.SimpleEnvelope.defaults);this.attack=options.attack,this.decay=options.decay,this.sustain=options.sustain,this.release=options.release,this._minOutput=1e-4,this._sig=this.output=new Tone.Signal,this._sig.setValueAtTime(this._minOutput,0)},Tone.extend(Tone.SimpleEnvelope),Tone.SimpleEnvelope.defaults={attack:.01,decay:.1,sustain:.5,release:1},Tone.SimpleEnvelope.prototype.triggerAttack=function(when,velocity){when=this.isUndef(when)?this.context.currentTime:when,velocity=this.isUndef(velocity)?1:velocity,this._sig.cancelScheduledValues(0),this._sig.setValueAtTime(this._sig.value,when),this._sig.linearRampToValueAtTime(velocity,when+this.attack),this._sig.linearRampToValueAtTime(this.sustain*velocity,when+this.attack+this.decay)},Tone.SimpleEnvelope.prototype.triggerRelease=function(when){when=this.isUndef(when)?this.context.currentTime:when,this._sig.cancelScheduledValues(0),this._sig.setValueAtTime(this._sig.value,when),this._sig.linearRampToValueAtTime(this._minOutput,when+this.release)},Tone.SimpleEnvelope.prototype.triggerAttackRelease=function(duration,when,velocity){when=this.isUndef(when)?this.context.currentTime:when,duration=this.isUndef(duration)?0:duration,velocity=this.isUndef(velocity)?1:velocity,this._sig.cancelScheduledValues(0),this._sig.setValueAtTime(this._sig.value,when),this._sig.linearRampToValueAtTime(velocity,when+this.attack),this._sig.linearRampToValueAtTime(this.sustain*velocity,when+this.attack+this.decay),this._sig.setValueAtTime(this._sig.value,duration+when+this.attack+this.decay),this._sig.linearRampToValueAtTime(this._minOutput,duration+when+this.release+this.attack+this.decay)},Tone.SimpleEnvelope.prototype.connect=Tone.Signal.prototype.connect,Tone.SimpleEnvelope.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._sig.dispose(),this._sig=null,this},Tone.SimpleEnvelope}),define("Tone/component/AmplitudeEnvelope",["Tone/core/Tone","Tone/component/SimpleEnvelope","Tone/core/Gain"],function(Tone){"use strict";return Tone.AmplitudeEnvelope=function(){Tone.SimpleEnvelope.apply(this,arguments),this.input=this.output=new Tone.Gain,this._sig.connect(this.output.gain)},Tone.extend(Tone.AmplitudeEnvelope,Tone.SimpleEnvelope),Tone.AmplitudeEnvelope.prototype.dispose=function(){return this.input.dispose(),this.input=null,Tone.SimpleEnvelope.prototype.dispose.call(this),this},Tone.AmplitudeEnvelope}),define("Tone/core/Timeline",["Tone/core/Tone","Tone/core/Type"],function(Tone){"use strict";return Tone.Timeline=function(){var options=this.optionsObject(arguments,["memory"],Tone.Timeline.defaults);this._timeline=[],this._toRemove=[],this._iterating=!1,this.memory=options.memory},Tone.extend(Tone.Timeline),Tone.Timeline.defaults={memory:Infinity},Object.defineProperty(Tone.Timeline.prototype,"length",{get:function(){return this._timeline.length}}),Tone.Timeline.prototype.addEvent=function(event){if(this.isUndef(event.time))throw new Error("events must have a time attribute");event.time=this.toSeconds(event.time);if(this._timeline.length){var index=this._search(event.time);this._timeline.splice(index+1,0,event)}else this._timeline.push(event);if(this.length>this.memory){var diff=this.length-this.memory;this._timeline.splice(0,diff)}return this},Tone.Timeline.prototype.removeEvent=function(event){if(this._iterating)this._toRemove.push(event);else{var index=this._timeline.indexOf(event);index!==-1&&this._timeline.splice(index,1)}return this},Tone.Timeline.prototype.getEvent=function(time){time=this.toSeconds(time);var index=this._search(time);return index!==-1?this._timeline[index]:null},Tone.Timeline.prototype.getEventAfter=function(time){time=this.toSeconds(time);var index=this._search(time);return index+1<this._timeline.length?this._timeline[index+1]:null},Tone.Timeline.prototype.getEventBefore=function(time){time=this.toSeconds(time);var index=this._search(time);return index-1>=0?this._timeline[index-1]:null},Tone.Timeline.prototype.cancel=function(after){if(this._timeline.length>1){after=this.toSeconds(after);var index=this._search(after);index>=0?this._timeline=this._timeline.slice(0,index):this._timeline=[]}else this._timeline.length===1&&this._timeline[0].time>=after&&(this._timeline=[]);return this},Tone.Timeline.prototype.cancelBefore=function(time){if(this._timeline.length){time=this.toSeconds(time);var index=this._search(time);index>=0&&(this._timeline=this._timeline.slice(index+1))}return this},Tone.Timeline.prototype._search=function(time){var beginning=0,len=this._timeline.length,end=len;while(beginning<=end&&beginning<len){var midPoint=Math.floor(beginning+(end-beginning)/2),event=this._timeline[midPoint];if(event.time===time){for(var i=midPoint;i<this._timeline.length;i++){var testEvent=this._timeline[i];testEvent.time===time&&(midPoint=i)}return midPoint}event.time>time?end=midPoint-1:event.time<time&&(beginning=midPoint+1)}return beginning-1},Tone.Timeline.prototype._iterate=function(callback,lowerBound,upperBound){this._iterating=!0,lowerBound=this.defaultArg(lowerBound,0),upperBound=this.defaultArg(upperBound,this._timeline.length-1);for(var i=lowerBound;i<=upperBound;i++)callback(this._timeline[i]);this._iterating=!1;if(this._toRemove.length>0){for(var j=0;j<this._toRemove.length;j++){var index=this._timeline.indexOf(this._toRemove[j]);index!==-1&&this._timeline.splice(index,1)}this._toRemove=[]}},Tone.Timeline.prototype.forEach=function(callback){return this._iterate(callback),this},Tone.Timeline.prototype.forEachBefore=function(time,callback){time=this.toSeconds(time);var upperBound=this._search(time);return upperBound!==-1&&this._iterate(callback,0,upperBound),this},Tone.Timeline.prototype.forEachAfter=function(time,callback){time=this.toSeconds(time);var lowerBound=this._search(time);return this._iterate(callback,lowerBound+1),this},Tone.Timeline.prototype.forEachFrom=function(time,callback){time=this.toSeconds(time);var lowerBound=this._search(time);while(lowerBound>=0&&this._timeline[lowerBound].time>=time)lowerBound--;return this._iterate(callback,lowerBound+1),this},Tone.Timeline.prototype.forEachAtTime=function(time,callback){time=this.toSeconds(time);var upperBound=this._search(time);return upperBound!==-1&&this._iterate(function(event){event.time===time&&callback(event)},0,upperBound),this},Tone.Timeline.prototype.dispose=function(){Tone.prototype.dispose.call(this),this._timeline=null,this._toRemove=null},Tone.Timeline}),define("Tone/signal/TimelineSignal",["Tone/core/Tone","Tone/signal/Signal","Tone/core/Timeline"],function(Tone){"use strict";return Tone.TimelineSignal=function(){var options=this.optionsObject(arguments,["value","units"],Tone.Signal.defaults);Tone.Signal.apply(this,options),options.param=this._param,Tone.Param.call(this,options),this._events=new Tone.Timeline(10),this._initial=this._fromUnits(this._param.value)},Tone.extend(Tone.TimelineSignal,Tone.Param),Tone.TimelineSignal.Type={Linear:"linear",Exponential:"exponential",Target:"target",Set:"set"},Object.defineProperty(Tone.TimelineSignal.prototype,"value",{get:function(){return this._toUnits(this._param.value)},set:function(value){var convertedVal=this._fromUnits(value);this._initial=convertedVal,this._param.value=convertedVal}}),Tone.TimelineSignal.prototype.setValueAtTime=function(value,startTime){return value=this._fromUnits(value),startTime=this.toSeconds(startTime),this._events.addEvent({type:Tone.TimelineSignal.Type.Set,value:value,time:startTime}),this._param.setValueAtTime(value,startTime),this},Tone.TimelineSignal.prototype.linearRampToValueAtTime=function(value,endTime){return value=this._fromUnits(value),endTime=this.toSeconds(endTime),this._events.addEvent({type:Tone.TimelineSignal.Type.Linear,value:value,time:endTime}),this._param.linearRampToValueAtTime(value,endTime),this},Tone.TimelineSignal.prototype.exponentialRampToValueAtTime=function(value,endTime){return value=this._fromUnits(value),value=Math.max(this._minOutput,value),endTime=this.toSeconds(endTime),this._events.addEvent({type:Tone.TimelineSignal.Type.Exponential,value:value,time:endTime}),this._param.exponentialRampToValueAtTime(value,endTime),this},Tone.TimelineSignal.prototype.setTargetAtTime=function(value,startTime,timeConstant){return value=this._fromUnits(value),value=Math.max(this._minOutput,value),timeConstant=Math.max(this._minOutput,timeConstant),startTime=this.toSeconds(startTime),this._events.addEvent({type:Tone.TimelineSignal.Type.Target,value:value,time:startTime,constant:timeConstant}),this._param.setTargetAtTime(value,startTime,timeConstant),this},Tone.TimelineSignal.prototype.cancelScheduledValues=function(after){return this._events.cancel(after),this._param.cancelScheduledValues(this.toSeconds(after)),this},Tone.TimelineSignal.prototype.setRampPoint=function(time){time=this.toSeconds(time);var val=this.getValueAtTime(time),after=this._searchAfter(time);return after&&(this.cancelScheduledValues(time),after.type===Tone.TimelineSignal.Type.Linear?this.linearRampToValueAtTime(val,time):after.type===Tone.TimelineSignal.Type.Exponential&&this.exponentialRampToValueAtTime(val,time)),this.setValueAtTime(val,time),this},Tone.TimelineSignal.prototype.linearRampToValueBetween=function(value,start,finish){return this.setRampPoint(start),this.linearRampToValueAtTime(value,finish),this},Tone.TimelineSignal.prototype.exponentialRampToValueBetween=function(value,start,finish){return this.setRampPoint(start),this.exponentialRampToValueAtTime(value,finish),this},Tone.TimelineSignal.prototype._searchBefore=function(time){return this._events.getEvent(time)},Tone.TimelineSignal.prototype._searchAfter=function(time){return this._events.getEventAfter(time)},Tone.TimelineSignal.prototype.getValueAtTime=function(time){var after=this._searchAfter(time),before=this._searchBefore(time),value=this._initial;if(before===null)value=this._initial;else if(before.type===Tone.TimelineSignal.Type.Target){var previous=this._events.getEventBefore(before.time),previouVal;previous===null?previouVal=this._initial:previouVal=previous.value,value=this._exponentialApproach(before.time,previouVal,before.value,before.constant,time)}else after===null?value=before.value:after.type===Tone.TimelineSignal.Type.Linear?value=this._linearInterpolate(before.time,before.value,after.time,after.value,time):after.type===Tone.TimelineSignal.Type.Exponential?value=this._exponentialInterpolate(before.time,before.value,after.time,after.value,time):value=before.value;return value},Tone.TimelineSignal.prototype.connect=Tone.SignalBase.prototype.connect,Tone.TimelineSignal.prototype._exponentialApproach=function(t0,v0,v1,timeConstant,t){return v1+(v0-v1)*Math.exp(-(t-t0)/timeConstant)},Tone.TimelineSignal.prototype._linearInterpolate=function(t0,v0,t1,v1,t){return v0+(v1-v0)*((t-t0)/(t1-t0))},Tone.TimelineSignal.prototype._exponentialInterpolate=function(t0,v0,t1,v1,t){return v0=Math.max(this._minOutput,v0),v0*Math.pow(v1/v0,(t-t0)/(t1-t0))},Tone.TimelineSignal.prototype.dispose=function(){Tone.Signal.prototype.dispose.call(this),Tone.Param.prototype.dispose.call(this),this._events.dispose(),this._events=null},Tone.TimelineSignal}),define("Tone/component/Envelope",["Tone/core/Tone","Tone/signal/TimelineSignal","Tone/signal/Pow","Tone/core/Type"],function(Tone){"use strict";return Tone.Envelope=function(){var options=this.optionsObject(arguments,["attack","decay","sustain","release"],Tone.Envelope.defaults);this.attack=options.attack,this.decay=options.decay,this.sustain=options.sustain,this.release=options.release,this._attackCurve=Tone.Envelope.Type.Linear,this._releaseCurve=Tone.Envelope.Type.Exponential,this._minOutput=1e-5,this._sig=this.output=new Tone.TimelineSignal,this._sig.setValueAtTime(this._minOutput,0),this.attackCurve=options.attackCurve,this.releaseCurve=options.releaseCurve},Tone.extend(Tone.Envelope),Tone.Envelope.defaults={attack:.01,decay:.1,sustain:.5,release:1,attackCurve:"linear",releaseCurve:"exponential"},Tone.Envelope.prototype._timeMult=.25,Object.defineProperty(Tone.Envelope.prototype,"value",{get:function(){return this._sig.value}}),Object.defineProperty(Tone.Envelope.prototype,"attackCurve",{get:function(){return this._attackCurve},set:function(type){if(type!==Tone.Envelope.Type.Linear&&type!==Tone.Envelope.Type.Exponential)throw Error('attackCurve must be either "linear" or "exponential". Invalid type: ',type);this._attackCurve=type}}),Object.defineProperty(Tone.Envelope.prototype,"releaseCurve",{get:function(){return this._releaseCurve},set:function(type){if(type!==Tone.Envelope.Type.Linear&&type!==Tone.Envelope.Type.Exponential)throw Error('releaseCurve must be either "linear" or "exponential". Invalid type: ',type);this._releaseCurve=type}}),Tone.Envelope.prototype.triggerAttack=function(time,velocity){var now=this.now()+this.blockTime;time=this.toSeconds(time,now);var attack=this.toSeconds(this.attack)+time,decay=this.toSeconds(this.decay);return velocity=this.defaultArg(velocity,1),this._attackCurve===Tone.Envelope.Type.Linear?this._sig.linearRampToValueBetween(velocity,time,attack):this._sig.exponentialRampToValueBetween(velocity,time,attack),this._sig.setValueAtTime(velocity,attack),this._sig.exponentialRampToValueAtTime(this.sustain*velocity,attack+decay),this},Tone.Envelope.prototype.triggerRelease=function(time){var now=this.now()+this.blockTime;time=this.toSeconds(time,now);var release=this.toSeconds(this.release);return this._releaseCurve===Tone.Envelope.Type.Linear?this._sig.linearRampToValueBetween(this._minOutput,time,time+release):this._sig.exponentialRampToValueBetween(this._minOutput,time,release+time),this},Tone.Envelope.prototype.triggerAttackRelease=function(duration,time,velocity){return time=this.toSeconds(time),this.triggerAttack(time,velocity),this.triggerRelease(time+this.toSeconds(duration)),this},Tone.Envelope.prototype.connect=Tone.Signal.prototype.connect,Tone.Envelope.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._sig.dispose(),this._sig=null,this},Tone.Envelope.Phase={Attack:"attack",Decay:"decay",Sustain:"sustain",Release:"release",Standby:"standby"},Tone.Envelope.Type={Linear:"linear",Exponential:"exponential"},Tone.Envelope}),define("Tone/component/Filter",["Tone/core/Tone","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Filter=function(){Tone.call(this);var options=this.optionsObject(arguments,["frequency","type","rolloff"],Tone.Filter.defaults);this._filters=[],this.frequency=new Tone.Signal(options.frequency,Tone.Type.Frequency),this.detune=new Tone.Signal(0,Tone.Type.Cents),this.gain=new Tone.Signal({value:options.gain,convert:!1}),this.Q=new Tone.Signal(options.Q),this._type=options.type,this._rolloff=options.rolloff,this.rolloff=options.rolloff,this._readOnly(["detune","frequency","gain","Q"])},Tone.extend(Tone.Filter),Tone.Filter.defaults={type:"lowpass",frequency:350,rolloff:-12,Q:1,gain:0},Object.defineProperty(Tone.Filter.prototype,"type",{get:function(){return this._type},set:function(type){var types=["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"];if(types.indexOf(type)===-1)throw new Error("Tone.Filter does not have filter type "+type);this._type=type;for(var i=0;i<this._filters.length;i++)this._filters[i].type=type}}),Object.defineProperty(Tone.Filter.prototype,"rolloff",{get:function(){return this._rolloff},set:function(rolloff){rolloff=parseInt(rolloff,10);var possibilities=[-12,-24,-48,-96],cascadingCount=possibilities.indexOf(rolloff);if(cascadingCount===-1)throw new Error("Filter rolloff can only be -12, -24, -48 or -96");cascadingCount+=1,this._rolloff=rolloff,this.input.disconnect();for(var i=0;i<this._filters.length;i++)this._filters[i].disconnect(),this._filters[i]=null;this._filters=new Array(cascadingCount);for(var count=0;count<cascadingCount;count++){var filter=this.context.createBiquadFilter();filter.type=this._type,this.frequency.connect(filter.frequency),this.detune.connect(filter.detune),this.Q.connect(filter.Q),this.gain.connect(filter.gain),this._filters[count]=filter}var connectionChain=[this.input].concat(this._filters).concat([this.output]);this.connectSeries.apply(this,connectionChain)}}),Tone.Filter.prototype.dispose=function(){Tone.prototype.dispose.call(this);for(var i=0;i<this._filters.length;i++)this._filters[i].disconnect(),this._filters[i]=null;return this._filters=null,this._writable(["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.frequency=null,this.Q=null,this.detune.dispose(),this.detune=null,this.gain.dispose(),this.gain=null,this},Tone.Filter}),define("Tone/component/Volume",["Tone/core/Tone","Tone/signal/Signal","Tone/core/Gain"],function(Tone){"use strict";return Tone.Volume=function(){var options=this.optionsObject(arguments,["volume"],Tone.Volume.defaults);this.output=this.input=new Tone.Gain(options.volume,Tone.Type.Decibels),this.volume=this.output.gain,this._readOnly("volume")},Tone.extend(Tone.Volume),Tone.Volume.defaults={volume:0},Tone.Volume.prototype.dispose=function(){return this.input.dispose(),Tone.prototype.dispose.call(this),this._writable("volume"),this.volume.dispose(),this.volume=null,this},Tone.Volume}),define("Tone/source/SimpleSource",["Tone/core/Tone","Tone/component/Volume"],function(Tone){"use strict";return Tone.SimpleSource=function(options){Tone.call(this),options=this.defaultArg(options,Tone.SimpleSource.defaults),this._volume=this.output=new Tone.Volume(options.volume),this.volume=this._volume.volume,this._volume.output.output.channelCount=2,this._volume.output.output.channelCountMode="explicit"},Tone.extend(Tone.SimpleSource),Tone.SimpleSource.defaults={volume:0},Tone.SimpleSource.prototype.start=function(time){this._start&&this._start.apply(this,arguments)},Tone.SimpleSource.prototype.stop=function(time){this._stop&&this._stop.apply(this,arguments)},Tone.SimpleSource.prototype.dispose=function(){this.stop(),Tone.prototype.dispose.call(this),this._volume.dispose(),this._volume=null,this.volume=null},Tone.SimpleSource}),define("Tone/core/TimelineState",["Tone/core/Tone","Tone/core/Timeline","Tone/core/Type"],function(Tone){"use strict";return Tone.TimelineState=function(initial){Tone.Timeline.call(this),this._initial=initial},Tone.extend(Tone.TimelineState,Tone.Timeline),Tone.TimelineState.prototype.getStateAtTime=function(time){var event=this.getEvent(time);return event!==null?event.state:this._initial},Tone.TimelineState.prototype.setStateAtTime=function(state,time){this.addEvent({state:state,time:this.toSeconds(time)})},Tone.TimelineState}),define("Tone/core/Clock",["Tone/core/Tone","Tone/signal/TimelineSignal","Tone/core/TimelineState"],function(Tone){"use strict";return Tone.Clock=function(){var options=this.optionsObject(arguments,["callback","frequency"],Tone.Clock.defaults);this.callback=options.callback,this._lookAhead="auto",this._computedLookAhead=1/60,this._threshold=.5,this._nextTick=-1,this._lastUpdate=0,this._loopID=-1,this.frequency=new Tone.TimelineSignal(options.frequency,Tone.Type.Frequency),this.ticks=0,this._state=new Tone.TimelineState(Tone.State.Stopped),this._boundLoop=this._loop.bind(this),this._readOnly("frequency"),this._loop()},Tone.extend(Tone.Clock),Tone.Clock.defaults={callback:Tone.noOp,frequency:1,lookAhead:"auto"},Object.defineProperty(Tone.Clock.prototype,"state",{get:function(){return this._state.getStateAtTime(this.now())}}),Object.defineProperty(Tone.Clock.prototype,"lookAhead",{get:function(){return this._lookAhead},set:function(val){val==="auto"?this._lookAhead="auto":this._lookAhead=this.toSeconds(val)}}),Tone.Clock.prototype.start=function(time,offset){return time=this.toSeconds(time),this._state.getStateAtTime(time)!==Tone.State.Started&&this._state.addEvent({state:Tone.State.Started,time:time,offset:offset}),this},Tone.Clock.prototype.stop=function(time){return time=this.toSeconds(time),this._state.getStateAtTime(time)!==Tone.State.Stopped&&this._state.setStateAtTime(Tone.State.Stopped,time),this},Tone.Clock.prototype.pause=function(time){return time=this.toSeconds(time),this._state.getStateAtTime(time)===Tone.State.Started&&this._state.setStateAtTime(Tone.State.Paused,time),this},Tone.Clock.prototype._loop=function(time){this._loopID=requestAnimationFrame(this._boundLoop);if(this._lookAhead==="auto"){if(!this.isUndef(time)){var diff=(time-this._lastUpdate)/1e3;this._lastUpdate=time,diff<this._threshold&&(this._computedLookAhead=(9*this._computedLookAhead+diff)/10)}}else this._computedLookAhead=this._lookAhead;var now=this.now(),lookAhead=this._computedLookAhead*2,event=this._state.getEvent(now+lookAhead),state=Tone.State.Stopped;event&&(state=event.state,this._nextTick===-1&&state===Tone.State.Started&&(this._nextTick=event.time,this.isUndef(event.offset)||(this.ticks=event.offset)));if(state===Tone.State.Started)while(now+lookAhead>this._nextTick){now>this._nextTick+this._threshold&&(this._nextTick=now);var tickTime=this._nextTick;this._nextTick+=1/this.frequency.getValueAtTime(this._nextTick),this.callback(tickTime),this.ticks++}else state===Tone.State.Stopped&&(this._nextTick=-1,this.ticks=0)},Tone.Clock.prototype.getStateAtTime=function(time){return this._state.getStateAtTime(time)},Tone.Clock.prototype.dispose=function(){cancelAnimationFrame(this._loopID),Tone.TimelineState.prototype.dispose.call(this),this._writable("frequency"),this.frequency.dispose(),this.frequency=null,this._boundLoop=Tone.noOp,this._nextTick=Infinity,this.callback=null,this._state.dispose(),this._state=null},Tone.Clock}),define("Tone/core/Emitter",["Tone/core/Tone"],function(Tone){"use strict";return Tone.Emitter=function(){this._events={}},Tone.extend(Tone.Emitter),Tone.Emitter.prototype.on=function(event,callback){var events=event.split(/\W+/);for(var i=0;i<events.length;i++){var eventName=events[i];this._events.hasOwnProperty(eventName)||(this._events[eventName]=[]),this._events[eventName].push(callback)}return this},Tone.Emitter.prototype.off=function(event,callback){var events=event.split(/\W+/);for(var ev=0;ev<events.length;ev++){event=events[ev];if(this._events.hasOwnProperty(event))if(Tone.prototype.isUndef(callback))this._events[event]=[];else{var eventList=this._events[event];for(var i=0;i<eventList.length;i++)eventList[i]===callback&&eventList.splice(i,1)}}return this},Tone.Emitter.prototype.trigger=function(event){if(this._events){var args=Array.prototype.slice.call(arguments,1);if(this._events.hasOwnProperty(event)){var eventList=this._events[event];for(var i=0,len=eventList.length;i<len;i++)eventList[i].apply(this,args)}}return this},Tone.Emitter.mixin=function(object){var functions=["on","off","trigger"];object._events={};for(var i=0;i<functions.length;i++){var func=functions[i],emitterFunc=Tone.Emitter.prototype[func];object[func]=emitterFunc}},Tone.Emitter.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._events=null,this},Tone.Emitter}),define("Tone/core/IntervalTimeline",["Tone/core/Tone","Tone/core/Type"],function(Tone){"use strict";Tone.IntervalTimeline=function(){this._root=null,this._length=0},Tone.extend(Tone.IntervalTimeline),Tone.IntervalTimeline.prototype.addEvent=function(event){if(this.isUndef(event.time)||this.isUndef(event.duration))throw new Error("events must have time and duration parameters");var node=new IntervalNode(event.time,event.time+event.duration,event);this._root===null?this._root=node:this._root.insert(node),this._length++;while(node!==null)node.updateHeight(),node.updateMax(),this._rebalance(node),node=node.parent;return this},Tone.IntervalTimeline.prototype.removeEvent=function(event){if(this._root!==null){var results=[];this._root.search(event.time,results);for(var i=0;i<results.length;i++){var node=results[i];if(node.event===event){this._removeNode(node),this._length--;break}}}return this},Object.defineProperty(Tone.IntervalTimeline.prototype,"length",{get:function(){return this._length}}),Tone.IntervalTimeline.prototype.cancel=function(after){return after=this.toSeconds(after),this.forEachAfter(after,function(event){this.removeEvent(event)}.bind(this)),this},Tone.IntervalTimeline.prototype._setRoot=function(node){this._root=node,this._root!==null&&(this._root.parent=null)},Tone.IntervalTimeline.prototype._replaceNodeInParent=function(node,replacement){node.parent!==null?(node.isLeftChild()?node.parent.left=replacement:node.parent.right=replacement,this._rebalance(node.parent)):this._setRoot(replacement)},Tone.IntervalTimeline.prototype._removeNode=function(node){if(node.left===null&&node.right===null)this._replaceNodeInParent(node,null);else if(node.right===null)this._replaceNodeInParent(node,node.left);else if(node.left===null)this._replaceNodeInParent(node,node.right);else{var balance=node.getBalance(),replacement,temp;if(balance>0)if(node.left.right===null)replacement=node.left,replacement.right=node.right,temp=replacement;else{replacement=node.left.right;while(replacement.right!==null)replacement=replacement.right;replacement.parent.right=replacement.left,temp=replacement.parent,replacement.left=node.left,replacement.right=node.right}else if(node.right.left===null)replacement=node.right,replacement.left=node.left,temp=replacement;else{replacement=node.right.left;while(replacement.left!==null)replacement=replacement.left;replacement.parent=replacement.parent,replacement.parent.left=replacement.right,temp=replacement.parent,replacement.left=node.left,replacement.right=node.right}node.parent!==null?node.isLeftChild()?node.parent.left=replacement:node.parent.right=replacement:this._setRoot(replacement),this._rebalance(temp)}node.dispose()},Tone.IntervalTimeline.prototype._rotateLeft=function(node){var parent=node.parent,isLeftChild=node.isLeftChild(),pivotNode=node.right;node.right=pivotNode.left,pivotNode.left=node,parent!==null?isLeftChild?parent.left=pivotNode:parent.right=pivotNode:this._setRoot(pivotNode)},Tone.IntervalTimeline.prototype._rotateRight=function(node){var parent=node.parent,isLeftChild=node.isLeftChild(),pivotNode=node.left;node.left=pivotNode.right,pivotNode.right=node,parent!==null?isLeftChild?parent.left=pivotNode:parent.right=pivotNode:this._setRoot(pivotNode)},Tone.IntervalTimeline.prototype._rebalance=function(node){var balance=node.getBalance();balance>1?node.left.getBalance()<0?this._rotateLeft(node.left):this._rotateRight(node):balance<-1&&(node.right.getBalance()>0?this._rotateRight(node.right):this._rotateLeft(node))},Tone.IntervalTimeline.prototype.getEvent=function(time){if(this._root!==null){var results=[];this._root.search(time,results);if(results.length>0){var max=results[0];for(var i=1;i<results.length;i++)results[i].low>max.low&&(max=results[i]);return max.event}}return null},Tone.IntervalTimeline.prototype.forEach=function(callback){if(this._root!==null){var allNodes=[];this._root!==null&&this._root.traverse(function(node){allNodes.push(node)});for(var i=0;i<allNodes.length;i++){var ev=allNodes[i].event;ev&&callback(ev)}}return this},Tone.IntervalTimeline.prototype.forEachOverlap=function(time,callback){time=this.toSeconds(time);if(this._root!==null){var results=[];this._root.search(time,results);for(var i=results.length-1;i>=0;i--){var ev=results[i].event;ev&&callback(ev)}}return this},Tone.IntervalTimeline.prototype.forEachAfter=function(time,callback){time=this.toSeconds(time);if(this._root!==null){var results=[];this._root.searchAfter(time,results);for(var i=results.length-1;i>=0;i--){var ev=results[i].event;ev&&callback(ev)}}return this},Tone.IntervalTimeline.prototype.dispose=function(){var allNodes=[];this._root!==null&&this._root.traverse(function(node){allNodes.push(node)});for(var i=0;i<allNodes.length;i++)allNodes[i].dispose();return allNodes=null,this._root=null,this};var IntervalNode=function(low,high,event){this.event=event,this.low=low,this.high=high,this.max=this.high,this._left=null,this._right=null,this.parent=null,this.height=0};return IntervalNode.prototype.insert=function(node){node.low<=this.low?this.left===null?this.left=node:this.left.insert(node):this.right===null?this.right=node:this.right.insert(node)},IntervalNode.prototype.search=function(point,results){if(point>this.max)return;this.left!==null&&this.left.search(point,results),this.low<=point&&this.high>=point&&results.push(this);if(this.low>point)return;this.right!==null&&this.right.search(point,results)},IntervalNode.prototype.searchAfter=function(point,results){this.low>=point&&(results.push(this),this.left!==null&&this.left.searchAfter(point,results)),this.right!==null&&this.right.searchAfter(point,results)},IntervalNode.prototype.traverse=function(callback){callback(this),this.left!==null&&this.left.traverse(callback),this.right!==null&&this.right.traverse(callback)},IntervalNode.prototype.updateHeight=function(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0},IntervalNode.prototype.updateMax=function(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))},IntervalNode.prototype.getBalance=function(){var balance=0;return this.left!==null&&this.right!==null?balance=this.left.height-this.right.height:this.left!==null?balance=this.left.height+1:this.right!==null&&(balance=-(this.right.height+1)),balance},IntervalNode.prototype.isLeftChild=function(){return this.parent!==null&&this.parent.left===this},Object.defineProperty(IntervalNode.prototype,"left",{get:function(){return this._left},set:function(node){this._left=node,node!==null&&(node.parent=this),this.updateHeight(),this.updateMax()}}),Object.defineProperty(IntervalNode.prototype,"right",{get:function(){return this._right},set:function(node){this._right=node,node!==null&&(node.parent=this),this.updateHeight(),this.updateMax()}}),IntervalNode.prototype.dispose=function(){this.parent=null,this._left=null,this._right=null,this.event=null},Tone.IntervalTimeline}),define("Tone/core/Transport",["Tone/core/Tone","Tone/core/Clock","Tone/core/Type","Tone/core/Timeline","Tone/core/Emitter","Tone/core/Gain","Tone/core/IntervalTimeline"],function(Tone){"use strict";Tone.Transport=function(){Tone.Emitter.call(this),this.loop=!1,this._loopStart=0,this._loopEnd=0,this._ppq=TransportConstructor.defaults.PPQ,this._clock=new Tone.Clock({callback:this._processTick.bind(this),frequency:0}),this.bpm=this._clock.frequency,this.bpm._toUnits=this._toUnits.bind(this),this.bpm._fromUnits=this._fromUnits.bind(this),this.bpm.units=Tone.Type.BPM,this.bpm.value=TransportConstructor.defaults.bpm,this._readOnly("bpm"),this._timeSignature=TransportConstructor.defaults.timeSignature,this._scheduledEvents={},this._eventID=0,this._timeline=new Tone.Timeline,this._repeatedEvents=new Tone.IntervalTimeline,this._onceEvents=new Tone.Timeline,this._syncedSignals=[];var swingSeconds=this.notationToSeconds(TransportConstructor.defaults.swingSubdivision,TransportConstructor.defaults.bpm,TransportConstructor.defaults.timeSignature);this._swingTicks=swingSeconds/(60/TransportConstructor.defaults.bpm)*this._ppq,this._swingAmount=0},Tone.extend(Tone.Transport,Tone.Emitter),Tone.Transport.defaults={bpm:120,swing:0,swingSubdivision:"16n",timeSignature:4,loopStart:0,loopEnd:"4m",PPQ:48},Tone.Transport.prototype._processTick=function(tickTime){this._swingAmount>0&&this._clock.ticks%this._ppq!==0&&this._clock.ticks%this._swingTicks===0&&(tickTime+=this.ticksToSeconds(this._swingTicks)*this._swingAmount),this.loop&&this._clock.ticks===this._loopEnd&&(this.ticks=this._loopStart,this.trigger("loop",tickTime));var ticks=this._clock.ticks;this._timeline.forEachAtTime(ticks,function(event){event.callback(tickTime)}),this._repeatedEvents.forEachOverlap(ticks,function(event){(ticks-event.time)%event.interval===0&&event.callback(tickTime)}),this._onceEvents.forEachBefore(ticks,function(event){event.callback(tickTime)}),this._onceEvents.cancelBefore(ticks)},Tone.Transport.prototype.schedule=function(callback,time){var event={time:this.toTicks(time),callback:callback},id=this._eventID++;return this._scheduledEvents[id.toString()]={event:event,timeline:this._timeline},this._timeline.addEvent(event),id},Tone.Transport.prototype.scheduleRepeat=function(callback,interval,startTime,duration){if(interval<=0)throw new Error("repeat events must have an interval larger than 0");var event={time:this.toTicks(startTime),duration:this.toTicks(this.defaultArg(duration,Infinity)),interval:this.toTicks(interval),callback:callback},id=this._eventID++;return this._scheduledEvents[id.toString()]={event:event,timeline:this._repeatedEvents},this._repeatedEvents.addEvent(event),id},Tone.Transport.prototype.scheduleOnce=function(callback,time){var event={time:this.toTicks(time),callback:callback},id=this._eventID++;return this._scheduledEvents[id.toString()]={event:event,timeline:this._onceEvents},this._onceEvents.addEvent(event),id},Tone.Transport.prototype.clear=function(eventId){if(this._scheduledEvents.hasOwnProperty(eventId)){var item=this._scheduledEvents[eventId.toString()];item.timeline.removeEvent(item.event),delete this._scheduledEvents[eventId.toString()]}return this},Tone.Transport.prototype.cancel=function(after){return after=this.defaultArg(after,0),after=this.toTicks(after),this._timeline.cancel(after),this._onceEvents.cancel(after),this._repeatedEvents.cancel(after),this},Tone.Transport.prototype.quantize=function(time,subdivision){subdivision=this.defaultArg(subdivision,"4n");var tickTime=this.toTicks(time);subdivision=this.toTicks(subdivision);var remainingTicks=subdivision-tickTime%subdivision;remainingTicks===subdivision&&(remainingTicks=0);var now=this.now();return this.state===Tone.State.Started&&(now=this._clock._nextTick),this.toSeconds(time,now)+this.ticksToSeconds(remainingTicks)},Object.defineProperty(Tone.Transport.prototype,"state",{get:function(){return this._clock.getStateAtTime(this.now())}}),Tone.Transport.prototype.start=function(time,offset){return time=this.toSeconds(time),this.isUndef(offset)?offset=this.defaultArg(offset,this._clock.ticks):offset=this.toTicks(offset),this._clock.start(time,offset),this.trigger("start",time,this.ticksToSeconds(offset)),this},Tone.Transport.prototype.stop=function(time){return time=this.toSeconds(time),this._clock.stop(time),this.trigger("stop",time),this},Tone.Transport.prototype.pause=function(time){return time=this.toSeconds(time),this._clock.pause(time),this.trigger("pause",time),this},Object.defineProperty(Tone.Transport.prototype,"timeSignature",{get:function(){return this._timeSignature},set:function(timeSig){this.isArray(timeSig)&&(timeSig=timeSig[0]/timeSig[1]*4),this._timeSignature=timeSig}}),Object.defineProperty(Tone.Transport.prototype,"loopStart",{get:function(){return this.ticksToSeconds(this._loopStart)},set:function(startPosition){this._loopStart=this.toTicks(startPosition)}}),Object.defineProperty(Tone.Transport.prototype,"loopEnd",{get:function(){return this.ticksToSeconds(this._loopEnd)},set:function(endPosition){this._loopEnd=this.toTicks(endPosition)}}),Tone.Transport.prototype.setLoopPoints=function(startPosition,endPosition){return this.loopStart=startPosition,this.loopEnd=endPosition,this},Object.defineProperty(Tone.Transport.prototype,"swing",{get:function(){return this._swingAmount*2},set:function(amount){this._swingAmount=amount*.5}}),Object.defineProperty(Tone.Transport.prototype,"swingSubdivision",{get:function(){return this.toNotation(this._swingTicks+"i")},set:function(subdivision){this._swingTicks=this.toTicks(subdivision)}}),Object.defineProperty(Tone.Transport.prototype,"position",{get:function(){var quarters=this.ticks/this._ppq,measures=Math.floor(quarters/this._timeSignature),sixteenths=quarters%1*4;sixteenths%1>0&&(sixteenths=sixteenths.toFixed(3)),quarters=Math.floor(quarters)%this._timeSignature;var progress=[measures,quarters,sixteenths];return progress.join(":")},set:function(progress){var ticks=this.toTicks(progress);this.ticks=ticks}}),Object.defineProperty(Tone.Transport.prototype,"progress",{get:function(){return this.loop?(this.ticks-this._loopStart)/(this._loopEnd-this._loopStart):0}}),Object.defineProperty(Tone.Transport.prototype,"ticks",{get:function(){return this._clock.ticks},set:function(t){this._clock.ticks=t}}),Object.defineProperty(Tone.Transport.prototype,"PPQ",{get:function(){return this._ppq},set:function(ppq){this._ppq=ppq,this.bpm.value=this.bpm.value}}),Tone.Transport.prototype._fromUnits=function(bpm){return 1/(60/bpm/this.PPQ)},Tone.Transport.prototype._toUnits=function(freq){return freq/this.PPQ*60},Tone.Transport.prototype.syncSignal=function(signal,ratio){ratio||(signal._param.value!==0?ratio=signal._param.value/this.bpm._param.value:ratio=0);var ratioSignal=new Tone.Gain(ratio);return this.bpm.chain(ratioSignal,signal._param),this._syncedSignals.push({ratio:ratioSignal,signal:signal,initial:signal._param.value}),signal._param.value=0,this},Tone.Transport.prototype.unsyncSignal=function(signal){for(var i=this._syncedSignals.length-1;i>=0;i--){var syncedSignal=this._syncedSignals[i];syncedSignal.signal===signal&&(syncedSignal.ratio.dispose(),syncedSignal.signal._param.value=syncedSignal.initial,this._syncedSignals.splice(i,1))}return this},Tone.Transport.prototype.dispose=function(){return Tone.Emitter.prototype.dispose.call(this),this._clock.dispose(),this._clock=null,this._writable("bpm"),this.bpm=null,this._timeline.dispose(),this._timeline=null,this._onceEvents.dispose(),this._onceEvents=null,this._repeatedEvents.dispose(),this._repeatedEvents=null,this},Tone.Transport.prototype.setInterval=function(callback,interval){return console.warn("This method is deprecated. Use Tone.Transport.scheduleRepeat instead."),Tone.Transport.scheduleRepeat(callback,interval)},Tone.Transport.prototype.clearInterval=function(id){return console.warn("This method is deprecated. Use Tone.Transport.clear instead."),Tone.Transport.clear(id)},Tone.Transport.prototype.setTimeout=function(callback,timeout){return console.warn("This method is deprecated. Use Tone.Transport.scheduleOnce instead."),Tone.Transport.scheduleOnce(callback,timeout)},Tone.Transport.prototype.clearTimeout=function(id){return console.warn("This method is deprecated. Use Tone.Transport.clear instead."),Tone.Transport.clear(id)},Tone.Transport.prototype.setTimeline=function(callback,time){return console.warn("This method is deprecated. Use Tone.Transport.schedule instead."),Tone.Transport.schedule(callback,time)},Tone.Transport.prototype.clearTimeline=function(id){return console.warn("This method is deprecated. Use Tone.Transport.clear instead."),Tone.Transport.clear(id)};var TransportConstructor=Tone.Transport;return Tone._initAudioContext(function(){if(typeof Tone.Transport=="function")Tone.Transport=new Tone.Transport;else{Tone.Transport.stop();var prevSettings=Tone.Transport.get();Tone.Transport.dispose(),TransportConstructor.call(Tone.Transport),Tone.Transport.set(prevSettings)}}),Tone.Transport}),define("Tone/source/Oscillator",["Tone/core/Tone","Tone/signal/Signal","Tone/source/SimpleSource","Tone/core/Transport"],function(Tone){"use strict";return Tone.Oscillator=function(){var options=this.optionsObject(arguments,["frequency","type"],Tone.Oscillator.defaults);Tone.SimpleSource.call(this,options),this._oscillator=null,this.frequency=new Tone.Signal(options.frequency,Tone.Type.Frequency),this.detune=new Tone.Signal(options.detune,Tone.Type.Cents),this._wave=null,this._partials=this.defaultArg(options.partials,[1]),this._phase=options.phase,this._type=null,this.type=options.type,this.phase=this._phase,this._readOnly(["frequency","detune"])},Tone.extend(Tone.Oscillator,Tone.SimpleSource),Tone.Oscillator.defaults={type:"sine",frequency:440,detune:0,phase:0,partials:[]},Tone.Oscillator.Type={Sine:"sine",Triangle:"triangle",Sawtooth:"sawtooth",Square:"square",Custom:"custom"},Tone.Oscillator.prototype._start=function(time){this._oscillator=this.context.createOscillator(),this._oscillator.setPeriodicWave(this._wave),this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(this.toSeconds(time))},Tone.Oscillator.prototype._stop=function(time){return this._oscillator&&(this._oscillator.stop(this.toSeconds(time)),this._oscillator=null),this},Tone.Oscillator.prototype.syncFrequency=function(){return Tone.Transport.syncSignal(this.frequency),this},Tone.Oscillator.prototype.unsyncFrequency=function(){return Tone.Transport.unsyncSignal(this.frequency),this},Object.defineProperty(Tone.Oscillator.prototype,"type",{get:function(){return this._type},set:function(type){var coefs=this._getRealImaginary(type,this._phase),periodicWave=this.context.createPeriodicWave(coefs[0],coefs[1]);this._wave=periodicWave,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),this._type=type}}),Tone.Oscillator.prototype._getRealImaginary=function(type,phase){var fftSize=4096,periodicWaveSize=fftSize/2,real=new Float32Array(periodicWaveSize),imag=new Float32Array(periodicWaveSize),partialCount=1;if(type===Tone.Oscillator.Type.Custom)partialCount=this._partials.length+1,periodicWaveSize=partialCount;else{var partial=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(type);partial&&(partialCount=parseInt(partial[2])+1,type=partial[1],partialCount=Math.max(partialCount,2),periodicWaveSize=partialCount)}for(var n=1;n<periodicWaveSize;++n){var piFactor=2/(n*Math.PI),b;switch(type){case Tone.Oscillator.Type.Sine:b=n<=partialCount?1:0;break;case Tone.Oscillator.Type.Square:b=n&1?2*piFactor:0;break;case Tone.Oscillator.Type.Sawtooth:b=piFactor*(n&1?1:-1);break;case Tone.Oscillator.Type.Triangle:n&1?b=2*piFactor*piFactor*(n-1>>1&1?-1:1):b=0;break;case Tone.Oscillator.Type.Custom:b=this._partials[n-1];break;default:throw new Error("invalid oscillator type: "+type)}b!==0?(real[n]=-b*Math.sin(phase*n),imag[n]=b*Math.cos(phase*n)):(real[n]=0,imag[n]=0)}return[real,imag]},Tone.Oscillator.prototype._inverseFFT=function(real,imag,phase){var sum=0,len=real.length;for(var i=0;i<len;i++)sum+=real[i]*Math.cos(i*phase)+imag[i]*Math.sin(i*phase);return sum},Tone.Oscillator.prototype._getInitialValue=function(){var coefs=this._getRealImaginary(this._type,0),real=coefs[0],imag=coefs[1],maxValue=0,twoPi=Math.PI*2;for(var i=0;i<8;i++)maxValue=Math.max(this._inverseFFT(real,imag,i/8*twoPi),maxValue);return-this._inverseFFT(real,imag,this._phase)/maxValue},Object.defineProperty(Tone.Oscillator.prototype,"partials",{get:function(){return this._type!==Tone.Oscillator.Type.Custom?[]:this._partials},set:function(partials){this._partials=partials,this.type=Tone.Oscillator.Type.Custom}}),Object.defineProperty(Tone.Oscillator.prototype,"phase",{get:function(){return this._phase*(180/Math.PI)},set:function(phase){this._phase=phase*Math.PI/180,this.type=this._type}}),Tone.Oscillator.prototype.dispose=function(){return Tone.SimpleSource.prototype.dispose.call(this),this._oscillator!==null&&(this._oscillator.disconnect(),this._oscillator=null),this._wave=null,this._writable(["frequency","detune"]),this.frequency.dispose(),this.frequency=null,this.detune.dispose(),this.detune=null,this._partials=null,this},Tone.Oscillator}),define("Tone/signal/Add",["Tone/core/Tone","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Add=function(value){Tone.call(this,2,0),this._sum=this.input[0]=this.input[1]=this.output=this.context.createGain(),this._param=this.input[1]=new Tone.Signal(value),this._param.connect(this._sum)},Tone.extend(Tone.Add,Tone.Signal),Tone.Add.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._sum.disconnect(),this._sum=null,this._param.dispose(),this._param=null,this},Tone.Add}),define("Tone/signal/Multiply",["Tone/core/Tone","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Multiply=function(value){Tone.call(this,2,0),this._mult=this.input[0]=this.output=this.context.createGain(),this._param=this.input[1]=this.output.gain,this._param.value=this.defaultArg(value,0)},Tone.extend(Tone.Multiply,Tone.Signal),Tone.Multiply.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._mult.disconnect(),this._mult=null,this._param=null,this},Tone.Multiply}),define("Tone/signal/Scale",["Tone/core/Tone","Tone/signal/Add","Tone/signal/Multiply","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Scale=function(outputMin,outputMax){this._outputMin=this.defaultArg(outputMin,0),this._outputMax=this.defaultArg(outputMax,1),this._scale=this.input=new Tone.Multiply(1),this._add=this.output=new Tone.Add(0),this._scale.connect(this._add),this._setRange()},Tone.extend(Tone.Scale,Tone.SignalBase),Object.defineProperty(Tone.Scale.prototype,"min",{get:function(){return this._outputMin},set:function(min){this._outputMin=min,this._setRange()}}),Object.defineProperty(Tone.Scale.prototype,"max",{get:function(){return this._outputMax},set:function(max){this._outputMax=max,this._setRange()}}),Tone.Scale.prototype._setRange=function(){this._add.value=this._outputMin,this._scale.value=this._outputMax-this._outputMin},Tone.Scale.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._add.dispose(),this._add=null,this._scale.dispose(),this._scale=null,this},Tone.Scale}),define("Tone/signal/AudioToGain",["Tone/core/Tone","Tone/signal/WaveShaper","Tone/signal/Signal"],function(Tone){"use strict";return Tone.AudioToGain=function(){this._norm=this.input=this.output=new Tone.WaveShaper(function(x){return(x+1)/2})},Tone.extend(Tone.AudioToGain,Tone.SignalBase),Tone.AudioToGain.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._norm.dispose(),this._norm=null,this},Tone.AudioToGain}),define("Tone/component/LFO",["Tone/core/Tone","Tone/source/Oscillator","Tone/signal/Scale","Tone/signal/Signal","Tone/signal/AudioToGain","Tone/core/Type"],function(Tone){"use strict";return Tone.LFO=function(){var options=this.optionsObject(arguments,["frequency","min","max"],Tone.LFO.defaults);this._oscillator=new Tone.Oscillator({frequency:options.frequency,type:options.type}),this.frequency=this._oscillator.frequency,this.amplitude=this._oscillator.volume,this.amplitude.units=Tone.Type.NormalRange,this.amplitude.value=options.amplitude,this._stoppedSignal=new Tone.Signal(0,Tone.Type.AudioRange),this._stoppedValue=0,this._a2g=new Tone.AudioToGain,this._scaler=this.output=new Tone.Scale(options.min,options.max),this._units=Tone.Type.Default,this.units=options.units,this._oscillator.chain(this._a2g,this._scaler),this._stoppedSignal.connect(this._a2g),this._readOnly(["amplitude","frequency"]),this.phase=options.phase},Tone.extend(Tone.LFO,Tone.Oscillator),Tone.LFO.defaults={type:"sine",min:0,max:1,phase:0,frequency:"4n",amplitude:1,units:Tone.Type.Default},Tone.LFO.prototype.start=function(time){return time=this.toSeconds(time),this._stoppedSignal.setValueAtTime(0,time),this._oscillator.start(time),this},Tone.LFO.prototype.stop=function(time){return time=this.toSeconds(time),this._stoppedSignal.setValueAtTime(this._stoppedValue,time),this._oscillator.stop(time),this},Tone.LFO.prototype.sync=function(delay){return this._oscillator.sync(delay),this._oscillator.syncFrequency(),this},Tone.LFO.prototype.unsync=function(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this},Object.defineProperty(Tone.LFO.prototype,"min",{get:function(){return this._toUnits(this._scaler.min)},set:function(min){min=this._fromUnits(min),this._scaler.min=min}}),Object.defineProperty(Tone.LFO.prototype,"max",{get:function(){return this._toUnits(this._scaler.max)},set:function(max){max=this._fromUnits(max),this._scaler.max=max}}),Object.defineProperty(Tone.LFO.prototype,"type",{get:function(){return this._oscillator.type},set:function(type){this._oscillator.type=type,this._stoppedValue=this._oscillator._getInitialValue(),this._stoppedSignal.value=this._stoppedValue}}),Object.defineProperty(Tone.LFO.prototype,"phase",{get:function(){return this._oscillator.phase},set:function(phase){this._oscillator.phase=phase,this._stoppedValue=this._oscillator._getInitialValue(),this._stoppedSignal.value=this._stoppedValue}}),Object.defineProperty(Tone.LFO.prototype,"units",{get:function(){return this._units},set:function(val){var currentMin=this.min,currentMax=this.max;this._units=val,this.min=currentMin,this.max=currentMax}}),Object.defineProperty(Tone.LFO.prototype,"state",{get:function(){return this._oscillator.state}}),Tone.LFO.prototype.connect=function(node){if(node.constructor===Tone.Signal||node.constructor===Tone.Param||node.constructor===Tone.TimelineSignal)this.convert=node.convert,this.units=node.units;return Tone.Signal.prototype.connect.apply(this,arguments),this},Tone.LFO.prototype._fromUnits=Tone.Param.prototype._fromUnits,Tone.LFO.prototype._toUnits=Tone.Param.prototype._toUnits,Tone.LFO.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._writable(["amplitude","frequency"]),this._oscillator.dispose(),this._oscillator=null,this._stoppedSignal.dispose(),this._stoppedSignal=null,this._scaler.dispose(),this._scaler=null,this._a2g.dispose(),this._a2g=null,this.frequency=null,this.amplitude=null,this},Tone.LFO}),define("Tone/component/EQMultiband",["Tone/core/Tone","Tone/component/Filter"],function(Tone){"use strict";return Tone.EQMultiband=function(options){this._bands=[],this.numberOfBands=options.length;for(var i=0;i<this.numberOfBands;i++){var filter=new Tone.Filter({type:options[i].type,frequency:options[i].frequency,rolloff:options[i].rolloff,Q:options[i].Q,gain:options[i].gain});this._bands.push(filter)}this.input=this._bands[0],this.output=this._bands[this.numberOfBands-1];var currentUnit=this._bands[0];for(var j=1;j<this._bands.length;j++){var toUnit=this._bands[j];currentUnit.connect(toUnit),currentUnit=toUnit}},Tone.extend(Tone.EQMultiband),Tone.EQMultiband.defaults=[{type:"lowshelf",frequency:80,rolloff:-12,Q:1,gain:0},{type:"peaking",frequency:160,rolloff:-12,Q:1,gain:0},{type:"peaking",frequency:480,rolloff:-12,Q:1,gain:0},{type:"peaking",frequency:1200,rolloff:-12,Q:1,gain:0},{type:"peaking",frequency:3e3,rolloff:-12,Q:1,gain:5},{type:"highshelf",frequency:12e3,rolloff:-12,Q:1,gain:10}],Tone.EQMultiband.prototype.setType=function(type,band){this._bands[band-1].type=type},Tone.EQMultiband.prototype.getType=function(band){return this._bands[band-1].type},Tone.EQMultiband.prototype.setFrequency=function(freq,band){this._bands[band-1].frequency.value=freq},Tone.EQMultiband.prototype.getFrequency=function(band){return this._bands[band-1].frequency.value},Tone.EQMultiband.prototype.setQ=function(Q,band){this._bands[band-1].Q.value=Q},Tone.EQMultiband.prototype.getQ=function(band){return this._bands[band-1].Q.value},Tone.EQMultiband.prototype.setGain=function(gain,band){this._bands[band-1].gain.value=gain},Tone.EQMultiband.prototype.getGain=function(band){return this._bands[band-1].gain.value},Tone.EQMultiband.prototype.dispose=function(){Tone.prototype.dispose.call(this);for(var i=0;i<this._bands.length;i++)this._bands[i].dispose();this.numberOfBands=null,this._bands=null},Tone.EQMultiband}),define("Tone/core/Master",["Tone/core/Tone","Tone/component/Volume"],function(Tone){"use strict";Tone.Master=function(){Tone.call(this),this._unmutedVolume=1,this._muted=!1,this._volume=this.output=new Tone.Volume,this.volume=this._volume.volume,this._readOnly("volume"),this.input.chain(this.output,this.context.destination)},Tone.extend(Tone.Master),Tone.Master.defaults={volume:0,mute:!1},Object.defineProperty(Tone.Master.prototype,"mute",{get:function(){return this._muted},set:function(mute){!this._muted&&mute?(this._unmutedVolume=this.volume.value,this.volume.value=-Infinity):this._muted&&!mute&&(this.volume.value=this._unmutedVolume),this._muted=mute}}),Tone.Master.prototype.chain=function(){this.input.disconnect(),this.input.chain.apply(this.input,arguments),arguments[arguments.length-1].connect(this.output)},Tone.Master.prototype.dispose=function(){Tone.prototype.dispose.call(this),this._writable("volume"),this._volume.dispose(),this._volume=null,this.volume=null},Tone.prototype.toMaster=function(){return this.connect(Tone.Master),this},AudioNode.prototype.toMaster=function(){return this.connect(Tone.Master),this};var MasterConstructor=Tone.Master;return Tone._initAudioContext(function(){Tone.prototype.isUndef(Tone.Master)?(MasterConstructor.prototype.dispose.call(Tone.Master),MasterConstructor.call(Tone.Master)):Tone.Master=new MasterConstructor}),Tone.Master}),define("Tone/core/Note",["Tone/core/Tone","Tone/core/Transport"],function(Tone){"use strict";Tone.Note=function(channel,time,value){this.value=value,this._channel=channel,this._timelineID=Tone.Transport.setTimeline(this._trigger.bind(this),time)},Tone.Note.prototype._trigger=function(time){channelCallbacks(this._channel,time,this.value)},Tone.Note.prototype.dispose=function(){return Tone.Transport.clearTimeline(this._timelineID),this.value=null,this};var NoteChannels={};function channelCallbacks(channel,time,value){if(NoteChannels.hasOwnProperty(channel)){var callbacks=NoteChannels[channel];for(var i=0,len=callbacks.length;i<len;i++){var callback=callbacks[i];Array.isArray(value)?callback.apply(window,[time].concat(value)):callback(time,value)}}}return Tone.Note.route=function(channel,callback){NoteChannels.hasOwnProperty(channel)?NoteChannels[channel].push(callback):NoteChannels[channel]=[callback]},Tone.Note.unroute=function(channel,callback){if(NoteChannels.hasOwnProperty(channel)){var channelCallback=NoteChannels[channel],index=channelCallback.indexOf(callback);index!==-1&&NoteChannels[channel].splice(index,1)}},Tone.Note.parseScore=function(score){var notes=[];for(var inst in score){var part=score[inst];if(inst==="tempo")Tone.Transport.bpm.value=part;else if(inst==="timeSignature")Tone.Transport.timeSignature=part[0]/(part[1]/4);else{if(!Array.isArray(part))throw new TypeError("score parts must be Arrays");for(var i=0;i<part.length;i++){var noteDescription=part[i],note;if(Array.isArray(noteDescription)){var time=noteDescription[0],value=noteDescription.slice(1);note=new Tone.Note(inst,time,value)}else typeof noteDescription=="object"?note=new Tone.Note(inst,noteDescription.time,noteDescription):note=new Tone.Note(inst,noteDescription);notes.push(note)}}}return notes},Tone.Note}),define("Tone/signal/Negate",["Tone/core/Tone","Tone/signal/Multiply","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Negate=function(){this._multiply=this.input=this.output=new Tone.Multiply(-1)},Tone.extend(Tone.Negate,Tone.SignalBase),Tone.Negate.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._multiply.dispose(),this._multiply=null,this},Tone.Negate}),define("Tone/signal/Subtract",["Tone/core/Tone","Tone/signal/Add","Tone/signal/Negate","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Subtract=function(value){Tone.call(this,2,0),this._sum=this.input[0]=this.output=this.context.createGain(),this._neg=new Tone.Negate,this._param=this.input[1]=new Tone.Signal(value),this._param.chain(this._neg,this._sum)},Tone.extend(Tone.Subtract,Tone.Signal),Tone.Subtract.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._neg.dispose(),this._neg=null,this._sum.disconnect(),this._sum=null,this._param.dispose(),this._param=null,this},Tone.Subtract}),define("Tone/signal/GreaterThanZero",["Tone/core/Tone","Tone/signal/Signal","Tone/signal/Multiply","Tone/signal/WaveShaper"],function(Tone){"use strict";return Tone.GreaterThanZero=function(){this._thresh=this.output=new Tone.WaveShaper(function(val){return val<=0?0:1}),this._scale=this.input=new Tone.Multiply(1e4),this._scale.connect(this._thresh)},Tone.extend(Tone.GreaterThanZero,Tone.SignalBase),Tone.GreaterThanZero.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._scale.dispose(),this._scale=null,this._thresh.dispose(),this._thresh=null,this},Tone.GreaterThanZero}),define("Tone/signal/EqualZero",["Tone/core/Tone","Tone/signal/Signal","Tone/signal/GreaterThanZero","Tone/signal/WaveShaper"],function(Tone){"use strict";return Tone.EqualZero=function(){this._scale=this.input=new Tone.Multiply(1e4),this._thresh=new Tone.WaveShaper(function(val){return val===0?1:0},128),this._gtz=this.output=new Tone.GreaterThanZero,this._scale.chain(this._thresh,this._gtz)},Tone.extend(Tone.EqualZero,Tone.SignalBase),Tone.EqualZero.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._gtz.dispose(),this._gtz=null,this._scale.dispose(),this._scale=null,this._thresh.dispose(),this._thresh=null,this},Tone.EqualZero}),define("Tone/signal/Equal",["Tone/core/Tone","Tone/signal/EqualZero","Tone/signal/Subtract","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Equal=function(value){Tone.call(this,2,0),this._sub=this.input[0]=new Tone.Subtract(value),this._equals=this.output=new Tone.EqualZero,this._sub.connect(this._equals),this.input[1]=this._sub.input[1]},Tone.extend(Tone.Equal,Tone.SignalBase),Object.defineProperty(Tone.Equal.prototype,"value",{get:function(){return this._sub.value},set:function(value){this._sub.value=value}}),Tone.Equal.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._equals.dispose(),this._equals=null,this._sub.dispose(),this._sub=null,this},Tone.Equal}),define("Tone/signal/Select",["Tone/core/Tone","Tone/signal/Equal","Tone/signal/Signal"],function(Tone){"use strict";Tone.Select=function(sourceCount){sourceCount=this.defaultArg(sourceCount,2),Tone.call(this,sourceCount,1),this.gate=new Tone.Signal(0),this._readOnly("gate");for(var i=0;i<sourceCount;i++){var switchGate=new SelectGate(i);this.input[i]=switchGate,this.gate.connect(switchGate.selecter),switchGate.connect(this.output)}},Tone.extend(Tone.Select,Tone.SignalBase),Tone.Select.prototype.select=function(which,time){return which=Math.floor(which),this.gate.setValueAtTime(which,this.toSeconds(time)),this},Tone.Select.prototype.dispose=function(){this._writable("gate"),this.gate.dispose(),this.gate=null;for(var i=0;i<this.input.length;i++)this.input[i].dispose(),this.input[i]=null;return Tone.prototype.dispose.call(this),this};var SelectGate=function(num){this.selecter=new Tone.Equal(num),this.gate=this.input=this.output=this.context.createGain(),this.selecter.connect(this.gate.gain)};return Tone.extend(SelectGate),SelectGate.prototype.dispose=function(){Tone.prototype.dispose.call(this),this.selecter.dispose(),this.gate.disconnect(),this.selecter=null,this.gate=null},Tone.Select}),define("Tone/signal/IfThenElse",["Tone/core/Tone","Tone/signal/Select","Tone/signal/Equal"],function(Tone){"use strict";return Tone.IfThenElse=function(){Tone.call(this,3,0),this._selector=this.output=new Tone.Select(2),this.if=this.input[0]=this._selector.gate,this.then=this.input[1]=this._selector.input[1],this.else=this.input[2]=this._selector.input[0]},Tone.extend(Tone.IfThenElse,Tone.SignalBase),Tone.IfThenElse.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._selector.dispose(),this._selector=null,this.if=null,this.then=null,this.else=null,this},Tone.IfThenElse}),define("Tone/signal/OR",["Tone/core/Tone","Tone/signal/GreaterThanZero"],function(Tone){"use strict";return Tone.OR=function(inputCount){inputCount=this.defaultArg(inputCount,2),Tone.call(this,inputCount,0),this._sum=this.context.createGain(),this._gtz=this.output=new Tone.GreaterThanZero;for(var i=0;i<inputCount;i++)this.input[i]=this._sum;this._sum.connect(this._gtz)},Tone.extend(Tone.OR,Tone.SignalBase),Tone.OR.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._gtz.dispose(),this._gtz=null,this._sum.disconnect(),this._sum=null,this},Tone.OR}),define("Tone/signal/AND",["Tone/core/Tone","Tone/signal/Equal"],function(Tone){"use strict";return Tone.AND=function(inputCount){inputCount=this.defaultArg(inputCount,2),Tone.call(this,inputCount,0),this._equals=this.output=new Tone.Equal(inputCount);for(var i=0;i<inputCount;i++)this.input[i]=this._equals},Tone.extend(Tone.AND,Tone.SignalBase),Tone.AND.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._equals.dispose(),this._equals=null,this},Tone.AND}),define("Tone/signal/NOT",["Tone/core/Tone","Tone/signal/EqualZero"],function(Tone){"use strict";return Tone.NOT=Tone.EqualZero,Tone.NOT}),define("Tone/signal/GreaterThan",["Tone/core/Tone","Tone/signal/GreaterThanZero","Tone/signal/Subtract","Tone/signal/Signal"],function(Tone){"use strict";return Tone.GreaterThan=function(value){Tone.call(this,2,0),this._param=this.input[0]=new Tone.Subtract(value),this.input[1]=this._param.input[1],this._gtz=this.output=new Tone.GreaterThanZero,this._param.connect(this._gtz)},Tone.extend(Tone.GreaterThan,Tone.Signal),Tone.GreaterThan.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._param.dispose(),this._param=null,this._gtz.dispose(),this._gtz=null,this},Tone.GreaterThan}),define("Tone/signal/LessThan",["Tone/core/Tone","Tone/signal/GreaterThan","Tone/signal/Negate","Tone/signal/Signal"],function(Tone){"use strict";return Tone.LessThan=function(value){Tone.call(this,2,0),this._neg=this.input[0]=new Tone.Negate,this._gt=this.output=new Tone.GreaterThan,this._rhNeg=new Tone.Negate,this._param=this.input[1]=new Tone.Signal(value),this._neg.connect(this._gt),this._param.connect(this._rhNeg),this._rhNeg.connect(this._gt,0,1)},Tone.extend(Tone.LessThan,Tone.Signal),Tone.LessThan.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._neg.dispose(),this._neg=null,this._gt.dispose(),this._gt=null,this._rhNeg.dispose(),this._rhNeg=null,this._param.dispose(),this._param=null,this},Tone.LessThan}),define("Tone/signal/Abs",["Tone/core/Tone","Tone/signal/Select","Tone/signal/Negate","Tone/signal/LessThan","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Abs=function(){Tone.call(this,1,0),this._ltz=new Tone.LessThan(0),this._switch=this.output=new Tone.Select(2),this._negate=new Tone.Negate,this.input.connect(this._switch,0,0),this.input.connect(this._negate),this._negate.connect(this._switch,0,1),this.input.chain(this._ltz,this._switch.gate)},Tone.extend(Tone.Abs,Tone.SignalBase),Tone.Abs.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._switch.dispose(),this._switch=null,this._ltz.dispose(),this._ltz=null,this._negate.dispose(),this._negate=null,this},Tone.Abs}),define("Tone/signal/Max",["Tone/core/Tone","Tone/signal/GreaterThan","Tone/signal/IfThenElse","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Max=function(max){Tone.call(this,2,0),this.input[0]=this.context.createGain(),this._param=this.input[1]=new Tone.Signal(max),this._ifThenElse=this.output=new Tone.IfThenElse,this._gt=new Tone.GreaterThan,this.input[0].chain(this._gt,this._ifThenElse.if),this.input[0].connect(this._ifThenElse.then),this._param.connect(this._ifThenElse.else),this._param.connect(this._gt,0,1)},Tone.extend(Tone.Max,Tone.Signal),Tone.Max.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._param.dispose(),this._ifThenElse.dispose(),this._gt.dispose(),this._param=null,this._ifThenElse=null,this._gt=null,this},Tone.Max}),define("Tone/signal/Min",["Tone/core/Tone","Tone/signal/LessThan","Tone/signal/IfThenElse","Tone/signal/Signal"],function(Tone){"use strict";return Tone.Min=function(min){Tone.call(this,2,0),this.input[0]=this.context.createGain(),this._ifThenElse=this.output=new Tone.IfThenElse,this._lt=new Tone.LessThan,this._param=this.input[1]=new Tone.Signal(min),this.input[0].chain(this._lt,this._ifThenElse.if),this.input[0].connect(this._ifThenElse.then),this._param.connect(this._ifThenElse.else),this._param.connect(this._lt,0,1)},Tone.extend(Tone.Min,Tone.Signal),Tone.Min.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._param.dispose(),this._ifThenElse.dispose(),this._lt.dispose(),this._param=null,this._ifThenElse=null,this._lt=null,this},Tone.Min}),define("Tone/signal/Modulo",["Tone/core/Tone","Tone/signal/WaveShaper","Tone/signal/Multiply","Tone/signal/Subtract"],function(Tone){"use strict";return Tone.Modulo=function(modulus){Tone.call(this,1,1),this._shaper=new Tone.WaveShaper(Math.pow(2,16)),this._multiply=new Tone.Multiply,this._subtract=this.output=new Tone.Subtract,this._modSignal=new Tone.Signal(modulus),this.input.fan(this._shaper,this._subtract),this._modSignal.connect(this._multiply,0,0),this._shaper.connect(this._multiply,0,1),this._multiply.connect(this._subtract,0,1),this._setWaveShaper(modulus)},Tone.extend(Tone.Modulo,Tone.SignalBase),Tone.Modulo.prototype._setWaveShaper=function(mod){this._shaper.setMap(function(val){var multiple=Math.floor((val+1e-4)/mod);return multiple})},Object.defineProperty(Tone.Modulo.prototype,"value",{get:function(){return this._modSignal.value},set:function(mod){this._modSignal.value=mod,this._setWaveShaper(mod)}}),Tone.Modulo.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._shaper.dispose(),this._shaper=null,this._multiply.dispose(),this._multiply=null,this._subtract.dispose(),this._subtract=null,this._modSignal.dispose(),this._modSignal=null,this},Tone.Modulo}),define("Tone/signal/Expr",["Tone/core/Tone","Tone/signal/Add","Tone/signal/Subtract","Tone/signal/Multiply","Tone/signal/IfThenElse","Tone/signal/OR","Tone/signal/AND","Tone/signal/NOT","Tone/signal/GreaterThan","Tone/signal/LessThan","Tone/signal/Equal","Tone/signal/EqualZero","Tone/signal/GreaterThanZero","Tone/signal/Abs","Tone/signal/Negate","Tone/signal/Max","Tone/signal/Min","Tone/signal/Modulo","Tone/signal/Pow","Tone/signal/AudioToGain"],function(Tone){"use strict";Tone.Expr=function(){var expr=this._replacements(Array.prototype.slice.call(arguments)),inputCount=this._parseInputs(expr);this._nodes=[],this.input=new Array(inputCount);for(var i=0;i<inputCount;i++)this.input[i]=this.context.createGain();var tree=this._parseTree(expr),result;try{result=this._eval(tree)}catch(e){throw this._disposeNodes(),new Error("Could evaluate expression: "+expr)}this.output=result},Tone.extend(Tone.Expr,Tone.SignalBase);function applyBinary(Constructor,args,self){var op=new Constructor;return self._eval(args[0]).connect(op,0,0),self._eval(args[1]).connect(op,0,1),op}function applyUnary(Constructor,args,self){var op=new Constructor;return self._eval(args[0]).connect(op,0,0),op}function getNumber(arg){return arg?parseFloat(arg):undefined}function literalNumber(arg){return arg&&arg.args?parseFloat(arg.args):undefined}return Tone.Expr._Expressions={value:{signal:{regexp:/^\d+\.\d+|^\d+/,method:function(arg){var sig=new Tone.Signal(getNumber(arg));return sig}},input:{regexp:/^\$\d/,method:function(arg,self){return self.input[getNumber(arg.substr(1))]}}},glue:{"(":{regexp:/^\(/},")":{regexp:/^\)/},",":{regexp:/^,/}},func:{abs:{regexp:/^abs/,method:applyUnary.bind(this,Tone.Abs)},min:{regexp:/^min/,method:applyBinary.bind(this,Tone.Min)},max:{regexp:/^max/,method:applyBinary.bind(this,Tone.Max)},"if":{regexp:/^if/,method:function(args,self){var op=new Tone.IfThenElse;return self._eval(args[0]).connect(op.if),self._eval(args[1]).connect(op.then),self._eval(args[2]).connect(op.else),op}},gt0:{regexp:/^gt0/,method:applyUnary.bind(this,Tone.GreaterThanZero)},eq0:{regexp:/^eq0/,method:applyUnary.bind(this,Tone.EqualZero)},mod:{regexp:/^mod/,method:function(args,self){var modulus=literalNumber(args[1]),op=new Tone.Modulo(modulus);return self._eval(args[0]).connect(op),op}},pow:{regexp:/^pow/,method:function(args,self){var exp=literalNumber(args[1]),op=new Tone.Pow(exp);return self._eval(args[0]).connect(op),op}},a2g:{regexp:/^a2g/,method:function(args,self){var op=new Tone.AudioToGain;return self._eval(args[0]).connect(op),op}}},binary:{"+":{regexp:/^\+/,precedence:1,method:applyBinary.bind(this,Tone.Add)},"-":{regexp:/^\-/,precedence:1,method:function(args,self){return args.length===1?applyUnary(Tone.Negate,args,self):applyBinary(Tone.Subtract,args,self)}},"*":{regexp:/^\*/,precedence:0,method:applyBinary.bind(this,Tone.Multiply)},">":{regexp:/^\>/,precedence:2,method:applyBinary.bind(this,Tone.GreaterThan)},"<":{regexp:/^</,precedence:2,method:applyBinary.bind(this,Tone.LessThan)},"==":{regexp:/^==/,precedence:3,method:applyBinary.bind(this,Tone.Equal)},"&&":{regexp:/^&&/,precedence:4,method:applyBinary.bind(this,Tone.AND)},"||":{regexp:/^\|\|/,precedence:5,method:applyBinary.bind(this,Tone.OR)}},unary:{"-":{regexp:/^\-/,method:applyUnary.bind(this,Tone.Negate)},"!":{regexp:/^\!/,method:applyUnary.bind(this,Tone.NOT)}}},Tone.Expr.prototype._parseInputs=function(expr){var inputArray=expr.match(/\$\d/g),inputMax=0;if(inputArray!==null)for(var i=0;i<inputArray.length;i++){var inputNum=parseInt(inputArray[i].substr(1))+1;inputMax=Math.max(inputMax,inputNum)}return inputMax},Tone.Expr.prototype._replacements=function(args){var expr=args.shift();for(var i=0;i<args.length;i++)expr=expr.replace(/\%/i,args[i]);return expr},Tone.Expr.prototype._tokenize=function(expr){var position=-1,tokens=[];while(expr.length>0){expr=expr.trim();var token=getNextToken(expr);tokens.push(token),expr=expr.substr(token.value.length)}function getNextToken(expr){for(var type in Tone.Expr._Expressions){var group=Tone.Expr._Expressions[type];for(var opName in group){var op=group[opName],reg=op.regexp,match=expr.match(reg);if(match!==null)return{type:type,value:match[0],method:op.method}}}throw new SyntaxError("Unexpected token "+expr)}return{next:function(){return tokens[++position]},peek:function(){return tokens[position+1]}}},Tone.Expr.prototype._parseTree=function(expr){var lexer=this._tokenize(expr),isUndef=this.isUndef.bind(this);function matchSyntax(token,syn){return!isUndef(token)&&token.type==="glue"&&token.value===syn}function matchGroup(token,groupName,prec){var ret=!1,group=Tone.Expr._Expressions[groupName];if(!isUndef(token))for(var opName in group){var op=group[opName];if(op.regexp.test(token.value)){if(!!isUndef(prec))return!0;if(op.precedence===prec)return!0}}return ret}function parseExpression(precedence){isUndef(precedence)&&(precedence=5);var expr;precedence<0?expr=parseUnary():expr=parseExpression(precedence-1);var token=lexer.peek();while(matchGroup(token,"binary",precedence))token=lexer.next(),expr={operator:token.value,method:token.method,args:[expr,parseExpression(precedence)]},token=lexer.peek();return expr}function parseUnary(){var token,expr;return token=lexer.peek(),matchGroup(token,"unary")?(token=lexer.next(),expr=parseUnary(),{operator:token.value,method:token.method,args:[expr]}):parsePrimary()}function parsePrimary(){var token,expr;token=lexer.peek();if(isUndef(token))throw new SyntaxError("Unexpected termination of expression");if(token.type==="func")return token=lexer.next(),parseFunctionCall(token);if(token.type==="value")return token=lexer.next(),{method:token.method,args:token.value};if(matchSyntax(token,"(")){lexer.next(),expr=parseExpression(),token=lexer.next();if(!matchSyntax(token,")"))throw new SyntaxError("Expected )");return expr}throw new SyntaxError("Parse error, cannot process token "+token.value)}function parseFunctionCall(func){var token,args=[];token=lexer.next();if(!matchSyntax(token,"("))throw new SyntaxError('Expected ( in a function call "'+func.value+'"');token=lexer.peek(),matchSyntax(token,")")||(args=parseArgumentList()),token=lexer.next();if(!matchSyntax(token,")"))throw new SyntaxError('Expected ) in a function call "'+func.value+'"');return{method:func.method,args:args,name:name}}function parseArgumentList(){var token,expr,args=[];for(;;){expr=parseExpression();if(isUndef(expr))break;args.push(expr),token=lexer.peek();if(!matchSyntax(token,","))break;lexer.next()}return args}return parseExpression()},Tone.Expr.prototype._eval=function(tree){if(!this.isUndef(tree)){var node=tree.method(tree.args,this);return this._nodes.push(node),node}},Tone.Expr.prototype._disposeNodes=function(){for(var i=0;i<this._nodes.length;i++){var node=this._nodes[i];this.isFunction(node.dispose)?node.dispose():this.isFunction(node.disconnect)&&node.disconnect(),node=null,this._nodes[i]=null}this._nodes=null},Tone.Expr.prototype.dispose=function(){Tone.prototype.dispose.call(this),this._disposeNodes()},Tone.Expr}),define("Tone/signal/EqualPowerGain",["Tone/core/Tone","Tone/signal/WaveShaper"],function(Tone){"use strict";return Tone.EqualPowerGain=function(){this._eqPower=this.input=this.output=new Tone.WaveShaper(function(val){return Math.abs(val)<.001?0:this.equalPowerScale(val)}.bind(this),4096)},Tone.extend(Tone.EqualPowerGain,Tone.SignalBase),Tone.EqualPowerGain.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._eqPower.dispose(),this._eqPower=null,this},Tone.EqualPowerGain}),define("Tone/component/CrossFade",["Tone/core/Tone","Tone/signal/Signal","Tone/signal/Expr","Tone/signal/EqualPowerGain"],function(Tone){"use strict";return Tone.CrossFade=function(initialFade){Tone.call(this,2,1),this.a=this.input[0]=this.context.createGain(),this.b=this.input[1]=this.context.createGain(),this.fade=new Tone.Signal(this.defaultArg(initialFade,.5),Tone.Type.NormalRange),this._equalPowerA=new Tone.EqualPowerGain,this._equalPowerB=new Tone.EqualPowerGain,this._invert=new Tone.Expr("1 - $0"),this.a.connect(this.output),this.b.connect(this.output),this.fade.chain(this._equalPowerB,this.b.gain),this.fade.chain(this._invert,this._equalPowerA,this.a.gain),this._readOnly("fade")},Tone.extend(Tone.CrossFade),Tone.CrossFade.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._writable("fade"),this._equalPowerA.dispose(),this._equalPowerA=null,this._equalPowerB.dispose(),this._equalPowerB=null,this.fade.dispose(),this.fade=null,this._invert.dispose(),this._invert=null,this.a.disconnect(),this.a=null,this.b.disconnect(),this.b=null,this},Tone.CrossFade}),define("Tone/effect/Effect",["Tone/core/Tone","Tone/component/CrossFade"],function(Tone){"use strict";return Tone.Effect=function(){Tone.call(this);var options=this.optionsObject(arguments,["wet"],Tone.Effect.defaults);this._dryWet=new Tone.CrossFade(options.wet),this.wet=this._dryWet.fade,this.effectSend=this.context.createGain(),this.effectReturn=this.context.createGain(),this.input.connect(this._dryWet.a),this.input.connect(this.effectSend),this.effectReturn.connect(this._dryWet.b),this._dryWet.connect(this.output),this._readOnly(["wet"])},Tone.extend(Tone.Effect),Tone.Effect.defaults={wet:1},Tone.Effect.prototype.connectEffect=function(effect){return this.effectSend.chain(effect,this.effectReturn),this},Tone.Effect.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._dryWet.dispose(),this._dryWet=null,this.effectSend.disconnect(),this.effectSend=null,this.effectReturn.disconnect(),this.effectReturn=null,this._writable(["wet"]),this.wet=null,this},Tone.Effect}),define("Tone/component/Merge",["Tone/core/Tone"],function(Tone){"use strict";return Tone.Merge=function(){Tone.call(this,2,0),this.left=this.input[0]=this.context.createGain(),this.right=this.input[1]=this.context.createGain(),this._merger=this.output=this.context.createChannelMerger(2),this.left.connect(this._merger,0,0),this.right.connect(this._merger,0,1),this.left.channelCount=1,this.right.channelCount=1,this.left.channelCountMode="explicit",this.right.channelCountMode="explicit"},Tone.extend(Tone.Merge),Tone.Merge.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this.left.disconnect(),this.left=null,this.right.disconnect(),this.right=null,this._merger.disconnect(),this._merger=null,this},Tone.Merge}),define("Tone/component/Split",["Tone/core/Tone"],function(Tone){"use strict";return Tone.Split=function(){Tone.call(this,0,2),this._splitter=this.input=this.context.createChannelSplitter(2),this.left=this.output[0]=this.context.createGain(),this.right=this.output[1]=this.context.createGain(),this._splitter.connect(this.left,0,0),this._splitter.connect(this.right,1,0)},Tone.extend(Tone.Split),Tone.Split.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._splitter.disconnect(),this.left.disconnect(),this.right.disconnect(),this.left=null,this.right=null,this._splitter=null,this},Tone.Split}),define("Tone/signal/GainToAudio",["Tone/core/Tone","Tone/signal/WaveShaper","Tone/signal/Signal"],function(Tone){"use strict";return Tone.GainToAudio=function(){this._norm=this.input=this.output=new Tone.WaveShaper(function(x){return Math.abs(x)*2-1})},Tone.extend(Tone.GainToAudio,Tone.SignalBase),Tone.GainToAudio.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._norm.dispose(),this._norm=null,this},Tone.GainToAudio}),define("Tone/component/Panner",["Tone/core/Tone","Tone/component/CrossFade","Tone/component/Merge","Tone/component/Split","Tone/signal/Signal","Tone/signal/GainToAudio"],function(Tone){"use strict";return Tone.Panner=function(initialPan){Tone.call(this),this._hasStereoPanner=this.isFunction(this.context.createStereoPanner),this._hasStereoPanner?(this._panner=this.input=this.output=this.context.createStereoPanner(),this.pan=new Tone.Signal(0,Tone.Type.NormalRange),this._scalePan=new Tone.GainToAudio,this.pan.chain(this._scalePan,this._panner.pan)):(this._crossFade=new Tone.CrossFade,this._merger=this.output=new Tone.Merge,this._splitter=this.input=new Tone.Split,this.pan=this._crossFade.fade,this._splitter.connect(this._crossFade,0,0),this._splitter.connect(this._crossFade,1,1),this._crossFade.a.connect(this._merger,0,0),this._crossFade.b.connect(this._merger,0,1)),this.pan.value=this.defaultArg(initialPan,.5),this._readOnly("pan")},Tone.extend(Tone.Panner),Tone.Panner.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._writable("pan"),this._hasStereoPanner?(this._panner.disconnect(),this._panner=null,this.pan.dispose(),this.pan=null,this._scalePan.dispose(),this._scalePan=null):(this._crossFade.dispose(),this._crossFade=null,this._splitter.dispose(),this._splitter=null,this._merger.dispose(),this._merger=null,this.pan=null),this},Tone.Panner}),define("Tone/effect/AutoPanner",["Tone/core/Tone","Tone/effect/Effect","Tone/component/LFO","Tone/component/Panner"],function(Tone){"use strict";return Tone.AutoPanner=function(){var options=this.optionsObject(arguments,["frequency"],Tone.AutoPanner.defaults);Tone.Effect.call(this,options),this._lfo=new Tone.LFO({frequency:options.frequency,amplitude:options.depth,min:0,max:1}),this.depth=this._lfo.amplitude,this._panner=new Tone.Panner,this.frequency=this._lfo.frequency,this.connectEffect(this._panner),this._lfo.connect(this._panner.pan),this.type=options.type,this._readOnly(["depth","frequency"])},Tone.extend(Tone.AutoPanner,Tone.Effect),Tone.AutoPanner.defaults={frequency:1,type:"sine",depth:1},Tone.AutoPanner.prototype.start=function(time){return this._lfo.start(time),this},Tone.AutoPanner.prototype.stop=function(time){return this._lfo.stop(time),this},Tone.AutoPanner.prototype.sync=function(delay){return this._lfo.sync(delay),this},Tone.AutoPanner.prototype.unsync=function(){return this._lfo.unsync(),this},Object.defineProperty(Tone.AutoPanner.prototype,"type",{get:function(){return this._lfo.type},set:function(type){this._lfo.type=type}}),Tone.AutoPanner.prototype.dispose=function(){return Tone.Effect.prototype.dispose.call(this),this._lfo.dispose(),this._lfo=null,this._panner.dispose(),this._panner=null,this._writable(["depth","frequency"]),this.frequency=null,this.depth=null,this},Tone.AutoPanner}),define("Tone/component/Follower",["Tone/core/Tone","Tone/signal/Abs","Tone/signal/Subtract","Tone/signal/Multiply","Tone/signal/Signal","Tone/signal/WaveShaper","Tone/core/Type"],function(Tone){"use strict";return Tone.Follower=function(){Tone.call(this);var options=this.optionsObject(arguments,["attack","release"],Tone.Follower.defaults);this._abs=new Tone.Abs,this._filter=this.context.createBiquadFilter(),this._filter.type="lowpass",this._filter.frequency.value=0,this._filter.Q.value=-100,this._frequencyValues=new Tone.WaveShaper,this._sub=new Tone.Subtract,this._delay=this.context.createDelay(),this._delay.delayTime.value=this.blockTime,this._mult=new Tone.Multiply(1e4),this._attack=options.attack,this._release=options.release,this.input.chain(this._abs,this._filter,this.output),this._abs.connect(this._sub,0,1),this._filter.chain(this._delay,this._sub),this._sub.chain(this._mult,this._frequencyValues,this._filter.frequency),this._setAttackRelease(this._attack,this._release)},Tone.extend(Tone.Follower),Tone.Follower.defaults={attack:.05,release:.5},Tone.Follower.prototype._setAttackRelease=function(attack,release){var minTime=this.blockTime;attack=this.secondsToFrequency(this.toSeconds(attack)),release=this.secondsToFrequency(this.toSeconds(release)),attack=Math.max(attack,minTime),release=Math.max(release,minTime),this._frequencyValues.setMap(function(val){return val<=0?attack:release})},Object.defineProperty(Tone.Follower.prototype,"attack",{get:function(){return this._attack},set:function(attack){this._attack=attack,this._setAttackRelease(this._attack,this._release)}}),Object.defineProperty(Tone.Follower.prototype,"release",{get:function(){return this._release},set:function(release){this._release=release,this._setAttackRelease(this._attack,this._release)}}),Tone.Follower.prototype.connect=Tone.Signal.prototype.connect,Tone.Follower.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._filter.disconnect(),this._filter=null,this._frequencyValues.disconnect(),this._frequencyValues=null,this._delay.disconnect(),this._delay=null,this._sub.disconnect(),this._sub=null,this._abs.dispose(),this._abs=null,this._mult.dispose(),this._mult=null,this._curve=null,this},Tone.Follower}),define("Tone/signal/ScaleExp",["Tone/core/Tone","Tone/signal/Scale","Tone/signal/Pow"],function(Tone){return Tone.ScaleExp=function(outputMin,outputMax,exponent){this._scale=this.output=new Tone.Scale(outputMin,outputMax),this._exp=this.input=new Tone.Pow(this.defaultArg(exponent,2)),this._exp.connect(this._scale)},Tone.extend(Tone.ScaleExp,Tone.SignalBase),Object.defineProperty(Tone.ScaleExp.prototype,"exponent",{get:function(){return this._exp.value},set:function(exp){this._exp.value=exp}}),Object.defineProperty(Tone.ScaleExp.prototype,"min",{get:function(){return this._scale.min},set:function(min){this._scale.min=min}}),Object.defineProperty(Tone.ScaleExp.prototype,"max",{get:function(){return this._scale.max},set:function(max){this._scale.max=max}}),Tone.ScaleExp.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._scale.dispose(),this._scale=null,this._exp.dispose(),this._exp=null,this},Tone.ScaleExp}),define("Tone/effect/AutoWah",["Tone/core/Tone","Tone/component/Follower","Tone/signal/ScaleExp","Tone/effect/Effect","Tone/component/Filter"],function(Tone){"use strict";return Tone.AutoWah=function(){var options=this.optionsObject(arguments,["baseFrequency","octaves","sensitivity"],Tone.AutoWah.defaults);Tone.Effect.call(this,options),this.follower=new Tone.Follower(options.follower),this._sweepRange=new Tone.ScaleExp(0,1,.5),this._baseFrequency=options.baseFrequency,this._octaves=options.octaves,this._inputBoost=this.context.createGain(),this._bandpass=new Tone.Filter({rolloff:-48,frequency:0,Q:options.Q}),this._peaking=new Tone.Filter(0,"peaking"),this._peaking.gain.value=options.gain,this.gain=this._peaking.gain,this.Q=this._bandpass.Q,this.effectSend.chain(this._inputBoost,this.follower,this._sweepRange),this._sweepRange.connect(this._bandpass.frequency),this._sweepRange.connect(this._peaking.frequency),this.effectSend.chain(this._bandpass,this._peaking,this.effectReturn),this._setSweepRange(),this.sensitivity=options.sensitivity,this._readOnly(["gain","Q"])},Tone.extend(Tone.AutoWah,Tone.Effect),Tone.AutoWah.defaults={baseFrequency:100,octaves:6,sensitivity:0,Q:2,gain:2,follower:{attack:.3,release:.5}},Object.defineProperty(Tone.AutoWah.prototype,"octaves",{get:function(){return this._octaves},set:function(octaves){this._octaves=octaves,this._setSweepRange()}}),Object.defineProperty(Tone.AutoWah.prototype,"baseFrequency",{get:function(){return this._baseFrequency},set:function(baseFreq){this._baseFrequency=baseFreq,this._setSweepRange()}}),Object.defineProperty(Tone.AutoWah.prototype,"sensitivity",{get:function(){return this.gainToDb(1/this._inputBoost.gain.value)},set:function(sensitivy){this._inputBoost.gain.value=1/this.dbToGain(sensitivy)}}),Tone.AutoWah.prototype._setSweepRange=function(){this._sweepRange.min=this._baseFrequency,this._sweepRange.max=Math.min(this._baseFrequency*Math.pow(2,this._octaves),this.context.sampleRate/2)},Tone.AutoWah.prototype.dispose=function(){return Tone.Effect.prototype.dispose.call(this),this.follower.dispose(),this.follower=null,this._sweepRange.dispose(),this._sweepRange=null,this._bandpass.dispose(),this._bandpass=null,this._peaking.dispose(),this._peaking=null,this._inputBoost.disconnect(),this._inputBoost=null,this._writable(["gain","Q"]),this.gain=null,this.Q=null,this},Tone.AutoWah}),define("Tone/effect/BitCrusher",["Tone/core/Tone","Tone/effect/Effect","Tone/signal/Subtract","Tone/signal/Modulo"],function(Tone){"use strict";return Tone.BitCrusher=function(){var options=this.optionsObject(arguments,["bits"],Tone.BitCrusher.defaults);Tone.Effect.call(this,options);var invStepSize=1/Math.pow(2,options.bits-1);this._subtract=new Tone.Subtract,this._modulo=new Tone.Modulo(invStepSize),this._bits=options.bits,this.effectSend.fan(this._subtract,this._modulo),this._modulo.connect(this._subtract,0,1),this._subtract.connect(this.effectReturn)},Tone.extend(Tone.BitCrusher,Tone.Effect),Tone.BitCrusher.defaults={bits:4},Object.defineProperty(Tone.BitCrusher.prototype,"bits",{get:function(){return this._bits},set:function(bits){this._bits=bits;var invStepSize=1/Math.pow(2,bits-1);this._modulo.value=invStepSize}}),Tone.BitCrusher.prototype.dispose=function(){return Tone.Effect.prototype.dispose.call(this),this._subtract.dispose(),this._subtract=null,this._modulo.dispose(),this._modulo=null,this},Tone.BitCrusher}),define("Tone/effect/StereoEffect",["Tone/core/Tone","Tone/effect/Effect","Tone/component/Split","Tone/component/Merge","Tone/component/CrossFade"],function(Tone){"use strict";return Tone.StereoEffect=function(){Tone.call(this);var options=this.optionsObject(arguments,["wet"],Tone.Effect.defaults);this._dryWet=new Tone.CrossFade(options.wet),this.wet=this._dryWet.fade,this._split=new Tone.Split,this.effectSendL=this._split.left,this.effectSendR=this._split.right,this._merge=new Tone.Merge,this.effectReturnL=this._merge.left,this.effectReturnR=this._merge.right,this.input.connect(this._split),this.input.connect(this._dryWet,0,0),this._merge.connect(this._dryWet,0,1),this._dryWet.connect(this.output),this._readOnly(["wet"])},Tone.extend(Tone.StereoEffect,Tone.Effect),Tone.StereoEffect.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._dryWet.dispose(),this._dryWet=null,this._split.dispose(),this._split=null,this._merge.dispose(),this._merge=null,this.effectSendL=null,this.effectSendR=null,this.effectReturnL=null,this.effectReturnR=null,this._writable(["wet"]),this.wet=null,this},Tone.StereoEffect}),define("Tone/effect/FeedbackEffect",["Tone/core/Tone","Tone/effect/Effect","Tone/signal/Signal","Tone/signal/Multiply"],function(Tone){"use strict";return Tone.FeedbackEffect=function(){var options=this.optionsObject(arguments,["feedback"]);options=this.defaultArg(options,Tone.FeedbackEffect.defaults),Tone.Effect.call(this,options),this.feedback=new Tone.Signal(options.feedback,Tone.Type.NormalRange),this._feedbackGain=this.context.createGain(),this.effectReturn.chain(this._feedbackGain,this.effectSend),this.feedback.connect(this._feedbackGain.gain),this._readOnly(["feedback"])},Tone.extend(Tone.FeedbackEffect,Tone.Effect),Tone.FeedbackEffect.defaults={feedback:.125},Tone.FeedbackEffect.prototype.dispose=function(){return Tone.Effect.prototype.dispose.call(this),this._writable(["feedback"]),this.feedback.dispose(),this.feedback=null,this._feedbackGain.disconnect(),this._feedbackGain=null,this},Tone.FeedbackEffect}),define("Tone/effect/StereoXFeedbackEffect",["Tone/core/Tone","Tone/effect/StereoEffect","Tone/effect/FeedbackEffect"],function(Tone){"use strict";return Tone.StereoXFeedbackEffect=function(){var options=this.optionsObject(arguments,["feedback"],Tone.FeedbackEffect.defaults);Tone.StereoEffect.call(this,options),this.feedback=new Tone.Signal(options.feedback,Tone.Type.NormalRange),this._feedbackLR=this.context.createGain(),this._feedbackRL=this.context.createGain(),this.effectReturnL.chain(this._feedbackLR,this.effectSendR),this.effectReturnR.chain(this._feedbackRL,this.effectSendL),this.feedback.fan(this._feedbackLR.gain,this._feedbackRL.gain),this._readOnly(["feedback"])},Tone.extend(Tone.StereoXFeedbackEffect,Tone.FeedbackEffect),Tone.StereoXFeedbackEffect.prototype.dispose=function(){return Tone.StereoEffect.prototype.dispose.call(this),this._writable(["feedback"]),this.feedback.dispose(),this.feedback=null,this._feedbackLR.disconnect(),this._feedbackLR=null,this._feedbackRL.disconnect(),this._feedbackRL=null,this},Tone.StereoXFeedbackEffect}),define("Tone/effect/Chorus",["Tone/core/Tone","Tone/component/LFO","Tone/effect/StereoXFeedbackEffect"],function(Tone){"use strict";return Tone.Chorus=function(){var options=this.optionsObject(arguments,["frequency","delayTime","depth"],Tone.Chorus.defaults);Tone.StereoXFeedbackEffect.call(this,options),this._depth=options.depth,this._delayTime=options.delayTime/1e3,this._lfoL=new Tone.LFO({frequency:options.frequency,min:0,max:1}),this._lfoR=new Tone.LFO({frequency:options.frequency,min:0,max:1,phase:180}),this._delayNodeL=this.context.createDelay(),this._delayNodeR=this.context.createDelay(),this.frequency=this._lfoL.frequency,this.effectSendL.chain(this._delayNodeL,this.effectReturnL),this.effectSendR.chain(this._delayNodeR,this.effectReturnR),this.effectSendL.connect(this.effectReturnL),this.effectSendR.connect(this.effectReturnR),this._lfoL.connect(this._delayNodeL.delayTime),this._lfoR.connect(this._delayNodeR.delayTime),this._lfoL.start(),this._lfoR.start(),this._lfoL.frequency.connect(this._lfoR.frequency),this.depth=this._depth,this.frequency.value=options.frequency,this.type=options.type,this._readOnly(["frequency"]),this.spread=options.spread},Tone.extend(Tone.Chorus,Tone.StereoXFeedbackEffect),Tone.Chorus.defaults={frequency:1.5,delayTime:3.5,depth:.7,feedback:.1,type:"sine",spread:180},Object.defineProperty(Tone.Chorus.prototype,"depth",{get:function(){return this._depth},set:function(depth){this._depth=depth;var deviation=this._delayTime*depth;this._lfoL.min=Math.max(this._delayTime-deviation,0),this._lfoL.max=this._delayTime+deviation,this._lfoR.min=Math.max(this._delayTime-deviation,0),this._lfoR.max=this._delayTime+deviation}}),Object.defineProperty(Tone.Chorus.prototype,"delayTime",{get:function(){return this._delayTime*1e3},set:function(delayTime){this._delayTime=delayTime/1e3,this.depth=this._depth}}),Object.defineProperty(Tone.Chorus.prototype,"type",{get:function(){return this._lfoL.type},set:function(type){this._lfoL.type=type,this._lfoR.type=type}}),Object.defineProperty(Tone.Chorus.prototype,"spread",{get:function(){return this._lfoR.phase-this._lfoL.phase},set:function(spread){this._lfoL.phase=90-spread/2,this._lfoR.phase=spread/2+90}}),Tone.Chorus.prototype.dispose=function(){return Tone.StereoXFeedbackEffect.prototype.dispose.call(this),this._lfoL.dispose(),this._lfoL=null,this._lfoR.dispose(),this._lfoR=null,this._delayNodeL.disconnect(),this._delayNodeL=null,this._delayNodeR.disconnect(),this._delayNodeR=null,this._writable("frequency"),this.frequency=null,this},Tone.Chorus}),define("Tone/core/Buffer",["Tone/core/Tone","Tone/core/Emitter"],function(Tone){"use strict";return Tone.Buffer=function(){var options=this.optionsObject(arguments,["url","onload"],Tone.Buffer.defaults);this._buffer=null,this._reversed=options.reverse,this.url=undefined,this.loaded=!1,this.onload=options.onload.bind(this,this),options.url instanceof AudioBuffer||options.url instanceof Tone.Buffer?(this.set(options.url),this.onload(this)):this.isString(options.url)&&(this.url=options.url,Tone.Buffer._addToQueue(options.url,this))},Tone.extend(Tone.Buffer),Tone.Buffer.defaults={url:undefined,onload:Tone.noOp,reverse:!1},Tone.Buffer.prototype.set=function(buffer){return buffer instanceof Tone.Buffer?this._buffer=buffer.get():this._buffer=buffer,this.loaded=!0,this},Tone.Buffer.prototype.get=function(){return this._buffer},Tone.Buffer.prototype.load=function(url,callback){return this.url=url,this.onload=this.defaultArg(callback,this.onload),Tone.Buffer._addToQueue(url,this),this},Tone.Buffer.prototype.dispose=function(){return Tone.prototype.dispose.call(this),Tone.Buffer._removeFromQueue(this),this._buffer=null,this.onload=Tone.Buffer.defaults.onload,this},Object.defineProperty(Tone.Buffer.prototype,"duration",{get:function(){return this._buffer?this._buffer.duration:0}}),Tone.Buffer.prototype._reverse=function(rev){if(this.loaded&&this._buffer!==null&&rev!==this._reversed){for(var i=0;i<this._buffer.numberOfChannels;i++)Array.prototype.reverse.call(this._buffer.getChannelData(i));this._reversed=rev}return this},Object.defineProperty(Tone.Buffer.prototype,"reverse",{get:function(){return this._reversed},set:function(rev){this._reverse(rev)}}),Tone.Emitter.mixin(Tone.Buffer),Tone.Buffer._queue=[],Tone.Buffer._currentDownloads=[],Tone.Buffer._totalDownloads=0,Tone.Buffer.MAX_SIMULTANEOUS_DOWNLOADS=6,Tone.Buffer._addToQueue=function(url,buffer){Tone.Buffer._queue.push({url:url,Buffer:buffer,progress:0,xhr:null}),this._totalDownloads++,Tone.Buffer._next()},Tone.Buffer._removeFromQueue=function(buffer){var i;for(i=0;i<Tone.Buffer._queue.length;i++){var q=Tone.Buffer._queue[i];q.Buffer===buffer&&Tone.Buffer._queue.splice(i,1)}for(i=0;i<Tone.Buffer._currentDownloads.length;i++){var dl=Tone.Buffer._currentDownloads[i];dl.Buffer===buffer&&(Tone.Buffer._currentDownloads.splice(i,1),dl.xhr.abort(),dl.xhr.onprogress=null,dl.xhr.onload=null,dl.xhr.onerror=null)}},Tone.Buffer._next=function(){if(Tone.Buffer._queue.length>0){if(Tone.Buffer._currentDownloads.length<Tone.Buffer.MAX_SIMULTANEOUS_DOWNLOADS){var next=Tone.Buffer._queue.shift();Tone.Buffer._currentDownloads.push(next),next.xhr=Tone.Buffer.load(next.url,function(buffer){var index=Tone.Buffer._currentDownloads.indexOf(next);Tone.Buffer._currentDownloads.splice(index,1),next.Buffer.set(buffer),next.Buffer._reversed&&next.Buffer._reverse(),next.Buffer.onload(next.Buffer),Tone.Buffer._onprogress(),Tone.Buffer._next()}),next.xhr.onprogress=function(event){next.progress=event.loaded/event.total,Tone.Buffer._onprogress()},next.xhr.onerror=function(e){Tone.Buffer.trigger("error",e)}}}else Tone.Buffer._currentDownloads.length===0&&(Tone.Buffer.trigger("load"),Tone.Buffer._totalDownloads=0)},Tone.Buffer._onprogress=function(){var curretDownloadsProgress=0,currentDLLen=Tone.Buffer._currentDownloads.length,inprogress=0;if(currentDLLen>0){for(var i=0;i<currentDLLen;i++){var dl=Tone.Buffer._currentDownloads[i];curretDownloadsProgress+=dl.progress}inprogress=curretDownloadsProgress}var currentDownloadProgress=currentDLLen-inprogress,completed=Tone.Buffer._totalDownloads-Tone.Buffer._queue.length-currentDownloadProgress;Tone.Buffer.trigger("progress",completed/Tone.Buffer._totalDownloads)},Tone.Buffer.load=function(url,callback){var request=new XMLHttpRequest;return request.open("GET",url,!0),request.responseType="arraybuffer",request.onload=function(){Tone.context.decodeAudioData(request.response,function(buff){if(!buff)throw new Error("could not decode audio data:"+url);callback(buff)})},request.send(),request},Object.defineProperty(Tone.Buffer,"onload",{set:function(cb){console.warn("Tone.Buffer.onload is deprecated, use Tone.Buffer.on('load', callback)"),Tone.Buffer.on("load",cb)}}),Object.defineProperty(Tone.Buffer,"onprogress",{set:function(cb){console.warn("Tone.Buffer.onprogress is deprecated, use Tone.Buffer.on('progress', callback)"),Tone.Buffer.on("progress",cb)}}),Object.defineProperty(Tone.Buffer,"onerror",{set:function(cb){console.warn("Tone.Buffer.onerror is deprecated, use Tone.Buffer.on('error', callback)"),Tone.Buffer.on("error",cb)}}),Tone.Buffer}),define("Tone/effect/Convolver",["Tone/core/Tone","Tone/core/Buffer","Tone/effect/Effect"],function(Tone){"use strict";return Tone.Convolver=function(){var options=this.optionsObject(arguments,["url"],Tone.Convolver.defaults);Tone.Effect.call(this,options),this._convolver=this.context.createConvolver(),this._buffer=new Tone.Buffer(options.url,function(buffer){this.buffer=buffer,options.onload()}.bind(this)),this.connectEffect(this._convolver)},Tone.extend(Tone.Convolver,Tone.Effect),Tone.Convolver.defaults={url:"",onload:Tone.noOp},Object.defineProperty(Tone.Convolver.prototype,"buffer",{get:function(){return this._buffer.get()},set:function(buffer){this._buffer.set(buffer),this._convolver.buffer=this._buffer.get()}}),Tone.Convolver.prototype.load=function(url,callback){return this._buffer.load(url,function(buff){this.buffer=buff,callback&&callback()}.bind(this)),this},Tone.Convolver.prototype.dispose=function(){return Tone.Effect.prototype.dispose.call(this),this._convolver.disconnect(),this._convolver=null,this._buffer.dispose(),this._buffer=null,this},Tone.Convolver}),define("Tone/effect/Distortion",["Tone/core/Tone","Tone/effect/Effect","Tone/signal/WaveShaper"],function(Tone){"use strict";return Tone.Distortion=function(){var options=this.optionsObject(arguments,["distortion"],Tone.Distortion.defaults);Tone.Effect.call(this,options),this._shaper=new Tone.WaveShaper(4096),this._distortion=options.distortion,this.connectEffect(this._shaper),this.distortion=options.distortion,this.oversample=options.oversample},Tone.extend(Tone.Distortion,Tone.Effect),Tone.Distortion.defaults={distortion:.4,oversample:"none"},Object.defineProperty(Tone.Distortion.prototype,"distortion",{get:function(){return this._distortion},set:function(amount){this._distortion=amount;var k=amount*100,deg=Math.PI/180;this._shaper.setMap(function(x){return Math.abs(x)<.001?0:(3+k)*x*20*deg/(Math.PI+k*Math.abs(x))})}}),Object.defineProperty(Tone.Distortion.prototype,"oversample",{get:function(){return this._shaper.oversample},set:function(oversampling){this._shaper.oversample=oversampling}}),Tone.Distortion.prototype.dispose=function(){return Tone.Effect.prototype.dispose.call(this),this._shaper.dispose(),this._shaper=null,this},Tone.Distortion}),define("Tone/component/LowpassCombFilter",["Tone/core/Tone","Tone/signal/Signal","Tone/component/Filter","Tone/core/Param"],function(Tone){"use strict";return Tone.LowpassCombFilter=function(){Tone.call(this);var options=this.optionsObject(arguments,["delayTime","resonance","dampening"],Tone.LowpassCombFilter.defaults);this._delay=this.input=this.context.createDelay(1),this.delayTime=new Tone.Signal(options.delayTime,Tone.Type.Time),this._lowpass=this.output=this.context.createBiquadFilter(),this._lowpass.Q.value=0,this._lowpass.type="lowpass",this.dampening=new Tone.Param({param:this._lowpass.frequency,units:Tone.Type.Frequency,value:options.dampening}),this._feedback=this.context.createGain(),this.resonance=new Tone.Param({param:this._feedback.gain,units:Tone.Type.NormalRange,value:options.resonance}),this._delay.chain(this._lowpass,this._feedback,this._delay),this.delayTime.connect(this._delay.delayTime),this._readOnly(["dampening","resonance","delayTime"])},Tone.extend(Tone.LowpassCombFilter),Tone.LowpassCombFilter.defaults={delayTime:.1,resonance:.5,dampening:3e3},Tone.LowpassCombFilter.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._writable(["dampening","resonance","delayTime"]),this.dampening.dispose(),this.dampening=null,this.resonance.dispose(),this.resonance=null,this._delay.disconnect(),this._delay=null,this._lowpass.disconnect(),this._lowpass=null,this._feedback.disconnect(),this._feedback=null,this.delayTime.dispose(),this.delayTime=null,this},Tone.LowpassCombFilter}),define("Tone/effect/Freeverb",["Tone/core/Tone","Tone/component/LowpassCombFilter","Tone/effect/StereoEffect","Tone/signal/Signal","Tone/component/Split","Tone/component/Merge","Tone/signal/ScaleExp"],function(Tone){"use strict";var combFilterTunings=[1557/44100,1617/44100,1491/44100,1422/44100,1277/44100,1356/44100,1188/44100,1116/44100],allpassFilterFrequencies=[225,556,441,341];return Tone.Freeverb=function(){var options=this.optionsObject(arguments,["roomSize","dampening"],Tone.Freeverb.defaults);Tone.StereoEffect.call(this,options),this.roomSize=new Tone.Signal(options.roomSize,Tone.Type.NormalRange),this.dampening=new Tone.Signal(options.dampening,Tone.Type.Frequency),this._dampeningScale=new Tone.ScaleExp(100,8e3,.5),this._combFilters=[],this._allpassFiltersL=[],this._allpassFiltersR=[];for(var l=0;l<allpassFilterFrequencies.length;l++){var allpassL=this.context.createBiquadFilter();allpassL.type="allpass",allpassL.frequency.value=allpassFilterFrequencies[l],this._allpassFiltersL.push(allpassL)}for(var r=0;r<allpassFilterFrequencies.length;r++){var allpassR=this.context.createBiquadFilter();allpassR.type="allpass",allpassR.frequency.value=allpassFilterFrequencies[r],this._allpassFiltersR.push(allpassR)}for(var c=0;c<combFilterTunings.length;c++){var lfpf=new Tone.LowpassCombFilter(combFilterTunings[c]);c<combFilterTunings.length/2?this.effectSendL.chain(lfpf,this._allpassFiltersL[0]):this.effectSendR.chain(lfpf,this._allpassFiltersR[0]),this.roomSize.connect(lfpf.resonance),this._dampeningScale.connect(lfpf.dampening),this._combFilters.push(lfpf)}this.connectSeries.apply(this,this._allpassFiltersL),this.connectSeries.apply(this,this._allpassFiltersR),this._allpassFiltersL[this._allpassFiltersL.length-1].connect(this.effectReturnL),this._allpassFiltersR[this._allpassFiltersR.length-1].connect(this.effectReturnR),this.dampening.connect(this._dampeningScale),this._readOnly(["roomSize","dampening"])},Tone.extend(Tone.Freeverb,Tone.StereoEffect),Tone.Freeverb.defaults={roomSize:.7,dampening:.5},Tone.Freeverb.prototype.dispose=function(){Tone.StereoEffect.prototype.dispose.call(this);for(var al=0;al<this._allpassFiltersL.length;al++)this._allpassFiltersL[al].disconnect(),this._allpassFiltersL[al]=null;this._allpassFiltersL=null;for(var ar=0;ar<this._allpassFiltersR.length;ar++)this._allpassFiltersR[ar].disconnect(),this._allpassFiltersR[ar]=null;this._allpassFiltersR=null;for(var cf=0;cf<this._combFilters.length;cf++)this._combFilters[cf].dispose(),this._combFilters[cf]=null;return this._combFilters=null,this._writable(["roomSize","dampening"]),this.roomSize.dispose(),this.roomSize=null,this.dampening.dispose(),this.dampening=null,this},Tone.Freeverb}),define("Tone/effect/Phaser",["Tone/core/Tone","Tone/component/LFO","Tone/component/Filter","Tone/effect/StereoEffect"],function(Tone){"use strict";return Tone.Phaser=function(){var options=this.optionsObject(arguments,["frequency","octaves","baseFrequency"],Tone.Phaser.defaults);Tone.StereoEffect.call(this,options),this._lfoL=new Tone.LFO(options.frequency,0,1),this._lfoR=new Tone.LFO(options.frequency,0,1),this._lfoR.phase=180,this._baseFrequency=options.baseFrequency,this._octaves=options.octaves,this.Q=new Tone.Signal(options.Q,Tone.Type.Positive),this._filtersL=this._makeFilters(options.stages,this._lfoL,this.Q),this._filtersR=this._makeFilters(options.stages,this._lfoR,this.Q),this.frequency=this._lfoL.frequency,this.frequency.value=options.frequency,this.effectSendL.connect(this._filtersL[0]),this.effectSendR.connect(this._filtersR[0]),this._filtersL[options.stages-1].connect(this.effectReturnL),this._filtersR[options.stages-1].connect(this.effectReturnR),this._lfoL.frequency.connect(this._lfoR.frequency),this.baseFrequency=options.baseFrequency,this.octaves=options.octaves,this._lfoL.start(),this._lfoR.start(),this._readOnly(["frequency","Q"])},Tone.extend(Tone.Phaser,Tone.StereoEffect),Tone.Phaser.defaults={frequency:.5,octaves:3,stages:10,Q:10,baseFrequency:350},Tone.Phaser.prototype._makeFilters=function(stages,connectToFreq,Q){var filters=new Array(stages);for(var i=0;i<stages;i++){var filter=this.context.createBiquadFilter();filter.type="allpass",Q.connect(filter.Q),connectToFreq.connect(filter.frequency),filters[i]=filter}return this.connectSeries.apply(this,filters),filters},Object.defineProperty(Tone.Phaser.prototype,"octaves",{get:function(){return this._octaves},set:function(octaves){this._octaves=octaves;var max=this._baseFrequency*Math.pow(2,octaves);this._lfoL.max=max,this._lfoR.max=max}}),Object.defineProperty(Tone.Phaser.prototype,"baseFrequency",{get:function(){return this._baseFrequency},set:function(freq){this._baseFrequency=freq,this._lfoL.min=freq,this._lfoR.min=freq,this.octaves=this._octaves}}),Tone.Phaser.prototype.dispose=function(){Tone.StereoEffect.prototype.dispose.call(this),this._writable(["frequency","Q"]),this.Q.dispose(),this.Q=null,this._lfoL.dispose(),this._lfoL=null,this._lfoR.dispose(),this._lfoR=null;for(var i=0;i<this._filtersL.length;i++)this._filtersL[i].disconnect(),this._filtersL[i]=null;this._filtersL=null;for(var j=0;j<this._filtersR.length;j++)this._filtersR[j].disconnect(),this._filtersR[j]=null;return this._filtersR=null,this.frequency=null,this},Tone.Phaser}),define("Tone/effect/PingPongDelay",["Tone/core/Tone","Tone/effect/StereoXFeedbackEffect","Tone/signal/Signal"],function(Tone){"use strict";return Tone.PingPongDelay=function(){var options=this.optionsObject(arguments,["delayTime","feedback"],Tone.PingPongDelay.defaults);Tone.StereoXFeedbackEffect.call(this,options),this._leftDelay=this.context.createDelay(options.maxDelayTime),this._rightDelay=this.context.createDelay(options.maxDelayTime),this._rightPreDelay=this.context.createDelay(options.maxDelayTime),this.delayTime=new Tone.Signal(options.delayTime,Tone.Type.Time),this.effectSendL.chain(this._leftDelay,this.effectReturnL),this.effectSendR.chain(this._rightPreDelay,this._rightDelay,this.effectReturnR),this.delayTime.fan(this._leftDelay.delayTime,this._rightDelay.delayTime,this._rightPreDelay.delayTime),this._feedbackLR.disconnect(),this._feedbackLR.connect(this._rightDelay),this._readOnly(["delayTime"])},Tone.extend(Tone.PingPongDelay,Tone.StereoXFeedbackEffect),Tone.PingPongDelay.defaults={delayTime:.25,maxDelayTime:1},Tone.PingPongDelay.prototype.dispose=function(){return Tone.StereoXFeedbackEffect.prototype.dispose.call(this),this._leftDelay.disconnect(),this._leftDelay=null,this._rightDelay.disconnect(),this._rightDelay=null,this._rightPreDelay.disconnect(),this._rightPreDelay=null,this._writable(["delayTime"]),this.delayTime.dispose(),this.delayTime=null,this},Tone.PingPongDelay}),define("Tone/effect/Tremolo",["Tone/core/Tone","Tone/component/LFO","Tone/effect/StereoEffect"],function(Tone){"use strict";return Tone.Tremolo=function(){var options=this.optionsObject(arguments,["frequency","depth"],Tone.Tremolo.defaults);Tone.StereoEffect.call(this,options),this._lfoL=new Tone.LFO({phase:options.spread,min:1,max:0}),this._lfoR=new Tone.LFO({phase:options.spread,min:1,max:0}),this._amplitudeL=new Tone.Gain,this._amplitudeR=new Tone.Gain,this.frequency=new Tone.Signal(options.frequency,Tone.Type.Frequency),this.depth=new Tone.Signal(options.depth,Tone.Type.NormalRange),this._readOnly(["frequency","depth"]),this.effectSendL.chain(this._amplitudeL,this.effectReturnL),this.effectSendR.chain(this._amplitudeR,this.effectReturnR),this._lfoL.connect(this._amplitudeL.gain),this._lfoR.connect(this._amplitudeR.gain),this.frequency.fan(this._lfoL.frequency,this._lfoR.frequency),this.depth.fan(this._lfoR.amplitude,this._lfoL.amplitude),this.type=options.type,this.spread=options.spread},Tone.extend(Tone.Tremolo,Tone.StereoEffect),Tone.Tremolo.defaults={frequency:10,type:"sine",depth:.5,spread:180},Tone.Tremolo.prototype.start=function(time){return this._lfoL.start(time),this._lfoR.start(time),this},Tone.Tremolo.prototype.stop=function(time){return this._lfoL.stop(time),this._lfoR.stop(time),this},Tone.Tremolo.prototype.sync=function(delay){return this._lfoL.sync(delay),this._lfoR.sync(delay),this},Tone.Tremolo.prototype.unsync=function(){return this._lfoL.unsync(),this._lfoR.unsync(),this},Object.defineProperty(Tone.Tremolo.prototype,"type",{get:function(){return this._lfoL.type},set:function(type){this._lfoL.type=type,this._lfoR.type=type}}),Object.defineProperty(Tone.Tremolo.prototype,"spread",{get:function(){return this._lfoR.phase-this._lfoL.phase},set:function(spread){this._lfoL.phase=90-spread/2,this._lfoR.phase=spread/2+90}}),Tone.Tremolo.prototype.dispose=function(){return Tone.StereoEffect.prototype.dispose.call(this),this._writable(["frequency","depth"]),this._lfoL.dispose(),this._lfoL=null,this._lfoR.dispose(),this._lfoR=null,this._amplitudeL.dispose(),this._amplitudeL=null,this._amplitudeR.dispose(),this._amplitudeR=null,this.frequency=null,this.depth=null,this},Tone.Tremolo}),define("Tone/core/Delay",["Tone/core/Tone","Tone/core/Param"],function(Tone){"use strict";return Tone.Delay=function(){var options=this.optionsObject(arguments,["delayTime","maxDelay"],Tone.Delay.defaults);this._delayNode=this.input=this.output=this.context.createDelay(this.toSeconds(options.maxDelay)),this.delayTime=new Tone.Param({param:this._delayNode.delayTime,units:Tone.Type.Time,value:options.delayTime}),this._readOnly("delayTime")},Tone.extend(Tone.Delay),Tone.Delay.defaults={maxDelay:1,delayTime:0},Tone.Delay.prototype.dispose=function(){return Tone.Param.prototype.dispose.call(this),this._delayNode.disconnect(),this._delayNode=null,this._writable("delayTime"),this.delayTime=null,this},Tone.Delay}),define("Tone/effect/PitchShift",["Tone/core/Tone","Tone/component/LFO","Tone/component/CrossFade","Tone/signal/Signal","Tone/effect/FeedbackEffect","Tone/core/Delay"],function(Tone){"use strict";return Tone.PitchShift=function(){var options=this.optionsObject(arguments,["pitch"],Tone.PitchShift.defaults);Tone.FeedbackEffect.call(this,options),this._frequency=new Tone.Signal(0),this._delayA=new Tone.Delay(0,1),this._lfoA=(new Tone.LFO({min:0,max:.1,type:"sawtooth"})).connect(this._delayA.delayTime),this._delayB=new Tone.Delay(0,1),this._lfoB=(new Tone.LFO({min:0,max:.1,type:"sawtooth",phase:180})).connect(this._delayB.delayTime),this._crossFade=new Tone.CrossFade,this._crossFadeLFO=(new Tone.LFO({min:0,max:1,type:"triangle",phase:90})).connect(this._crossFade.fade),this._feedbackDelay=new Tone.Delay(options.delayTime),this.delayTime=this._feedbackDelay.delayTime,this._readOnly("delayTime"),this._pitch=options.pitch,this._windowSize=options.windowSize,this._delayA.connect(this._crossFade.a),this._delayB.connect(this._crossFade.b),this._frequency.fan(this._lfoA.frequency,this._lfoB.frequency,this._crossFadeLFO.frequency),this.effectSend.fan(this._delayA,this._delayB),this._crossFade.chain(this._feedbackDelay,this.effectReturn);var now=this.now();this._lfoA.start(now),this._lfoB.start(now),this._crossFadeLFO.start(now),this.windowSize=this._windowSize},Tone.extend(Tone.PitchShift,Tone.FeedbackEffect),Tone.PitchShift.defaults={pitch:0,windowSize:.1,delayTime:0,feedback:0},Object.defineProperty(Tone.PitchShift.prototype,"pitch",{get:function(){return this._pitch},set:function(interval){this._pitch=interval;var factor=0;interval<0?(this._lfoA.min=0,this._lfoA.max=this._windowSize,this._lfoB.min=0,this._lfoB.max=this._windowSize,factor=this.intervalToFrequencyRatio(interval-1)+1):(this._lfoA.min=this._windowSize,this._lfoA.max=0,this._lfoB.min=this._windowSize,this._lfoB.max=0,factor=this.intervalToFrequencyRatio(interval)-1),this._frequency.value=factor*(1.2/this._windowSize)}}),Object.defineProperty(Tone.PitchShift.prototype,"windowSize",{get:function(){return this._windowSize},set:function(size){this._windowSize=this.toSeconds(size),this.pitch=this._pitch}}),Tone.PitchShift.prototype.dispose=function(){return Tone.FeedbackEffect.prototype.dispose.call(this),this._frequency.dispose(),this._frequency=null,this._delayA.disconnect(),this._delayA=null,this._delayB.disconnect(),this._delayB=null,this._lfoA.dispose(),this._lfoA=null,this._lfoB.dispose(),this._lfoB=null,this._crossFade.dispose(),this._crossFade=null,this._crossFadeLFO.dispose(),this._crossFadeLFO=null,this._writable("delayTime"),this._feedbackDelay.dispose(),this._feedbackDelay=null,this.delayTime=null,this},Tone.PitchShift}),define("Tone/source/SimplePlayer",["Tone/core/Tone","Tone/core/Buffer","Tone/source/SimpleSource"],function(Tone){"use strict";return Tone.SimplePlayer=function(url){var options;url instanceof Tone.Buffer?(url=url.get(),options=Tone.SimplePlayer.defaults):options=this.optionsObject(arguments,["url","onload"],Tone.SimplePlayer.defaults),Tone.SimpleSource.call(this,options),this._source=null,this._lastSource=null,this._sourceGain=null,this._lastSourceGain=null,this.autostart=options.autostart,this._buffer=new Tone.Buffer({url:options.url,onload:this._onload.bind(this,options.onload),reverse:options.reverse}),url instanceof AudioBuffer&&this._buffer.set(url),this._loop=options.loop,this._loopStart=options.loopStart,this._loopEnd=options.loopEnd,Tone.isSafari?this._playbackRate=options.playbackRate:(this.playbackRate=new Tone.Signal(options.playbackRate,Tone.Type.Positive),this._readOnly("playbackRate"));var s=this.context.createBufferSource();s.detune&&(this.detune=new Tone.Signal(options.detune,Tone.Type.Cents),this._readOnly("detune")),this.retrigger=options.retrigger},Tone.extend(Tone.SimplePlayer,Tone.SimpleSource),Tone.SimplePlayer.defaults={onload:Tone.noOp,playbackRate:1,loop:!1,autostart:!1,loopStart:0,loopEnd:0,retrigger:!1,reverse:!1,detune:0},Tone.SimplePlayer.prototype.load=function(url,callback){return this._buffer.load(url,this._onload.bind(this,callback)),this},Tone.SimplePlayer.prototype._onload=function(callback){callback(this),this.autostart&&this.start()},Tone.SimplePlayer.prototype._start=function(offset,duration){if(this._buffer.loaded&&this._buffer._buffer){var now=this.context.currentTime;this._loop?offset=this.defaultArg(offset,this._loopStart):offset=this.defaultArg(offset,0),duration=this.defaultArg(duration,this._buffer.duration-offset),this._lastSource&&(this._lastSourceGain.gain.setValueAtTime(1,this.context.currentTime),this._lastSourceGain.gain.linearRampToValueAtTime(0,this.context.currentTime+.001),this._lastSource.stop(this.context.currentTime+.001)),this._source=this.context.createBufferSource(),this._lastSource=this._source,this._sourceGain=this.context.createGain(),this._lastSourceGain=this._sourceGain,this._source.buffer=this._buffer.get(),this._loop&&(this._source.loop=this._loop,this._source.loopStart=this._loopStart,this._source.loopEnd=this._loopEnd,duration=65536),Tone.isSafari?this._source.playbackRate.value=this._playbackRate:this.playbackRate.connect(this._source.playbackRate),this._source.detune&&this.detune.connect(this._source.detune),this._sourceGain.connect(this.output),this._source.connect(this._sourceGain),this._loop?this._source.start(now,offset):this._source.start(now,offset,duration)}else console.log("tried to start Player before the buffer was loaded")},Tone.SimplePlayer.prototype._stop=function(time){this._source&&(this._source.stop(time),this._source=null)},Tone.SimplePlayer.prototype.setLoopPoints=function(loopStart,loopEnd){return this.loopStart=loopStart,this.loopEnd=loopEnd,this},Object.defineProperty(Tone.SimplePlayer.prototype,"loopStart",{get:function(){return this._loopStart},set:function(loopStart){this._loopStart=loopStart,this._source&&(this._source.loopStart=this.toSeconds(loopStart))}}),Object.defineProperty(Tone.SimplePlayer.prototype,"loopEnd",{get:function(){return this._loopEnd},set:function(loopEnd){this._loopEnd=loopEnd,this._source&&(this._source.loopEnd=this.toSeconds(loopEnd))}}),Object.defineProperty(Tone.SimplePlayer.prototype,"buffer",{get:function(){return this._buffer},set:function(buffer){this._buffer.set(buffer)}}),Object.defineProperty(Tone.SimplePlayer.prototype,"loop",{get:function(){return this._loop},set:function(loop){this._loop=loop,this._source&&(this._source.loop=loop)}}),Tone.isSafari&&Object.defineProperty(Tone.SimplePlayer.prototype,"playbackRate",{get:function(){return this._playbackRate},set:function(rate){this._playbackRate=rate,this._source&&(this._source.playbackRate.value=rate)}}),Object.defineProperty(Tone.SimplePlayer.prototype,"reverse",{get:function(){return this._buffer.reverse},set:function(rev){this._buffer.reverse=rev}}),Tone.SimplePlayer.prototype.dispose=function(){return Tone.SimpleSource.prototype.dispose.call(this),this._source!==null&&(this._source.disconnect(),this._source=null),this._buffer.dispose(),this._buffer=null,Tone.isSafari||(this._writable("playbackRate"),this.playbackRate.dispose(),this.playbackRate=null),this.detune&&(this._writable("detune"),this.detune.dispose(),this.detune=null),this},Tone.SimplePlayer}),define("Tone/instrument/Instrument",["Tone/core/Tone","Tone/core/Type"],function(Tone){"use strict";return Tone.Instrument=function(options){options=this.defaultArg(options,Tone.Instrument.defaults),this._volume=this.output=new Tone.Volume(options.volume),this.volume=this._volume.volume,this._readOnly("volume")},Tone.extend(Tone.Instrument),Tone.Instrument.defaults={volume:0},Tone.Instrument.prototype.triggerAttack=Tone.noOp,Tone.Instrument.prototype.triggerRelease=Tone.noOp,Tone.Instrument.prototype.triggerAttackRelease=function(note,duration,time,velocity){return time=this.toSeconds(time),duration=this.toSeconds(duration),this.triggerAttack(note,time,velocity),this.triggerRelease(time+duration),this},Tone.Instrument.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._volume.dispose(),this._volume=null,this._writable(["volume"]),this.volume=null,this},Tone.Instrument}),define("Tone/instrument/Simpler",["Tone/core/Tone","Tone/source/SimplePlayer","Tone/component/AmplitudeEnvelope","Tone/instrument/Instrument"],function(Tone){"use strict";return Tone.Simpler=function(urls,options){options=this.defaultArg(options,Tone.Simpler.defaults),Tone.Instrument.call(this,options),this.player=new Tone.SimplePlayer(options.player),this._buffers={},this.envelope=new Tone.AmplitudeEnvelope(options.envelope),this._sample=options.sample,this._loadBuffers(urls),this.player.chain(this.envelope,this.output),this._readOnly(["player","envelope"])},Tone.extend(Tone.Simpler,Tone.Instrument),Tone.Simpler.defaults={sample:0,pitch:0,player:{loop:!1},envelope:{attack:.001,decay:0,sustain:1,release:.1}},Tone.Simpler.prototype._loadBuffers=function(urls){if(typeof urls=="string")this._buffers[0]=new Tone.Buffer(urls,function(){this.sample="0"}.bind(this));else{urls=this._flattenUrls(urls);for(var buffName in urls){this._sample=buffName;var urlString=urls[buffName];this._buffers[buffName]=new Tone.Buffer(urlString)}}},Tone.Simpler.prototype._flattenUrls=function(ob){var toReturn={};for(var i in ob){if(!ob.hasOwnProperty(i))continue;if(typeof ob[i]=="object"){var flatObject=this._flattenUrls(ob[i]);for(var x in flatObject){if(!flatObject.hasOwnProperty(x))continue;toReturn[i+"."+x]=flatObject[x]}}else toReturn[i]=ob[i]}return toReturn},Tone.Simpler.prototype.triggerAttack=function(offset,duration){return this.player.start(offset,duration),this.envelope.triggerAttack(),this},Tone.Simpler.prototype.triggerRelease=function(){var now=this.context.currentTime;return this.envelope.triggerRelease(),this.player.stop(this.envelope.release+now),this},Tone.Simpler.prototype.triggerAttackRelease=function(length,offset,duration){this.triggerAttack(offset,duration);var that=this;return setTimeout(function(){that.triggerRelease()},length),this},Object.defineProperty(Tone.Simpler.prototype,"sample",{get:function(){return this._sample},set:function(name){if(!this._buffers.hasOwnProperty(name))throw new Error("Simpler does not have a sample named "+name);this._sample=name,this.player.buffer=this._buffers[name]}}),Object.defineProperty(Tone.Simpler.prototype,"reverse",{get:function(){for(var i in this._buffers)return this._buffers[i].reverse},set:function(rev){for(var i in this._buffers)this._buffers[i].reverse=rev}}),Tone.Simpler.prototype.dispose=function(){Tone.Instrument.prototype.dispose.call(this),this._writable(["player","envelope"]),this.player.dispose(),this.envelope.dispose(),this.player=null,this.envelope=null;for(var sample in this._buffers)this._buffers[sample].dispose(),this._buffers[sample]=null;return this._buffers=null,this},Tone.Simpler}),define("Tone/source/ExternalInput",["Tone/core/Tone","Tone/source/SimpleSource","Tone/core/Gain"],function(Tone){"use strict";return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,Tone.ExternalInput=function(){var options=this.optionsObject(arguments,["inputNum"],Tone.ExternalInput.defaults);Tone.SimpleSource.call(this,options),this._mediaStream=null,this._stream=null,this._constraints={audio:!0},this._inputNum=options.inputNum,this._gate=(new Tone.Gain(0)).connect(this.output)},Tone.extend(Tone.ExternalInput,Tone.SimpleSource),Tone.ExternalInput.defaults={inputNum:0},Tone.ExternalInput.prototype._getUserMedia=function(callback){if(!Tone.ExternalInput.supported){console.error("browser does not support 'getUserMedia'");return}Tone.ExternalInput.sources[this._inputNum]&&(this._constraints={audio:{optional:[{sourceId:Tone.ExternalInput.sources[this._inputNum].id}]}}),navigator.getUserMedia(this._constraints,function(stream){this._onStream(stream),callback()}.bind(this),function(err){callback(err)})},Tone.ExternalInput.prototype._onStream=function(stream){if(!this.isFunction(this.context.createMediaStreamSource))throw new Error("browser does not support the 'MediaStreamSourceNode'");this._stream||(this._stream=stream,this._mediaStream=this.context.createMediaStreamSource(stream),this._mediaStream.connect(this._gate))},Tone.ExternalInput.prototype.open=function(callback){return callback=this.defaultArg(callback,Tone.noOp),Tone.ExternalInput.getSources(function(){this._getUserMedia(callback)}.bind(this)),this},Tone.ExternalInput.prototype.close=function(){if(this._stream){var track=this._stream.getTracks()[this._inputNum];this.isUndef(track)||track.stop(),this._stream=null}return this},Tone.ExternalInput.prototype._start=function(time){return time=this.toSeconds(time),this._gate.gain.setValueAtTime(1,time),this},Tone.ExternalInput.prototype._stop=function(time){return time=this.toSeconds(time),this._gate.gain.setValueAtTime(0,time),this},Tone.ExternalInput.prototype.dispose=function(){return Tone.SimpleSource.prototype.dispose.call(this),this.close(),this._mediaStream&&(this._mediaStream.disconnect(),this._mediaStream=null),this._constraints=null,this._gate.dispose(),this._gate=null,this},Tone.ExternalInput.sources=[],Tone.ExternalInput._canGetSources=!Tone.prototype.isUndef(window.MediaStreamTrack)&&Tone.prototype.isFunction(MediaStreamTrack.getSources),Object.defineProperty(Tone.ExternalInput,"supported",{get:function(){return Tone.prototype.isFunction(navigator.getUserMedia)}}),Tone.ExternalInput.getSources=function(callback){return Tone.ExternalInput.sources.length===0&&Tone.ExternalInput._canGetSources?MediaStreamTrack.getSources(function(media_sources){for(var i=0;i<media_sources.length;i++)media_sources[i].kind==="audio"&&(Tone.ExternalInput.sources[i]=media_sources[i]);callback(Tone.ExternalInput.sources)}):callback(Tone.ExternalInput.sources),this},Tone.ExternalInput}),define("Tone/source/Microphone",["Tone/core/Tone","Tone/source/ExternalInput"],function(Tone){"use strict";return Tone.Microphone=function(){Tone.ExternalInput.call(this,0)},Tone.extend(Tone.Microphone,Tone.ExternalInput),Object.defineProperty(Tone.Microphone,"supported",{get:function(){return Tone.ExternalInput.supported}}),Tone.Microphone}),define("Tone/source/Noise",["Tone/core/Tone","Tone/source/SimpleSource"],function(Tone){"use strict";Tone.Noise=function(){var options=this.optionsObject(arguments,["type"],Tone.Noise.defaults);Tone.SimpleSource.call(this,options),this._source=null,this._buffer=null,this._state==="stopped",Tone.isSafari?this._playbackRate=options.playbackRate:(this.playbackRate=new Tone.Signal(options.playbackRate,Tone.Type.Positive),this._readOnly("playbackRate")),this.type=options.type},Tone.extend(Tone.Noise,Tone.SimpleSource),Tone.Noise.defaults={type:"white",playbackRate:1},Object.defineProperty(Tone.Noise.prototype,"type",{get:function(){if(this._buffer===_whiteNoise)return"white";if(this._buffer===_brownNoise)return"brown";if(this._buffer===_pinkNoise)return"pink"},set:function(type){if(this.type!==type){switch(type){case"white":this._buffer=_whiteNoise;break;case"pink":this._buffer=_pinkNoise;break;case"brown":this._buffer=_brownNoise;break;default:throw new Error("invalid noise type: "+type)}if(this._state==="started"){var now=this.now()+this.blockTime;this._stop(now),this._start(now)}}}}),Tone.isSafari&&Object.defineProperty(Tone.Noise.prototype,"playbackRate",{get:function(){return this._playbackRate},set:function(rate){this._playbackRate=rate,this._source&&(this._source.playbackRate.value=rate)}}),Tone.Noise.prototype._start=function(time){this._source=this.context.createBufferSource(),this._source.buffer=this._buffer,this._source.loop=!0,Tone.isSafari?this._source.playbackRate.value=this._playbackRate:this.playbackRate.connect(this._source.playbackRate),this._source.connect(this.output),this._source.start(this.toSeconds(time)),this._state="started"},Tone.Noise.prototype._stop=function(time){this._source&&this._source.stop(this.toSeconds(time)),this._state==="stopped"},Tone.Noise.prototype.dispose=function(){return Tone.SimpleSource.prototype.dispose.call(this),this._source!==null&&(this._source.disconnect(),this._source=null),this._buffer=null,Tone.isSafari||(this._writable("playbackRate"),this.playbackRate.dispose(),this.playbackRate=null),this};var _pinkNoise=null,_brownNoise=null,_whiteNoise=null;return Tone._initAudioContext(function(audioContext){var sampleRate=audioContext.sampleRate,bufferLength=sampleRate*4;_pinkNoise=function(){var buffer=audioContext.createBuffer(2,bufferLength,sampleRate);for(var channelNum=0;channelNum<buffer.numberOfChannels;channelNum++){var channel=buffer.getChannelData(channelNum),b0,b1,b2,b3,b4,b5,b6;b0=b1=b2=b3=b4=b5=b6=0;for(var i=0;i<bufferLength;i++){var white=Math.random()*2-1;b0=.99886*b0+white*.0555179,b1=.99332*b1+white*.0750759,b2=.969*b2+white*.153852,b3=.8665*b3+white*.3104856,b4=.55*b4+white*.5329522,b5=-0.7616*b5-white*.016898,channel[i]=b0+b1+b2+b3+b4+b5+b6+white*.5362,channel[i]*=.11,b6=white*.115926}}return buffer}(),_brownNoise=function(){var buffer=audioContext.createBuffer(2,bufferLength,sampleRate);for(var channelNum=0;channelNum<buffer.numberOfChannels;channelNum++){var channel=buffer.getChannelData(channelNum),lastOut=0;for(var i=0;i<bufferLength;i++){var white=Math.random()*2-1;channel[i]=(lastOut+.02*white)/1.02,lastOut=channel[i],channel[i]*=3.5}}return buffer}(),_whiteNoise=function(){var buffer=audioContext.createBuffer(2,bufferLength,sampleRate);for(var channelNum=0;channelNum<buffer.numberOfChannels;channelNum++){var channel=buffer.getChannelData(channelNum);for(var i=0;i<bufferLength;i++)channel[i]=Math.random()*2-1}return buffer}()}),Tone.Noise}),define("Tone/component/Meter",["Tone/core/Tone"],function(Tone){"use strict";return Tone.Meter=function(){var options=this.optionsObject(arguments,["channels","smoothing"],Tone.Meter.defaults);Tone.call(this),this._channels=options.channels,this.smoothing=options.smoothing,this.clipMemory=options.clipMemory,this.clipLevel=options.clipLevel,this._volume=new Array(this._channels),this._values=new Array(this._channels);for(var i=0;i<this._channels;i++)this._volume[i]=0,this._values[i]=0;this._lastClip=new Array(this._channels);for(var j=0;j<this._lastClip.length;j++)this._lastClip[j]=0;this._jsNode=this.context.createScriptProcessor(options.bufferSize,this._channels,1),this._jsNode.onaudioprocess=this._onprocess.bind(this),this._jsNode.noGC(),this.input.connect(this.output),this.input.connect(this._jsNode)},Tone.extend(Tone.Meter),Tone.Meter.defaults={smoothing:.8,bufferSize:1024,clipMemory:.5,clipLevel:.9,channels:1},Tone.Meter.prototype._onprocess=function(event){var bufferSize=this._jsNode.bufferSize,smoothing=this.smoothing;for(var channel=0;channel<this._channels;channel++){var input=event.inputBuffer.getChannelData(channel),sum=0,total=0,x;for(var i=0;i<bufferSize;i++)x=input[i],total+=x,sum+=x*x;var average=total/bufferSize,rms=Math.sqrt(sum/bufferSize);rms>.9&&(this._lastClip[channel]=Date.now()),this._volume[channel]=Math.max(rms,this._volume[channel]*smoothing),this._values[channel]=average}},Tone.Meter.prototype.getLevel=function(channel){channel=this.defaultArg(channel,0);var vol=this._volume[channel];return vol<1e-5?0:vol},Tone.Meter.prototype.getValue=function(channel){return channel=this.defaultArg(channel,0),this._values[channel]},Tone.Meter.prototype.getDb=function(channel){return this.gainToDb(this.getLevel(channel))},Tone.Meter.prototype.isClipped=function(channel){return channel=this.defaultArg(channel,0),Date.now()-this._lastClip[channel]<this._clipMemory*1e3},Tone.Meter.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._jsNode.disconnect(),this._jsNode.onaudioprocess=null,this._jsNode=null,this._volume=null,this._values=null,this._lastClip=null,this},Tone.Meter}),define("Tone/component/Mono",["Tone/core/Tone","Tone/component/Merge"],function(Tone){"use strict";return Tone.Mono=function(){Tone.call(this,1,0),this._merge=this.output=new Tone.Merge,this.input.connect(this._merge,0,0),this.input.connect(this._merge,0,1),this.input.gain.value=this.dbToGain(-10)},Tone.extend(Tone.Mono),Tone.Mono.prototype.dispose=function(){return Tone.prototype.dispose.call(this),this._merge.dispose(),this._merge=null,this},Tone.Mono}),require.config({baseUrl:"./",paths:{App:"App",etch:"lib/etch/dist/etch",exjs:"lib/exjs/dist/ex",extensions:"lib/extensions/dist/extensions",intersection:"lib/intersection/intersection",keycodes:"lib/key-codes/dist/key-codes",lzma:"lib/lzma/src/lzma",PixelPalette:"lib/pixelpalette/dist/PixelPalette",Recorderjs:"lib/RecorderJS",text:"lib/text/text",Tone:"lib/tone/Tone",utils:"lib/utils/dist/utils"},shim:{exjs:{exports:"exjs",path:"lib/exjs/dist/ex.min"},utils:{exports:"Utils"},pixelpalette:{},RecorderJS:{path:"lib/RecorderJS/recorder.js"}}}),require(["text","App","text!config.json","text!l10n.json","PixelPalette","Tone/core/Tone","etch","exjs","extensions","intersection","keycodes","lzma","Recorderjs/recorder","Tone/component/AmplitudeEnvelope","Tone/component/Envelope","Tone/component/Filter","Tone/component/LFO","Tone/component/EQMultiband","Tone/core/Master","Tone/core/Note","Tone/core/Transport","Tone/effect/AutoPanner","Tone/effect/AutoWah","Tone/effect/BitCrusher","Tone/effect/Chorus","Tone/effect/Convolver","Tone/effect/Distortion","Tone/effect/Freeverb","Tone/effect/Phaser","Tone/effect/PingPongDelay","Tone/effect/Tremolo","Tone/effect/PitchShift","Tone/instrument/Simpler","Tone/source/Microphone","Tone/source/Noise","Tone/source/Oscillator","Tone/component/Meter","Tone/component/Mono","utils"],function(text,App,config,l10n,PixelPalette,Tone){window.PixelPalette=PixelPalette,window.Tone=Tone,$(document).ready(function(){window.App=new App.default(config,l10n),window.App.Setup()})}),define("require-config",function(){});